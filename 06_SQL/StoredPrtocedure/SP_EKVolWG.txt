USE [LIVE]
GO
/****** Object:  StoredProcedure [dbo].[GGP_SP_EKVolWG]    Script Date: 22.12.2017 11:20:27 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[GGP_SP_EKVolWG]
	@Case_ varchar(255) = '',
	@para1 varchar(255) = '',
	@para2 varchar(255) = '',
	@para3 varchar(255) = '',
	@para4 varchar(255) = '',
	@para5 varchar(255) = '',
	@para6 varchar(255) = '',
	@para7 varchar(255) = '',
	@para8 varchar(255) = '',
	@para9 varchar(255) = '',
	@para10 varchar(255) = '', --OberFl
	@para11 varchar(255) = '', --BohrDM von
	@para12 varchar(255) = '', --BohrDM von
	@para13 varchar(2000) = '',
	@OUTPUT_RES AS varchar(1000) = '' OUTPUT
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	IF @Case_ = 'KT_Lieferant'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255)
		SET @para1 = '%'
		SET @para2 = '%' --Kunde
		SET @para3 = '%' --Kundenteil
		SET @para4 = '%' --PC
		SET @para5 = '01.01.2014'
		SET @para6 = '31.12.2020'
		*/

		DECLARE @tblLiefKT table (
									Lieferant char(30),
									Warengruppe char(30),
									Rechnung FLOAT,
									Jahr INT
								)

		INSERT @tblLiefKT(
									Lieferant,
									Warengruppe,
									Rechnung,
									Jahr
						)
		SELECT
			Lieferant,
			Warengruppe,
			SUM(Rechnung) AS Rechnung,
			Jahr
		FROM
		(
			SELECT
				Lieferant,
				Rechnung,
				Jahr,
				Warengruppe
			FROM
			(
				SELECT 
					SUPPLIER_NAME AS Lieferant,
					CAST((ISNULL(RWert, 0)+ISNULL(R_NK, 0)) AS FLOAT) AS Rechnung,
					YEAR(Datum) AS Jahr,
					'Standard' AS BETyp,
					ISNULL((
							SELECT  TOP 1   dbo.DATA0007.PRODUCT_GROUP_NAME
							FROM         dbo.DATA0007 INNER JOIN
												  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER										  
							WHERE 
								dbo.DATA0008.RKEY = PROD_CODE_SELL_PTR
					), '') AS Warengruppe
				FROM 
				(
					SELECT  
						dbo.DATA0023.SUPPLIER_NAME,
						dbo.DATA0017.PROD_CODE_SELL_PTR,			
						dbo.DATA0095.TRAN_TP, 
						CASE
							WHEN dbo.DATA0070.STATUS=2 THEN 'Lieferung T' ELSE 'Lieferung' 
						END As TransDesc
						,dbo.DATA0017.INV_PART_NUMBER, 
						--dbo.DATA0017.INV_PART_DESCRIPTION, 
						CASE
							WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
								dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
							ELSE
								dbo.DATA0017.INV_PART_DESCRIPTION
						END AS INV_PART_DESCRIPTION,
						dbo.DATA0095.ENTERED_DATE AS Datum, dbo.DATA0095.ENTERED_TIME AS Zeit, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
						dbo.DATA0005.ABBR_NAME, 
						dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS PRICE, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
						dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert, (dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
						--23.10.2013 Wnn RE nicht vorhanden dann BE sonst Stamm (Vorgabe Jha)
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
												ELSE 
													(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis

							FROM         dbo.DATA0107 AS D107 INNER JOIN
												  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
												  dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
							--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						) AS RPreis,
						dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE
												ELSE 
													(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis

							FROM         dbo.DATA0107 AS D107 INNER JOIN
												  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
												  dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
							--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						) AS RWert,
						(
							SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE  AS Res
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
												  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
							--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						) AS R_NK

					FROM         dbo.DATA0005 INNER JOIN
											  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
											  dbo.DATA0017 INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
											  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
							AND  (dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para6, 103))
							AND (
								dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR 
								(dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD)
							)

					UNION ALL --offene Bestellungen

					SELECT  
						dbo.DATA0023.SUPPLIER_NAME,
						dbo.DATA0017.PROD_CODE_SELL_PTR,
						5 AS TRAN_TP, 'offene Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
						dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
							dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
						dbo.DATA0005.ABBR_NAME,
						dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
						dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,
						(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
						--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
						--0 AS RPreis,
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
												ELSE 
													(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis

							FROM         dbo.DATA0107 AS D107 INNER JOIN
													dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													dbo.DATA0070 AS D70 INNER JOIN
													dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						) AS RPreis,
						--0 AS RWert,
						(dbo.DATA0071.QUAN_RECD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY))*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE  
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE
												ELSE 
													(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis

							FROM         dbo.DATA0107 AS D107 INNER JOIN
													dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													dbo.DATA0070 AS D70 INNER JOIN
													dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						) AS RWert,
						(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE  AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
												dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
												dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						) AS R_NK
					FROM         dbo.DATA0070 INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
										  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY

					WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
								--AND  (dbo.DATA0071.QUAN_RECD = 0)
								AND  (dbo.DATA0070.STATUS = 1)
								AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
								AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
								AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
				
					UNION ALL --Debit/Belastung 

					SELECT  
						dbo.DATA0023.SUPPLIER_NAME,
						dbo.DATA0017.PROD_CODE_SELL_PTR,
						5 AS TRAN_TP, 'Debit/Belast.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
						dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, 
						--dbo.DATA0071.QUAN_RECD AS QUANTITY, 
						(-1)*dbo.DATA0219.QUAN_DEBITED AS QUANTITY,
						dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
							dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
						dbo.DATA0005.ABBR_NAME,
						dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, 
						dbo.DATA0070.PO_DATE AS BDatum,
						dbo.DATA0071.QUAN_ORD AS BMenge, 
						dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
						--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
						dbo.DATA0108.PRICE AS RPreis,
						(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert,
						(dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT)/dbo.DATA0132.EX_RATE AS R_NK

					FROM         dbo.DATA0132 INNER JOIN
							  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
							  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
							  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
							  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
							  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
							  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
							  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
					WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
								--AND  (dbo.DATA0071.QUAN_RECD = 0)
								AND  (dbo.DATA0070.STATUS = 1)
								AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
								AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
								AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

					UNION ALL --Lastschriften

					SELECT  DISTINCT
						dbo.DATA0023.SUPPLIER_NAME,
						dbo.DATA0017.PROD_CODE_SELL_PTR,
						5 AS TRAN_TP, 
						'Lastschrift' As TransDesc,
						dbo.DATA0017.INV_PART_NUMBER, 
						dbo.DATA0017.INV_PART_DESCRIPTION, 
						dbo.DATA0132.MEMO_DATE AS Datum, '' AS Zeit, 
						--dbo.DATA0108.QUANTITY AS QUANTITY, 
						--0 AS QUANTITY,
						(-1)*dbo.DATA0108.quan_debited AS QUANTITY,
						--ISNULL(dbo.DATA0071.QUAN_REJD + dbo.DATA0071.QUAN_RETN, 0) AS QUANTITY,
						0 AS QUAN_ON_HAND, 
						0 AS CONSIGN_ONHAND_QTY, 
						RTRIM(dbo.DATA0070.PO_NUMBER) + '/' + LTRIM(dbo.DATA0132.MEMO_NUMBER) AS Feld1, 
						dbo.DATA0023.CODE AS Feld2, 
						dbo.DATA0002.UNIT_CODE, 
						dbo.DATA0005.ABBR_NAME, 
						0 AS PRICE, 
						0 AS Wert, 
						dbo.DATA0070.PO_DATE AS BDatum, 
						0 AS BMenge, 
						0 AS BWert, 
						0 AS NK,
						-- -1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RPreis,
						0 AS RPreis,
						--  -1 * dbo.DATA0108.QUANTITY * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RWert,
						---1 * dbo.DATA0132.MISC_TOT AS RWert,
						-1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE) AS RWert,
						0 AS R_NK

					FROM         dbo.DATA0023 INNER JOIN
							  dbo.DATA0132 ON dbo.DATA0023.RKEY = dbo.DATA0132.SUPP_PTR INNER JOIN
							  dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
							  dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
							  dbo.DATA0005 ON dbo.DATA0132.EMPL_PTR = dbo.DATA0005.RKEY INNER JOIN
							  dbo.DATA0002 INNER JOIN
							  dbo.DATA0071 ON dbo.DATA0002.RKEY = dbo.DATA0071.PURCHASE_UNIT_PTR ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
							  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
							  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

					WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
								--AND  (dbo.DATA0071.QUAN_RECD = 0)
								--AND  (dbo.DATA0070.STATUS = 1)
								--AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
								AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para5, 103))
								AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para6, 103))

					UNION ALL --Bestellungen in Klärung 

					SELECT  
						dbo.DATA0023.SUPPLIER_NAME,
						dbo.DATA0017.PROD_CODE_SELL_PTR,
						5 AS TRAN_TP, 'in Klärung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
						dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
							dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
						dbo.DATA0005.ABBR_NAME,
						dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
						dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,
						(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
						--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
						0 AS RPreis,
						0 AS RWert,
						(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
												dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
												dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						) AS R_NK

					FROM         dbo.DATA0070 INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
										  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
					WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
								--AND  (dbo.DATA0071.QUAN_RECD = 0)
								AND  (dbo.DATA0070.STATUS = 5)
								AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
								AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

					UNION ALL --Konsi Bestellungen

					SELECT  
						dbo.DATA0023.SUPPLIER_NAME,
						dbo.DATA0017.PROD_CODE_SELL_PTR,
						5 AS TRAN_TP, 'K-Lieferung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
						dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
						'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
						dbo.DATA0005.ABBR_NAME
						, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE AS Wert, 
						dbo.DATA0466.RO_DATE AS BDatum,
						dbo.DATA0467.QUAN_ORD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS BMenge, 
						dbo.DATA0467.QUAN_ORD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE AS BWert,0 AS NK, 
						CASE
							WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
								ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
						END AS RPreis, 
						CASE
							WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
								ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
						END AS RWert, 
						0 AS R_NK

					FROM         dbo.DATA0017 INNER JOIN
										  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
										  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
										  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
										  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
					WHERE     (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
							AND dbo.DATA0341.TRAN_TP=1
							AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
							AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

					UNION ALL --rückgängig Konsi-Bestellungen

					SELECT  
						dbo.DATA0023.SUPPLIER_NAME,
						dbo.DATA0017.PROD_CODE_SELL_PTR,
						5 AS TRAN_TP, 'rückgäng. Kons' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
						dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
						'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
						dbo.DATA0005.ABBR_NAME
						, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
						dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
						CASE
							WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
								ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
						END AS RPreis, 
						CASE
							WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
								ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
						END AS RWert, 
						0 AS R_NK

					FROM         dbo.DATA0017 INNER JOIN
										  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
										  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
										  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
										  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
					WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
							AND dbo.DATA0341.TRAN_TP=15
							AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
							AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))

					UNION ALL --offene Konsi-Bestellungen

					SELECT  
						dbo.DATA0023.SUPPLIER_NAME,
						dbo.DATA0017.PROD_CODE_SELL_PTR,
						5 AS TRAN_TP, 'offene K-Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
						dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
						'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
						dbo.DATA0005.ABBR_NAME
						,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
						dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
						0 AS RWert, 0 AS R_NK

					FROM         dbo.DATA0467 INNER JOIN
										  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
										  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
					WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							--AND dbo.DATA0467.QUAN_RECD=0
							AND (dbo.DATA0466.STATUS=1)
							AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

					UNION ALL --liegende Konsi-Bestellungen

					SELECT  
						dbo.DATA0023.SUPPLIER_NAME,
						dbo.DATA0017.PROD_CODE_SELL_PTR,
						5 AS TRAN_TP, 'K-storniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
						dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
						'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
						dbo.DATA0005.ABBR_NAME
						,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
						dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
						0 AS RWert, 0 AS R_NK

					FROM         dbo.DATA0467 INNER JOIN
										  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
										  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
					WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							--AND dbo.DATA0467.QUAN_RECD=0
							AND (dbo.DATA0466.STATUS=4)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

					UNION ALL --retournierte Konsi-Bestellungen

					SELECT  
						dbo.DATA0023.SUPPLIER_NAME,
						dbo.DATA0017.PROD_CODE_SELL_PTR,
						5 AS TRAN_TP, 'K-retourniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
						dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, (-1)*dbo.DATA0467.QUAN_RETN AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
						'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
						dbo.DATA0005.ABBR_NAME
						,  dbo.DATA0467.PRICE, -1*dbo.DATA0467.QUAN_RETN * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
						dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
						CASE
							WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
								ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
						END AS RPreis, 
						CASE
							WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN -1*dbo.DATA0467.QUAN_RETN*dbo.DATA0467.PRICE
								ELSE (SELECT TOP 1 -1*dbo.DATA0467.QUAN_RETN*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
						END AS RWert, 
						0 AS R_NK

					FROM         dbo.DATA0467 INNER JOIN
										  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
										  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
					WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND dbo.DATA0467.QUAN_RETN>0
							AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
							AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				)  AS ResTbl


				UNION ALL


				SELECT 
					SUPPLIER_NAME AS Lieferant,
					CAST((ISNULL(RWERT,0)+ISNULL(R_NK,0)) AS FLOAT) AS RE_Wert,
					YEAR(Datum) AS Jahr,
					'Sonstige' AS BETyp,
					'' AS Warengruppe
				FROM
				(
					SELECT     
						dbo.DATA0023.SUPPLIER_NAME,
						5 AS TRAN_TP, 
						--'sonstige' As TransDesc,
						CASE
							WHEN dbo.DATA0070.STATUS=1 AND (dbo.DATA0072.QUANTITY_RECEIVED<dbo.DATA0072.QUAN_ORD) THEN 'offene Best.'
							ELSE
								CASE
									WHEN dbo.DATA0070.STATUS=2 THEN 'Lieferung T'
									ELSE
										CASE
											WHEN dbo.DATA0070.STATUS=3 THEN 'storniert'
											ELSE
												CASE
													WHEN dbo.DATA0070.STATUS=5 THEN 'in Klärung'
													ELSE
														CASE
															WHEN dbo.DATA0070.STATUS=6 OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0072.QUANTITY_RECEIVED>=dbo.DATA0072.QUAN_ORD) THEN 'Lieferung'
															ELSE '?????'
														END
												END
										END
								END
						END As TransDesc,dbo.DATA0072.DESCRIPTION + STR(dbo.DATA0072.RKEY) AS INV_PART_NUMBER, dbo.DATA0072.DESCRIPTION2 + STR(dbo.DATA0072.RKEY) AS INV_PART_DESCRIPTION, dbo.DATA0072.DEL_DATE AS Datum, '' AS Zeit, 
						dbo.DATA0072.QUANTITY_RECEIVED AS QUANTITY, 0 AS QUAN_ON_HAND, 0 AS CONSIGN_ONHAND_QTY, dbo.DATA0070.PO_NUMBER AS Feld1, 
						dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, dbo.DATA0005.ABBR_NAME, dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE AS PRICE, 
						dbo.DATA0072.QUANTITY_RECEIVED * dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE  AS Wert, dbo.DATA0070.PO_DATE AS BDatum, dbo.DATA0072.QUAN_ORD AS BMenge, 
						--CASE 
						--	WHEN dbo.DATA0070.STATUS<>3 THEN dbo.DATA0072.QUAN_ORD * dbo.DATA0072.UNIT_PRICE
						--		ELSE 0
						--END AS BWert, 
						dbo.DATA0072.QUAN_ORD * dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert, 
						(dbo.DATA0070.SHIPPING_COST + dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
						--0 AS RPreis,
						--0 AS RWert,
						--0 AS R_NK
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D109.PRICE, 0)>0 THEN D109.PRICE/D107.EX_RATE
									ELSE 
										ISNULL(D72.UNIT_PRICE/D70.EXCHANGE_RATE, 0)
							END AS RPreis
							--FROM         dbo.DATA0070 AS D70 INNER JOIN
							--					  dbo.DATA0072 AS D72 ON D70.RKEY = D72.POPTR LEFT OUTER JOIN
							--					  dbo.DATA0109 ON D72.RKEY = dbo.DATA0109.DATA0072_PTR
							--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER)
							--FROM         dbo.DATA0072 AS D72 LEFT OUTER JOIN
							--					  dbo.DATA0109 ON D72.RKEY = dbo.DATA0109.DATA0072_PTR
							FROM         dbo.DATA0070 AS d70 INNER JOIN
													dbo.DATA0072 AS D72 ON d70.RKEY = D72.POPTR LEFT OUTER JOIN
													dbo.DATA0107 AS D107 INNER JOIN
													dbo.DATA0109 AS d109 ON D107.RKEY = d109.DATA0107_PTR ON D72.RKEY = d109.DATA0072_PTR
							WHERE     (D72.RKEY = dbo.DATA0072.RKEY)
						) AS RPreis,
						dbo.DATA0072.QUANTITY_RECEIVED*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D109.PRICE, 0)>0 THEN D109.PRICE/D107.EX_RATE
									ELSE 
										ISNULL(D72.UNIT_PRICE/D70.EXCHANGE_RATE, 0)
							END AS RPreis
							--FROM         dbo.DATA0070 AS D70 INNER JOIN
							--					  dbo.DATA0072 AS D72 ON D70.RKEY = D72.POPTR LEFT OUTER JOIN
							--					  dbo.DATA0109 ON D72.RKEY = dbo.DATA0109.DATA0072_PTR
							--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER)
							--FROM         dbo.DATA0072 AS D72 LEFT OUTER JOIN
							--					  dbo.DATA0109 ON D72.RKEY = dbo.DATA0109.DATA0072_PTR
							FROM         dbo.DATA0070 AS d70 INNER JOIN
													dbo.DATA0072 AS D72 ON d70.RKEY = D72.POPTR LEFT OUTER JOIN
													dbo.DATA0107 AS D107 INNER JOIN
													dbo.DATA0109 AS d109 ON D107.RKEY = d109.DATA0107_PTR ON D72.RKEY = d109.DATA0072_PTR
							WHERE     (D72.RKEY = dbo.DATA0072.RKEY)
						) AS RWert,
						(
						SELECT     TOP 1 
							CASE
								WHEN ISNULL(dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT, 0)>0 THEN dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT
								ELSE
									ISNULL(dbo.DATA0070.SHIPPING_COST + dbo.DATA0070.MISC_CHARGE, 0)
							END AS RES
							FROM         dbo.DATA0107 INNER JOIN
											dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR RIGHT OUTER JOIN
											dbo.DATA0070 AS D70 INNER JOIN
											dbo.DATA0072 AS D72 ON D70.RKEY = D72.POPTR ON dbo.DATA0109.DATA0072_PTR = D72.RKEY
							WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER)
						)/dbo.DATA0070.EXCHANGE_RATE AS R_NK

					FROM         dbo.DATA0072 INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0072.POPTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0072.UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
										  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
					WHERE      (dbo.DATA0072.DESCRIPTION + ' ' + ISNULL(dbo.DATA0072.DESCRIPTION2, '') COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 
									OR dbo.DATA0072.DESCRIPTION + ' ' + ISNULL(dbo.DATA0072.DESCRIPTION2, '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
								--AND  (dbo.DATA0071.QUAN_RECD = 0)
								AND  (dbo.DATA0070.STATUS <> 3)
								AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0072.DEL_DATE >= CONVERT(DATETIME, @para5, 103))
								AND (dbo.DATA0072.DEL_DATE <= CONVERT(DATETIME, @para6, 103))

					UNION ALL

					SELECT DISTINCT   
						dbo.DATA0023.SUPPLIER_NAME, 
						5 AS TRAN_TP, 
						'Lastschrift' As TransDesc,
						dbo.DATA0072.DESCRIPTION + STR(dbo.DATA0072.RKEY) AS INV_PART_NUMBER, 
						dbo.DATA0072.DESCRIPTION2 + STR(dbo.DATA0072.RKEY) AS INV_PART_DESCRIPTION, 
						dbo.DATA0132.MEMO_DATE AS Datum, '' AS Zeit, 
						-- dbo.DATA0109.QUANTITY AS QUANTITY, 
						0 AS QUANTITY, 
						0 AS QUAN_ON_HAND, 
						0 AS CONSIGN_ONHAND_QTY, 
						--dbo.DATA0070.PO_NUMBER AS Feld1, 
						RTRIM(dbo.DATA0070.PO_NUMBER) + '/' + LTRIM(dbo.DATA0132.MEMO_NUMBER) AS Feld1, 
						dbo.DATA0023.CODE AS Feld2, 
						dbo.DATA0002.UNIT_CODE, 
						dbo.DATA0005.ABBR_NAME, 
						0 AS PRICE, 
						0 AS Wert, 
						dbo.DATA0070.PO_DATE AS BDatum, 
						0 AS BMenge, 
						0 AS BWert, 
						0 AS NK,
						---1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0109.QUANTITY) AS RPreis,
						0 AS RPreis,
						-- -1 * dbo.DATA0109.QUANTITY * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0109.QUANTITY) AS RWert,
						-1 * dbo.DATA0132.MISC_TOT/dbo.DATA0070.EXCHANGE_RATE AS RWert,
						0 AS R_NK

					FROM         dbo.DATA0023 INNER JOIN
										  dbo.DATA0132 ON dbo.DATA0023.RKEY = dbo.DATA0132.SUPP_PTR INNER JOIN
										  dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR INNER JOIN
										  dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR INNER JOIN
										  dbo.DATA0005 ON dbo.DATA0132.EMPL_PTR = dbo.DATA0005.RKEY INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0072.UNIT_PTR = dbo.DATA0002.RKEY
					WHERE      (dbo.DATA0072.DESCRIPTION + ' ' + dbo.DATA0072.DESCRIPTION2 COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 
									OR dbo.DATA0072.DESCRIPTION + ' ' + dbo.DATA0072.DESCRIPTION2 COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
								--AND  (dbo.DATA0071.QUAN_RECD = 0)
								AND  (dbo.DATA0070.STATUS <> 3)
								AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0072.DEL_DATE >= CONVERT(DATETIME, @para5, 103))
								AND (dbo.DATA0072.DEL_DATE <= CONVERT(DATETIME, @para6, 103))
				) AS tblSonst
				--GROUP BY 
				--	SUPPLIER_NAME, Datum
			) AS tblGrp
			WHERE
				Warengruppe COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para7
		) AS tblAll
		GROUP BY
			Lieferant, Warengruppe, Jahr

		IF @para8='Standard'
		BEGIN
			DELETE FROM @tblLiefKT WHERE Warengruppe=''
		END
		IF @para8='Sonstige'
		BEGIN
			DELETE FROM @tblLiefKT WHERE Warengruppe<>''
		END

		SELECT 
			*  
		FROM 
		(
			SELECT 
				Lieferant,
				Jahr,
				Rechnung 
			FROM 
				@tblLiefKT AS tblDaten 
		) AS P 
		PIVOT 
		(
			SUM(Rechnung)
			FOR Jahr IN ( 
							[2014], [2015], [2016], [2017], [2018], [2019], [2020] 
						)
		) AS KT 

	END

	IF @Case_ = 'KT_Warengruppe'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255)
		SET @para1 = '%'
		SET @para2 = '%' --Kunde
		SET @para3 = '%' --Kundenteil
		SET @para4 = '%' --PC
		SET @para5 = '01.01.2014'
		SET @para6 = '31.12.2020'
		*/

		DECLARE @tblWGrpKT table (
									Warengruppe char(30),
									Rechnung FLOAT,
									Jahr INT
								)

		INSERT @tblWGrpKT(
									Warengruppe,
									Rechnung,
									Jahr
						)

		SELECT
			Warengruppe,
			Rechnung,
			Jahr
		FROM
		(
			SELECT 
				ISNULL((
						SELECT  TOP 1   dbo.DATA0007.PRODUCT_GROUP_NAME
						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER										  
						WHERE 
							dbo.DATA0008.RKEY = PROD_CODE_SELL_PTR
				), '') AS Warengruppe,
				CAST(SUM(ISNULL(RWert, 0)+ISNULL(R_NK, 0)) AS FLOAT) AS Rechnung,
				YEAR(Datum) AS Jahr
			FROM 
			(
				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,			
					dbo.DATA0095.TRAN_TP, 
					CASE
						WHEN dbo.DATA0070.STATUS=2 THEN 'Lieferung T' ELSE 'Lieferung' 
					END As TransDesc
					,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0095.ENTERED_DATE AS Datum, dbo.DATA0095.ENTERED_TIME AS Zeit, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
					dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS PRICE, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert, (dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Wnn RE nicht vorhanden dann BE sonst Stamm (Vorgabe Jha)
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
											  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
											  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE  AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK

				FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE    
						(CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND  (dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (
							dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
							OR 
							(dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD)
						)

				UNION ALL --offene Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'offene Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,
					(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					--0 AS RPreis,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
												dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
												dbo.DATA0070 AS D70 INNER JOIN
												dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					--0 AS RWert,
					(dbo.DATA0071.QUAN_RECD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY))*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE  
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
												dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
												dbo.DATA0070 AS D70 INNER JOIN
												dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
					SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE  AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
											dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK
				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY

				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
				
				UNION ALL --Debit/Belastung 

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'Debit/Belast.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, 
					--dbo.DATA0071.QUAN_RECD AS QUANTITY, 
					(-1)*dbo.DATA0219.QUAN_DEBITED AS QUANTITY,
					dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, 
					dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, 
					dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					dbo.DATA0108.PRICE AS RPreis,
					(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert,
					(dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT)/dbo.DATA0132.EX_RATE AS R_NK

				FROM         dbo.DATA0132 INNER JOIN
						  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
						  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Lastschriften

				SELECT  DISTINCT
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 
					'Lastschrift' As TransDesc,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0132.MEMO_DATE AS Datum, '' AS Zeit, 
					--dbo.DATA0108.QUANTITY AS QUANTITY, 
					--0 AS QUANTITY,
					(-1)*dbo.DATA0108.quan_debited AS QUANTITY,
					--ISNULL(dbo.DATA0071.QUAN_REJD + dbo.DATA0071.QUAN_RETN, 0) AS QUANTITY,
					0 AS QUAN_ON_HAND, 
					0 AS CONSIGN_ONHAND_QTY, 
					RTRIM(dbo.DATA0070.PO_NUMBER) + '/' + LTRIM(dbo.DATA0132.MEMO_NUMBER) AS Feld1, 
					dbo.DATA0023.CODE AS Feld2, 
					dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					0 AS PRICE, 
					0 AS Wert, 
					dbo.DATA0070.PO_DATE AS BDatum, 
					0 AS BMenge, 
					0 AS BWert, 
					0 AS NK,
					-- -1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RPreis,
					0 AS RPreis,
					--  -1 * dbo.DATA0108.QUANTITY * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RWert,
					---1 * dbo.DATA0132.MISC_TOT AS RWert,
					-1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE) AS RWert,
					0 AS R_NK

				FROM         dbo.DATA0023 INNER JOIN
						  dbo.DATA0132 ON dbo.DATA0023.RKEY = dbo.DATA0132.SUPP_PTR INNER JOIN
						  dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0132.EMPL_PTR = dbo.DATA0005.RKEY INNER JOIN
						  dbo.DATA0002 INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0002.RKEY = dbo.DATA0071.PURCHASE_UNIT_PTR ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							--AND  (dbo.DATA0070.STATUS = 1)
							--AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Bestellungen in Klärung 

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'in Klärung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,
					(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					0 AS RPreis,
					0 AS RWert,
					(
					SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
											dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 5)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Konsi Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-Lieferung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE AS Wert, 
					dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS BMenge, 
					dbo.DATA0467.QUAN_ORD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND dbo.DATA0341.TRAN_TP=1
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

				UNION ALL --rückgängig Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'rückgäng. Kons' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND dbo.DATA0341.TRAN_TP=15
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --offene Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'offene K-Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
					0 AS RWert, 0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						--AND dbo.DATA0467.QUAN_RECD=0
						AND (dbo.DATA0466.STATUS=1)
						AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --liegende Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-storniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
					0 AS RWert, 0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						--AND dbo.DATA0467.QUAN_RECD=0
						AND (dbo.DATA0466.STATUS=4)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --retournierte Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-retourniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, (-1)*dbo.DATA0467.QUAN_RETN AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, -1*dbo.DATA0467.QUAN_RETN * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN -1*dbo.DATA0467.QUAN_RETN*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 -1*dbo.DATA0467.QUAN_RETN*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						AND dbo.DATA0467.QUAN_RETN>0
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

			)  AS ResTbl
			GROUP BY
				PROD_CODE_SELL_PTR, Datum
		) AS tbl
		WHERE
			Warengruppe COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para7



		SELECT 
			*  
		FROM 
		(
			SELECT 
				Warengruppe,
				Jahr,
				Rechnung 
			FROM 
				@tblWGrpKT AS tblDaten 
		) AS P 
		PIVOT 
		(
			SUM(Rechnung)
			FOR Jahr IN ( 
							[2014], [2015], [2016], [2017], [2018], [2019], [2020] 
						)
		) AS KTWG 
	END

	IF @Case_ = 'KT_WarengruppeLieferant'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255)
		SET @para1 = '%'
		SET @para2 = '%' --Kunde
		SET @para3 = '%' --Kundenteil
		SET @para4 = '%' --PC
		SET @para5 = '01.01.2014'
		SET @para6 = '31.12.2020'
		*/

		DECLARE @tblWGrpLiefKT table (
									Lieferant char(30),
									Warengruppe char(30),
									Rechnung FLOAT,
									Jahr INT
								)

		INSERT @tblWGrpLiefKT(
									Lieferant,
									Warengruppe,
									Rechnung,
									Jahr
						)

		SELECT
			Lieferant,
			Warengruppe,
			Rechnung,
			Jahr
		FROM
		(
			SELECT 
				SUPPLIER_NAME AS Lieferant,
				ISNULL((
						SELECT  TOP 1   dbo.DATA0007.PRODUCT_GROUP_NAME
						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER										  
						WHERE 
							dbo.DATA0008.RKEY = PROD_CODE_SELL_PTR
				), '') AS Warengruppe,
				CAST(SUM(ISNULL(RWert, 0)+ISNULL(R_NK, 0)) AS FLOAT) AS Rechnung,
				YEAR(Datum) AS Jahr
			FROM 
			(
				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,			
					dbo.DATA0095.TRAN_TP, 
					CASE
						WHEN dbo.DATA0070.STATUS=2 THEN 'Lieferung T' ELSE 'Lieferung' 
					END As TransDesc
					,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0095.ENTERED_DATE AS Datum, dbo.DATA0095.ENTERED_TIME AS Zeit, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
					dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS PRICE, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert, (dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Wnn RE nicht vorhanden dann BE sonst Stamm (Vorgabe Jha)
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
											  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
											  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE  AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK

				FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE    
						(CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND  (dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (
							dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
							OR 
							(dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD)
						)

				UNION ALL --offene Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'offene Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,
					(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					--0 AS RPreis,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
												dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
												dbo.DATA0070 AS D70 INNER JOIN
												dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					--0 AS RWert,
					(dbo.DATA0071.QUAN_RECD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY))*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE  
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
												dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
												dbo.DATA0070 AS D70 INNER JOIN
												dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
					SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE  AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
											dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK
				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY

				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
				
				UNION ALL --Debit/Belastung 

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'Debit/Belast.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, 
					--dbo.DATA0071.QUAN_RECD AS QUANTITY, 
					(-1)*dbo.DATA0219.QUAN_DEBITED AS QUANTITY,
					dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, 
					dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, 
					dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					dbo.DATA0108.PRICE AS RPreis,
					(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert,
					(dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT)/dbo.DATA0132.EX_RATE AS R_NK

				FROM         dbo.DATA0132 INNER JOIN
						  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
						  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Lastschriften

				SELECT  DISTINCT
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 
					'Lastschrift' As TransDesc,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0132.MEMO_DATE AS Datum, '' AS Zeit, 
					--dbo.DATA0108.QUANTITY AS QUANTITY, 
					--0 AS QUANTITY,
					(-1)*dbo.DATA0108.quan_debited AS QUANTITY,
					--ISNULL(dbo.DATA0071.QUAN_REJD + dbo.DATA0071.QUAN_RETN, 0) AS QUANTITY,
					0 AS QUAN_ON_HAND, 
					0 AS CONSIGN_ONHAND_QTY, 
					RTRIM(dbo.DATA0070.PO_NUMBER) + '/' + LTRIM(dbo.DATA0132.MEMO_NUMBER) AS Feld1, 
					dbo.DATA0023.CODE AS Feld2, 
					dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					0 AS PRICE, 
					0 AS Wert, 
					dbo.DATA0070.PO_DATE AS BDatum, 
					0 AS BMenge, 
					0 AS BWert, 
					0 AS NK,
					-- -1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RPreis,
					0 AS RPreis,
					--  -1 * dbo.DATA0108.QUANTITY * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RWert,
					---1 * dbo.DATA0132.MISC_TOT AS RWert,
					-1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE) AS RWert,
					0 AS R_NK

				FROM         dbo.DATA0023 INNER JOIN
						  dbo.DATA0132 ON dbo.DATA0023.RKEY = dbo.DATA0132.SUPP_PTR INNER JOIN
						  dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0132.EMPL_PTR = dbo.DATA0005.RKEY INNER JOIN
						  dbo.DATA0002 INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0002.RKEY = dbo.DATA0071.PURCHASE_UNIT_PTR ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							--AND  (dbo.DATA0070.STATUS = 1)
							--AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Bestellungen in Klärung 

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'in Klärung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,
					(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					0 AS RPreis,
					0 AS RWert,
					(
					SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
											dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 5)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Konsi Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-Lieferung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE AS Wert, 
					dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS BMenge, 
					dbo.DATA0467.QUAN_ORD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND dbo.DATA0341.TRAN_TP=1
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

				UNION ALL --rückgängig Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'rückgäng. Kons' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND dbo.DATA0341.TRAN_TP=15
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --offene Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'offene K-Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
					0 AS RWert, 0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						--AND dbo.DATA0467.QUAN_RECD=0
						AND (dbo.DATA0466.STATUS=1)
						AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --liegende Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-storniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
					0 AS RWert, 0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						--AND dbo.DATA0467.QUAN_RECD=0
						AND (dbo.DATA0466.STATUS=4)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --retournierte Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-retourniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, (-1)*dbo.DATA0467.QUAN_RETN AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, -1*dbo.DATA0467.QUAN_RETN * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN -1*dbo.DATA0467.QUAN_RETN*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 -1*dbo.DATA0467.QUAN_RETN*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						AND dbo.DATA0467.QUAN_RETN>0
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

			)  AS ResTbl
			GROUP BY
				SUPPLIER_NAME, PROD_CODE_SELL_PTR, Datum
		) AS tbl
		WHERE 
			Warengruppe COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para7


		SELECT 
			*
		FROM 
		(
			SELECT 
				Lieferant,
				Warengruppe,
				Jahr,
				Rechnung 
			FROM 
				@tblWGrpLiefKT AS tblDaten 
		) AS P 
		PIVOT 
		(
			SUM(Rechnung)
			FOR Jahr IN ( 
							[2014], [2015], [2016], [2017], [2018], [2019], [2020] 
						)
		) AS KTWG 
		ORDER BY
			Warengruppe 
	END

	IF @Case_ = 'KT_LieferantWarengruppe'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255)
		SET @para1 = '%'
		SET @para2 = '%' --Kunde
		SET @para3 = '%' --Kundenteil
		SET @para4 = '%' --PC
		SET @para5 = '01.01.2014'
		SET @para6 = '31.12.2020'
		*/

		DECLARE @tblLiefWGrpKT table (
									Lieferant char(30),
									Warengruppe char(30),
									Rechnung FLOAT,
									Jahr INT
								)

		INSERT @tblLiefWGrpKT(
									Lieferant,
									Warengruppe,
									Rechnung,
									Jahr
						)

		SELECT
			Lieferant,
			Warengruppe,
			Rechnung,
			Jahr
		FROM
		(
			SELECT 
				SUPPLIER_NAME AS Lieferant,
				ISNULL((
						SELECT  TOP 1   dbo.DATA0007.PRODUCT_GROUP_NAME
						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER										  
						WHERE 
							dbo.DATA0008.RKEY = PROD_CODE_SELL_PTR
				), '') AS Warengruppe,
				CAST(SUM(ISNULL(RWert, 0)+ISNULL(R_NK, 0)) AS FLOAT) AS Rechnung,
				YEAR(Datum) AS Jahr
			FROM 
			(
				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,			
					dbo.DATA0095.TRAN_TP, 
					CASE
						WHEN dbo.DATA0070.STATUS=2 THEN 'Lieferung T' ELSE 'Lieferung' 
					END As TransDesc
					,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0095.ENTERED_DATE AS Datum, dbo.DATA0095.ENTERED_TIME AS Zeit, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
					dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS PRICE, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert, (dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Wnn RE nicht vorhanden dann BE sonst Stamm (Vorgabe Jha)
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
											  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
											  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE  AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK

				FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE    
						(CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND  (dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (
							dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
							OR 
							(dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD)
						)

				UNION ALL --offene Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'offene Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,
					(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					--0 AS RPreis,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
												dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
												dbo.DATA0070 AS D70 INNER JOIN
												dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					--0 AS RWert,
					(dbo.DATA0071.QUAN_RECD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY))*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE  
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
												dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
												dbo.DATA0070 AS D70 INNER JOIN
												dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
					SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE  AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
											dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK
				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY

				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
				
				UNION ALL --Debit/Belastung 

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'Debit/Belast.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, 
					--dbo.DATA0071.QUAN_RECD AS QUANTITY, 
					(-1)*dbo.DATA0219.QUAN_DEBITED AS QUANTITY,
					dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, 
					dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, 
					dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					dbo.DATA0108.PRICE AS RPreis,
					(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert,
					(dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT)/dbo.DATA0132.EX_RATE AS R_NK

				FROM         dbo.DATA0132 INNER JOIN
						  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
						  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Lastschriften

				SELECT  DISTINCT
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 
					'Lastschrift' As TransDesc,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0132.MEMO_DATE AS Datum, '' AS Zeit, 
					--dbo.DATA0108.QUANTITY AS QUANTITY, 
					--0 AS QUANTITY,
					(-1)*dbo.DATA0108.quan_debited AS QUANTITY,
					--ISNULL(dbo.DATA0071.QUAN_REJD + dbo.DATA0071.QUAN_RETN, 0) AS QUANTITY,
					0 AS QUAN_ON_HAND, 
					0 AS CONSIGN_ONHAND_QTY, 
					RTRIM(dbo.DATA0070.PO_NUMBER) + '/' + LTRIM(dbo.DATA0132.MEMO_NUMBER) AS Feld1, 
					dbo.DATA0023.CODE AS Feld2, 
					dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					0 AS PRICE, 
					0 AS Wert, 
					dbo.DATA0070.PO_DATE AS BDatum, 
					0 AS BMenge, 
					0 AS BWert, 
					0 AS NK,
					-- -1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RPreis,
					0 AS RPreis,
					--  -1 * dbo.DATA0108.QUANTITY * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RWert,
					---1 * dbo.DATA0132.MISC_TOT AS RWert,
					-1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE) AS RWert,
					0 AS R_NK

				FROM         dbo.DATA0023 INNER JOIN
						  dbo.DATA0132 ON dbo.DATA0023.RKEY = dbo.DATA0132.SUPP_PTR INNER JOIN
						  dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0132.EMPL_PTR = dbo.DATA0005.RKEY INNER JOIN
						  dbo.DATA0002 INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0002.RKEY = dbo.DATA0071.PURCHASE_UNIT_PTR ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							--AND  (dbo.DATA0070.STATUS = 1)
							--AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Bestellungen in Klärung 

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'in Klärung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,
					(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					0 AS RPreis,
					0 AS RWert,
					(
					SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
											dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 5)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Konsi Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-Lieferung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE AS Wert, 
					dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS BMenge, 
					dbo.DATA0467.QUAN_ORD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND dbo.DATA0341.TRAN_TP=1
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

				UNION ALL --rückgängig Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'rückgäng. Kons' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND dbo.DATA0341.TRAN_TP=15
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --offene Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'offene K-Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
					0 AS RWert, 0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						--AND dbo.DATA0467.QUAN_RECD=0
						AND (dbo.DATA0466.STATUS=1)
						AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --liegende Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-storniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
					0 AS RWert, 0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						--AND dbo.DATA0467.QUAN_RECD=0
						AND (dbo.DATA0466.STATUS=4)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --retournierte Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-retourniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, (-1)*dbo.DATA0467.QUAN_RETN AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, -1*dbo.DATA0467.QUAN_RETN * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN -1*dbo.DATA0467.QUAN_RETN*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 -1*dbo.DATA0467.QUAN_RETN*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						AND dbo.DATA0467.QUAN_RETN>0
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

			)  AS ResTbl
			GROUP BY
				SUPPLIER_NAME, PROD_CODE_SELL_PTR, Datum
		) AS tbl
		WHERE 
			Warengruppe COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para7


		SELECT 
			*
		FROM 
		(
			SELECT 
				Lieferant,
				Warengruppe,
				Jahr,
				Rechnung 
			FROM 
				@tblLiefWGrpKT AS tblDaten 
		) AS P 
		PIVOT 
		(
			SUM(Rechnung)
			FOR Jahr IN ( 
							[2014], [2015], [2016], [2017], [2018], [2019], [2020] 
						)
		) AS KTWG 
		ORDER BY
			Lieferant
	END

	IF @Case_ = 'KT_WarengruppePC'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255)
		SET @para1 = '%'
		SET @para2 = '%' --Kunde
		SET @para3 = '%' --Kundenteil
		SET @para4 = '%' --PC
		SET @para5 = '01.01.2014'
		SET @para6 = '31.12.2020'
		*/

		DECLARE @tblWGrpPCKT table (
									Warengruppe char(30),
									Produktcode char(30),
									Rechnung FLOAT,
									Jahr INT
								)

		INSERT @tblWGrpPCKT(
									Warengruppe,
									Produktcode,
									Rechnung,
									Jahr
						)

		SELECT
			Warengruppe,
			Produktcode,
			Rechnung,
			Jahr
		FROM
		(
			SELECT 
				--SUPPLIER_NAME AS Lieferant,
				ISNULL((
						SELECT  TOP 1   dbo.DATA0007.PRODUCT_GROUP_NAME
						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER										  
						WHERE 
							dbo.DATA0008.RKEY = PROD_CODE_SELL_PTR
				), '') AS Warengruppe,
				ISNULL((
						SELECT  TOP 1   dbo.DATA0008.PRODUCT_NAME
						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER										  
						WHERE 
							dbo.DATA0008.RKEY = PROD_CODE_SELL_PTR
				), '') AS Produktcode,
				CAST(SUM(ISNULL(RWert, 0)+ISNULL(R_NK, 0)) AS FLOAT) AS Rechnung,
				YEAR(Datum) AS Jahr
			FROM 
			(
				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,			
					dbo.DATA0095.TRAN_TP, 
					CASE
						WHEN dbo.DATA0070.STATUS=2 THEN 'Lieferung T' ELSE 'Lieferung' 
					END As TransDesc
					,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0095.ENTERED_DATE AS Datum, dbo.DATA0095.ENTERED_TIME AS Zeit, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
					dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS PRICE, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert, (dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Wnn RE nicht vorhanden dann BE sonst Stamm (Vorgabe Jha)
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
											  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
											  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE  AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK

				FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE    
						(CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND  (dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (
							dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
							OR 
							(dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD)
						)

				UNION ALL --offene Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'offene Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,
					(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					--0 AS RPreis,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
												dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
												dbo.DATA0070 AS D70 INNER JOIN
												dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					--0 AS RWert,
					(dbo.DATA0071.QUAN_RECD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY))*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE  
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
												dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
												dbo.DATA0070 AS D70 INNER JOIN
												dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
					SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE  AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
											dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK
				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY

				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
				
				UNION ALL --Debit/Belastung 

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'Debit/Belast.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, 
					--dbo.DATA0071.QUAN_RECD AS QUANTITY, 
					(-1)*dbo.DATA0219.QUAN_DEBITED AS QUANTITY,
					dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, 
					dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, 
					dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					dbo.DATA0108.PRICE AS RPreis,
					(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert,
					(dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT)/dbo.DATA0132.EX_RATE AS R_NK

				FROM         dbo.DATA0132 INNER JOIN
						  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
						  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Lastschriften

				SELECT  DISTINCT
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 
					'Lastschrift' As TransDesc,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0132.MEMO_DATE AS Datum, '' AS Zeit, 
					--dbo.DATA0108.QUANTITY AS QUANTITY, 
					--0 AS QUANTITY,
					(-1)*dbo.DATA0108.quan_debited AS QUANTITY,
					--ISNULL(dbo.DATA0071.QUAN_REJD + dbo.DATA0071.QUAN_RETN, 0) AS QUANTITY,
					0 AS QUAN_ON_HAND, 
					0 AS CONSIGN_ONHAND_QTY, 
					RTRIM(dbo.DATA0070.PO_NUMBER) + '/' + LTRIM(dbo.DATA0132.MEMO_NUMBER) AS Feld1, 
					dbo.DATA0023.CODE AS Feld2, 
					dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					0 AS PRICE, 
					0 AS Wert, 
					dbo.DATA0070.PO_DATE AS BDatum, 
					0 AS BMenge, 
					0 AS BWert, 
					0 AS NK,
					-- -1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RPreis,
					0 AS RPreis,
					--  -1 * dbo.DATA0108.QUANTITY * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RWert,
					---1 * dbo.DATA0132.MISC_TOT AS RWert,
					-1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE) AS RWert,
					0 AS R_NK

				FROM         dbo.DATA0023 INNER JOIN
						  dbo.DATA0132 ON dbo.DATA0023.RKEY = dbo.DATA0132.SUPP_PTR INNER JOIN
						  dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0132.EMPL_PTR = dbo.DATA0005.RKEY INNER JOIN
						  dbo.DATA0002 INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0002.RKEY = dbo.DATA0071.PURCHASE_UNIT_PTR ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							--AND  (dbo.DATA0070.STATUS = 1)
							--AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Bestellungen in Klärung 

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'in Klärung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,
					(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					0 AS RPreis,
					0 AS RWert,
					(
					SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
											dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 5)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Konsi Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-Lieferung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE AS Wert, 
					dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS BMenge, 
					dbo.DATA0467.QUAN_ORD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND dbo.DATA0341.TRAN_TP=1
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

				UNION ALL --rückgängig Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'rückgäng. Kons' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND dbo.DATA0341.TRAN_TP=15
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --offene Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'offene K-Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
					0 AS RWert, 0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						--AND dbo.DATA0467.QUAN_RECD=0
						AND (dbo.DATA0466.STATUS=1)
						AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --liegende Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-storniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
					0 AS RWert, 0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						--AND dbo.DATA0467.QUAN_RECD=0
						AND (dbo.DATA0466.STATUS=4)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --retournierte Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-retourniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, (-1)*dbo.DATA0467.QUAN_RETN AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, -1*dbo.DATA0467.QUAN_RETN * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN -1*dbo.DATA0467.QUAN_RETN*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 -1*dbo.DATA0467.QUAN_RETN*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						AND dbo.DATA0467.QUAN_RETN>0
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

			)  AS ResTbl
			GROUP BY
				PROD_CODE_SELL_PTR, Datum
		) AS tbl
		WHERE 
			Warengruppe COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para7


		SELECT 
			*
		FROM 
		(
			SELECT 
				Warengruppe,
				Produktcode,
				Jahr,
				Rechnung 
			FROM 
				@tblWGrpPCKT AS tblDaten 
		) AS P 
		PIVOT 
		(
			SUM(Rechnung)
			FOR Jahr IN ( 
							[2014], [2015], [2016], [2017], [2018], [2019], [2020] 
						)
		) AS KTWG 
		ORDER BY
			Warengruppe
	END

	IF @Case_ = 'KT_LiefWGrpPCArt'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255)
		SET @para1 = '%'
		SET @para2 = '%' --Kunde
		SET @para3 = '%' --Kundenteil
		SET @para4 = '%' --PC
		SET @para5 = '01.01.2014'
		SET @para6 = '31.12.2020'
		*/

		DECLARE @tblAllesKT table (
									Lieferant char(30),
									Warengruppe char(30),
									Produktcode char(30),
									Artikel char(100),
									Rechnung FLOAT,
									Jahr INT
								)

		INSERT @tblAllesKT(
									Lieferant,
									Warengruppe,
									Produktcode,
									Artikel,
									Rechnung,
									Jahr
						)


		SELECT
			Lieferant,
			Warengruppe,
			Produktcode,
			Artikel,
			Rechnung,
			Jahr
		FROM
		(
			SELECT 
				SUPPLIER_NAME AS Lieferant,
				ISNULL((
						SELECT  TOP 1   dbo.DATA0007.PRODUCT_GROUP_NAME
						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER										  
						WHERE 
							dbo.DATA0008.RKEY = PROD_CODE_SELL_PTR
				), '') AS Warengruppe,
				ISNULL((
						SELECT  TOP 1   dbo.DATA0008.PRODUCT_NAME
						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER										  
						WHERE 
							dbo.DATA0008.RKEY = PROD_CODE_SELL_PTR
				), '') AS Produktcode,
				INV_PART_DESCRIPTION AS Artikel,
				CAST(SUM(ISNULL(RWert, 0)+ISNULL(R_NK, 0)) AS FLOAT) AS Rechnung,
				YEAR(Datum) AS Jahr
			FROM 
			(
				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,			
					dbo.DATA0095.TRAN_TP, 
					CASE
						WHEN dbo.DATA0070.STATUS=2 THEN 'Lieferung T' ELSE 'Lieferung' 
					END As TransDesc
					,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0095.ENTERED_DATE AS Datum, dbo.DATA0095.ENTERED_TIME AS Zeit, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
					dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS PRICE, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert, (dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Wnn RE nicht vorhanden dann BE sonst Stamm (Vorgabe Jha)
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
											  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
											  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE  AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK

				FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE    
						(CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND  (dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (
							dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
							OR 
							(dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD)
						)

				UNION ALL --offene Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'offene Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,
					(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					--0 AS RPreis,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
												dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
												dbo.DATA0070 AS D70 INNER JOIN
												dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					--0 AS RWert,
					(dbo.DATA0071.QUAN_RECD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY))*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE  
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
												dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
												dbo.DATA0070 AS D70 INNER JOIN
												dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
					SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE  AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
											dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK
				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY

				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
				
				UNION ALL --Debit/Belastung 

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'Debit/Belast.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, 
					--dbo.DATA0071.QUAN_RECD AS QUANTITY, 
					(-1)*dbo.DATA0219.QUAN_DEBITED AS QUANTITY,
					dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, 
					dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, 
					dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					dbo.DATA0108.PRICE AS RPreis,
					(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert,
					(dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT)/dbo.DATA0132.EX_RATE AS R_NK

				FROM         dbo.DATA0132 INNER JOIN
						  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
						  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Lastschriften

				SELECT  DISTINCT
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 
					'Lastschrift' As TransDesc,
					dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0132.MEMO_DATE AS Datum, '' AS Zeit, 
					--dbo.DATA0108.QUANTITY AS QUANTITY, 
					--0 AS QUANTITY,
					(-1)*dbo.DATA0108.quan_debited AS QUANTITY,
					--ISNULL(dbo.DATA0071.QUAN_REJD + dbo.DATA0071.QUAN_RETN, 0) AS QUANTITY,
					0 AS QUAN_ON_HAND, 
					0 AS CONSIGN_ONHAND_QTY, 
					RTRIM(dbo.DATA0070.PO_NUMBER) + '/' + LTRIM(dbo.DATA0132.MEMO_NUMBER) AS Feld1, 
					dbo.DATA0023.CODE AS Feld2, 
					dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					0 AS PRICE, 
					0 AS Wert, 
					dbo.DATA0070.PO_DATE AS BDatum, 
					0 AS BMenge, 
					0 AS BWert, 
					0 AS NK,
					-- -1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RPreis,
					0 AS RPreis,
					--  -1 * dbo.DATA0108.QUANTITY * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RWert,
					---1 * dbo.DATA0132.MISC_TOT AS RWert,
					-1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE) AS RWert,
					0 AS R_NK

				FROM         dbo.DATA0023 INNER JOIN
						  dbo.DATA0132 ON dbo.DATA0023.RKEY = dbo.DATA0132.SUPP_PTR INNER JOIN
						  dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0132.EMPL_PTR = dbo.DATA0005.RKEY INNER JOIN
						  dbo.DATA0002 INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0002.RKEY = dbo.DATA0071.PURCHASE_UNIT_PTR ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							--AND  (dbo.DATA0070.STATUS = 1)
							--AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Bestellungen in Klärung 

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'in Klärung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,
					(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					0 AS RPreis,
					0 AS RWert,
					(
					SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
											dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 5)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Konsi Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-Lieferung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE AS Wert, 
					dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS BMenge, 
					dbo.DATA0467.QUAN_ORD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND dbo.DATA0341.TRAN_TP=1
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

				UNION ALL --rückgängig Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'rückgäng. Kons' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND dbo.DATA0341.TRAN_TP=15
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --offene Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'offene K-Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
					0 AS RWert, 0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						--AND dbo.DATA0467.QUAN_RECD=0
						AND (dbo.DATA0466.STATUS=1)
						AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --liegende Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-storniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
					0 AS RWert, 0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						--AND dbo.DATA0467.QUAN_RECD=0
						AND (dbo.DATA0466.STATUS=4)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --retournierte Konsi-Bestellungen

				SELECT  
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-retourniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, (-1)*dbo.DATA0467.QUAN_RETN AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, -1*dbo.DATA0467.QUAN_RETN * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN -1*dbo.DATA0467.QUAN_RETN*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 -1*dbo.DATA0467.QUAN_RETN*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						AND dbo.DATA0467.QUAN_RETN>0
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

			)  AS ResTbl
			GROUP BY
				SUPPLIER_NAME, PROD_CODE_SELL_PTR, Datum, INV_PART_DESCRIPTION
		) AS tbl
		WHERE 
			Warengruppe COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para7

		SELECT 
			*
		FROM 
		(
			SELECT 
				Lieferant,
				Warengruppe,
				Produktcode,
				Artikel,
				Jahr,
				Rechnung 
			FROM 
				@tblAllesKT AS tblDaten 
		) AS P 
		PIVOT 
		(
			SUM(Rechnung)
			FOR Jahr IN ( 
							[2014], [2015], [2016], [2017], [2018], [2019], [2020] 
						)
		) AS KTWG 
		ORDER BY
			Lieferant,
			Warengruppe,
			Produktcode,
			Artikel
	END

	IF @Case_ = 'KT_LiefArtSoBE'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255)
		SET @para1 = '%'
		SET @para2 = '%' --Kunde
		SET @para3 = '%' --Kundenteil
		SET @para4 = '%' --PC
		SET @para5 = '01.01.2014'
		SET @para6 = '31.12.2020'
		*/

		DECLARE @tblSoBEKT table (
									Lieferant char(30),
									Artikel char(100),
									Rechnung FLOAT,
									Jahr INT
								)

		INSERT @tblSoBEKT(
									Lieferant,
									Artikel,
									Rechnung,
									Jahr
						)

		SELECT 
			SUPPLIER_NAME AS Lieferant,
			Artikel,
			CAST((ISNULL(RWERT,0)+ISNULL(R_NK,0)) AS FLOAT) AS RE_Wert,
			YEAR(Datum) AS Jahr
		FROM
		(
			SELECT     
				dbo.DATA0023.SUPPLIER_NAME,
				RTRIM(ISNULL(dbo.DATA0072.DESCRIPTION, '')) + ' , ' + LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION2, '')) AS Artikel,
				5 AS TRAN_TP, 
				--'sonstige' As TransDesc,
				CASE
					WHEN dbo.DATA0070.STATUS=1 AND (dbo.DATA0072.QUANTITY_RECEIVED<dbo.DATA0072.QUAN_ORD) THEN 'offene Best.'
					ELSE
						CASE
							WHEN dbo.DATA0070.STATUS=2 THEN 'Lieferung T'
							ELSE
								CASE
									WHEN dbo.DATA0070.STATUS=3 THEN 'storniert'
									ELSE
										CASE
											WHEN dbo.DATA0070.STATUS=5 THEN 'in Klärung'
											ELSE
												CASE
													WHEN dbo.DATA0070.STATUS=6 OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0072.QUANTITY_RECEIVED>=dbo.DATA0072.QUAN_ORD) THEN 'Lieferung'
													ELSE '?????'
												END
										END
								END
						END
				END As TransDesc,dbo.DATA0072.DESCRIPTION + STR(dbo.DATA0072.RKEY) AS INV_PART_NUMBER, dbo.DATA0072.DESCRIPTION2 + STR(dbo.DATA0072.RKEY) AS INV_PART_DESCRIPTION, dbo.DATA0072.DEL_DATE AS Datum, '' AS Zeit, 
				dbo.DATA0072.QUANTITY_RECEIVED AS QUANTITY, 0 AS QUAN_ON_HAND, 0 AS CONSIGN_ONHAND_QTY, dbo.DATA0070.PO_NUMBER AS Feld1, 
				dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, dbo.DATA0005.ABBR_NAME, dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE AS PRICE, 
				dbo.DATA0072.QUANTITY_RECEIVED * dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE  AS Wert, dbo.DATA0070.PO_DATE AS BDatum, dbo.DATA0072.QUAN_ORD AS BMenge, 
				--CASE 
				--	WHEN dbo.DATA0070.STATUS<>3 THEN dbo.DATA0072.QUAN_ORD * dbo.DATA0072.UNIT_PRICE
				--		ELSE 0
				--END AS BWert, 
				dbo.DATA0072.QUAN_ORD * dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert, 
				(dbo.DATA0070.SHIPPING_COST + dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
				--0 AS RPreis,
				--0 AS RWert,
				--0 AS R_NK
				(
					SELECT     TOP 1 
					CASE
						WHEN ISNULL(D109.PRICE, 0)>0 THEN D109.PRICE/D107.EX_RATE
							ELSE 
								ISNULL(D72.UNIT_PRICE/D70.EXCHANGE_RATE, 0)
					END AS RPreis
					--FROM         dbo.DATA0070 AS D70 INNER JOIN
					--					  dbo.DATA0072 AS D72 ON D70.RKEY = D72.POPTR LEFT OUTER JOIN
					--					  dbo.DATA0109 ON D72.RKEY = dbo.DATA0109.DATA0072_PTR
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER)
					--FROM         dbo.DATA0072 AS D72 LEFT OUTER JOIN
					--					  dbo.DATA0109 ON D72.RKEY = dbo.DATA0109.DATA0072_PTR
					FROM         dbo.DATA0070 AS d70 INNER JOIN
											dbo.DATA0072 AS D72 ON d70.RKEY = D72.POPTR LEFT OUTER JOIN
											dbo.DATA0107 AS D107 INNER JOIN
											dbo.DATA0109 AS d109 ON D107.RKEY = d109.DATA0107_PTR ON D72.RKEY = d109.DATA0072_PTR
					WHERE     (D72.RKEY = dbo.DATA0072.RKEY)
				) AS RPreis,
				dbo.DATA0072.QUANTITY_RECEIVED*
				(
					SELECT     TOP 1 
					CASE
						WHEN ISNULL(D109.PRICE, 0)>0 THEN D109.PRICE/D107.EX_RATE
							ELSE 
								ISNULL(D72.UNIT_PRICE/D70.EXCHANGE_RATE, 0)
					END AS RPreis
					--FROM         dbo.DATA0070 AS D70 INNER JOIN
					--					  dbo.DATA0072 AS D72 ON D70.RKEY = D72.POPTR LEFT OUTER JOIN
					--					  dbo.DATA0109 ON D72.RKEY = dbo.DATA0109.DATA0072_PTR
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER)
					--FROM         dbo.DATA0072 AS D72 LEFT OUTER JOIN
					--					  dbo.DATA0109 ON D72.RKEY = dbo.DATA0109.DATA0072_PTR
					FROM         dbo.DATA0070 AS d70 INNER JOIN
											dbo.DATA0072 AS D72 ON d70.RKEY = D72.POPTR LEFT OUTER JOIN
											dbo.DATA0107 AS D107 INNER JOIN
											dbo.DATA0109 AS d109 ON D107.RKEY = d109.DATA0107_PTR ON D72.RKEY = d109.DATA0072_PTR
					WHERE     (D72.RKEY = dbo.DATA0072.RKEY)
				) AS RWert,
				(
				SELECT     TOP 1 
					CASE
						WHEN ISNULL(dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT, 0)>0 THEN dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT
						ELSE
							ISNULL(dbo.DATA0070.SHIPPING_COST + dbo.DATA0070.MISC_CHARGE, 0)
					END AS RES
					FROM         dbo.DATA0107 INNER JOIN
									dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR RIGHT OUTER JOIN
									dbo.DATA0070 AS D70 INNER JOIN
									dbo.DATA0072 AS D72 ON D70.RKEY = D72.POPTR ON dbo.DATA0109.DATA0072_PTR = D72.RKEY
					WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER)
				)/dbo.DATA0070.EXCHANGE_RATE AS R_NK

			FROM         dbo.DATA0072 INNER JOIN
									dbo.DATA0070 ON dbo.DATA0072.POPTR = dbo.DATA0070.RKEY INNER JOIN
									dbo.DATA0002 ON dbo.DATA0072.UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
			WHERE      (dbo.DATA0072.DESCRIPTION + ' ' + ISNULL(dbo.DATA0072.DESCRIPTION2, '') COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 
							OR dbo.DATA0072.DESCRIPTION + ' ' + ISNULL(dbo.DATA0072.DESCRIPTION2, '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
						--AND  (dbo.DATA0071.QUAN_RECD = 0)
						AND  (dbo.DATA0070.STATUS <> 3)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0072.DEL_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0072.DEL_DATE <= CONVERT(DATETIME, @para6, 103))

			UNION ALL

			SELECT DISTINCT   
				dbo.DATA0023.SUPPLIER_NAME, 
				RTRIM(ISNULL(dbo.DATA0072.DESCRIPTION, '')) + ' , ' + LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION2, '')) AS Artikel,
				5 AS TRAN_TP, 
				'Lastschrift' As TransDesc,
				dbo.DATA0072.DESCRIPTION + STR(dbo.DATA0072.RKEY) AS INV_PART_NUMBER, 
				dbo.DATA0072.DESCRIPTION2 + STR(dbo.DATA0072.RKEY) AS INV_PART_DESCRIPTION, 
				dbo.DATA0132.MEMO_DATE AS Datum, '' AS Zeit, 
				-- dbo.DATA0109.QUANTITY AS QUANTITY, 
				0 AS QUANTITY, 
				0 AS QUAN_ON_HAND, 
				0 AS CONSIGN_ONHAND_QTY, 
				--dbo.DATA0070.PO_NUMBER AS Feld1, 
				RTRIM(dbo.DATA0070.PO_NUMBER) + '/' + LTRIM(dbo.DATA0132.MEMO_NUMBER) AS Feld1, 
				dbo.DATA0023.CODE AS Feld2, 
				dbo.DATA0002.UNIT_CODE, 
				dbo.DATA0005.ABBR_NAME, 
				0 AS PRICE, 
				0 AS Wert, 
				dbo.DATA0070.PO_DATE AS BDatum, 
				0 AS BMenge, 
				0 AS BWert, 
				0 AS NK,
				---1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0109.QUANTITY) AS RPreis,
				0 AS RPreis,
				-- -1 * dbo.DATA0109.QUANTITY * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0109.QUANTITY) AS RWert,
				-1 * dbo.DATA0132.MISC_TOT/dbo.DATA0070.EXCHANGE_RATE AS RWert,
				0 AS R_NK

			FROM         dbo.DATA0023 INNER JOIN
									dbo.DATA0132 ON dbo.DATA0023.RKEY = dbo.DATA0132.SUPP_PTR INNER JOIN
									dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
									dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR INNER JOIN
									dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR INNER JOIN
									dbo.DATA0005 ON dbo.DATA0132.EMPL_PTR = dbo.DATA0005.RKEY INNER JOIN
									dbo.DATA0002 ON dbo.DATA0072.UNIT_PTR = dbo.DATA0002.RKEY
			WHERE      (dbo.DATA0072.DESCRIPTION + ' ' + dbo.DATA0072.DESCRIPTION2 COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 
							OR dbo.DATA0072.DESCRIPTION + ' ' + dbo.DATA0072.DESCRIPTION2 COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
						--AND  (dbo.DATA0071.QUAN_RECD = 0)
						AND  (dbo.DATA0070.STATUS <> 3)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0072.DEL_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0072.DEL_DATE <= CONVERT(DATETIME, @para6, 103))
		) AS tblSonst



		SELECT 
			*
		FROM 
		(
			SELECT 
				Lieferant,
				Artikel,
				Jahr,
				Rechnung 
			FROM 
				@tblSoBEKT AS tblDaten 
		) AS P 
		PIVOT 
		(
			SUM(Rechnung)
			FOR Jahr IN ( 
							[2014], [2015], [2016], [2017], [2018], [2019], [2020] 
						)
		) AS KTWG 
		ORDER BY
			Lieferant,
			Artikel
	END

	IF @Case_ = 'KT_LiefWGrpPCArt_Preise'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255),
			@para7 varchar(255)
		SET @para1 = '%'
		SET @para2 = '%' --Kunde
		SET @para3 = '%' --Kundenteil
		SET @para4 = '%' --PC
		SET @para5 = '01.01.2014'
		SET @para6 = '31.12.2020'
		SET @para7 = '%'
		*/


		--Lieferantenbezeichnung holen
		DECLARE @tblLiefArtikel table (
									Artikel char(100),
									ArtikelLief char(60)
									)

		--Alle Artikel selektieren, die nur einen Lieferanten haben
		INSERT @tblLiefArtikel(
									Artikel,
									ArtikelLief
							)
		SELECT
			--dbo.DATA0017.INV_PART_DESCRIPTION,
			CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')='' THEN dbo.DATA0017.INV_PART_DESCRIPTION ELSE dbo.DATA0017.LONG_INVENTORY_PART_NUMBER END AS Artikel,
			dbo.DATA0028.SUPPLIER_PART_NO
		FROM         dbo.DATA0017 INNER JOIN
							  dbo.DATA0028 ON dbo.DATA0017.RKEY = dbo.DATA0028.INVENTORY_PTR
		WHERE
			ISNULL(dbo.DATA0028.SUPPLIER_PART_NO, '') <> ''
			AND dbo.DATA0028.INVENTORY_PTR IN (
											SELECT
												D17_PTR
											FROM
											(
												SELECT
													COUNT(D28.SUPPLIER_PART_NO) AS AnzLief, 
													D28.INVENTORY_PTR AS D17_PTR
												FROM   
													dbo.DATA0028 AS D28
												WHERE
													ISNULL(D28.SUPPLIER_PART_NO, '') <> ''
												GROUP BY 
													D28.INVENTORY_PTR
											) AS tblGrpLief
											WHERE
												AnzLief = 1
										)


		--Bei Artikel, die mehrere Lieferanten haben, die Lieferantenbezeichnung aus der letzten Bestellung des Lieferanten holen
		INSERT @tblLiefArtikel(
									Artikel,
									ArtikelLief
							)

		SELECT DISTINCT
			--dbo.DATA0017.INV_PART_DESCRIPTION AS Artikel,
			CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')='' THEN dbo.DATA0017.INV_PART_DESCRIPTION ELSE dbo.DATA0017.LONG_INVENTORY_PART_NUMBER END AS Artikel,
			ISNULL((
					SELECT TOP 1
						SUPPLIER_PART_NO
					FROM
						dbo.DATA0028
					WHERE
						dbo.DATA0028.SUPPLIER_PTR = (
															SELECT TOP 1
																D70.SUPPLIER_POINTER
															FROM         dbo.DATA0017 D17 INNER JOIN
																					dbo.DATA0071 AS D71 ON D17.RKEY = D71.INVT_PTR INNER JOIN
																					dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY
															WHERE
																D17.RKEY = dbo.DATA0017.RKEY
															ORDER BY
																D70.PO_DATE DESC
														)
						AND dbo.DATA0028.INVENTORY_PTR = dbo.DATA0017.RKEY
			), '') AS Lieferantenbezeichnung
			--dbo.DATA0028.SUPPLIER_PART_NO
		FROM         dbo.DATA0017 INNER JOIN
							  dbo.DATA0028 ON dbo.DATA0017.RKEY = dbo.DATA0028.INVENTORY_PTR
		WHERE
			ISNULL(dbo.DATA0028.SUPPLIER_PART_NO, '') <> ''
			AND dbo.DATA0028.INVENTORY_PTR IN (
											SELECT
												D17_PTR
											FROM
											(
												SELECT
													COUNT(D28.SUPPLIER_PART_NO) AS AnzLief, 
													D28.INVENTORY_PTR AS D17_PTR
												FROM   
													dbo.DATA0028 AS D28
												WHERE
													ISNULL(D28.SUPPLIER_PART_NO, '') <> ''
												GROUP BY 
													D28.INVENTORY_PTR
											) AS tblGrpLief
											WHERE
												AnzLief > 1
										)
		-------------------------------


		DECLARE @tblAllesKTPreise table (
									Lieferant char(30),
									Warengruppe char(30),
									Produktcode char(30),
									Artikel char(100),
									ArtikelLief char(60),
									D17_PTR NUMERIC(10, 0),
									Rechnung FLOAT,
									Jahr INT,
									EKEinheit varchar(5)
								)

		INSERT @tblAllesKTPreise(
									Lieferant,
									Warengruppe,
									Produktcode,
									Artikel,
									ArtikelLief,
									D17_PTR,
									Rechnung,
									Jahr,
									EKEinheit
						)


		SELECT
			Lieferant,
			Warengruppe,
			Produktcode,
			Artikel,
			ISNULL((
					SELECT TOP 1 tblLiefArtikel.ArtikelLief FROM @tblLiefArtikel AS tblLiefArtikel WHERE tblLiefArtikel.Artikel COLLATE SQL_Latin1_General_CP1_CI_AS = tbl.Artikel
			), '') AS ArtikelLief,
			D17_PTR,
			Rechnung,
			Jahr,
			EKEinheit
		FROM
		(
			SELECT 
				D17_PTR,
				SUPPLIER_NAME AS Lieferant,
				ISNULL((
						SELECT  TOP 1   dbo.DATA0007.PRODUCT_GROUP_NAME
						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER										  
						WHERE 
							dbo.DATA0008.RKEY = PROD_CODE_SELL_PTR
				), '') AS Warengruppe,
				ISNULL((
						SELECT  TOP 1   dbo.DATA0008.PRODUCT_NAME
						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER										  
						WHERE 
							dbo.DATA0008.RKEY = PROD_CODE_SELL_PTR
				), '') AS Produktcode,
				INV_PART_DESCRIPTION AS Artikel,
				--CAST(SUM(ISNULL(RWert, 0)+ISNULL(R_NK, 0)) AS FLOAT) AS Rechnung,
				--CAST(SUM(ISNULL(RWert, 0)) AS FLOAT) AS Rechnung,
				CAST(SUM(ISNULL(RWert, 0)+ISNULL(R_NK, 0)) AS FLOAT) AS Rechnung,
				YEAR(Datum) AS Jahr,
				BMenge,
				UNIT_CODE AS EKEinheit
			FROM 
			(
				SELECT  
					dbo.DATA0017.RKEY AS D17_PTR,
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,			
					dbo.DATA0095.TRAN_TP, 
					CASE
						WHEN dbo.DATA0070.STATUS=2 THEN 'Lieferung T' ELSE 'Lieferung' 
					END As TransDesc
					,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0095.ENTERED_DATE AS Datum, dbo.DATA0095.ENTERED_TIME AS Zeit, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
					dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS PRICE, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert, (dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Wnn RE nicht vorhanden dann BE sonst Stamm (Vorgabe Jha)
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
											  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
											  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE  AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK

				FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE    
						(CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND  (dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (
							dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
							OR 
							(dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD)
						)

				UNION ALL --offene Bestellungen

				SELECT  
					dbo.DATA0017.RKEY AS D17_PTR,
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'offene Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,
					(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					--0 AS RPreis,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
												dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
												dbo.DATA0070 AS D70 INNER JOIN
												dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					--0 AS RWert,
					(dbo.DATA0071.QUAN_RECD)*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE  
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0107 AS D107 INNER JOIN
												dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
												dbo.DATA0070 AS D70 INNER JOIN
												dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
					SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE  AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
											dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK
				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY

				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
				
				UNION ALL --Debit/Belastung 

				SELECT  
					dbo.DATA0017.RKEY AS D17_PTR,
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'Debit/Belast.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, 
					--dbo.DATA0071.QUAN_RECD AS QUANTITY, 
					(-1)*dbo.DATA0219.QUAN_DEBITED AS QUANTITY,
					dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, 
					dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, 
					dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					dbo.DATA0108.PRICE AS RPreis,
					(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert,
					(dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT)/dbo.DATA0132.EX_RATE AS R_NK

				FROM         dbo.DATA0132 INNER JOIN
						  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
						  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Lastschriften

				SELECT  DISTINCT
					dbo.DATA0017.RKEY AS D17_PTR,
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 
					'Lastschrift' As TransDesc,
					dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0132.MEMO_DATE AS Datum, '' AS Zeit, 
					--dbo.DATA0108.QUANTITY AS QUANTITY, 
					--0 AS QUANTITY,
					(-1)*dbo.DATA0108.quan_debited AS QUANTITY,
					--ISNULL(dbo.DATA0071.QUAN_REJD + dbo.DATA0071.QUAN_RETN, 0) AS QUANTITY,
					0 AS QUAN_ON_HAND, 
					0 AS CONSIGN_ONHAND_QTY, 
					RTRIM(dbo.DATA0070.PO_NUMBER) + '/' + LTRIM(dbo.DATA0132.MEMO_NUMBER) AS Feld1, 
					dbo.DATA0023.CODE AS Feld2, 
					dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					0 AS PRICE, 
					0 AS Wert, 
					dbo.DATA0070.PO_DATE AS BDatum, 
					0 AS BMenge, 
					0 AS BWert, 
					0 AS NK,
					-- -1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RPreis,
					0 AS RPreis,
					--  -1 * dbo.DATA0108.QUANTITY * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RWert,
					---1 * dbo.DATA0132.MISC_TOT AS RWert,
					-1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE) AS RWert,
					0 AS R_NK

				FROM         dbo.DATA0023 INNER JOIN
						  dbo.DATA0132 ON dbo.DATA0023.RKEY = dbo.DATA0132.SUPP_PTR INNER JOIN
						  dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0132.EMPL_PTR = dbo.DATA0005.RKEY INNER JOIN
						  dbo.DATA0002 INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0002.RKEY = dbo.DATA0071.PURCHASE_UNIT_PTR ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							--AND  (dbo.DATA0070.STATUS = 1)
							--AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Bestellungen in Klärung 

				SELECT  
					dbo.DATA0017.RKEY AS D17_PTR,

					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'in Klärung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
						dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME,
					dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert,
					(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
					--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
					0 AS RPreis,
					0 AS RWert,
					(
					SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0107.EX_RATE AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
											dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 5)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --Konsi Bestellungen

				SELECT 
					dbo.DATA0017.RKEY AS D17_PTR, 
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-Lieferung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE AS Wert, 
					dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS BMenge, 
					dbo.DATA0467.QUAN_ORD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND dbo.DATA0341.TRAN_TP=1
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

				UNION ALL --rückgängig Konsi-Bestellungen

				SELECT  
					dbo.DATA0017.RKEY AS D17_PTR,
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'rückgäng. Kons' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND dbo.DATA0341.TRAN_TP=15
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --offene Konsi-Bestellungen

				SELECT 
					dbo.DATA0017.RKEY AS D17_PTR, 
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'offene K-Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
					0 AS RWert, 0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						--AND dbo.DATA0467.QUAN_RECD=0
						AND (dbo.DATA0466.STATUS=1)
						AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --liegende Konsi-Bestellungen

				SELECT  
					dbo.DATA0017.RKEY AS D17_PTR,
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-storniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
					0 AS RWert, 0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						--AND dbo.DATA0467.QUAN_RECD=0
						AND (dbo.DATA0466.STATUS=4)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL --retournierte Konsi-Bestellungen

				SELECT  
					dbo.DATA0017.RKEY AS D17_PTR,
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0017.PROD_CODE_SELL_PTR,
					5 AS TRAN_TP, 'K-retourniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, (-1)*dbo.DATA0467.QUAN_RETN AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
					'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME
					,  dbo.DATA0467.PRICE, -1*dbo.DATA0467.QUAN_RETN * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
					dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN -1*dbo.DATA0467.QUAN_RETN*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 -1*dbo.DATA0467.QUAN_RETN*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS R_NK

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						AND dbo.DATA0467.QUAN_RETN>0
						AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))

			)  AS ResTbl
			GROUP BY
				D17_PTR, SUPPLIER_NAME, PROD_CODE_SELL_PTR, Datum, INV_PART_DESCRIPTION, BMenge, UNIT_CODE
		) AS tbl
		WHERE 
			Warengruppe COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para7

		--SELECT * FROM @tblAllesKT

		SELECT 
			*,
			ISNULL((
					SELECT TOP 1
						ISNULL(
							CASE WHEN ISNULL(D108.PRICE, 0)>0 THEN 
								D108.PRICE/D107.EX_RATE ELSE D71.PRICE/D70.EXCHANGE_RATE
							END
						, 0) AS RES
					FROM         dbo.DATA0108 AS D108 INNER JOIN
											dbo.DATA0107 AS D107 ON D108.DATA0107_PTR = D107.RKEY RIGHT OUTER JOIN
											dbo.DATA0095 AS D95 INNER JOIN
											dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
					WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = D17_PTR)
					ORDER BY D95.TRAN_DATE DESC
			), 0) AS LtzPreis,
			ISNULL((
					SELECT TOP 1
						SUM (
							CASE WHEN RPreis>0 THEN 
								RPreis/RWK*RMenge ELSE BPreis/BWK*BMenge
							END
						)
						/
						SUM(
							CASE WHEN RPreis>0 THEN 
								RMenge ELSE BMenge
							END
						)

					FROM
					(
						SELECT     ISNULL(D108.QUANTITY, 0) AS RMenge, ISNULL(D108.PRICE, 0) AS RPreis, ISNULL(D107.EX_RATE, 0) AS RWK, 
									D71.PRICE AS BPreis, D71.QUAN_RECD - D71.QUAN_RETN AS BMenge, D70.EXCHANGE_RATE AS BWK
						FROM         dbo.DATA0108 AS D108 INNER JOIN
											  dbo.DATA0107 AS D107 ON D108.DATA0107_PTR = D107.RKEY RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = D17_PTR) 
						AND YEAR(D95.TRAN_DATE) = YEAR(GETDATE())-2
						AND (ISNULL(D71.PRICE, 0) > 0)
						AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
						AND D70.STATUS <> 3
					) AS tblBE
			), 0) AS DPreis2,
			ISNULL((
					SELECT TOP 1
						SUM (
							CASE WHEN RPreis>0 THEN 
								RPreis/RWK*RMenge ELSE BPreis/BWK*BMenge
							END
						)
						/
						SUM(
							CASE WHEN RPreis>0 THEN 
								RMenge ELSE BMenge
							END
						)
					FROM
					(
						SELECT     ISNULL(D108.QUANTITY, 0) AS RMenge, ISNULL(D108.PRICE, 0) AS RPreis, ISNULL(D107.EX_RATE, 0) AS RWK, 
									D71.PRICE AS BPreis, D71.QUAN_RECD - D71.QUAN_RETN AS BMenge, D70.EXCHANGE_RATE AS BWK
						FROM         dbo.DATA0108 AS D108 INNER JOIN
											  dbo.DATA0107 AS D107 ON D108.DATA0107_PTR = D107.RKEY RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = D17_PTR) 
						AND YEAR(D95.TRAN_DATE) = YEAR(GETDATE())-1
						AND (ISNULL(D71.PRICE, 0) > 0)
						AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
						AND D70.STATUS <> 3
					) AS tblBE
			), 0) AS DPreis1,
			ISNULL((
					SELECT TOP 1
						SUM (
							CASE WHEN RPreis>0 THEN 
								RPreis/RWK*RMenge ELSE BPreis/BWK*BMenge
							END
						)
						/
						SUM(
							CASE WHEN RPreis>0 THEN 
								RMenge ELSE BMenge
							END
						)
					FROM
					(
						SELECT     ISNULL(D108.QUANTITY, 0) AS RMenge, ISNULL(D108.PRICE, 0) AS RPreis, ISNULL(D107.EX_RATE, 0) AS RWK, 
									D71.PRICE AS BPreis, D71.QUAN_RECD - D71.QUAN_RETN AS BMenge, D70.EXCHANGE_RATE AS BWK
						FROM         dbo.DATA0108 AS D108 INNER JOIN
											  dbo.DATA0107 AS D107 ON D108.DATA0107_PTR = D107.RKEY RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = D17_PTR) 
						AND YEAR(D95.TRAN_DATE) = YEAR(GETDATE())
						AND (ISNULL(D71.PRICE, 0) > 0)
						AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
						AND D70.STATUS <> 3
					) AS tblBE
			), 0) AS DPreis,
			ISNULL((
				dbo.F_dsi_EKMengeGGP(D17_PTR, '01.01.' + LTRIM(STR(YEAR(GETDATE())-2)), '31.12.' + LTRIM(STR(YEAR(GETDATE())-2))) 
				+
				dbo.F_dsi_EKMengeKonsi(D17_PTR, '01.01.' + LTRIM(STR(YEAR(GETDATE())-2)), '31.12.' + LTRIM(STR(YEAR(GETDATE())-2))) 
			), 0) AS EKMenge2,
			ISNULL((
				dbo.F_dsi_EKMengeGGP(D17_PTR, '01.01.' + LTRIM(STR(YEAR(GETDATE())-1)), '31.12.' + LTRIM(STR(YEAR(GETDATE())-1))) 
				+
				dbo.F_dsi_EKMengeKonsi(D17_PTR, '01.01.' + LTRIM(STR(YEAR(GETDATE())-1)), '31.12.' + LTRIM(STR(YEAR(GETDATE())-1))) 
			), 0) AS EKMenge1,
			ISNULL((
				dbo.F_dsi_EKMengeGGP(D17_PTR, '01.01.' + LTRIM(STR(YEAR(GETDATE()))), '31.12.' + LTRIM(STR(YEAR(GETDATE())))) 
				+
				dbo.F_dsi_EKMengeKonsi(D17_PTR, '01.01.' + LTRIM(STR(YEAR(GETDATE()))), '31.12.' + LTRIM(STR(YEAR(GETDATE())))) 
			), 0) AS EKMenge
		FROM 
		(
			SELECT 
				Lieferant,
				Warengruppe,
				Produktcode,
				Artikel,
				ArtikelLief,
				D17_PTR,
				Jahr,
				Rechnung,
				EKEinheit
			FROM 
				@tblAllesKTPreise AS tblDaten 
		) AS P 
		PIVOT 
		(
			SUM(Rechnung)
			FOR Jahr IN ( 
							[2014], [2015], [2016], [2017], [2018], [2019], [2020] 
						)
		) AS KTWG 
		ORDER BY
			ISNULL([2014], 0) + ISNULL([2015], 0) + ISNULL([2016], 0) + ISNULL([2017], 0) + ISNULL([2018], 0) + ISNULL([2019], 0) + ISNULL([2020], 0) DESC,
			Lieferant,
			Warengruppe,
			Produktcode,
			Artikel,
			ArtikelLief,
			D17_PTR
	END

	IF @Case_ = 'Fremdleistung'
	BEGIN
		SELECT
			Fremdleistung,
			SUM(CAST(DezVJ AS FLOAT)) AS DezVJ,
			SUM(CAST(Jan AS FLOAT)) AS Jan,
			SUM(CAST(Feb AS FLOAT)) AS Feb,
			SUM(CAST(Mrz AS FLOAT)) AS Mrz,
			SUM(CAST(Apr AS FLOAT)) AS Apr,
			SUM(CAST(Mai AS FLOAT)) AS Mai,
			SUM(CAST(Jun AS FLOAT)) AS Jun,
			SUM(CAST(Jul AS FLOAT)) AS Jul,
			SUM(CAST(Aug AS FLOAT)) AS Aug,
			SUM(CAST(Sep AS FLOAT)) AS Sep,
			SUM(CAST(Okt AS FLOAT)) AS Okt,
			SUM(CAST(Nov AS FLOAT)) AS Nov,
			SUM(CAST(Dez AS FLOAT)) AS Dez
		FROM
		(
			SELECT
				CASE
					WHEN Fremdleistung = 'DL:Annico' THEN
						'Annico'
					ELSE
						CASE
							WHEN Fremdleistung = 'Hofstetter' THEN
								'chem. Nickel/Gold red. Palladium'
							ELSE
								CASE
									WHEN Fremdleistung = 'DL:ETZ' OR Fremdleistung = 'ETZ' THEN
										'E-Test'
									ELSE
										Fremdleistung
								END
						END
				END AS Fremdleistung,
				ISNULL((
						SELECT TOP 1
							SUM((REMenge*Preis_EUR)+NK_EUR) AS Wert
						FROM
						(
							SELECT DISTINCT
								LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) AS FL, 
								dbo.DATA0109.RKEY AS D109_PTR,
								dbo.DATA0109.QUANTITY AS REMenge,
								dbo.DATA0109.PRICE / dbo.DATA0107.EX_RATE AS Preis_EUR,
								dbo.DATA0107.MISC_TOT / dbo.DATA0107.EX_RATE AS NK_EUR
							FROM         dbo.DATA0023 INNER JOIN
													dbo.DATA0070 INNER JOIN
													dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR ON dbo.DATA0023.RKEY = dbo.DATA0070.SUPPLIER_POINTER INNER JOIN --LEFT OUTER JOIN
													dbo.DATA0107 INNER JOIN
													dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR ON dbo.DATA0072.RKEY = dbo.DATA0109.DATA0072_PTR
							WHERE     
								(dbo.DATA0072.DESCRIPTION2 <> '') --AND (LEFT(dbo.DATA0072.DESCRIPTION, 3) = 'DL:')
								AND LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) = Fremdleistung
								AND YEAR(dbo.DATA0107.INV_DATE)=YEAR(GETDATE())-1
								AND MONTH(dbo.DATA0107.INV_DATE)=12
						) AS tblSoRe
						GROUP BY
							FL
				), 0) AS DezVJ,
				ISNULL((
						SELECT TOP 1
							SUM((REMenge*Preis_EUR)+NK_EUR) AS Wert
						FROM
						(
							SELECT DISTINCT
								LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) AS FL, 
								dbo.DATA0109.RKEY AS D109_PTR,
								dbo.DATA0109.QUANTITY AS REMenge,
								dbo.DATA0109.PRICE / dbo.DATA0107.EX_RATE AS Preis_EUR,
								dbo.DATA0107.MISC_TOT / dbo.DATA0107.EX_RATE AS NK_EUR
							FROM         dbo.DATA0023 INNER JOIN
													dbo.DATA0070 INNER JOIN
													dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR ON dbo.DATA0023.RKEY = dbo.DATA0070.SUPPLIER_POINTER INNER JOIN --LEFT OUTER JOIN
													dbo.DATA0107 INNER JOIN
													dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR ON dbo.DATA0072.RKEY = dbo.DATA0109.DATA0072_PTR
							WHERE     
								(dbo.DATA0072.DESCRIPTION2 <> '') --AND (LEFT(dbo.DATA0072.DESCRIPTION, 3) = 'DL:')
								AND LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) = Fremdleistung
								AND YEAR(dbo.DATA0107.INV_DATE)=YEAR(GETDATE())
								AND MONTH(dbo.DATA0107.INV_DATE)=1
						) AS tblSoRe
						GROUP BY
							FL
				), 0) AS Jan,
				ISNULL((
						SELECT TOP 1
							SUM((REMenge*Preis_EUR)+NK_EUR) AS Wert
						FROM
						(
							SELECT DISTINCT
								LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) AS FL, 
								dbo.DATA0109.RKEY AS D109_PTR,
								dbo.DATA0109.QUANTITY AS REMenge,
								dbo.DATA0109.PRICE / dbo.DATA0107.EX_RATE AS Preis_EUR,
								dbo.DATA0107.MISC_TOT / dbo.DATA0107.EX_RATE AS NK_EUR
							FROM         dbo.DATA0023 INNER JOIN
													dbo.DATA0070 INNER JOIN
													dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR ON dbo.DATA0023.RKEY = dbo.DATA0070.SUPPLIER_POINTER INNER JOIN --LEFT OUTER JOIN
													dbo.DATA0107 INNER JOIN
													dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR ON dbo.DATA0072.RKEY = dbo.DATA0109.DATA0072_PTR
							WHERE     
								(dbo.DATA0072.DESCRIPTION2 <> '') --AND (LEFT(dbo.DATA0072.DESCRIPTION, 3) = 'DL:')
								AND LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) = Fremdleistung
								AND YEAR(dbo.DATA0107.INV_DATE)=YEAR(GETDATE())
								AND MONTH(dbo.DATA0107.INV_DATE)=2
						) AS tblSoRe
						GROUP BY
							FL
				), 0) AS Feb,
				ISNULL((
						SELECT TOP 1
							SUM((REMenge*Preis_EUR)+NK_EUR) AS Wert
						FROM
						(
							SELECT DISTINCT
								LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) AS FL, 
								dbo.DATA0109.RKEY AS D109_PTR,
								dbo.DATA0109.QUANTITY AS REMenge,
								dbo.DATA0109.PRICE / dbo.DATA0107.EX_RATE AS Preis_EUR,
								dbo.DATA0107.MISC_TOT / dbo.DATA0107.EX_RATE AS NK_EUR
							FROM         dbo.DATA0023 INNER JOIN
													dbo.DATA0070 INNER JOIN
													dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR ON dbo.DATA0023.RKEY = dbo.DATA0070.SUPPLIER_POINTER INNER JOIN --LEFT OUTER JOIN
													dbo.DATA0107 INNER JOIN
													dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR ON dbo.DATA0072.RKEY = dbo.DATA0109.DATA0072_PTR
							WHERE     
								(dbo.DATA0072.DESCRIPTION2 <> '') --AND (LEFT(dbo.DATA0072.DESCRIPTION, 3) = 'DL:')
								AND LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) = Fremdleistung
								AND YEAR(dbo.DATA0107.INV_DATE)=YEAR(GETDATE())
								AND MONTH(dbo.DATA0107.INV_DATE)=3
						) AS tblSoRe
						GROUP BY
							FL
				), 0) AS Mrz,
				ISNULL((
						SELECT TOP 1
							SUM((REMenge*Preis_EUR)+NK_EUR) AS Wert
						FROM
						(
							SELECT DISTINCT
								LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) AS FL, 
								dbo.DATA0109.RKEY AS D109_PTR,
								dbo.DATA0109.QUANTITY AS REMenge,
								dbo.DATA0109.PRICE / dbo.DATA0107.EX_RATE AS Preis_EUR,
								dbo.DATA0107.MISC_TOT / dbo.DATA0107.EX_RATE AS NK_EUR
							FROM         dbo.DATA0023 INNER JOIN
													dbo.DATA0070 INNER JOIN
													dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR ON dbo.DATA0023.RKEY = dbo.DATA0070.SUPPLIER_POINTER INNER JOIN --LEFT OUTER JOIN
													dbo.DATA0107 INNER JOIN
													dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR ON dbo.DATA0072.RKEY = dbo.DATA0109.DATA0072_PTR
							WHERE     
								(dbo.DATA0072.DESCRIPTION2 <> '') --AND (LEFT(dbo.DATA0072.DESCRIPTION, 3) = 'DL:')
								AND LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) = Fremdleistung
								AND YEAR(dbo.DATA0107.INV_DATE)=YEAR(GETDATE())
								AND MONTH(dbo.DATA0107.INV_DATE)=4
						) AS tblSoRe
						GROUP BY
							FL
				), 0) AS Apr,
				ISNULL((
						SELECT TOP 1
							SUM((REMenge*Preis_EUR)+NK_EUR) AS Wert
						FROM
						(
							SELECT DISTINCT
								LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) AS FL, 
								dbo.DATA0109.RKEY AS D109_PTR,
								dbo.DATA0109.QUANTITY AS REMenge,
								dbo.DATA0109.PRICE / dbo.DATA0107.EX_RATE AS Preis_EUR,
								dbo.DATA0107.MISC_TOT / dbo.DATA0107.EX_RATE AS NK_EUR
							FROM         dbo.DATA0023 INNER JOIN
													dbo.DATA0070 INNER JOIN
													dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR ON dbo.DATA0023.RKEY = dbo.DATA0070.SUPPLIER_POINTER INNER JOIN --LEFT OUTER JOIN
													dbo.DATA0107 INNER JOIN
													dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR ON dbo.DATA0072.RKEY = dbo.DATA0109.DATA0072_PTR
							WHERE     
								(dbo.DATA0072.DESCRIPTION2 <> '') --AND (LEFT(dbo.DATA0072.DESCRIPTION, 3) = 'DL:')
								AND LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) = Fremdleistung
								AND YEAR(dbo.DATA0107.INV_DATE)=YEAR(GETDATE())
								AND MONTH(dbo.DATA0107.INV_DATE)=5
						) AS tblSoRe
						GROUP BY
							FL
				), 0) AS Mai,
				ISNULL((
						SELECT TOP 1
							SUM((REMenge*Preis_EUR)+NK_EUR) AS Wert
						FROM
						(
							SELECT DISTINCT
								LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) AS FL, 
								dbo.DATA0109.RKEY AS D109_PTR,
								dbo.DATA0109.QUANTITY AS REMenge,
								dbo.DATA0109.PRICE / dbo.DATA0107.EX_RATE AS Preis_EUR,
								dbo.DATA0107.MISC_TOT / dbo.DATA0107.EX_RATE AS NK_EUR
							FROM         dbo.DATA0023 INNER JOIN
													dbo.DATA0070 INNER JOIN
													dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR ON dbo.DATA0023.RKEY = dbo.DATA0070.SUPPLIER_POINTER INNER JOIN --LEFT OUTER JOIN
													dbo.DATA0107 INNER JOIN
													dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR ON dbo.DATA0072.RKEY = dbo.DATA0109.DATA0072_PTR
							WHERE     
								(dbo.DATA0072.DESCRIPTION2 <> '') --AND (LEFT(dbo.DATA0072.DESCRIPTION, 3) = 'DL:')
								AND LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) = Fremdleistung
								AND YEAR(dbo.DATA0107.INV_DATE)=YEAR(GETDATE())
								AND MONTH(dbo.DATA0107.INV_DATE)=6
						) AS tblSoRe
						GROUP BY
							FL
				), 0) AS Jun,
				ISNULL((
						SELECT TOP 1
							SUM((REMenge*Preis_EUR)+NK_EUR) AS Wert
						FROM
						(
							SELECT DISTINCT
								LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) AS FL, 
								dbo.DATA0109.RKEY AS D109_PTR,
								dbo.DATA0109.QUANTITY AS REMenge,
								dbo.DATA0109.PRICE / dbo.DATA0107.EX_RATE AS Preis_EUR,
								dbo.DATA0107.MISC_TOT / dbo.DATA0107.EX_RATE AS NK_EUR
							FROM         dbo.DATA0023 INNER JOIN
													dbo.DATA0070 INNER JOIN
													dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR ON dbo.DATA0023.RKEY = dbo.DATA0070.SUPPLIER_POINTER INNER JOIN --LEFT OUTER JOIN
													dbo.DATA0107 INNER JOIN
													dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR ON dbo.DATA0072.RKEY = dbo.DATA0109.DATA0072_PTR
							WHERE     
								(dbo.DATA0072.DESCRIPTION2 <> '') --AND (LEFT(dbo.DATA0072.DESCRIPTION, 3) = 'DL:')
								AND LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) = Fremdleistung
								AND YEAR(dbo.DATA0107.INV_DATE)=YEAR(GETDATE())
								AND MONTH(dbo.DATA0107.INV_DATE)=7
						) AS tblSoRe
						GROUP BY
							FL
				), 0) AS Jul,
				ISNULL((
						SELECT TOP 1
							SUM((REMenge*Preis_EUR)+NK_EUR) AS Wert
						FROM
						(
							SELECT DISTINCT
								LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) AS FL, 
								dbo.DATA0109.RKEY AS D109_PTR,
								dbo.DATA0109.QUANTITY AS REMenge,
								dbo.DATA0109.PRICE / dbo.DATA0107.EX_RATE AS Preis_EUR,
								dbo.DATA0107.MISC_TOT / dbo.DATA0107.EX_RATE AS NK_EUR
							FROM         dbo.DATA0023 INNER JOIN
													dbo.DATA0070 INNER JOIN
													dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR ON dbo.DATA0023.RKEY = dbo.DATA0070.SUPPLIER_POINTER INNER JOIN --LEFT OUTER JOIN
													dbo.DATA0107 INNER JOIN
													dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR ON dbo.DATA0072.RKEY = dbo.DATA0109.DATA0072_PTR
							WHERE     
								(dbo.DATA0072.DESCRIPTION2 <> '') --AND (LEFT(dbo.DATA0072.DESCRIPTION, 3) = 'DL:')
								AND LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) = Fremdleistung
								AND YEAR(dbo.DATA0107.INV_DATE)=YEAR(GETDATE())
								AND MONTH(dbo.DATA0107.INV_DATE)=8
						) AS tblSoRe
						GROUP BY
							FL
				), 0) AS Aug,
				ISNULL((
						SELECT TOP 1
							SUM((REMenge*Preis_EUR)+NK_EUR) AS Wert
						FROM
						(
							SELECT DISTINCT
								LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) AS FL, 
								dbo.DATA0109.RKEY AS D109_PTR,
								dbo.DATA0109.QUANTITY AS REMenge,
								dbo.DATA0109.PRICE / dbo.DATA0107.EX_RATE AS Preis_EUR,
								dbo.DATA0107.MISC_TOT / dbo.DATA0107.EX_RATE AS NK_EUR
							FROM         dbo.DATA0023 INNER JOIN
													dbo.DATA0070 INNER JOIN
													dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR ON dbo.DATA0023.RKEY = dbo.DATA0070.SUPPLIER_POINTER INNER JOIN --LEFT OUTER JOIN
													dbo.DATA0107 INNER JOIN
													dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR ON dbo.DATA0072.RKEY = dbo.DATA0109.DATA0072_PTR
							WHERE     
								(dbo.DATA0072.DESCRIPTION2 <> '') --AND (LEFT(dbo.DATA0072.DESCRIPTION, 3) = 'DL:')
								AND LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) = Fremdleistung
								AND YEAR(dbo.DATA0107.INV_DATE)=YEAR(GETDATE())
								AND MONTH(dbo.DATA0107.INV_DATE)=9
						) AS tblSoRe
						GROUP BY
							FL
				), 0) AS Sep,
				ISNULL((
						SELECT TOP 1
							SUM((REMenge*Preis_EUR)+NK_EUR) AS Wert
						FROM
						(
							SELECT DISTINCT
								LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) AS FL, 
								dbo.DATA0109.RKEY AS D109_PTR,
								dbo.DATA0109.QUANTITY AS REMenge,
								dbo.DATA0109.PRICE / dbo.DATA0107.EX_RATE AS Preis_EUR,
								dbo.DATA0107.MISC_TOT / dbo.DATA0107.EX_RATE AS NK_EUR
							FROM         dbo.DATA0023 INNER JOIN
													dbo.DATA0070 INNER JOIN
													dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR ON dbo.DATA0023.RKEY = dbo.DATA0070.SUPPLIER_POINTER INNER JOIN --LEFT OUTER JOIN
													dbo.DATA0107 INNER JOIN
													dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR ON dbo.DATA0072.RKEY = dbo.DATA0109.DATA0072_PTR
							WHERE     
								(dbo.DATA0072.DESCRIPTION2 <> '') --AND (LEFT(dbo.DATA0072.DESCRIPTION, 3) = 'DL:')
								AND LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) = Fremdleistung
								AND YEAR(dbo.DATA0107.INV_DATE)=YEAR(GETDATE())
								AND MONTH(dbo.DATA0107.INV_DATE)=10
						) AS tblSoRe
						GROUP BY
							FL
				), 0) AS Okt,
				ISNULL((
						SELECT TOP 1
							SUM((REMenge*Preis_EUR)+NK_EUR) AS Wert
						FROM
						(
							SELECT DISTINCT
								LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) AS FL, 
								dbo.DATA0109.RKEY AS D109_PTR,
								dbo.DATA0109.QUANTITY AS REMenge,
								dbo.DATA0109.PRICE / dbo.DATA0107.EX_RATE AS Preis_EUR,
								dbo.DATA0107.MISC_TOT / dbo.DATA0107.EX_RATE AS NK_EUR
							FROM         dbo.DATA0023 INNER JOIN
													dbo.DATA0070 INNER JOIN
													dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR ON dbo.DATA0023.RKEY = dbo.DATA0070.SUPPLIER_POINTER INNER JOIN --LEFT OUTER JOIN
													dbo.DATA0107 INNER JOIN
													dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR ON dbo.DATA0072.RKEY = dbo.DATA0109.DATA0072_PTR
							WHERE     
								(dbo.DATA0072.DESCRIPTION2 <> '') --AND (LEFT(dbo.DATA0072.DESCRIPTION, 3) = 'DL:')
								AND LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) = Fremdleistung
								AND YEAR(dbo.DATA0107.INV_DATE)=YEAR(GETDATE())
								AND MONTH(dbo.DATA0107.INV_DATE)=11
						) AS tblSoRe
						GROUP BY
							FL
				), 0) AS Nov,
				ISNULL((
						SELECT TOP 1
							SUM((REMenge*Preis_EUR)+NK_EUR) AS Wert
						FROM
						(
							SELECT DISTINCT
								LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) AS FL, 
								dbo.DATA0109.RKEY AS D109_PTR,
								dbo.DATA0109.QUANTITY AS REMenge,
								dbo.DATA0109.PRICE / dbo.DATA0107.EX_RATE AS Preis_EUR,
								dbo.DATA0107.MISC_TOT / dbo.DATA0107.EX_RATE AS NK_EUR
							FROM         dbo.DATA0023 INNER JOIN
													dbo.DATA0070 INNER JOIN
													dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR ON dbo.DATA0023.RKEY = dbo.DATA0070.SUPPLIER_POINTER INNER JOIN --LEFT OUTER JOIN
													dbo.DATA0107 INNER JOIN
													dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR ON dbo.DATA0072.RKEY = dbo.DATA0109.DATA0072_PTR
							WHERE     
								(dbo.DATA0072.DESCRIPTION2 <> '') --AND (LEFT(dbo.DATA0072.DESCRIPTION, 3) = 'DL:')
								AND LTRIM(REPLACE(dbo.DATA0072.DESCRIPTION, 'DL: ', '')) = Fremdleistung
								AND YEAR(dbo.DATA0107.INV_DATE)=YEAR(GETDATE())
								AND MONTH(dbo.DATA0107.INV_DATE)=12
						) AS tblSoRe
						GROUP BY
							FL
				), 0) AS Dez
			FROM
			(
				SELECT DISTINCT
					LTRIM(REPLACE(D72.DESCRIPTION, 'DL: ', '')) AS Fremdleistung
				FROM
					dbo.DATA0072 AS D72
				WHERE
					D72.DESCRIPTION2 <> '' 
					AND LEFT(D72.DESCRIPTION, 3) = 'DL:'
					AND D72.UNIT_PRICE*D72.QUAN_ORD>0
					AND (
							(YEAR(D72.DEL_DATE)=YEAR(GETDATE())-1 AND MONTH(D72.DEL_DATE)=12)
							OR
							(YEAR(D72.DEL_DATE)=YEAR(GETDATE()))
						)
			) AS tblFL
		) AS tblFLMon
		GROUP BY
			Fremdleistung
		ORDER BY
			SUM(ISNULL(Jan, 0))+SUM(ISNULL(Feb, 0))+SUM(ISNULL(Mrz, 0))+SUM(ISNULL(Apr, 0))+SUM(ISNULL(Mai, 0))+SUM(ISNULL(Jun, 0))+SUM(ISNULL(Jul, 0))+SUM(ISNULL(Aug, 0))+SUM(ISNULL(Sep, 0))+SUM(ISNULL(Okt, 0))+SUM(ISNULL(Nov, 0))+SUM(ISNULL(Dez, 0)) DESC
	END
END
