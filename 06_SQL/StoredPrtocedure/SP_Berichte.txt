USE [LIVE]
GO
/****** Object:  StoredProcedure [dbo].[GGP_SP_Berichte]    Script Date: 22.12.2017 11:00:00 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Daniel Simic
-- Create date: 15.10.2013
-- Last change: 19.03.2014
-- Description:	GGP Programmierung -> beinhaltet verschiedene Berichte
-- =============================================
ALTER PROCEDURE [dbo].[GGP_SP_Berichte]
	@Case_ varchar(255) = '',
	@para1 varchar(255) = '',
	@para2 varchar(255) = '',
	@para3 varchar(255) = '',
	@para4 varchar(255) = '',
	@para5 varchar(255) = '',
	@para6 varchar(255) = '',
	@para7 varchar(255) = '',
	@para8 varchar(255) = '',
	@para9 varchar(2000) = '',
	@OUTPUT_RES AS varchar(1000) = '' OUTPUT
AS
BEGIN

	SET NOCOUNT ON;

	IF @Case_ = 'ReportBuilder_Felder'
	BEGIN

		SELECT
			'ME-GOLDKALIUMZYANID' AS INV_PART_NUMBER, 
			'Goldkaliumzyanid 68,2 %' AS INV_PART_DESCRIPTION,
			1773573.63 AS EK_Volume,
			6233498.00 AS LMenge,
			'LTR' AS EinkEinheit,
			3.4 AS DRPreis,
			3.5 AS Letzter_EK_Preis,
			'20.12.2013' AS letztes_LDatum,
			744 AS AnzBestellungen,
			4 As Anzahl_Lieferanten,
			2090.076604 AS DRWert,
			8868.364174 AS DLMenge
		UNION ALL
		SELECT
			'ME-CU-ANODE KUGEL   ' AS INV_PART_NUMBER, 
			'Kupferanoden Kugeln 1" / 25mm           ' AS INV_PART_DESCRIPTION,
			1773573.63 AS EK_Volume,
			6233498.00 AS LMenge,
			'LTR' AS EinkEinheit,
			3.4 AS DRPreis,
			3.5 AS Letzter_EK_Preis,
			'20.12.2013' AS letztes_LDatum,
			744 AS AnzBestellungen,
			4 As Anzahl_Lieferanten,
			2090.076604 AS DRWert,
			8868.364174 AS DLMenge
		UNION ALL
		SELECT
			'LA-GIEßLACK HALOGEN ' AS INV_PART_NUMBER, 
			'Gießlack fotosen. grün matt, halogenfrei' AS INV_PART_DESCRIPTION,
			1773573.63 AS EK_Volume,
			6233498.00 AS LMenge,
			'LTR' AS EinkEinheit,
			3.4 AS DRPreis,
			3.5 AS Letzter_EK_Preis,
			'20.12.2013' AS letztes_LDatum,
			744 AS AnzBestellungen,
			4 As Anzahl_Lieferanten,
			2090.076604 AS DRWert,
			8868.364174 AS DLMenge
		/*
		--Materialverbrauch
		SELECT 
			1 AS Anlage_PTR,
			'Haftvermittler' AS Abteilung,
			'Black Oxide' AS Anlage, 
			'2013.02' AS JahrMonat, 
			'Feb. 13' AS JahrMonatStr,
			'Wasserstoffperoxid 95%, wässerige Lösung' AS Bezeichnung,
			255.00 AS Anfangsbestand,
			1950.00 AS Zugaenge,
			896.60 AS Endbestand,
			1308.40 AS Verbrauch,
			1202.40 AS Verbrauch_Korr,
			1021.40 AS Abgemeldet,
			1592.06 AS Durchsatz,
			31678.03 AS Durchsatz_Gesamt,
			0 AS EK_DPreis,
			0.43 AS EK_DPreis_Monat,
			0 AS EK_DPreis_Umgerech,
			0.43 AS EK_DPreis_Monat_Umgerech,
			838.24 AS Zugaenge_EUR,
			385.42 AS Endbestand_EUR,
			562.43 AS AbsMatKosten_EUR,
			0.3533 AS Rel_Kosten,
			0.0530 AS Rel_Kosten_Korr,
			24 AS QUAN_ON_HAND,
			211 AS Lagerwert,
			'KG' AS EinkEinheit,
			'LTR' AS LagerEinheit,
			0.7 AS Umrechnungsfaktor,
			0.34 AS VerbrauchSOLL,
			12 AS CONSIGN_ONHAND_QTY,
			234 AS Lagerwert_Konsi,
			0 As Abweichung_EUR,
			'' AS MatInDivAnlagen
			UNION ALL
		SELECT 
			1 AS Anlage_PTR,
			'Haftvermittler' AS Abteilung,
			'Black Oxide' AS Anlage, 
			'2013.02' AS JahrMonat, 
			'Feb. 13' AS JahrMonatStr,
			'Wasserstoffperoxid 95%, wässerige Lösung' AS Bezeichnung,
			155.00 AS Anfangsbestand,
			1050.00 AS Zugaenge,
			996.60 AS Endbestand,
			1508.40 AS Verbrauch,
			1402.40 AS Verbrauch_Korr,
			1021.40 AS Abgemeldet,
			1792.06 AS Durchsatz,
			31678.03 AS Durchsatz_Gesamt,
			0.43 AS EK_DPreis,
			0.43 AS EK_DPreis_Monat,
			0 AS EK_DPreis_Umgerech,
			0.43 AS EK_DPreis_Monat_Umgerech,
			838.24 AS Zugaenge_EUR,
			385.42 AS Endbestand_EUR,
			562.43 AS AbsMatKosten_EUR,
			0.3533 AS Rel_Kosten,
			0.0530 AS Rel_Kosten_Korr,
			24 AS QUAN_ON_HAND,
			211 AS Lagerwert,
			'KG' AS EinkEinheit,
			'LTR' AS LagerEinheit,
			0.7 AS Umrechnungsfaktor,
			0.32 AS VerbrauchSOLL,
			12 AS CONSIGN_ONHAND_QTY,
			234 AS Lagerwert_Konsi,
			0 As Abweichung_EUR,
			'' AS MatInDivAnlagen
			UNION ALL
		SELECT
			1 AS Anlage_PTR,
			'Haftvermittler' AS Abteilung,
			'Black Oxide' AS Anlage, 
			'2013.01' AS JahrMonat, 
			'Jan 13' AS JahrMonatStr,
			'Wasserstoffperoxid 35%, wässerige Lösung' AS Bezeichnung,
			155.00 AS Anfangsbestand,
			1352.00 AS Zugaenge,
			598.00 AS Endbestand,
			1508.40 AS Verbrauch,
			1301.10 AS Verbrauch_Korr,
			1221.20 AS Abgemeldet,
			1892.56 AS Durchsatz,
			31678.03 AS Durchsatz_Gesamt,
			0.43 AS EK_DPreis,
			0 AS EK_DPreis_Monat,
			0 AS EK_DPreis_Umgerech,
			0.43 AS EK_DPreis_Monat_Umgerech,
			438.24 AS Zugaenge_EUR,
			585.42 AS Endbestand_EUR,
			162.43 AS AbsMatKosten_EUR,
			0.2533 AS Rel_Kosten,
			0.0430 AS Rel_Kosten_Korr,
			73 AS QUAN_ON_HAND,
			325 AS Lagerwert,
			'KG' AS EinkEinheit,
			'LTR' AS LagerEinheit,
			0.7 AS Umrechnungsfaktor,
			0.35 AS VerbrauchSOLL,
			12 AS CONSIGN_ONHAND_QTY,
			234 AS Lagerwert_Konsi,
			0 As Abweichung_EUR,
			'
			Atzen sauer = 55%
			Au-Vorrein. Cupra = 1% 
			Black Hole = 25% 
			Black Oxide = 15%
			Chem. Zinn = 2%
			Desmear = 1%
			Mikroätze = 1%
			' AS MatInDivAnlagen
			UNION ALL
		SELECT 
			1 AS Anlage_PTR,
			'Haftvermittler' AS Abteilung,
			'Black Oxide' AS Anlage, 
			'2013.02' AS JahrMonat, 
			'Feb. 13' AS JahrMonatStr,
			'Wasserstoffperoxid 45%, wässerige Lösung' AS Bezeichnung,
			255.00 AS Anfangsbestand,
			1950.00 AS Zugaenge,
			896.60 AS Endbestand,
			1308.40 AS Verbrauch,
			1202.40 AS Verbrauch_Korr,
			1021.40 AS Abgemeldet,
			1592.06 AS Durchsatz,
			31678.03 AS Durchsatz_Gesamt,
			0.43 AS EK_DPreis,
			0.43 AS EK_DPreis_Monat,
			0 AS EK_DPreis_Umgerech,
			0.43 AS EK_DPreis_Monat_Umgerech,
			838.24 AS Zugaenge_EUR,
			385.42 AS Endbestand_EUR,
			562.43 AS AbsMatKosten_EUR,
			0.3533 AS Rel_Kosten,
			0.0530 AS Rel_Kosten_Korr,
			24 AS QUAN_ON_HAND,
			211 AS Lagerwert,
			'KG' AS EinkEinheit,
			'LTR' AS LagerEinheit,
			0.7 AS Umrechnungsfaktor,
			0.33 AS VerbrauchSOLL,
			12 AS CONSIGN_ONHAND_QTY,
			234 AS Lagerwert_Konsi,
			0 As Abweichung_EUR,
			'
			Atzen sauer = 5%
			Au-Vorrein. Cupra = 15% 
			Black Hole = 25% 
			Chem. Zinn = 2%
			Desmear = 1%
			Mikroätze = 1%
			' AS MatInDivAnlagen
			UNION ALL
		SELECT
			1 AS Anlage_PTR,
			'Haftvermittler' AS Abteilung,
			'Black Oxide' AS Anlage, 
			'2013.02' AS JahrMonat, 
			'Feb. 13' AS JahrMonatStr,
			'Wasserstoffperoxid 25%, wässerige Lösung' AS Bezeichnung,
			155.00 AS Anfangsbestand,
			1352.00 AS Zugaenge,
			598.00 AS Endbestand,
			1508.40 AS Verbrauch,
			1301.10 AS Verbrauch_Korr,
			1221.20 AS Abgemeldet,
			1892.56 AS Durchsatz,
			31678.03 AS Durchsatz_Gesamt,
			0.43 AS EK_DPreis,
			0 AS EK_DPreis_Monat,
			0 AS EK_DPreis_Umgerech,
			0.43 AS EK_DPreis_Monat_Umgerech,
			438.24 AS Zugaenge_EUR,
			585.42 AS Endbestand_EUR,
			162.43 AS AbsMatKosten_EUR,
			0.2533 AS Rel_Kosten,
			0.0430 AS Rel_Kosten_Korr,
			73 AS QUAN_ON_HAND,
			325 AS Lagerwert,
			'KG' AS EinkEinheit,
			'LTR' AS LagerEinheit,
			0.7 AS Umrechnungsfaktor,
			0.34 AS VerbrauchSOLL,
			12 AS CONSIGN_ONHAND_QTY,
			234 AS Lagerwert_Konsi,
			0 As Abweichung_EUR,
			'' AS MatInDivAnlagen
		*/
		--Einkaufshietorie
		/*
		SELECT 
			1 AS TRAN_TP,
			'Lieferung' AS TransDesc,
			'KLEBEB. 4024 50MM66M' AS INV_PART_NUMBER,
			'Klebeband Tesa 4024, 50mmx66m, f.Verpack' AS INV_PART_DESCRIPTION,
			'03.10.2013' AS Datum,
			'' AS Zeit,
			23 AS QUANTITY,
			44 As QUAN_ON_HAND,
			13 AS CONSIGN_ONHAND_QTY,
			'Isola' AS Feld1,
			'23145' AS Feld2,
			'KG' AS UNIT_CODE,
			'DSI' AS ABBR_NAME,
			23.12 AS PRICE,
			34.45 AS Wert,
			'04.10.2013' AS BDatum,
			341 AS BMenge,
			1235.23 AS BWert,
			23.2 AS NK,
			12.3 AS RPreis,
			245 AS RWert,
			23 AS R_NK,
			'Chem. Ni / Au' AS Abteilung,
			'Au Reiniger' AS Anlage
		UNION ALL
		SELECT 
			1 AS TRAN_TP,
			'Lieferung' AS TransDesc,
			'ZKLEBEB. 4024 50MM66M' AS INV_PART_NUMBER,
			'ZKlebeband Tesa 4024, 50mmx66m, f.Verpack' AS INV_PART_DESCRIPTION,
			'03.10.2013' AS Datum,
			'' AS Zeit,
			23 AS QUANTITY,
			44 As QUAN_ON_HAND,
			13 AS CONSIGN_ONHAND_QTY,
			'Isola' AS Feld1,
			'23145' AS Feld2,
			'KG' AS UNIT_CODE,
			'DSI' AS ABBR_NAME,
			23.12 AS PRICE,
			34.45 AS Wert,
			'04.10.2013' AS BDatum,
			341 AS BMenge,
			1235.23 AS BWert,
			23.2 AS NK,
			12.3 AS RPreis,
			245 AS RWert,
			23 AS R_NK,
			'Chem. Ni / Au' AS Abteilung,
			'Au Reiniger' AS Anlage
		*/
		/*
		--Inventurbestand
		SELECT
			D17_PTR,
			CODE, 
			INV_PART_NUMBER, 
			INV_PART_DESCRIPTION, 
			EINK_Einheit,
			LAGER_Einheit,
			CAST(EinhKonvFaktor AS DECIMAL(10,4)) AS EinhKonvFaktor,
			CAST(VerfuegbarLagerplatz AS DECIMAL(10,4)) AS VerfuegbarLagerplatz,
			CAST(VerfuegbarLagerplatz/EinhKonvFaktor AS DECIMAL(10,4)) AS VerfuegbarLagerplatz_Konv,
			CAST(Normalkosten AS DECIMAL(10,4)) AS Normalkosten,
			CAST(Preis_LetztBestellung AS DECIMAL(10,4)) AS Preis_LetztBestellung,
			CAST(Preis_gewichtet12Mon AS DECIMAL(10,4)) AS Preis_gewichtet12Mon,
			CAST(VerfuegbarLagerplatz/EinhKonvFaktor*Normalkosten AS DECIMAL(10,4)) AS NK_Wert,
			CAST(VerfuegbarLagerplatz/EinhKonvFaktor*Preis_LetztBestellung AS DECIMAL(10,4)) AS LB_Wert,
			CAST(VerfuegbarLagerplatz/EinhKonvFaktor*Preis_gewichtet12Mon AS DECIMAL(10,4)) AS DB_Wert

			FROM
			(
				SELECT  TOP 100 PERCENT 
					dbo.DATA0017.RKEY AS D17_PTR,
					dbo.DATA0016.CODE, 
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0002.UNIT_CODE AS EINK_Einheit,
					DATA0002_1.UNIT_CODE AS LAGER_Einheit,
					dbo.DATA0017.STOCK_PURCH AS EinhKonvFaktor,
					dbo.DATA0019.QUAN_ON_HAND As VerfuegbarLagerplatz,
					ISNULL(dbo.DATA0017.STD_COST, 0) As Normalkosten,
					(
						SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
						FROM         dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
						WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY)
						ORDER BY D95.TRAN_DATE DESC

					) AS Preis_LetztBestellung,
					(
						CASE
							WHEN
							ISNULL(
							(SELECT
								SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
								FROM
								(
									SELECT     PRICE, QUAN_RECD, QUAN_RETN
									FROM         dbo.DATA0095 AS D95 INNER JOIN
														  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
														  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
									WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY) 
											AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
											AND (ISNULL(D71.PRICE, 0) > 0)
											AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
								) As myTbl12Mon
							), 0)>0 THEN 
							(
								SELECT
								SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
								FROM
								(
									SELECT     PRICE, QUAN_RECD, QUAN_RETN
									FROM         dbo.DATA0095 AS D95 INNER JOIN
														  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
														  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
									WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY) 
											AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
											AND (ISNULL(D71.PRICE, 0) > 0)
											AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
								) As myTbl12Mon
							)
							ELSE
							(
								SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
								FROM         dbo.DATA0095 AS D95 INNER JOIN
													  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
													  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
								WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY)
								ORDER BY D95.TRAN_DATE DESC
							)
						END
					) AS Preis_gewichtet12Mon

				FROM         dbo.DATA0019 WITH (NOLOCK) INNER JOIN
									  dbo.DATA0016 WITH (NOLOCK) ON dbo.DATA0019.LOCATION_PTR = dbo.DATA0016.RKEY INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0019.INVENTORY_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.STOCK_UNIT_PTR = DATA0002_1.RKEY
				WHERE     
					(dbo.DATA0017.ACTIVE_FLAG = 'Y') 
					AND (ISNULL(dbo.DATA0017.MANUFACTURER_CODE, '') = '') 
					--AND (dbo.DATA0017.S_B_N = 'N') 
					AND (dbo.DATA0017.TTYPE = 'R' OR dbo.DATA0017.TTYPE = 'M') 
					AND (dbo.DATA0017.PROD_CODE_SELL_PTR <> 95) 
					AND (dbo.DATA0017.INV_PART_NUMBER NOT LIKE 'REC-%') AND 
									  (dbo.DATA0019.QUAN_ON_HAND > 0) 
										--AND (NOT (dbo.DATA0017.RKEY IN (312, 55, 410, 798, 1005, 29881, 28876)))
				) AS myTbl
				ORDER BY CODE, INV_PART_NUMBER, INV_PART_DESCRIPTION
		*/

		/*
		--Einkaufshistorie gruppiert
		SELECT 
			BTyp, 
			D95_PTR,
			D17_RKEY,  
			INV_PART_NUMBER, 
			INV_PART_DESCRIPTION,
			UNIT_CODE,
			QUAN_ON_HAND,
			CONSIGN_ONHAND_QTY,
			LMenge,
			SUPPLIER_NAME,
			ENTERED_DATE,

			(
				SELECT 
					SUM(dbo.DATA0108.QUANTITY * dbo.DATA0108.PRICE) AS Res
				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
				WHERE     (dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE 'Technolam GmbH')
							AND
							(dbo.DATA0071.DEL_DATE >= CONVERT(DATETIME, '01.01.2013', 103)) AND (dbo.DATA0071.DEL_DATE <= CONVERT(DATETIME, '31.12.2013', 103))
							AND
							dbo.DATA0071.INVT_PTR=D17_RKEY
			) AS RVolume,

			--(SELECT QUANTITY FROM dbo.DATA0095 WHERE RKEY =  D95_PTR) AS LMenge,
			(
				SELECT     SUM(dbo.DATA0108.PRICE * dbo.DATA0108.QUANTITY) / SUM(dbo.DATA0108.QUANTITY) AS Res
				FROM         dbo.DATA0108 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
				WHERE     (dbo.DATA0071.INVT_PTR = D17_RKEY) AND (dbo.DATA0108.QUANTITY > 0)
			) 
			AS DRPreis,
			(
				SELECT 
					SUM(dbo.DATA0070.MISC_CHARGE + dbo.DATA0070.SHIPPING_COST) AS Res
				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
				WHERE     (dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE 'Technolam GmbH')
							AND
							(dbo.DATA0071.DEL_DATE >= CONVERT(DATETIME, '01.01.2013', 103)) AND (dbo.DATA0071.DEL_DATE <= CONVERT(DATETIME, '31.12.2013', 103))
							AND
							dbo.DATA0071.INVT_PTR=D17_RKEY
			) AS B_NK,
			(SELECT ENTERED_DATE FROM dbo.DATA0095 WHERE RKEY = D95_PTR) AS LDatum,
			(
				SELECT   TOP 1   dbo.DATA0023.CODE
				FROM         dbo.DATA0095 INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE     (dbo.DATA0095.RKEY = D95_PTR)
			) 
			AS LetzterLieferant,
			(
				SELECT     COUNT(SUPPLIER_NAME) AS Expr1
				FROM         (SELECT     dbo.DATA0071.INVT_PTR, dbo.DATA0023.SUPPLIER_NAME
									   FROM          dbo.DATA0071 INNER JOIN
															  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
															  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
									   GROUP BY dbo.DATA0071.INVT_PTR, dbo.DATA0023.SUPPLIER_NAME) AS mySup
				WHERE     (INVT_PTR = D17_RKEY)
			) 
			AS AnzLieferanten,
			(
				SELECT     COUNT(dbo.DATA0070.PO_NUMBER) AS Res
				FROM         dbo.DATA0071 INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY
				WHERE     (dbo.DATA0071.INVT_PTR = D17_RKEY)
			) 
			AS AnzBestellungen
			
		FROM
		(
			SELECT     
				'GGP' AS BTyp, 
				MAX(dbo.DATA0095.RKEY) AS D95_PTR,
				dbo.DATA0017.RKEY AS D17_RKEY,  
				dbo.DATA0017.INV_PART_NUMBER, 
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.QUAN_ON_HAND,
				dbo.DATA0017.CONSIGN_ONHAND_QTY,
				SUM(dbo.DATA0071.QUAN_RECD - dbo.DATA0071.QUAN_RETN) AS LMenge,
				dbo.DATA0023.SUPPLIER_NAME,
				dbo.DATA0095.ENTERED_DATE
			FROM         dbo.DATA0005 INNER JOIN
								  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
								  dbo.DATA0017 INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
			WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = '' OR
								  dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE '%') AND (dbo.DATA0095.TRAN_TP = 5) AND 
								  (dbo.DATA0070.PURCHASE_ORDER_TYPE = 0) AND (dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE 'Technolam GmbH') AND
								   (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, '01.01.2013', 103)) AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, '31.12.2013', 103))
			GROUP BY dbo.DATA0017.RKEY, dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, dbo.DATA0002.UNIT_CODE,dbo.DATA0017.QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY, dbo.DATA0023.SUPPLIER_NAME, dbo.DATA0095.ENTERED_DATE
		) As myTbl
		UNION ALL --Konsi-Bestellungen
		SELECT 
			BTyp, 
			D95_PTR,
			D17_RKEY,  
			INV_PART_NUMBER, 
			INV_PART_DESCRIPTION,
			UNIT_CODE,
			QUAN_ON_HAND,
			CONSIGN_ONHAND_QTY,
			LMenge,
			SUPPLIER_NAME,
			ENTERED_DATE,

			(
				SELECT 
					SUM(dbo.DATA0108.QUANTITY * dbo.DATA0108.PRICE) AS Res
				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
				WHERE     (dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE 'Technolam GmbH')
							AND
							(dbo.DATA0071.DEL_DATE >= CONVERT(DATETIME, '01.01.2013', 103)) AND (dbo.DATA0071.DEL_DATE <= CONVERT(DATETIME, '31.12.2013', 103))
							AND
							dbo.DATA0071.INVT_PTR=D17_RKEY
			) AS RVolume,

			--(SELECT QUANTITY FROM dbo.DATA0095 WHERE RKEY =  D95_PTR) AS LMenge,
			(
				SELECT     SUM(dbo.DATA0108.PRICE * dbo.DATA0108.QUANTITY) / SUM(dbo.DATA0108.QUANTITY) AS Res
				FROM         dbo.DATA0108 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
				WHERE     (dbo.DATA0071.INVT_PTR = D17_RKEY) AND (dbo.DATA0108.QUANTITY > 0)
			) 
			AS DRPreis,
			(
				SELECT 
					SUM(dbo.DATA0070.MISC_CHARGE + dbo.DATA0070.SHIPPING_COST) AS Res
				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
				WHERE     (dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE 'Technolam GmbH')
							AND
							(dbo.DATA0071.DEL_DATE >= CONVERT(DATETIME, '01.01.2013', 103)) AND (dbo.DATA0071.DEL_DATE <= CONVERT(DATETIME, '31.12.2013', 103))
							AND
							dbo.DATA0071.INVT_PTR=D17_RKEY
			) AS B_NK,
			(SELECT ENTERED_DATE FROM dbo.DATA0095 WHERE RKEY = D95_PTR) AS LDatum,
			(
				SELECT   TOP 1   dbo.DATA0023.CODE
				FROM         dbo.DATA0095 INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE     (dbo.DATA0095.RKEY = D95_PTR)
			) 
			AS LetzterLieferant,
			(
				SELECT     COUNT(SUPPLIER_NAME) AS Expr1
				FROM         (SELECT     dbo.DATA0071.INVT_PTR, dbo.DATA0023.SUPPLIER_NAME
									   FROM          dbo.DATA0071 INNER JOIN
															  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
															  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
									   GROUP BY dbo.DATA0071.INVT_PTR, dbo.DATA0023.SUPPLIER_NAME) AS mySup
				WHERE     (INVT_PTR = D17_RKEY)
			) 
			AS AnzLieferanten,
			(
				SELECT     COUNT(dbo.DATA0070.PO_NUMBER) AS Res
				FROM         dbo.DATA0071 INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY
				WHERE     (dbo.DATA0071.INVT_PTR = D17_RKEY)
			) 
			AS AnzBestellungen
			
		FROM
		(
			SELECT     
				'Konsi' AS BTyp, 
				MAX(dbo.DATA0341.RKEY) AS D95_PTR,
				dbo.DATA0017.RKEY AS D17_RKEY,  
				dbo.DATA0017.INV_PART_NUMBER, 
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.QUAN_ON_HAND,
				dbo.DATA0017.CONSIGN_ONHAND_QTY,
				SUM(dbo.DATA0467.QUAN_RECD - dbo.DATA0467.QUAN_RETN) AS LMenge,
				dbo.DATA0023.SUPPLIER_NAME,
				dbo.DATA0341.TRAN_DATE AS ENTERED_DATE

			FROM         dbo.DATA0017 INNER JOIN
								  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
			WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = '' OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE '%')  
					AND dbo.DATA0341.TRAN_TP=1
					AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE 'Mac Dermid GmbH               '
					AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, '01.01.2013', 103))
					AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, '31.12.2013', 103))

			GROUP BY dbo.DATA0017.RKEY, dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, dbo.DATA0002.UNIT_CODE,dbo.DATA0017.QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY, dbo.DATA0023.SUPPLIER_NAME, dbo.DATA0341.TRAN_DATE
		) As myTbl
		*/

		/*
		--Einkaufshistorie
		SELECT 
			TRAN_TP,
			TransDesc,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION,
			Datum,
			Zeit,
			QUANTITY,
			QUAN_ON_HAND,
			CONSIGN_ONHAND_QTY,
			Feld1,
			Feld2,
			UNIT_CODE,
			ABBR_NAME,
			PRICE,
			Wert,
			BDatum,
			BMenge,
			BWert,
			NK,
			RPreis,
			RWert,
			R_NK
			
			FROM (SELECT  
							dbo.DATA0095.TRAN_TP, 'Lieferung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0095.ENTERED_DATE AS Datum, dbo.DATA0095.ENTERED_TIME AS Zeit, dbo.DATA0095.QUANTITY, dbo.DATA0017.QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME, 
							dbo.DATA0071.PRICE, dbo.DATA0095.QUANTITY * dbo.DATA0071.PRICE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
							dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE AS BWert,dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							--(SELECT TOP 1 PRICE FROM dbo.DATA0108 WHERE DATA0071_PTR=dbo.DATA0071.RKEY ORDER BY RKEY DESC) AS RPreis,
							(
								SELECT     TOP 1 dbo.DATA0108.PRICE
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RPreis,
							dbo.DATA0095.QUANTITY*
							(
								SELECT     TOP 1 dbo.DATA0108.PRICE
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert,
							(
							SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
												  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
							WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS R_NK
							FROM         dbo.DATA0005 INNER JOIN
												  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
												  dbo.DATA0017 INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
												  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
							WHERE    
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = '' OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE '%')  
									AND  (dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = 'Mac Dermid GmbH               '
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, '01.01.2013', 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, '31.12.2013', 103))

						UNION ALL

						SELECT  
							dbo.DATA0095.TRAN_TP, 'Retourniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0095.ENTERED_DATE AS Datum, dbo.DATA0095.ENTERED_TIME AS Zeit, dbo.DATA0095.QUANTITY, dbo.DATA0017.QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME, 
							dbo.DATA0071.PRICE, dbo.DATA0095.QUANTITY * dbo.DATA0071.PRICE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
							dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE AS BWert,dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							--(SELECT TOP 1 PRICE FROM dbo.DATA0108 WHERE DATA0071_PTR=dbo.DATA0071.RKEY ORDER BY RKEY DESC) AS RPreis,
							(
								SELECT     TOP 1 dbo.DATA0108.PRICE
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RPreis,
							dbo.DATA0095.QUANTITY*
							(
								SELECT     TOP 1 dbo.DATA0108.PRICE
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert,
							(
							SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
												  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
							WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS R_NK
							FROM         dbo.DATA0005 INNER JOIN
												  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
												  dbo.DATA0017 INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
												  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
							WHERE    
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = '' OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE '%')  
									AND  (dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = 'Mac Dermid GmbH               '
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, '01.01.2013', 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, '31.12.2013', 103))

			UNION ALL --offene Bestellungen

			SELECT  
							5 AS TRAN_TP, 'off. Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							 dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME,
							dbo.DATA0071.PRICE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
							dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE AS BWert,dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							--(SELECT TOP 1 PRICE FROM dbo.DATA0108 WHERE DATA0071_PTR=dbo.DATA0071.RKEY ORDER BY RKEY DESC) AS RPreis,
							(
								SELECT     TOP 1 dbo.DATA0108.PRICE
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RPreis,
							dbo.DATA0071.QUAN_RECD*
							(
								SELECT     TOP 1 dbo.DATA0108.PRICE
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert,
							(
							SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
												  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
							WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS R_NK
			FROM         dbo.DATA0070 INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
			WHERE      (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = '' OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE '%')    
						AND  (dbo.DATA0071.QUAN_RECD = 0)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE 'Mac Dermid GmbH               '
						AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, '01.01.2013', 103))
						AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, '31.12.2013', 103))

			--UNION ALL
			--
			--				SELECT      dbo.DATA0095.TRAN_TP,'Lieferung ohne BestNr.' As TranDesc, dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, dbo.DATA0095.ENTERED_DATE AS Datum,
			--					   dbo.DATA0095.ENTERED_TIME AS Zeit, dbo.DATA0095.QUANTITY, dbo.DATA0017.QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY, '' AS Feld1, 'ohne Bestellnummer' AS Feld2, 
			--					  dbo.DATA0002.UNIT_CODE, dbo.DATA0005.ABBR_NAME, 
			--					  dbo.DATA0017.STD_COST AS PRICE, dbo.DATA0095.QUANTITY * dbo.DATA0017.STD_COST AS Wert
			--				FROM         dbo.DATA0005 INNER JOIN
			--					  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
			--					  dbo.DATA0017 INNER JOIN
			--					  dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
			--					  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
			--					  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY
			--				WHERE   (dbo.DATA0017.INV_PART_DESCRIPTION = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION LIKE @para3)   
			--					AND  (dbo.DATA0095.TRAN_TP = 22)
			--					AND (dbo.DATA0095.ENTERED_DATE > CONVERT(DATETIME, @para5, 103))

			UNION ALL --Konsi Bestellungen

			SELECT  
							5 AS TRAN_TP, 'K-Bestellung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, dbo.DATA0341.QUANTITY, dbo.DATA0017.QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY  ,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, dbo.DATA0341.STANDARD_COST AS RPreis,
							(dbo.DATA0341.STANDARD_COST * dbo.DATA0341.QUANTITY) AS RWert, 0 AS R_NK
			FROM         dbo.DATA0017 INNER JOIN
								  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
			WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = '' OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE '%')  
					AND dbo.DATA0341.TRAN_TP=1
					AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE 'Mac Dermid GmbH               '
					AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, '01.01.2013', 103))
					AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, '31.12.2013', 103))

			UNION ALL --offene Konsi-Bestellungen

			SELECT  
							5 AS TRAN_TP, 'off. K-Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
							0 AS RWert, 0 AS R_NK
			FROM         dbo.DATA0467 INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
			WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION = '' OR dbo.DATA0017.INV_PART_DESCRIPTION LIKE '%')   
					AND dbo.DATA0467.QUAN_RECD=0
					AND dbo.DATA0023.SUPPLIER_NAME LIKE 'Mac Dermid GmbH               '
					AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, '01.01.2013', 103))
					AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, '31.12.2013', 103))

			UNION ALL --retournierte Konsi-Bestellungen

			SELECT  
							5 AS TRAN_TP, 'K-Retourniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, -1*dbo.DATA0467.QUAN_RETN AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							,  dbo.DATA0467.PRICE, -1*dbo.DATA0467.QUAN_RETN * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis, 0 AS RWert
							, 0 AS R_NK
			FROM         dbo.DATA0467 INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
			WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = '' OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE '%')   
					AND dbo.DATA0467.QUAN_RETN>0
					AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE 'Mac Dermid GmbH               '
					AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, '01.01.2013', 103))
					AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, '31.12.2013', 103))

			)  AS ResTbl
			ORDER BY INV_PART_NUMBER, INV_PART_DESCRIPTION, Datum DESC, Zeit DESC
		*/
		--Inventurbestand
		/*
		SELECT
				DATA0017_PTR, 
				CODE, 
				INV_PART_NUMBER, 
				INV_PART_DESCRIPTION, 
				QUAN_ON_HAND, 
				QUAN_ON_HAND_CONV, 
				Einkaufseinheit, 
				Lagereinheit, 
				Einlagerungsfaktor,
				RE_Preis,
				BE_Preis,
				STAMM_Preis,
				CASE
					WHEN ISNULL(BE_Preis, 0)=0 AND ISNULL(STAMM_Preis, 0)=0 THEN 
						''
					ELSE
					CASE
						WHEN ISNULL(STAMM_Preis, 0)=0 AND ISNULL(BE_Preis, 0)>0 THEN
							''
						ELSE
						CASE
							WHEN ABS((ISNULL(BE_Preis, 0)-ISNULL(STAMM_Preis, 0))/ISNULL(STAMM_Preis, 0)) > 0.1 THEN '!!!' ELSE ''
						END
					END
				END AS ProzDiff
				FROM
				(
					SELECT     TOP 100 PERCENT dbo.DATA0017.RKEY AS DATA0017_PTR, dbo.DATA0016.CODE, dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
										  dbo.DATA0019.QUAN_ON_HAND, (dbo.DATA0019.QUAN_ON_HAND*dbo.DATA0017.STOCK_PURCH) AS QUAN_ON_HAND_CONV, dbo.DATA0002.UNIT_CODE AS Einkaufseinheit, DATA0002_1.UNIT_CODE AS Lagereinheit, 
										  dbo.DATA0017.STOCK_PURCH AS Einlagerungsfaktor,
					ISNULL(
					(SELECT TOP 1
					ISNULL(dbo.DATA0108.PRICE, 0)
					FROM         dbo.DATA0108 INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY RIGHT OUTER JOIN
										  dbo.DATA0017 D17 ON dbo.DATA0071.INVT_PTR = D17.RKEY
					WHERE     (D17.RKEY = dbo.DATA0017.RKEY) AND (dbo.DATA0070.PURCHASE_ORDER_TYPE = 0)
					ORDER BY D17.RKEY, dbo.DATA0108.RKEY DESC, dbo.DATA0071.RKEY DESC
					), 0) AS RE_Preis,

					ISNULL(
					(SELECT TOP 1
					ISNULL(dbo.DATA0071.PRICE, 0)
					FROM         dbo.DATA0071 INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY RIGHT OUTER JOIN
										  dbo.DATA0017 D17  ON dbo.DATA0071.INVT_PTR = D17.RKEY
					WHERE     (D17.RKEY = dbo.DATA0017.RKEY) AND (dbo.DATA0070.PURCHASE_ORDER_TYPE = 0)
					ORDER BY D17.RKEY, dbo.DATA0071.RKEY DESC
					), 0) AS BE_Preis,

					ISNULL(
					(SELECT TOP 1
					ISNULL(dbo.DATA0017.STD_COST, 0)
					FROM         dbo.DATA0017 D17
					WHERE     (D17.RKEY = dbo.DATA0017.RKEY)
					ORDER BY D17.RKEY
					), 0) AS STAMM_Preis


					FROM         dbo.DATA0019 WITH (NOLOCK) INNER JOIN
										  dbo.DATA0016 WITH (NOLOCK) ON dbo.DATA0019.LOCATION_PTR = dbo.DATA0016.RKEY INNER JOIN
										  dbo.DATA0017 ON dbo.DATA0019.INVENTORY_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
										  dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.STOCK_UNIT_PTR = DATA0002_1.RKEY
					WHERE     
						(dbo.DATA0017.ACTIVE_FLAG = 'Y') 
						AND (ISNULL(dbo.DATA0017.MANUFACTURER_CODE, '') = '') 
						--AND (dbo.DATA0017.S_B_N = 'N') 
						AND (dbo.DATA0017.TTYPE = 'R' OR dbo.DATA0017.TTYPE = 'M') 
						AND (dbo.DATA0017.PROD_CODE_SELL_PTR <> 95) 
						AND (dbo.DATA0017.INV_PART_NUMBER NOT LIKE 'REC-%') AND 
										  (dbo.DATA0019.QUAN_ON_HAND > 0) 
											--AND (NOT (dbo.DATA0017.RKEY IN (312, 55, 410, 798, 1005, 29881, 28876)))
					) AS myTbl
					ORDER BY CODE, INV_PART_NUMBER
		*/
	END

	--Applikation Einkaufshistorie
	IF @Case_ = 'Einkaufshistorie'
	BEGIN
		DECLARE @pST_Einkaufshistorie varchar(255)
		SET @pST_Einkaufshistorie = @para1

		IF @pST_Einkaufshistorie = 'EH_Lieferant'
		BEGIN
			SELECT  
				dbo.DATA0095.TRAN_TP, 'Lieferung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
				CAST(dbo.DATA0095.ENTERED_DATE AS varchar(12)) AS Datum, dbo.DATA0095.ENTERED_TIME AS Zeit, dbo.DATA0095.QUANTITY, dbo.DATA0017.QUAN_ON_HAND,
				dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.SUPPLIER_NAME AS Feld2, dbo.DATA0002.UNIT_CODE, 
				dbo.DATA0005.ABBR_NAME, dbo.DATA0095.REFERENCE_NUMBER,
				dbo.DATA0095.RKEY as D95_RKEY, dbo.DATA0017.RKEY as D17_RKEY, dbo.DATA0023.RKEY AS RKEY23, dbo.DATA0070.PURCHASE_ORDER_TYPE AS Bestelltyp, dbo.DATA0017.CONSIGN_ONHAND_QTY 
				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE    (dbo.DATA0023.SUPPLIER_NAME = @para2)  
					AND  (dbo.DATA0095.TRAN_TP = 5) 
				ORDER BY dbo.DATA0095.ENTERED_DATE DESC, dbo.DATA0095.ENTERED_TIME DESC
		END

		IF @pST_Einkaufshistorie = 'EH_Abteilung'
		BEGIN
			SELECT Abteilung FROM LIVE2.dbo.MatRueck_Abteilung ORDER BY Abteilung
		END

		IF @pST_Einkaufshistorie = 'EH_AlleAbteilungen'
		BEGIN
			SELECT     LIVE2.dbo.MatRueck_Abteilung.Abteilung, 
					LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) AS Abteilung_PTR
			FROM         dbo.DATA0017 INNER JOIN
								  LIVE2.dbo.MatRueck_Abteilung ON dbo.DATA0017.IES_INDIRECT_MATL1 = LIVE2.dbo.MatRueck_Abteilung.ID
			GROUP BY LIVE2.dbo.MatRueck_Abteilung.Abteilung, dbo.DATA0017.IES_INDIRECT_MATL1
		END

		IF @pST_Einkaufshistorie = 'EH_Anlage'
		BEGIN
			SELECT Anlage FROM LIVE2.dbo.MatRueck_Anlage ORDER BY Anlage
		END

		IF @pST_Einkaufshistorie = 'EH_Anlage_Filter'
		BEGIN
			SELECT     LIVE2.dbo.MatRueck_Anlage.Anlage
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
								  LIVE2.dbo.MatRueck_AnlageAbteilung ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_AnlageAbteilung.Abteilung_PTR INNER JOIN
								  LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_AnlageAbteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
			WHERE     LIVE2.dbo.MatRueck_Abteilung.Abteilung = @para2 --CAST(@para2 AS int)
		END

		IF @pST_Einkaufshistorie = 'EH_AlleAnlagen'
		BEGIN
			SELECT     LIVE2.dbo.MatRueck_Anlage.Anlage, 
					LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) AS Anlage_PTR
			FROM         dbo.DATA0017 INNER JOIN
								  LIVE2.dbo.MatRueck_Anlage ON dbo.DATA0017.IES_INDIRECT_MATL2 = LIVE2.dbo.MatRueck_Anlage.ID
			GROUP BY LIVE2.dbo.MatRueck_Anlage.Anlage, dbo.DATA0017.IES_INDIRECT_MATL2
		END

		IF @pST_Einkaufshistorie = 'EH_Einkaeufe'
		BEGIN
			SELECT 
				TRAN_TP,
				TransDesc,
				INV_PART_NUMBER,
				INV_PART_DESCRIPTION,
				Datum,
				Zeit,
				QUANTITY,
				QUAN_ON_HAND,
				CONSIGN_ONHAND_QTY,
				Feld1,
				Feld2,
				UNIT_CODE,
				ABBR_NAME,
				PRICE,
				Wert,
				BDatum,
				BMenge,
				BWert,
				NK,
				RPreis,
				RWert,
				R_NK,
				Abteilung,
				Anlage

			FROM (SELECT  
								
					dbo.DATA0095.TRAN_TP, 
					CASE
						WHEN dbo.DATA0070.STATUS=2 THEN 'Lieferung T' ELSE 'Lieferung' 
					END As TransDesc
					,dbo.DATA0017.INV_PART_NUMBER, 
					--dbo.DATA0017.INV_PART_DESCRIPTION, 
					CASE
						WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
							dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
						ELSE
							dbo.DATA0017.INV_PART_DESCRIPTION
					END AS INV_PART_DESCRIPTION,
					dbo.DATA0095.ENTERED_DATE AS Datum, dbo.DATA0095.ENTERED_TIME AS Zeit, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
					dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					dbo.DATA0071.PRICE, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0071.PRICE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE AS BWert, dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					--23.10.2013 Wnn RE nicht vorhanden dann BE sonst Stamm (Vorgabe Jha)
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
					SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
										  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
										  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
										  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
							AND  (dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

				UNION ALL

				SELECT  
					dbo.DATA0095.TRAN_TP, 'Retourniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0095.ENTERED_DATE AS Datum, dbo.DATA0095.ENTERED_TIME AS Zeit, (-1)*dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
					dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					dbo.DATA0071.PRICE, dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0071.PRICE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE AS BWert,dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					--23.10.2013 Wnn RE nicht vorhanden dann BE sonst Stamm (Vorgabe Jha)
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					-1*(dbo.DATA0095.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY))*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
					SELECT     TOP 1 -1*(dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
										  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
										  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
										  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
							AND  (dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para6, 103))
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL --offene Bestellungen

			SELECT  
							5 AS TRAN_TP, 'offene Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
							 dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME,
							dbo.DATA0071.PRICE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
							dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE AS BWert,dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
							--0 AS RPreis,
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RPreis,
							--0 AS RWert,
							(dbo.DATA0071.QUAN_RECD/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY))*
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert,
							(
							SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
												  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
							--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0070 INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY

			WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						--AND  (dbo.DATA0071.QUAN_RECD = 0)
						AND  (dbo.DATA0070.STATUS = 1)
						AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)
				
			UNION ALL --Debit/Belastung 

			SELECT  
							5 AS TRAN_TP, 'Debit/Belast.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, 
							--dbo.DATA0071.QUAN_RECD AS QUANTITY, 
							(-1)*dbo.DATA0219.QUAN_DEBITED AS QUANTITY,
							dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
							 dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME,
							dbo.DATA0071.PRICE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
							dbo.DATA0071.QUAN_ORD AS BMenge, 
							dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE AS BWert,dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
							dbo.DATA0108.PRICE AS RPreis,
							(-1)*dbo.DATA0132.AMOUNT AS RWert,
							--(
							--SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
							--FROM         dbo.DATA0070 AS D70 INNER JOIN
							--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
							--					  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
							--					  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
							----WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							--WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							--) 
							dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0132 INNER JOIN
                      dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
                      dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
                      dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
                      dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
                      dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
                      dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
                      dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
			WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
						--AND  (dbo.DATA0071.QUAN_RECD = 0)
						AND  (dbo.DATA0070.STATUS = 1)
						AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL --Lastschriften

			SELECT  DISTINCT
				5 AS TRAN_TP, 
				'Lastschrift' As TransDesc,
				dbo.DATA0017.INV_PART_NUMBER, 
				dbo.DATA0017.INV_PART_DESCRIPTION, 
				dbo.DATA0132.MEMO_DATE AS Datum, '' AS Zeit, 
				--dbo.DATA0108.QUANTITY AS QUANTITY, 
				0 AS QUANTITY,
				0 AS QUAN_ON_HAND, 
				0 AS CONSIGN_ONHAND_QTY, 
				RTRIM(dbo.DATA0070.PO_NUMBER) + '/' + LTRIM(dbo.DATA0132.MEMO_NUMBER) AS Feld1, 
				dbo.DATA0023.CODE AS Feld2, 
				dbo.DATA0002.UNIT_CODE, 
				dbo.DATA0005.ABBR_NAME, 
				0 AS PRICE, 
				0 AS Wert, 
				dbo.DATA0070.PO_DATE AS BDatum, 
				0 AS BMenge, 
				0 AS BWert, 
				0 AS NK,
				-- -1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RPreis,
				0 AS RPreis,
				--  -1 * dbo.DATA0108.QUANTITY * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RWert,
				-1 * dbo.DATA0132.MISC_TOT AS RWert,
				0 AS R_NK,
				'' AS Abteilung,
				'' AS Anlage

			FROM         dbo.DATA0023 INNER JOIN
                      dbo.DATA0132 ON dbo.DATA0023.RKEY = dbo.DATA0132.SUPP_PTR INNER JOIN
                      dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
                      dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
                      dbo.DATA0005 ON dbo.DATA0132.EMPL_PTR = dbo.DATA0005.RKEY INNER JOIN
                      dbo.DATA0002 INNER JOIN
                      dbo.DATA0071 ON dbo.DATA0002.RKEY = dbo.DATA0071.PURCHASE_UNIT_PTR ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
                      dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

			WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
						--AND  (dbo.DATA0071.QUAN_RECD = 0)
						--AND  (dbo.DATA0070.STATUS = 1)
						--AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL --Bestellungen in Klärung 

			SELECT  
							5 AS TRAN_TP, 'in Klärung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY, 
							 dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME,
							dbo.DATA0071.PRICE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
							dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE AS BWert,dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
							0 AS RPreis,
							0 AS RWert,
							(
							SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
												  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
							--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0070 INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
			WHERE      (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
						--AND  (dbo.DATA0071.QUAN_RECD = 0)
						AND  (dbo.DATA0070.STATUS = 5)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL --Konsi Bestellungen

			SELECT  
							5 AS TRAN_TP, 'K-Lieferung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RPreis, 
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0017 INNER JOIN
								  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
			WHERE     (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
					AND dbo.DATA0341.TRAN_TP=1
					AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
					AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
					AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))
					AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL --rückgängig Konsi-Bestellungen

			SELECT  
							5 AS TRAN_TP, 'rückgäng. Kons' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY  ,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RPreis, 
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY)*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0017 INNER JOIN
								  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
			WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
					AND dbo.DATA0341.TRAN_TP=15
					AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
					AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
					AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL --offene Konsi-Bestellungen

			SELECT  
							5 AS TRAN_TP, 'offene K-Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
							0 AS RWert, 0 AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0467 INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
			WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
					--AND dbo.DATA0467.QUAN_RECD=0
					AND (dbo.DATA0466.STATUS=1)
					AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
					AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
					AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
					AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL --liegende Konsi-Bestellungen

			SELECT  
							5 AS TRAN_TP, 'K-storniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
							0 AS RWert, 0 AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0467 INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
			WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
					--AND dbo.DATA0467.QUAN_RECD=0
					AND (dbo.DATA0466.STATUS=4)
					AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
					AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
					AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL --retournierte Konsi-Bestellungen

			SELECT  
							5 AS TRAN_TP, 'K-retourniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, (-1)*dbo.DATA0467.QUAN_RETN AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY/LIVE.dbo.F_dsi_ConvFact(dbo.DATA0017.RKEY, dbo.DATA0023.RKEY) AS CONSIGN_ONHAND_QTY,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							,  dbo.DATA0467.PRICE, -1*dbo.DATA0467.QUAN_RETN * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RPreis, 
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN -1*dbo.DATA0467.QUAN_RETN*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 -1*dbo.DATA0467.QUAN_RETN*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0467 INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
			WHERE   (CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR CASE WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN dbo.DATA0017.LONG_INVENTORY_PART_NUMBER ELSE dbo.DATA0017.INV_PART_DESCRIPTION END COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   --  (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
					AND dbo.DATA0467.QUAN_RETN>0
					AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
					AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
					AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			)  AS ResTbl
			ORDER BY INV_PART_NUMBER, INV_PART_DESCRIPTION, Datum DESC, Zeit DESC
		END

		IF @pST_Einkaufshistorie = 'EH_Einkaeufe_Grp'
		BEGIN
			SELECT 
				BTyp, 
				MAX(D95_PTR) AS D95_PTR,
				D17_RKEY,  
				INV_PART_NUMBER, 
				INV_PART_DESCRIPTION,
				UNIT_CODE,
				QUAN_ON_HAND,
				CONSIGN_ONHAND_QTY,
				SUM(LMenge) AS LMenge,
				--AVG(RPreis) AS DRPreis,
				CASE
					WHEN SUM(CASE WHEN RPreis=0 THEN 0 ELSE LMenge END) > 0 THEN
						SUM(RPreis*LMenge)/SUM(CASE WHEN RPreis=0 THEN 0 ELSE LMenge END) 
					ELSE 0
				END AS DRPreis,
				SUM(RWert) AS RVolume,
				SUM(NK) AS B_NK,
				MAX(LDatum) AS LDatum,
				SUM(AnzBestellungen) AS AnzBestellungen,
				CASE
					WHEN BTyp='GGP' THEN 
						(SELECT     TOP 1 dbo.DATA0023.CODE
							FROM         dbo.DATA0071 INNER JOIN
												  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
						WHERE  dbo.DATA0071.INVT_PTR = D17_RKEY
						ORDER BY dbo.DATA0070.PO_NUMBER DESC)
					ELSE 
						(SELECT     TOP 1 dbo.DATA0023.CODE
						FROM         dbo.DATA0467 INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY
						WHERE     dbo.DATA0467.INVT_PTR = D17_RKEY
						ORDER BY dbo.DATA0466.RO_NUMBER DESC)
				END AS LetzterLieferant,
				CASE
					WHEN BTyp='GGP' THEN
						(SELECT     COUNT(SUPPLIER_NAME) AS Expr1
						FROM         (SELECT     dbo.DATA0071.INVT_PTR, dbo.DATA0023.SUPPLIER_NAME
											   FROM          dbo.DATA0071 INNER JOIN
																	  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
																	  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
											   GROUP BY dbo.DATA0071.INVT_PTR, dbo.DATA0023.SUPPLIER_NAME) AS mySup
						WHERE     INVT_PTR = D17_RKEY)
					ELSE
						(SELECT     COUNT(SUPPLIER_NAME) AS Expr1
						FROM         (SELECT dbo.DATA0467.INVT_PTR, dbo.DATA0023.SUPPLIER_NAME
										FROM         dbo.DATA0467 INNER JOIN
															  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
															  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY
										GROUP BY dbo.DATA0467.INVT_PTR, dbo.DATA0023.SUPPLIER_NAME) AS mySup
						WHERE     INVT_PTR = D17_RKEY)
				END AS AnzLieferanten

			FROM (
				--Lieferung T , Lieferung
				SELECT  
					'GGP' As BTyp,		
					dbo.DATA0095.RKEY AS D95_PTR, 
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					dbo.DATA0095.ENTERED_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
							AND  (dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

				UNION ALL

				--Retourniert
				SELECT 
					'GGP' As BTyp, 
					dbo.DATA0095.RKEY AS D95_PTR, 
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					(-1)*dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					dbo.DATA0095.ENTERED_DATE AS LDatum,
					0 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
							AND  (dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para6, 103))
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

				UNION ALL 

				--offene Bestellungen
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

				UNION ALL 

				--Debit/Belastung
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					dbo.DATA0108.PRICE AS RPreis,
					(-1)*dbo.DATA0132.AMOUNT AS RWert,
					--(
					--	SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
					--	FROM         dbo.DATA0070 AS D70 INNER JOIN
					--						  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
					--						  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
					--						  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					--	--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					--	WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					--) 
					dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0132 INNER JOIN
                      dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
                      dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
                      dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
                      dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
                      dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
                      dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
                      dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE      (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

				UNION ALL 

				--Bestellungen in Klärung 
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)	
					) AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS = 5)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

				UNION ALL --Lastschriften

				SELECT DISTINCT    
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					0 AS LMenge,
					-- -1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RPreis,
					0 AS RPreis,
					-- -1 * dbo.DATA0108.QUANTITY * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0108.QUANTITY) AS RWert,
					-1 * dbo.DATA0132.MISC_TOT AS RWert,
					0 AS NK,
					dbo.DATA0132.MEMO_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0023 INNER JOIN
						  dbo.DATA0132 ON dbo.DATA0023.RKEY = dbo.DATA0132.SUPP_PTR INNER JOIN
						  dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0132.EMPL_PTR = dbo.DATA0005.RKEY INNER JOIN
						  dbo.DATA0002 INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0002.RKEY = dbo.DATA0071.PURCHASE_UNIT_PTR ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

				WHERE      (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							--AND  (dbo.DATA0070.STATUS = 1)
							--AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para6, 103))
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

				UNION ALL

				--Konsi Bestellungen
				SELECT  
					'Konsi' As BTyp,
					dbo.DATA0341.RKEY AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS NK,
					dbo.DATA0341.TRAN_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND dbo.DATA0341.TRAN_TP=1
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

				UNION ALL 

				--rückgängig Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					dbo.DATA0341.RKEY AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS NK,
					dbo.DATA0341.TRAN_DATE AS LDatum,
					0 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND dbo.DATA0341.TRAN_TP=15
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

				UNION ALL 

				--offene Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0467.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert, 
					0 AS NK,
					dbo.DATA0467.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						--AND dbo.DATA0467.QUAN_RECD=0
						AND (dbo.DATA0466.STATUS=1)
						AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

				UNION ALL 

				--liegende Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0467.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert, 
					0 AS NK,
					dbo.DATA0467.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						--AND dbo.DATA0467.QUAN_RECD=0
						AND (dbo.DATA0466.STATUS=4)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

				UNION ALL 

				--retournierte Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					dbo.DATA0341.RKEY AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					--(-1)*dbo.DATA0467.QUAN_RETN AS LMenge,
					(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						--WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN -1*dbo.DATA0467.QUAN_RETN*dbo.DATA0467.PRICE
						--	ELSE (SELECT TOP 1 -1*dbo.DATA0467.QUAN_RETN/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS NK,
					dbo.DATA0467.REQ_DATE AS LDatum,
					0 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
						AND dbo.DATA0341.TRAN_TP=2
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)
				--FROM         dbo.DATA0467 INNER JOIN
				--					  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
				--					  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
				--					  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
				--					  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
				--					  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				--WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
				--		AND dbo.DATA0467.QUAN_RETN>0
				--		AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
				--		AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
				--		AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
				--		AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
				--		AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			)  AS ResTbl
			GROUP BY
				BTyp, 
				D17_RKEY,  
				INV_PART_NUMBER, 
				INV_PART_DESCRIPTION,
				UNIT_CODE,
				QUAN_ON_HAND,
				CONSIGN_ONHAND_QTY,
				LetzterLieferant,
				AnzLieferanten
			ORDER BY INV_PART_NUMBER, INV_PART_DESCRIPTION, BTyp
		END

		IF @pST_Einkaufshistorie = 'EH_Einkaeufe_stornierte_Bestellungen'
		BEGIN
			SELECT  
							5 AS TRAN_TP, 'storniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							 dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.SUPPLIER_NAME AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME,
							dbo.DATA0071.PRICE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
							dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE AS BWert,dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							0 AS RPreis,
							0 AS RWert,
							(
							SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
												  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
							WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0070 INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
			WHERE      (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
						--AND  (dbo.DATA0071.QUAN_RECD = 0)
						AND  (dbo.DATA0070.STATUS = 3)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL 

			SELECT  
							5 AS TRAN_TP, 'K-storniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.SUPPLIER_NAME AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, 
							dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
							0 AS RWert, 0 AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0467 INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
			WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
					--AND dbo.DATA0467.QUAN_RECD=0
					AND dbo.DATA0466.STATUS=3
					AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
					AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
					AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)
		END

		IF @pST_Einkaufshistorie = 'EH_Einkaeufe_offene_Bestellungen'
		BEGIN
			SELECT  
							5 AS TRAN_TP, 'in Klärung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							 dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.SUPPLIER_NAME AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME,
							dbo.DATA0071.PRICE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
							dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE AS BWert,dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							0 AS RPreis,
							0 AS RWert,
							(
							SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
												  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
							WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0070 INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
			WHERE      (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
						--AND  (dbo.DATA0071.QUAN_RECD = 0)
						AND  (dbo.DATA0070.STATUS = 5)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL 

			SELECT  
							5 AS TRAN_TP, 'offene Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							 dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.SUPPLIER_NAME AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME,
							dbo.DATA0071.PRICE, dbo.DATA0071.QUAN_RECD * dbo.DATA0071.PRICE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
							dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE AS BWert,dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							0 AS RPreis,
							0 AS RWert,
							(
							SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
												  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
							WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0070 INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
			WHERE      (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
						--AND  (dbo.DATA0071.QUAN_RECD = 0)
						AND  (dbo.DATA0070.STATUS = 1)
						AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL 

			SELECT  
							5 AS TRAN_TP, 'K in Klärung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.SUPPLIER_NAME AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, 
							dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
							0 AS RWert, 0 AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0467 INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
			WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
					--AND dbo.DATA0467.QUAN_RECD=0
					AND (dbo.DATA0466.STATUS=4)
					AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
					AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
					AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL 

			SELECT  
							5 AS TRAN_TP, 'offene K-Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.SUPPLIER_NAME AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, 
							dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
							0 AS RWert, 0 AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0467 INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
			WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
					--AND dbo.DATA0467.QUAN_RECD=0
					--AND (dbo.DATA0466.STATUS=1)
					AND (dbo.DATA0466.STATUS=1)
					AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
					AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
					AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
					AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)
		END

		IF @pST_Einkaufshistorie = 'EH_Einkaeufe_sonstige_Bestellungen'
		BEGIN
			SELECT *
			FROM
			(
				SELECT     
						5 AS TRAN_TP, 
						--'sonstige' As TransDesc,
						CASE
							WHEN dbo.DATA0070.STATUS=1 AND (dbo.DATA0072.QUANTITY_RECEIVED<dbo.DATA0072.QUAN_ORD) THEN 'offene Best.'
							ELSE
								CASE
									WHEN dbo.DATA0070.STATUS=2 THEN 'Lieferung T'
									ELSE
										CASE
											WHEN dbo.DATA0070.STATUS=3 THEN 'storniert'
											ELSE
												CASE
													WHEN dbo.DATA0070.STATUS=5 THEN 'in Klärung'
													ELSE
														CASE
															WHEN dbo.DATA0070.STATUS=6 OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0072.QUANTITY_RECEIVED>=dbo.DATA0072.QUAN_ORD) THEN 'Lieferung'
															ELSE '?????'
														END
												END
										END
								END
						END As TransDesc,dbo.DATA0072.DESCRIPTION + STR(dbo.DATA0072.RKEY) AS INV_PART_NUMBER, dbo.DATA0072.DESCRIPTION2 + STR(dbo.DATA0072.RKEY) AS INV_PART_DESCRIPTION, dbo.DATA0072.DEL_DATE AS Datum, '' AS Zeit, 
						dbo.DATA0072.QUANTITY_RECEIVED AS QUANTITY, 0 AS QUAN_ON_HAND, 0 AS CONSIGN_ONHAND_QTY, dbo.DATA0070.PO_NUMBER AS Feld1, 
						dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, dbo.DATA0005.ABBR_NAME, dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE AS PRICE, 
						dbo.DATA0072.QUANTITY_RECEIVED * dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE  AS Wert, dbo.DATA0070.PO_DATE AS BDatum, dbo.DATA0072.QUAN_ORD AS BMenge, 
						--CASE 
						--	WHEN dbo.DATA0070.STATUS<>3 THEN dbo.DATA0072.QUAN_ORD * dbo.DATA0072.UNIT_PRICE
						--		ELSE 0
						--END AS BWert, 
						dbo.DATA0072.QUAN_ORD * dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE AS BWert, 
						(dbo.DATA0070.SHIPPING_COST + dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
						--0 AS RPreis,
						--0 AS RWert,
						--0 AS R_NK
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D109.PRICE, 0)>0 THEN D109.PRICE/D107.EX_RATE
									ELSE 
										ISNULL(D72.UNIT_PRICE/D70.EXCHANGE_RATE, 0)
							END AS RPreis
							--FROM         dbo.DATA0070 AS D70 INNER JOIN
							--					  dbo.DATA0072 AS D72 ON D70.RKEY = D72.POPTR LEFT OUTER JOIN
							--					  dbo.DATA0109 ON D72.RKEY = dbo.DATA0109.DATA0072_PTR
							--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER)
							--FROM         dbo.DATA0072 AS D72 LEFT OUTER JOIN
							--					  dbo.DATA0109 ON D72.RKEY = dbo.DATA0109.DATA0072_PTR
							FROM         dbo.DATA0070 AS d70 INNER JOIN
												  dbo.DATA0072 AS D72 ON d70.RKEY = D72.POPTR LEFT OUTER JOIN
												  dbo.DATA0107 AS D107 INNER JOIN
												  dbo.DATA0109 AS d109 ON D107.RKEY = d109.DATA0107_PTR ON D72.RKEY = d109.DATA0072_PTR
							WHERE     (D72.RKEY = dbo.DATA0072.RKEY)
						) AS RPreis,
						dbo.DATA0072.QUANTITY_RECEIVED*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D109.PRICE, 0)>0 THEN D109.PRICE/D107.EX_RATE
									ELSE 
										ISNULL(D72.UNIT_PRICE/D70.EXCHANGE_RATE, 0)
							END AS RPreis
							--FROM         dbo.DATA0070 AS D70 INNER JOIN
							--					  dbo.DATA0072 AS D72 ON D70.RKEY = D72.POPTR LEFT OUTER JOIN
							--					  dbo.DATA0109 ON D72.RKEY = dbo.DATA0109.DATA0072_PTR
							--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER)
							--FROM         dbo.DATA0072 AS D72 LEFT OUTER JOIN
							--					  dbo.DATA0109 ON D72.RKEY = dbo.DATA0109.DATA0072_PTR
							FROM         dbo.DATA0070 AS d70 INNER JOIN
												  dbo.DATA0072 AS D72 ON d70.RKEY = D72.POPTR LEFT OUTER JOIN
												  dbo.DATA0107 AS D107 INNER JOIN
												  dbo.DATA0109 AS d109 ON D107.RKEY = d109.DATA0107_PTR ON D72.RKEY = d109.DATA0072_PTR
							WHERE     (D72.RKEY = dbo.DATA0072.RKEY)
						) AS RWert,
						(
						SELECT     TOP 1 
							CASE
								WHEN ISNULL(dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT, 0)>0 THEN dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT
								ELSE
									ISNULL(dbo.DATA0070.SHIPPING_COST + dbo.DATA0070.MISC_CHARGE, 0)
							END AS RES
							FROM         dbo.DATA0107 INNER JOIN
										  dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR RIGHT OUTER JOIN
										  dbo.DATA0070 AS D70 INNER JOIN
										  dbo.DATA0072 AS D72 ON D70.RKEY = D72.POPTR ON dbo.DATA0109.DATA0072_PTR = D72.RKEY
							WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER)
						)/dbo.DATA0070.EXCHANGE_RATE AS R_NK,
						'' AS Abteilung,
						'' AS Anlage

				FROM         dbo.DATA0072 INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0072.POPTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0072.UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE      (dbo.DATA0072.DESCRIPTION + ' ' + ISNULL(dbo.DATA0072.DESCRIPTION2, '') COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 
								OR dbo.DATA0072.DESCRIPTION + ' ' + ISNULL(dbo.DATA0072.DESCRIPTION2, '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS <> 3)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0072.DEL_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0072.DEL_DATE <= CONVERT(DATETIME, @para6, 103))

				UNION ALL

				SELECT DISTINCT    
				5 AS TRAN_TP, 
				'Lastschrift' As TransDesc,
				dbo.DATA0072.DESCRIPTION + STR(dbo.DATA0072.RKEY) AS INV_PART_NUMBER, 
				dbo.DATA0072.DESCRIPTION2 + STR(dbo.DATA0072.RKEY) AS INV_PART_DESCRIPTION, 
				dbo.DATA0132.MEMO_DATE AS Datum, '' AS Zeit, 
				-- dbo.DATA0109.QUANTITY AS QUANTITY, 
				0 AS QUANTITY, 
				0 AS QUAN_ON_HAND, 
				0 AS CONSIGN_ONHAND_QTY, 
				--dbo.DATA0070.PO_NUMBER AS Feld1, 
				RTRIM(dbo.DATA0070.PO_NUMBER) + '/' + LTRIM(dbo.DATA0132.MEMO_NUMBER) AS Feld1, 
				dbo.DATA0023.CODE AS Feld2, 
				dbo.DATA0002.UNIT_CODE, 
				dbo.DATA0005.ABBR_NAME, 
				0 AS PRICE, 
				0 AS Wert, 
				dbo.DATA0070.PO_DATE AS BDatum, 
				0 AS BMenge, 
				0 AS BWert, 
				0 AS NK,
				---1 * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0109.QUANTITY) AS RPreis,
				0 AS RPreis,
				-- -1 * dbo.DATA0109.QUANTITY * ((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0109.QUANTITY) AS RWert,
				-1 * dbo.DATA0132.MISC_TOT/dbo.DATA0070.EXCHANGE_RATE AS RWert,
				0 AS R_NK,
				'' AS Abteilung,
				'' AS Anlage

				FROM         dbo.DATA0023 INNER JOIN
									  dbo.DATA0132 ON dbo.DATA0023.RKEY = dbo.DATA0132.SUPP_PTR INNER JOIN
									  dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR INNER JOIN
									  dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0132.EMPL_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0072.UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      (dbo.DATA0072.DESCRIPTION + ' ' + dbo.DATA0072.DESCRIPTION2 COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 
								OR dbo.DATA0072.DESCRIPTION + ' ' + dbo.DATA0072.DESCRIPTION2 COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							AND  (dbo.DATA0070.STATUS <> 3)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0072.DEL_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0072.DEL_DATE <= CONVERT(DATETIME, @para6, 103))
			) AS tblSonst
			ORDER BY Datum DESC

		END

		IF @pST_Einkaufshistorie = 'EH_Einkaeufe_oB'
		BEGIN
			SELECT 
				TRAN_TP,
				TransDesc,
				INV_PART_NUMBER,
				INV_PART_DESCRIPTION,
				Datum,
				Zeit,
				QUANTITY,
				QUAN_ON_HAND,
				CONSIGN_ONHAND_QTY,
				Feld1,
				Feld2,
				UNIT_CODE,
				ABBR_NAME,
				PRICE,
				Wert,
				BDatum,
				BMenge,
				BWert,
				NK,
				RPreis,
				RWert,
				R_NK,
				Abteilung,
				Anlage

			FROM (SELECT  
								
					dbo.DATA0095.TRAN_TP, 
					CASE
						WHEN dbo.DATA0070.STATUS=2 THEN 'Lieferung T' ELSE 'Lieferung' 
					END As TransDesc
					,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0095.ENTERED_DATE AS Datum, dbo.DATA0095.ENTERED_TIME AS Zeit, dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					dbo.DATA0071.PRICE, dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH * dbo.DATA0071.PRICE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE AS BWert, dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					--23.10.2013 Wnn RE nicht vorhanden dann BE sonst Stamm (Vorgabe Jha)
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
					SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
										  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
										  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
										  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
							AND (dbo.DATA0017.RKEY IN (SELECT D17.RKEY FROM dbo.DATA0017 AS D17 WHERE D17.TTYPE='M'))
							AND  (dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

				UNION ALL

				SELECT  
					dbo.DATA0095.TRAN_TP, 'Retourniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0095.ENTERED_DATE AS Datum, dbo.DATA0095.ENTERED_TIME AS Zeit, (-1)*dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
					dbo.DATA0005.ABBR_NAME, 
					dbo.DATA0071.PRICE, dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH * dbo.DATA0071.PRICE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
					dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE AS BWert,dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					--23.10.2013 Wnn RE nicht vorhanden dann BE sonst Stamm (Vorgabe Jha)
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					(
					SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
					FROM         dbo.DATA0070 AS D70 INNER JOIN
										  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
										  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
										  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
					WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
							AND (dbo.DATA0017.RKEY IN (SELECT D17.RKEY FROM dbo.DATA0017 AS D17 WHERE D17.TTYPE='M'))
							AND  (dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para5, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para6, 103))
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
							AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL --offene Bestellungen

			SELECT  
							5 AS TRAN_TP, 'offene Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							 dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME,
							dbo.DATA0071.PRICE, dbo.DATA0071.QUAN_RECD/dbo.DATA0017.STOCK_PURCH * dbo.DATA0071.PRICE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
							dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE AS BWert,dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
							0 AS RPreis,
							0 AS RWert,
							(
							SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
												  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
							WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0070 INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
			WHERE      (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
						AND (dbo.DATA0017.RKEY IN (SELECT D17.RKEY FROM dbo.DATA0017 AS D17 WHERE D17.TTYPE='M'))
						--AND  (dbo.DATA0071.QUAN_RECD = 0)
						AND  (dbo.DATA0070.STATUS = 1)
						AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL --Bestellungen in Klärung 

			SELECT  
							5 AS TRAN_TP, 'in Klärung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0071.REQ_DATE AS Datum, dbo.DATA0071.REQ_DATE AS Zeit, dbo.DATA0071.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND,dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							 dbo.DATA0070.PO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME,
							dbo.DATA0071.PRICE, dbo.DATA0071.QUAN_RECD/dbo.DATA0017.STOCK_PURCH * dbo.DATA0071.PRICE AS Wert, dbo.DATA0070.PO_DATE AS BDatum,
							dbo.DATA0071.QUAN_ORD AS BMenge, dbo.DATA0071.QUAN_ORD*dbo.DATA0071.PRICE AS BWert,dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							--23.10.2013 Offene Bestellung auf Null setzen (Vorgabe Jha)
							0 AS RPreis,
							0 AS RWert,
							(
							SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
												  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
							WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0070 INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
			WHERE      (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)    
						AND (dbo.DATA0017.RKEY IN (SELECT D17.RKEY FROM dbo.DATA0017 AS D17 WHERE D17.TTYPE='M'))
						--AND  (dbo.DATA0071.QUAN_RECD = 0)
						AND  (dbo.DATA0070.STATUS = 5)
						AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
						AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
						AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL --Konsi Bestellungen

			SELECT  
							5 AS TRAN_TP, 'K-Lieferung' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY  ,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RPreis, 
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0017 INNER JOIN
								  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
			WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
					AND (dbo.DATA0017.RKEY IN (SELECT D17.RKEY FROM dbo.DATA0017 AS D17 WHERE D17.TTYPE='M'))
					AND dbo.DATA0341.TRAN_TP=1
					AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
					AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
					AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))
					AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL --rückgängig Konsi-Bestellungen

			SELECT  
							5 AS TRAN_TP, 'rückgängig Kons' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0341.TRAN_DATE AS Datum, dbo.DATA0341.TRAN_DATE AS Zeit, (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY  ,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							, dbo.DATA0467.PRICE, dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RPreis, 
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0017 INNER JOIN
								  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
			WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
					AND (dbo.DATA0017.RKEY IN (SELECT D17.RKEY FROM dbo.DATA0017 AS D17 WHERE D17.TTYPE='M'))
					AND dbo.DATA0341.TRAN_TP=15
					AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
					AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para5, 103))
					AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para6, 103))
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL --offene Konsi-Bestellungen

			SELECT  
							5 AS TRAN_TP, 'offene K-Best.' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
							0 AS RWert, 0 AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0467 INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
			WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
					AND (dbo.DATA0017.RKEY IN (SELECT D17.RKEY FROM dbo.DATA0017 AS D17 WHERE D17.TTYPE='M'))
					--AND dbo.DATA0467.QUAN_RECD=0
					AND (dbo.DATA0466.STATUS=1)
					AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
					AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
					AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
					AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL --liegende Konsi-Bestellungen

			SELECT  
							5 AS TRAN_TP, 'K-storniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, dbo.DATA0467.QUAN_RECD AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							,  dbo.DATA0467.PRICE, dbo.DATA0467.QUAN_RECD * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 0 AS RPreis,
							0 AS RWert, 0 AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0467 INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
			WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
					AND (dbo.DATA0017.RKEY IN (SELECT D17.RKEY FROM dbo.DATA0017 AS D17 WHERE D17.TTYPE='M'))
					--AND dbo.DATA0467.QUAN_RECD=0
					AND (dbo.DATA0466.STATUS=4)
					AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
					AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
					AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			UNION ALL --retournierte Konsi-Bestellungen

			SELECT  
							5 AS TRAN_TP, 'K-retourniert' As TransDesc,dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
							dbo.DATA0467.REQ_DATE AS Datum, dbo.DATA0467.REQ_DATE AS Zeit, (-1)*dbo.DATA0467.QUAN_RETN AS QUANTITY, dbo.DATA0017.QUAN_ON_HAND, dbo.DATA0017.CONSIGN_ONHAND_QTY,
							'RO-' + dbo.DATA0466.RO_NUMBER AS Feld1, dbo.DATA0023.CODE AS Feld2, dbo.DATA0002.UNIT_CODE, 
							dbo.DATA0005.ABBR_NAME
							,  dbo.DATA0467.PRICE, -1*dbo.DATA0467.QUAN_RETN * dbo.DATA0467.PRICE AS Wert, dbo.DATA0466.RO_DATE AS BDatum,
							dbo.DATA0467.QUAN_ORD AS BMenge, dbo.DATA0467.QUAN_ORD*dbo.DATA0467.PRICE AS BWert,0 AS NK, 
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RPreis, 
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN -1*dbo.DATA0467.QUAN_RETN*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 -1*dbo.DATA0467.QUAN_RETN/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS R_NK,
					(SELECT TOP 1 Abteilung FROM LIVE2.dbo.MatRueck_Abteilung WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL1) AS Abteilung,
					(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage WHERE ID=dbo.DATA0017.IES_INDIRECT_MATL2) AS Anlage

			FROM         dbo.DATA0467 INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
			WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
					AND (dbo.DATA0017.RKEY IN (SELECT D17.RKEY FROM dbo.DATA0017 AS D17 WHERE D17.TTYPE='M')) 
					AND dbo.DATA0467.QUAN_RETN>0
					AND dbo.DATA0023.SUPPLIER_NAME LIKE @para4
					AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para5, 103))
					AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para6, 103))
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL1 AS integer))) LIKE @para7)
					AND (LTRIM(STR(CAST(dbo.DATA0017.IES_INDIRECT_MATL2 AS integer))) LIKE @para8)

			)  AS ResTbl
			ORDER BY INV_PART_NUMBER, INV_PART_DESCRIPTION, Datum DESC, Zeit DESC
		END

		IF @pST_Einkaufshistorie = 'select_rkeyD19'
		BEGIN
			IF ISNUMERIC(@para2) > 0 AND ISNUMERIC(@para3) > 0
			BEGIN
				SELECT RKEY, QUAN_ON_HAND FROM DATA0019  WITH (NOLOCK)  
				WHERE INVENTORY_PTR  = CAST(@para2 AS numeric(10, 0))  
				AND LOCATION_PTR = CAST(@para3 AS numeric(10, 0)) 
			END
		END

		IF @pST_Einkaufshistorie = 'Lieferanten'
		BEGIN
			SELECT dbo.DATA0023.SUPPLIER_NAME FROM dbo.DATA0023 ORDER BY dbo.DATA0023.SUPPLIER_NAME
		END

		IF @pST_Einkaufshistorie = 'Inventurmaterial'
		BEGIN
			SELECT dbo.DATA0017.INV_PART_DESCRIPTION FROM dbo.DATA0017 
				WHERE TTYPE='R'AND ACTIVE_FLAG = 'Y' AND PROD_CODE_SELL_PTR <> 95 
					AND INV_PART_NUMBER Not Like 'REC-%' 
					--AND dbo.DATA0017.INV_PART_DESCRIPTION NOT LIKE 'PCB%' 
					ORDER BY dbo.DATA0017.INV_PART_DESCRIPTION
		END

		IF @pST_Einkaufshistorie = 'oBMaterial'
		BEGIN
			SELECT dbo.DATA0017.INV_PART_DESCRIPTION FROM dbo.DATA0017 
				WHERE TTYPE='M'AND ACTIVE_FLAG = 'Y' AND PROD_CODE_SELL_PTR <> 95 
					AND INV_PART_NUMBER Not Like 'REC-%' 
					--AND dbo.DATA0017.INV_PART_DESCRIPTION NOT LIKE 'PCB%' 
					ORDER BY dbo.DATA0017.INV_PART_DESCRIPTION
		END

		IF @pST_Einkaufshistorie = 'MaterialAlles'
		BEGIN
			SELECT dbo.DATA0017.INV_PART_DESCRIPTION FROM dbo.DATA0017 
				WHERE ACTIVE_FLAG = 'Y' AND PROD_CODE_SELL_PTR <> 95 
					--AND (ISNULL(dbo.DATA0017.MANUFACTURER_CODE, '') = '') 02.12.2014/DSI deaktiviert nach Absprache mit Hr. Wienecke (wegen Hr. Seidels Inventurberichten)
					AND dbo.DATA0017.INV_PART_DESCRIPTION NOT LIKE 'PCB%' ORDER BY dbo.DATA0017.INV_PART_DESCRIPTION
		END

	END

	--ABC Analyse
	IF @Case_ = 'ABCWarengruppe' 
	BEGIN
		--DECLARE
		--@para1 varchar(250),
		--@para2 varchar(250)
		--SET @para1 = '01.08.2016'
		--SET @para2 = '12.08.2016'

		DECLARE
		@para1VJLief varchar(250),
		@para2VJLief varchar(250),
		@paraVJLief varchar(250)

		SET @para1VJLief = SUBSTRING(@para1, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para1, 7, 4) AS INT)-1))
		SET @para2VJLief = SUBSTRING(@para2, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para2, 7, 4) AS INT)-1))
		SET @paraVJLief = LTRIM(STR(CAST(SUBSTRING(@para2, 7, 4) AS INT)-1))

		DECLARE @tblPG table (
									--D23_RKEY NUMERIC(10, 0), 
									--PC_Name char(30) null,
									PG_Name char(30) null,
									EK_Volume NUMERIC(10,2) ,
									EK_VolumeVJ NUMERIC(10,2) ,
									EK_VolumeVJ_Jahr NUMERIC(10,2) ,
									LMenge NUMERIC(10,2) ,
									AnzBestellungen int,
									DRWert NUMERIC(10,2),
									DLMenge NUMERIC(10,2),
									NK_VJ NUMERIC(10,2),
									NK_VJ_ZR NUMERIC(10,2),
									NK_ZR NUMERIC(10,2)
									)

		INSERT @tblPG(
									--PC_Name, 
									PG_Name,
									EK_Volume,
									EK_VolumeVJ,
									EK_VolumeVJ_Jahr,
									LMenge,
									AnzBestellungen,
									DRWert,
									DLMenge,
									NK_VJ,
									NK_VJ_ZR,
									NK_ZR
						)

		SELECT 
			--PC_Name, 
			PG_Name,
			SUM(EK_Volume) AS EK_Volume,
			0 AS EK_VolumeVJ,
			0 AS EK_VolumeVJ_Jahr,
			SUM(LMenge) AS LMenge,
			SUM(AnzBestellungen) AS AnzBestellungen,
			AVG(DRWert) AS DRWert,
			AVG(DLMenge) AS DLMenge,
			ISNULL((
				SELECT  TOP 1   SUM(dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) AS NK
				FROM         dbo.DATA0008 INNER JOIN
									  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
									  dbo.DATA0107 INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
				WHERE dbo.DATA0007.PRODUCT_GROUP_NAME = PG_Name
						AND (YEAR(dbo.DATA0107.INV_DATE) = CAST(@paraVJLief AS INT))
			), 0) AS NK_VJ,
			ISNULL((
				SELECT  TOP 1   SUM(dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) AS NK
				FROM         dbo.DATA0008 INNER JOIN
									  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
									  dbo.DATA0107 INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
				WHERE dbo.DATA0007.PRODUCT_GROUP_NAME = PG_Name
						AND (dbo.DATA0107.INV_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
						AND (dbo.DATA0107.INV_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
			), 0) AS NK_VJ_ZR,
			ISNULL((
				SELECT  TOP 1   SUM(dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) AS NK
				FROM         dbo.DATA0008 INNER JOIN
									  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
									  dbo.DATA0107 INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
				WHERE dbo.DATA0007.PRODUCT_GROUP_NAME = PG_Name
						AND (dbo.DATA0107.INV_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0107.INV_DATE <= CONVERT(DATETIME, @para2, 103))
			), 0) AS NK_ZR

		FROM
		(
					SELECT 
						--PRODUCT_NAME AS PC_Name, 
						PRODUCT_GROUP_NAME AS PG_Name,
						CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_Volume,
						CAST(SUM(LMenge) AS NUMERIC(10, 2)) AS LMenge,
						SUM(AnzBestellungen) AS AnzBestellungen,
						CAST(AVG(RWert) AS NUMERIC(10, 2)) AS DRWert,
						CAST(AVG(LMenge) AS NUMERIC(10, 2)) AS DLMenge

					FROM (
						--Lieferung T , Lieferung
						SELECT  
							'GGP' As BTyp,		
							dbo.DATA0095.RKEY AS D95_PTR, 
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert,
							dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							dbo.DATA0095.ENTERED_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten
							FROM         dbo.DATA0007 INNER JOIN
													dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))
									AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
										OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))

						UNION ALL

						--Retourniert
						SELECT 
							'GGP' As BTyp, 
							dbo.DATA0095.RKEY AS D95_PTR, 
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert,
							dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							dbo.DATA0095.ENTERED_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0005 INNER JOIN
												dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE    
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
								--AND 
								(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--offene Bestellungen
						SELECT  
							'GGP' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD AS LMenge,
							0 AS RWert,
							(
								SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
													  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
											  dbo.DATA0070 INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE   
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--Debit/Belastung
						SELECT  
							'GGP' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD AS LMenge,
							(-1)*dbo.DATA0132.AMOUNT AS RWert,
							dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0008 INNER JOIN
											  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
											  dbo.DATA0132 INNER JOIN
											  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
											  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--Bestellungen in Klärung 
						SELECT  
							'GGP' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD AS LMenge,
							0 AS RWert,
							(
								SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
													  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)	
							) AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0008 INNER JOIN
											  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
											  dbo.DATA0070 INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									(dbo.DATA0070.STATUS = 5)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--Konsi Bestellungen
						SELECT  
							'Konsi' As BTyp,
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0341.TRAN_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
											  dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								dbo.DATA0341.TRAN_TP=1
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))


						UNION ALL 

						--rückgängig Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION,
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0341.TRAN_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
											  dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE    
								dbo.DATA0341.TRAN_TP=15
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--offene Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0467.QUAN_RECD AS LMenge,
							0 AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
											  dbo.DATA0467 INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								(dbo.DATA0466.STATUS=1)
								AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--liegende Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0467.QUAN_RECD AS LMenge,
							0 AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0008 INNER JOIN
											  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
											  dbo.DATA0467 INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								(dbo.DATA0466.STATUS=4)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--retournierte Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
											  dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								dbo.DATA0341.TRAN_TP=2
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))


					)  AS ResTbl
					GROUP BY
						--D23_RKEY,
						--Lieferant
						PRODUCT_GROUP_NAME
						--UNIT_CODE,
						--QUAN_ON_HAND,
						--CONSIGN_ONHAND_QTY,
						--LetzterLieferant,
						--AnzLieferanten

		) AS tblMain
		GROUP BY PG_Name --D23_RKEY, Lieferant
		--ORDER BY SUM(EK_Volume) DESC 


		--UPDATE
		----------------------------------
		UPDATE tblPG
		SET tblPG.EK_VolumeVJ = myTblEK_VolumeVJ.EK_VolumeVJ
		FROM
		@tblPG AS tblPG,
		(
					SELECT 
						--D17_RKEY,  
						--D23_RKEY,
						--PC_Name,
						PG_Name,
						CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ

					FROM (
						--Lieferung T , Lieferung
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0070 AS D70 INNER JOIN
														dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0005 INNER JOIN
												dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE    
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
									OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


						UNION ALL

						--Retourniert
						SELECT 
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0070 AS D70 INNER JOIN
														dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert

							FROM         dbo.DATA0007 INNER JOIN
													dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND 
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Debit/Belastung
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							(-1)*dbo.DATA0132.AMOUNT AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Bestellungen in Klärung 
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert
								
						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 5)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Konsi Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=1
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						UNION ALL 

						--rückgängig Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=15
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=1)
								AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--liegende Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=4)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--retournierte Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=2
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

					)  AS ResTbl
					GROUP BY
						PG_Name
		) AS myTblEK_VolumeVJ
		WHERE 
		tblPG.PG_Name COLLATE SQL_Latin1_General_CP1_CI_AS = myTblEK_VolumeVJ.PG_Name
		----------------------------------

		--INSERT
		----------------------------------
		INSERT @tblPG(
									--D23_RKEY, 
									--PC_Name,
									PG_Name,
									EK_Volume,
									EK_VolumeVJ,
									EK_VolumeVJ_Jahr,
									LMenge,
									AnzBestellungen,
									DRWert,
									DLMenge
						)

		SELECT
			--myTblEK_VolumeVJ.D23_RKEY,
			--myTblEK_VolumeVJ.PC_Name,
			myTblEK_VolumeVJ.PG_Name,
			0,
			myTblEK_VolumeVJ.EK_VolumeVJ,
			0,
			0,
			0,
			0,
			0

		FROM
		--@tblPG AS tblPG,
		(
					SELECT 
						--D17_RKEY,  
						--D23_RKEY,
						--PC_Name,
						PG_Name,
						CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ

					FROM (
						--Lieferung T , Lieferung
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0070 AS D70 INNER JOIN
														dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert

							FROM         dbo.DATA0008 INNER JOIN
													dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
									AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
										OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


						UNION ALL

						--Retourniert
						SELECT 
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0070 AS D70 INNER JOIN
														dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert

							FROM         dbo.DATA0007 INNER JOIN
													dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND 
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Debit/Belastung
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							(-1)*dbo.DATA0132.AMOUNT AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Bestellungen in Klärung 
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert
								
						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 5)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Konsi Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=1
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						UNION ALL 

						--rückgängig Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=15
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=1)
								AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--liegende Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=4)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--retournierte Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=2
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

					)  AS ResTbl
					GROUP BY
						PG_Name		
		) AS myTblEK_VolumeVJ
		WHERE 
		myTblEK_VolumeVJ.PG_Name COLLATE SQL_Latin1_General_CP1_CI_AS Not In (SELECT tblPG.PG_Name FROM @tblPG AS tblPG)
		----------------------------------


		--UPDATE EK VOLUMEN GANZES JAHR
		----------------------------------
		UPDATE tblPG
		SET tblPG.EK_VolumeVJ_Jahr = myTblEK_VolumeVJ_Jahr.EK_VolumeVJ_Jahr
		FROM
		@tblPG AS tblPG,
		(
					SELECT 
						--PC_Name,
						PG_Name,
						CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ_Jahr

					FROM (
						--Lieferung T , Lieferung
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0070 AS D70 INNER JOIN
														dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert

							FROM         dbo.DATA0008 INNER JOIN
													dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
									AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
										OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


						UNION ALL

						--Retourniert
						SELECT 
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0070 AS D70 INNER JOIN
														dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert

							FROM         dbo.DATA0008 INNER JOIN
													dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND 
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Debit/Belastung
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							(-1)*dbo.DATA0132.AMOUNT AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Bestellungen in Klärung 
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert
								
						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 5)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Konsi Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=1
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (YEAR(dbo.DATA0341.TRAN_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
								--AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						UNION ALL 

						--rückgängig Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=15
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (YEAR(dbo.DATA0341.TRAN_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
								--AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=1)
								AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (YEAR(dbo.DATA0467.REQ_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
								--AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--liegende Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=4)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (YEAR(dbo.DATA0467.REQ_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
								--AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--retournierte Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=2
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (YEAR(dbo.DATA0341.TRAN_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
								--AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

					)  AS ResTbl
					GROUP BY
						PG_Name
		) AS myTblEK_VolumeVJ_Jahr
		WHERE 
		--tblArtLief.D17_RKEY = myTblEK_VolumeVJ.D17_RKEY
		--AND
		--tblPG.D23_RKEY = myTblEK_VolumeVJ.D23_RKEY
		tblPG.PG_Name COLLATE SQL_Latin1_General_CP1_CI_AS = myTblEK_VolumeVJ_Jahr.PG_Name
		----------------------------------



		SELECT
			--PC_Name, 
			PG_Name,
			ISNULL(EK_Volume, 0) AS EK_Volume, --EK-Vol. ZR
			ISNULL(EK_VolumeVJ, 0) AS EK_VolumeVJ, --EK-Vol. VJ ZR
			ISNULL(EK_Volume-EK_VolumeVJ, 0) AS EK_VolumeDiff, --Differenz
			CASE WHEN EK_VolumeVJ>0 THEN ISNULL((EK_Volume-EK_VolumeVJ)/EK_VolumeVJ*100, 0) ELSE 0 END AS EK_VolumeDiffProz, --in %
			ISNULL(AnzBestellungen, 0) AS AnzBestellungen, --Anz. Lieferungen
			--CASE WHEN ISNULL(letztes_LDatum, '')='' THEN '' ELSE CONVERT(varchar(10), letztes_LDatum, 104) END AS letztes_LDatum, --letze Lieferung vom
			ISNULL(EK_VolumeVJ_Jahr, 0) AS EK_VolumeVJ_Jahr, --EK-Vol. Vorjahr
			CASE WHEN ISNULL(EK_VolumeVJ_Jahr, 0)>0 THEN ISNULL(EK_Volume, 0)/ISNULL(EK_VolumeVJ_Jahr, 0)*100 ELSE 0 END AS AnteilEKVolZR_inProz, --Anteil EK Vol ZR an VJ in %
			ISNULL(NK_VJ, 0) AS NKVorjahr, --NK Vorjahr
			ISNULL(NK_ZR, 0) AS NKZR, --NK ZR
			ISNULL(NK_VJ_ZR, 0) AS NKVJZR, --NK ZR
			ISNULL(DRWert, 0) AS DRWert, --O Rechnungswert
			ISNULL(LMenge, 0) AS LMenge, --EK-Menge
			ISNULL(DLMenge, 0) AS DLMenge --O Liefermenge

			--ISNULL(EK_Volume_ArtGesamt, 0) AS EK_Volume_ArtGesamt,
			--ISNULL(EK_Volume/EK_Volume_TOTAL*100, 0) AS Proz_Anteil,
			--D17_RKEY, 
			--INV_PART_NUMBER, 
			--INV_PART_DESCRIPTION,
			--Anteil EK Vol ZR an VJ
			--UNIT_CODE,
			--ISNULL(DRPreis, 0) AS DRPreis,
			--ISNULL(Letzter_EK_Preis, 0) AS Letzter_EK_Preis,
			--letztes_LDatum,
			--CONVERT(varchar(10), letztes_LDatum, 104) AS letztes_LDatum,
			
		FROM
		(
			SELECT
			--(SELECT TOP 1 SUM(EK_Volume) FROM @tblPG AS myTmptblPG WHERE myTmptblPG.D23_RKEY = myTmpTblArtLiefMain.D23_RKEY) AS EK_Volume_ArtGesamt,
			(SELECT TOP 1 SUM(EK_Volume) FROM @tblPG AS myTmptblPG WHERE myTmptblPG.PG_Name = myTmpTblArtLiefMain.PG_Name) AS EK_Volume_ArtGesamt,
			(SELECT TOP 1 SUM(EK_Volume) FROM @tblPG AS myTmptblPG) AS EK_Volume_TOTAL,
			* 
			FROM @tblPG AS myTmpTblArtLiefMain --ORDER BY INV_PART_NUMBER, INV_PART_DESCRIPTION
		) AS tbl
		ORDER BY EK_Volume DESC--EK_Volume_ArtGesamt DESC, INV_PART_DESCRIPTION, EK_Volume DESC
	END

	IF @Case_ = 'ABCWarengruppeDetail' 
	BEGIN
		--DECLARE
		--@para1 varchar(250),
		--@para2 varchar(250),
		--@para3 varchar(250)
		--SET @para1 = '01.08.2016'
		--SET @para2 = '12.08.2016'
		--SET @para3 = 'Chemie'
		--DECLARE
		--@para1VJLief varchar(250),
		--@para2VJLief varchar(250),
		--@paraVJLief varchar(250)

		SET @para1VJLief = SUBSTRING(@para1, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para1, 7, 4) AS INT)-1))
		SET @para2VJLief = SUBSTRING(@para2, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para2, 7, 4) AS INT)-1))
		SET @paraVJLief = LTRIM(STR(CAST(SUBSTRING(@para2, 7, 4) AS INT)-1))

		DECLARE @tblPC table (
									--D23_RKEY NUMERIC(10, 0), 
									--PC_Name char(30) null,
									PC_Name char(30) null,
									EK_Volume NUMERIC(10,2) ,
									EK_VolumeVJ NUMERIC(10,2) ,
									EK_VolumeVJ_Jahr NUMERIC(10,2) ,
									LMenge NUMERIC(10,2) ,
									AnzBestellungen int,
									DRWert NUMERIC(10,2),
									DLMenge NUMERIC(10,2),
									NK_VJ NUMERIC(10,2),
									NK_VJ_ZR NUMERIC(10,2),
									NK_ZR NUMERIC(10,2)
									)

		INSERT @tblPC(
									--PC_Name, 
									PC_Name,
									EK_Volume,
									EK_VolumeVJ,
									EK_VolumeVJ_Jahr,
									LMenge,
									AnzBestellungen,
									DRWert,
									DLMenge,
									NK_VJ,
									NK_VJ_ZR,
									NK_ZR
						)

		SELECT 
			--PC_Name, 
			PC_Name,
			SUM(EK_Volume) AS EK_Volume,
			0 AS EK_VolumeVJ,
			0 AS EK_VolumeVJ_Jahr,
			SUM(LMenge) AS LMenge,
			SUM(AnzBestellungen) AS AnzBestellungen,
			AVG(DRWert) AS DRWert,
			AVG(DLMenge) AS DLMenge,
			ISNULL((
				SELECT  TOP 1   SUM((dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) / dbo.DATA0107.EX_RATE) AS NK
				FROM         dbo.DATA0008 INNER JOIN
									  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
									  dbo.DATA0107 INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
				WHERE dbo.DATA0007.PRODUCT_GROUP_NAME = @para3
						AND dbo.DATA0008.PRODUCT_NAME = PC_Name
						AND (YEAR(dbo.DATA0107.INV_DATE) = CAST(@paraVJLief AS INT))
			), 0) AS NK_VJ,
			ISNULL((
				SELECT  TOP 1   SUM((dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) / dbo.DATA0107.EX_RATE) AS NK
				FROM         dbo.DATA0008 INNER JOIN
									  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
									  dbo.DATA0107 INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
				WHERE dbo.DATA0007.PRODUCT_GROUP_NAME = @para3
						AND dbo.DATA0008.PRODUCT_NAME = PC_Name
						AND (dbo.DATA0107.INV_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
						AND (dbo.DATA0107.INV_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
			), 0) AS NK_VJ_ZR,
			ISNULL((
				SELECT  TOP 1   SUM((dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) / dbo.DATA0107.EX_RATE) AS NK
				FROM         dbo.DATA0008 INNER JOIN
									  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
									  dbo.DATA0107 INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
				WHERE dbo.DATA0007.PRODUCT_GROUP_NAME = @para3
						AND dbo.DATA0008.PRODUCT_NAME = PC_Name
						AND (dbo.DATA0107.INV_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0107.INV_DATE <= CONVERT(DATETIME, @para2, 103))
			), 0) AS NK_ZR

		FROM
		(
					SELECT 
						PRODUCT_NAME AS PC_Name, 
						PRODUCT_GROUP_NAME AS PG_Name,
						CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_Volume,
						CAST(SUM(LMenge) AS NUMERIC(10, 2)) AS LMenge,
						SUM(AnzBestellungen) AS AnzBestellungen,
						CAST(AVG(RWert) AS NUMERIC(10, 2)) AS DRWert,
						CAST(AVG(LMenge) AS NUMERIC(10, 2)) AS DLMenge

					FROM (
						--Lieferung T , Lieferung
						SELECT  
							'GGP' As BTyp,		
							dbo.DATA0095.RKEY AS D95_PTR, 
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							ISNULL((
								SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE / dbo.DATA0107.EX_RATE
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE / D70.EXCHANGE_RATE
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis
								FROM         dbo.DATA0107 INNER JOIN
													  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert,
							(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE) / dbo.DATA0070.EXCHANGE_RATE AS NK,
							dbo.DATA0095.ENTERED_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten
						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0005 INNER JOIN
												dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE    
								(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
								AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))
								AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
									OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))

						UNION ALL

						--Retourniert
						SELECT 
							'GGP' As BTyp, 
							dbo.DATA0095.RKEY AS D95_PTR, 
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							ISNULL((
								SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE / dbo.DATA0107.EX_RATE
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE / D70.EXCHANGE_RATE
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis
								FROM         dbo.DATA0107 INNER JOIN
													  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert,
							(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE)/dbo.DATA0070.EXCHANGE_RATE AS NK,
							dbo.DATA0095.ENTERED_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0005 INNER JOIN
												dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE    
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
								--AND 
								(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--offene Bestellungen
						SELECT  
							'GGP' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD/dbo.DATA0017.STOCK_PURCH AS LMenge,
							0 AS RWert,
							(
								SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0070.EXCHANGE_RATE AS Res
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
													  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
											  dbo.DATA0070 INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE   
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--Debit/Belastung
						SELECT  
							'GGP' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD/dbo.DATA0017.STOCK_PURCH AS LMenge,
							(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert,
							(dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT)/dbo.DATA0132.EX_RATE AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0008 INNER JOIN
											  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
											  dbo.DATA0132 INNER JOIN
											  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
											  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--Bestellungen in Klärung 
						SELECT  
							'GGP' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD/dbo.DATA0017.STOCK_PURCH AS LMenge,
							0 AS RWert,
							(
								SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) / dbo.DATA0107.EX_RATE AS Res
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
													  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)	
							) AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0008 INNER JOIN
											  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
											  dbo.DATA0070 INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									(dbo.DATA0070.STATUS = 5)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--Konsi Bestellungen
						SELECT  
							'Konsi' As BTyp,
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0341.TRAN_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
											  dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								dbo.DATA0341.TRAN_TP=1
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))


						UNION ALL 

						--rückgängig Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION,
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0341.TRAN_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
											  dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE    
								dbo.DATA0341.TRAN_TP=15
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--offene Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0467.QUAN_RECD/dbo.DATA0017.STOCK_PURCH AS LMenge,
							0 AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
											  dbo.DATA0467 INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								(dbo.DATA0466.STATUS=1)
								AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--liegende Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0467.QUAN_RECD/dbo.DATA0017.STOCK_PURCH AS LMenge,
							0 AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0008 INNER JOIN
											  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
											  dbo.DATA0467 INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								(dbo.DATA0466.STATUS=4)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--retournierte Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
											  dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								dbo.DATA0341.TRAN_TP=2
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))


					)  AS ResTbl
					WHERE PRODUCT_GROUP_NAME = @para3 
					GROUP BY
						--D23_RKEY,
						--Lieferant
						PRODUCT_NAME,
						PRODUCT_GROUP_NAME
						--UNIT_CODE,
						--QUAN_ON_HAND,
						--CONSIGN_ONHAND_QTY,
						--LetzterLieferant,
						--AnzLieferanten

		) AS tblMain
		GROUP BY PC_Name --D23_RKEY, Lieferant
		--ORDER BY SUM(EK_Volume) DESC 


		--UPDATE
		----------------------------------
		UPDATE tblPC
		SET tblPC.EK_VolumeVJ = myTblEK_VolumeVJ.EK_VolumeVJ
		FROM
		@tblPC AS tblPC,
		(
					SELECT 
						--D17_RKEY,  
						--D23_RKEY,
						--PC_Name,
						ResTbl.PC_Name,
						CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ

					FROM (
						--Lieferung T , Lieferung
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							ISNULL((
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0107 AS D107 INNER JOIN
													  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0005 INNER JOIN
												dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE    
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
									OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


						UNION ALL

						--Retourniert
						SELECT 
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							ISNULL((
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0107 AS D107 INNER JOIN
													  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert

							FROM         dbo.DATA0007 INNER JOIN
													dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND 
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Debit/Belastung
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PC_Name,
							(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Bestellungen in Klärung 
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert
								
						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 5)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Konsi Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=1
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						UNION ALL 

						--rückgängig Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=15
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=1)
								AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--liegende Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=4)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--retournierte Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=2
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

					)  AS ResTbl
					WHERE PG_Name = @para3
					GROUP BY
						ResTbl.PC_Name
		) AS myTblEK_VolumeVJ
		WHERE 
		tblPC.PC_Name COLLATE SQL_Latin1_General_CP1_CI_AS = myTblEK_VolumeVJ.PC_Name
		----------------------------------

		--INSERT
		----------------------------------
		INSERT @tblPC(
									--D23_RKEY, 
									--PC_Name,
									PC_Name,
									EK_Volume,
									EK_VolumeVJ,
									EK_VolumeVJ_Jahr,
									LMenge,
									AnzBestellungen,
									DRWert,
									DLMenge
						)

		SELECT
			--myTblEK_VolumeVJ.D23_RKEY,
			--myTblEK_VolumeVJ.PC_Name,
			myTblEK_VolumeVJ.PC_Name,
			0,
			SUM(myTblEK_VolumeVJ.EK_VolumeVJ) AS EK_VolumeVJ,
			0,
			0,
			0,
			0,
			0

		FROM
		--@tblPC AS tblPC,
		(
					SELECT 
						--D17_RKEY,  
						--D23_RKEY,
						PC_Name,
						PG_Name,
						CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ

					FROM (
						--Lieferung T , Lieferung
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							ISNULL((
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0107 AS D107 INNER JOIN
													  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert

							FROM         dbo.DATA0008 INNER JOIN
													dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
									AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
										OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


						UNION ALL

						--Retourniert
						SELECT 
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							ISNULL((
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0107 AS D107 INNER JOIN
													  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert

							FROM         dbo.DATA0007 INNER JOIN
													dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND 
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Debit/Belastung
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Bestellungen in Klärung 
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert
								
						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 5)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Konsi Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=1
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						UNION ALL 

						--rückgängig Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=15
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=1)
								AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--liegende Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=4)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--retournierte Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=2
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

					)  AS ResTbl
					WHERE PG_Name = @para3 
					GROUP BY
						PC_Name,
						PG_Name	
		) AS myTblEK_VolumeVJ
		WHERE 
			myTblEK_VolumeVJ.PC_Name COLLATE SQL_Latin1_General_CP1_CI_AS Not In (SELECT tblPC.PC_Name FROM @tblPC AS tblPC)
		GROUP BY
			myTblEK_VolumeVJ.PC_Name
		----------------------------------


		--UPDATE EK VOLUMEN GANZES JAHR
		----------------------------------
		UPDATE tblPC
		SET tblPC.EK_VolumeVJ_Jahr = myTblEK_VolumeVJ_Jahr.EK_VolumeVJ_Jahr
		FROM
		@tblPC AS tblPC,
		(
					SELECT 
						--PC_Name,
						PC_Name,
						CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ_Jahr

					FROM (
						--Lieferung T , Lieferung
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							ISNULL((
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0107 AS D107 INNER JOIN
													  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert

							FROM         dbo.DATA0008 INNER JOIN
													dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
									AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
										OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


						UNION ALL

						--Retourniert
						SELECT 
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							ISNULL((
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0107 AS D107 INNER JOIN
													  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert

							FROM         dbo.DATA0008 INNER JOIN
													dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND 
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Debit/Belastung
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Bestellungen in Klärung 
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert
								
						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 5)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Konsi Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=1
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (YEAR(dbo.DATA0341.TRAN_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
								--AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						UNION ALL 

						--rückgängig Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PC_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=15
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (YEAR(dbo.DATA0341.TRAN_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
								--AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=1)
								AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (YEAR(dbo.DATA0467.REQ_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
								--AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--liegende Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=4)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (YEAR(dbo.DATA0467.REQ_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
								--AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--retournierte Konsi-Bestellungen
						SELECT  
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=2
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (YEAR(dbo.DATA0341.TRAN_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
								--AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

					)  AS ResTbl
					WHERE
						PG_Name = @para3
					GROUP BY
						PC_Name
		) AS myTblEK_VolumeVJ_Jahr
		WHERE 
		--tblArtLief.D17_RKEY = myTblEK_VolumeVJ.D17_RKEY
		--AND
		--tblPC.D23_RKEY = myTblEK_VolumeVJ.D23_RKEY
			tblPC.PC_Name COLLATE SQL_Latin1_General_CP1_CI_AS = myTblEK_VolumeVJ_Jahr.PC_Name
		----------------------------------



		SELECT
			--PC_Name, 
			PC_Name,
			ISNULL(EK_Volume, 0) AS EK_Volume, --EK-Vol. ZR
			ISNULL(EK_VolumeVJ, 0) AS EK_VolumeVJ, --EK-Vol. VJ ZR
			ISNULL(EK_Volume-EK_VolumeVJ, 0) AS EK_VolumeDiff, --Differenz
			CASE WHEN EK_VolumeVJ>0 THEN ISNULL((EK_Volume-EK_VolumeVJ)/EK_VolumeVJ*100, 0) ELSE 0 END AS EK_VolumeDiffProz, --in %
			ISNULL(AnzBestellungen, 0) AS AnzBestellungen, --Anz. Lieferungen
			--CASE WHEN ISNULL(letztes_LDatum, '')='' THEN '' ELSE CONVERT(varchar(10), letztes_LDatum, 104) END AS letztes_LDatum, --letze Lieferung vom
			ISNULL(EK_VolumeVJ_Jahr, 0) AS EK_VolumeVJ_Jahr, --EK-Vol. Vorjahr
			CASE WHEN ISNULL(EK_VolumeVJ_Jahr, 0)>0 THEN ISNULL(EK_Volume, 0)/ISNULL(EK_VolumeVJ_Jahr, 0)*100 ELSE 0 END AS AnteilEKVolZR_inProz, --Anteil EK Vol ZR an VJ in %
			ISNULL(NK_VJ, 0) AS NKVorjahr, --NK Vorjahr
			ISNULL(NK_ZR, 0) AS NKZR, --NK ZR
			ISNULL(NK_VJ_ZR, 0) AS NKVJZR, --NK ZR
			ISNULL(DRWert, 0) AS DRWert, --O Rechnungswert
			ISNULL(LMenge, 0) AS LMenge, --EK-Menge
			ISNULL(DLMenge, 0) AS DLMenge --O Liefermenge

			--ISNULL(EK_Volume_ArtGesamt, 0) AS EK_Volume_ArtGesamt,
			--ISNULL(EK_Volume/EK_Volume_TOTAL*100, 0) AS Proz_Anteil,
			--D17_RKEY, 
			--INV_PART_NUMBER, 
			--INV_PART_DESCRIPTION,
			--Anteil EK Vol ZR an VJ
			--UNIT_CODE,
			--ISNULL(DRPreis, 0) AS DRPreis,
			--ISNULL(Letzter_EK_Preis, 0) AS Letzter_EK_Preis,
			--letztes_LDatum,
			--CONVERT(varchar(10), letztes_LDatum, 104) AS letztes_LDatum,
			
		FROM
		(
			SELECT
			--(SELECT TOP 1 SUM(EK_Volume) FROM @tblPC AS myTmptblPC WHERE myTmptblPC.D23_RKEY = myTmpTblArtLiefMain.D23_RKEY) AS EK_Volume_ArtGesamt,
			(SELECT TOP 1 SUM(EK_Volume) FROM @tblPC AS myTmptblPC WHERE myTmptblPC.PC_Name = myTmpTblArtLiefMain.PC_Name) AS EK_Volume_ArtGesamt,
			(SELECT TOP 1 SUM(EK_Volume) FROM @tblPC AS myTmptblPC) AS EK_Volume_TOTAL,
			* 
			FROM @tblPC AS myTmpTblArtLiefMain --ORDER BY INV_PART_NUMBER, INV_PART_DESCRIPTION
		) AS tbl
		ORDER BY EK_Volume DESC--EK_Volume_ArtGesamt DESC, INV_PART_DESCRIPTION, EK_Volume DESC
	END

	IF @Case_ = 'ABCWarengruppeDetailInv' 
	BEGIN
		--DECLARE
		--@para1 varchar(250),
		--@para2 varchar(250),
		--@para3 varchar(250)
		--SET @para1 = '01.08.2016'
		--SET @para2 = '12.08.2016'
		--SET @para3 = 'Chemie'

		--DECLARE
		--@para1VJLief varchar(250),
		--@para2VJLief varchar(250),
		--@paraVJLief varchar(250)

		SET @para1VJLief = SUBSTRING(@para1, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para1, 7, 4) AS INT)-1))
		SET @para2VJLief = SUBSTRING(@para2, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para2, 7, 4) AS INT)-1))
		SET @paraVJLief = LTRIM(STR(CAST(SUBSTRING(@para2, 7, 4) AS INT)-1))

		DECLARE @tblPCInv table (
									--D23_RKEY NUMERIC(10, 0), 
									--PC_Name char(30) null,
									INV_PART_DESCRIPTION char(100) null,
									PC_Name char(30) null,
									EK_Volume NUMERIC(10,2) ,
									EK_VolumeVJ NUMERIC(10,2) ,
									EK_VolumeVJ_Jahr NUMERIC(10,2) ,
									LMenge NUMERIC(10,2) ,
									AnzBestellungen int,
									DRWert NUMERIC(10,2),
									DLMenge NUMERIC(10,2),
									NK_VJ NUMERIC(10,2),
									NK_VJ_ZR NUMERIC(10,2),
									NK_ZR NUMERIC(10,2)
									)

		INSERT @tblPCInv(
									--PC_Name, 
									INV_PART_DESCRIPTION,
									PC_Name,
									EK_Volume,
									EK_VolumeVJ,
									EK_VolumeVJ_Jahr,
									LMenge,
									AnzBestellungen,
									DRWert,
									DLMenge,
									NK_VJ,
									NK_VJ_ZR,
									NK_ZR
						)

		SELECT 
			--PC_Name, 
			INV_PART_DESCRIPTION,
			PC_Name,
			SUM(EK_Volume) AS EK_Volume,
			0 AS EK_VolumeVJ,
			0 AS EK_VolumeVJ_Jahr,
			SUM(LMenge) AS LMenge,
			SUM(AnzBestellungen) AS AnzBestellungen,
			AVG(DRWert) AS DRWert,
			AVG(DLMenge) AS DLMenge,
			ISNULL((
				SELECT  TOP 1   SUM((dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) / dbo.DATA0107.EX_RATE) AS NK
				FROM         dbo.DATA0008 INNER JOIN
									  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
									  dbo.DATA0107 INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
				WHERE dbo.DATA0007.PRODUCT_GROUP_NAME = @para3
						AND dbo.DATA0008.PRODUCT_NAME = PC_Name
						AND (YEAR(dbo.DATA0107.INV_DATE) = CAST(@paraVJLief AS INT))
			), 0) AS NK_VJ,
			ISNULL((
				SELECT  TOP 1   SUM((dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) / dbo.DATA0107.EX_RATE)  AS NK
				FROM         dbo.DATA0008 INNER JOIN
									  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
									  dbo.DATA0107 INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
				WHERE dbo.DATA0007.PRODUCT_GROUP_NAME = @para3
						AND dbo.DATA0008.PRODUCT_NAME = PC_Name
						AND (dbo.DATA0107.INV_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
						AND (dbo.DATA0107.INV_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
			), 0) AS NK_VJ_ZR,
			ISNULL((
				SELECT  TOP 1   SUM((dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) / dbo.DATA0107.EX_RATE)  AS NK
				FROM         dbo.DATA0008 INNER JOIN
									  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
									  dbo.DATA0107 INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
				WHERE dbo.DATA0007.PRODUCT_GROUP_NAME = @para3
						AND dbo.DATA0008.PRODUCT_NAME = PC_Name
						AND (dbo.DATA0107.INV_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0107.INV_DATE <= CONVERT(DATETIME, @para2, 103))
			), 0) AS NK_ZR

		FROM
		(
					SELECT 
						INV_PART_DESCRIPTION,
						PRODUCT_NAME AS PC_Name, 
						PRODUCT_GROUP_NAME AS PG_Name,
						CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_Volume,
						CAST(SUM(LMenge) AS NUMERIC(10, 2)) AS LMenge,
						SUM(AnzBestellungen) AS AnzBestellungen,
						CAST(AVG(RWert) AS NUMERIC(10, 2)) AS DRWert,
						CAST(AVG(LMenge) AS NUMERIC(10, 2)) AS DLMenge

					FROM (
						--Lieferung T , Lieferung
						SELECT  
							'GGP' As BTyp,	
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,	
							dbo.DATA0095.RKEY AS D95_PTR, 
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							--dbo.DATA0017.INV_PART_DESCRIPTION,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							ISNULL((
								SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE / dbo.DATA0107.EX_RATE
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE / D70.EXCHANGE_RATE
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis
								FROM         dbo.DATA0107 INNER JOIN
													  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert,
							(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE) / dbo.DATA0070.EXCHANGE_RATE AS NK,
							dbo.DATA0095.ENTERED_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten
							FROM         dbo.DATA0007 INNER JOIN
													dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))
									AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
										OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))

						UNION ALL

						--Retourniert
						SELECT 
							'GGP' As BTyp, 
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,	
							dbo.DATA0095.RKEY AS D95_PTR, 
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							--dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							ISNULL((
								SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE / dbo.DATA0107.EX_RATE
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE / D70.EXCHANGE_RATE
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis
								FROM         dbo.DATA0107 INNER JOIN
													  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert,
							(dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE) / dbo.DATA0070.EXCHANGE_RATE AS NK,
							dbo.DATA0095.ENTERED_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0005 INNER JOIN
												dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE    
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
								--AND 
								(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--offene Bestellungen
						SELECT  
							'GGP' As BTyp,
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,	
							0 AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							--dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD/dbo.DATA0017.STOCK_PURCH AS LMenge,
							0 AS RWert,
							ISNULL((
								SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)/dbo.DATA0070.EXCHANGE_RATE AS Res
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
													  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
											  dbo.DATA0070 INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE   
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--Debit/Belastung
						SELECT  
							'GGP' As BTyp,
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,	
							0 AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							--dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD/dbo.DATA0017.STOCK_PURCH AS LMenge,
							(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert,
							(dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT)/dbo.DATA0132.EX_RATE AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0008 INNER JOIN
											  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
											  dbo.DATA0132 INNER JOIN
											  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
											  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--Bestellungen in Klärung 
						SELECT  
							'GGP' As BTyp,
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,	
							0 AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							--dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD/dbo.DATA0017.STOCK_PURCH AS LMenge,
							0 AS RWert,
							ISNULL((
								SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) / dbo.DATA0107.EX_RATE AS Res
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
													  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)	
							), 0) AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0008 INNER JOIN
											  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
											  dbo.DATA0070 INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									(dbo.DATA0070.STATUS = 5)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--Konsi Bestellungen
						SELECT  
							'Konsi' As BTyp,
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,	
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							--dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0341.TRAN_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
											  dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								dbo.DATA0341.TRAN_TP=1
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))


						UNION ALL 

						--rückgängig Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,	
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							--dbo.DATA0017.INV_PART_DESCRIPTION,
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0341.TRAN_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
											  dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE    
								dbo.DATA0341.TRAN_TP=15
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--offene Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,	
							0 AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							--dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0467.QUAN_RECD/dbo.DATA0017.STOCK_PURCH AS LMenge,
							0 AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
											  dbo.DATA0467 INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								(dbo.DATA0466.STATUS=1)
								AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--liegende Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,	
							0 AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							--dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0467.QUAN_RECD/dbo.DATA0017.STOCK_PURCH AS LMenge,
							0 AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0008 INNER JOIN
											  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
											  dbo.DATA0467 INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								(dbo.DATA0466.STATUS=4)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--retournierte Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,	
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0008.PRODUCT_NAME, 
							dbo.DATA0007.PRODUCT_GROUP_NAME,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							--dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0007 INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
											  dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								dbo.DATA0341.TRAN_TP=2
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))


					)  AS ResTbl
					WHERE PRODUCT_GROUP_NAME = @para3 
					GROUP BY
						--D23_RKEY,
						--Lieferant
						INV_PART_DESCRIPTION,
						PRODUCT_NAME,
						PRODUCT_GROUP_NAME
						--UNIT_CODE,
						--QUAN_ON_HAND,
						--CONSIGN_ONHAND_QTY,
						--LetzterLieferant,
						--AnzLieferanten

		) AS tblMain
		GROUP BY INV_PART_DESCRIPTION, PC_Name --D23_RKEY, Lieferant
		--ORDER BY SUM(EK_Volume) DESC 


		--UPDATE
		----------------------------------
		UPDATE tblPCInv
		SET tblPCInv.EK_VolumeVJ = myTblEK_VolumeVJ.EK_VolumeVJ
		FROM
		@tblPCInv AS tblPCInv,
		(
					SELECT 
						--D17_RKEY,  
						--D23_RKEY,
						--PC_Name,
						ResTbl.INV_PART_DESCRIPTION,
						ResTbl.PC_Name,
						CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ

					FROM (
						--Lieferung T , Lieferung
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							ISNULL((
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0107 AS D107 INNER JOIN
													  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0005 INNER JOIN
												dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE    
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
									OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


						UNION ALL

						--Retourniert
						SELECT 
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							ISNULL((
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0107 AS D107 INNER JOIN
													  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert

							FROM         dbo.DATA0007 INNER JOIN
													dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND 
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Debit/Belastung
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PC_Name,
							(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Bestellungen in Klärung 
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert
								
						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 5)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Konsi Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=1
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						UNION ALL 

						--rückgängig Konsi-Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=15
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Konsi-Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=1)
								AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--liegende Konsi-Bestellungen
						SELECT 
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,					 
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=4)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--retournierte Konsi-Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name, 
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=2
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

					)  AS ResTbl
					WHERE PG_Name = @para3 
					GROUP BY
						ResTbl.INV_PART_DESCRIPTION,
						ResTbl.PC_Name
		) AS myTblEK_VolumeVJ
		WHERE 
			tblPCInv.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = myTblEK_VolumeVJ.INV_PART_DESCRIPTION
			AND tblPCInv.PC_Name COLLATE SQL_Latin1_General_CP1_CI_AS = myTblEK_VolumeVJ.PC_Name
		----------------------------------

		--INSERT
		----------------------------------
		INSERT @tblPCInv(
									--D23_RKEY, 
									--PC_Name,
									INV_PART_DESCRIPTION,
									PC_Name,
									EK_Volume,
									EK_VolumeVJ,
									EK_VolumeVJ_Jahr,
									LMenge,
									AnzBestellungen,
									DRWert,
									DLMenge
						)

		SELECT
			--myTblEK_VolumeVJ.D23_RKEY,
			--myTblEK_VolumeVJ.PC_Name,
			myTblEK_VolumeVJ.INV_PART_DESCRIPTION,
			myTblEK_VolumeVJ.PC_Name,
			0,
			SUM(myTblEK_VolumeVJ.EK_VolumeVJ) AS EK_VolumeVJ,
			0,
			0,
			0,
			0,
			0

		FROM
		--@tblPCInv AS tblPCInv,
		(
					SELECT 
						--D17_RKEY,  
						--D23_RKEY,
						INV_PART_DESCRIPTION,
						PC_Name,
						PG_Name,
						CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ

					FROM (
						--Lieferung T , Lieferung
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							ISNULL((
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0107 AS D107 INNER JOIN
													  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert

							FROM         dbo.DATA0008 INNER JOIN
													dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
									AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
										OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


						UNION ALL

						--Retourniert
						SELECT 
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							ISNULL((
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0107 AS D107 INNER JOIN
													  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert

							FROM         dbo.DATA0007 INNER JOIN
													dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND 
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Debit/Belastung
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Bestellungen in Klärung 
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert
								
						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 5)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Konsi Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=1
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						UNION ALL 

						--rückgängig Konsi-Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=15
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Konsi-Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=1)
								AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--liegende Konsi-Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=4)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--retournierte Konsi-Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=2
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

					)  AS ResTbl
					WHERE PG_Name = @para3 
					GROUP BY
						INV_PART_DESCRIPTION,
						PC_Name,
						PG_Name	
		) AS myTblEK_VolumeVJ
		WHERE 
			--AND myTblEK_VolumeVJ.PC_Name COLLATE SQL_Latin1_General_CP1_CI_AS Not In (SELECT tblPCInv.PC_Name FROM @tblPCInv AS tblPCInv)
			--AND 
			myTblEK_VolumeVJ.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS Not In (SELECT tblPCInv.INV_PART_DESCRIPTION FROM @tblPCInv AS tblPCInv)
		GROUP BY
			myTblEK_VolumeVJ.INV_PART_DESCRIPTION,
			myTblEK_VolumeVJ.PC_Name
		----------------------------------


		--UPDATE EK VOLUMEN GANZES JAHR
		----------------------------------
		UPDATE tblPCInv
		SET tblPCInv.EK_VolumeVJ_Jahr = myTblEK_VolumeVJ_Jahr.EK_VolumeVJ_Jahr
		FROM
		@tblPCInv AS tblPCInv,
		(
					SELECT 
						--PC_Name,
						INV_PART_DESCRIPTION,
						PC_Name,
						CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ_Jahr

					FROM (
						--Lieferung T , Lieferung
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							ISNULL((
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0107 AS D107 INNER JOIN
													  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert

							FROM         dbo.DATA0008 INNER JOIN
													dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
									AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
										OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


						UNION ALL

						--Retourniert
						SELECT 
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							ISNULL((
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE/D107.EX_RATE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE/D70.EXCHANGE_RATE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0107 AS D107 INNER JOIN
													  dbo.DATA0108 ON D107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							), 0) AS RWert

							FROM         dbo.DATA0008 INNER JOIN
													dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
													dbo.DATA0005 INNER JOIN
													dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													dbo.DATA0017 INNER JOIN
													dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND 
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Debit/Belastung
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
												dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Bestellungen in Klärung 
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert
								
						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0070 INNER JOIN
												dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE      
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0070.STATUS = 5)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--Konsi Bestellungen
						SELECT 
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,						 
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=1
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (YEAR(dbo.DATA0341.TRAN_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
								--AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						UNION ALL 

						--rückgängig Konsi-Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PC_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=15
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (YEAR(dbo.DATA0341.TRAN_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
								--AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--offene Konsi-Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=1)
								AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (YEAR(dbo.DATA0467.REQ_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
								--AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--liegende Konsi-Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							0 AS RWert

						FROM         dbo.DATA0008 INNER JOIN
												dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY INNER JOIN
												dbo.DATA0467 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								(dbo.DATA0466.STATUS=4)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (YEAR(dbo.DATA0467.REQ_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
								--AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

						UNION ALL 

						--retournierte Konsi-Bestellungen
						SELECT  
							CASE 
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '') = '' THEN 
									dbo.DATA0017.INV_PART_DESCRIPTION 
								ELSE 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER 
							END AS INV_PART_DESCRIPTION,
							dbo.DATA0008.PRODUCT_NAME AS PC_Name,
							dbo.DATA0007.PRODUCT_GROUP_NAME AS PG_Name,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert

						FROM         dbo.DATA0007 INNER JOIN
												dbo.DATA0008 ON dbo.DATA0007.RKEY = dbo.DATA0008.PR_GRP_POINTER INNER JOIN
												dbo.DATA0017 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     
								--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
								--AND
								dbo.DATA0341.TRAN_TP=2
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (YEAR(dbo.DATA0341.TRAN_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
								--AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

					)  AS ResTbl
					WHERE PG_Name = @para3 
					GROUP BY
						INV_PART_DESCRIPTION,
						PC_Name
		) AS myTblEK_VolumeVJ_Jahr
		WHERE 
		--tblArtLief.D17_RKEY = myTblEK_VolumeVJ.D17_RKEY
		--AND
		--tblPCInv.D23_RKEY = myTblEK_VolumeVJ.D23_RKEY
			tblPCInv.PC_Name COLLATE SQL_Latin1_General_CP1_CI_AS = myTblEK_VolumeVJ_Jahr.PC_Name
			AND tblPCInv.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = myTblEK_VolumeVJ_Jahr.INV_PART_DESCRIPTION
		----------------------------------



		SELECT
			--PC_Name, 
			INV_PART_DESCRIPTION,
			PC_Name,
			ISNULL(EK_Volume, 0) AS EK_Volume, --EK-Vol. ZR
			ISNULL(EK_VolumeVJ, 0) AS EK_VolumeVJ, --EK-Vol. VJ ZR
			ISNULL(EK_Volume-EK_VolumeVJ, 0) AS EK_VolumeDiff, --Differenz
			CASE WHEN EK_VolumeVJ>0 THEN ISNULL((EK_Volume-EK_VolumeVJ)/EK_VolumeVJ*100, 0) ELSE 0 END AS EK_VolumeDiffProz, --in %
			ISNULL(AnzBestellungen, 0) AS AnzBestellungen, --Anz. Lieferungen
			--CASE WHEN ISNULL(letztes_LDatum, '')='' THEN '' ELSE CONVERT(varchar(10), letztes_LDatum, 104) END AS letztes_LDatum, --letze Lieferung vom
			ISNULL(EK_VolumeVJ_Jahr, 0) AS EK_VolumeVJ_Jahr, --EK-Vol. Vorjahr
			CASE WHEN ISNULL(EK_VolumeVJ_Jahr, 0)>0 THEN ISNULL(EK_Volume, 0)/ISNULL(EK_VolumeVJ_Jahr, 0)*100 ELSE 0 END AS AnteilEKVolZR_inProz, --Anteil EK Vol ZR an VJ in %
			ISNULL(NK_VJ, 0) AS NKVorjahr, --NK Vorjahr
			ISNULL(NK_ZR, 0) AS NKZR, --NK ZR
			ISNULL(NK_VJ_ZR, 0) AS NKVJZR, --NK ZR
			ISNULL(DRWert, 0) AS DRWert, --O Rechnungswert
			ISNULL(LMenge, 0) AS LMenge, --EK-Menge
			ISNULL(DLMenge, 0) AS DLMenge --O Liefermenge

			--ISNULL(EK_Volume_ArtGesamt, 0) AS EK_Volume_ArtGesamt,
			--ISNULL(EK_Volume/EK_Volume_TOTAL*100, 0) AS Proz_Anteil,
			--D17_RKEY, 
			--INV_PART_NUMBER, 
			--INV_PART_DESCRIPTION,
			--Anteil EK Vol ZR an VJ
			--UNIT_CODE,
			--ISNULL(DRPreis, 0) AS DRPreis,
			--ISNULL(Letzter_EK_Preis, 0) AS Letzter_EK_Preis,
			--letztes_LDatum,
			--CONVERT(varchar(10), letztes_LDatum, 104) AS letztes_LDatum,
			
		FROM
		(
			SELECT
			--(SELECT TOP 1 SUM(EK_Volume) FROM @tblPCInv AS myTmptblPCInv WHERE myTmptblPCInv.D23_RKEY = myTmpTblArtLiefMain.D23_RKEY) AS EK_Volume_ArtGesamt,
			(SELECT TOP 1 SUM(EK_Volume) FROM @tblPCInv AS myTmptblPCInv WHERE myTmptblPCInv.PC_Name = myTmpTblArtLiefMain.PC_Name) AS EK_Volume_ArtGesamt,
			(SELECT TOP 1 SUM(EK_Volume) FROM @tblPCInv AS myTmptblPCInv) AS EK_Volume_TOTAL,
			* 
			FROM @tblPCInv AS myTmpTblArtLiefMain --ORDER BY INV_PART_NUMBER, INV_PART_DESCRIPTION
		) AS tbl
		ORDER BY EK_Volume DESC--EK_Volume_ArtGesamt DESC, INV_PART_DESCRIPTION, EK_Volume DESC
	END

	IF @Case_ = 'ABCLieferant'
	BEGIN

		--DECLARE
		--@para1 varchar(250),
		--@para2 varchar(250)
		--SET @para1 = '01.01.2014'
		--SET @para2 = '04.01.2014'

		--DECLARE
		--@para1VJLief varchar(250),
		--@para2VJLief varchar(250),
		--@paraVJLief varchar(250)

		SET @para1VJLief = SUBSTRING(@para1, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para1, 7, 4) AS INT)-1))
		SET @para2VJLief = SUBSTRING(@para2, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para2, 7, 4) AS INT)-1))
		SET @paraVJLief = LTRIM(STR(CAST(SUBSTRING(@para2, 7, 4) AS INT)-1))

		DECLARE @tblLief table (
									--D23_RKEY NUMERIC(10, 0), 
									Lieferant char(50) null,
									EK_Volume NUMERIC(10,2) ,
									EK_VolumeVJ NUMERIC(10,2) ,
									EK_VolumeVJ_Jahr NUMERIC(10,2) ,
									LMenge NUMERIC(10,2) ,
									letztes_LDatum smalldatetime ,
									AnzBestellungen int,
									DRWert NUMERIC(10,2),
									DLMenge NUMERIC(10,2),
									NK_VJ NUMERIC(10,2),
									NK_VJ_ZR NUMERIC(10,2),
									NK_ZR NUMERIC(10,2)
									)

		INSERT @tblLief(
									--D23_RKEY, 
									Lieferant,
									EK_Volume,
									EK_VolumeVJ,
									EK_VolumeVJ_Jahr,
									LMenge,
									letztes_LDatum,
									AnzBestellungen,
									DRWert,
									DLMenge,
									NK_VJ,
									NK_VJ_ZR,
									NK_ZR
						)

		SELECT 
		--D23_RKEY,
		Lieferant,
		SUM(EK_Volume) AS EK_Volume,
		0 AS EK_VolumeVJ,
		0 AS EK_VolumeVJ_Jahr,
		SUM(LMenge) AS LMenge,
		--CONVERT(varchar(10), MAX(letztes_LDatum), 104) AS letztes_LDatum,
	(
			SELECT CONVERT(varchar(10), MAX(ResDatum), 104) AS RecMaxDatum
			FROM
			(
				SELECT   
					--CONVERT(varchar(10), dbo.DATA0095.ENTERED_DATE, 104) AS ResDatum,
					dbo.DATA0095.ENTERED_DATE AS ResDatum,
					dbo.DATA0017.RKEY AS D17ID,
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0023.CODE
					--dbo.DATA0023.RKEY AS D23ID
				FROM         
					dbo.DATA0095 INNER JOIN
					dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
					dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
					dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
					dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
					dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE    
					--(dbo.DATA0017.RKEY = D17_RKEY)
					--AND 
					(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
					--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
					AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
						OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
				UNION ALL
				SELECT
					--CONVERT(varchar(10), dbo.DATA0341.TRAN_DATE, 104) AS ResDatum,
					dbo.DATA0341.TRAN_DATE AS ResDatum,
					dbo.DATA0017.RKEY AS D17ID,
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0023.CODE
					--dbo.DATA0023.RKEY AS D23ID
				FROM        
					dbo.DATA0017 INNER JOIN
					dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
					dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
					dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
					dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
					dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
					dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     
					--(dbo.DATA0017.RKEY = D17_RKEY)
					--AND 
					(dbo.DATA0341.TRAN_TP=1)
					--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
					AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))
			) AS myTblMaxDatum
			WHERE --D17ID = D17_RKEY 
					--AND D23ID = D23_RKEY 
					SUPPLIER_NAME = Lieferant
		) AS letztes_LDatum,
		SUM(AnzBestellungen) AS AnzBestellungen,
		AVG(DRWert) AS DRWert,
		AVG(DLMenge) AS DLMenge,
		/*
		(
			SELECT  TOP 1   SUM(dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) AS NK
			FROM         dbo.DATA0108 INNER JOIN
				  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY INNER JOIN
				  dbo.DATA0095 INNER JOIN
				  dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
				  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
				  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
				  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
				  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
			WHERE dbo.DATA0023.SUPPLIER_NAME = Lieferant
					AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@paraVJLief AS INT))
		) AS NK_VJ
		*/
		ISNULL((
			SELECT  TOP 1   SUM(dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) AS NK
			FROM         dbo.DATA0107 INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
                      dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
                      dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
                      dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY
			WHERE dbo.DATA0023.SUPPLIER_NAME = Lieferant
					AND (YEAR(dbo.DATA0107.INV_DATE) = CAST(@paraVJLief AS INT))
		), 0) AS NK_VJ,
		ISNULL((
			SELECT  TOP 1   SUM(dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) AS NK
			FROM         dbo.DATA0107 INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
                      dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
                      dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
                      dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY
			WHERE dbo.DATA0023.SUPPLIER_NAME = Lieferant
					AND (dbo.DATA0107.INV_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
					AND (dbo.DATA0107.INV_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
		), 0) AS NK_VJ_ZR,
		ISNULL((
			SELECT  TOP 1   SUM(dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) AS NK
			FROM         dbo.DATA0107 INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
                      dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
                      dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
                      dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY
			WHERE dbo.DATA0023.SUPPLIER_NAME = Lieferant
					AND (dbo.DATA0107.INV_DATE >= CONVERT(DATETIME, @para1, 103))
					AND (dbo.DATA0107.INV_DATE <= CONVERT(DATETIME, @para2, 103))
		), 0) AS NK_ZR

		FROM
		(
					SELECT 
						--D23_RKEY, 
						Lieferant,
						CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_Volume,
						CAST(SUM(LMenge) AS NUMERIC(10, 2)) AS LMenge,
						--MAX(LDatum) AS letztes_LDatum,
						(
							SELECT CONVERT(varchar(10), MAX(ResDatum), 104) AS RecMaxDatum
							FROM
							(
								SELECT   
									--CONVERT(varchar(10), dbo.DATA0095.ENTERED_DATE, 104) AS ResDatum,
									dbo.DATA0095.ENTERED_DATE AS ResDatum,
									dbo.DATA0017.RKEY AS D17ID,
									dbo.DATA0023.SUPPLIER_NAME
								FROM         
									dbo.DATA0095 INNER JOIN
									dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
									--(dbo.DATA0017.RKEY = D17_RKEY)
									--AND 
									(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
									AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
										OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
								UNION ALL
								SELECT
									--CONVERT(varchar(10), dbo.DATA0341.TRAN_DATE, 104) AS ResDatum,
									dbo.DATA0341.TRAN_DATE AS ResDatum,
									dbo.DATA0017.RKEY AS D17ID,
									dbo.DATA0023.SUPPLIER_NAME
								FROM        
									dbo.DATA0017 INNER JOIN
									dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
								WHERE     
									--(dbo.DATA0017.RKEY = D17_RKEY)
									--AND 
									(dbo.DATA0341.TRAN_TP=1)
									--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))
							) AS myTblMaxDatum
							WHERE SUPPLIER_NAME = Lieferant --AND D17ID = D17_RKEY 
						) AS letztes_LDatum,
						SUM(AnzBestellungen) AS AnzBestellungen,
						CAST(AVG(RWert) AS NUMERIC(10, 2)) AS DRWert,
						CAST(AVG(LMenge) AS NUMERIC(10, 2)) AS DLMenge

					FROM (
						--Lieferung T , Lieferung
						SELECT  
							'GGP' As BTyp,		
							dbo.DATA0095.RKEY AS D95_PTR, 
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION,
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert,
							dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							dbo.DATA0095.ENTERED_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

							FROM         dbo.DATA0005 INNER JOIN
												  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
												  dbo.DATA0017 INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
												  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
							WHERE    
									(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))
									AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
										OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))

						UNION ALL

						--Retourniert
						SELECT 
							'GGP' As BTyp, 
							dbo.DATA0095.RKEY AS D95_PTR, 
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert,
							dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							dbo.DATA0095.ENTERED_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

							FROM         dbo.DATA0005 INNER JOIN
												  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
												  dbo.DATA0017 INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
												  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
									--AND 
									(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--offene Bestellungen
						SELECT  
							'GGP' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD AS LMenge,
							0 AS RWert,
							(
								SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
													  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0070 INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
						WHERE   
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--Debit/Belastung
						SELECT  
							'GGP' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD AS LMenge,
							(-1)*dbo.DATA0132.AMOUNT AS RWert,
							dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0132 INNER JOIN
							  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
							  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
							  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
							  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
							  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
							  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
							  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
						WHERE      
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--Bestellungen in Klärung 
						SELECT  
							'GGP' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD AS LMenge,
							0 AS RWert,
							(
								SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
													  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)	
							) AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0070 INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
						WHERE      
									(dbo.DATA0070.STATUS = 5)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--Konsi Bestellungen
						SELECT  
							'Konsi' As BTyp,
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0341.TRAN_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
						WHERE     
								dbo.DATA0341.TRAN_TP=1
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))


						UNION ALL 

						--rückgängig Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION,
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0341.TRAN_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
						WHERE    
								dbo.DATA0341.TRAN_TP=15
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--offene Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0467.QUAN_RECD AS LMenge,
							0 AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0467 INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
						WHERE     
								(dbo.DATA0466.STATUS=1)
								AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--liegende Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0467.QUAN_RECD AS LMenge,
							0 AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0467 INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
						WHERE     
								(dbo.DATA0466.STATUS=4)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--retournierte Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
						WHERE     
								dbo.DATA0341.TRAN_TP=2
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))


					)  AS ResTbl
					GROUP BY
						--D23_RKEY,
						Lieferant
						--UNIT_CODE,
						--QUAN_ON_HAND,
						--CONSIGN_ONHAND_QTY,
						--LetzterLieferant,
						--AnzLieferanten

		) AS tblMain
		GROUP BY Lieferant --D23_RKEY, Lieferant
		--ORDER BY SUM(EK_Volume) DESC 


			--UPDATE
			----------------------------------
			UPDATE tblLief
			SET tblLief.EK_VolumeVJ = myTblEK_VolumeVJ.EK_VolumeVJ
			FROM
			@tblLief AS tblLief,
			(
						SELECT 
							--D17_RKEY,  
							--D23_RKEY,
							Lieferant,
							CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ

						FROM (
							--Lieferung T , Lieferung
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
										AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
											OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


							UNION ALL

							--Retourniert
							SELECT 
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--offene Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE     
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND 
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--Debit/Belastung
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								(-1)*dbo.DATA0132.AMOUNT AS RWert

							FROM         dbo.DATA0132 INNER JOIN
								  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE      
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--Bestellungen in Klärung 
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								0 AS RWert
								
							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE      
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0070.STATUS = 5)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--Konsi Bestellungen
							SELECT  

								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=1
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

							UNION ALL 

							--rückgängig Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=15
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--offene Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0466.STATUS=1)
									AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--liegende Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0466.STATUS=4)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--retournierte Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=2
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						)  AS ResTbl
						GROUP BY
							--D17_RKEY, 
							--D23_RKEY
							Lieferant
			) AS myTblEK_VolumeVJ
			WHERE 
			--tblArtLief.D17_RKEY = myTblEK_VolumeVJ.D17_RKEY
			--AND
			--tblLief.D23_RKEY = myTblEK_VolumeVJ.D23_RKEY
			tblLief.Lieferant COLLATE SQL_Latin1_General_CP1_CI_AS = myTblEK_VolumeVJ.Lieferant
			----------------------------------

			--INSERT
			----------------------------------
			INSERT @tblLief(
										--D23_RKEY, 
										Lieferant,
										EK_Volume,
										EK_VolumeVJ,
										EK_VolumeVJ_Jahr,
										LMenge,
										letztes_LDatum,
										AnzBestellungen,
										DRWert,
										DLMenge
							)

			SELECT
				--myTblEK_VolumeVJ.D23_RKEY,
				myTblEK_VolumeVJ.Lieferant,
				0,
				myTblEK_VolumeVJ.EK_VolumeVJ,
				0,
				0,
				null,
				0,
				0,
				0

			FROM
			--@tblLief AS tblLief,
			(
						SELECT 
							--D17_RKEY,  
							--D23_RKEY,
							Lieferant,
							CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ

						FROM (
							--Lieferung T , Lieferung
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant, 
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
										AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
											OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


							UNION ALL

							--Retourniert
							SELECT 
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant, 
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--offene Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE     
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND 
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--Debit/Belastung
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								(-1)*dbo.DATA0132.AMOUNT AS RWert

							FROM         dbo.DATA0132 INNER JOIN
								  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE      
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--Bestellungen in Klärung 
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert
								
							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE      
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0070.STATUS = 5)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--Konsi Bestellungen
							SELECT  

								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=1
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

							UNION ALL 

							--rückgängig Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=15
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--offene Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0466.STATUS=1)
									AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--liegende Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0466.STATUS=4)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--retournierte Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=2
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLief, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						)  AS ResTbl
						GROUP BY
							--D17_RKEY, 
							--D23_RKEY,
							Lieferant		
			) AS myTblEK_VolumeVJ
			WHERE 
			--tblArtLief.D17_RKEY = myTblEK_VolumeVJ.D17_RKEY
			--AND
			--tblLief.D23_RKEY = myTblEK_VolumeVJ.D23_RKEY
			--myTblEK_VolumeVJ.D23_RKEY Not In (SELECT tblLief.D23_RKEY FROM @tblLief AS tblLief)
			myTblEK_VolumeVJ.Lieferant COLLATE SQL_Latin1_General_CP1_CI_AS Not In (SELECT tblLief.Lieferant FROM @tblLief AS tblLief)
			----------------------------------


			--UPDATE EK VOLUMEN GANZES JAHR
			----------------------------------
			UPDATE tblLief
			SET tblLief.EK_VolumeVJ_Jahr = myTblEK_VolumeVJ_Jahr.EK_VolumeVJ_Jahr
			FROM
			@tblLief AS tblLief,
			(
						SELECT 
							--D17_RKEY,  
							--D23_RKEY,
							Lieferant,
							CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ_Jahr

						FROM (
							--Lieferung T , Lieferung
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
										--AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
										AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
											OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


							UNION ALL

							--Retourniert
							SELECT 
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
										--AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--offene Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE     
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND 
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
										--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--Debit/Belastung
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								(-1)*dbo.DATA0132.AMOUNT AS RWert

							FROM         dbo.DATA0132 INNER JOIN
								  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE      
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
										--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--Bestellungen in Klärung 
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								0 AS RWert
								
							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE      
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0070.STATUS = 5)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
										--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--Konsi Bestellungen
							SELECT  

								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=1
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0341.TRAN_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

							UNION ALL 

							--rückgängig Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=15
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0341.TRAN_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--offene Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0466.STATUS=1)
									AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0467.REQ_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--liegende Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0466.STATUS=4)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0467.REQ_DATE) = CAST(@paraVJLief AS INT)) -->= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLief, 103))

							UNION ALL 

							--retournierte Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=2
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0341.TRAN_DATE) = CAST(@paraVJLief AS INT)) -- >= CONVERT(DATETIME, @para1VJLief, 103))
									--AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLief, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						)  AS ResTbl
						GROUP BY
							--D17_RKEY, 
							--D23_RKEY
							Lieferant
			) AS myTblEK_VolumeVJ_Jahr
			WHERE 
			--tblArtLief.D17_RKEY = myTblEK_VolumeVJ.D17_RKEY
			--AND
			--tblLief.D23_RKEY = myTblEK_VolumeVJ.D23_RKEY
			tblLief.Lieferant COLLATE SQL_Latin1_General_CP1_CI_AS = myTblEK_VolumeVJ_Jahr.Lieferant
			----------------------------------



			SELECT

			Lieferant, --Lieferant
			ISNULL(EK_Volume, 0) AS EK_Volume, --EK-Vol. ZR
			ISNULL(EK_VolumeVJ, 0) AS EK_VolumeVJ, --EK-Vol. VJ ZR
			ISNULL(EK_Volume-EK_VolumeVJ, 0) AS EK_VolumeDiff, --Differenz
			CASE WHEN EK_VolumeVJ>0 THEN ISNULL((EK_Volume-EK_VolumeVJ)/EK_VolumeVJ*100, 0) ELSE 0 END AS EK_VolumeDiffProz, --in %
			ISNULL(AnzBestellungen, 0) AS AnzBestellungen, --Anz. Lieferungen
			CASE WHEN ISNULL(letztes_LDatum, '')='' THEN '' ELSE CONVERT(varchar(10), letztes_LDatum, 104) END AS letztes_LDatum, --letze Lieferung vom
			ISNULL(EK_VolumeVJ_Jahr, 0) AS EK_VolumeVJ_Jahr, --EK-Vol. Vorjahr
			CASE WHEN ISNULL(EK_VolumeVJ_Jahr, 0)>0 THEN ISNULL(EK_Volume, 0)/ISNULL(EK_VolumeVJ_Jahr, 0)*100 ELSE 0 END AS AnteilEKVolZR_inProz, --Anteil EK Vol ZR an VJ in %
			ISNULL(NK_VJ, 0) AS NKVorjahr, --NK Vorjahr
			ISNULL(NK_ZR, 0) AS NKZR, --NK ZR
			ISNULL(NK_VJ_ZR, 0) AS NKVJZR, --NK ZR
			ISNULL(DRWert, 0) AS DRWert, --O Rechnungswert
			ISNULL(LMenge, 0) AS LMenge, --EK-Menge
			ISNULL(DLMenge, 0) AS DLMenge --O Liefermenge

			--ISNULL(EK_Volume_ArtGesamt, 0) AS EK_Volume_ArtGesamt,
			--ISNULL(EK_Volume/EK_Volume_TOTAL*100, 0) AS Proz_Anteil,
			--D17_RKEY, 
			--INV_PART_NUMBER, 
			--INV_PART_DESCRIPTION,
			--Anteil EK Vol ZR an VJ
			--UNIT_CODE,
			--ISNULL(DRPreis, 0) AS DRPreis,
			--ISNULL(Letzter_EK_Preis, 0) AS Letzter_EK_Preis,
			--letztes_LDatum,
			--CONVERT(varchar(10), letztes_LDatum, 104) AS letztes_LDatum,
			
			FROM
			(
				SELECT
				--(SELECT TOP 1 SUM(EK_Volume) FROM @tblLief AS myTmpTblLief WHERE myTmpTblLief.D23_RKEY = myTmpTblArtLiefMain.D23_RKEY) AS EK_Volume_ArtGesamt,
				(SELECT TOP 1 SUM(EK_Volume) FROM @tblLief AS myTmpTblLief WHERE myTmpTblLief.Lieferant = myTmpTblArtLiefMain.Lieferant) AS EK_Volume_ArtGesamt,
				(SELECT TOP 1 SUM(EK_Volume) FROM @tblLief AS myTmpTblLief) AS EK_Volume_TOTAL,
				* 
				FROM @tblLief AS myTmpTblArtLiefMain --ORDER BY INV_PART_NUMBER, INV_PART_DESCRIPTION
			) AS tbl
			ORDER BY EK_Volume DESC--EK_Volume_ArtGesamt DESC, INV_PART_DESCRIPTION, EK_Volume DESC
	END

	IF @Case_ = 'ABCLieferantMonate'
	BEGIN

		--DECLARE
		--@para1 varchar(250),
		--@para2 varchar(250)
		--SET @para1 = '01.01.2014'
		--SET @para2 = '04.01.2014'

		--DECLARE
		--@para1VJLief varchar(250),
		--@para2VJLief varchar(250),
		--@paraVJLief varchar(250)


		INSERT @tblLief(
									--D23_RKEY, 
									Lieferant,
									EK_Volume,
									EK_VolumeVJ,
									EK_VolumeVJ_Jahr,
									LMenge,
									letztes_LDatum,
									AnzBestellungen,
									DRWert,
									DLMenge,
									NK_ZR
						)

		SELECT 
		--D23_RKEY,
		Lieferant,
		SUM(EK_Volume) AS EK_Volume,
		0 AS EK_VolumeVJ,
		0 AS EK_VolumeVJ_Jahr,
		SUM(LMenge) AS LMenge,
		--CONVERT(varchar(10), MAX(letztes_LDatum), 104) AS letztes_LDatum,
	(
			SELECT CONVERT(varchar(10), MAX(ResDatum), 104) AS RecMaxDatum
			FROM
			(
				SELECT   
					--CONVERT(varchar(10), dbo.DATA0095.ENTERED_DATE, 104) AS ResDatum,
					dbo.DATA0095.ENTERED_DATE AS ResDatum,
					dbo.DATA0017.RKEY AS D17ID,
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0023.CODE
					--dbo.DATA0023.RKEY AS D23ID
				FROM         
					dbo.DATA0095 INNER JOIN
					dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
					dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
					dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
					dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
					dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE    
					--(dbo.DATA0017.RKEY = D17_RKEY)
					--AND 
					(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
					--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
					AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
						OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
				UNION ALL
				SELECT
					--CONVERT(varchar(10), dbo.DATA0341.TRAN_DATE, 104) AS ResDatum,
					dbo.DATA0341.TRAN_DATE AS ResDatum,
					dbo.DATA0017.RKEY AS D17ID,
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0023.CODE
					--dbo.DATA0023.RKEY AS D23ID
				FROM        
					dbo.DATA0017 INNER JOIN
					dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
					dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
					dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
					dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
					dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
					dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     
					--(dbo.DATA0017.RKEY = D17_RKEY)
					--AND 
					(dbo.DATA0341.TRAN_TP=1)
					--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
					AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))
			) AS myTblMaxDatum
			WHERE --D17ID = D17_RKEY 
					--AND D23ID = D23_RKEY 
					SUPPLIER_NAME = Lieferant
		) AS letztes_LDatum,
		SUM(AnzBestellungen) AS AnzBestellungen,
		AVG(DRWert) AS DRWert,
		AVG(DLMenge) AS DLMenge,
		ISNULL((
			SELECT  TOP 1   SUM((dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) / dbo.DATA0107.EX_RATE) AS NK
			FROM         dbo.DATA0107 INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
                      dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
                      dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
                      dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY
			WHERE dbo.DATA0023.SUPPLIER_NAME = Lieferant
					AND (dbo.DATA0107.INV_DATE >= CONVERT(DATETIME, @para1, 103))
					AND (dbo.DATA0107.INV_DATE <= CONVERT(DATETIME, @para2, 103))
		), 0) AS NK_ZR

		FROM
		(
					SELECT 
						--D23_RKEY, 
						Lieferant,
						CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_Volume,
						CAST(SUM(LMenge) AS NUMERIC(10, 2)) AS LMenge,
						--MAX(LDatum) AS letztes_LDatum,
						(
							SELECT CONVERT(varchar(10), MAX(ResDatum), 104) AS RecMaxDatum
							FROM
							(
								SELECT   
									--CONVERT(varchar(10), dbo.DATA0095.ENTERED_DATE, 104) AS ResDatum,
									dbo.DATA0095.ENTERED_DATE AS ResDatum,
									dbo.DATA0017.RKEY AS D17ID,
									dbo.DATA0023.SUPPLIER_NAME
								FROM         
									dbo.DATA0095 INNER JOIN
									dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
									--(dbo.DATA0017.RKEY = D17_RKEY)
									--AND 
									(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
									AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
										OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
								UNION ALL
								SELECT
									--CONVERT(varchar(10), dbo.DATA0341.TRAN_DATE, 104) AS ResDatum,
									dbo.DATA0341.TRAN_DATE AS ResDatum,
									dbo.DATA0017.RKEY AS D17ID,
									dbo.DATA0023.SUPPLIER_NAME
								FROM        
									dbo.DATA0017 INNER JOIN
									dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
								WHERE     
									--(dbo.DATA0017.RKEY = D17_RKEY)
									--AND 
									(dbo.DATA0341.TRAN_TP=1)
									--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))
							) AS myTblMaxDatum
							WHERE SUPPLIER_NAME = Lieferant --AND D17ID = D17_RKEY 
						) AS letztes_LDatum,
						SUM(AnzBestellungen) AS AnzBestellungen,
						CAST(AVG(RWert) AS NUMERIC(10, 2)) AS DRWert,
						CAST(AVG(LMenge) AS NUMERIC(10, 2)) AS DLMenge

					FROM (
						--Lieferung T , Lieferung
						SELECT  
							'GGP' As BTyp,		
							dbo.DATA0095.RKEY AS D95_PTR, 
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION,
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							(
								SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE / dbo.DATA0107.EX_RATE
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE / D70.EXCHANGE_RATE
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis
								FROM         dbo.DATA0107 INNER JOIN
													  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert,
							dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							dbo.DATA0095.ENTERED_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

							FROM         dbo.DATA0005 INNER JOIN
												  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
												  dbo.DATA0017 INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
												  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
							WHERE    
									(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))
									AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
										OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))

						UNION ALL

						--Retourniert
						SELECT 
							'GGP' As BTyp, 
							dbo.DATA0095.RKEY AS D95_PTR, 
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							(
								SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE / dbo.DATA0107.EX_RATE
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE / D70.EXCHANGE_RATE
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis
								FROM         dbo.DATA0107 INNER JOIN
													  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													  dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR ON dbo.DATA0108.DATA0071_PTR = D71.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert,
							dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							dbo.DATA0095.ENTERED_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

							FROM         dbo.DATA0005 INNER JOIN
												  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
												  dbo.DATA0017 INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
												  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
									--AND 
									(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--offene Bestellungen
						SELECT  
							'GGP' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD/dbo.DATA0017.STOCK_PURCH AS LMenge,
							0 AS RWert,
							(
								SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
													  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0070 INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
						WHERE   
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--Debit/Belastung
						SELECT  
							'GGP' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD/dbo.DATA0017.STOCK_PURCH AS LMenge,
							(-1)*dbo.DATA0132.AMOUNT/dbo.DATA0132.EX_RATE AS RWert,
							(dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT)/dbo.DATA0132.EX_RATE AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0132 INNER JOIN
							  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
							  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
							  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
							  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
							  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
							  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
							  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
						WHERE      
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--Bestellungen in Klärung 
						SELECT  
							'GGP' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD/dbo.DATA0017.STOCK_PURCH AS LMenge,
							0 AS RWert,
							(
								SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
													  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)	
							) AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0070 INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
						WHERE      
									(dbo.DATA0070.STATUS = 5)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--Konsi Bestellungen
						SELECT  
							'Konsi' As BTyp,
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0341.TRAN_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
						WHERE     
								dbo.DATA0341.TRAN_TP=1
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))


						UNION ALL 

						--rückgängig Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION,
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0341.TRAN_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
						WHERE    
								dbo.DATA0341.TRAN_TP=15
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--offene Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0467.QUAN_RECD/dbo.DATA0017.STOCK_PURCH AS LMenge,
							0 AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0467 INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
						WHERE     
								(dbo.DATA0466.STATUS=1)
								AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--liegende Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0467.QUAN_RECD/dbo.DATA0017.STOCK_PURCH AS LMenge,
							0 AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0467 INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
						WHERE     
								(dbo.DATA0466.STATUS=4)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--retournierte Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
						WHERE     
								dbo.DATA0341.TRAN_TP=2
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))


					)  AS ResTbl
					GROUP BY
						--D23_RKEY,
						Lieferant
						--UNIT_CODE,
						--QUAN_ON_HAND,
						--CONSIGN_ONHAND_QTY,
						--LetzterLieferant,
						--AnzLieferanten

		) AS tblMain
		GROUP BY Lieferant --D23_RKEY, Lieferant
		--ORDER BY SUM(EK_Volume) DESC 



		SELECT
			Lieferant, --Lieferant
			--ISNULL(EK_Volume, 0) AS EK_Volume, --EK-Vol. ZR
			ISNULL(EK_Volume, 0)+ISNULL(NK_ZR, 0) AS EK_Volume, --EK-Vol. ZR

			ISNULL(EK_VolumeVJ, 0) AS EK_VolumeVJ, --EK-Vol. VJ ZR
			ISNULL(EK_Volume-EK_VolumeVJ, 0) AS EK_VolumeDiff, --Differenz
			CASE WHEN EK_VolumeVJ>0 THEN ISNULL((EK_Volume-EK_VolumeVJ)/EK_VolumeVJ*100, 0) ELSE 0 END AS EK_VolumeDiffProz, --in %
			ISNULL(AnzBestellungen, 0) AS AnzBestellungen, --Anz. Lieferungen
			CASE WHEN ISNULL(letztes_LDatum, '')='' THEN '' ELSE CONVERT(varchar(10), letztes_LDatum, 104) END AS letztes_LDatum, --letze Lieferung vom
			ISNULL(EK_VolumeVJ_Jahr, 0) AS EK_VolumeVJ_Jahr, --EK-Vol. Vorjahr
			CASE WHEN ISNULL(EK_VolumeVJ_Jahr, 0)>0 THEN ISNULL(EK_Volume, 0)/ISNULL(EK_VolumeVJ_Jahr, 0)*100 ELSE 0 END AS AnteilEKVolZR_inProz, --Anteil EK Vol ZR an VJ in %
			ISNULL(NK_VJ, 0) AS NKVorjahr, --NK Vorjahr
			ISNULL(NK_ZR, 0) AS NKZR, --NK ZR
			ISNULL(NK_VJ_ZR, 0) AS NKVJZR, --NK ZR
			ISNULL(DRWert, 0) AS DRWert, --O Rechnungswert
			ISNULL(LMenge, 0) AS LMenge, --EK-Menge
			ISNULL(DLMenge, 0) AS DLMenge --O Liefermenge
			
		FROM
		(
			SELECT
			--(SELECT TOP 1 SUM(EK_Volume) FROM @tblLief AS myTmpTblLief WHERE myTmpTblLief.D23_RKEY = myTmpTblArtLiefMain.D23_RKEY) AS EK_Volume_ArtGesamt,
			(SELECT TOP 1 SUM(EK_Volume) FROM @tblLief AS myTmpTblLief WHERE myTmpTblLief.Lieferant = myTmpTblArtLiefMain.Lieferant) AS EK_Volume_ArtGesamt,
			(SELECT TOP 1 SUM(EK_Volume) FROM @tblLief AS myTmpTblLief) AS EK_Volume_TOTAL,
			* 
			FROM @tblLief AS myTmpTblArtLiefMain --ORDER BY INV_PART_NUMBER, INV_PART_DESCRIPTION
		) AS tbl
		ORDER BY EK_Volume DESC--EK_Volume_ArtGesamt DESC, INV_PART_DESCRIPTION, EK_Volume DESC
	END

	IF @Case_ = 'ABCLieferantHersteller'
	BEGIN

		--DECLARE
		--@para1 varchar(250),
		--@para2 varchar(250)
		--SET @para1 = '01.01.2014'
		--SET @para2 = '07.01.2014'

		DECLARE
		@para1VJLiefHerst varchar(250),
		@para2VJLiefHerst varchar(250),
		@paraVJLiefHerst varchar(250)

		SET @para1VJLiefHerst = SUBSTRING(@para1, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para1, 7, 4) AS INT)-1))
		SET @para2VJLiefHerst = SUBSTRING(@para2, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para2, 7, 4) AS INT)-1))
		SET @paraVJLiefHerst = LTRIM(STR(CAST(SUBSTRING(@para2, 7, 4) AS INT)-1))

		DECLARE @tblLiefHerst table (
									D23_RKEY NUMERIC(10, 0), 
									Lieferant char(50) null,
									EK_Volume NUMERIC(10,2) ,
									EK_VolumeVJ NUMERIC(10,2) ,
									EK_VolumeVJ_Jahr NUMERIC(10,2) ,
									LMenge NUMERIC(10,2) ,
									letztes_LDatum smalldatetime ,
									AnzBestellungen int,
									DRWert NUMERIC(10,2),
									DLMenge NUMERIC(10,2),
									NK_VJ NUMERIC(10,2),
									NK_VJ_ZR NUMERIC(10,2),
									NK_ZR NUMERIC(10,2)
									)

		INSERT @tblLiefHerst(
									D23_RKEY, 
									Lieferant,
									EK_Volume,
									EK_VolumeVJ,
									EK_VolumeVJ_Jahr,
									LMenge,
									letztes_LDatum,
									AnzBestellungen,
									DRWert,
									DLMenge,
									NK_VJ,
									NK_VJ_ZR,
									NK_ZR
						)

		SELECT 
		D23_RKEY,
		Lieferant,
		SUM(EK_Volume) AS EK_Volume,
		0 AS EK_VolumeVJ,
		0 AS EK_VolumeVJ_Jahr,
		SUM(LMenge) AS LMenge,
		--CONVERT(varchar(10), MAX(letztes_LDatum), 104) AS letztes_LDatum,
		(
			SELECT CONVERT(varchar(10), MAX(ResDatum), 104) AS RecMaxDatum
			FROM
			(
				SELECT   
					--CONVERT(varchar(10), dbo.DATA0095.ENTERED_DATE, 104) AS ResDatum,
					dbo.DATA0095.ENTERED_DATE AS ResDatum,
					dbo.DATA0017.RKEY AS D17ID,
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0023.CODE
					--dbo.DATA0023.RKEY AS D23ID
				FROM         
					dbo.DATA0095 INNER JOIN
					dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
					dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
					dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
					dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
					dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE    
					--(dbo.DATA0017.RKEY = D17_RKEY)
					--AND 
					(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
					--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
					AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
						OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
				UNION ALL
				SELECT
					--CONVERT(varchar(10), dbo.DATA0341.TRAN_DATE, 104) AS ResDatum,
					dbo.DATA0341.TRAN_DATE AS ResDatum,
					dbo.DATA0017.RKEY AS D17ID,
					dbo.DATA0023.SUPPLIER_NAME,
					dbo.DATA0023.CODE
					--dbo.DATA0023.RKEY AS D23ID
				FROM        
					dbo.DATA0017 INNER JOIN
					dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
					dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
					dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
					dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
					dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
					dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     
					--(dbo.DATA0017.RKEY = D17_RKEY)
					--AND 
					(dbo.DATA0341.TRAN_TP=1)
					--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
					AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))
			) AS myTblMaxDatum
			WHERE --D17ID = D17_RKEY 
					--AND D23ID = D23_RKEY 
					RTRIM(SUPPLIER_NAME) + ' (' + CODE + ')' = Lieferant
		) AS letztes_LDatum,
		SUM(AnzBestellungen) AS AnzBestellungen,
		AVG(DRWert) AS DRWert,
		AVG(DLMenge) AS DLMenge,
		ISNULL((
			SELECT  TOP 1   SUM(dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) AS NK
			FROM         dbo.DATA0107 INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
                      dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
                      dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
                      dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY
			WHERE dbo.DATA0023.RKEY = D23_RKEY
					AND (YEAR(dbo.DATA0107.INV_DATE) = CAST(@paraVJLiefHerst AS INT))
		), 0) AS NK_VJ,
		ISNULL((
			SELECT  TOP 1   SUM(dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) AS NK
			FROM         dbo.DATA0107 INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
                      dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
                      dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
                      dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY
			WHERE dbo.DATA0023.RKEY = D23_RKEY
					AND (dbo.DATA0107.INV_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
					AND (dbo.DATA0107.INV_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))
		), 0) AS NK_VJ_ZR,
		ISNULL((
			SELECT  TOP 1   SUM(dbo.DATA0107.SHIPPING + dbo.DATA0107.MISC_TOT) AS NK
			FROM         dbo.DATA0107 INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
                      dbo.DATA0023 ON dbo.DATA0107.SUPP_PTR = dbo.DATA0023.RKEY INNER JOIN
                      dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
                      dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY
			WHERE dbo.DATA0023.SUPPLIER_NAME = Lieferant
					AND (dbo.DATA0107.INV_DATE >= CONVERT(DATETIME, @para1, 103))
					AND (dbo.DATA0107.INV_DATE <= CONVERT(DATETIME, @para2, 103))
		), 0) AS NK_ZR

		FROM
		(
					SELECT 
						D23_RKEY, 
						Lieferant,
						CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_Volume,
						CAST(SUM(LMenge) AS NUMERIC(10, 2)) AS LMenge,
						--MAX(LDatum) AS letztes_LDatum,
						(
							SELECT CONVERT(varchar(10), MAX(ResDatum), 104) AS RecMaxDatum
							FROM
							(
								SELECT   
									--CONVERT(varchar(10), dbo.DATA0095.ENTERED_DATE, 104) AS ResDatum,
									dbo.DATA0095.ENTERED_DATE AS ResDatum,
									dbo.DATA0017.RKEY AS D17ID,
									dbo.DATA0023.SUPPLIER_NAME
								FROM         
									dbo.DATA0095 INNER JOIN
									dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
									--(dbo.DATA0017.RKEY = D17_RKEY)
									--AND 
									(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
									AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
										OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
								UNION ALL
								SELECT
									--CONVERT(varchar(10), dbo.DATA0341.TRAN_DATE, 104) AS ResDatum,
									dbo.DATA0341.TRAN_DATE AS ResDatum,
									dbo.DATA0017.RKEY AS D17ID,
									dbo.DATA0023.SUPPLIER_NAME
								FROM        
									dbo.DATA0017 INNER JOIN
									dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
								WHERE     
									--(dbo.DATA0017.RKEY = D17_RKEY)
									--AND 
									(dbo.DATA0341.TRAN_TP=1)
									--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))
							) AS myTblMaxDatum
							WHERE SUPPLIER_NAME = Lieferant --AND D17ID = D17_RKEY 
						) AS letztes_LDatum,
						SUM(AnzBestellungen) AS AnzBestellungen,
						CAST(AVG(RWert) AS NUMERIC(10, 2)) AS DRWert,
						CAST(AVG(LMenge) AS NUMERIC(10, 2)) AS DLMenge

					FROM (
						--Lieferung T , Lieferung
						SELECT  
							'GGP' As BTyp,		
							dbo.DATA0095.RKEY AS D95_PTR, 
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION,
							RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert,
							dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							dbo.DATA0095.ENTERED_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

							FROM         dbo.DATA0005 INNER JOIN
												  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
												  dbo.DATA0017 INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
												  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
							WHERE    
									(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))
									AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
										OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))

						UNION ALL

						--Retourniert
						SELECT 
							'GGP' As BTyp, 
							dbo.DATA0095.RKEY AS D95_PTR, 
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis

								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS RWert,
							dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
							dbo.DATA0095.ENTERED_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

							FROM         dbo.DATA0005 INNER JOIN
												  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
												  dbo.DATA0017 INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
												  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
							WHERE    
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para2 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)  
									--AND 
									(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--offene Bestellungen
						SELECT  
							'GGP' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD AS LMenge,
							0 AS RWert,
							(
								SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
													  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0070 INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
						WHERE   
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--Debit/Belastung
						SELECT  
							'GGP' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD AS LMenge,
							(-1)*dbo.DATA0132.AMOUNT AS RWert,
							dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0132 INNER JOIN
							  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
							  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
							  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
							  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
							  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
							  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
							  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
						WHERE      
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--Bestellungen in Klärung 
						SELECT  
							'GGP' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0071.QUAN_RECD AS LMenge,
							0 AS RWert,
							(
								SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
													  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)	
							) AS NK,
							dbo.DATA0071.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0070 INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
						WHERE      
									(dbo.DATA0070.STATUS = 5)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
									AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--Konsi Bestellungen
						SELECT  
							'Konsi' As BTyp,
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0341.TRAN_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
						WHERE     
								dbo.DATA0341.TRAN_TP=1
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))


						UNION ALL 

						--rückgängig Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION,
							RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0341.TRAN_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
						WHERE    
								dbo.DATA0341.TRAN_TP=15
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))

						UNION ALL 

						--offene Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0467.QUAN_RECD AS LMenge,
							0 AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0467 INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
						WHERE     
								(dbo.DATA0466.STATUS=1)
								AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--liegende Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							0 AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							dbo.DATA0467.QUAN_RECD AS LMenge,
							0 AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							1 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0467 INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
						WHERE     
								(dbo.DATA0466.STATUS=4)
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


						UNION ALL 

						--retournierte Konsi-Bestellungen
						SELECT  
							'Konsi' As BTyp,
							dbo.DATA0341.RKEY AS D95_PTR,
							dbo.DATA0023.RKEY AS D23_RKEY,
							dbo.DATA0017.INV_PART_NUMBER, 
							dbo.DATA0017.INV_PART_DESCRIPTION, 
							RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
							--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
							dbo.DATA0002.UNIT_CODE,
							dbo.DATA0017.QUAN_ON_HAND,
							dbo.DATA0017.CONSIGN_ONHAND_QTY, 
							(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
									ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
							END AS RWert, 
							0 AS NK,
							dbo.DATA0467.REQ_DATE AS LDatum,
							0 AS AnzBestellungen,
							'' AS LetzterLieferant,
							0 As AnzLieferanten

						FROM         dbo.DATA0017 INNER JOIN
											  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
											  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
											  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
						WHERE     
								dbo.DATA0341.TRAN_TP=2
								--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
								AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
								AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
								AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))


					)  AS ResTbl
					GROUP BY
						D23_RKEY,
						Lieferant
						--UNIT_CODE,
						--QUAN_ON_HAND,
						--CONSIGN_ONHAND_QTY,
						--LetzterLieferant,
						--AnzLieferanten

		) AS tblMain
		GROUP BY D23_RKEY, Lieferant
		--ORDER BY SUM(EK_Volume) DESC 


			--UPDATE
			----------------------------------
			UPDATE tblLiefHerst
			SET tblLiefHerst.EK_VolumeVJ = myTblEK_VolumeVJ.EK_VolumeVJ
			FROM
			@tblLiefHerst AS tblLiefHerst,
			(
						SELECT 
							--D17_RKEY,  
							D23_RKEY,
							Lieferant,
							CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ

						FROM (
							--Lieferung T , Lieferung
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))
										AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
											OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


							UNION ALL

							--Retourniert
							SELECT 
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--offene Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE     
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND 
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--Debit/Belastung
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								(-1)*dbo.DATA0132.AMOUNT AS RWert

							FROM         dbo.DATA0132 INNER JOIN
								  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE      
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--Bestellungen in Klärung 
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								0 AS RWert
								
							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE      
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0070.STATUS = 5)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--Konsi Bestellungen
							SELECT  

								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=1
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

							UNION ALL 

							--rückgängig Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=15
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--offene Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0466.STATUS=1)
									AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--liegende Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0466.STATUS=4)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--retournierte Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=2
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						)  AS ResTbl
						GROUP BY
							--D17_RKEY, 
							D23_RKEY,
							Lieferant
			) AS myTblEK_VolumeVJ
			WHERE 
			--tblArtLief.D17_RKEY = myTblEK_VolumeVJ.D17_RKEY
			--AND
			tblLiefHerst.D23_RKEY = myTblEK_VolumeVJ.D23_RKEY
			--tblLief.Lieferant COLLATE SQL_Latin1_General_CP1_CI_AS = myTblEK_VolumeVJ.Lieferant
			----------------------------------

			--INSERT
			----------------------------------
			INSERT @tblLiefHerst(
										D23_RKEY, 
										Lieferant,
										EK_Volume,
										EK_VolumeVJ,
										EK_VolumeVJ_Jahr,
										LMenge,
										letztes_LDatum,
										AnzBestellungen,
										DRWert,
										DLMenge
							)

			SELECT
				myTblEK_VolumeVJ.D23_RKEY,
				myTblEK_VolumeVJ.Lieferant,
				0,
				myTblEK_VolumeVJ.EK_VolumeVJ,
				0,
				0,
				null,
				0,
				0,
				0

			FROM
			--@tblLief AS tblLief,
			(
						SELECT 
							--D17_RKEY,  
							D23_RKEY,
							Lieferant,
							CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ

						FROM (
							--Lieferung T , Lieferung
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant, 
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))
										AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
											OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


							UNION ALL

							--Retourniert
							SELECT 
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant, 
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--offene Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE     
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND 
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--Debit/Belastung
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								(-1)*dbo.DATA0132.AMOUNT AS RWert

							FROM         dbo.DATA0132 INNER JOIN
								  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE      
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--Bestellungen in Klärung 
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert
								
							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE      
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0070.STATUS = 5)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--Konsi Bestellungen
							SELECT  

								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=1
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

							UNION ALL 

							--rückgängig Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY, 
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=15
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--offene Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0466.STATUS=1)
									AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--liegende Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0466.STATUS=4)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--retournierte Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=2
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						)  AS ResTbl
						GROUP BY
							--D17_RKEY, 
							D23_RKEY,
							Lieferant		
			) AS myTblEK_VolumeVJ
			WHERE 
			--tblArtLief.D17_RKEY = myTblEK_VolumeVJ.D17_RKEY
			--AND
			--tblLief.D23_RKEY = myTblEK_VolumeVJ.D23_RKEY
			myTblEK_VolumeVJ.D23_RKEY Not In (SELECT tblLiefHerst.D23_RKEY FROM @tblLiefHerst AS tblLiefHerst)
			--myTblEK_VolumeVJ.Lieferant COLLATE SQL_Latin1_General_CP1_CI_AS Not In (SELECT tblLief.Lieferant FROM @tblLief AS tblLief)
			----------------------------------


			--UPDATE EK VOLUMEN GANZES JAHR
			----------------------------------
			UPDATE tblLiefHerst
			SET tblLiefHerst.EK_VolumeVJ_Jahr = myTblEK_VolumeVJ_Jahr.EK_VolumeVJ_Jahr
			FROM
			@tblLiefHerst AS tblLiefHerst,
			(
						SELECT 
							--D17_RKEY,  
							D23_RKEY,
							Lieferant,
							CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ_Jahr

						FROM (
							--Lieferung T , Lieferung
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@paraVJLiefHerst AS INT)) -->= CONVERT(DATETIME, @para1VJLiefHerst, 103))
										--AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))
										AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
											OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


							UNION ALL

							--Retourniert
							SELECT 
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@paraVJLiefHerst AS INT)) -->= CONVERT(DATETIME, @para1VJLiefHerst, 103))
										--AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--offene Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE     
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND 
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@paraVJLiefHerst AS INT)) -- >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
										--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--Debit/Belastung
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								(-1)*dbo.DATA0132.AMOUNT AS RWert

							FROM         dbo.DATA0132 INNER JOIN
								  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE      
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@paraVJLiefHerst AS INT)) -- >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
										--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--Bestellungen in Klärung 
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert
								
							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE      
										--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										--AND
										(dbo.DATA0070.STATUS = 5)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@paraVJLiefHerst AS INT)) -->= CONVERT(DATETIME, @para1VJLiefHerst, 103))
										--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--Konsi Bestellungen
							SELECT  

								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=1
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0341.TRAN_DATE) = CAST(@paraVJLiefHerst AS INT)) -- >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
									--AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

							UNION ALL 

							--rückgängig Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY, 
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=15
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0341.TRAN_DATE) = CAST(@paraVJLiefHerst AS INT)) -- >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
									--AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--offene Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0466.STATUS=1)
									AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0467.REQ_DATE) = CAST(@paraVJLiefHerst AS INT)) -- >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
									--AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--liegende Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									(dbo.DATA0466.STATUS=4)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0467.REQ_DATE) = CAST(@paraVJLiefHerst AS INT)) -->= CONVERT(DATETIME, @para1VJLiefHerst, 103))
									--AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))

							UNION ALL 

							--retournierte Konsi-Bestellungen
							SELECT  
								--dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									--AND
									dbo.DATA0341.TRAN_TP=2
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (YEAR(dbo.DATA0341.TRAN_DATE) = CAST(@paraVJLiefHerst AS INT)) -- >= CONVERT(DATETIME, @para1VJLiefHerst, 103))
									--AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJLiefHerst, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						)  AS ResTbl
						GROUP BY
							--D17_RKEY, 
							D23_RKEY,
							Lieferant
			) AS myTblEK_VolumeVJ_Jahr
			WHERE 
			--tblArtLief.D17_RKEY = myTblEK_VolumeVJ.D17_RKEY
			--AND
			tblLiefHerst.D23_RKEY = myTblEK_VolumeVJ_Jahr.D23_RKEY
			--tblLief.Lieferant COLLATE SQL_Latin1_General_CP1_CI_AS = myTblEK_VolumeVJ_Jahr.Lieferant
			----------------------------------



			SELECT
			Lieferant, --Lieferant
			ISNULL(EK_Volume, 0) AS EK_Volume, --EK-Vol. ZR
			ISNULL(EK_VolumeVJ, 0) AS EK_VolumeVJ, --EK-Vol. VJ ZR
			ISNULL(EK_Volume-EK_VolumeVJ, 0) AS EK_VolumeDiff, --Differenz
			CASE WHEN EK_VolumeVJ>0 THEN ISNULL((EK_Volume-EK_VolumeVJ)/EK_VolumeVJ*100, 0) ELSE 0 END AS EK_VolumeDiffProz, --in %
			ISNULL(AnzBestellungen, 0) AS AnzBestellungen, --Anz. Lieferungen
			CASE WHEN ISNULL(letztes_LDatum, '')='' THEN '' ELSE CONVERT(varchar(10), letztes_LDatum, 104) END AS letztes_LDatum, --letze Lieferung vom
			ISNULL(EK_VolumeVJ_Jahr, 0) AS EK_VolumeVJ_Jahr, --EK-Vol. Vorjahr
			CASE WHEN ISNULL(EK_VolumeVJ_Jahr, 0)>0 THEN ISNULL(EK_Volume, 0)/ISNULL(EK_VolumeVJ_Jahr, 0)*100 ELSE 0 END AS AnteilEKVolZR_inProz, --Anteil EK Vol ZR an VJ in %
			ISNULL(NK_VJ, 0) AS NKVorjahr, --NK Vorjahr
			ISNULL(NK_ZR, 0) AS NKZR, --NK ZR
			ISNULL(NK_VJ_ZR, 0) AS NKVJZR, --NK ZR
			ISNULL(DRWert, 0) AS DRWert, --O Rechnungswert
			ISNULL(LMenge, 0) AS LMenge, --EK-Menge
			ISNULL(DLMenge, 0) AS DLMenge --O Liefermenge

--			ISNULL(EK_Volume_ArtGesamt, 0) AS EK_Volume_ArtGesamt,
--			ISNULL(EK_Volume/EK_Volume_TOTAL*100, 0) AS Proz_Anteil,
--			--D17_RKEY, 
--			--INV_PART_NUMBER, 
--			--INV_PART_DESCRIPTION, 
--			Lieferant,
--			ISNULL(EK_Volume, 0) AS EK_Volume,
--			ISNULL(EK_VolumeVJ, 0) AS EK_VolumeVJ,
--			ISNULL(EK_VolumeVJ_Jahr, 0) AS EK_VolumeVJ_Jahr,
--			ISNULL(EK_Volume-EK_VolumeVJ, 0) AS EK_VolumeDiff,
--			CASE WHEN EK_VolumeVJ>0 THEN ISNULL((EK_Volume-EK_VolumeVJ)/EK_VolumeVJ*100, 0) ELSE 0 END AS EK_VolumeDiffProz,
--			ISNULL(LMenge, 0) AS LMenge,
			--UNIT_CODE,
			--ISNULL(DRPreis, 0) AS DRPreis,
			--ISNULL(Letzter_EK_Preis, 0) AS Letzter_EK_Preis,
			--letztes_LDatum,
			--CONVERT(varchar(10), letztes_LDatum, 104) AS letztes_LDatum,
--			CASE WHEN ISNULL(letztes_LDatum, '')='' THEN '' ELSE CONVERT(varchar(10), letztes_LDatum, 104) END AS letztes_LDatum,
--			ISNULL(AnzBestellungen, 0) AS AnzBestellungen,
--			ISNULL(DRWert, 0) AS DRWert,
--			ISNULL(DLMenge, 0) AS DLMenge,
--			CASE WHEN ISNULL(EK_VolumeVJ_Jahr, 0)>0 THEN ISNULL(EK_Volume, 0)/ISNULL(EK_VolumeVJ_Jahr, 0)*100 ELSE 0 END AS AnteilEKVolZR_inProz, --Anteil EK Vol ZR an VJ in %
--			ISNULL(NK_VJ, 0) AS NKVorjahr, --NK Vorjahr
--			ISNULL(NK_VJ_ZR, 0) AS NKZR --NK ZR
			FROM
			(
				SELECT
				--(SELECT TOP 1 SUM(EK_Volume) FROM @tblLief AS myTmpTblLief WHERE myTmpTblLief.D23_RKEY = myTmpTblArtLiefMain.D23_RKEY) AS EK_Volume_ArtGesamt,
				(SELECT TOP 1 SUM(EK_Volume) FROM @tblLiefHerst AS myTmpTblLief WHERE myTmpTblLief.Lieferant = myTmpTblArtLiefMain.Lieferant) AS EK_Volume_ArtGesamt,
				(SELECT TOP 1 SUM(EK_Volume) FROM @tblLiefHerst AS myTmpTblLief) AS EK_Volume_TOTAL,
				* 
				FROM @tblLiefHerst AS myTmpTblArtLiefMain --ORDER BY INV_PART_NUMBER, INV_PART_DESCRIPTION
			) AS tbl
			ORDER BY EK_Volume DESC--EK_Volume_ArtGesamt DESC, INV_PART_DESCRIPTION, EK_Volume DESC
	END

	IF @Case_ = 'ABCArtikelAuswahlliste'
	BEGIN
		SELECT 
			INV_PART_DESCRIPTION 
		FROM 
			DATA0017 
		WHERE 
			(dbo.DATA0017.ACTIVE_FLAG = 'Y') 
			--AND (ISNULL(dbo.DATA0017.MANUFACTURER_CODE, '') = '') 02.12.2014/DSI deaktiviert nach Absprache mit Hr. Wienecke (wegen Hr. Seidels Inventurberichten)
			--AND (dbo.DATA0017.S_B_N = 'N') 
			AND (dbo.DATA0017.TTYPE = 'R') 
			AND (dbo.DATA0017.PROD_CODE_SELL_PTR <> 95) 
			AND (dbo.DATA0017.INV_PART_NUMBER NOT LIKE 'REC-%') 
		ORDER BY INV_PART_DESCRIPTION
	END

	IF @Case_ = 'ABCArtikel'
	BEGIN
		--DECLARE
		--@para1 varchar(250),
		--@para2 varchar(250),
		--@para3 varchar(250),
		--@para4 varchar(250)
		--SET @para1 = '01.01.2013'
		--SET @para2 = '07.01.2014'
		--SET @para3 = ''
		--SET @para4 = 'bimsmehl'
/*
			SELECT 
				INV_PART_NUMBER, 
				INV_PART_DESCRIPTION,
				ISNULL(CAST(SUM(RWert) AS NUMERIC(10, 2)), 0) AS EK_Volume,
				ISNULL(CAST(SUM(LMenge) AS NUMERIC(10, 2)), 0) AS LMenge,
				ISNULL((
					SELECT  TOP 1   ISNULL(dbo.DATA0002.UNIT_CODE, '') AS RES
					FROM         dbo.DATA0002 INNER JOIN
										  dbo.DATA0017 ON dbo.DATA0002.RKEY = dbo.DATA0017.PURCH_UNIT_PTR
					WHERE     (dbo.DATA0017.RKEY = D17_RKEY)
				), '') As EinkEinheit,
				ISNULL(CAST(AVG(RPreis) AS NUMERIC(10, 3)), 0) AS DRPreis,
				ISNULL(CAST((
					SELECT     TOP 1 ISNULL(dbo.DATA0108.PRICE, 0) AS RES
					FROM         dbo.DATA0017 AS D17 INNER JOIN
										  dbo.DATA0071 ON D17.RKEY = dbo.DATA0071.INVT_PTR INNER JOIN
										  dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
					WHERE     (dbo.DATA0071.PRICE > 0) AND (D17.RKEY = D17_RKEY)
					ORDER BY dbo.DATA0071.DEL_DATE DESC
				) AS NUMERIC(10, 3)), 0) AS Letzter_EK_Preis,
				ISNULL(CONVERT(varchar(10), MAX(LDatum), 104), '') AS letztes_LDatum,
				ISNULL(SUM(AnzBestellungen), 0) AS AnzBestellungen,
				ISNULL((
						SELECT TOP 1  COUNT(dbo.DATA0023.CODE)AS RES
						FROM         dbo.DATA0071 INNER JOIN
											  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
						WHERE  dbo.DATA0071.INVT_PTR = D17_RKEY
						GROUP BY CODE
					), 0) AS Anzahl_Lieferanten,
				ISNULL(CAST(AVG(RWert) AS NUMERIC(10, 2)), 0) AS DRWert,
				ISNULL(CAST(AVG(LMenge) AS NUMERIC(10, 2)), 0) AS DLMenge

			FROM (
				--Lieferung T , Lieferung
				SELECT  
					'GGP' As BTyp,		
					dbo.DATA0095.RKEY AS D95_PTR, 
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION,
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant, 
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					dbo.DATA0095.ENTERED_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
							AND  
							(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))

				UNION ALL

				--Retourniert
				SELECT 
					'GGP' As BTyp, 
					dbo.DATA0095.RKEY AS D95_PTR, 
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					(-1)*dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					dbo.DATA0095.ENTERED_DATE AS LDatum,
					0 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
							AND
							(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--offene Bestellungen
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      
							--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
							AND 
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							--AND  
							(dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--Debit/Belastung
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					dbo.DATA0108.PRICE AS RPreis,
					(-1)*dbo.DATA0132.AMOUNT AS RWert,
					dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0132 INNER JOIN
                      dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
                      dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
                      dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
                      dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
                      dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
                      dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
                      dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE      	
							--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
							AND 
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							--AND  
							(dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--Bestellungen in Klärung 
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)	
					) AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      
							--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
							AND 
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							--AND  
							(dbo.DATA0070.STATUS = 5)
							--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--Konsi Bestellungen
				SELECT  
					'Konsi' As BTyp,
					dbo.DATA0341.RKEY AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS NK,
					dbo.DATA0341.TRAN_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     
						--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
						AND 
						dbo.DATA0341.TRAN_TP=1
						--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
						AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

				UNION ALL 

				--rückgängig Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					dbo.DATA0341.RKEY AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION,
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant, 
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS NK,
					dbo.DATA0341.TRAN_DATE AS LDatum,
					0 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     
						--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
						AND 
						dbo.DATA0341.TRAN_TP=15
						--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--offene Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0467.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert, 
					0 AS NK,
					dbo.DATA0467.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE     
						--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
						AND 
						(dbo.DATA0466.STATUS=1)
						AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
						--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--liegende Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0467.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert, 
					0 AS NK,
					dbo.DATA0467.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE     
						--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
						AND 
						(dbo.DATA0466.STATUS=4)
						--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--retournierte Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					dbo.DATA0341.RKEY AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
						(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS NK,
					dbo.DATA0467.REQ_DATE AS LDatum,
					0 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     
						--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
						AND 
						dbo.DATA0341.TRAN_TP=2
						--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
						AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

			)  AS ResTbl
			GROUP BY
				D17_RKEY, 
 				INV_PART_NUMBER, 
				INV_PART_DESCRIPTION,
				UNIT_CODE,
				QUAN_ON_HAND,
				CONSIGN_ONHAND_QTY,
				LetzterLieferant,
				AnzLieferanten
			ORDER BY SUM(CAST(RWert AS NUMERIC(10, 2))) DESC 
*/

		--DECLARE
		--@para1 varchar(250),
		--@para2 varchar(250),
		--@para3 varchar(250)
		--SET @para1 = '01.01.2013'
		--SET @para2 = '07.01.2014'
		--SET @para3 = '%'


		DECLARE
		@para1VJArt varchar(250),
		@para2VJArt varchar(250)
		SET @para1VJArt = SUBSTRING(@para1, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para1, 7, 4) AS INT)-1))
		SET @para2VJArt = SUBSTRING(@para2, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para2, 7, 4) AS INT)-1))


		DECLARE @tblArt table (
									D17_RKEY NUMERIC(10, 0), 
									INV_PART_NUMBER char(20) null, 
									INV_PART_DESCRIPTION char(40) null, 
									EK_Volume NUMERIC(10,2) ,
									EK_VolumeVJ NUMERIC(10,2) ,
									LMenge NUMERIC(10,2) ,
									EinkEinheit char(5) null,
									DRPreis NUMERIC(10,3) ,
									Letzter_EK_Preis NUMERIC(10,3) ,
									letztes_LDatum smalldatetime ,
									AnzBestellungen int,
									Anzahl_Lieferanten int,
									DRWert NUMERIC(10,2),
									DLMenge NUMERIC(10,2)
									)

		INSERT @tblArt(
									D17_RKEY, 
									INV_PART_NUMBER, 
									INV_PART_DESCRIPTION, 
									EK_Volume,
									EK_VolumeVJ,
									LMenge,
									EinkEinheit,
									DRPreis,
									Letzter_EK_Preis,
									letztes_LDatum,
									AnzBestellungen,
									Anzahl_Lieferanten,
									DRWert,
									DLMenge
						)

			SELECT 
				D17_RKEY,
				INV_PART_NUMBER, 
				INV_PART_DESCRIPTION,
				ISNULL(CAST(SUM(RWert) AS NUMERIC(10, 2)), 0) AS EK_Volume,
				0 AS EK_VolumeVJ,
				ISNULL(CAST(SUM(LMenge) AS NUMERIC(10, 2)), 0) AS LMenge,
				ISNULL((
					SELECT  TOP 1   ISNULL(dbo.DATA0002.UNIT_CODE, '') AS RES
					FROM         dbo.DATA0002 INNER JOIN
										  dbo.DATA0017 ON dbo.DATA0002.RKEY = dbo.DATA0017.PURCH_UNIT_PTR
					WHERE     (dbo.DATA0017.RKEY = D17_RKEY)
				), '') As EinkEinheit,
				--ISNULL(CAST(AVG(RPreis) AS NUMERIC(10, 3)), 0) AS DRPreis,
				ISNULL(SUM(LMenge*RPreis)/SUM(LMenge), 0) AS DRPreis,
				ISNULL(CAST((
					SELECT     TOP 1 ISNULL(dbo.DATA0108.PRICE, 0) AS RES
					FROM         dbo.DATA0017 AS D17 INNER JOIN
										  dbo.DATA0071 ON D17.RKEY = dbo.DATA0071.INVT_PTR INNER JOIN
										  dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
					WHERE     (dbo.DATA0071.PRICE > 0) AND (D17.RKEY = D17_RKEY)
					ORDER BY dbo.DATA0071.DEL_DATE DESC
				) AS NUMERIC(10, 3)), 0) AS Letzter_EK_Preis,
				ISNULL(CONVERT(varchar(10), MAX(LDatum), 104), '') AS letztes_LDatum,
				ISNULL(SUM(AnzBestellungen), 0) AS AnzBestellungen,
				ISNULL((
						--SELECT TOP 1  COUNT(dbo.DATA0023.CODE)AS RES
						--FROM         dbo.DATA0071 INNER JOIN
						--					  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						--					  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
						--WHERE  dbo.DATA0071.INVT_PTR = D17_RKEY
						--GROUP BY CODE
						SELECT TOP 1  
							COUNT(RES) AS Anz
						FROM
						(
							SELECT (dbo.DATA0023.CODE)AS RES, dbo.DATA0071.INVT_PTR 
							FROM         dbo.DATA0071 INNER JOIN
												  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
							--WHERE  dbo.DATA0071.INVT_PTR = D17_RKEY
							GROUP BY CODE, INVT_PTR
						) AS myCountTbl WHERE INVT_PTR = D17_RKEY
					), 0) AS Anzahl_Lieferanten,
				ISNULL(CAST(AVG(RWert) AS NUMERIC(10, 2)), 0) AS DRWert,
				ISNULL(CAST(AVG(LMenge) AS NUMERIC(10, 2)), 0) AS DLMenge

			FROM (
				--Lieferung T , Lieferung
				SELECT  
					'GGP' As BTyp,		
					dbo.DATA0095.RKEY AS D95_PTR, 
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION,
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant, 
					dbo.DATA0002.UNIT_CODE AS EinkEinheit,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					dbo.DATA0095.ENTERED_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
							AND  
							(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))

				UNION ALL

				--Retourniert
				SELECT 
					'GGP' As BTyp, 
					dbo.DATA0095.RKEY AS D95_PTR, 
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					(-1)*dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					dbo.DATA0095.ENTERED_DATE AS LDatum,
					0 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
							AND
							(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--offene Bestellungen
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      
							--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
							AND 
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							--AND  
							(dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--Debit/Belastung
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					dbo.DATA0108.PRICE AS RPreis,
					(-1)*dbo.DATA0132.AMOUNT AS RWert,
					dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0132 INNER JOIN
                      dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
                      dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
                      dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
                      dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
                      dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
                      dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
                      dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE      	
							--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
							AND 
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							--AND  
							(dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--Bestellungen in Klärung 
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)	
					) AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      
							--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
							AND 
							--AND  (dbo.DATA0071.QUAN_RECD = 0)
							--AND  
							(dbo.DATA0070.STATUS = 5)
							--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--Konsi Bestellungen
				SELECT  
					'Konsi' As BTyp,
					dbo.DATA0341.RKEY AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS NK,
					dbo.DATA0341.TRAN_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     
						--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
						AND 
						dbo.DATA0341.TRAN_TP=1
						--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
						AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

				UNION ALL 

				--rückgängig Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					dbo.DATA0341.RKEY AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION,
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant, 
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS NK,
					dbo.DATA0341.TRAN_DATE AS LDatum,
					0 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     
						--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
						AND 
						dbo.DATA0341.TRAN_TP=15
						--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--offene Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0467.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert, 
					0 AS NK,
					dbo.DATA0467.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE     
						--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
						AND 
						(dbo.DATA0466.STATUS=1)
						AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
						--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--liegende Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0467.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert, 
					0 AS NK,
					dbo.DATA0467.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE     
						--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
						AND 
						(dbo.DATA0466.STATUS=4)
						--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--retournierte Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					dbo.DATA0341.RKEY AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
						(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS NK,
					dbo.DATA0467.REQ_DATE AS LDatum,
					0 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     
						--(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para3 OR dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4)  
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)
						AND 
						dbo.DATA0341.TRAN_TP=2
						--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
						AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

			)  AS ResTbl
			GROUP BY
				D17_RKEY, 
 				INV_PART_NUMBER, 
				INV_PART_DESCRIPTION,
				EinkEinheit,
				QUAN_ON_HAND,
				CONSIGN_ONHAND_QTY,
				LetzterLieferant,
				AnzLieferanten
			ORDER BY SUM(CAST(RWert AS NUMERIC(10, 2))) DESC 


			--UPDATE
			----------------------------------
			UPDATE tblArt
			SET tblArt.EK_VolumeVJ = myTblEK_VolumeVJ.EK_VolumeVJ
			FROM
			@tblArt AS tblArt,
			(
						SELECT 
							D17_RKEY,  
							--D23_RKEY,
							CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ

						FROM (
							--Lieferung T , Lieferung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJArt, 103))
										AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
											OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


							UNION ALL

							--Retourniert
							SELECT 
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJArt, 103))

							UNION ALL 

							--offene Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								0 AS RWert

							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE     
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND 
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJArt, 103))

							UNION ALL 

							--Debit/Belastung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								(-1)*dbo.DATA0132.AMOUNT AS RWert

							FROM         dbo.DATA0132 INNER JOIN
								  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJArt, 103))

							UNION ALL 

							--Bestellungen in Klärung 
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								0 AS RWert
								
							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 5)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJArt, 103))

							UNION ALL 

							--Konsi Bestellungen
							SELECT  

								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									dbo.DATA0341.TRAN_TP=1
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJArt, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

							UNION ALL 

							--rückgängig Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY, 
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									dbo.DATA0341.TRAN_TP=15
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJArt, 103))

							UNION ALL 

							--offene Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									(dbo.DATA0466.STATUS=1)
									AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJArt, 103))

							UNION ALL 

							--liegende Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									(dbo.DATA0466.STATUS=4)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJArt, 103))

							UNION ALL 

							--retournierte Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									dbo.DATA0341.TRAN_TP=2
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJArt, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						)  AS ResTbl
						GROUP BY
							D17_RKEY, 
							D23_RKEY
			) AS myTblEK_VolumeVJ
			WHERE 
			tblArt.D17_RKEY = myTblEK_VolumeVJ.D17_RKEY
			--AND
			--tblArtLief.D23_RKEY = myTblEK_VolumeVJ.D23_RKEY
			----------------------------------

			--INSERT
			----------------------------------
			INSERT @tblArt(
										D17_RKEY, 
										INV_PART_NUMBER, 
										INV_PART_DESCRIPTION, 
										EK_Volume,
										EK_VolumeVJ,
										LMenge,
										EinkEinheit,
										DRPreis,
										Letzter_EK_Preis,
										letztes_LDatum,
										AnzBestellungen,
										Anzahl_Lieferanten,
										DRWert,
										DLMenge
							)
			--UPDATE tblArt
			--SET tblArt.EK_VolumeVJ = myTblEK_VolumeVJ.EK_VolumeVJ
			SELECT
				myTblEK_VolumeVJ.D17_RKEY,
				myTblEK_VolumeVJ.INV_PART_NUMBER,
				myTblEK_VolumeVJ.INV_PART_DESCRIPTION,
				0,
				myTblEK_VolumeVJ.EK_VolumeVJ,
				0,
				'',
				0,
				0,
				null,
				0,
				0,
				0,
				0
			FROM
			--@tblArt AS tblArt,
			(
						SELECT 
							D17_RKEY,  
							INV_PART_NUMBER, 
							INV_PART_DESCRIPTION,
							--D23_RKEY,
							CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ

						FROM (
							--Lieferung T , Lieferung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJArt, 103))
										AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
											OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


							UNION ALL

							--Retourniert
							SELECT 
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJArt, 103))

							UNION ALL 

							--offene Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								0 AS RWert

							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE     
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND 
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJArt, 103))

							UNION ALL 

							--Debit/Belastung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								(-1)*dbo.DATA0132.AMOUNT AS RWert

							FROM         dbo.DATA0132 INNER JOIN
								  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJArt, 103))

							UNION ALL 

							--Bestellungen in Klärung 
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								0 AS RWert
								
							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 5)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJArt, 103))

							UNION ALL 

							--Konsi Bestellungen
							SELECT  

								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									dbo.DATA0341.TRAN_TP=1
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJArt, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

							UNION ALL 

							--rückgängig Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									dbo.DATA0341.TRAN_TP=15
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJArt, 103))

							UNION ALL 

							--offene Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									(dbo.DATA0466.STATUS=1)
									AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJArt, 103))

							UNION ALL 

							--liegende Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									(dbo.DATA0466.STATUS=4)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJArt, 103))

							UNION ALL 

							--retournierte Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									dbo.DATA0341.TRAN_TP=2
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJArt, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJArt, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						)  AS ResTbl
						GROUP BY
							D17_RKEY, 
							INV_PART_NUMBER, 
							INV_PART_DESCRIPTION
			) AS myTblEK_VolumeVJ
			WHERE 
			--tblArt.D17_RKEY = myTblEK_VolumeVJ.D17_RKEY
			--AND
			--tblArtLief.D23_RKEY = myTblEK_VolumeVJ.D23_RKEY
			myTblEK_VolumeVJ.D17_RKEY Not In (SELECT tblArt.D17_RKEY FROM @tblArt AS tblArt)
			----------------------------------



		SELECT
			ISNULL(EK_Volume_ArtGesamt, 0) AS EK_Volume_ArtGesamt,
			ISNULL(EK_Volume/EK_Volume_TOTAL*100, 0) AS Proz_Anteil,
			--D17_RKEY, 
			INV_PART_NUMBER, 
			INV_PART_DESCRIPTION, 
			--Lieferant,
			ISNULL(EK_Volume, 0) AS EK_Volume,
			ISNULL(EK_VolumeVJ, 0) AS EK_VolumeVJ,
			ISNULL(LMenge, 0) AS LMenge,
			EinkEinheit,
			ISNULL(DRPreis, 0) AS DRPreis,
			ISNULL(Letzter_EK_Preis, 0) AS Letzter_EK_Preis,
			--letztes_LDatum,
			CASE WHEN ISNULL(letztes_LDatum, '')='' THEN '' ELSE CONVERT(varchar(10), letztes_LDatum, 104) END AS letztes_LDatum,
			ISNULL(AnzBestellungen, 0) AS AnzBestellungen,
			ISNULL(Anzahl_Lieferanten, 0) AS Anzahl_Lieferanten,
			ISNULL(DRWert, 0) AS DRWert,
			ISNULL(DLMenge, 0) AS DLMenge
			FROM
			(
				SELECT
				(SELECT TOP 1 SUM(EK_Volume) FROM @tblArt AS myTmpTblArt WHERE myTmpTblArt.D17_RKEY = myTmpTblArtMain.D17_RKEY) AS EK_Volume_ArtGesamt,
				(SELECT TOP 1 SUM(EK_Volume) FROM @tblArt AS myTmpTblArt) AS EK_Volume_TOTAL,
				* 
				FROM @tblArt AS myTmpTblArtMain --ORDER BY INV_PART_NUMBER, INV_PART_DESCRIPTION
			) AS tblArtikel
			ORDER BY EK_Volume_ArtGesamt DESC, INV_PART_DESCRIPTION, EK_Volume DESC
	END

	IF @Case_ = 'ABCAnalyse'
	BEGIN
		SELECT
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION,
			Sum_GGPKonsi_EKVolumen,
			Sum_GGPKonsi_EKMenge,
			Sum_Gesamt_EKVolumen,
			(Sum_GGPKonsi_EKVolumen/Sum_Gesamt_EKVolumen) AS Anteil
		FROM
		(
		SELECT
			--D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION,
			Sum_GGPKonsi_EKVolumen,
			Sum_GGPKonsi_EKMenge,
			(SELECT TOP 1 
				SUM((dbo.DATA0071.QUAN_RECD - dbo.DATA0071.QUAN_RETN)
				*
				(CASE
					WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
					ELSE 
						CASE
							WHEN ISNULL(dbo.DATA0071.PRICE, 0)>0 THEN dbo.DATA0071.PRICE 
								ELSE 
									ISNULL(dbo.DATA0017.STD_COST, 0)
						END
				END)) AS RES
				FROM         dbo.DATA0095 INNER JOIN
				  dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
				  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
				  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY LEFT OUTER JOIN
				  dbo.DATA0108 ON dbo.DATA0071.PO_PTR = dbo.DATA0108.DATA0071_PTR
				WHERE      (dbo.DATA0095.TRAN_TP = 5)
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para2, 103)) 
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para3, 103))
			) AS Sum_Gesamt_EKVolumen
			
		FROM
		(
			SELECT
			--D17_PTR
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION,
			SUM(GGPKonsi_EKVolumen) AS Sum_GGPKonsi_EKVolumen,
			SUM(GGPKonsi_EKMenge) AS Sum_GGPKonsi_EKMenge
			FROM
			(
				--GGP Bestellungen
				SELECT
					--dbo.DATA0095.INVT_PTR AS D17_PTR     
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					SUM(
							(dbo.DATA0071.QUAN_RECD - dbo.DATA0071.QUAN_RETN)
							*
							CASE
								WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(dbo.DATA0071.PRICE, 0)>0 THEN dbo.DATA0071.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0)
									END
							END
						) AS GGPKonsi_EKVolumen, 
						SUM(dbo.DATA0071.QUAN_RECD - dbo.DATA0071.QUAN_RETN) AS GGPKonsi_EKMenge
									

				FROM         dbo.DATA0095 INNER JOIN
							  dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
							  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
							  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY LEFT OUTER JOIN
							  dbo.DATA0108 ON dbo.DATA0071.PO_PTR = dbo.DATA0108.DATA0071_PTR
				WHERE      (dbo.DATA0095.TRAN_TP = 5)
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para2, 103)) 
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para3, 103))
				GROUP BY dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, dbo.DATA0095.INVT_PTR

				UNION ALL

				--Konsi Bestellungen
				SELECT     
					--dbo.DATA0341.DATA0017_PTR AS D17_PTR
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					SUM(
							(dbo.DATA0467.QUAN_RECD - dbo.DATA0467.QUAN_RETN)
							*
							CASE
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE 
								ELSE 
									ISNULL(dbo.DATA0017.STD_COST, 0)
							END
						) AS GGPKonsi_EKVolumen, 
					SUM(dbo.DATA0467.QUAN_RECD - dbo.DATA0467.QUAN_RETN) AS GGPKonsi_EKMenge

					FROM         dbo.DATA0017 INNER JOIN
										  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
										  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
										  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
										  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
					WHERE  (dbo.DATA0341.TRAN_TP=1)
							AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para2, 103))
							AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para3, 103))
					GROUP BY dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, dbo.DATA0341.DATA0017_PTR

			) AS myTbl
			GROUP BY 
				INV_PART_NUMBER, INV_PART_DESCRIPTION
		) AS myTbl2
		) As MyTbl3

		ORDER BY
				(Sum_GGPKonsi_EKVolumen/Sum_Gesamt_EKVolumen) DESC --INV_PART_NUMBER, INV_PART_DESCRIPTION
	END

	IF @Case_ = 'ABCArtikelLieferantDetail5'
	BEGIN
		--DECLARE
		--	@para1 varchar(250),
		--	@para2 varchar(250),
		--	@para3 varchar(250),
		--	@para4 varchar(250)
		--	SET @para1 = '01.01.2014'
		--	SET @para2 = '31.01.2014'
		--	SET @para3 = 'FR4 1,5 18/18   610x460' --'%' --'bimsmehl'
		--	SET @para4 = '%' --'Brautmeier GmbH'

		SELECT

			ISNULL((
				SELECT TOP 1
					Res_EKPreis
				FROM
				(
					SELECT     
						CASE 
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE
							ELSE
								CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
									ELSE D17.STD_COST
								END
						END AS Res_EKPreis,
						D17.INV_PART_DESCRIPTION,
						D23.SUPPLIER_NAME,
						D95.TRAN_DATE
					FROM         dbo.DATA0095 AS D95 INNER JOIN
						  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
						  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
						  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
						  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY INNER JOIN
						  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
						  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
					WHERE     
						(D95.TRAN_TP = 5) 
						AND (D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
				) AS myDPreisTbl
				WHERE
					(INV_PART_DESCRIPTION = @para3) 
					AND SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
				ORDER BY TRAN_DATE DESC
			), 0) AS Preis_letzter,

			ISNULL((
				SELECT TOP 1
					MAX(Res_EKPreis) AS Res_EKPreis
				FROM
				(
					SELECT     
						CASE 
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE
							ELSE
								CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
									ELSE D17.STD_COST
								END
						END AS Res_EKPreis,
						D17.INV_PART_DESCRIPTION,
						D23.SUPPLIER_NAME
					FROM         dbo.DATA0095 AS D95 INNER JOIN
						  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
						  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
						  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
						  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY INNER JOIN
						  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
						  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
					WHERE     
						(D95.TRAN_TP = 5) 
						AND (D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
				) AS myDPreisTbl
				WHERE
					(INV_PART_DESCRIPTION = @para3) 
					AND SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
			), 0) AS Preis_max,

			ISNULL((
				SELECT TOP 1
					MIN(Res_EKPreis) AS Res_EKPreis
				FROM
				(
					SELECT     
						CASE 
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE
							ELSE
								CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
									ELSE D17.STD_COST
								END
						END AS Res_EKPreis,
						D17.INV_PART_DESCRIPTION,
						D23.SUPPLIER_NAME
					FROM         dbo.DATA0095 AS D95 INNER JOIN
						  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
						  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
						  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
						  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY INNER JOIN
						  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
						  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
					WHERE     
						(D95.TRAN_TP = 5) 
						AND (D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
				) AS myDPreisTbl
				WHERE
					(INV_PART_DESCRIPTION = @para3) 
					AND SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
			), 0) AS Preis_min
	END

	IF @Case_ = 'ABCArtikelLieferantDetail4'
	BEGIN
		--DECLARE
		--	@para1 varchar(250),
		--	@para2 varchar(250),
		--	@para3 varchar(250),
		--	@para4 varchar(250)
		--	SET @para1 = '01.01.2014'
		--	SET @para2 = '31.01.2014'
		--	SET @para3 = 'FR4 1,5 18/18   610x460' --'%' --'bimsmehl'
		--	SET @para4 = '%' --'Brautmeier GmbH'

		SELECT

			ISNULL(CAST(SUM(LMenge) AS NUMERIC(10, 2)), 0) AS LMenge,
			ISNULL(CAST(SUM(RWert) AS NUMERIC(10, 2)), 0) AS EK_Volume,
			ISNULL((
				SELECT 
				SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
				FROM
				(
					SELECT     
						CASE 
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE
							ELSE
								CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
									ELSE D17.STD_COST
								END
						END AS Res_DREPreis,
						(D95.QUANTITY/D17.STOCK_PURCH) AS Menge,
						D17.INV_PART_DESCRIPTION,
						D23.SUPPLIER_NAME
					FROM         dbo.DATA0095 AS D95 INNER JOIN
						  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
						  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
						  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
						  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY INNER JOIN
						  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
						  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
					WHERE     
						(D95.TRAN_TP = 5) 
						AND (D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
				) AS myDPreisTbl
				WHERE
					(INV_PART_DESCRIPTION = @para3) 
					AND SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
				--GROUP BY
				--	INV_PART_DESCRIPTION,
				--	SUPPLIER_NAME
			), 0) AS DPreis

			FROM (
				--Lieferung T , Lieferung
				SELECT  
					'GGP' As BTyp,		
					dbo.DATA0095.RKEY AS D95_PTR, 
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION,
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant, 
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE--/dbo.DATA0107.EX_RATE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						--FROM         dbo.DATA0107 INNER JOIN
						--					  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
						--					  dbo.DATA0070 AS D70 INNER JOIN
						--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
						--					  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
					) AS RPreis,
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						--FROM         dbo.DATA0070 AS D70 INNER JOIN
						--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
						--					  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									--AND (D70.SUPPLIER_POINTER = dbo.DATA0023.RKEY)
									AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
					) AS RWert,
					dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					dbo.DATA0095.ENTERED_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND
							(dbo.DATA0095.TRAN_TP = 5) --AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


				UNION ALL

				--Retourniert
				SELECT 
					'GGP' As BTyp, 
					dbo.DATA0095.RKEY AS D95_PTR, 
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					(-1)*dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis
						--FROM         dbo.DATA0070 AS D70 INNER JOIN
						--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
						--					  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
					) AS RPreis,
					-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis
						--FROM         dbo.DATA0070 AS D70 INNER JOIN
						--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
						--					  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						----WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						--WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						--			--AND (D70.SUPPLIER_POINTER = dbo.DATA0023.RKEY)
						--			AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
					) AS RWert,
					dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					dbo.DATA0095.ENTERED_DATE AS LDatum,
					0 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND
							(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) --AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--offene Bestellungen
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE     
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND 
							(dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--Debit/Belastung
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					dbo.DATA0108.PRICE AS RPreis,
					(-1)*dbo.DATA0132.AMOUNT AS RWert,
					dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0132 INNER JOIN
					  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
					  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
					  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
					  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
					  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
					  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
					  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
					  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE      
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND
							(dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--Bestellungen in Klärung 
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)	
					) AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND
							(dbo.DATA0070.STATUS = 5)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


			)  AS ResTbl
	END

	IF @Case_ = 'ABCArtikelLieferantDetail3'
	BEGIN
		--DECLARE
		--	@para1 varchar(250),
		--	@para2 varchar(250)
		--SET @para1 = 'Wasserstoffperoxid 35%, wässerige Lösung'
		--SET @para2 = '2013'

		DECLARE 
			@ArtGrp_PTR numeric(10, 0),
			@EKVol_Art numeric(10, 0),
			@EKVol_Grp numeric(10, 0),
			@EKVol_Gesamt numeric(10, 0)

		SET @ArtGrp_PTR = (
						SELECT     dbo.DATA0008.RKEY
						FROM         dbo.DATA0008 INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0008.RKEY = dbo.DATA0017.PROD_CODE_SELL_PTR
						WHERE     (dbo.DATA0017.INV_PART_DESCRIPTION = @para1)
						)

		SET @EKVol_Art =
			ISNULL((
				SELECT
				ISNULL((
					SELECT
						SUM(ISNULL(Res0, 0)) AS ResSum0
					FROM
					(
						--Lieferung T , Lieferung
						SELECT  
							dbo.DATA0017.RKEY AS D17RKEY,
							--dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
							dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
													  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
							) 
							AS Res0

						FROM         dbo.DATA0005 INNER JOIN
											  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
											  dbo.DATA0017 INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
											  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
						WHERE    
								(dbo.DATA0095.TRAN_TP = 5)
								AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
									OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
								AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@para2 AS INT)) --YEAR(GETDATE()))
						UNION ALL
						--Retourniert
						SELECT 
							dbo.DATA0017.RKEY AS D17RKEY,
							--dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
							-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
							(
								SELECT     TOP 1 
								CASE
									WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
										ELSE 
											CASE
												WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
													ELSE 
														(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
											END
								END AS RPreis
								FROM         dbo.DATA0070 AS D70 INNER JOIN
													  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
													  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
													  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
								WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
										--AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
							) AS Res0

						FROM         dbo.DATA0005 INNER JOIN
											  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
											  dbo.DATA0017 INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
											  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
											  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
											  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
						WHERE    
								(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20)
								AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@para2 AS INT)) --YEAR(GETDATE()))
						UNION ALL
						--Debit/Belastung
						SELECT  
							dbo.DATA0017.RKEY AS D17RKEY,
							--dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
							(-1)*dbo.DATA0132.AMOUNT AS Res0

						FROM         dbo.DATA0132 INNER JOIN
							  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
							  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
							  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
							  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
							  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
							  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
							  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
						WHERE      
									(dbo.DATA0070.STATUS = 1)
									AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
									AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@para2 AS INT)) --YEAR(GETDATE()))

					) AS myTblJ0
					WHERE D17RKEY=D17_RKEY --AND SUPPLIER_NAME = Lieferant
				), 0) AS EKVol_J0

			FROM
			(
				SELECT DISTINCT 
					dbo.DATA0017.RKEY AS D17_RKEY
					--dbo.DATA0023.SUPPLIER_NAME AS Lieferant

				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE    
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para1)   
						AND (dbo.DATA0095.TRAN_TP = 5) 
						AND (YEAR(dbo.DATA0095.ENTERED_DATE) > YEAR(GETDATE())-5)
						AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
							OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
			) AS myTblLief
			), 0)

		SET @EKVol_Grp =
			ISNULL((
				SELECT
					SUM(ISNULL(Res0, 0)) AS ResSum0
				FROM
				(
					--Lieferung T , Lieferung
					SELECT  
						dbo.DATA0017.RKEY AS D17RKEY,
						--dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
												ELSE 
													ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
												  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						) 
						AS Res0

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0095.TRAN_TP = 5)
							AND (dbo.DATA0017.PROD_CODE_SELL_PTR = @ArtGrp_PTR)  
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
							AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@para2 AS INT)) --YEAR(GETDATE()))
					UNION ALL
					--Retourniert
					SELECT 
						dbo.DATA0017.RKEY AS D17RKEY,
						--dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
												ELSE 
													(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
												  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									--AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
						) AS Res0

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20)
							AND (dbo.DATA0017.PROD_CODE_SELL_PTR = @ArtGrp_PTR)  
							AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@para2 AS INT)) --YEAR(GETDATE()))
					UNION ALL
					--Debit/Belastung
					SELECT  
						dbo.DATA0017.RKEY AS D17RKEY,
						--dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						(-1)*dbo.DATA0132.AMOUNT AS Res0

					FROM         dbo.DATA0132 INNER JOIN
						  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
						  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
					WHERE      
								(dbo.DATA0070.STATUS = 1)
								AND (dbo.DATA0017.PROD_CODE_SELL_PTR = @ArtGrp_PTR)  
								AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
								AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@para2 AS INT)) --YEAR(GETDATE()))

				) AS myTblJ0
			), 0)

		SET @EKVol_Gesamt =
			ISNULL((
				SELECT
					SUM(ISNULL(Res0, 0)) AS ResSum0
				FROM
				(
					--Lieferung T , Lieferung
					SELECT  
						dbo.DATA0017.RKEY AS D17RKEY,
						--dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
												ELSE 
													ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
												  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						) 
						AS Res0

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0095.TRAN_TP = 5)
							--AND (dbo.DATA0017.PROD_CODE_SELL_PTR = @ArtGrp_PTR)  
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
							AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@para2 AS INT)) --YEAR(GETDATE()))
					UNION ALL
					--Retourniert
					SELECT 
						dbo.DATA0017.RKEY AS D17RKEY,
						--dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
												ELSE 
													(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
												  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									--AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
						) AS Res0

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20)
							--AND (dbo.DATA0017.PROD_CODE_SELL_PTR = @ArtGrp_PTR)  
							AND (YEAR(dbo.DATA0095.ENTERED_DATE) = CAST(@para2 AS INT)) --YEAR(GETDATE()))
					UNION ALL
					--Debit/Belastung
					SELECT  
						dbo.DATA0017.RKEY AS D17RKEY,
						--dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						(-1)*dbo.DATA0132.AMOUNT AS Res0

					FROM         dbo.DATA0132 INNER JOIN
						  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
						  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
					WHERE      
								(dbo.DATA0070.STATUS = 1)
								--AND (dbo.DATA0017.PROD_CODE_SELL_PTR = @ArtGrp_PTR)  
								AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
								AND (YEAR(dbo.DATA0071.REQ_DATE) = CAST(@para2 AS INT)) --YEAR(GETDATE()))

				) AS myTblJ0
			), 0)


		SELECT 
			YEAR(GETDATE()) AS Jahr, 
			@EKVol_Art AS EKVol_Artikel, 
			@EKVol_Grp AS EKVol_Gruppe, 
			@EKVol_Gesamt AS EKVol_Gesamt,
			@EKVol_Art/@EKVol_Grp AS ProzGrp,
			@EKVol_Art/@EKVol_Gesamt AS ProzGesamt
	END

	IF @Case_ = 'ABCArtikelLieferantDetail2'
	BEGIN
		--DECLARE
		--	@para1 varchar(250)
		--SET @para1 = 'Wasserstoffperoxid 35%, wässerige Lösung'

		SELECT
			ISNULL(Jahr, 0) AS Jahr,
			ISNULL(DEKPreis, 0) AS DEKPreis,
			ISNULL(EKMenge, 0) AS EKMenge
		FROM
		(
			SELECT
				YEAR(GETDATE()) AS Jahr,
				CASE WHEN SUM(EKMenge)>0 THEN ISNULL(SUM(EKMenge*RPreis)/SUM(EKMenge), 0) ELSE 0 END AS DEKPreis,
				SUM(ISNULL(EKMenge, 0)) AS EKMenge
			FROM
			(
				--Lieferung T , Lieferung
				SELECT  
					dbo.DATA0017.RKEY AS D17RKEY,
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS EKMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE--/dbo.DATA0107.EX_RATE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis

				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE   dbo.DATA0017.INV_PART_DESCRIPTION = @para1 
						AND (dbo.DATA0095.TRAN_TP = 5)
						AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
							OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
						AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE()))
				UNION ALL
				--Retourniert
				SELECT 
					dbo.DATA0017.RKEY AS D17RKEY,
					-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH) AS EKMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis
						--FROM         dbo.DATA0070 AS D70 INNER JOIN
						--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
						--					  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis

				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE   dbo.DATA0017.INV_PART_DESCRIPTION = @para1 
						AND (dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20)
						AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE()))
				UNION ALL
				--Debit/Belastung
				SELECT  
					dbo.DATA0017.RKEY AS D17RKEY,
					(-1)*dbo.DATA0132.AMOUNT AS EKMenge,
					dbo.DATA0108.PRICE AS RPreis

				FROM         dbo.DATA0132 INNER JOIN
					  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
					  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
					  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
					  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
					  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
					  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
					  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
					  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE       dbo.DATA0017.INV_PART_DESCRIPTION = @para1
							AND (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND (YEAR(dbo.DATA0071.REQ_DATE) = YEAR(GETDATE()))

			) AS myTblJ0
			----------------------------------------------------------------------------------------------------------
			UNION ALL
			----------------------------------------------------------------------------------------------------------
			SELECT
				YEAR(GETDATE())-1 AS Jahr,
				CASE WHEN SUM(EKMenge)>0 THEN ISNULL(SUM(EKMenge*RPreis)/SUM(EKMenge), 0) ELSE 0 END AS DEKPreis,
				SUM(ISNULL(EKMenge, 0)) AS EKMenge
			FROM
			(
				--Lieferung T , Lieferung
				SELECT  
					dbo.DATA0017.RKEY AS D17RKEY,
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS EKMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0)
									END
						END AS RPreis
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis

				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE   dbo.DATA0017.INV_PART_DESCRIPTION = @para1 
						AND (dbo.DATA0095.TRAN_TP = 5)
						AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
							OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
						AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-1)
				UNION ALL
				--Retourniert
				SELECT 
					dbo.DATA0017.RKEY AS D17RKEY,
					-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH) AS EKMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0) 
									END
						END AS RPreis
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis

				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE   dbo.DATA0017.INV_PART_DESCRIPTION = @para1 
						AND (dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20)
						AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-1)
				UNION ALL
				--Debit/Belastung
				SELECT  
					dbo.DATA0017.RKEY AS D17RKEY,
					(-1)*dbo.DATA0132.AMOUNT AS EKMenge,
					dbo.DATA0108.PRICE AS RPreis

				FROM         dbo.DATA0132 INNER JOIN
					  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
					  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
					  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
					  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
					  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
					  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
					  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
					  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE       dbo.DATA0017.INV_PART_DESCRIPTION = @para1
							AND (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND (YEAR(dbo.DATA0071.REQ_DATE) = YEAR(GETDATE())-1)

			) AS myTblJ1
			----------------------------------------------------------------------------------------------------------
			UNION ALL
			----------------------------------------------------------------------------------------------------------
			SELECT
				YEAR(GETDATE())-2 AS Jahr,
				CASE WHEN SUM(EKMenge)>0 THEN ISNULL(SUM(EKMenge*RPreis)/SUM(EKMenge), 0) ELSE 0 END AS DEKPreis,
				SUM(ISNULL(EKMenge, 0)) AS EKMenge
			FROM
			(
				--Lieferung T , Lieferung
				SELECT  
					dbo.DATA0017.RKEY AS D17RKEY,
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS EKMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0)
									END
						END AS RPreis
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis

				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE   dbo.DATA0017.INV_PART_DESCRIPTION = @para1 
						AND (dbo.DATA0095.TRAN_TP = 5)
						AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
							OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
						AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-2)
				UNION ALL
				--Retourniert
				SELECT 
					dbo.DATA0017.RKEY AS D17RKEY,
					-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH) AS EKMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0) 
									END
						END AS RPreis
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis

				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE   dbo.DATA0017.INV_PART_DESCRIPTION = @para1 
						AND (dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20)
						AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-2)
				UNION ALL
				--Debit/Belastung
				SELECT  
					dbo.DATA0017.RKEY AS D17RKEY,
					(-1)*dbo.DATA0132.AMOUNT AS EKMenge,
					dbo.DATA0108.PRICE AS RPreis

				FROM         dbo.DATA0132 INNER JOIN
					  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
					  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
					  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
					  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
					  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
					  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
					  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
					  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE       dbo.DATA0017.INV_PART_DESCRIPTION = @para1
							AND (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND (YEAR(dbo.DATA0071.REQ_DATE) = YEAR(GETDATE())-2)

			) AS myTblJ2
			----------------------------------------------------------------------------------------------------------
			UNION ALL
			----------------------------------------------------------------------------------------------------------
			SELECT
				YEAR(GETDATE())-3 AS Jahr,
				CASE WHEN SUM(EKMenge)>0 THEN ISNULL(SUM(EKMenge*RPreis)/SUM(EKMenge), 0) ELSE 0 END AS DEKPreis,
				SUM(ISNULL(EKMenge, 0)) AS EKMenge
			FROM
			(
				--Lieferung T , Lieferung
				SELECT  
					dbo.DATA0017.RKEY AS D17RKEY,
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS EKMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0)
									END
						END AS RPreis
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis

				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE   dbo.DATA0017.INV_PART_DESCRIPTION = @para1 
						AND (dbo.DATA0095.TRAN_TP = 5)
						AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
							OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
						AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-3)
				UNION ALL
				--Retourniert
				SELECT 
					dbo.DATA0017.RKEY AS D17RKEY,
					-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH) AS EKMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0) 
									END
						END AS RPreis
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis

				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE   dbo.DATA0017.INV_PART_DESCRIPTION = @para1 
						AND (dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20)
						AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-3)
				UNION ALL
				--Debit/Belastung
				SELECT  
					dbo.DATA0017.RKEY AS D17RKEY,
					(-1)*dbo.DATA0132.AMOUNT AS EKMenge,
					dbo.DATA0108.PRICE AS RPreis

				FROM         dbo.DATA0132 INNER JOIN
					  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
					  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
					  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
					  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
					  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
					  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
					  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
					  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE       dbo.DATA0017.INV_PART_DESCRIPTION = @para1
							AND (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND (YEAR(dbo.DATA0071.REQ_DATE) = YEAR(GETDATE())-3)

			) AS myTblJ3
			----------------------------------------------------------------------------------------------------------
			UNION ALL
			----------------------------------------------------------------------------------------------------------
			SELECT
				YEAR(GETDATE())-4 AS Jahr,
				CASE WHEN SUM(EKMenge)>0 THEN ISNULL(SUM(EKMenge*RPreis)/SUM(EKMenge), 0) ELSE 0 END AS DEKPreis,
				SUM(ISNULL(EKMenge, 0)) AS EKMenge
			FROM
			(
				--Lieferung T , Lieferung
				SELECT  
					dbo.DATA0017.RKEY AS D17RKEY,
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS EKMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0)
									END
						END AS RPreis
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis

				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE   dbo.DATA0017.INV_PART_DESCRIPTION = @para1 
						AND (dbo.DATA0095.TRAN_TP = 5)
						AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
							OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
						AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-4)
				UNION ALL
				--Retourniert
				SELECT 
					dbo.DATA0017.RKEY AS D17RKEY,
					-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH) AS EKMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0) 
									END
						END AS RPreis
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis

				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
				WHERE   dbo.DATA0017.INV_PART_DESCRIPTION = @para1 
						AND (dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20)
						AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-4)
				UNION ALL
				--Debit/Belastung
				SELECT  
					dbo.DATA0017.RKEY AS D17RKEY,
					(-1)*dbo.DATA0132.AMOUNT AS EKMenge,
					dbo.DATA0108.PRICE AS RPreis

				FROM         dbo.DATA0132 INNER JOIN
					  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
					  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
					  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
					  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
					  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
					  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
					  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
					  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE       dbo.DATA0017.INV_PART_DESCRIPTION = @para1
							AND (dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND (YEAR(dbo.DATA0071.REQ_DATE) = YEAR(GETDATE())-4)

			) AS myTblJ2

		) AS myTblMain
		ORDER BY Jahr DESC
	END

	IF @Case_ = 'ABCArtikelLieferantDetail1'
	BEGIN
		--DECLARE
		--	@para1 varchar(250)
		--SET @para1 = 'Wasserstoffperoxid 35%, wässerige Lösung'

		SELECT
			@para1 AS Artikel, 
			Lieferant,
			(
				SELECT
				SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
				FROM
				(
					SELECT     
						CASE 
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE
							ELSE
								CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
									ELSE D17.STD_COST
								END
						END AS Res_DREPreis,
						(D95.QUANTITY/D17.STOCK_PURCH) AS Menge,
						D95.INVT_PTR,
						D23.SUPPLIER_NAME
					FROM         dbo.DATA0095 AS D95 INNER JOIN
						  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
						  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
						  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
						  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY INNER JOIN
						  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
						  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
					WHERE     
						(D95.TRAN_TP = 5) 
						AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
				) AS myDPreisTbl
				WHERE
						INVT_PTR=D17_RKEY AND SUPPLIER_NAME = Lieferant
				GROUP BY
					INVT_PTR,
					SUPPLIER_NAME
			) AS Preis_gewichtet12Mon_Lief,
		(
			SELECT
			SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
			FROM
			(
				SELECT     
					CASE 
						WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE
						ELSE
							CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
								ELSE D17.STD_COST
							END
					END AS Res_DREPreis,
					(D95.QUANTITY/D17.STOCK_PURCH) AS Menge,
					D95.INVT_PTR,
					D23.SUPPLIER_NAME
				FROM         dbo.DATA0095 AS D95 INNER JOIN
					  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
					  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
					  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
					  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY INNER JOIN
					  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
					  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
				WHERE     
					(D95.TRAN_TP = 5) 
					AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
			) AS myDPreisTbl
			WHERE
					INVT_PTR=D17_RKEY
			GROUP BY
				INVT_PTR
		) AS Preis_gewichtet12Mon,

		ISNULL((SELECT QUAN_ON_HAND FROM dbo.DATA0017 WHERE dbo.DATA0017.INV_PART_DESCRIPTION = @para1), 0) AS QUAN_ON_HAND,

		ISNULL((SELECT CONSIGN_ONHAND_QTY FROM dbo.DATA0017 WHERE dbo.DATA0017.INV_PART_DESCRIPTION = @para1), 0) AS CONSIGN_ONHAND_QTY,
			ISNULL((
				SELECT
					SUM(ISNULL(Res0, 0)) AS ResSum0
				FROM
				(
					--Lieferung T , Lieferung
					SELECT  
						dbo.DATA0017.RKEY AS D17RKEY,
						dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
												ELSE 
													ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
												  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
										AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
						) 
						AS Res0

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0095.TRAN_TP = 5)
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
							AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE()))
					UNION ALL
					--Retourniert
					SELECT 
						dbo.DATA0017.RKEY AS D17RKEY,
						dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
												ELSE 
													(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
												  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
						) AS Res0

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20)
							AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE()))
					UNION ALL
					--Debit/Belastung
					SELECT  
						dbo.DATA0017.RKEY AS D17RKEY,
						dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						(-1)*dbo.DATA0132.AMOUNT AS Res0

					FROM         dbo.DATA0132 INNER JOIN
						  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
						  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
					WHERE      
								(dbo.DATA0070.STATUS = 1)
								AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
								AND (YEAR(dbo.DATA0071.REQ_DATE) = YEAR(GETDATE()))

				) AS myTblJ0
				WHERE D17RKEY=D17_RKEY AND SUPPLIER_NAME = Lieferant
			), 0) AS EKVol_J0,
			ISNULL((
				SELECT
					SUM(ISNULL(Res1, 0)) AS ResSum1
				FROM
				(
					--Lieferung T , Lieferung
					SELECT  
						dbo.DATA0017.RKEY AS D17RKEY,
						dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
												ELSE 
													ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
												  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
										AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
						) 
						AS Res1

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0095.TRAN_TP = 5)
							AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-1)
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
					UNION ALL
					--Retourniert
					SELECT 
						dbo.DATA0017.RKEY AS D17RKEY,
						dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
												ELSE 
													(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
												  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
						) AS Res1

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20)
							AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-1)
					UNION ALL
					--Debit/Belastung
					SELECT  
						dbo.DATA0017.RKEY AS D17RKEY,
						dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						(-1)*dbo.DATA0132.AMOUNT AS Res1

					FROM         dbo.DATA0132 INNER JOIN
						  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
						  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
					WHERE      
								(dbo.DATA0070.STATUS = 1)
								AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
								AND (YEAR(dbo.DATA0071.REQ_DATE) = YEAR(GETDATE())-1)
							
				) AS myTblJ1Min
				WHERE D17RKEY=D17_RKEY AND SUPPLIER_NAME = Lieferant
			), 0) AS EKVol_J1min,
			ISNULL((
				SELECT
					SUM(ISNULL(Res2, 0)) AS ResSum2
				FROM
				(
					--Lieferung T , Lieferung
					SELECT  
						dbo.DATA0017.RKEY AS D17RKEY,
						dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
												ELSE 
													ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
												  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
										AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
						) 
						AS Res2

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE     
							(dbo.DATA0095.TRAN_TP = 5)
							AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-2)
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
					UNION ALL
					--Retourniert
					SELECT 
						dbo.DATA0017.RKEY AS D17RKEY,
						dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
												ELSE 
													(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
												  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
						) AS Res2

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20)
							AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-2)
					UNION ALL
					--Debit/Belastung
					SELECT  
						dbo.DATA0017.RKEY AS D17RKEY,
						dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						(-1)*dbo.DATA0132.AMOUNT AS Res2

					FROM         dbo.DATA0132 INNER JOIN
						  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
						  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
					WHERE      
								(dbo.DATA0070.STATUS = 1)
								AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
								AND (YEAR(dbo.DATA0071.REQ_DATE) = YEAR(GETDATE())-2)
							
				) AS myTblJ2Min
				WHERE D17RKEY=D17_RKEY AND SUPPLIER_NAME = Lieferant
			), 0) AS EKVol_J2min,
			ISNULL((
				SELECT
					SUM(ISNULL(Res3, 0)) AS ResSum3
				FROM
				(
					--Lieferung T , Lieferung
					SELECT  
						dbo.DATA0017.RKEY AS D17RKEY,
						dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
												ELSE 
													ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
												  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
						) 
						AS Res3

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE      
							(dbo.DATA0095.TRAN_TP = 5)
							AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-3)
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
					UNION ALL
					--Retourniert
					SELECT 
						dbo.DATA0017.RKEY AS D17RKEY,
						dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
												ELSE 
													(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
												  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
						) AS Res3

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20)
							AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-3)
					UNION ALL
					--Debit/Belastung
					SELECT  
						dbo.DATA0017.RKEY AS D17RKEY,
						dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						(-1)*dbo.DATA0132.AMOUNT AS Res3

					FROM         dbo.DATA0132 INNER JOIN
						  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
						  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
					WHERE      
								(dbo.DATA0070.STATUS = 1)
								AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
								AND (YEAR(dbo.DATA0071.REQ_DATE) = YEAR(GETDATE())-3)
							
				) AS myTblJ3Min
				WHERE D17RKEY=D17_RKEY AND SUPPLIER_NAME = Lieferant
			), 0) AS EKVol_J3min,
			ISNULL((
				SELECT
					SUM(ISNULL(Res4, 0)) AS ResSum4
				FROM
				(
					--Lieferung T , Lieferung
					SELECT  
						dbo.DATA0017.RKEY AS D17RKEY,
						dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
												ELSE 
													ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
												  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
										AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
						) 
						AS Res4

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE      
							(dbo.DATA0095.TRAN_TP = 5)
							AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-4)
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
					UNION ALL
					--Retourniert
					SELECT 
						dbo.DATA0017.RKEY AS D17RKEY,
						dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
						(
							SELECT     TOP 1 
							CASE
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
									ELSE 
										CASE
											WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
												ELSE 
													(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
										END
							END AS RPreis
							FROM         dbo.DATA0070 AS D70 INNER JOIN
												  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
												  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
												  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
						) AS Res4

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20)
							AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-4)
					UNION ALL
					--Debit/Belastung
					SELECT  
						dbo.DATA0017.RKEY AS D17RKEY,
						dbo.DATA0023.SUPPLIER_NAME AS SUPPLIER_NAME,
						(-1)*dbo.DATA0132.AMOUNT AS Res4

					FROM         dbo.DATA0132 INNER JOIN
						  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
						  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
						  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
					WHERE      
								(dbo.DATA0070.STATUS = 1)
								AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
								AND (YEAR(dbo.DATA0071.REQ_DATE) = YEAR(GETDATE())-4)
							
				) AS myTblJ4Min
				WHERE D17RKEY=D17_RKEY AND SUPPLIER_NAME = Lieferant
			), 0) AS EKVol_J4min,
			ISNULL((
				SELECT SUM(dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)
				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
									  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
				WHERE     
					(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para1)   
					AND (dbo.DATA0095.TRAN_TP = 5) 
					AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE()))
					AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
						OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
					AND dbo.DATA0023.SUPPLIER_NAME = Lieferant
			), 0) AS NK_J0,
			ISNULL((
				SELECT SUM(dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)
				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
									  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
				WHERE     
					(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para1)   
					AND (dbo.DATA0095.TRAN_TP = 5) 
					AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-1)
					AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
						OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
					AND dbo.DATA0023.SUPPLIER_NAME = Lieferant
			), 0) AS NK_J1min,
			ISNULL((
				SELECT SUM(dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)
				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
									  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
				WHERE     
					(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para1)   
					AND (dbo.DATA0095.TRAN_TP = 5) 
					AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-2)
					AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
						OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
					AND dbo.DATA0023.SUPPLIER_NAME = Lieferant
			), 0) AS NK_J2min,
			ISNULL((
				SELECT SUM(dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)
				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
									  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
				WHERE     
					(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para1)   
					AND (dbo.DATA0095.TRAN_TP = 5) 
					AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-3)
					AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
						OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
					AND dbo.DATA0023.SUPPLIER_NAME = Lieferant
			), 0) AS NK_J3min,
			ISNULL((
				SELECT SUM(dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT)
				FROM         dbo.DATA0005 INNER JOIN
									  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
									  dbo.DATA0017 INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
									  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
									  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
				WHERE     
					(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para1)   
					AND (dbo.DATA0095.TRAN_TP = 5) 
					AND (YEAR(dbo.DATA0095.ENTERED_DATE) = YEAR(GETDATE())-4)
					AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
						OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
					AND dbo.DATA0023.SUPPLIER_NAME = Lieferant
			), 0) AS NK_J4min
		
		FROM
		(
			SELECT DISTINCT 
				dbo.DATA0017.RKEY AS D17_RKEY,
				dbo.DATA0023.SUPPLIER_NAME AS Lieferant

			FROM         dbo.DATA0005 INNER JOIN
								  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
								  dbo.DATA0017 INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
			WHERE    
					(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS = @para1)   
					AND (dbo.DATA0095.TRAN_TP = 5) 
					AND (YEAR(dbo.DATA0095.ENTERED_DATE) > YEAR(GETDATE())-5)
					AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
						OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
		) AS myTblLief
	END

	IF @Case_ = 'ABCArtikelLieferant'
	BEGIN
		--DECLARE
		--@para1 varchar(250),
		--@para2 varchar(250),
		--@para3 varchar(250),
		--@para4 varchar(250)
		--SET @para1 = '01.01.2013'
		--SET @para2 = '07.01.2014'
		--SET @para3 = '%' --'bimsmehl'

		DECLARE
		@para1VJ varchar(250),
		@para2VJ varchar(250)
		SET @para1VJ = SUBSTRING(@para1, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para1, 7, 4) AS INT)-1))
		SET @para2VJ = SUBSTRING(@para2, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para2, 7, 4) AS INT)-1))

		DECLARE @tblArtLief table (
									D17_RKEY NUMERIC(10, 0), 
									D23_RKEY NUMERIC(10, 0), 
									INV_PART_NUMBER char(20) null, 
									INV_PART_DESCRIPTION char(40) null, 
									Lieferant char(50) null,
									EK_Volume NUMERIC(10,2) ,
									EK_VolumeVJ NUMERIC(10,2) ,
									LMenge NUMERIC(10,2) ,
									UNIT_CODE char(5) null,
									DRPreis NUMERIC(10,3) ,
									Letzter_EK_Preis NUMERIC(10,3) ,
									letztes_LDatum smalldatetime ,
									AnzBestellungen int,
									DRWert NUMERIC(10,2),
									DLMenge NUMERIC(10,2)
									)

		INSERT @tblArtLief(
									D17_RKEY, 
									D23_RKEY, 
									INV_PART_NUMBER, 
									INV_PART_DESCRIPTION, 
									Lieferant,
									EK_Volume,
									EK_VolumeVJ,
									LMenge,
									UNIT_CODE,
									DRPreis,
									Letzter_EK_Preis,
									letztes_LDatum,
									AnzBestellungen,
									DRWert,
									DLMenge
						)

			SELECT 
				--BTyp, 
				--MAX(D95_PTR) AS D95_PTR,
				D17_RKEY,  
				D23_RKEY, 
				INV_PART_NUMBER, 
				INV_PART_DESCRIPTION,
				Lieferant,
				CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_Volume,
				0 AS EK_VolumeVJ,
				CAST(SUM(LMenge) AS NUMERIC(10, 2)) AS LMenge,
				UNIT_CODE,
				--CAST(AVG(RPreis) AS NUMERIC(10, 3)) AS DRPreis,
				--ISNULL(SUM(LMenge*RPreis)/SUM(LMenge), 0) AS DRPreis,
				CASE WHEN SUM(LMenge)>0 THEN ISNULL(SUM(LMenge*RPreis)/SUM(LMenge), 0) ELSE 0 END AS DRPreis,
				CAST((
					SELECT     TOP 1 dbo.DATA0108.PRICE
					--FROM         dbo.DATA0017 AS D17 INNER JOIN
					--					  dbo.DATA0071 ON D17.RKEY = dbo.DATA0071.INVT_PTR INNER JOIN
					--					  dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
					FROM         dbo.DATA0017 AS D17 INNER JOIN
                      dbo.DATA0071 ON D17.RKEY = dbo.DATA0071.INVT_PTR INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
                      dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
                      dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE     (dbo.DATA0071.PRICE > 0) AND (D17.RKEY = D17_RKEY) AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
					ORDER BY dbo.DATA0071.DEL_DATE DESC
				) AS NUMERIC(10, 3)) AS Letzter_EK_Preis,

				--MAX(LDatum) AS letztes_LDatum,
				--CONVERT(varchar(10), MAX(LDatum), 104) AS letztes_LDatum,
				(
					SELECT CONVERT(varchar(10), MAX(ResDatum), 104) AS RecMaxDatum
					FROM
					(
						SELECT   
							--CONVERT(varchar(10), dbo.DATA0095.ENTERED_DATE, 104) AS ResDatum,
							dbo.DATA0095.ENTERED_DATE AS ResDatum,
							dbo.DATA0017.RKEY AS D17ID,
							dbo.DATA0023.SUPPLIER_NAME
						FROM         
							dbo.DATA0095 INNER JOIN
							dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
							dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
							dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
							dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
						WHERE    
							--(dbo.DATA0017.RKEY = D17_RKEY)
							--AND 
							(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
						UNION ALL
						SELECT
							--CONVERT(varchar(10), dbo.DATA0341.TRAN_DATE, 104) AS ResDatum,
							dbo.DATA0341.TRAN_DATE AS ResDatum,
							dbo.DATA0017.RKEY AS D17ID,
							dbo.DATA0023.SUPPLIER_NAME
						FROM        
							dbo.DATA0017 INNER JOIN
							dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
							dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
							dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
							dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
						WHERE     
							--(dbo.DATA0017.RKEY = D17_RKEY)
							--AND 
							(dbo.DATA0341.TRAN_TP=1)
							--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
							AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))
					) AS myTblMaxDatum
					WHERE D17ID = D17_RKEY AND SUPPLIER_NAME = Lieferant
				) AS letztes_LDatum,

				SUM(AnzBestellungen) AS AnzBestellungen,
				CAST(AVG(RWert) AS NUMERIC(10, 2)) AS DRWert,
				CAST(AVG(LMenge) AS NUMERIC(10, 2)) AS DLMenge

			FROM (
				--Lieferung T , Lieferung
				SELECT  
					'GGP' As BTyp,		
					dbo.DATA0095.RKEY AS D95_PTR, 
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION,
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant, 
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					dbo.DATA0095.ENTERED_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND
							(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


				UNION ALL

				--Retourniert
				SELECT 
					'GGP' As BTyp, 
					dbo.DATA0095.RKEY AS D95_PTR, 
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					(-1)*dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RPreis,
					-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS RWert,
					dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					dbo.DATA0095.ENTERED_DATE AS LDatum,
					0 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND
							(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--offene Bestellungen
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE     
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND 
							(dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--Debit/Belastung
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					dbo.DATA0108.PRICE AS RPreis,
					(-1)*dbo.DATA0132.AMOUNT AS RWert,
					dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0132 INNER JOIN
                      dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
                      dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
                      dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
                      dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
                      dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
                      dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
                      dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE      
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND
							(dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--Bestellungen in Klärung 
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)	
					) AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND
							(dbo.DATA0070.STATUS = 5)
							--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--Konsi Bestellungen
				SELECT  
					'Konsi' As BTyp,
					dbo.DATA0341.RKEY AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS NK,
					dbo.DATA0341.TRAN_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						AND
						dbo.DATA0341.TRAN_TP=1
						--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
						AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

				UNION ALL 

				--rückgängig Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					dbo.DATA0341.RKEY AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION,
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant, 
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS NK,
					dbo.DATA0341.TRAN_DATE AS LDatum,
					0 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						AND
						dbo.DATA0341.TRAN_TP=15
						--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--offene Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0467.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert, 
					0 AS NK,
					dbo.DATA0467.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE     
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						AND
						(dbo.DATA0466.STATUS=1)
						AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
						--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--liegende Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0467.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert, 
					0 AS NK,
					dbo.DATA0467.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0467 INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE     
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						AND
						(dbo.DATA0466.STATUS=4)
						--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--retournierte Konsi-Bestellungen
				SELECT  
					'Konsi' As BTyp,
					dbo.DATA0341.RKEY AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					(-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RPreis, 
					CASE
						WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
							ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
					END AS RWert, 
					0 AS NK,
					dbo.DATA0467.REQ_DATE AS LDatum,
					0 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0017 INNER JOIN
									  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
				WHERE     
						(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
						AND
						dbo.DATA0341.TRAN_TP=2
						--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
						AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
						AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
						AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

			)  AS ResTbl
			GROUP BY
				D17_RKEY, 
 				D23_RKEY,
				INV_PART_NUMBER, 
				INV_PART_DESCRIPTION,
				Lieferant,

				UNIT_CODE,
				QUAN_ON_HAND,
				CONSIGN_ONHAND_QTY,
				LetzterLieferant,
				AnzLieferanten
			--ORDER BY INV_PART_NUMBER, INV_PART_DESCRIPTION --SUM(CAST(RWert AS NUMERIC(10, 2))) DESC --INV_PART_NUMBER, INV_PART_DESCRIPTION , BTyp


			--UPDATE
			----------------------------------
			UPDATE tblArtLief
			SET tblArtLief.EK_VolumeVJ = myTblEK_VolumeVJ.EK_VolumeVJ
			FROM
			@tblArtLief AS tblArtLief,
			(
						SELECT 
							D17_RKEY,  
							D23_RKEY,
							CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ

						FROM (
							--Lieferung T , Lieferung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJ, 103))
										AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
											OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


							UNION ALL

							--Retourniert
							SELECT 
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--offene Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								0 AS RWert

							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE     
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND 
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--Debit/Belastung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								(-1)*dbo.DATA0132.AMOUNT AS RWert

							FROM         dbo.DATA0132 INNER JOIN
								  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--Bestellungen in Klärung 
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								0 AS RWert
								
							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 5)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--Konsi Bestellungen
							SELECT  

								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									dbo.DATA0341.TRAN_TP=1
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJ, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJ, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

							UNION ALL 

							--rückgängig Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY, 
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									dbo.DATA0341.TRAN_TP=15
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJ, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--offene Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									(dbo.DATA0466.STATUS=1)
									AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--liegende Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									(dbo.DATA0466.STATUS=4)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--retournierte Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									dbo.DATA0341.TRAN_TP=2
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJ, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJ, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						)  AS ResTbl
						GROUP BY
							D17_RKEY, 
							D23_RKEY
			) AS myTblEK_VolumeVJ
			WHERE 
			tblArtLief.D17_RKEY = myTblEK_VolumeVJ.D17_RKEY
			AND
			tblArtLief.D23_RKEY = myTblEK_VolumeVJ.D23_RKEY
			----------------------------------

			--INSERT
			----------------------------------
			INSERT @tblArtLief(
										D17_RKEY, 
										D23_RKEY, 
										INV_PART_NUMBER, 
										INV_PART_DESCRIPTION, 
										Lieferant,
										EK_Volume,
										EK_VolumeVJ,
										LMenge,
										UNIT_CODE,
										DRPreis,
										Letzter_EK_Preis,
										letztes_LDatum,
										AnzBestellungen,
										DRWert,
										DLMenge
							)
			--UPDATE tblArtLief
			--SET tblArtLief.EK_VolumeVJ = myTblEK_VolumeVJ.EK_VolumeVJ
			SELECT
				myTblEK_VolumeVJ.D17_RKEY,
				myTblEK_VolumeVJ.D23_RKEY,
				myTblEK_VolumeVJ.INV_PART_NUMBER,
				myTblEK_VolumeVJ.INV_PART_DESCRIPTION,
				myTblEK_VolumeVJ.Lieferant,
				0,
				myTblEK_VolumeVJ.EK_VolumeVJ,
				0,
				'',
				0,
				0,
				null,
				0,
				0,
				0	

			FROM
			--@tblArtLief AS tblArtLief,
			(
						SELECT 
							D17_RKEY,  
							D23_RKEY,
							INV_PART_NUMBER, 
							INV_PART_DESCRIPTION, 
							Lieferant,
							CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ

						FROM (
							--Lieferung T , Lieferung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJ, 103))
										AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
											OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


							UNION ALL

							--Retourniert
							SELECT 
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN dbo.DATA0108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis

									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--offene Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE     
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND 
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--Debit/Belastung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								(-1)*dbo.DATA0132.AMOUNT AS RWert

							FROM         dbo.DATA0132 INNER JOIN
								  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--Bestellungen in Klärung 
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert
								
							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 5)
										--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--Konsi Bestellungen
							SELECT  

								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									dbo.DATA0341.TRAN_TP=1
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJ, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJ, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

							UNION ALL 

							--rückgängig Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY, 
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									dbo.DATA0341.TRAN_TP=15
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJ, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--offene Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									(dbo.DATA0466.STATUS=1)
									AND (dbo.DATA0467.QUAN_RECD<dbo.DATA0467.QUAN_ORD)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--liegende Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert

							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									(dbo.DATA0466.STATUS=4)
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0467.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
									AND (dbo.DATA0467.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--retournierte Konsi-Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								CASE
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 THEN (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*dbo.DATA0467.PRICE
										ELSE (SELECT TOP 1 (-1)*dbo.DATA0341.QUANTITY/dbo.DATA0017.STOCK_PURCH*ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
								END AS RWert

							FROM         dbo.DATA0017 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
							WHERE     
									(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
									AND
									dbo.DATA0341.TRAN_TP=2
									--AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
									AND (dbo.DATA0341.TRAN_DATE >= CONVERT(DATETIME, @para1VJ, 103))
									AND (dbo.DATA0341.TRAN_DATE <= CONVERT(DATETIME, @para2VJ, 103))
									AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))

						)  AS ResTbl
						GROUP BY
							D17_RKEY, 
							D23_RKEY,
							INV_PART_NUMBER, 
							INV_PART_DESCRIPTION, 
							Lieferant
			) AS myTblEK_VolumeVJ
			WHERE 
			STR(myTblEK_VolumeVJ.D17_RKEY) + ';' + STR(myTblEK_VolumeVJ.D23_RKEY) Not In (SELECT STR(tblArtLief .D17_RKEY) + ';' + STR(tblArtLief .D23_RKEY) FROM @tblArtLief AS tblArtLief )
			--tblArtLief.D17_RKEY = myTblEK_VolumeVJ.D17_RKEY
			--AND
			--tblArtLief.D23_RKEY = myTblEK_VolumeVJ.D23_RKEY
			----------------------------------


			SELECT
			ISNULL(EK_Volume_ArtGesamt, 0) AS EK_Volume_ArtGesamt,
			--ISNULL(EK_Volume/EK_Volume_TOTAL*100, 0) AS Proz_Anteil,
			CASE WHEN EK_Volume_TOTAL>0 THEN ISNULL(EK_Volume/EK_Volume_TOTAL*100, 0) ELSE 0 END AS Proz_Anteil,
			--D17_RKEY, 
			INV_PART_NUMBER, 
			INV_PART_DESCRIPTION, 
			Lieferant,
			ISNULL(EK_Volume, 0) AS EK_Volume,
			ISNULL(EK_VolumeVJ, 0) AS EK_VolumeVJ,
			ISNULL(LMenge, 0) AS LMenge,
			UNIT_CODE,
			ISNULL(DRPreis, 0) AS DRPreis,
			ISNULL(Letzter_EK_Preis, 0) AS Letzter_EK_Preis,
			--letztes_LDatum,
			--CONVERT(varchar(10), letztes_LDatum, 104) AS letztes_LDatum,
			CASE WHEN ISNULL(letztes_LDatum, '')='' THEN '' ELSE CONVERT(varchar(10), letztes_LDatum, 104) END AS letztes_LDatum,
			ISNULL(AnzBestellungen, 0) AS AnzBestellungen,
			ISNULL(DRWert, 0) AS DRWert,
			ISNULL(DLMenge, 0) AS DLMenge
			FROM
			(
				SELECT
				(SELECT TOP 1 SUM(EK_Volume) FROM @tblArtLief AS myTmpTblArtLief WHERE myTmpTblArtLief.D17_RKEY = myTmpTblArtLiefMain.D17_RKEY) AS EK_Volume_ArtGesamt,
				(SELECT TOP 1 SUM(EK_Volume) FROM @tblArtLief AS myTmpTblArtLief) AS EK_Volume_TOTAL,
				* 
				FROM @tblArtLief AS myTmpTblArtLiefMain --ORDER BY INV_PART_NUMBER, INV_PART_DESCRIPTION
			) AS tbl
			ORDER BY EK_Volume_ArtGesamt DESC, INV_PART_DESCRIPTION, EK_Volume DESC
	END

	IF @Case_ = 'ABC_Lieferantenliste'
	BEGIN
		SELECT DISTINCT dbo.DATA0023.SUPPLIER_NAME --, dbo.DATA0023.CODE 
		FROM dbo.DATA0023 ORDER BY dbo.DATA0023.SUPPLIER_NAME --, dbo.DATA0023.CODE
	END

	IF @Case_ = 'ABCArtikelMaterialArt'
	BEGIN
		SELECT
			Dicke,
			Kaschierung,
			Materialart,
			D_P,
			TG,
			gefuellt,
			restliche_Codierung,
			m2,
			Lieferant,
			EK_Vol,
			CAST(EK_Vol/m2 AS NUMERIC(10, 3)) AS m2_DPreis,
			EK_Vol_Gesamt,
			EK_m2_Gesamt,
			EK_Vol_Gesamt/EK_m2_Gesamt AS m2_d_Preis
		FROM
		(
		SELECT
		--INV_PART_NUMBER,
		--INV_PART_DESCRIPTION,
			Artikelname,
			Dicke,
			Kaschierung,
			Materialart,
			D_P,
			TG,
			gefuellt,
			restliche_Codierung,
			CAST(SUM(ISNULL(m2, 0)) AS NUMERIC(10, 2)) AS m2,
			Lieferant,
			--CAST(SUM(ISNULL(EK_Preis, 0)*ISNULL(Liefermenge, 0))/SUM(Liefermenge) AS NUMERIC(10, 3)) AS D_EK_Preis,
			--CAST(SUM(ISNULL(Liefermenge, 0)) AS NUMERIC(10, 2)) AS Liefermenge,
			CAST(SUM(ISNULL(EK_Vol, 0)) AS NUMERIC(10, 2)) AS EK_Vol,
			(
				SELECT TOP 1 SUM(RES) AS Res_
				FROM
				(
					SELECT
							(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH *dbo.DATA0071.PRICE) AS RES,
							CASE 
								WHEN LEN(dbo.DATA0017.INV_PART_NUMBER)>15 THEN  RTRIM(SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 1, 8)) + '_' + LTRIM(SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 12, LEN(dbo.DATA0017.INV_PART_NUMBER)-11)) 
								ELSE 'XXXXXXXXXXXXXXX'
							END AS Art
					FROM         dbo.DATA0107 INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
								  dbo.DATA0095 INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
					WHERE     
								(dbo.DATA0095.TRAN_TP = 5) 
								AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103)) 
								AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103)) 
								AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
									OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
								AND ISNUMERIC(dbo.DATA0017.ANALYSIS_CODE1)=1
								AND ISNULL(dbo.DATA0017.ANALYSIS_CODE2, '')<>''
				) AS myVolTbl
				WHERE
					myVolTbl.Art = Artikelname 
			) AS EK_Vol_Gesamt,
			(
				SELECT TOP 1 SUM(RES) AS Res_
				FROM
				(
					SELECT
							CAST(dbo.DATA0095.QUANTITY*CAST(REPLACE(dbo.DATA0017.ANALYSIS_CODE5, ',', '.') AS NUMERIC(10, 3)) AS NUMERIC(10, 3)) AS RES,
							CASE 
								WHEN LEN(dbo.DATA0017.INV_PART_NUMBER)>15 THEN  RTRIM(SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 1, 8)) + '_' + LTRIM(SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 12, LEN(dbo.DATA0017.INV_PART_NUMBER)-11)) 
								ELSE 'XXXXXXXXXXXXXXX'
							END AS Art
					FROM         dbo.DATA0107 INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
								  dbo.DATA0095 INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
					WHERE     
								(dbo.DATA0095.TRAN_TP = 5) 
								AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103)) 
								AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103)) 
								AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
									OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
								AND ISNUMERIC(dbo.DATA0017.ANALYSIS_CODE1)=1
								AND ISNULL(dbo.DATA0017.ANALYSIS_CODE2, '')<>''
				) AS myVolTbl
				WHERE
					myVolTbl.Art = Artikelname 
			) AS EK_m2_Gesamt

		FROM
		(
			SELECT     
		--dbo.DATA0017.INV_PART_NUMBER,
		--dbo.DATA0017.INV_PART_DESCRIPTION,
				--dbo.DATA0017.INV_PARt_DESCRIPTION,
				--SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 1, 8) + '_' + SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 12, LEN(dbo.DATA0017.INV_PART_NUMBER)-11) AS Artikelname,
				--CASE WHEN SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 2, 1)='D' THEN 'doppelseitig' 
				--		ELSE
				--		CASE WHEN SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 2, 1)='E' THEN 'einseitig'
				--			ELSE 'unkaschiert'
				--		END
				--END AS KaschTyp,
				--SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 3, 3) AS D,
				SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 1, 8) + '_' + SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 12, LEN(dbo.DATA0017.INV_PART_NUMBER)-11) AS Artikelname,
				CASE
					WHEN ISNUMERIC(SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 3, 3))=1 THEN
							CAST(CAST(SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 3, 3) AS NUMERIC(10, 0))/100 AS NUMERIC(10, 2))
						ELSE
							0 --SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 3, 3)
				END AS Dicke,
				CASE WHEN SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 2, 1)='D' THEN 
							SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 6, 3) + '/' + SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 6, 3)
						ELSE
						CASE WHEN SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 2, 1)='E' THEN 
								SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 6, 3) + '/--' 
							ELSE '--/--'
						END
				END AS Kaschierung,
				CASE WHEN SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 12, 2)='F4' THEN 'FR4' ELSE SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 12, 2) END AS Materialart,
				CASE WHEN SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 14, 1)='D' THEN 'dicy' 
						ELSE 
						CASE WHEN SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 14, 1)='P' THEN 'phenolisch'
							ELSE SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 14, 1)
						END
				END AS D_P,
				CASE WHEN SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 15, 1)='3' THEN 'TG130' 
						ELSE 
						CASE WHEN SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 15, 1)='5' THEN 'TG150'
							ELSE 
							CASE WHEN SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 15, 1)='7' THEN 'TG170'
								ELSE SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 15, 1)
							END
						END
				END AS TG,
				CASE WHEN SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 16, 1)='0' THEN 'nicht gefüllt' 
						ELSE 
						CASE WHEN SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 16, 1)='1' THEN 'gefüllt'
							ELSE SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 16, 1)
						END
				END AS gefuellt,
				SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 17, 3) AS restliche_Codierung,
				--SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 6, 3) AS Kaschierung,
				CAST(dbo.DATA0095.QUANTITY*CAST(REPLACE(dbo.DATA0017.ANALYSIS_CODE5, ',', '.') AS NUMERIC(10, 3)) AS NUMERIC(10, 3)) AS m2,
				dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
				dbo.DATA0108.PRICE AS EK_Preis,
				dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS Liefermenge,
				dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH  * dbo.DATA0071.PRICE AS EK_Vol

				--SUBSTRING(dbo.DATA0017.INV_PART_NUMBER, 1, 8) AS Dicke,
				

				--ISNULL(
				--		(	
				--			SELECT     TOP 1 RKEY
				--			FROM         dbo.DATA0050
				--			WHERE     (RTRIM(CUSTOMER_PART_NUMBER) + '.' + LTRIM(CP_REV) = SUBSTRING(dbo.DATA0017.INV_PART_NUMBER,3,5) + '.' + CASE WHEN ISNULL(SUBSTRING(dbo.DATA0017.INV_PART_NUMBER,9,3), '')='' THEN '300' ELSE SUBSTRING(dbo.DATA0017.INV_PART_NUMBER,9,3) END)
				--		)
				--, 0) AS D50_PTR,
				----dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH  * dbo.DATA0071.PRICE AS Wert
				--dbo.DATA0108.PRICE AS RE_Preis,
				--dbo.DATA0071.QUAN_RECD AS Erhalten,
				--dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
				--dbo.DATA0023.CODE AS L_Code,
				--dbo.DATA0107.INVOICE_NO AS RE_NR,
				--dbo.DATA0070.PO_NUMBER AS BE_NR,
				--dbo.DATA0071.DEL_DATE AS LieferungGeplantAm,
				--dbo.DATA0095.TRAN_DATE AS eingeliefertAm,
				--dbo.DATA0095.QUANTITY AS geliefert

			FROM         dbo.DATA0107 INNER JOIN
						  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
						  dbo.DATA0095 INNER JOIN
						  dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
						  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
						  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
						  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
			WHERE     --(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE 'PCB%') 
						(dbo.DATA0095.TRAN_TP = 5) 
						--AND (dbo.DATA0070.PURCHASE_ORDER_TYPE = 0) 
						AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103)) 
						AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103)) 
						--AND (dbo.DATA0095.ENTERED_DATE < 12) 
						AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
							OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
						AND ISNUMERIC(dbo.DATA0017.ANALYSIS_CODE1)=1
						AND ISNULL(dbo.DATA0017.ANALYSIS_CODE2, '')<>''
		) AS myTbl
		GROUP BY
		--INV_PART_NUMBER,
			--INV_PART_DESCRIPTION,
			Artikelname,
			Dicke,
			Kaschierung,
			Materialart,
			D_P,
			TG,
			gefuellt,
			restliche_Codierung,
			Lieferant
		) AS tblMain
		ORDER BY
			Dicke,
			Kaschierung
	END

	IF @Case_ = 'ABCArtikelLieferantNeu'
	BEGIN
		
--Artikel-Lieferant:
--Konsiartikel werden über normale Bestellungen berücksichtigt (keine Konsi-Ausprägungen)
--Letzte Änderung: 20.02.2014

	--DECLARE
	--	@para1 varchar(250),
	--	@para2 varchar(250),
	--	@para3 varchar(250),
	--	@para4 varchar(250)
	--	SET @para1 = '01.01.2014'
	--	SET @para2 = '31.12.2014'
	--	SET @para3 = '%' --'bimsmehl'
	--	SET @para4 = 'Brautmeier GmbH'

		DECLARE
		--@para1VJ varchar(250),
		--@para2VJ varchar(250),
		@paraVJ varchar(250)

		SET @para1VJ = SUBSTRING(@para1, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para1, 7, 4) AS INT)-1))
		SET @para2VJ = SUBSTRING(@para2, 1, 6) + LTRIM(STR(CAST(SUBSTRING(@para2, 7, 4) AS INT)-1))
		SET @paraVJ = LTRIM(STR(CAST(SUBSTRING(@para2, 7, 4) AS INT)-1))

		DECLARE @tblArtLiefNeu table (
									D17_RKEY NUMERIC(10, 0), 
									--D23_RKEY NUMERIC(10, 0), 
									INV_PART_NUMBER char(20) null, 
									INV_PART_DESCRIPTION char(40) null, 
									Lieferant char(50) null,
									EK_Volume NUMERIC(10,2) ,
									EK_VolumeVJ NUMERIC(10,2) ,
									EK_VolumeVJ_ZR NUMERIC(10,2) ,
									LMenge NUMERIC(10,2) ,
									UNIT_CODE char(5) null,
									DRPreis NUMERIC(10,3) ,
									Letzter_EK_Preis NUMERIC(10,3) ,
									letztes_LDatum smalldatetime ,
		    						AnzBestellungen int,
									DRWert NUMERIC(10,2),
									DLMenge NUMERIC(10,2),
									Preis_gewichtet12Mon NUMERIC(10,2),
									DPreis_VJ_Lief NUMERIC(10,2),
									DPreis_VJ_Lief_ZR NUMERIC(10,2),
									PRODUCT_GROUP_NAME CHAR(30) null,
									PRODUCT_NAME CHAR(30) null,
									LMengeVJZR NUMERIC(10,2),
									LMengeVJ NUMERIC(10,2)
									)

		INSERT @tblArtLiefNeu(
									D17_RKEY, 
									--D23_RKEY, 
									INV_PART_NUMBER, 
									INV_PART_DESCRIPTION, 
									Lieferant,
									EK_Volume,
									EK_VolumeVJ,
									EK_VolumeVJ_ZR,
									LMenge,
									UNIT_CODE,
									DRPreis,
									Letzter_EK_Preis,
									letztes_LDatum,
									AnzBestellungen,
									DRWert,
									DLMenge,
									Preis_gewichtet12Mon,
									DPreis_VJ_Lief,
									DPreis_VJ_Lief_ZR,
									PRODUCT_GROUP_NAME,
									PRODUCT_NAME,
									LMengeVJZR,
									LMengeVJ
						)

			SELECT 
				--BTyp, 
				--MAX(D95_PTR) AS D95_PTR,
				D17_RKEY,  
				--D23_RKEY, 
				INV_PART_NUMBER, 
				INV_PART_DESCRIPTION,
				Lieferant,
				CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_Volume,
				0 AS EK_VolumeVJ,
				0 AS EK_VolumeVJ_ZR,
				CAST(SUM(LMenge) AS NUMERIC(10, 2)) AS LMenge,
				UNIT_CODE,
				--CAST(AVG(RPreis) AS NUMERIC(10, 3)) AS DRPreis,
				CASE WHEN SUM(LMenge)>0 THEN ISNULL(SUM(LMenge*RPreis)/SUM(LMenge), 0) ELSE 0 END AS DRPreis,
				CAST((
					SELECT     TOP 1 dbo.DATA0108.PRICE
					--FROM         dbo.DATA0017 AS D17 INNER JOIN
					--					  dbo.DATA0071 ON D17.RKEY = dbo.DATA0071.INVT_PTR INNER JOIN
					--					  dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
					FROM         dbo.DATA0017 AS D17 INNER JOIN
                      dbo.DATA0071 ON D17.RKEY = dbo.DATA0071.INVT_PTR INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
                      dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
                      dbo.DATA0023 AS D23 ON dbo.DATA0070.SUPPLIER_POINTER = D23.RKEY
					WHERE     (dbo.DATA0071.PRICE > 0) AND (D17.RKEY = D17_RKEY) 
								--AND D23.RKEY = D23_RKEY 
								AND (D23.SUPPLIER_NAME = Lieferant)
					ORDER BY dbo.DATA0071.DEL_DATE DESC
				) AS NUMERIC(10, 3)) AS Letzter_EK_Preis,

				--MAX(LDatum) AS letztes_LDatum,
				--CONVERT(varchar(10), MAX(LDatum), 104) AS letztes_LDatum,
				(
					SELECT CONVERT(varchar(10), MAX(ResDatum), 104) AS RecMaxDatum
					FROM
					(
						SELECT   
							--CONVERT(varchar(10), dbo.DATA0095.ENTERED_DATE, 104) AS ResDatum,
							dbo.DATA0095.ENTERED_DATE AS ResDatum,
							dbo.DATA0017.RKEY AS D17ID,
							dbo.DATA0023.SUPPLIER_NAME
							--dbo.DATA0023.RKEY AS D23ID
						FROM         
							dbo.DATA0095 INNER JOIN
							dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
							dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
							dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
							dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
						WHERE    
							--(dbo.DATA0017.RKEY = D17_RKEY)
							--AND 
							(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
						UNION ALL
						SELECT
							--CONVERT(varchar(10), dbo.DATA0341.TRAN_DATE, 104) AS ResDatum,
							dbo.DATA0341.TRAN_DATE AS ResDatum,
							dbo.DATA0017.RKEY AS D17ID,
							dbo.DATA0023.SUPPLIER_NAME
							--dbo.DATA0023.RKEY AS D23ID
						FROM        
							dbo.DATA0017 INNER JOIN
							dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
							dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
							dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
							dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
						WHERE     
							--(dbo.DATA0017.RKEY = D17_RKEY)
							--AND 
							(dbo.DATA0341.TRAN_TP=1)
							--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
							AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))
					) AS myTblMaxDatum
					WHERE D17ID = D17_RKEY 
							--AND D23ID = D23_RKEY 
							AND SUPPLIER_NAME = Lieferant
				) AS letztes_LDatum,

				SUM(AnzBestellungen) AS AnzBestellungen,
				CAST(AVG(RWert) AS NUMERIC(10, 2)) AS DRWert,
				CAST(AVG(LMenge) AS NUMERIC(10, 2)) AS DLMenge,
				(
					SELECT
					SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
					--Res_DREPreis,
					--TRAN_DATE
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE --SUM(D108.PRICE*D108.QUANTITY)/SUM(D108.QUANTITY) --D108.PRICE 
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
										ELSE D17.STD_COST --D95.QUANTITY/D17.STOCK_PURCH*(SELECT TOP 1 STD_COST FROM dbo.DATA0017 WHERE RKEY=225)
									END
							END AS Res_DREPreis,
							(D95.QUANTITY/D17.STOCK_PURCH) AS Menge,
							--D95.TRAN_DATE 
							D95.INVT_PTR,
							--D70.SUPPLIER_POINTER
							D23.SUPPLIER_NAME
						FROM         dbo.DATA0095 AS D95 INNER JOIN
							  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
							  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
							  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
							  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY INNER JOIN
							  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
							  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							(D95.TRAN_TP = 5) 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND (ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0) 
							--AND (D95.INVT_PTR=D17_RKEY)
							--AND (D70.SUPPLIER_POINTER = D23_RKEY)
					) AS myDPreisTbl
					WHERE
							(INVT_PTR=D17_RKEY)
							--AND (SUPPLIER_POINTER = D23_RKEY)
							AND SUPPLIER_NAME = Lieferant
					GROUP BY
						INVT_PTR,
						--SUPPLIER_POINTER
						SUPPLIER_NAME
					--ORDER BY TRAN_DATE DESC
				) AS Preis_gewichtet12Mon,
				(
					SELECT
					SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE --SUM(D108.PRICE*D108.QUANTITY)/SUM(D108.QUANTITY) --D108.PRICE 
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
										ELSE D17.STD_COST --D95.QUANTITY/D17.STOCK_PURCH*(SELECT TOP 1 STD_COST FROM dbo.DATA0017 WHERE RKEY=225)
									END
							END AS Res_DREPreis,
							(D95.QUANTITY/D17.STOCK_PURCH) AS Menge,
							D95.INVT_PTR,
							--D70.SUPPLIER_POINTER
							D23.SUPPLIER_NAME
						FROM         dbo.DATA0095 AS D95 INNER JOIN
							  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
							  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
							  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
							  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY INNER JOIN
							  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
							  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							(D95.TRAN_TP = 5) 
							AND (YEAR(D95.TRAN_DATE)= CAST(@paraVJ AS INT))
					) AS myDPreisTbl
					WHERE
						(INVT_PTR=D17_RKEY)
						--AND (SUPPLIER_POINTER = D23_RKEY)
						AND SUPPLIER_NAME = Lieferant
					GROUP BY
						INVT_PTR,
						--SUPPLIER_POINTER
						SUPPLIER_NAME
				) AS DPreis_VJ_Lief,
				(
					SELECT
					SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE --SUM(D108.PRICE*D108.QUANTITY)/SUM(D108.QUANTITY) --D108.PRICE 
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
										ELSE D17.STD_COST --D95.QUANTITY/D17.STOCK_PURCH*(SELECT TOP 1 STD_COST FROM dbo.DATA0017 WHERE RKEY=225)
									END
							END AS Res_DREPreis,
							(D95.QUANTITY/D17.STOCK_PURCH) AS Menge,
							D95.INVT_PTR,
							D23.SUPPLIER_NAME
						FROM         dbo.DATA0095 AS D95 INNER JOIN
							  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
							  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
							  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
							  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY INNER JOIN
							  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
							  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							(D95.TRAN_TP = 5) 
							AND (D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103))
					) AS myDPreisTbl
					WHERE
						(INVT_PTR=D17_RKEY)
						--AND (SUPPLIER_POINTER = D23_RKEY)
						AND SUPPLIER_NAME = Lieferant
					GROUP BY
						INVT_PTR,
						--SUPPLIER_POINTER
						SUPPLIER_NAME
				) AS DPreis_VJ_Lief_ZR,
				(
					SELECT TOP 1  dbo.DATA0007.PRODUCT_GROUP_NAME
					FROM         dbo.DATA0017 INNER JOIN
										  dbo.DATA0008 ON dbo.DATA0017.PROD_CODE_SELL_PTR = dbo.DATA0008.RKEY INNER JOIN
										  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY
					WHERE     (dbo.DATA0017.RKEY = D17_RKEY)
				) AS PRODUCT_GROUP_NAME,
				(
					SELECT TOP 1  dbo.DATA0008.PRODUCT_NAME
					FROM         dbo.DATA0017 INNER JOIN
										  dbo.DATA0008 ON dbo.DATA0017.PROD_CODE_SELL_PTR = dbo.DATA0008.RKEY INNER JOIN
										  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY
					WHERE     (dbo.DATA0017.RKEY = D17_RKEY)
				) AS PRODUCT_NAME,
				0 AS LMengeVJZR,
				0 AS LMengeVJ

			FROM (
				--Lieferung T , Lieferung
				SELECT  
					'GGP' As BTyp,		
					dbo.DATA0095.RKEY AS D95_PTR, 
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION,
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant, 
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE--/dbo.DATA0107.EX_RATE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						--FROM         dbo.DATA0107 INNER JOIN
						--					  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
						--					  dbo.DATA0070 AS D70 INNER JOIN
						--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
						--					  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
					) AS RPreis,
					dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis

						--FROM         dbo.DATA0070 AS D70 INNER JOIN
						--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
						--					  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									--AND (D70.SUPPLIER_POINTER = dbo.DATA0023.RKEY)
									AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
					) AS RWert,
					dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					dbo.DATA0095.ENTERED_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND
							(dbo.DATA0095.TRAN_TP = 5) --AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


				UNION ALL

				--Retourniert
				SELECT 
					'GGP' As BTyp, 
					dbo.DATA0095.RKEY AS D95_PTR, 
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					(-1)*dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMenge,
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis
						--FROM         dbo.DATA0070 AS D70 INNER JOIN
						--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
						--					  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
					) AS RPreis,
					-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
					(
						SELECT     TOP 1 
						CASE
							WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
								ELSE 
									CASE
										WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
											ELSE 
												(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
									END
						END AS RPreis
						--FROM         dbo.DATA0070 AS D70 INNER JOIN
						--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
						--					  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						----WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						--WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						--			--AND (D70.SUPPLIER_POINTER = dbo.DATA0023.RKEY)
						--			AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
											  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
								AND (D23.SUPPLIER_NAME = dbo.DATA0023.SUPPLIER_NAME)
					) AS RWert,
					dbo.DATA0070.SHIPPING_COST+dbo.DATA0070.MISC_CHARGE AS NK,
					dbo.DATA0095.ENTERED_DATE AS LDatum,
					0 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

					FROM         dbo.DATA0005 INNER JOIN
										  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										  dbo.DATA0017 INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
					WHERE    
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND
							(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) --AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--offene Bestellungen
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
					) AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE     
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND 
							(dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--Debit/Belastung
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					dbo.DATA0108.PRICE AS RPreis,
					(-1)*dbo.DATA0132.AMOUNT AS RWert,
					dbo.DATA0132.SHIPPING + dbo.DATA0132.MISC_TOT AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0132 INNER JOIN
                      dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
                      dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
                      dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
                      dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
                      dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
                      dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
                      dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
				WHERE      
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND
							(dbo.DATA0070.STATUS = 1)
							AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))

				UNION ALL 

				--Bestellungen in Klärung 
				SELECT  
					'GGP' As BTyp,
					0 AS D95_PTR,
					dbo.DATA0017.RKEY AS D17_RKEY,
					dbo.DATA0023.RKEY AS D23_RKEY,
					dbo.DATA0017.INV_PART_NUMBER, 
					dbo.DATA0017.INV_PART_DESCRIPTION, 
					dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
					--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
					dbo.DATA0002.UNIT_CODE,
					dbo.DATA0017.QUAN_ON_HAND,
					dbo.DATA0017.CONSIGN_ONHAND_QTY, 
					dbo.DATA0071.QUAN_RECD AS LMenge,
					0 AS RPreis,
					0 AS RWert,
					(
						SELECT     TOP 1 (dbo.DATA0107.SHIPPING+dbo.DATA0107.MISC_TOT) AS Res
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
											  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
											  dbo.DATA0107 ON dbo.DATA0108.DATA0107_PTR = dbo.DATA0107.RKEY
						WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)	
					) AS NK,
					dbo.DATA0071.REQ_DATE AS LDatum,
					1 AS AnzBestellungen,
					'' AS LetzterLieferant,
					0 As AnzLieferanten

				FROM         dbo.DATA0070 INNER JOIN
									  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
									  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
									  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
									  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
				WHERE      
							(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
							AND
							(dbo.DATA0070.STATUS = 5)
							AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
							AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1, 103))
							AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2, 103))


			)  AS ResTbl
			GROUP BY
				D17_RKEY, 
 				--D23_RKEY,
				INV_PART_NUMBER, 
				INV_PART_DESCRIPTION,
				Lieferant,

				UNIT_CODE,
				QUAN_ON_HAND,
				CONSIGN_ONHAND_QTY,
				LetzterLieferant,
				AnzLieferanten
			--ORDER BY INV_PART_NUMBER, INV_PART_DESCRIPTION --SUM(CAST(RWert AS NUMERIC(10, 2))) DESC --INV_PART_NUMBER, INV_PART_DESCRIPTION , BTyp




			--INSERT
			----------------------------------
			INSERT @tblArtLiefNeu(
										D17_RKEY, 
										--D23_RKEY, 
										INV_PART_NUMBER, 
										INV_PART_DESCRIPTION, 
										Lieferant,
										EK_Volume,
										EK_VolumeVJ,
										EK_VolumeVJ_ZR,
										LMenge,
										UNIT_CODE,
										DRPreis,
										Letzter_EK_Preis,
										letztes_LDatum,
										AnzBestellungen,
										DRWert,
										DLMenge,
										Preis_gewichtet12Mon,
										DPreis_VJ_Lief,
										PRODUCT_GROUP_NAME,
										PRODUCT_NAME
							)
			--UPDATE tblArtLief
			--SET tblArtLief.EK_VolumeVJ_ZR = myTblEK_VolumeVJ_ZR.EK_VolumeVJ_ZR
			SELECT
				myTblEK_VolumeVJ_ZR.D17_RKEY,
				--myTblEK_VolumeVJ_ZR.D23_RKEY,
				myTblEK_VolumeVJ_ZR.INV_PART_NUMBER,
				myTblEK_VolumeVJ_ZR.INV_PART_DESCRIPTION,
				myTblEK_VolumeVJ_ZR.Lieferant,
				0,
				0,
				myTblEK_VolumeVJ_ZR.EK_VolumeVJ_ZR,
				0,
				myTblEK_VolumeVJ_ZR.EK_Einheit,
				0,
				CAST((
					SELECT     TOP 1 dbo.DATA0108.PRICE
					--FROM         dbo.DATA0017 AS D17 INNER JOIN
					--					  dbo.DATA0071 ON D17.RKEY = dbo.DATA0071.INVT_PTR INNER JOIN
					--					  dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
					FROM         dbo.DATA0017 AS D17 INNER JOIN
                      dbo.DATA0071 ON D17.RKEY = dbo.DATA0071.INVT_PTR INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
                      dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
                      dbo.DATA0023 AS D23 ON dbo.DATA0070.SUPPLIER_POINTER = D23.RKEY
					WHERE     (dbo.DATA0071.PRICE > 0) AND (D17.RKEY = D17_RKEY) 
								--AND D23.RKEY = D23_RKEY 
								AND (D23.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = Lieferant)
					ORDER BY dbo.DATA0071.DEL_DATE DESC
				) AS NUMERIC(10, 3)) AS Letzter_EK_Preis,
				(
					SELECT CONVERT(varchar(10), MAX(ResDatum), 104) AS RecMaxDatum
					FROM
					(
						SELECT   
							--CONVERT(varchar(10), dbo.DATA0095.ENTERED_DATE, 104) AS ResDatum,
							dbo.DATA0095.ENTERED_DATE AS ResDatum,
							dbo.DATA0017.RKEY AS D17ID,
							dbo.DATA0023.SUPPLIER_NAME,
							dbo.DATA0023.RKEY AS D23ID
						FROM         
							dbo.DATA0095 INNER JOIN
							dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
							dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
							dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
							dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
						WHERE    
							--(dbo.DATA0017.RKEY = D17_RKEY)
							--AND 
							(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
						UNION ALL
						SELECT
							--CONVERT(varchar(10), dbo.DATA0341.TRAN_DATE, 104) AS ResDatum,
							dbo.DATA0341.TRAN_DATE AS ResDatum,
							dbo.DATA0017.RKEY AS D17ID,
							dbo.DATA0023.SUPPLIER_NAME,
							dbo.DATA0023.RKEY AS D23ID
						FROM        
							dbo.DATA0017 INNER JOIN
							dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
							dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
							dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
							dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
						WHERE     
							--(dbo.DATA0017.RKEY = D17_RKEY)
							--AND 
							(dbo.DATA0341.TRAN_TP=1)
							--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
							AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))
					) AS myTblMaxDatum
					WHERE D17ID = D17_RKEY 
							--AND D23ID = D23_RKEY 
							AND SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = Lieferant
				) AS letztes_LDatum,
				0,
				0,
				0,
				(
					SELECT
					SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
					--Res_DREPreis,
					--TRAN_DATE
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE --SUM(D108.PRICE*D108.QUANTITY)/SUM(D108.QUANTITY) --D108.PRICE 
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
										ELSE D17.STD_COST --D95.QUANTITY/D17.STOCK_PURCH*(SELECT TOP 1 STD_COST FROM dbo.DATA0017 WHERE RKEY=225)
									END
							END AS Res_DREPreis,
							(D95.QUANTITY/D17.STOCK_PURCH) AS Menge,
							--D95.TRAN_DATE 
							D95.INVT_PTR,
							--D70.SUPPLIER_POINTER
							--D108.PRICE AS RE_Preis, D71.PRICE BE_Preis, D71.QUAN_RECD, D71.QUAN_RETN, D95.INVT_PTR AS INVPTR, D70.SUPPLIER_POINTER
						--FROM         dbo.DATA0095 AS D95 INNER JOIN
						--					  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
						--					  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
						--					  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
						--					  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY LEFT OUTER JOIN
						--					  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							D23.SUPPLIER_NAME
						FROM         dbo.DATA0095 AS D95 INNER JOIN
							  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
							  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
							  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
							  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY INNER JOIN
							  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
							  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							(D95.TRAN_TP = 5) 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND (ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0) 
							--AND (D95.INVT_PTR=D17_RKEY)
							--AND (D70.SUPPLIER_POINTER = D23_RKEY)
					) AS myDPreisTbl 
					WHERE
							(INVT_PTR=D17_RKEY)
							--AND (SUPPLIER_POINTER = D23_RKEY)
							AND SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = Lieferant
					GROUP BY
						INVT_PTR,
						--SUPPLIER_POINTER
						SUPPLIER_NAME
					--ORDER BY TRAN_DATE DESC
				) AS Preis_gewichtet12Mon,
				(
					SELECT
					SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE --SUM(D108.PRICE*D108.QUANTITY)/SUM(D108.QUANTITY) --D108.PRICE 
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
										ELSE D17.STD_COST --D95.QUANTITY/D17.STOCK_PURCH*(SELECT TOP 1 STD_COST FROM dbo.DATA0017 WHERE RKEY=225)
									END
							END AS Res_DREPreis,
							(D95.QUANTITY/D17.STOCK_PURCH) AS Menge,
							D95.INVT_PTR,
							--D70.SUPPLIER_POINTER
						--FROM         dbo.DATA0095 AS D95 INNER JOIN
						--					  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
						--					  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
						--					  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
						--					  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY LEFT OUTER JOIN
						--					  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							D23.SUPPLIER_NAME
						FROM         dbo.DATA0095 AS D95 INNER JOIN
							  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
							  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
							  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
							  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY INNER JOIN
							  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
							  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							(D95.TRAN_TP = 5) 
							AND (YEAR(D95.TRAN_DATE)= CAST(@paraVJ AS INT))
					) AS myDPreisTbl
					WHERE
						(INVT_PTR=D17_RKEY)
						--AND (SUPPLIER_POINTER = D23_RKEY)
						AND (SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = Lieferant)
					GROUP BY
						INVT_PTR,
						--SUPPLIER_POINTER
						SUPPLIER_NAME
				) AS DPreis_VJ_Lief,
				(
					SELECT TOP 1  dbo.DATA0007.PRODUCT_GROUP_NAME
					FROM         dbo.DATA0017 INNER JOIN
										  dbo.DATA0008 ON dbo.DATA0017.PROD_CODE_SELL_PTR = dbo.DATA0008.RKEY INNER JOIN
										  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY
					WHERE     (dbo.DATA0017.RKEY = D17_RKEY)
				) AS PRODUCT_GROUP_NAME,
				(
					SELECT TOP 1  dbo.DATA0008.PRODUCT_NAME
					FROM         dbo.DATA0017 INNER JOIN
										  dbo.DATA0008 ON dbo.DATA0017.PROD_CODE_SELL_PTR = dbo.DATA0008.RKEY INNER JOIN
										  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY
					WHERE     (dbo.DATA0017.RKEY = D17_RKEY)
				) AS PRODUCT_NAME
	

			FROM
			--@tblArtLief AS tblArtLief,
			(
						SELECT 
							D17_RKEY,  
							--D23_RKEY,
							INV_PART_NUMBER, 
							INV_PART_DESCRIPTION, 
							Lieferant,
							CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ_ZR,
							EK_Einheit

						FROM (
							--Lieferung T , Lieferung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis
									--FROM         dbo.DATA0070 AS D70 INNER JOIN
									--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
									--					  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
										--D23.SUPPLIER_NAME
									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
														  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
														  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
												AND D23.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0023.SUPPLIER_NAME
								) AS RWert,
								dbo.DATA0002.UNIT_CODE AS EK_Einheit

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 5) --AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJ, 103))
										AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
											OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


							UNION ALL

							--Retourniert
							SELECT 
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis
									--FROM         dbo.DATA0070 AS D70 INNER JOIN
									--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
									--					  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									--D23.SUPPLIER_NAME
									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
														  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
														  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
									--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
												AND D23.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0023.SUPPLIER_NAME
								) AS RWert,
								dbo.DATA0002.UNIT_CODE AS EK_Einheit

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) --AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--offene Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert,
								dbo.DATA0002.UNIT_CODE AS EK_Einheit

							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE     
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND 
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--Debit/Belastung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								(-1)*dbo.DATA0132.AMOUNT AS RWert,
								dbo.DATA0002.UNIT_CODE AS EK_Einheit

							FROM         dbo.DATA0132 INNER JOIN
								  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--Bestellungen in Klärung 
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert,
								dbo.DATA0002.UNIT_CODE AS EK_Einheit
								
							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 5)
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

						)  AS ResTbl
						GROUP BY
							D17_RKEY, 
							--D23_RKEY,
							INV_PART_NUMBER, 
							INV_PART_DESCRIPTION, 
							Lieferant,
							EK_Einheit
			) AS myTblEK_VolumeVJ_ZR
			WHERE 
			--STR(myTblEK_VolumeVJ_ZR.D17_RKEY) + ';' + STR(myTblEK_VolumeVJ_ZR.D23_RKEY) Not In (SELECT STR(tblArtLief .D17_RKEY) + ';' + STR(tblArtLief .D23_RKEY) FROM @tblArtLief AS tblArtLief )
			STR(myTblEK_VolumeVJ_ZR.D17_RKEY) + ';' + RTRIM(myTblEK_VolumeVJ_ZR.Lieferant) COLLATE SQL_Latin1_General_CP1_CI_AS
				Not In (SELECT STR(tblArtLiefNeu.D17_RKEY) + ';' + RTRIM(tblArtLiefNeu.Lieferant) COLLATE SQL_Latin1_General_CP1_CI_AS FROM @tblArtLiefNeu AS tblArtLiefNeu )
			--tblArtLief.D17_RKEY = myTblEK_VolumeVJ_ZR.D17_RKEY
			--AND
			--tblArtLief.D23_RKEY = myTblEK_VolumeVJ_ZR.D23_RKEY
			----------------------------------


			--INSERT VORJAHR Werte
			----------------------------------
			INSERT @tblArtLiefNeu(
										D17_RKEY, 
										--D23_RKEY, 
										INV_PART_NUMBER, 
										INV_PART_DESCRIPTION, 
										Lieferant,
										EK_Volume,
										EK_VolumeVJ,
										EK_VolumeVJ_ZR,
										LMenge,
										UNIT_CODE,
										DRPreis,
										Letzter_EK_Preis,
										letztes_LDatum,
										AnzBestellungen,
										DRWert,
										DLMenge,
										Preis_gewichtet12Mon,
										DPreis_VJ_Lief,
										PRODUCT_GROUP_NAME,
										PRODUCT_NAME
							)
			--UPDATE tblArtLief
			--SET tblArtLief.EK_VolumeVJ_ZR = myTblEK_VolumeVJ_ZR.EK_VolumeVJ_ZR
			SELECT
				myTblEK_VolumeVJ_ZR.D17_RKEY,
				--myTblEK_VolumeVJ_ZR.D23_RKEY,
				myTblEK_VolumeVJ_ZR.INV_PART_NUMBER,
				myTblEK_VolumeVJ_ZR.INV_PART_DESCRIPTION,
				myTblEK_VolumeVJ_ZR.Lieferant,
				0,
				0,
				myTblEK_VolumeVJ_ZR.EK_VolumeVJ_ZR,
				0,
				myTblEK_VolumeVJ_ZR.EK_Einheit,
				0,
				CAST((
					SELECT     TOP 1 dbo.DATA0108.PRICE
					--FROM         dbo.DATA0017 AS D17 INNER JOIN
					--					  dbo.DATA0071 ON D17.RKEY = dbo.DATA0071.INVT_PTR INNER JOIN
					--					  dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
					FROM         dbo.DATA0017 AS D17 INNER JOIN
                      dbo.DATA0071 ON D17.RKEY = dbo.DATA0071.INVT_PTR INNER JOIN
                      dbo.DATA0108 ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR INNER JOIN
                      dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
                      dbo.DATA0023 AS D23 ON dbo.DATA0070.SUPPLIER_POINTER = D23.RKEY
					WHERE     (dbo.DATA0071.PRICE > 0) AND (D17.RKEY = D17_RKEY) 
								--AND D23.RKEY = D23_RKEY 
								AND (D23.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = Lieferant)
					ORDER BY dbo.DATA0071.DEL_DATE DESC
				) AS NUMERIC(10, 3)) AS Letzter_EK_Preis,
				(
					SELECT CONVERT(varchar(10), MAX(ResDatum), 104) AS RecMaxDatum
					FROM
					(
						SELECT   
							--CONVERT(varchar(10), dbo.DATA0095.ENTERED_DATE, 104) AS ResDatum,
							dbo.DATA0095.ENTERED_DATE AS ResDatum,
							dbo.DATA0017.RKEY AS D17ID,
							dbo.DATA0023.SUPPLIER_NAME,
							dbo.DATA0023.RKEY AS D23ID
						FROM         
							dbo.DATA0095 INNER JOIN
							dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
							dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
							dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
							dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
						WHERE    
							--(dbo.DATA0017.RKEY = D17_RKEY)
							--AND 
							(dbo.DATA0095.TRAN_TP = 5) AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
							--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
							AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
								OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))
						UNION ALL
						SELECT
							--CONVERT(varchar(10), dbo.DATA0341.TRAN_DATE, 104) AS ResDatum,
							dbo.DATA0341.TRAN_DATE AS ResDatum,
							dbo.DATA0017.RKEY AS D17ID,
							dbo.DATA0023.SUPPLIER_NAME,
							dbo.DATA0023.RKEY AS D23ID
						FROM        
							dbo.DATA0017 INNER JOIN
							dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
							dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
							dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
							dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
						WHERE     
							--(dbo.DATA0017.RKEY = D17_RKEY)
							--AND 
							(dbo.DATA0341.TRAN_TP=1)
							--AND (dbo.DATA0023.SUPPLIER_NAME = Lieferant)
							AND (dbo.DATA0466.STATUS=2 OR (dbo.DATA0466.STATUS=1 AND dbo.DATA0467.QUAN_RECD>=dbo.DATA0467.QUAN_ORD))
					) AS myTblMaxDatum
					WHERE D17ID = D17_RKEY 
							--AND D23ID = D23_RKEY 
							AND SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = Lieferant
				) AS letztes_LDatum,
				0,
				0,
				0,
				(
					SELECT
					SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
					--Res_DREPreis,
					--TRAN_DATE
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE --SUM(D108.PRICE*D108.QUANTITY)/SUM(D108.QUANTITY) --D108.PRICE 
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
										ELSE D17.STD_COST --D95.QUANTITY/D17.STOCK_PURCH*(SELECT TOP 1 STD_COST FROM dbo.DATA0017 WHERE RKEY=225)
									END
							END AS Res_DREPreis,
							(D95.QUANTITY/D17.STOCK_PURCH) AS Menge,
							--D95.TRAN_DATE 
							D95.INVT_PTR,
							--D70.SUPPLIER_POINTER
							--D108.PRICE AS RE_Preis, D71.PRICE BE_Preis, D71.QUAN_RECD, D71.QUAN_RETN, D95.INVT_PTR AS INVPTR, D70.SUPPLIER_POINTER
						--FROM         dbo.DATA0095 AS D95 INNER JOIN
						--					  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
						--					  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
						--					  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
						--					  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY LEFT OUTER JOIN
						--					  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							D23.SUPPLIER_NAME
						FROM         dbo.DATA0095 AS D95 INNER JOIN
							  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
							  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
							  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
							  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY INNER JOIN
							  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
							  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							(D95.TRAN_TP = 5) 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND (ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0) 
							--AND (D95.INVT_PTR=D17_RKEY)
							--AND (D70.SUPPLIER_POINTER = D23_RKEY)
					) AS myDPreisTbl 
					WHERE
							(INVT_PTR=D17_RKEY)
							--AND (SUPPLIER_POINTER = D23_RKEY)
							AND SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = Lieferant
					GROUP BY
						INVT_PTR,
						--SUPPLIER_POINTER
						SUPPLIER_NAME
					--ORDER BY TRAN_DATE DESC
				) AS Preis_gewichtet12Mon,
				(
					SELECT
					SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE --SUM(D108.PRICE*D108.QUANTITY)/SUM(D108.QUANTITY) --D108.PRICE 
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
										ELSE D17.STD_COST --D95.QUANTITY/D17.STOCK_PURCH*(SELECT TOP 1 STD_COST FROM dbo.DATA0017 WHERE RKEY=225)
									END
							END AS Res_DREPreis,
							(D95.QUANTITY/D17.STOCK_PURCH) AS Menge,
							D95.INVT_PTR,
							--D70.SUPPLIER_POINTER
						--FROM         dbo.DATA0095 AS D95 INNER JOIN
						--					  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
						--					  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
						--					  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
						--					  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY LEFT OUTER JOIN
						--					  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
							D23.SUPPLIER_NAME
						FROM         dbo.DATA0095 AS D95 INNER JOIN
							  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
							  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
							  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY INNER JOIN
							  dbo.DATA0017 AS D17 ON D95.INVT_PTR = D17.RKEY INNER JOIN
							  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
							  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							(D95.TRAN_TP = 5) 
							AND (YEAR(D95.TRAN_DATE)= CAST(@paraVJ AS INT))
					) AS myDPreisTbl
					WHERE
						(INVT_PTR=D17_RKEY)
						--AND (SUPPLIER_POINTER = D23_RKEY)
						AND (SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = Lieferant)
					GROUP BY
						INVT_PTR,
						--SUPPLIER_POINTER
						SUPPLIER_NAME
				) AS DPreis_VJ_Lief,
				(
					SELECT TOP 1  dbo.DATA0007.PRODUCT_GROUP_NAME
					FROM         dbo.DATA0017 INNER JOIN
										  dbo.DATA0008 ON dbo.DATA0017.PROD_CODE_SELL_PTR = dbo.DATA0008.RKEY INNER JOIN
										  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY
					WHERE     (dbo.DATA0017.RKEY = D17_RKEY)
				) AS PRODUCT_GROUP_NAME,
				(
					SELECT TOP 1  dbo.DATA0008.PRODUCT_NAME
					FROM         dbo.DATA0017 INNER JOIN
										  dbo.DATA0008 ON dbo.DATA0017.PROD_CODE_SELL_PTR = dbo.DATA0008.RKEY INNER JOIN
										  dbo.DATA0007 ON dbo.DATA0008.PR_GRP_POINTER = dbo.DATA0007.RKEY
					WHERE     (dbo.DATA0017.RKEY = D17_RKEY)
				) AS PRODUCT_NAME
	

			FROM
			--@tblArtLief AS tblArtLief,
			(
						SELECT 
							D17_RKEY,  
							--D23_RKEY,
							INV_PART_NUMBER, 
							INV_PART_DESCRIPTION, 
							Lieferant,
							CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ_ZR,
							EK_Einheit

						FROM (
							--Lieferung T , Lieferung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis
									--FROM         dbo.DATA0070 AS D70 INNER JOIN
									--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
									--					  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
										--D23.SUPPLIER_NAME
									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
														  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
														  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
												AND D23.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0023.SUPPLIER_NAME
								) AS RWert,
								dbo.DATA0002.UNIT_CODE AS EK_Einheit

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 5) --AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE < CONVERT(DATETIME, @para1VJ, 103)
											OR dbo.DATA0095.ENTERED_DATE > CONVERT(DATETIME, @para2VJ, 103))
										AND (YEAR(dbo.DATA0095.ENTERED_DATE)= CAST(@paraVJ AS INT))
										AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
											OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


							UNION ALL

							--Retourniert
							SELECT 
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis
									--FROM         dbo.DATA0070 AS D70 INNER JOIN
									--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
									--					  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									--D23.SUPPLIER_NAME
									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
														  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
														  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
									--WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
												AND D23.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0023.SUPPLIER_NAME
								) AS RWert,
								dbo.DATA0002.UNIT_CODE AS EK_Einheit

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) --AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE < CONVERT(DATETIME, @para1VJ, 103)
											OR dbo.DATA0095.ENTERED_DATE > CONVERT(DATETIME, @para2VJ, 103))
										AND (YEAR(dbo.DATA0095.ENTERED_DATE)= CAST(@paraVJ AS INT))

							UNION ALL 

							--offene Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert,
								dbo.DATA0002.UNIT_CODE AS EK_Einheit

							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE     
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND 
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE < CONVERT(DATETIME, @para1VJ, 103)
											OR dbo.DATA0071.REQ_DATE > CONVERT(DATETIME, @para2VJ, 103))
										AND (YEAR(dbo.DATA0071.REQ_DATE)= CAST(@paraVJ AS INT))

							UNION ALL 

							--Debit/Belastung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								(-1)*dbo.DATA0132.AMOUNT AS RWert,
								dbo.DATA0002.UNIT_CODE AS EK_Einheit

							FROM         dbo.DATA0132 INNER JOIN
								  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE < CONVERT(DATETIME, @para1VJ, 103)
											OR dbo.DATA0071.REQ_DATE > CONVERT(DATETIME, @para2VJ, 103))
										AND (YEAR(dbo.DATA0071.REQ_DATE)= CAST(@paraVJ AS INT))

							UNION ALL 

							--Bestellungen in Klärung 
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0017.INV_PART_NUMBER, 
								dbo.DATA0017.INV_PART_DESCRIPTION, 
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								--RTRIM(dbo.DATA0023.SUPPLIER_NAME) + ' (' + dbo.DATA0023.CODE + ')' AS Lieferant,
								0 AS RWert,
								dbo.DATA0002.UNIT_CODE AS EK_Einheit
								
							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 5)
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE < CONVERT(DATETIME, @para1VJ, 103)
											OR dbo.DATA0071.REQ_DATE > CONVERT(DATETIME, @para2VJ, 103))
										AND (YEAR(dbo.DATA0071.REQ_DATE)= CAST(@paraVJ AS INT))

						)  AS ResTbl
						GROUP BY
							D17_RKEY, 
							--D23_RKEY,
							INV_PART_NUMBER, 
							INV_PART_DESCRIPTION, 
							Lieferant,
							EK_Einheit
			) AS myTblEK_VolumeVJ_ZR
			WHERE 
			--STR(myTblEK_VolumeVJ_ZR.D17_RKEY) + ';' + STR(myTblEK_VolumeVJ_ZR.D23_RKEY) Not In (SELECT STR(tblArtLief .D17_RKEY) + ';' + STR(tblArtLief .D23_RKEY) FROM @tblArtLief AS tblArtLief )
			STR(myTblEK_VolumeVJ_ZR.D17_RKEY) + ';' + RTRIM(myTblEK_VolumeVJ_ZR.Lieferant) COLLATE SQL_Latin1_General_CP1_CI_AS
				Not In (SELECT STR(tblArtLiefNeu.D17_RKEY) + ';' + RTRIM(tblArtLiefNeu.Lieferant) COLLATE SQL_Latin1_General_CP1_CI_AS FROM @tblArtLiefNeu AS tblArtLiefNeu )
			--tblArtLief.D17_RKEY = myTblEK_VolumeVJ_ZR.D17_RKEY
			--AND
			--tblArtLief.D23_RKEY = myTblEK_VolumeVJ_ZR.D23_RKEY
			----------------------------------



			--UPDATE EK_VolumeVJ Vorjahr
			----------------------------------
			UPDATE tblArtLiefNeu
			SET 
				tblArtLiefNeu.EK_VolumeVJ = myTblEK_VolumeVJ.EK_VolumeVJ,
				tblArtLiefNeu.LMengeVJ = myTblEK_VolumeVJ.LMengeVJ
			FROM
			@tblArtLiefNeu AS tblArtLiefNeu,
			(
						SELECT 
							D17_RKEY,  
							--D23_RKEY,
							Lieferant,
							CAST(SUM(LMengeVJ) AS NUMERIC(10, 2)) AS LMengeVJ,
							CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ

						FROM (
							--Lieferung T , Lieferung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMengeVJ,
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis
									--FROM         dbo.DATA0070 AS D70 INNER JOIN
									--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
									--					  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									--WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
														  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
														  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
												AND D23.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0023.SUPPLIER_NAME
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 5) --AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (YEAR(dbo.DATA0095.ENTERED_DATE)= CAST(@paraVJ AS INT))
										--AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										--AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJ, 103))
										AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
											OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


							UNION ALL

							--Retourniert
							SELECT 
								dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH) AS LMengeVJ,
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis
									--FROM         dbo.DATA0070 AS D70 INNER JOIN
									--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
									--					  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									----WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									--WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
														  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
														  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
												AND D23.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0023.SUPPLIER_NAME
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) --AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (YEAR(dbo.DATA0095.ENTERED_DATE)= CAST(@paraVJ AS INT))
										--AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										--AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--offene Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								dbo.DATA0071.QUAN_RECD AS LMengeVJ,
								0 AS RWert

							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE     
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND 
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (YEAR(dbo.DATA0071.REQ_DATE)= CAST(@paraVJ AS INT))
										--AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--Debit/Belastung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								dbo.DATA0071.QUAN_RECD AS LMengeVJ,
								(-1)*dbo.DATA0132.AMOUNT AS RWert

							FROM         dbo.DATA0132 INNER JOIN
								  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (YEAR(dbo.DATA0071.REQ_DATE)= CAST(@paraVJ AS INT))
										--AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--Bestellungen in Klärung 
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								dbo.DATA0071.QUAN_RECD AS LMengeVJ,
								0 AS RWert
								
							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 5)
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (YEAR(dbo.DATA0071.REQ_DATE)= CAST(@paraVJ AS INT))
										--AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										--AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))


						)  AS ResTbl
						GROUP BY
							D17_RKEY, 
							--D23_RKEY
							Lieferant
			) AS myTblEK_VolumeVJ
			WHERE 
			tblArtLiefNeu.D17_RKEY = myTblEK_VolumeVJ.D17_RKEY
			AND
			--tblArtLief.D23_RKEY = myTblEK_VolumeVJ.D23_RKEY
			tblArtLiefNeu.Lieferant COLLATE SQL_Latin1_General_CP1_CI_AS = myTblEK_VolumeVJ.Lieferant
			----------------------------------
									

			--UPDATE EK_VolumeVJ Zeitraum
			----------------------------------
			UPDATE tblArtLiefNeu
			SET 
				tblArtLiefNeu.EK_VolumeVJ_ZR = myTblEK_VolumeVJ_ZR.EK_VolumeVJ_ZR,
				tblArtLiefNeu.LMengeVJZR = myTblEK_VolumeVJ_ZR.LMengeVJZR
			FROM
			@tblArtLiefNeu AS tblArtLiefNeu,
			(
						SELECT 
							D17_RKEY,  
							--D23_RKEY,
							Lieferant,
							CAST(SUM(LMengeVJZR) AS NUMERIC(10, 2)) AS LMengeVJZR,
							CAST(SUM(RWert) AS NUMERIC(10, 2)) AS EK_VolumeVJ_ZR

						FROM (
							--Lieferung T , Lieferung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH AS LMengeVJZR, --EK-Menge Vorjahr Zeitraum
								dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis
									--FROM         dbo.DATA0070 AS D70 INNER JOIN
									--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
									--					  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									--WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
														  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
														  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
												AND D23.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0023.SUPPLIER_NAME
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 5) --AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJ, 103))
										AND (dbo.DATA0070.STATUS=2 OR dbo.DATA0070.STATUS=6
											OR (dbo.DATA0070.STATUS=1 AND dbo.DATA0071.QUAN_RECD>=dbo.DATA0071.QUAN_ORD))


							UNION ALL

							--Retourniert
							SELECT 
								dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH) AS LMengeVJZR, --EK-Menge Vorjahr Zeitraum
								-1*(dbo.DATA0095.QUANTITY/dbo.DATA0017.STOCK_PURCH)*
								(
									SELECT     TOP 1 
									CASE
										WHEN ISNULL(D108.PRICE, 0)>0 THEN D108.PRICE 
											ELSE 
												CASE
													WHEN ISNULL(D71.PRICE, 0)>0 THEN D71.PRICE 
														ELSE 
															ISNULL(dbo.DATA0017.STD_COST, 0) --(SELECT TOP 1 ISNULL(STD_COST, 0) AS Res FROM DATA0017 WHERE RKEY=dbo.DATA0017.RKEY)
												END
									END AS RPreis
									--FROM         dbo.DATA0070 AS D70 INNER JOIN
									--					  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
									--					  dbo.DATA0108 ON D71.RKEY = dbo.DATA0108.DATA0071_PTR
									----WHERE     (D70.PO_NUMBER = dbo.DATA0070.PO_NUMBER) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									--WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
									FROM         dbo.DATA0070 AS D70 INNER JOIN
														  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR INNER JOIN
														  dbo.DATA0023 AS D23 ON D70.SUPPLIER_POINTER = D23.RKEY LEFT OUTER JOIN
														  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
									WHERE     (D71.RKEY = dbo.DATA0071.RKEY) AND (D71.INVT_PTR = dbo.DATA0017.RKEY)
												AND D23.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0023.SUPPLIER_NAME
								) AS RWert

								FROM         dbo.DATA0005 INNER JOIN
													  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
													  dbo.DATA0017 INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
													  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
													  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
													  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
								WHERE    
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) --AND dbo.DATA0070.PURCHASE_ORDER_TYPE=0
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0095.ENTERED_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0095.ENTERED_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--offene Bestellungen
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								dbo.DATA0071.QUAN_RECD AS LMengeVJZR, --EK-Menge Vorjahr Zeitraum
								0 AS RWert

							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE     
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND 
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--Debit/Belastung
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								dbo.DATA0071.QUAN_RECD AS LMengeVJZR, --EK-Menge Vorjahr Zeitraum
								(-1)*dbo.DATA0132.AMOUNT AS RWert

							FROM         dbo.DATA0132 INNER JOIN
								  dbo.DATA0219 ON dbo.DATA0132.RKEY = dbo.DATA0219.DEBIT_PTR INNER JOIN
								  dbo.DATA0108 ON dbo.DATA0219.DATA0108_PTR = dbo.DATA0108.RKEY INNER JOIN
								  dbo.DATA0071 ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY INNER JOIN
								  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
								  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
								  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
								  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 1)
										AND (dbo.DATA0071.QUAN_RECD<dbo.DATA0071.QUAN_ORD)
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))

							UNION ALL 

							--Bestellungen in Klärung 
							SELECT  
								dbo.DATA0017.RKEY AS D17_RKEY,
								--dbo.DATA0023.RKEY AS D23_RKEY,
								dbo.DATA0023.SUPPLIER_NAME AS Lieferant,
								dbo.DATA0071.QUAN_RECD AS LMengeVJZR, --EK-Menge Vorjahr Zeitraum
								0 AS RWert
								
							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0005 ON dbo.DATA0070.EMPLOYEE_POINTER = dbo.DATA0005.RKEY INNER JOIN
												  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
												  dbo.DATA0002 ON dbo.DATA0071.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY
							WHERE      
										(dbo.DATA0017.INV_PART_DESCRIPTION COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para3)   
										AND
										(dbo.DATA0070.STATUS = 5)
										AND dbo.DATA0023.SUPPLIER_NAME COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para4
										AND (dbo.DATA0071.REQ_DATE >= CONVERT(DATETIME, @para1VJ, 103))
										AND (dbo.DATA0071.REQ_DATE <= CONVERT(DATETIME, @para2VJ, 103))


						)  AS ResTbl
						GROUP BY
							D17_RKEY, 
							--D23_RKEY
							Lieferant
			) AS myTblEK_VolumeVJ_ZR
			WHERE 
			tblArtLiefNeu.D17_RKEY = myTblEK_VolumeVJ_ZR.D17_RKEY
			AND
			--tblArtLief.D23_RKEY = myTblEK_VolumeVJ_ZR.D23_RKEY
			tblArtLiefNeu.Lieferant COLLATE SQL_Latin1_General_CP1_CI_AS = myTblEK_VolumeVJ_ZR.Lieferant
			----------------------------------





			SELECT
			--D17_RKEY, 
			--D23_RKEY,
			--PRODUCT_GROUP_NAME,
			--PRODUCT_NAME,
			INV_PART_NUMBER, --Artikel
			INV_PART_DESCRIPTION, --Bezeichnung
			Lieferant, --Lieferant
			ISNULL(EK_Volume_ArtGesamt, 0) AS EK_Volume_ArtGesamt, --EK-Volumen ZR ges
			ISNULL(EK_Volume, 0) AS EK_Volume, --EK-Volumen Lieferant ZR ges
			ISNULL(EK_VolumeVJ_ZR, 0) AS EK_VolumeVJ_ZR, --EK-Volumen Lieferant ZR VJ
			ISNULL(EK_VolumeVJ, 0) AS EK_VolumeVJ, --EK-Volumen Lieferant VJ
			ISNULL(EK_Volume, 0)-ISNULL(EK_VolumeVJ_ZR, 0) AS Diff_ZR_abs, --Diff. im ZR abs
			CASE WHEN ISNULL(EK_VolumeVJ_ZR, 0)>0 THEN 
				(ISNULL(EK_Volume, 0)-ISNULL(EK_VolumeVJ_ZR, 0))/ISNULL(EK_VolumeVJ_ZR, 0)*100 ELSE 0 END AS Diff_ZR_Proz, --Diff. im ZR in %
			CASE WHEN ISNULL(EK_Volume_ArtGesamt, 0)>0 THEN 
				ISNULL(EK_Volume, 0)/ISNULL(EK_Volume_ArtGesamt, 0)*100 ELSE 0 END AS Ant_LiefArt_Proz, --Anteil Lieferant an Artikel
			--Anteil am EK-Volumen von Lieferant
			ISNULL(Preis_gewichtet12Mon, 0) AS Preis_gewichtet12Mon, --O RE-Preis der letzten 12 Monate
			ISNULL(DPreis_VJ_Lief, 0) AS DPreis_VJ_Lief, --O RE-Preis des Vorjahres
			ISNULL(DPreis_VJ_Lief_ZR, 0) AS DPreis_VJ_Lief_ZR, --O RE-Preis des Zeitraums je Lieferant
			ISNULL(Letzter_EK_Preis, 0) AS Letzter_EK_Preis, --Letzter EK-Preis je Lieferant
			CASE WHEN ISNULL(letztes_LDatum, '')='' THEN '' ELSE CONVERT(varchar(10), letztes_LDatum, 104) END AS letztes_LDatum, --le Pr vom
			ISNULL(DPreis_VJ_Lief_ZR, 0)-ISNULL(DPreis_VJ_Lief, 0) AS Diff_DPreis_ZR_Min_DPreisVJ, --Diff. O Pr ZR - O Pr VJ
			ISNULL(LMenge, 0) AS LMenge, --EK-Menge Zeitraum

			ISNULL(LMengeVJZR, 0) AS LMengeVJZR, --EK-Menge VJ ZR
			ISNULL(LMengeVJ, 0) AS LMengeVJ, --EK-Menge VJ

			UNIT_CODE, --EK Einheit
			ISNULL(LMenge, 0)*(ISNULL(DPreis_VJ_Lief_ZR, 0)-ISNULL(Preis_gewichtet12Mon, 0)) AS Abweich_abs, --Abweichung absolut

			CASE WHEN ISNULL(Preis_gewichtet12Mon, 0)>0 THEN 
				(ISNULL(DPreis_VJ_Lief_ZR, 0)-ISNULL(Preis_gewichtet12Mon, 0))/ISNULL(Preis_gewichtet12Mon, 0)
				ELSE 0 END AS Abweich_Proz, --Abweichung in %

			CASE WHEN EK_Volume_TOTAL>0 THEN ROUND(ISNULL(EK_Volume/EK_Volume_TOTAL*100, 0), 2) ELSE ROUND(0, 2) END AS Proz_Anteil, --Anteil am EK-Volumen von Lieferant
			ISNULL(AnzBestellungen, 0) AS AnzBestellungen, --Anz. Lieferungen
			ISNULL(DRWert, 0) AS DRWert, --O Rechnungswert
			ISNULL(DLMenge, 0) AS DLMenge --O Liefermenge

			--ISNULL(DPreis_VJ, 0) AS DPreis_VJ,
			--ISNULL(DPreis_VJ_Lief, 0) AS DPreis_VJ_Lief, --O RE-Preis des Vorjahres (2013) je Lieferant
			
			
			
			--ISNULL(DPreis_VJ_Lief_ZR, 0)-ISNULL(Preis_gewichtet12Mon, 0) AS Diff_DPreis, --Differenz d Preis Zeitraum - d Preis l 12 Monate
			--Anteil am EK-Volumen der Grupppe


			--CASE WHEN EK_Volume_TOTAL>0 THEN ISNULL(EK_Volume/EK_Volume_TOTAL*100, 0) ELSE 0 END AS Proz_Anteil,
			--ISNULL(EK_VolumeVJ_ZR, 0) AS EK_VolumeVJ_ZR,
			--UNIT_CODE,
			--ISNULL(DRPreis, 0) AS DRPreis,
			----letztes_LDatum,
			----CONVERT(varchar(10), letztes_LDatum, 104) AS letztes_LDatum,
			--ISNULL(AnzBestellungen, 0) AS AnzBestellungen,
			--ISNULL(DRWert, 0) AS DRWert,
			--ISNULL(DLMenge, 0) AS DLMenge
			FROM
			(
				SELECT
				(SELECT TOP 1 SUM(EK_Volume) FROM @tblArtLiefNeu AS myTmpTblArtLiefNeu WHERE myTmpTblArtLiefNeu.D17_RKEY = myTmpTblArtLiefMain.D17_RKEY) AS EK_Volume_ArtGesamt,
				(SELECT TOP 1 SUM(EK_Volume) FROM @tblArtLiefNeu AS myTmpTblArtLiefNeu) AS EK_Volume_TOTAL,
				* 
				FROM @tblArtLiefNeu AS myTmpTblArtLiefMain --ORDER BY INV_PART_NUMBER, INV_PART_DESCRIPTION
			) AS tbl
--WHERE Lieferant = 'Rolf Schmidt KG'
--WHERE INV_PART_DESCRIPTION LIKE 'FR4 0,10 35/35%' --'Prepreg 7628/610x460Kgel.TG150 phen.gef.'
			ORDER BY EK_Volume_ArtGesamt DESC, INV_PART_DESCRIPTION, EK_Volume DESC
	END

	--Liefert Inventurbestand
	IF @Case_ = 'Inventurbestand'
	BEGIN
		DECLARE @pST_Inventurbestand varchar(255)
		SET @pST_Inventurbestand = @para1

		IF @pST_Inventurbestand = 'Lagerplatz'
		BEGIN
			SELECT '*** Alle Lagerplätze ***' AS CODE 
			UNION ALL
			SELECT CODE FROM DATA0016 ORDER BY CODE
		END

		IF @pST_Inventurbestand = 'InventurbestandAlles'
		BEGIN
/*
			SELECT
				D17_PTR,
				CODE, 
				INV_PART_NUMBER, 
				INV_PART_DESCRIPTION, 
				EINK_Einheit,
				LAGER_Einheit,
				CAST(ISNULL(EinhKonvFaktor, 0) AS DECIMAL(10,4)) AS EinhKonvFaktor,
				CAST(ISNULL(VerfuegbarLagerplatz, 0) AS DECIMAL(10,4)) AS VerfuegbarLagerplatz,
				CAST(Kaufmenge AS DECIMAL(10,4)) AS VerfuegbarLagerplatz_Konv,
				CAST(ISNULL(Normalkosten, 0) AS DECIMAL(10,4)) AS Normalkosten,
				CAST(ISNULL(Preis_LetztBestellung, 0) AS DECIMAL(10,4)) AS Preis_LetztBestellung,
				CAST(ISNULL(Preis_gewichtet12Mon, 0) AS DECIMAL(10,4)) AS Preis_gewichtet12Mon,
				--CAST(VerfuegbarLagerplatz/EinhKonvFaktor*Normalkosten AS DECIMAL(10,4)) AS NK_Wert,
				CASE
				WHEN ISNULL(Normalkosten, 0)>0 THEN
					(SELECT Kaufmenge*Normalkosten AS RES)
				ELSE
					(SELECT 0 AS RES)
				END AS NK_Wert,
				--CAST(VerfuegbarLagerplatz/EinhKonvFaktor*Preis_LetztBestellung AS DECIMAL(10,4)) AS LB_Wert,
				CASE
				WHEN ISNULL(Preis_LetztBestellung, 0)>0 THEN
					(SELECT Kaufmenge*Preis_LetztBestellung AS RES)
				ELSE
					(SELECT 0 AS RES)
				END AS LB_Wert,
				--CAST(VerfuegbarLagerplatz/EinhKonvFaktor*Preis_gewichtet12Mon AS DECIMAL(10,4)) AS DB_Wert
				CASE
				WHEN ISNULL(Preis_gewichtet12Mon, 0)>0 THEN
					(SELECT Kaufmenge*Preis_gewichtet12Mon AS RES)
				ELSE
					(SELECT 0 AS RES)
				END  AS DB_Wert

				FROM
				(
					SELECT  TOP 100 PERCENT 
						dbo.DATA0017.RKEY AS D17_PTR,
						dbo.DATA0016.CODE, 
						dbo.DATA0017.INV_PART_NUMBER, 
						--dbo.DATA0017.INV_PART_DESCRIPTION, 
						CASE
							WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
								dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
							ELSE
								dbo.DATA0017.INV_PART_DESCRIPTION
						END AS INV_PART_DESCRIPTION,
						DATA0002_1.UNIT_CODE AS LAGER_Einheit,
						dbo.DATA0002.UNIT_CODE AS EINK_Einheit,
						dbo.DATA0017.STOCK_PURCH AS EinhKonvFaktor,
						dbo.DATA0019.QUAN_ON_HAND As VerfuegbarLagerplatz,
						dbo.DATA0019.QUAN_ON_HAND/dbo.DATA0017.STOCK_PURCH As Kaufmenge,
						ISNULL(dbo.DATA0017.STD_COST, 0) As Normalkosten,
						(
							SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
							FROM         dbo.DATA0095 AS D95 INNER JOIN
												  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
												  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
							WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY)
							ORDER BY D95.TRAN_DATE DESC

						) AS Preis_LetztBestellung,
						(
							CASE
								WHEN
								ISNULL(
								(SELECT
									SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
									FROM
									(
										SELECT     PRICE, QUAN_RECD, QUAN_RETN
										FROM         dbo.DATA0095 AS D95 INNER JOIN
															  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
															  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
										WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY) 
												AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
												AND (ISNULL(D71.PRICE, 0) > 0)
												AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
									) As myTbl12Mon
								), 0)>0 THEN 
								(
									SELECT
									SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
									FROM
									(
										SELECT     PRICE, QUAN_RECD, QUAN_RETN
										FROM         dbo.DATA0095 AS D95 INNER JOIN
															  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
															  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
										WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY) 
												AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
												AND (ISNULL(D71.PRICE, 0) > 0)
												AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
									) As myTbl12Mon
								)
								ELSE
								(
									SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
									FROM         dbo.DATA0095 AS D95 INNER JOIN
														  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
														  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
									WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY)
									ORDER BY D95.TRAN_DATE DESC
								)
							END
						) AS Preis_gewichtet12Mon

					FROM         dbo.DATA0019 WITH (NOLOCK) INNER JOIN
										  dbo.DATA0016 WITH (NOLOCK) ON dbo.DATA0019.LOCATION_PTR = dbo.DATA0016.RKEY INNER JOIN
										  dbo.DATA0017 ON dbo.DATA0019.INVENTORY_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
										  dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.STOCK_UNIT_PTR = DATA0002_1.RKEY
					WHERE     
						(dbo.DATA0017.ACTIVE_FLAG = 'Y') 
						--AND (ISNULL(dbo.DATA0017.MANUFACTURER_CODE, '') = '') 01.12.2014/DSI deaktiviert nach Absprache mit Hr. Wienecke (wegen Hr. Seidels Inventurberichten)
						--AND (dbo.DATA0017.S_B_N = 'N') 
						AND (dbo.DATA0017.TTYPE = 'R') 
						AND (dbo.DATA0017.PROD_CODE_SELL_PTR <> 95) 
						AND (dbo.DATA0017.INV_PART_NUMBER NOT LIKE 'REC-%') AND 
										  (dbo.DATA0019.QUAN_ON_HAND > 0) 
											--AND (NOT (dbo.DATA0017.RKEY IN (312, 55, 410, 798, 1005, 29881, 28876)))
						AND dbo.DATA0016.CODE LIKE @para2
					) AS myTbl
					ORDER BY CODE, INV_PART_NUMBER, INV_PART_DESCRIPTION
*/
			SELECT
				D17_PTR,
				CODE, 
				INV_PART_NUMBER, 
				INV_PART_DESCRIPTION, 
				EINK_Einheit,
				LAGER_Einheit,
				CAST(ISNULL(EinhKonvFaktor, 0) AS DECIMAL(10,4)) AS EinhKonvFaktor,
				CAST(ISNULL(VerfuegbarLagerplatz, 0) AS DECIMAL(10,4)) AS VerfuegbarLagerplatz,
				CAST(Kaufmenge AS DECIMAL(10,4)) AS VerfuegbarLagerplatz_Konv,
				CAST(ISNULL(Normalkosten, 0) AS DECIMAL(10,4)) AS Normalkosten,
				CAST(ISNULL(Preis_LetztBestellung, 0) AS DECIMAL(10,4)) AS Preis_LetztBestellung,
				CAST(ISNULL(Preis_gewichtet12Mon, 0) AS DECIMAL(10,4)) AS Preis_gewichtet12Mon,
				--CAST(VerfuegbarLagerplatz/EinhKonvFaktor*Normalkosten AS DECIMAL(10,4)) AS NK_Wert,
				CASE
				WHEN ISNULL(Normalkosten, 0)>0 THEN
					(SELECT VerfuegbarLagerplatz*Normalkosten AS RES)
				ELSE
					(SELECT 0 AS RES)
				END AS NK_Wert,
				--CAST(VerfuegbarLagerplatz/EinhKonvFaktor*Preis_LetztBestellung AS DECIMAL(10,4)) AS LB_Wert,
				CASE
				WHEN ISNULL(Preis_LetztBestellung, 0)>0 THEN
					(SELECT Kaufmenge*Preis_LetztBestellung AS RES)
				ELSE
					--(SELECT 0 AS RES) Vorgaben MSE am 11.10.2015
					(SELECT VerfuegbarLagerplatz*Normalkosten AS RES)
				END AS LB_Wert,
				--CAST(VerfuegbarLagerplatz/EinhKonvFaktor*Preis_gewichtet12Mon AS DECIMAL(10,4)) AS DB_Wert
				CASE
				WHEN ISNULL(Preis_gewichtet12Mon, 0)>0 THEN
					(SELECT Kaufmenge*Preis_gewichtet12Mon AS RES)
				ELSE
					--(SELECT 0 AS RES) Vorgaben MSE am 11.10.2015
					(SELECT VerfuegbarLagerplatz*Normalkosten AS RES)
				END  AS DB_Wert,
				CASE
					WHEN Preis_LetztBestellung=0 AND Preis_gewichtet12Mon=0 THEN
						'keine Bestellung vorhanden (wird mit Standardkosten gerechnet)'
					ELSE
						''
				END AS BestellInfo

				FROM
				(
					SELECT  TOP 100 PERCENT 
						dbo.DATA0017.RKEY AS D17_PTR,
						dbo.DATA0016.CODE, 
						dbo.DATA0017.INV_PART_NUMBER, 
						--dbo.DATA0017.INV_PART_DESCRIPTION, 
						CASE
							WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
								dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
							ELSE
								dbo.DATA0017.INV_PART_DESCRIPTION
						END AS INV_PART_DESCRIPTION,
						DATA0002_1.UNIT_CODE AS LAGER_Einheit,
						dbo.DATA0002.UNIT_CODE AS EINK_Einheit,
						dbo.DATA0017.STOCK_PURCH AS EinhKonvFaktor,
						dbo.DATA0019.QUAN_ON_HAND As VerfuegbarLagerplatz,
						dbo.DATA0019.QUAN_ON_HAND/dbo.DATA0017.STOCK_PURCH As Kaufmenge,
						ISNULL(dbo.DATA0017.STD_COST, 0) As Normalkosten,
						(
							SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
							FROM         dbo.DATA0095 AS D95 INNER JOIN
												  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
												  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
							WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY)
							ORDER BY D95.TRAN_DATE DESC

						) AS Preis_LetztBestellung,
						(
							CASE
								WHEN
								ISNULL(
								(SELECT
									SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
									FROM
									(
										SELECT     PRICE, QUAN_RECD, QUAN_RETN
										FROM         dbo.DATA0095 AS D95 INNER JOIN
															  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
															  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
										WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY) 
												AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
												AND (ISNULL(D71.PRICE, 0) > 0)
												AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
									) As myTbl12Mon
								), 0)>0 THEN 
								(
									SELECT
									SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
									FROM
									(
										SELECT     PRICE, QUAN_RECD, QUAN_RETN
										FROM         dbo.DATA0095 AS D95 INNER JOIN
															  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
															  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
										WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY) 
												AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
												AND (ISNULL(D71.PRICE, 0) > 0)
												AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
									) As myTbl12Mon
								)
								ELSE
								(
									SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
									FROM         dbo.DATA0095 AS D95 INNER JOIN
														  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
														  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
									WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY)
									ORDER BY D95.TRAN_DATE DESC
								)
							END
						) AS Preis_gewichtet12Mon

					FROM         dbo.DATA0019 WITH (NOLOCK) INNER JOIN
										  dbo.DATA0016 WITH (NOLOCK) ON dbo.DATA0019.LOCATION_PTR = dbo.DATA0016.RKEY INNER JOIN
										  dbo.DATA0017 ON dbo.DATA0019.INVENTORY_PTR = dbo.DATA0017.RKEY INNER JOIN
										  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
										  dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.STOCK_UNIT_PTR = DATA0002_1.RKEY
					WHERE     
						(dbo.DATA0017.ACTIVE_FLAG = 'Y') 
						--AND (ISNULL(dbo.DATA0017.MANUFACTURER_CODE, '') = '') 01.12.2014/DSI deaktiviert nach Absprache mit Hr. Wienecke (wegen Hr. Seidels Inventurberichten)
						--AND (dbo.DATA0017.S_B_N = 'N') 
						AND (dbo.DATA0017.TTYPE = 'R') 
						AND (dbo.DATA0017.PROD_CODE_SELL_PTR <> 95) 
						AND (dbo.DATA0017.INV_PART_NUMBER NOT LIKE 'REC-%') AND 
										  (dbo.DATA0019.QUAN_ON_HAND > 0) 
											--AND (NOT (dbo.DATA0017.RKEY IN (312, 55, 410, 798, 1005, 29881, 28876)))
						AND dbo.DATA0016.CODE LIKE @para2
					) AS myTbl
					ORDER BY CODE, INV_PART_NUMBER, INV_PART_DESCRIPTION
		END

		IF @pST_Inventurbestand = 'InventurbestandAllesGrp'
		BEGIN
			--DECLARE
			--@para2 varchar(255)
			--SET @para2 = '%'

			SELECT
				CODE,
				SUM(NK_Wert) AS NK_Wert,
				SUM(LB_Wert) AS LB_Wert, 
				SUM(DB_Wert) AS DB_Wert,
				BestellInfo
			FROM
			(
				SELECT
					--D17_PTR,
					CODE, 
					--INV_PART_NUMBER, 
					--INV_PART_DESCRIPTION, 
					--EINK_Einheit,
					--LAGER_Einheit,
					--CAST(ISNULL(EinhKonvFaktor, 0) AS DECIMAL(10,4)) AS EinhKonvFaktor,
					--CAST(ISNULL(VerfuegbarLagerplatz, 0) AS DECIMAL(10,4)) AS VerfuegbarLagerplatz,
					--CAST(Kaufmenge AS DECIMAL(10,4)) AS VerfuegbarLagerplatz_Konv,
					--CAST(ISNULL(Normalkosten, 0) AS DECIMAL(10,4)) AS Normalkosten,
					--CAST(ISNULL(Preis_LetztBestellung, 0) AS DECIMAL(10,4)) AS Preis_LetztBestellung,
					--CAST(ISNULL(Preis_gewichtet12Mon, 0) AS DECIMAL(10,4)) AS Preis_gewichtet12Mon,
					----CAST(VerfuegbarLagerplatz/EinhKonvFaktor*Normalkosten AS DECIMAL(10,4)) AS NK_Wert,
					CASE
					WHEN ISNULL(Normalkosten, 0)>0 THEN
						(SELECT  VerfuegbarLagerplatz*Normalkosten AS RES)
					ELSE
						(SELECT  0 AS RES)
					END AS NK_Wert,
					--CAST(VerfuegbarLagerplatz/EinhKonvFaktor*Preis_LetztBestellung AS DECIMAL(10,4)) AS LB_Wert,
					CASE
					WHEN ISNULL(Preis_LetztBestellung, 0)>0 THEN
						(SELECT Kaufmenge*Preis_LetztBestellung AS RES)
					ELSE
						--(SELECT 0 AS RES) --Vorgaben MSE 11.10.2015
						(SELECT  VerfuegbarLagerplatz*Normalkosten AS RES)
					END AS LB_Wert,
					--CAST(VerfuegbarLagerplatz/EinhKonvFaktor*Preis_gewichtet12Mon AS DECIMAL(10,4)) AS DB_Wert
					CASE
					WHEN ISNULL(Preis_gewichtet12Mon, 0)>0 THEN
						(SELECT Kaufmenge*Preis_gewichtet12Mon AS RES)
					ELSE
						--(SELECT  0 AS RES) --Vorgaben MSE 11.10.2015
						(SELECT  VerfuegbarLagerplatz*Normalkosten AS RES)
					END AS DB_Wert,
					CASE
						WHEN Preis_LetztBestellung=0 AND Preis_gewichtet12Mon=0 THEN
							'keine Bestellung vorhanden (wird mit Standardkosten gerechnet)'
						ELSE
							''
					END AS BestellInfo										

					FROM
					(
						SELECT  TOP 100 PERCENT 
							dbo.DATA0017.RKEY AS D17_PTR,
							dbo.DATA0016.CODE, 
							dbo.DATA0017.INV_PART_NUMBER, 
							--dbo.DATA0017.INV_PART_DESCRIPTION, 
							CASE
								WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
									dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
								ELSE
									dbo.DATA0017.INV_PART_DESCRIPTION
							END AS INV_PART_DESCRIPTION,
							DATA0002_1.UNIT_CODE AS LAGER_Einheit,
							dbo.DATA0002.UNIT_CODE AS EINK_Einheit,
							dbo.DATA0017.STOCK_PURCH AS EinhKonvFaktor,
							dbo.DATA0019.QUAN_ON_HAND As VerfuegbarLagerplatz,
							dbo.DATA0019.QUAN_ON_HAND/dbo.DATA0017.STOCK_PURCH As Kaufmenge,
							ISNULL(dbo.DATA0017.STD_COST, 0) As Normalkosten,
							(
								SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
								FROM         dbo.DATA0095 AS D95 INNER JOIN
													  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
													  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
								WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY)
								ORDER BY D95.TRAN_DATE DESC

							) AS Preis_LetztBestellung,
							(
								CASE
									WHEN
									ISNULL(
									(SELECT
										SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
										FROM
										(
											SELECT     PRICE, QUAN_RECD, QUAN_RETN
											FROM         dbo.DATA0095 AS D95 INNER JOIN
																  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
																  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
											WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY) 
													AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
													AND (ISNULL(D71.PRICE, 0) > 0)
													AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
										) As myTbl12Mon
									), 0)>0 THEN 
									(
										SELECT
										SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
										FROM
										(
											SELECT     PRICE, QUAN_RECD, QUAN_RETN
											FROM         dbo.DATA0095 AS D95 INNER JOIN
																  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
																  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
											WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY) 
													AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
													AND (ISNULL(D71.PRICE, 0) > 0)
													AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
										) As myTbl12Mon
									)
									ELSE
									(
										SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
										FROM         dbo.DATA0095 AS D95 INNER JOIN
															  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
															  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
										WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY)
										ORDER BY D95.TRAN_DATE DESC
									)
								END
							) AS Preis_gewichtet12Mon

						FROM         dbo.DATA0019 WITH (NOLOCK) INNER JOIN
											  dbo.DATA0016 WITH (NOLOCK) ON dbo.DATA0019.LOCATION_PTR = dbo.DATA0016.RKEY INNER JOIN
											  dbo.DATA0017 ON dbo.DATA0019.INVENTORY_PTR = dbo.DATA0017.RKEY INNER JOIN
											  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
											  dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.STOCK_UNIT_PTR = DATA0002_1.RKEY
						WHERE     
							(dbo.DATA0017.ACTIVE_FLAG = 'Y') 
							--AND (ISNULL(dbo.DATA0017.MANUFACTURER_CODE, '') = '') 01.12.2014/DSI deaktiviert nach Absprache mit Hr. Wienecke (wegen Hr. Seidels Inventurberichten)
							--AND (dbo.DATA0017.S_B_N = 'N') 
							AND (dbo.DATA0017.TTYPE = 'R') 
							AND (dbo.DATA0017.PROD_CODE_SELL_PTR <> 95) 
							AND (dbo.DATA0017.INV_PART_NUMBER NOT LIKE 'REC-%') AND 
											  (dbo.DATA0019.QUAN_ON_HAND > 0) 
												--AND (NOT (dbo.DATA0017.RKEY IN (312, 55, 410, 798, 1005, 29881, 28876)))
							AND dbo.DATA0016.CODE LIKE @para2
						) AS myTbl
					) AS myGrpTbl 
					GROUP BY CODE, BestellInfo
					ORDER BY CODE --, INV_PART_NUMBER, INV_PART_DESCRIPTION		
		END

		IF @pST_Inventurbestand = 'InventurbestandAlles_Konsi'
		BEGIN
			SELECT
				D17_PTR,
				CODE, 
				INV_PART_NUMBER, 
				INV_PART_DESCRIPTION, 
				EINK_Einheit,
				LAGER_Einheit,
				CAST(ISNULL(EinhKonvFaktor, 0) AS DECIMAL(10,4)) AS EinhKonvFaktor,
				CAST(ISNULL(VerfuegbarLagerplatz, 0) AS DECIMAL(10,4)) AS VerfuegbarLagerplatz,
				CAST(Kaufmenge AS DECIMAL(10,4)) AS VerfuegbarLagerplatz_Konv,
				CAST(ISNULL(Normalkosten, 0) AS DECIMAL(10,4)) AS Normalkosten,
				CAST(ISNULL(Preis_LetztBestellung, 0) AS DECIMAL(10,4)) AS Preis_LetztBestellung,
				CAST(ISNULL(Preis_gewichtet12Mon, 0) AS DECIMAL(10,4)) AS Preis_gewichtet12Mon,
				--CAST(VerfuegbarLagerplatz/EinhKonvFaktor*Normalkosten AS DECIMAL(10,4)) AS NK_Wert,
				CASE
				WHEN ISNULL(Normalkosten, 0)>0 THEN
					(SELECT VerfuegbarLagerplatz*Normalkosten AS RES)
				ELSE
					(SELECT 0 AS RES)
				END AS NK_Wert,
				--CAST(VerfuegbarLagerplatz/EinhKonvFaktor*Preis_LetztBestellung AS DECIMAL(10,4)) AS LB_Wert,
				CASE
				WHEN ISNULL(Preis_LetztBestellung, 0)>0 THEN
					(SELECT Kaufmenge*Preis_LetztBestellung AS RES)
				ELSE
					(SELECT 0 AS RES)
				END AS LB_Wert,
				--CAST(VerfuegbarLagerplatz/EinhKonvFaktor*Preis_gewichtet12Mon AS DECIMAL(10,4)) AS DB_Wert
				CASE
				WHEN ISNULL(Preis_gewichtet12Mon, 0)>0 THEN
					(SELECT Kaufmenge*Preis_gewichtet12Mon AS RES)
				ELSE
					(SELECT 0 AS RES)
				END  AS DB_Wert

				FROM
				(
					SELECT  TOP 100 PERCENT 
						dbo.DATA0017.RKEY AS D17_PTR,
						dbo.DATA0016.CODE, 
						dbo.DATA0017.INV_PART_NUMBER, 
						--dbo.DATA0017.INV_PART_DESCRIPTION, 
						CASE
							WHEN ISNULL(dbo.DATA0017.LONG_INVENTORY_PART_NUMBER, '')<>'' THEN 
								dbo.DATA0017.LONG_INVENTORY_PART_NUMBER
							ELSE
								dbo.DATA0017.INV_PART_DESCRIPTION
						END AS INV_PART_DESCRIPTION,
						DATA0002_1.UNIT_CODE AS LAGER_Einheit,
						dbo.DATA0002.UNIT_CODE AS EINK_Einheit,
						dbo.DATA0017.STOCK_PURCH AS EinhKonvFaktor,
						dbo.DATA0340.QUANTITY As VerfuegbarLagerplatz,
						dbo.DATA0340.QUANTITY/dbo.DATA0017.STOCK_PURCH As Kaufmenge,
						ISNULL(dbo.DATA0017.STD_COST, 0) As Normalkosten,
						ISNULL((
							--SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
							--FROM         dbo.DATA0095 AS D95 INNER JOIN
							--					  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
							--					  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
							--WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY)
							--ORDER BY D95.TRAN_DATE DESC
							SELECT     TOP 1 ISNULL(D467.PRICE, 0) AS RES 
							FROM         dbo.DATA0341 AS D341 INNER JOIN
										dbo.DATA0467 AS D467 ON D341.DATA0467_PTR = D467.RKEY
							WHERE     (D341.TRAN_TP = 1) AND (D467.INVT_PTR = dbo.DATA0017.RKEY)
							ORDER BY D341.TRAN_DATE DESC

						), 0) AS Preis_LetztBestellung,
						ISNULL((
							CASE
								WHEN
								ISNULL(
								(
									--SELECT
									--	SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
									--FROM
									--(
									--	SELECT     PRICE, QUAN_RECD, QUAN_RETN
									--	FROM         dbo.DATA0095 AS D95 INNER JOIN
									--						  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
									--						  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
									--	WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY) 
									--			AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
									--			AND (ISNULL(D71.PRICE, 0) > 0)
									--			AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
									--) As myTbl12Mon
									SELECT
										SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
									FROM
									(
										SELECT     PRICE, QUAN_RECD, QUAN_RETN
										FROM         dbo.DATA0341 AS D341 INNER JOIN
												dbo.DATA0467 AS D467 ON D341.DATA0467_PTR = D467.RKEY
										WHERE     (D341.TRAN_TP = 1) AND (D467.INVT_PTR = dbo.DATA0017.RKEY) 
												AND (D341.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
												AND (ISNULL(D467.PRICE, 0) > 0)
												AND ISNULL(D467.QUAN_RECD, 0) - ISNULL(D467.QUAN_RETN, 0) > 0
									) As myTbl12Mon
								), 0)>0 THEN 
								(
									--SELECT
									--SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
									--FROM
									--(
									--	SELECT     PRICE, QUAN_RECD, QUAN_RETN
									--	FROM         dbo.DATA0095 AS D95 INNER JOIN
									--						  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
									--						  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
									--	WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY) 
									--			AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
									--			AND (ISNULL(D71.PRICE, 0) > 0)
									--			AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
									--) As myTbl12Mon
									SELECT
										SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
									FROM
									(
										SELECT     PRICE, QUAN_RECD, QUAN_RETN
										FROM         dbo.DATA0341 AS D341 INNER JOIN
												dbo.DATA0467 AS D467 ON D341.DATA0467_PTR = D467.RKEY
										WHERE     (D341.TRAN_TP = 1) AND (D467.INVT_PTR = dbo.DATA0017.RKEY) 
												AND (D341.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
												AND (ISNULL(D467.PRICE, 0) > 0)
												AND ISNULL(D467.QUAN_RECD, 0) - ISNULL(D467.QUAN_RETN, 0) > 0
									) As myTbl12Mon
								)
								ELSE
								(
									--SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
									--FROM         dbo.DATA0095 AS D95 INNER JOIN
									--					  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
									--					  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
									--WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY)
									--ORDER BY D95.TRAN_DATE DESC
									SELECT     TOP 1 ISNULL(D467.PRICE, 0) AS RES 
									FROM         dbo.DATA0341 AS D341 INNER JOIN
												dbo.DATA0467 AS D467 ON D341.DATA0467_PTR = D467.RKEY
									WHERE     (D341.TRAN_TP = 1) AND (D467.INVT_PTR = dbo.DATA0017.RKEY)
									ORDER BY D341.TRAN_DATE DESC
								)
							END
						), 0) AS Preis_gewichtet12Mon

					FROM         
							  dbo.DATA0002 INNER JOIN
							  dbo.DATA0017 ON dbo.DATA0002.RKEY = dbo.DATA0017.PURCH_UNIT_PTR INNER JOIN
							  dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.STOCK_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							  dbo.DATA0340 INNER JOIN
							  dbo.DATA0016 WITH (NOLOCK) ON dbo.DATA0340.DATA0016_PTR = dbo.DATA0016.RKEY ON dbo.DATA0017.RKEY = dbo.DATA0340.DATA0017_PTR
					WHERE     
						(dbo.DATA0017.ACTIVE_FLAG = 'Y') 
						--AND (ISNULL(dbo.DATA0017.MANUFACTURER_CODE, '') = '') 01.12.2014/DSI deaktiviert nach Absprache mit Hr. Wienecke (wegen Hr. Seidels Inventurberichten)
						--AND (dbo.DATA0017.S_B_N = 'N') 
						AND (dbo.DATA0017.TTYPE = 'R') 
						AND (dbo.DATA0017.PROD_CODE_SELL_PTR <> 95) 
						AND (dbo.DATA0017.INV_PART_NUMBER NOT LIKE 'REC-%') AND 
										  (dbo.DATA0340.QUANTITY > 0) 
											--AND (NOT (dbo.DATA0017.RKEY IN (312, 55, 410, 798, 1005, 29881, 28876)))
						AND dbo.DATA0016.CODE LIKE @para2
					) AS myTbl
					ORDER BY CODE, INV_PART_NUMBER, INV_PART_DESCRIPTION
		END

	END

	--Zusatzinfos für die Inventurwerte aus Excel 
	IF @Case_ = 'Artikelzusatzinfos'
	BEGIN
		SELECT     TOP 1 dbo.DATA0017.RKEY AS INV_PTR, dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION, 
				dbo.DATA0016.LOCATION, dbo.DATA0002.UNIT_CODE AS Einkaufseinheit, dbo.DATA0017.STOCK_PURCH AS KonvFaktor, 
				dbo.DATA0017.STD_COST, dbo.DATA0017.NEW_STD_COST,
				--ISNULL((
				--	SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
				--	FROM         dbo.DATA0095 AS D95 INNER JOIN
				--						  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
				--						  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
				--	WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY)
				--	ORDER BY D95.TRAN_DATE DESC
				--), 0) AS Preis_LetzteBestellung,
				ISNULL((
					SELECT     TOP 1 ISNULL(D108.PRICE, 0) AS RES
					FROM         dbo.DATA0095 AS D95 INNER JOIN
										  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
										  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
										  dbo.DATA0108 AS D108 ON D71.RKEY = D108.DATA0071_PTR
					WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY)
					ORDER BY D95.TRAN_DATE DESC
				), 0) AS Preis_LetzteRechnung,
				ISNULL((
					CASE
						WHEN
						ISNULL(
						(SELECT
							SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
							FROM
							(
								SELECT     PRICE, QUAN_RECD, QUAN_RETN
								FROM         dbo.DATA0095 AS D95 INNER JOIN
													  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
													  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
								WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY) 
										AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
										AND (ISNULL(D71.PRICE, 0) > 0)
										AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
							) As myTbl12Mon
						), 0)>0 THEN 
						(
							SELECT
							SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
							FROM
							(
								SELECT     PRICE, QUAN_RECD, QUAN_RETN
								FROM         dbo.DATA0095 AS D95 INNER JOIN
													  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
													  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
								WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY) 
										AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
										AND (ISNULL(D71.PRICE, 0) > 0)
										AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
							) As myTbl12Mon
						)
						ELSE
						(
							SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
							FROM         dbo.DATA0095 AS D95 INNER JOIN
												  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
												  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
							WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = dbo.DATA0017.RKEY)
							ORDER BY D95.TRAN_DATE DESC
						)
					END
				), 0) AS Preis_gewichtet12Mon
		FROM         dbo.DATA0019 WITH (NOLOCK) INNER JOIN
							  dbo.DATA0016 WITH (NOLOCK) ON dbo.DATA0019.LOCATION_PTR = dbo.DATA0016.RKEY INNER JOIN
							  dbo.DATA0017 ON dbo.DATA0019.INVENTORY_PTR = dbo.DATA0017.RKEY INNER JOIN
							  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							  dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.STOCK_UNIT_PTR = DATA0002_1.RKEY
		WHERE     
				--(dbo.DATA0017.ACTIVE_FLAG = 'Y') 
				--AND (ISNULL(dbo.DATA0017.MANUFACTURER_CODE, '') = '') 
				--AND (dbo.DATA0017.TTYPE = 'R') 
				--AND (dbo.DATA0017.PROD_CODE_SELL_PTR <> 95) 
				--AND (dbo.DATA0017.INV_PART_NUMBER NOT LIKE 'REC-%') 
				--AND (dbo.DATA0019.QUAN_ON_HAND > 0) 
				--AND 
				(dbo.DATA0017.INV_PART_NUMBER = @para1) --AND (dbo.DATA0017.INV_PART_DESCRIPTION = @para2)
	END

/*
	--Materialverbrauch
	IF @Case_ = 'Materialverbrauch'
	BEGIN
		SELECT
			*
		FROM
		(
		------------------------------------------------------------------------------------------------------
		--SES Ätzen alkalisch
		------------------------------------------------------------------------------------------------------
		SELECT
			Abteilung,
			Anlage,
			Artikel,
			Bezeichnung,
			Einheit_ AS Lagereinheit,
			(Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013) AS Verbrauch_2013,
			Durchsatz_ZUm2_2013,
			CASE
				WHEN Einheit_='KG' OR Einheit_='LTR' THEN
					CAST((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)/Durchsatz_ZUm2_2013*1000 AS DECIMAL(10,2))
				ELSE
					CAST((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)/Durchsatz_ZUm2_2013 AS DECIMAL(10,2))
			END AS  rel_Verbrauch,
			CASE
				WHEN Einheit_='KG' THEN 'gr' 
				ELSE
					CASE
						WHEN Einheit_='LTR' THEN 'ml' ELSE Einheit_
					END
			END AS Verbrauch_gerechnet_in,
			CAST(Preis_gewichtet12Mon AS DECIMAL(10,2)) AS Preis_gew12Mon,
			CAST(((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)*Preis_gewichtet12Mon)/Durchsatz_ZUm2_2013 AS DECIMAL(10,4)) AS Rel_Kosten,
			CAST(((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)*Preis_gewichtet12Mon) AS DECIMAL(10,2)) AS Abs_Kosten,
			Einheit_ AS Preis_Kosten_Einheit
		FROM
		(
			SELECT
				D17_PTR,
				Abteilung,
				Anlage,
				Artikel,
				Bezeichnung,
				Einheit_,
				CAST(ISNULL((
					SELECT     SUM(LgMg) AS InvBestand
					FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
					WHERE     (JahrMonat = '2012.12') AND RKEY=myTbl1.D17_PTR
				), 0) AS DECIMAL(10,2)) AS Bestand_01_01_2013,
				CAST(ISNULL((
					SELECT     SUM(QUANTITY) AS Zugang
					FROM         dbo.DATA0095
					WHERE   TRAN_TP = 5 AND INVT_PTR = myTbl1.D17_PTR 
							AND YEAR(TRAN_DATE) = 2013 AND MONTH(TRAN_DATE) < 11
				), 0) AS DECIMAL(10,2))AS Zugaenge_2013,
				CAST(ISNULL((
					SELECT     SUM(LgMg) AS InvBestand
					FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
					WHERE     (JahrMonat = '2013.10') AND RKEY=myTbl1.D17_PTR
				), 0) AS DECIMAL(10,2)) AS Bestand_31_12_2013,
				CAST(ISNULL((
					SELECT
						SUM(
						(dbo.ARTIKELDATEN.ZuX*dbo.ARTIKELDATEN.ZuY*
						CAST((CAST(dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT AS FLOAT)/[ELP_Zu]+0.9999) AS INT)/1000000) 
						)
						AS Zu_m2
					FROM         dbo.ARTIKELDATEN RIGHT OUTER JOIN
										  dbo.DATA0050 INNER JOIN
										  dbo.DATA0048 WITH (nolock) INNER JOIN
										  dbo.DATA0034 WITH (nolock) ON dbo.DATA0048.WORK_CENTER_PTR = dbo.DATA0034.RKEY INNER JOIN
										  dbo.DATA0006 WITH (nolock) ON dbo.DATA0048.WO_PTR = dbo.DATA0006.RKEY ON dbo.DATA0050.RKEY = dbo.DATA0006.CUST_PART_PTR ON 
										  dbo.ARTIKELDATEN.CUST_PART_PTR = dbo.DATA0006.CUST_PART_PTR LEFT OUTER JOIN
										  dbo.DATA0056 WITH (nolock) LEFT OUTER JOIN
										  dbo.abfr_NP0056 ON dbo.DATA0056.RKEY = dbo.abfr_NP0056.FILE_POINTER LEFT OUTER JOIN
										  dbo.DATA0038 ON dbo.DATA0056.WO_PTR = dbo.DATA0038.SOURCE_PTR AND dbo.DATA0056.STEP = dbo.DATA0038.STEP_NUMBER ON 
										  dbo.DATA0048.TPUT_PTR = dbo.DATA0056.RKEY
					WHERE   YEAR(dbo.DATA0048.TDATE)=2013 AND MONTH(dbo.DATA0048.TDATE)<11
							AND (dbo.DATA0034.DEPT_CODE = 'ÄTZA-01-01') 
							AND (dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT > 0)
				), 0) AS DECIMAL(10,2)) As Durchsatz_ZUm2_2013,
				CAST((
					CASE
						WHEN
						ISNULL(
						(SELECT
							SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
							FROM
							(
								SELECT     D95.INVT_PTR, PRICE, QUAN_RECD, QUAN_RETN
								FROM         dbo.DATA0095 AS D95 INNER JOIN
													  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
													  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
								WHERE     (D95.TRAN_TP = 5) --AND (D95.INVT_PTR = myTbl2.D17_PTR) 
										AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
										AND (ISNULL(D71.PRICE, 0) > 0)
										AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
							) As myTbl12Mon
							WHERE (INVT_PTR = myTbl1.D17_PTR) 
						), 0)>0 THEN 
						(
							SELECT
							SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
							FROM
							(
								SELECT     D95.INVT_PTR, PRICE, QUAN_RECD, QUAN_RETN
								FROM         dbo.DATA0095 AS D95 INNER JOIN
													  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
													  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
								WHERE     (D95.TRAN_TP = 5) --AND (D95.INVT_PTR = myTbl2.D17_PTR) 
										AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
										AND (ISNULL(D71.PRICE, 0) > 0)
										AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
							) As myTbl12Mon
							WHERE (INVT_PTR = myTbl1.D17_PTR) 
						)
						ELSE
						(
							SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
							FROM         dbo.DATA0095 AS D95 INNER JOIN
												  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
												  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
							--WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = myTbl1.D17_PTR)
							--ORDER BY D95.TRAN_DATE DESC
							WHERE D95.RKEY=(SELECT MAX(RKEY) AS RES FROM DATA0095 WHERE TRAN_TP = 5 AND INVT_PTR = myTbl1.D17_PTR)
						)
					END
				) AS DECIMAL(10,2)) AS Preis_gewichtet12Mon


			FROM
			(
				SELECT  dbo.DATA0017.RKEY AS D17_PTR, LIVE2.dbo.MatRueck_Abteilung.Abteilung, 
						LIVE2.dbo.MatRueck_Anlage.Anlage, dbo.DATA0017.INV_PART_NUMBER AS Artikel, 
						dbo.DATA0017.INV_PART_DESCRIPTION AS Bezeichnung, dbo.DATA0002.UNIT_CODE AS Einheit_
				FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							  LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							  LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							  dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							  dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY
				GROUP BY dbo.DATA0017.RKEY, LIVE2.dbo.MatRueck_Abteilung.Abteilung, LIVE2.dbo.MatRueck_Anlage.Anlage, dbo.DATA0017.INV_PART_NUMBER, 
									  dbo.DATA0017.INV_PART_DESCRIPTION, dbo.DATA0002.UNIT_CODE
				HAVING      (LIVE2.dbo.MatRueck_Anlage.Anlage = 'SES Ätzen alkalisch')
			) As myTbl1
		) As myTbl2

		------------------------------------------------------------------------------------------------------
		UNION
		------------------------------------------------------------------------------------------------------
		--SES Festresist striper
		------------------------------------------------------------------------------------------------------
		SELECT
			Abteilung,
			Anlage,
			Artikel,
			Bezeichnung,
			Einheit_ AS Lagereinheit,
			(Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013) AS Verbrauch_2013,
			Durchsatz_ZUm2_2013,
			CASE
				WHEN Einheit_='KG' OR Einheit_='LTR' THEN
					CAST((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)/Durchsatz_ZUm2_2013*1000 AS DECIMAL(10,2))
				ELSE
					CAST((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)/Durchsatz_ZUm2_2013 AS DECIMAL(10,2))
			END AS  rel_Verbrauch,
			CASE
				WHEN Einheit_='KG' THEN 'gr' 
				ELSE
					CASE
						WHEN Einheit_='LTR' THEN 'ml' ELSE Einheit_
					END
			END AS Verbrauch_gerechnet_in,
			CAST(Preis_gewichtet12Mon AS DECIMAL(10,2)) AS Preis_gew12Mon,
			CAST(((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)*Preis_gewichtet12Mon)/Durchsatz_ZUm2_2013 AS DECIMAL(10,4)) AS Rel_Kosten,
			CAST(((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)*Preis_gewichtet12Mon) AS DECIMAL(10,2)) AS Abs_Kosten,
			Einheit_ AS Preis_Kosten_Einheit
		FROM
		(
			SELECT
				D17_PTR,
				Abteilung,
				Anlage,
				Artikel,
				Bezeichnung,
				Einheit_,
				CAST(ISNULL((
					SELECT     SUM(LgMg) AS InvBestand
					FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
					WHERE     (JahrMonat = '2012.12') AND RKEY=myTbl1.D17_PTR
				), 0) AS DECIMAL(10,2)) AS Bestand_01_01_2013,
				CAST(ISNULL((
					SELECT     SUM(QUANTITY) AS Zugang
					FROM         dbo.DATA0095
					WHERE   TRAN_TP = 5 AND INVT_PTR = myTbl1.D17_PTR 
							AND YEAR(TRAN_DATE) = 2013 AND MONTH(TRAN_DATE) < 11
				), 0) AS DECIMAL(10,2))AS Zugaenge_2013,
				CAST(ISNULL((
					SELECT     SUM(LgMg) AS InvBestand
					FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
					WHERE     (JahrMonat = '2013.10') AND RKEY=myTbl1.D17_PTR
				), 0) AS DECIMAL(10,2)) AS Bestand_31_12_2013,
				CAST(ISNULL((
					SELECT
						SUM(
						(dbo.ARTIKELDATEN.ZuX*dbo.ARTIKELDATEN.ZuY*
						CAST((CAST(dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT AS FLOAT)/[ELP_Zu]+0.9999) AS INT)/1000000) 
						)
						AS Zu_m2
					FROM         dbo.ARTIKELDATEN RIGHT OUTER JOIN
										  dbo.DATA0050 INNER JOIN
										  dbo.DATA0048 WITH (nolock) INNER JOIN
										  dbo.DATA0034 WITH (nolock) ON dbo.DATA0048.WORK_CENTER_PTR = dbo.DATA0034.RKEY INNER JOIN
										  dbo.DATA0006 WITH (nolock) ON dbo.DATA0048.WO_PTR = dbo.DATA0006.RKEY ON dbo.DATA0050.RKEY = dbo.DATA0006.CUST_PART_PTR ON 
										  dbo.ARTIKELDATEN.CUST_PART_PTR = dbo.DATA0006.CUST_PART_PTR LEFT OUTER JOIN
										  dbo.DATA0056 WITH (nolock) LEFT OUTER JOIN
										  dbo.abfr_NP0056 ON dbo.DATA0056.RKEY = dbo.abfr_NP0056.FILE_POINTER LEFT OUTER JOIN
										  dbo.DATA0038 ON dbo.DATA0056.WO_PTR = dbo.DATA0038.SOURCE_PTR AND dbo.DATA0056.STEP = dbo.DATA0038.STEP_NUMBER ON 
										  dbo.DATA0048.TPUT_PTR = dbo.DATA0056.RKEY
					WHERE   YEAR(dbo.DATA0048.TDATE)=2013 AND MONTH(dbo.DATA0048.TDATE)<11 
							AND (dbo.DATA0034.DEPT_CODE = 'ÄTZA-01-01' OR dbo.DATA0034.DEPT_CODE = 'ÄTZA-01-02') 
							AND (dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT > 0)
				), 0) AS DECIMAL(10,2)) As Durchsatz_ZUm2_2013,
				CAST((
					CASE
						WHEN
						ISNULL(
						(SELECT
							SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
							FROM
							(
								SELECT     D95.INVT_PTR, PRICE, QUAN_RECD, QUAN_RETN
								FROM         dbo.DATA0095 AS D95 INNER JOIN
													  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
													  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
								WHERE     (D95.TRAN_TP = 5) --AND (D95.INVT_PTR = myTbl2.D17_PTR) 
										AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
										AND (ISNULL(D71.PRICE, 0) > 0)
										AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
							) As myTbl12Mon
							WHERE (INVT_PTR = myTbl1.D17_PTR) 
						), 0)>0 THEN 
						(
							SELECT
							SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
							FROM
							(
								SELECT     D95.INVT_PTR, PRICE, QUAN_RECD, QUAN_RETN
								FROM         dbo.DATA0095 AS D95 INNER JOIN
													  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
													  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
								WHERE     (D95.TRAN_TP = 5) --AND (D95.INVT_PTR = myTbl2.D17_PTR) 
										AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
										AND (ISNULL(D71.PRICE, 0) > 0)
										AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
							) As myTbl12Mon
							WHERE (INVT_PTR = myTbl1.D17_PTR) 
						)
						ELSE
						(
							SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
							FROM         dbo.DATA0095 AS D95 INNER JOIN
												  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
												  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
							--WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = myTbl1.D17_PTR)
							--ORDER BY D95.TRAN_DATE DESC
							WHERE D95.RKEY=(SELECT MAX(RKEY) AS RES FROM DATA0095 WHERE TRAN_TP = 5 AND INVT_PTR = myTbl1.D17_PTR)
						)
					END
				) AS DECIMAL(10,2)) AS Preis_gewichtet12Mon


			FROM
			(
				SELECT  dbo.DATA0017.RKEY AS D17_PTR, LIVE2.dbo.MatRueck_Abteilung.Abteilung, 
						LIVE2.dbo.MatRueck_Anlage.Anlage, dbo.DATA0017.INV_PART_NUMBER AS Artikel, 
						dbo.DATA0017.INV_PART_DESCRIPTION AS Bezeichnung, dbo.DATA0002.UNIT_CODE AS Einheit_
				FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							  LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							  LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							  dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							  dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY
				GROUP BY dbo.DATA0017.RKEY, LIVE2.dbo.MatRueck_Abteilung.Abteilung, LIVE2.dbo.MatRueck_Anlage.Anlage, dbo.DATA0017.INV_PART_NUMBER, 
									  dbo.DATA0017.INV_PART_DESCRIPTION, dbo.DATA0002.UNIT_CODE
				HAVING      (LIVE2.dbo.MatRueck_Anlage.Anlage = 'SES Festresist-Stripper')
			) As myTbl1
		) As myTbl2
		------------------------------------------------------------------------------------------------------
		UNION
		------------------------------------------------------------------------------------------------------
		--SES Zinn Stripper
		------------------------------------------------------------------------------------------------------
		SELECT
			Abteilung,
			Anlage,
			Artikel,
			Bezeichnung,
			Einheit_ AS Lagereinheit,
			(Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013) AS Verbrauch_2013,
			Durchsatz_ZUm2_2013,
			CASE
				WHEN Einheit_='KG' OR Einheit_='LTR' THEN
					CAST((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)/Durchsatz_ZUm2_2013*1000 AS DECIMAL(10,2))
				ELSE
					CAST((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)/Durchsatz_ZUm2_2013 AS DECIMAL(10,2))
			END AS  rel_Verbrauch,
			CASE
				WHEN Einheit_='KG' THEN 'gr' 
				ELSE
					CASE
						WHEN Einheit_='LTR' THEN 'ml' ELSE Einheit_
					END
			END AS Verbrauch_gerechnet_in,
			CAST(Preis_gewichtet12Mon AS DECIMAL(10,2)) AS Preis_gew12Mon,
			CAST(((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)*Preis_gewichtet12Mon)/Durchsatz_ZUm2_2013 AS DECIMAL(10,4)) AS Rel_Kosten,
			CAST(((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)*Preis_gewichtet12Mon) AS DECIMAL(10,2)) AS Abs_Kosten,
			Einheit_ AS Preis_Kosten_Einheit
		FROM
		(
			SELECT
				D17_PTR,
				Abteilung,
				Anlage,
				Artikel,
				Bezeichnung,
				Einheit_,
				CAST(ISNULL((
					SELECT     SUM(LgMg) AS InvBestand
					FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
					WHERE     (JahrMonat = '2012.12') AND RKEY=myTbl1.D17_PTR
				), 0) AS DECIMAL(10,2)) AS Bestand_01_01_2013,
				CAST(ISNULL((
					SELECT     SUM(QUANTITY) AS Zugang
					FROM         dbo.DATA0095
					WHERE   TRAN_TP = 5 AND INVT_PTR = myTbl1.D17_PTR 
							AND YEAR(TRAN_DATE) = 2013 AND MONTH(TRAN_DATE) < 11
				), 0) AS DECIMAL(10,2))AS Zugaenge_2013,
				CAST(ISNULL((
					SELECT     SUM(LgMg) AS InvBestand
					FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
					WHERE     (JahrMonat = '2013.10') AND RKEY=myTbl1.D17_PTR
				), 0) AS DECIMAL(10,2)) AS Bestand_31_12_2013,
				CAST(ISNULL((
					SELECT
						SUM(
						(dbo.ARTIKELDATEN.ZuX*dbo.ARTIKELDATEN.ZuY*
						CAST((CAST(dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT AS FLOAT)/[ELP_Zu]+0.9999) AS INT)/1000000) 
						)
						AS Zu_m2
					FROM         dbo.ARTIKELDATEN RIGHT OUTER JOIN
										  dbo.DATA0050 INNER JOIN
										  dbo.DATA0048 WITH (nolock) INNER JOIN
										  dbo.DATA0034 WITH (nolock) ON dbo.DATA0048.WORK_CENTER_PTR = dbo.DATA0034.RKEY INNER JOIN
										  dbo.DATA0006 WITH (nolock) ON dbo.DATA0048.WO_PTR = dbo.DATA0006.RKEY ON dbo.DATA0050.RKEY = dbo.DATA0006.CUST_PART_PTR ON 
										  dbo.ARTIKELDATEN.CUST_PART_PTR = dbo.DATA0006.CUST_PART_PTR LEFT OUTER JOIN
										  dbo.DATA0056 WITH (nolock) LEFT OUTER JOIN
										  dbo.abfr_NP0056 ON dbo.DATA0056.RKEY = dbo.abfr_NP0056.FILE_POINTER LEFT OUTER JOIN
										  dbo.DATA0038 ON dbo.DATA0056.WO_PTR = dbo.DATA0038.SOURCE_PTR AND dbo.DATA0056.STEP = dbo.DATA0038.STEP_NUMBER ON 
										  dbo.DATA0048.TPUT_PTR = dbo.DATA0056.RKEY
					WHERE   YEAR(dbo.DATA0048.TDATE)=2013 AND MONTH(dbo.DATA0048.TDATE)<11
							AND (dbo.DATA0034.DEPT_CODE = 'ÄTZA-01-01' OR dbo.DATA0034.DEPT_CODE = 'ÄTZA-01-03') 
							AND (dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT > 0)
				), 0) AS DECIMAL(10,2)) As Durchsatz_ZUm2_2013,
				CAST((
					CASE
						WHEN
						ISNULL(
						(SELECT
							SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
							FROM
							(
								SELECT     D95.INVT_PTR, PRICE, QUAN_RECD, QUAN_RETN
								FROM         dbo.DATA0095 AS D95 INNER JOIN
													  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
													  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
								WHERE     (D95.TRAN_TP = 5) --AND (D95.INVT_PTR = myTbl2.D17_PTR) 
										AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
										AND (ISNULL(D71.PRICE, 0) > 0)
										AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
							) As myTbl12Mon
							WHERE (INVT_PTR = myTbl1.D17_PTR) 
						), 0)>0 THEN 
						(
							SELECT
							SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
							FROM
							(
								SELECT     D95.INVT_PTR, PRICE, QUAN_RECD, QUAN_RETN
								FROM         dbo.DATA0095 AS D95 INNER JOIN
													  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
													  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
								WHERE     (D95.TRAN_TP = 5) --AND (D95.INVT_PTR = myTbl2.D17_PTR) 
										AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
										AND (ISNULL(D71.PRICE, 0) > 0)
										AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
							) As myTbl12Mon
							WHERE (INVT_PTR = myTbl1.D17_PTR) 
						)
						ELSE
						(
							SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
							FROM         dbo.DATA0095 AS D95 INNER JOIN
												  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
												  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
							--WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = myTbl1.D17_PTR)
							--ORDER BY D95.TRAN_DATE DESC
							WHERE D95.RKEY=(SELECT MAX(RKEY) AS RES FROM DATA0095 WHERE TRAN_TP = 5 AND INVT_PTR = myTbl1.D17_PTR)
						)
					END
				) AS DECIMAL(10,2)) AS Preis_gewichtet12Mon

			FROM
			(
				SELECT  dbo.DATA0017.RKEY AS D17_PTR, LIVE2.dbo.MatRueck_Abteilung.Abteilung, 
						LIVE2.dbo.MatRueck_Anlage.Anlage, dbo.DATA0017.INV_PART_NUMBER AS Artikel, 
						dbo.DATA0017.INV_PART_DESCRIPTION AS Bezeichnung, dbo.DATA0002.UNIT_CODE AS Einheit_
				FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							  LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							  LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							  dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							  dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY
				GROUP BY dbo.DATA0017.RKEY, LIVE2.dbo.MatRueck_Abteilung.Abteilung, LIVE2.dbo.MatRueck_Anlage.Anlage, dbo.DATA0017.INV_PART_NUMBER, 
									  dbo.DATA0017.INV_PART_DESCRIPTION, dbo.DATA0002.UNIT_CODE
				HAVING      (LIVE2.dbo.MatRueck_Anlage.Anlage = 'SES Zinn-Stripper')
			) As myTbl1
		) As myTbl2
		------------------------------------------------------------------------------------------------------
		UNION
		------------------------------------------------------------------------------------------------------
		--Black Hole
		------------------------------------------------------------------------------------------------------
		SELECT
			Abteilung,
			Anlage,
			Artikel,
			Bezeichnung,
			Einheit_ AS Lagereinheit,
			(Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013) AS Verbrauch_2013,
			Durchsatz_ZUm2_2013,
			CASE
				WHEN Einheit_='KG' OR Einheit_='LTR' THEN
					CAST((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)/Durchsatz_ZUm2_2013*1000 AS DECIMAL(10,2))
				ELSE
					CAST((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)/Durchsatz_ZUm2_2013 AS DECIMAL(10,2))
			END AS  rel_Verbrauch,
			CASE
				WHEN Einheit_='KG' THEN 'gr' 
				ELSE
					CASE
						WHEN Einheit_='LTR' THEN 'ml' ELSE Einheit_
					END
			END AS Verbrauch_gerechnet_in,
			CAST(Preis_gewichtet12Mon AS DECIMAL(10,2)) AS Preis_gew12Mon,
			CAST(((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)*Preis_gewichtet12Mon)/Durchsatz_ZUm2_2013 AS DECIMAL(10,4)) AS Rel_Kosten,
			CAST(((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)*Preis_gewichtet12Mon) AS DECIMAL(10,2)) AS Abs_Kosten,
			Einheit_ AS Preis_Kosten_Einheit
		FROM
		(
			SELECT
				D17_PTR,
				Abteilung,
				Anlage,
				Artikel,
				Bezeichnung,
				Einheit_,
				CAST(ISNULL((
					SELECT     SUM(LgMg) AS InvBestand
					FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
					WHERE     (JahrMonat = '2012.12') AND RKEY=myTbl1.D17_PTR
				), 0) AS DECIMAL(10,2)) AS Bestand_01_01_2013,
				CAST(ISNULL((
					SELECT     SUM(QUANTITY) AS Zugang
					FROM         dbo.DATA0095
					WHERE   TRAN_TP = 5 AND INVT_PTR = myTbl1.D17_PTR 
							AND YEAR(TRAN_DATE) = 2013 AND MONTH(TRAN_DATE) < 11
				), 0) AS DECIMAL(10,2))AS Zugaenge_2013,
				CAST(ISNULL((
					SELECT     SUM(LgMg) AS InvBestand
					FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
					WHERE     (JahrMonat = '2013.10') AND RKEY=myTbl1.D17_PTR
				), 0) AS DECIMAL(10,2)) AS Bestand_31_12_2013,
				CAST(ISNULL((
					SELECT
						SUM(
						(dbo.ARTIKELDATEN.ZuX*dbo.ARTIKELDATEN.ZuY*
						CAST((CAST(dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT AS FLOAT)/[ELP_Zu]+0.9999) AS INT)/1000000) 
						)
						AS Zu_m2
					FROM         dbo.ARTIKELDATEN RIGHT OUTER JOIN
										  dbo.DATA0050 INNER JOIN
										  dbo.DATA0048 WITH (nolock) INNER JOIN
										  dbo.DATA0034 WITH (nolock) ON dbo.DATA0048.WORK_CENTER_PTR = dbo.DATA0034.RKEY INNER JOIN
										  dbo.DATA0006 WITH (nolock) ON dbo.DATA0048.WO_PTR = dbo.DATA0006.RKEY ON dbo.DATA0050.RKEY = dbo.DATA0006.CUST_PART_PTR ON 
										  dbo.ARTIKELDATEN.CUST_PART_PTR = dbo.DATA0006.CUST_PART_PTR LEFT OUTER JOIN
										  dbo.DATA0056 WITH (nolock) LEFT OUTER JOIN
										  dbo.abfr_NP0056 ON dbo.DATA0056.RKEY = dbo.abfr_NP0056.FILE_POINTER LEFT OUTER JOIN
										  dbo.DATA0038 ON dbo.DATA0056.WO_PTR = dbo.DATA0038.SOURCE_PTR AND dbo.DATA0056.STEP = dbo.DATA0038.STEP_NUMBER ON 
										  dbo.DATA0048.TPUT_PTR = dbo.DATA0056.RKEY
					WHERE   YEAR(dbo.DATA0048.TDATE)=2013 AND MONTH(dbo.DATA0048.TDATE)<11
							AND (dbo.DATA0034.DEPT_CODE = 'BLHO-01-01') 
							AND (dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT > 0)
				), 0) AS DECIMAL(10,2)) As Durchsatz_ZUm2_2013,
				CAST((
					CASE
						WHEN
						ISNULL(
						(SELECT
							SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
							FROM
							(
								SELECT     D95.INVT_PTR, PRICE, QUAN_RECD, QUAN_RETN
								FROM         dbo.DATA0095 AS D95 INNER JOIN
													  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
													  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
								WHERE     (D95.TRAN_TP = 5) --AND (D95.INVT_PTR = myTbl2.D17_PTR) 
										AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
										AND (ISNULL(D71.PRICE, 0) > 0)
										AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
							) As myTbl12Mon
							WHERE (INVT_PTR = myTbl1.D17_PTR) 
						), 0)>0 THEN 
						(
							SELECT
							SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
							FROM
							(
								SELECT     D95.INVT_PTR, PRICE, QUAN_RECD, QUAN_RETN
								FROM         dbo.DATA0095 AS D95 INNER JOIN
													  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
													  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
								WHERE     (D95.TRAN_TP = 5) --AND (D95.INVT_PTR = myTbl2.D17_PTR) 
										AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
										AND (ISNULL(D71.PRICE, 0) > 0)
										AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
							) As myTbl12Mon
							WHERE (INVT_PTR = myTbl1.D17_PTR) 
						)
						ELSE
						(
							SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
							FROM         dbo.DATA0095 AS D95 INNER JOIN
												  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
												  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
							--WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = myTbl1.D17_PTR)
							--ORDER BY D95.TRAN_DATE DESC
							WHERE D95.RKEY=(SELECT MAX(RKEY) AS RES FROM DATA0095 WHERE TRAN_TP = 5 AND INVT_PTR = myTbl1.D17_PTR)
						)
					END
				) AS DECIMAL(10,2)) AS Preis_gewichtet12Mon


			FROM
			(
				SELECT  dbo.DATA0017.RKEY AS D17_PTR, LIVE2.dbo.MatRueck_Abteilung.Abteilung, 
						LIVE2.dbo.MatRueck_Anlage.Anlage, dbo.DATA0017.INV_PART_NUMBER AS Artikel, 
						dbo.DATA0017.INV_PART_DESCRIPTION AS Bezeichnung, dbo.DATA0002.UNIT_CODE AS Einheit_
				FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							  LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							  LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							  dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							  dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY
				GROUP BY dbo.DATA0017.RKEY, LIVE2.dbo.MatRueck_Abteilung.Abteilung, LIVE2.dbo.MatRueck_Anlage.Anlage, dbo.DATA0017.INV_PART_NUMBER, 
									  dbo.DATA0017.INV_PART_DESCRIPTION, dbo.DATA0002.UNIT_CODE
				HAVING      (LIVE2.dbo.MatRueck_Anlage.Anlage = 'Black Hole')
			) As myTbl1
		) As myTbl2
		------------------------------------------------------------------------------------------------------
		UNION
		------------------------------------------------------------------------------------------------------
		--Black Oxide
		------------------------------------------------------------------------------------------------------
		SELECT
			Abteilung,
			Anlage,
			Artikel,
			Bezeichnung,
			Einheit_ AS Lagereinheit,
			(Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013) AS Verbrauch_2013,
			Durchsatz_ZUm2_2013,
			CASE
				WHEN Einheit_='KG' OR Einheit_='LTR' THEN
					CAST((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)/Durchsatz_ZUm2_2013*1000 AS DECIMAL(10,2))
				ELSE
					CAST((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)/Durchsatz_ZUm2_2013 AS DECIMAL(10,2))
			END AS  rel_Verbrauch,
			CASE
				WHEN Einheit_='KG' THEN 'gr' 
				ELSE
					CASE
						WHEN Einheit_='LTR' THEN 'ml' ELSE Einheit_
					END
			END AS Verbrauch_gerechnet_in,
			CAST(Preis_gewichtet12Mon AS DECIMAL(10,2)) AS Preis_gew12Mon,
			CAST(((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)*Preis_gewichtet12Mon)/Durchsatz_ZUm2_2013 AS DECIMAL(10,4)) AS Rel_Kosten,
			CAST(((Bestand_01_01_2013+Zugaenge_2013-Bestand_31_12_2013)*Preis_gewichtet12Mon) AS DECIMAL(10,2)) AS Abs_Kosten,
			Einheit_ AS Preis_Kosten_Einheit
		FROM
		(
			SELECT
				D17_PTR,
				Abteilung,
				Anlage,
				Artikel,
				Bezeichnung,
				Einheit_,
				CAST(ISNULL((
					SELECT     SUM(LgMg) AS InvBestand
					FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
					WHERE     (JahrMonat = '2012.12') AND RKEY=myTbl1.D17_PTR
				), 0) AS DECIMAL(10,2)) AS Bestand_01_01_2013,
				CAST(ISNULL((
					SELECT     SUM(QUANTITY) AS Zugang
					FROM         dbo.DATA0095
					WHERE   TRAN_TP = 5 AND INVT_PTR = myTbl1.D17_PTR 
							AND YEAR(TRAN_DATE) = 2013 AND MONTH(TRAN_DATE) < 11
				), 0) AS DECIMAL(10,2))AS Zugaenge_2013,
				CAST(ISNULL((
					SELECT     SUM(LgMg) AS InvBestand
					FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
					WHERE     (JahrMonat = '2013.10') AND RKEY=myTbl1.D17_PTR
				), 0) AS DECIMAL(10,2)) AS Bestand_31_12_2013,
				CAST(ISNULL((
					SELECT
						SUM(
						(dbo.ARTIKELDATEN.ZuX*dbo.ARTIKELDATEN.ZuY*
						CAST((CAST(dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT AS FLOAT)/[ELP_Zu]+0.9999) AS INT)/1000000) 
						)
						AS Zu_m2
					FROM         dbo.ARTIKELDATEN RIGHT OUTER JOIN
										  dbo.DATA0050 INNER JOIN
										  dbo.DATA0048 WITH (nolock) INNER JOIN
										  dbo.DATA0034 WITH (nolock) ON dbo.DATA0048.WORK_CENTER_PTR = dbo.DATA0034.RKEY INNER JOIN
										  dbo.DATA0006 WITH (nolock) ON dbo.DATA0048.WO_PTR = dbo.DATA0006.RKEY ON dbo.DATA0050.RKEY = dbo.DATA0006.CUST_PART_PTR ON 
										  dbo.ARTIKELDATEN.CUST_PART_PTR = dbo.DATA0006.CUST_PART_PTR LEFT OUTER JOIN
										  dbo.DATA0056 WITH (nolock) LEFT OUTER JOIN
										  dbo.abfr_NP0056 ON dbo.DATA0056.RKEY = dbo.abfr_NP0056.FILE_POINTER LEFT OUTER JOIN
										  dbo.DATA0038 ON dbo.DATA0056.WO_PTR = dbo.DATA0038.SOURCE_PTR AND dbo.DATA0056.STEP = dbo.DATA0038.STEP_NUMBER ON 
										  dbo.DATA0048.TPUT_PTR = dbo.DATA0056.RKEY
					WHERE   YEAR(dbo.DATA0048.TDATE)=2013 AND MONTH(dbo.DATA0048.TDATE)<11
							AND (dbo.DATA0034.DEPT_CODE = 'MLBL-01-01') 
							AND (dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT > 0)
				), 0) AS DECIMAL(10,2)) As Durchsatz_ZUm2_2013,
				CAST((
					CASE
						WHEN
						ISNULL(
						(SELECT
							SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
							FROM
							(
								SELECT     D95.INVT_PTR, PRICE, QUAN_RECD, QUAN_RETN
								FROM         dbo.DATA0095 AS D95 INNER JOIN
													  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
													  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
								WHERE     (D95.TRAN_TP = 5) --AND (D95.INVT_PTR = myTbl2.D17_PTR) 
										AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
										AND (ISNULL(D71.PRICE, 0) > 0)
										AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
							) As myTbl12Mon
							WHERE (INVT_PTR = myTbl1.D17_PTR) 
						), 0)>0 THEN 
						(
							SELECT
							SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
							FROM
							(
								SELECT     D95.INVT_PTR, PRICE, QUAN_RECD, QUAN_RETN
								FROM         dbo.DATA0095 AS D95 INNER JOIN
													  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
													  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
								WHERE     (D95.TRAN_TP = 5) --AND (D95.INVT_PTR = myTbl2.D17_PTR) 
										AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
										AND (ISNULL(D71.PRICE, 0) > 0)
										AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
							) As myTbl12Mon
							WHERE (INVT_PTR = myTbl1.D17_PTR) 
						)
						ELSE
						(
							SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
							FROM         dbo.DATA0095 AS D95 INNER JOIN
												  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
												  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
							--WHERE     (D95.TRAN_TP = 5) AND (D95.INVT_PTR = myTbl1.D17_PTR)
							--ORDER BY D95.TRAN_DATE DESC
							WHERE D95.RKEY=(SELECT MAX(RKEY) AS RES FROM DATA0095 WHERE TRAN_TP = 5 AND INVT_PTR = myTbl1.D17_PTR)
						)
					END
				) AS DECIMAL(10,2)) AS Preis_gewichtet12Mon


			FROM
			(
				SELECT  dbo.DATA0017.RKEY AS D17_PTR, LIVE2.dbo.MatRueck_Abteilung.Abteilung, 
						LIVE2.dbo.MatRueck_Anlage.Anlage, dbo.DATA0017.INV_PART_NUMBER AS Artikel, 
						dbo.DATA0017.INV_PART_DESCRIPTION AS Bezeichnung, dbo.DATA0002.UNIT_CODE AS Einheit_
				FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							  LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							  LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							  dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							  dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY
				GROUP BY dbo.DATA0017.RKEY, LIVE2.dbo.MatRueck_Abteilung.Abteilung, LIVE2.dbo.MatRueck_Anlage.Anlage, dbo.DATA0017.INV_PART_NUMBER, 
									  dbo.DATA0017.INV_PART_DESCRIPTION, dbo.DATA0002.UNIT_CODE
				HAVING      (LIVE2.dbo.MatRueck_Anlage.Anlage = 'Black Oxide')
			) As myTbl1
		) As myTbl2
		------------------------------------------------------------------------------------------------------

		) As myMainTbl
		ORDER BY Abteilung, Anlage, Artikel
	END
*/
	--Materialverbrauch
	DECLARE @myYear int
	DECLARE @myMonth int
	DECLARE @JahrMonat varchar(7)
	DECLARE @JahrMonatVor varchar(7)

	IF @Case_ = 'Materialverbrauch'
	BEGIN

		-------INPUT-------
		--DECLARE @in_Anlage_PTR varchar(250)
		-------------------
		--SET @in_Anlage_PTR = '001005000006000000'

		DECLARE @p_P1 int
		DECLARE @p_P2 int
		DECLARE @p_P3 int
		DECLARE @p_P4 int
		DECLARE @p_P5 int
		DECLARE @p_P6 int

		SET @p_P1 = CAST(SUBSTRING(@para1, 1, 3) AS INT)
		SET @p_P2 = CAST(SUBSTRING(@para1, 4, 3) AS INT)
		SET @p_P3 = CAST(SUBSTRING(@para1, 7, 3) AS INT)
		SET @p_P4 = CAST(SUBSTRING(@para1, 10, 3) AS INT)
		SET @p_P5 = CAST(SUBSTRING(@para1, 13, 3) AS INT)
		SET @p_P6 = CAST(SUBSTRING(@para1, 16, 3) AS INT)

		DECLARE @p_Durchsatz DECIMAL(10,2) 
		DECLARE @p_Durchsatz_Gesamt DECIMAL(10,2) 
		DECLARE @p_SQL varchar(4000)
		DECLARE @p_Anlage_PTR int
		DECLARE @p_D34_PTR int
		DECLARE @p_Abteilung varchar(250)
		DECLARE @p_Anlage varchar(250)
		DECLARE	@p_DEPT_CODE char(1000)
		DECLARE @p_BzGr_Typ varchar(50)
	
		DECLARE @tblMaterialRelKosten table (
											Anlage_PTR int,
											Abteilung varchar(250) null,
											Anlage varchar(250) null, 
											JahrMonat varchar(7) null, 
											JahrMonatStr varchar(10) null, 
											Bezeichnung char(40) null,
											Anfangsbestand NUMERIC(10,4),
											Zugaenge NUMERIC(10,4),
											Endbestand NUMERIC(10,4),
											Verbrauch NUMERIC(10,4),
											Verbrauch_Korr NUMERIC(10,4),
											Abgemeldet NUMERIC(10,4), 
											Durchsatz NUMERIC(10,4),
											Durchsatz_Gesamt NUMERIC(10,4),
											EK_DPreis NUMERIC(10,4),
											EK_DPreis_Monat NUMERIC(10,4), 
											Zugaenge_EUR NUMERIC(10,4),
											Endbestand_EUR NUMERIC(10,4),
											AbsMatKosten_EUR NUMERIC(10,4),
											Rel_Kosten NUMERIC(10,4),
											Rel_Kosten_Korr NUMERIC(10,4),
											QUAN_ON_HAND NUMERIC(10,4), 
											Lagerwert NUMERIC(10,4), 
											EinkEinheit varchar(5) null, 
											LagerEinheit varchar(5) null, 
											Umrechnungsfaktor NUMERIC(10, 4), 
											VerbrauchSOLL NUMERIC(10,4),
											CONSIGN_ONHAND_QTY NUMERIC(10,4),
											Lagerwert_Konsi NUMERIC(10,4),
											Abweichung_EUR NUMERIC(10,4),
											EK_DPreis_Umgerech NUMERIC(10,4),
											EK_DPreis_Monat_Umgerech NUMERIC(10,4),
											MatInDivAnlagen varchar(2000) null
											)

		DECLARE myCursorSample CURSOR fast_forward FOR (
															SELECT
																Abteilung, Anlage, Anlage_PTR, DEPT_CODE, BzGr_Typ 
															FROM
															(
																SELECT 
																		(SELECT TOP 1 Abteilung  FROM  LIVE2.dbo.MatRueck_Abteilung INNER JOIN LIVE2.dbo.MatRueck_AnlageAbteilung ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_AnlageAbteilung.Abteilung_PTR WHERE Anlage_PTR = LIVE2.dbo.MatKost_KostensatzStamm.Anlage_PTR) AS Abteilung,
																		(SELECT TOP 1 Anlage FROM LIVE2.dbo.MatRueck_Anlage As tblAnlage WHERE tblAnlage.ID=LIVE2.dbo.MatKost_KostensatzStamm.Anlage_PTR) AS Anlage,
																		Anlage_PTR, DEPT_CODE, BzGr_Typ 
																FROM LIVE2.dbo.MatKost_KostensatzStamm 
																WHERE Anlage_PTR In (@p_P1, @p_P2, @p_P3, @p_P4, @p_P5, @p_P6)
															) As myTbl
														)
		OPEN myCursorSample
		FETCH NEXT FROM myCursorSample INTO @p_Abteilung, @p_Anlage, @p_Anlage_PTR, @p_DEPT_CODE, @p_BzGr_Typ

		WHILE @@FETCH_STATUS = 0 
		BEGIN   

			SET @myYear = 2013
			SET @myMonth = 1
			SET @p_Durchsatz_Gesamt = 0
			SET @p_D34_PTR = (SELECT TOP 1 D34_PTR FROM LIVE2.dbo.MatRueck_AnlageAbteilung WHERE Anlage_PTR = @p_Anlage_PTR)
			--------------------------------------------------------------------------------------------------------------------------------

			WHILE @myYear < 2015
			BEGIN
				WHILE @myMonth < 13
				BEGIN
					IF CAST(LTRIM(STR(@myYear) + RIGHT('00'+LTRIM(STR(@myMonth)), 2)) AS INT) < CAST(LTRIM(STR(YEAR(GETDATE()))) + RIGHT('00'+LTRIM(STR(MONTH(GETDATE()))), 2) AS INT)
					BEGIN

						IF @myMonth='01'
							SET @JahrMonatVor = LTRIM(STR(@myYear-1) + '.12')
						ELSE
							SET @JahrMonatVor = LTRIM(STR(@myYear) + '.' + RIGHT('00'+LTRIM(STR(@myMonth-1)), 2))

						SET @JahrMonat = LTRIM(STR(@myYear) + '.' + RIGHT('00'+LTRIM(STR(@myMonth)), 2))

						--Durchsatz
						--------------------------------------------------------------------------------
						DECLARE @BzGr_Formel varchar(1000)
						IF @p_BzGr_Typ = 'ZU_Fl' 
						BEGIN
							SET @BzGr_Formel = '
												(dbo.ARTIKELDATEN.ZuX*dbo.ARTIKELDATEN.ZuY*
													CAST((CAST(dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT AS FLOAT)/[ELP_Zu]+0.9999) AS INT)/1000000) 
												'
						END

						IF OBJECT_ID(N'tempdb..##MYTable') is not null
						BEGIN
							DROP TABLE ##MYTable
						END

						SET @p_SQL ='SELECT CAST(Zu_m2 AS DECIMAL(10,2)) AS RES INTO ##MYTable FROM(
									SELECT
										SUM(' + @BzGr_Formel + ') AS Zu_m2
									FROM         dbo.ARTIKELDATEN RIGHT OUTER JOIN
														  dbo.DATA0050 INNER JOIN
														  dbo.DATA0048 WITH (nolock) INNER JOIN
														  dbo.DATA0034 WITH (nolock) ON dbo.DATA0048.WORK_CENTER_PTR = dbo.DATA0034.RKEY INNER JOIN
														  dbo.DATA0006 WITH (nolock) ON dbo.DATA0048.WO_PTR = dbo.DATA0006.RKEY ON dbo.DATA0050.RKEY = dbo.DATA0006.CUST_PART_PTR ON 
														  dbo.ARTIKELDATEN.CUST_PART_PTR = dbo.DATA0006.CUST_PART_PTR LEFT OUTER JOIN
														  dbo.DATA0056 WITH (nolock) LEFT OUTER JOIN
														  dbo.abfr_NP0056 ON dbo.DATA0056.RKEY = dbo.abfr_NP0056.FILE_POINTER LEFT OUTER JOIN
														  dbo.DATA0038 ON dbo.DATA0056.WO_PTR = dbo.DATA0038.SOURCE_PTR AND dbo.DATA0056.STEP = dbo.DATA0038.STEP_NUMBER ON 
														  dbo.DATA0048.TPUT_PTR = dbo.DATA0056.RKEY
									WHERE   (dbo.DATA0034.DEPT_CODE in  (' + RTRIM(@p_DEPT_CODE) + ')) 
											AND (dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT > 0)
											AND LTRIM(STR(YEAR(dbo.DATA0048.TDATE)) + ''.'' + RIGHT(''00''+LTRIM(STR(MONTH(dbo.DATA0048.TDATE))), 2))=''' + @JahrMonat + '''
								) As tblTmp
								'
						EXEC (@p_SQL)

						SET @p_Durchsatz = (SELECT TOP 1 RES FROM ##MYTable)
						SET @p_Durchsatz_Gesamt = @p_Durchsatz_Gesamt + @p_Durchsatz
						--------------------------------------------------------------------------------

						--Material
						--------------------------------------------------------------------------------

						INSERT @tblMaterialRelKosten(
													Anlage_PTR,
													Abteilung,
													Anlage, 
													JahrMonat, 
													JahrMonatStr,
													Bezeichnung,
													Anfangsbestand,
													Zugaenge,
													Endbestand,
													Verbrauch,
													Verbrauch_Korr,
													Abgemeldet, 
													Durchsatz,
													Durchsatz_Gesamt,
													EK_DPreis,
													EK_DPreis_Monat, 
													Zugaenge_EUR,
													Endbestand_EUR,
													AbsMatKosten_EUR,
													Rel_Kosten,
													Rel_Kosten_Korr,
													QUAN_ON_HAND, 
													Lagerwert, 
													EinkEinheit, 
													LagerEinheit, 
													Umrechnungsfaktor, 
													VerbrauchSOLL, 
													CONSIGN_ONHAND_QTY,
													Lagerwert_Konsi,
													Abweichung_EUR,
													EK_DPreis_Umgerech,
													EK_DPreis_Monat_Umgerech
													)
				
						SELECT 
							@p_Anlage_PTR AS Anlage_PTR,
							Abteilung,
							Anlage,
							@JahrMonat AS JahrMonat,
							LEFT(DATENAME(Month, '01.' + RIGHT(@JahrMonat, 2) + '.' + LEFT(@JahrMonat, 4)), 3) + ' ' + RIGHT(LEFT(@JahrMonat, 4), 2) AS JahrMonatStr,
							Bezeichnung,
							(Anfangsbestand_GGP+Anfangsbestand_Konsi) AS Anfangsbestand,
							Zugaenge,
							(Endbestand_GGP+Endbestand_Konsi) AS Endbestand,
							((Anfangsbestand_GGP+Anfangsbestand_Konsi)+Zugaenge-(Endbestand_GGP+Endbestand_Konsi)) AS Verbrauch,
							((Anfangsbestand_GGP+Anfangsbestand_Konsi)+Zugaenge-(Endbestand_GGP+Endbestand_Konsi)) AS Verbrauch_Korr,
							Abgemeldet,
							@p_Durchsatz,
							0 AS Durchsatz_Gesamt,
							Preis_gewichtet12Mon AS EK_DPreis,
							CASE
								WHEN Zugaenge>0 THEN EK_DPreis_Monat ELSE 0
							END AS EK_DPreis_Monat,
							CAST(CASE
								WHEN Zugaenge=0 THEN 0
								ELSE
									CASE
										WHEN EK_DPreis_Monat>0 THEN (Zugaenge/Umrechnungsfaktor)*CAST(EK_DPreis_Monat AS NUMERIC(10, 4))
										ELSE (Zugaenge/Umrechnungsfaktor)*CAST(Preis_gewichtet12Mon AS NUMERIC(10, 4))
									END
							END AS NUMERIC(10, 4)) AS Zugaenge_EUR,
							(CAST(Endbestand_GGP+Endbestand_Konsi  AS NUMERIC(10, 4))/Umrechnungsfaktor)*Preis_gewichtet12Mon AS Endbestand_EUR,
							(CAST((Anfangsbestand_GGP+Anfangsbestand_Konsi)+Zugaenge-(Endbestand_GGP+Endbestand_Konsi) AS NUMERIC(10, 4))/Umrechnungsfaktor)*Preis_gewichtet12Mon AS AbsMatKosten_EUR,
							((CAST((Anfangsbestand_GGP+Anfangsbestand_Konsi)+Zugaenge-(Endbestand_GGP+Endbestand_Konsi) AS NUMERIC(10, 4))/Umrechnungsfaktor)*Preis_gewichtet12Mon)/@p_Durchsatz AS Kostensatz, --Rel_Kosten
							((CAST((Anfangsbestand_GGP+Anfangsbestand_Konsi)+Zugaenge-(Endbestand_GGP+Endbestand_Konsi) AS NUMERIC(10, 4))/Umrechnungsfaktor)*Preis_gewichtet12Mon)/@p_Durchsatz AS Kostensatz_Korr, --Rel_Kosten_Korr
							QUAN_ON_HAND,
							CAST((QUAN_ON_HAND/Umrechnungsfaktor)*Preis_gewichtet12Mon AS NUMERIC(10, 4)) AS Lagerwert, 
							EinkEinheit,
							LagerEinheit,
							Umrechnungsfaktor, 
							ISNULL(VerbrauchSOLL, 0) AS VerbrauchSOLL,
							CONSIGN_ONHAND_QTY,
							CAST((CONSIGN_ONHAND_QTY/Umrechnungsfaktor)*Preis_gewichtet12Mon AS NUMERIC(10, 4)) AS Lagerwert_Konsi,
							CASE
								WHEN Zugaenge=0 THEN 0
								ELSE
									CASE
										WHEN EK_DPreis_Monat>0 THEN (Zugaenge/Umrechnungsfaktor)*(EK_DPreis_Monat-Preis_gewichtet12Mon) 
										ELSE 0
									END
							END AS Abweichung_EUR,
							CAST(Preis_gewichtet12Mon/Umrechnungsfaktor AS NUMERIC(10, 4)) AS EK_DPreis_Umgerech,
							CASE
								WHEN Zugaenge>0 THEN EK_DPreis_Monat/Umrechnungsfaktor ELSE 0
							END AS EK_DPreis_Monat_Umgerech
														
						FROM
						(
							SELECT
								Abteilung,
								Anlage,
								Bezeichnung,
								CAST(ISNULL((
									SELECT     SUM(LgMg) AS InvBestand
									FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
									WHERE     (JahrMonat = @JahrMonatVor) AND RKEY=myTbl1.D17_PTR --'2012.12'
								), 0) AS NUMERIC(10,4)) AS Anfangsbestand_GGP,
								CAST(ISNULL((
									SELECT     SUM(LgMg_Konsi) AS InvBestand
									FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
									WHERE     (JahrMonat = @JahrMonatVor) AND RKEY=myTbl1.D17_PTR --'2012.12'
								), 0) AS NUMERIC(10,4)) AS Anfangsbestand_Konsi,
								CAST(ISNULL((
									SELECT  ISNULL(SUM(dbo.DATA0095.QUANTITY), 0) + 
									ISNULL((
										SELECT  ISNULL(SUM(dbo.DATA0341.QUANTITY), 0) AS Zugang_Konsi
										--FROM         dbo.DATA0017 INNER JOIN
										--					  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
										--					  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
										--					  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
										--					  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
										--					  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
										--					  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
										FROM dbo.DATA0341
										WHERE dbo.DATA0341.TRAN_TP=1 AND dbo.DATA0341.DATA0017_PTR = myTbl1.D17_PTR 
											AND dbo.DATA0341.DATA0466_PTR>0 AND dbo.DATA0341.DATA0467_PTR>0
											AND LTRIM(STR(YEAR(dbo.DATA0341.TRAN_DATE)) + '.' + RIGHT('00'+LTRIM(STR(MONTH(dbo.DATA0341.TRAN_DATE))), 2))=@JahrMonat
									), 0) -
									ISNULL((
										SELECT ISNULL(SUM(dbo.DATA0467.QUAN_RETN*dbo.DATA0017.STOCK_PURCH  ), 0) AS Retourn_Konsi
										--FROM         dbo.DATA0467 INNER JOIN
										--					  dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										--					  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
										--					  dbo.DATA0023 ON dbo.DATA0466.SUPPLIER_POINTER = dbo.DATA0023.RKEY INNER JOIN
										--					  dbo.DATA0002 ON dbo.DATA0467.PURCHASE_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
										--					  dbo.DATA0005 ON dbo.DATA0466.EMPLOYEE_POINTER = dbo.DATA0005.RKEY
										FROM       dbo.DATA0467 INNER JOIN
													dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY
										WHERE dbo.DATA0467.QUAN_RETN>0 AND dbo.DATA0017.RKEY = myTbl1.D17_PTR 
											AND LTRIM(STR(YEAR(dbo.DATA0467.REQ_DATE)) + '.' + RIGHT('00'+LTRIM(STR(MONTH(dbo.DATA0467.REQ_DATE))), 2))=@JahrMonat
									), 0) -
									ISNULL((
										SELECT ISNULL(SUM(dbo.DATA0095.QUANTITY), 0) AS Retourn_GGP
										--FROM         dbo.DATA0005 INNER JOIN
										--					  dbo.DATA0095 ON dbo.DATA0005.RKEY = dbo.DATA0095.TRAN_BY INNER JOIN
										--					  dbo.DATA0017 INNER JOIN
										--					  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
										--					  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
										--					  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
										--					  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										--					  dbo.DATA0023 ON dbo.DATA0070.SUPPLIER_POINTER = dbo.DATA0023.RKEY
										FROM dbo.DATA0095
										WHERE (dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0095.INVT_PTR= myTbl1.D17_PTR  --dbo.DATA0017.RKEY = myTbl1.D17_PTR 
											AND LTRIM(STR(YEAR(dbo.DATA0095.ENTERED_DATE)) + '.' + RIGHT('00'+LTRIM(STR(MONTH(dbo.DATA0095.ENTERED_DATE))), 2))=@JahrMonat
									), 0) -
									ISNULL(( SELECT  ISNULL(SUM(dbo.DATA0341.QUANTITY), 0) AS K_Rueckgaengig
									--FROM         dbo.DATA0017 INNER JOIN
									--					  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
									--					  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
									--					  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
									--					  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
									--					  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
									--					  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
									FROM dbo.DATA0341
									WHERE     dbo.DATA0341.TRAN_TP=15 AND dbo.DATA0341.DATA0017_PTR = myTbl1.D17_PTR --dbo.DATA0017.RKEY = myTbl1.D17_PTR 
											AND LTRIM(STR(YEAR(dbo.DATA0341.TRAN_DATE)) + '.' + RIGHT('00'+LTRIM(STR(MONTH(dbo.DATA0341.TRAN_DATE))), 2))=@JahrMonat
											AND dbo.DATA0341.DATA0466_PTR>0 AND dbo.DATA0341.DATA0467_PTR>0
									), 0) AS Zugang_GGP_Konsi
									FROM	dbo.DATA0095 INNER JOIN
											dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
											dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
											dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY
									WHERE   dbo.DATA0095.TRAN_TP = 5 AND dbo.DATA0095.INVT_PTR = myTbl1.D17_PTR 
											AND dbo.DATA0070.PURCHASE_ORDER_TYPE = 0 
											AND LTRIM(STR(YEAR(dbo.DATA0095.TRAN_DATE)) + '.' + RIGHT('00'+LTRIM(STR(MONTH(dbo.DATA0095.TRAN_DATE))), 2))=@JahrMonat
								), 0) AS NUMERIC(10,4)) AS Zugaenge,
								CAST(ISNULL((
									SELECT     SUM(LgMg) AS InvBestand
									FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
									WHERE     (JahrMonat = @JahrMonat) AND RKEY=myTbl1.D17_PTR --'2013.11'
								), 0) AS NUMERIC(10,4)) AS Endbestand_GGP,
								CAST(ISNULL((
									SELECT     SUM(LgMg_Konsi) AS InvBestand
									FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
									WHERE     (JahrMonat = @JahrMonat) AND RKEY=myTbl1.D17_PTR --'2013.11'
								), 0) AS NUMERIC(10,4)) AS Endbestand_Konsi,
								CAST((
									CASE
										WHEN
										ISNULL(
										(SELECT
											SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
											FROM
											(
												SELECT     D95.INVT_PTR, PRICE, QUAN_RECD, QUAN_RETN
												FROM         dbo.DATA0095 AS D95 INNER JOIN
																	  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
																	  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
												WHERE     (D95.TRAN_TP = 5) --AND (D95.INVT_PTR = myTbl2.D17_PTR) 
														--AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
														AND (YEAR(D95.TRAN_DATE) = YEAR(GETDATE())-1)
														AND (ISNULL(D71.PRICE, 0) > 0)
														AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
											) As myTbl12Mon
											WHERE (INVT_PTR = myTbl1.D17_PTR) 
										), 0)>0 THEN 
										(
											SELECT
											SUM(PRICE*(QUAN_RECD-QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
											FROM
											(
												SELECT     D95.INVT_PTR, PRICE, QUAN_RECD, QUAN_RETN,
															(SELECT TOP 1 ArtTbl.STOCK_PURCH FROM dbo.DATA0017 AS ArtTbl WHERE ArtTbl.RKEY=D95.INVT_PTR) AS UmrechFaktor
												FROM         dbo.DATA0095 AS D95 INNER JOIN
																	  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
																	  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
												WHERE     (D95.TRAN_TP = 5) --AND (D95.INVT_PTR = myTbl2.D17_PTR) 
														--AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
														AND (YEAR(D95.TRAN_DATE) = YEAR(GETDATE())-1)
														AND (ISNULL(D71.PRICE, 0) > 0)
														AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
											) As myTbl12Mon
											WHERE (INVT_PTR = myTbl1.D17_PTR) 
										)
										ELSE
										(
											SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
											FROM         dbo.DATA0095 AS D95 INNER JOIN
																  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
																  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
											WHERE D95.RKEY=(SELECT MAX(RKEY) AS RES FROM DATA0095 WHERE TRAN_TP = 5 AND INVT_PTR = myTbl1.D17_PTR)
										)
									END
								--) AS DECIMAL(10,2))/myTbl1.Umrechnungsfaktor AS Preis_gewichtet12Mon
								) AS NUMERIC(10,4)) AS Preis_gewichtet12Mon,
								ISNULL(
										(
										SELECT AVG(MD_Preis_GGP_Konsi) AS Res
										FROM
										(
										SELECT  dbo.DATA0071.PRICE AS MD_Preis_GGP_Konsi, dbo.DATA0017.RKEY AS DATA0017_PTR
										FROM         dbo.DATA0095 INNER JOIN
															  dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
															  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
															  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
															  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY
										WHERE	(dbo.DATA0095.TRAN_TP = 5) 
												--AND (dbo.DATA0095.INVT_PTR = 218)--myTbl1.D17_PTR) 
												AND (LTRIM(STR(YEAR(dbo.DATA0095.TRAN_DATE)) + '.' + RIGHT('00' + LTRIM(STR(MONTH(dbo.DATA0095.TRAN_DATE))), 2)) = @JahrMonat) 
												AND (dbo.DATA0071.PRICE > 0) 
												AND dbo.DATA0070.PURCHASE_ORDER_TYPE = 0
										UNION ALL
										SELECT     dbo.DATA0467.PRICE AS MD_Preis_GGP_Konsi, dbo.DATA0017.RKEY AS DATA0017_PTR
										FROM         dbo.DATA0017 INNER JOIN
															  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
															  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
															  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
															  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
															  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
															  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
										WHERE   (dbo.DATA0341.TRAN_TP = 1) 
												--AND (dbo.DATA0341.DATA0017_PTR = 218)--myTbl1.D17_PTR) 
												AND (LTRIM(STR(YEAR(dbo.DATA0341.TRAN_DATE)) + '.' + RIGHT('00' + LTRIM(STR(MONTH(dbo.DATA0341.TRAN_DATE))), 2)) = @JahrMonat) 
												AND (dbo.DATA0467.PRICE > 0)
										) AS myDMPreis
										WHERE DATA0017_PTR = myTbl1.D17_PTR
										)
								, 0) AS EK_DPreis_Monat,
								QUAN_ON_HAND,
								Umrechnungsfaktor,
								(ISNULL((
										SELECT ISNULL(SUM(dbo.DATA0095.QUANTITY), 0) AS Ausgaben
										FROM dbo.DATA0095
										WHERE dbo.DATA0095.TRAN_TP = 15 AND dbo.DATA0095.INVT_PTR= myTbl1.D17_PTR
											AND LTRIM(STR(YEAR(dbo.DATA0095.ENTERED_DATE)) + '.' + RIGHT('00'+LTRIM(STR(MONTH(dbo.DATA0095.ENTERED_DATE))), 2))=@JahrMonat
											AND dbo.DATA0095.SRCE_PTR = @p_D34_PTR
								), 0) 
								+
								ISNULL((
										SELECT ISNULL(SUM(dbo.DATA0095.QUANTITY), 0) AS Rueckgaben
										FROM dbo.DATA0095
										WHERE dbo.DATA0095.TRAN_TP = 16 AND dbo.DATA0095.INVT_PTR= myTbl1.D17_PTR
											AND LTRIM(STR(YEAR(dbo.DATA0095.ENTERED_DATE)) + '.' + RIGHT('00'+LTRIM(STR(MONTH(dbo.DATA0095.ENTERED_DATE))), 2))=@JahrMonat
											AND dbo.DATA0095.SRCE_PTR = @p_D34_PTR
								), 0)) AS Abgemeldet,
								LagerEinheit,
								EinkEinheit,
								VerbrauchSOLL,
								CONSIGN_ONHAND_QTY

							FROM
							(
								SELECT  dbo.DATA0017.RKEY AS D17_PTR, LIVE2.dbo.MatRueck_Abteilung.Abteilung, 
										LIVE2.dbo.MatRueck_Anlage.Anlage, dbo.DATA0017.INV_PART_NUMBER AS Artikel, 
										dbo.DATA0017.INV_PART_DESCRIPTION AS Bezeichnung, dbo.DATA0002.UNIT_CODE AS LagerEinheit, 
										ROUND(dbo.DATA0017.STOCK_PURCH, 4) AS Umrechnungsfaktor, dbo.DATA0017.QUAN_ON_HAND, DATA0002_1.UNIT_CODE AS EinkEinheit,
										CAST(dbo.DATA0017.IES_DIRECT_MATL_COST  AS NUMERIC(10, 7)) AS VerbrauchSOLL,
										dbo.DATA0017.CONSIGN_ONHAND_QTY
								--FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
								--			  LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
								--			  LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
								--			  dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
								--			  dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY
								FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
													  LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
													  LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
													  dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
													  dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY
								GROUP BY dbo.DATA0017.RKEY, LIVE2.dbo.MatRueck_Abteilung.Abteilung, LIVE2.dbo.MatRueck_Anlage.Anlage, dbo.DATA0017.INV_PART_NUMBER, 
										dbo.DATA0017.INV_PART_DESCRIPTION, dbo.DATA0002.UNIT_CODE, dbo.DATA0017.STOCK_PURCH, 
										dbo.DATA0017.QUAN_ON_HAND, DATA0002_1.UNIT_CODE, dbo.DATA0017.IES_DIRECT_MATL_COST, dbo.DATA0017.CONSIGN_ONHAND_QTY
								HAVING      (LIVE2.dbo.MatRueck_Anlage.Anlage = @p_Anlage) --'Black Hole')
							) As myTbl1
						) As myTbl2
						--------------------------------------------------------------------------------

					END
					SET @myMonth = @myMonth + 1
				END

				SET @myYear = @myYear + 1
				SET @myMonth = 1
			END

			UPDATE @tblMaterialRelKosten SET Durchsatz_Gesamt=@p_Durchsatz_Gesamt WHERE Anlage=@p_Anlage

			FETCH NEXT FROM myCursorSample INTO @p_Abteilung, @p_Anlage, @p_Anlage_PTR, @p_DEPT_CODE, @p_BzGr_Typ
		END

		CLOSE myCursorSample
		DEALLOCATE myCursorSample

		IF OBJECT_ID(N'tempdb..##MYTable') is not null
		BEGIN
			DROP TABLE ##MYTable
		END


		--Materialeinsatz
		--------------------------------------------------------------------------------
		--Black Oxide
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.05 WHERE Anlage='Black Oxide' AND Bezeichnung='Schwefelsäure 50%, chem. rein'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.15 WHERE Anlage='Black Oxide' AND Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.01 WHERE Anlage='Black Oxide' AND Bezeichnung='Natronlauge 32/33 % techn.'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.05 WHERE Anlage='Black Oxide' AND Bezeichnung='Kupfer Sulfat'

		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Black Oxide' AND Bezeichnung='Schwefelsäure 50%, chem. rein'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Black Oxide' AND Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Black Oxide' AND Bezeichnung='Natronlauge 32/33 % techn.'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Black Oxide' AND Bezeichnung='Kupfer Sulfat'

		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Black Oxide' AND Bezeichnung='Schwefelsäure 50%, chem. rein'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Black Oxide' AND Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Black Oxide' AND Bezeichnung='Natronlauge 32/33 % techn.'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Black Oxide' AND Bezeichnung='Kupfer Sulfat'

		--Black Hole
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.2 WHERE Anlage='Black Hole' AND Bezeichnung='Schwefelsäure 50%, chem. rein'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.25 WHERE Anlage='Black Hole' AND Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.01 WHERE Anlage='Black Hole' AND Bezeichnung='Natronlauge 32/33 % techn.'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.05 WHERE Anlage='Black Hole' AND Bezeichnung='Kupfer Sulfat'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.8 WHERE Anlage='Black Hole' AND Bezeichnung='Filterkerzen 10µ / 10" Hytrex II'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.5 WHERE Anlage='Black Hole' AND Bezeichnung='Filterkerzen 10µ/9 3/4" Garnwickelfilter'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.7 WHERE Anlage='Black Hole' AND Bezeichnung='Macuprep Etch G-5-S (Stabilisator)'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.02 WHERE Anlage='Black Hole' AND Bezeichnung='Filterbeutel 520 x 520/350 f. Bimsanlage'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.5 WHERE Anlage='Black Hole' AND Bezeichnung='Filterkerzen 75µ / 9 3/4" Hytrex II'

		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Black Hole' AND Bezeichnung='Schwefelsäure 50%, chem. rein'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Black Hole' AND Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Black Hole' AND Bezeichnung='Natronlauge 32/33 % techn.'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Black Hole' AND Bezeichnung='Kupfer Sulfat'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Black Hole' AND Bezeichnung='Filterkerzen 10µ / 10" Hytrex II'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Black Hole' AND Bezeichnung='Filterkerzen 10µ/9 3/4" Garnwickelfilter'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Black Hole' AND Bezeichnung='Macuprep Etch G-5-S (Stabilisator)'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Black Hole' AND Bezeichnung='Filterbeutel 520 x 520/350 f. Bimsanlage'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Black Hole' AND Bezeichnung='Filterkerzen 75µ / 9 3/4" Hytrex II'

		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Black Hole' AND Bezeichnung='Schwefelsäure 50%, chem. rein'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Black Hole' AND Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Black Hole' AND Bezeichnung='Natronlauge 32/33 % techn.'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Black Hole' AND Bezeichnung='Kupfer Sulfat'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Black Hole' AND Bezeichnung='Filterkerzen 10µ / 10" Hytrex II'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Black Hole' AND Bezeichnung='Filterkerzen 10µ/9 3/4" Garnwickelfilter'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Black Hole' AND Bezeichnung='Macuprep Etch G-5-S (Stabilisator)'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Black Hole' AND Bezeichnung='Filterbeutel 520 x 520/350 f. Bimsanlage'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Black Hole' AND Bezeichnung='Filterkerzen 75µ / 9 3/4" Hytrex II'

		--Desmear
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.01 WHERE Anlage='Desmear' AND Bezeichnung='Schwefelsäure 50%, chem. rein'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.01 WHERE Anlage='Desmear' AND Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.03 WHERE Anlage='Desmear' AND Bezeichnung='Natronlauge 32/33 % techn.'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.25 WHERE Anlage='Desmear' AND Bezeichnung='White Sheating 30" Nr. 18002'

		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Desmear' AND Bezeichnung='Schwefelsäure 50%, chem. rein'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Desmear' AND Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Desmear' AND Bezeichnung='Natronlauge 32/33 % techn.'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Desmear' AND Bezeichnung='White Sheating 30" Nr. 18002'

		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Desmear' AND Bezeichnung='Schwefelsäure 50%, chem. rein'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Desmear' AND Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Desmear' AND Bezeichnung='Natronlauge 32/33 % techn.'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Desmear' AND Bezeichnung='White Sheating 30" Nr. 18002'

		--Mikroätze
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.1 WHERE Anlage='Mikroätze' AND Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.15 WHERE Anlage='Mikroätze' AND Bezeichnung='Schwefelsäure 96%, chem. rein'

		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Mikroätze' AND Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Mikroätze' AND Bezeichnung='Schwefelsäure 96%, chem. rein'

		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Mikroätze' AND Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Mikroätze' AND Bezeichnung='Schwefelsäure 96%, chem. rein'

		--SES Festresist-Stripper
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.5 WHERE Anlage='SES Festresist-Stripper' AND Bezeichnung='Resist Stripper'
		
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='SES Festresist-Stripper' AND Bezeichnung='Resist Stripper'

		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='SES Festresist-Stripper' AND Bezeichnung='Resist Stripper'

		--Chemisch Zinn
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.01 WHERE Anlage='Chem. Zinn' AND Bezeichnung='Schwefelsäure 50%, chem. rein'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.02 WHERE Anlage='Chem. Zinn' AND Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.03 WHERE Anlage='Chem. Zinn' AND Bezeichnung='Macuprep Etch G-5-S (Stabilisator)'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.9 WHERE Anlage='Chem. Zinn' AND Bezeichnung='White Sheating 30" Nr. 18002'

		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Chem. Zinn' AND Bezeichnung='Schwefelsäure 50%, chem. rein'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Chem. Zinn' AND Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Chem. Zinn' AND Bezeichnung='Macuprep Etch G-5-S (Stabilisator)'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='Chem. Zinn' AND Bezeichnung='White Sheating 30" Nr. 18002'

		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Chem. Zinn' AND Bezeichnung='Schwefelsäure 50%, chem. rein'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Chem. Zinn' AND Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Chem. Zinn' AND Bezeichnung='Macuprep Etch G-5-S (Stabilisator)'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='Chem. Zinn' AND Bezeichnung='White Sheating 30" Nr. 18002'

		--Ätzen alkalisch
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.05 WHERE Anlage='SES Ätzen alkalisch' AND Bezeichnung='Schwefelsäure 50%, chem. rein'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.25 WHERE Anlage='SES Ätzen alkalisch' AND Bezeichnung='White Sheating 30" Nr. 18002'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.25 WHERE Anlage='SES Ätzen alkalisch' AND Bezeichnung='Putzlappen Papier 3-lagig, blau, 1000Bl.'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.95 WHERE Anlage='SES Ätzen alkalisch' AND Bezeichnung='Salmiakgeist (Ammoniaklösung 25 %)'
		UPDATE @tblMaterialRelKosten SET Verbrauch_Korr=Verbrauch*0.1 WHERE Anlage='SES Ätzen alkalisch' AND Bezeichnung='Filterkerzen 10µ / 20" Garnwickelfilter'

		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='SES Ätzen alkalisch' AND Bezeichnung='Schwefelsäure 50%, chem. rein'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='SES Ätzen alkalisch' AND Bezeichnung='White Sheating 30" Nr. 18002'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='SES Ätzen alkalisch' AND Bezeichnung='Putzlappen Papier 3-lagig, blau, 1000Bl.'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='SES Ätzen alkalisch' AND Bezeichnung='Salmiakgeist (Ammoniaklösung 25 %)'
		UPDATE @tblMaterialRelKosten SET Rel_Kosten_Korr=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis/Durchsatz WHERE Anlage='SES Ätzen alkalisch' AND Bezeichnung='Filterkerzen 10µ / 20" Garnwickelfilter'

		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='SES Ätzen alkalisch' AND Bezeichnung='Schwefelsäure 50%, chem. rein'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='SES Ätzen alkalisch' AND Bezeichnung='White Sheating 30" Nr. 18002'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='SES Ätzen alkalisch' AND Bezeichnung='Putzlappen Papier 3-lagig, blau, 1000Bl.'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='SES Ätzen alkalisch' AND Bezeichnung='Salmiakgeist (Ammoniaklösung 25 %)'
		UPDATE @tblMaterialRelKosten SET AbsMatKosten_EUR=(Verbrauch_Korr/Umrechnungsfaktor)*EK_DPreis WHERE Anlage='SES Ätzen alkalisch' AND Bezeichnung='Filterkerzen 10µ / 20" Garnwickelfilter'

		--------------------------------------------------------------------------------

		SELECT * FROM @tblMaterialRelKosten ORDER BY Abteilung, Anlage, Bezeichnung, JahrMonat
	END
	--Materialverbrauch
	IF @Case_ = 'MaterialverbrauchDivAnlagen'
	BEGIN
		--DECLARE @myYear int
		--DECLARE @myMonth int
		--DECLARE @JahrMonat varchar(7)
		--DECLARE @JahrMonatVor varchar(7)

		DECLARE @p_D17_PTR int
		
		/*
		DECLARE @tblMaterialRelKosten table (
											Anlage_PTR int, --D17_PTR int,
											--Abteilung varchar(250) null,
											--Anlage varchar(250) null, 
											JahrMonat varchar(7) null, 
											JahrMonatStr varchar(10) null, 
											Bezeichnung char(40) null,
											Anfangsbestand NUMERIC(10,4),
											Zugaenge NUMERIC(10,4),
											Endbestand NUMERIC(10,4),
											Verbrauch NUMERIC(10,4),
											--Verbrauch_Korr NUMERIC(10,4),
											Abgemeldet NUMERIC(10,4), 
											--Durchsatz NUMERIC(10,4),
											--Durchsatz_Gesamt NUMERIC(10,4),
											EK_DPreis NUMERIC(10,4),
											EK_DPreis_Monat NUMERIC(10,4), 
											Zugaenge_EUR NUMERIC(10,4),
											Endbestand_EUR NUMERIC(10,4),
											AbsMatKosten_EUR NUMERIC(10,4),
											--Rel_Kosten NUMERIC(10,4),
											--Rel_Kosten_Korr NUMERIC(10,4),
											QUAN_ON_HAND NUMERIC(10,4), 
											Lagerwert NUMERIC(10,4), 
											EinkEinheit varchar(5) null, 
											LagerEinheit varchar(5) null, 
											Umrechnungsfaktor NUMERIC(10, 4), 
											VerbrauchSOLL NUMERIC(10,4),
											CONSIGN_ONHAND_QTY NUMERIC(10,4),
											Lagerwert_Konsi NUMERIC(10,4),
											Abweichung_EUR NUMERIC(10,4),
											EK_DPreis_Umgerech NUMERIC(10,4),
											EK_DPreis_Monat_Umgerech NUMERIC(10,4)
											)
		*/

		DECLARE myCursorSample CURSOR fast_forward FOR (
														SELECT
														DISTINCT D17_PTR
														FROM
														(
															SELECT     TOP 100 PERCENT dbo.DATA0017.RKEY AS D17_PTR, dbo.DATA0017.INV_PART_NUMBER AS Artikel, 
																		dbo.DATA0017.INV_PART_DESCRIPTION AS Bezeichnung,
															(
																SELECT
																	Count(Anlage_PTR) AS Res
																FROM
																(
																	SELECT     TOP 100 PERCENT D17_Art_PTR, Anlage_PTR
																	FROM         LIVE2.dbo.MatRueck_Transaktion
																	WHERE ISNULL(D95_PTR, 0)>0
																	GROUP BY D17_Art_PTR, Anlage_PTR
																	ORDER BY D17_Art_PTR
																) AS myTblCount
																WHERE myTblCount.D17_Art_PTR = dbo.DATA0017.RKEY
															) As Anzahl_Anlagen
															--CASE WHEN Anlage='Black Hole' THEN 'x' ELSE '' END As Ist_Blackhole
															FROM         LIVE2.dbo.MatRueck_Anlage INNER JOIN
																			  LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR INNER JOIN
																			  dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = LIVE.dbo.DATA0017.RKEY INNER JOIN
																			  dbo.DATA0095 ON LIVE2.dbo.MatRueck_Transaktion.D95_PTR = dbo.DATA0095.RKEY
															
															GROUP BY dbo.DATA0017.RKEY, dbo.DATA0017.INV_PART_NUMBER, dbo.DATA0017.INV_PART_DESCRIPTION
															ORDER BY dbo.DATA0017.INV_PART_NUMBER --Anzahl_Anlagen DESC, 
														) AS Tbl
														WHERE Bezeichnung Not Like 'Bohrer%' AND Anzahl_Anlagen>1
														)
		OPEN myCursorSample
		FETCH NEXT FROM myCursorSample INTO @p_D17_PTR --@p_Abteilung, @p_Anlage, @p_Anlage_PTR, @p_DEPT_CODE, @p_BzGr_Typ

		WHILE @@FETCH_STATUS = 0 
		BEGIN   

			SET @myYear = 2013
			SET @myMonth = 1

			WHILE @myYear < 2015
			BEGIN
				WHILE @myMonth < 13
				BEGIN
					IF CAST(LTRIM(STR(@myYear) + RIGHT('00'+LTRIM(STR(@myMonth)), 2)) AS INT) < CAST(LTRIM(STR(YEAR(GETDATE()))) + RIGHT('00'+LTRIM(STR(MONTH(GETDATE()))), 2) AS INT)
					BEGIN

						IF @myMonth='01'
							SET @JahrMonatVor = LTRIM(STR(@myYear-1) + '.12')
						ELSE
							SET @JahrMonatVor = LTRIM(STR(@myYear) + '.' + RIGHT('00'+LTRIM(STR(@myMonth-1)), 2))

						SET @JahrMonat = LTRIM(STR(@myYear) + '.' + RIGHT('00'+LTRIM(STR(@myMonth)), 2))
					
						--Material
						--------------------------------------------------------------------------------

						INSERT @tblMaterialRelKosten(
													Anlage_PTR, --D17_PTR,
													--Abteilung,
													--Anlage, 
													JahrMonat, 
													JahrMonatStr,
													Bezeichnung,
													Anfangsbestand,
													Zugaenge,
													Endbestand,
													Verbrauch,
													--Verbrauch_Korr,
													Abgemeldet, 
													--Durchsatz,
													--Durchsatz_Gesamt,
													EK_DPreis,
													EK_DPreis_Monat, 
													Zugaenge_EUR,
													Endbestand_EUR,
													AbsMatKosten_EUR,
													--Rel_Kosten,
													--Rel_Kosten_Korr,
													QUAN_ON_HAND, 
													Lagerwert, 
													EinkEinheit, 
													LagerEinheit, 
													Umrechnungsfaktor, 
													VerbrauchSOLL, 
													CONSIGN_ONHAND_QTY,
													Lagerwert_Konsi,
													Abweichung_EUR,
													EK_DPreis_Umgerech,
													EK_DPreis_Monat_Umgerech
													)
				
						SELECT 
							D17_PTR,
							--@p_Anlage_PTR AS Anlage_PTR,
							--Abteilung,
							--Anlage,
							@JahrMonat AS JahrMonat,
							LEFT(DATENAME(Month, '01.' + RIGHT(@JahrMonat, 2) + '.' + LEFT(@JahrMonat, 4)), 3) + ' ' + RIGHT(LEFT(@JahrMonat, 4), 2) AS JahrMonatStr,
							Bezeichnung,
							(Anfangsbestand_GGP+Anfangsbestand_Konsi) AS Anfangsbestand,
							Zugaenge,
							(Endbestand_GGP+Endbestand_Konsi) AS Endbestand,
							((Anfangsbestand_GGP+Anfangsbestand_Konsi)+Zugaenge-(Endbestand_GGP+Endbestand_Konsi)) AS Verbrauch,
							--((Anfangsbestand_GGP+Anfangsbestand_Konsi)+Zugaenge-(Endbestand_GGP+Endbestand_Konsi)) AS Verbrauch_Korr,
							Abgemeldet,
							--@p_Durchsatz,
							--0 AS Durchsatz_Gesamt,
							Preis_gewichtet12Mon AS EK_DPreis,
							CASE
								WHEN Zugaenge>0 THEN EK_DPreis_Monat ELSE 0
							END AS EK_DPreis_Monat,
							CAST(CASE
								WHEN Zugaenge=0 THEN 0
								ELSE
									CASE
										WHEN EK_DPreis_Monat>0 THEN (Zugaenge/Umrechnungsfaktor)*CAST(EK_DPreis_Monat AS NUMERIC(10, 4))
										ELSE (Zugaenge/Umrechnungsfaktor)*CAST(Preis_gewichtet12Mon AS NUMERIC(10, 4))
									END
							END AS NUMERIC(10, 4)) AS Zugaenge_EUR,
							(CAST(Endbestand_GGP+Endbestand_Konsi  AS NUMERIC(10, 4))/Umrechnungsfaktor)*Preis_gewichtet12Mon AS Endbestand_EUR,
							(CAST((Anfangsbestand_GGP+Anfangsbestand_Konsi)+Zugaenge-(Endbestand_GGP+Endbestand_Konsi) AS NUMERIC(10, 4))/Umrechnungsfaktor)*Preis_gewichtet12Mon AS AbsMatKosten_EUR,
							--((CAST((Anfangsbestand_GGP+Anfangsbestand_Konsi)+Zugaenge-(Endbestand_GGP+Endbestand_Konsi) AS NUMERIC(10, 4))/Umrechnungsfaktor)*Preis_gewichtet12Mon)/@p_Durchsatz AS Kostensatz, --Rel_Kosten
							--((CAST((Anfangsbestand_GGP+Anfangsbestand_Konsi)+Zugaenge-(Endbestand_GGP+Endbestand_Konsi) AS NUMERIC(10, 4))/Umrechnungsfaktor)*Preis_gewichtet12Mon)/@p_Durchsatz AS Kostensatz_Korr, --Rel_Kosten_Korr
							QUAN_ON_HAND,
							CAST((QUAN_ON_HAND/Umrechnungsfaktor)*Preis_gewichtet12Mon AS NUMERIC(10, 4)) AS Lagerwert, 
							EinkEinheit,
							LagerEinheit,
							Umrechnungsfaktor, 
							ISNULL(VerbrauchSOLL, 0) AS VerbrauchSOLL,
							CONSIGN_ONHAND_QTY,
							CAST((CONSIGN_ONHAND_QTY/Umrechnungsfaktor)*Preis_gewichtet12Mon AS NUMERIC(10, 4)) AS Lagerwert_Konsi,
							CASE
								WHEN Zugaenge=0 THEN 0
								ELSE
									CASE
										WHEN EK_DPreis_Monat>0 THEN (Zugaenge/Umrechnungsfaktor)*(EK_DPreis_Monat-Preis_gewichtet12Mon) 
										ELSE 0
									END
							END AS Abweichung_EUR,
							CAST(Preis_gewichtet12Mon/Umrechnungsfaktor AS NUMERIC(10, 4)) AS EK_DPreis_Umgerech,
							CASE
								WHEN Zugaenge>0 THEN EK_DPreis_Monat/Umrechnungsfaktor ELSE 0
							END AS EK_DPreis_Monat_Umgerech
														
						FROM
						(
							SELECT
								D17_PTR,
								--Abteilung,
								--Anlage,
								Bezeichnung,
								CAST(ISNULL((
									SELECT     SUM(LgMg) AS InvBestand
									FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
									WHERE     (JahrMonat = @JahrMonatVor) AND RKEY=myTbl1.D17_PTR --'2012.12'
								), 0) AS NUMERIC(10,4)) AS Anfangsbestand_GGP,
								CAST(ISNULL((
									SELECT     SUM(LgMg_Konsi) AS InvBestand
									FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
									WHERE     (JahrMonat = @JahrMonatVor) AND RKEY=myTbl1.D17_PTR --'2012.12'
								), 0) AS NUMERIC(10,4)) AS Anfangsbestand_Konsi,
								CAST(ISNULL((
									SELECT  ISNULL(SUM(dbo.DATA0095.QUANTITY), 0) + 
									ISNULL((
										SELECT  ISNULL(SUM(dbo.DATA0341.QUANTITY), 0) AS Zugang_Konsi
										FROM dbo.DATA0341
										WHERE dbo.DATA0341.TRAN_TP=1 AND dbo.DATA0341.DATA0017_PTR = myTbl1.D17_PTR 
											AND dbo.DATA0341.DATA0466_PTR>0 AND dbo.DATA0341.DATA0467_PTR>0
											AND LTRIM(STR(YEAR(dbo.DATA0341.TRAN_DATE)) + '.' + RIGHT('00'+LTRIM(STR(MONTH(dbo.DATA0341.TRAN_DATE))), 2))=@JahrMonat
									), 0) -
									ISNULL((
										SELECT ISNULL(SUM(dbo.DATA0467.QUAN_RETN*dbo.DATA0017.STOCK_PURCH  ), 0) AS Retourn_Konsi
										FROM       dbo.DATA0467 INNER JOIN
													dbo.DATA0017 ON dbo.DATA0467.INVT_PTR = dbo.DATA0017.RKEY
										WHERE dbo.DATA0467.QUAN_RETN>0 AND dbo.DATA0017.RKEY = myTbl1.D17_PTR 
											AND LTRIM(STR(YEAR(dbo.DATA0467.REQ_DATE)) + '.' + RIGHT('00'+LTRIM(STR(MONTH(dbo.DATA0467.REQ_DATE))), 2))=@JahrMonat
									), 0) -
									ISNULL((
										SELECT ISNULL(SUM(dbo.DATA0095.QUANTITY), 0) AS Retourn_GGP
										FROM dbo.DATA0095
										WHERE (dbo.DATA0095.TRAN_TP = 8 OR dbo.DATA0095.TRAN_TP = 20) AND dbo.DATA0095.INVT_PTR= myTbl1.D17_PTR  --dbo.DATA0017.RKEY = myTbl1.D17_PTR 
											AND LTRIM(STR(YEAR(dbo.DATA0095.ENTERED_DATE)) + '.' + RIGHT('00'+LTRIM(STR(MONTH(dbo.DATA0095.ENTERED_DATE))), 2))=@JahrMonat
									), 0) -
									ISNULL(( SELECT  ISNULL(SUM(dbo.DATA0341.QUANTITY), 0) AS K_Rueckgaengig
									FROM dbo.DATA0341
									WHERE     dbo.DATA0341.TRAN_TP=15 AND dbo.DATA0341.DATA0017_PTR = myTbl1.D17_PTR --dbo.DATA0017.RKEY = myTbl1.D17_PTR 
											AND LTRIM(STR(YEAR(dbo.DATA0341.TRAN_DATE)) + '.' + RIGHT('00'+LTRIM(STR(MONTH(dbo.DATA0341.TRAN_DATE))), 2))=@JahrMonat
											AND dbo.DATA0341.DATA0466_PTR>0 AND dbo.DATA0341.DATA0467_PTR>0
									), 0) AS Zugang_GGP_Konsi
									FROM	dbo.DATA0095 INNER JOIN
											dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
											dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
											dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY
									WHERE   dbo.DATA0095.TRAN_TP = 5 AND dbo.DATA0095.INVT_PTR = myTbl1.D17_PTR 
											AND dbo.DATA0070.PURCHASE_ORDER_TYPE = 0 
											AND LTRIM(STR(YEAR(dbo.DATA0095.TRAN_DATE)) + '.' + RIGHT('00'+LTRIM(STR(MONTH(dbo.DATA0095.TRAN_DATE))), 2))=@JahrMonat
								), 0) AS NUMERIC(10,4)) AS Zugaenge,
								CAST(ISNULL((
									SELECT     SUM(LgMg) AS InvBestand
									FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
									WHERE     (JahrMonat = @JahrMonat) AND RKEY=myTbl1.D17_PTR --'2013.11'
								), 0) AS NUMERIC(10,4)) AS Endbestand_GGP,
								CAST(ISNULL((
									SELECT     SUM(LgMg_Konsi) AS InvBestand
									FROM         LIVE2.dbo.PEX_Inventurbestaende_RHB
									WHERE     (JahrMonat = @JahrMonat) AND RKEY=myTbl1.D17_PTR --'2013.11'
								), 0) AS NUMERIC(10,4)) AS Endbestand_Konsi,
								CAST((
									CASE
										WHEN
										ISNULL(
										(SELECT
											SUM(PRICE*(QUAN_RECD - QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
											FROM
											(
												SELECT     D95.INVT_PTR, PRICE, QUAN_RECD, QUAN_RETN
												FROM         dbo.DATA0095 AS D95 INNER JOIN
																	  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
																	  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
												WHERE     (D95.TRAN_TP = 5) --AND (D95.INVT_PTR = myTbl2.D17_PTR) 
														--AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
														AND (YEAR(D95.TRAN_DATE) = YEAR(GETDATE())-1)
														AND (ISNULL(D71.PRICE, 0) > 0)
														AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
											) As myTbl12Mon
											WHERE (INVT_PTR = myTbl1.D17_PTR) 
										), 0)>0 THEN 
										(
											SELECT
											SUM(PRICE*(QUAN_RECD-QUAN_RETN))/SUM(QUAN_RECD - QUAN_RETN) AS RES
											FROM
											(
												SELECT     D95.INVT_PTR, PRICE, QUAN_RECD, QUAN_RETN,
															(SELECT TOP 1 ArtTbl.STOCK_PURCH FROM dbo.DATA0017 AS ArtTbl WHERE ArtTbl.RKEY=D95.INVT_PTR) AS UmrechFaktor
												FROM         dbo.DATA0095 AS D95 INNER JOIN
																	  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
																	  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
												WHERE     (D95.TRAN_TP = 5) --AND (D95.INVT_PTR = myTbl2.D17_PTR) 
														--AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
														AND (YEAR(D95.TRAN_DATE) = YEAR(GETDATE())-1)
														AND (ISNULL(D71.PRICE, 0) > 0)
														AND ISNULL(D71.QUAN_RECD, 0) - ISNULL(D71.QUAN_RETN, 0) > 0
											) As myTbl12Mon
											WHERE (INVT_PTR = myTbl1.D17_PTR) 
										)
										ELSE
										(
											SELECT     TOP 1 ISNULL(D71.PRICE, 0) AS RES
											FROM         dbo.DATA0095 AS D95 INNER JOIN
																  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
																  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY
											WHERE D95.RKEY=(SELECT MAX(RKEY) AS RES FROM DATA0095 WHERE TRAN_TP = 5 AND INVT_PTR = myTbl1.D17_PTR)
										)
									END
								--) AS DECIMAL(10,2))/myTbl1.Umrechnungsfaktor AS Preis_gewichtet12Mon
								) AS NUMERIC(10,4)) AS Preis_gewichtet12Mon,
								ISNULL(
										(
										SELECT AVG(MD_Preis_GGP_Konsi) AS Res
										FROM
										(
										SELECT  dbo.DATA0071.PRICE AS MD_Preis_GGP_Konsi, dbo.DATA0017.RKEY AS DATA0017_PTR
										FROM         dbo.DATA0095 INNER JOIN
															  dbo.DATA0017 ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY INNER JOIN
															  dbo.DATA0022 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0022.RKEY INNER JOIN
															  dbo.DATA0071 ON dbo.DATA0022.SOURCE_PTR = dbo.DATA0071.RKEY INNER JOIN
															  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY
										WHERE	(dbo.DATA0095.TRAN_TP = 5) 
												--AND (dbo.DATA0095.INVT_PTR = 218)--myTbl1.D17_PTR) 
												AND (LTRIM(STR(YEAR(dbo.DATA0095.TRAN_DATE)) + '.' + RIGHT('00' + LTRIM(STR(MONTH(dbo.DATA0095.TRAN_DATE))), 2)) = @JahrMonat) 
												AND (dbo.DATA0071.PRICE > 0) 
												AND dbo.DATA0070.PURCHASE_ORDER_TYPE = 0
										UNION ALL
										SELECT     dbo.DATA0467.PRICE AS MD_Preis_GGP_Konsi, dbo.DATA0017.RKEY AS DATA0017_PTR
										FROM         dbo.DATA0017 INNER JOIN
															  dbo.DATA0341 ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR INNER JOIN
															  dbo.DATA0023 ON dbo.DATA0341.DATA0023_PTR = dbo.DATA0023.RKEY INNER JOIN
															  dbo.DATA0005 ON dbo.DATA0341.DATA0005_PTR = dbo.DATA0005.RKEY INNER JOIN
															  dbo.DATA0002 ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
															  dbo.DATA0466 ON dbo.DATA0341.DATA0466_PTR = dbo.DATA0466.RKEY INNER JOIN
															  dbo.DATA0467 ON dbo.DATA0341.DATA0467_PTR = dbo.DATA0467.RKEY
										WHERE   (dbo.DATA0341.TRAN_TP = 1) 
												--AND (dbo.DATA0341.DATA0017_PTR = 218)--myTbl1.D17_PTR) 
												AND (LTRIM(STR(YEAR(dbo.DATA0341.TRAN_DATE)) + '.' + RIGHT('00' + LTRIM(STR(MONTH(dbo.DATA0341.TRAN_DATE))), 2)) = @JahrMonat) 
												AND (dbo.DATA0467.PRICE > 0)
										) AS myDMPreis
										WHERE DATA0017_PTR = myTbl1.D17_PTR
										)
								, 0) AS EK_DPreis_Monat,
								QUAN_ON_HAND,
								Umrechnungsfaktor,
								(ISNULL((
										SELECT ISNULL(SUM(dbo.DATA0095.QUANTITY), 0) AS Ausgaben
										FROM dbo.DATA0095
										WHERE dbo.DATA0095.TRAN_TP = 15 AND dbo.DATA0095.INVT_PTR= myTbl1.D17_PTR
											AND LTRIM(STR(YEAR(dbo.DATA0095.ENTERED_DATE)) + '.' + RIGHT('00'+LTRIM(STR(MONTH(dbo.DATA0095.ENTERED_DATE))), 2))=@JahrMonat
											--AND dbo.DATA0095.SRCE_PTR = @p_D34_PTR
								), 0) 
								+
								ISNULL((
										SELECT ISNULL(SUM(dbo.DATA0095.QUANTITY), 0) AS Rueckgaben
										FROM dbo.DATA0095
										WHERE dbo.DATA0095.TRAN_TP = 16 AND dbo.DATA0095.INVT_PTR= myTbl1.D17_PTR
											AND LTRIM(STR(YEAR(dbo.DATA0095.ENTERED_DATE)) + '.' + RIGHT('00'+LTRIM(STR(MONTH(dbo.DATA0095.ENTERED_DATE))), 2))=@JahrMonat
											--AND dbo.DATA0095.SRCE_PTR = @p_D34_PTR
								), 0)) AS Abgemeldet,
								LagerEinheit,
								EinkEinheit,
								VerbrauchSOLL,
								CONSIGN_ONHAND_QTY

							FROM
							(
								SELECT  dbo.DATA0017.RKEY AS D17_PTR, 
										--LIVE2.dbo.MatRueck_Abteilung.Abteilung, 
										--LIVE2.dbo.MatRueck_Anlage.Anlage, 
										dbo.DATA0017.INV_PART_NUMBER AS Artikel, 
										dbo.DATA0017.INV_PART_DESCRIPTION AS Bezeichnung, dbo.DATA0002.UNIT_CODE AS LagerEinheit, 
										ROUND(dbo.DATA0017.STOCK_PURCH, 4) AS Umrechnungsfaktor, dbo.DATA0017.QUAN_ON_HAND, DATA0002_1.UNIT_CODE AS EinkEinheit,
										CAST(dbo.DATA0017.IES_DIRECT_MATL_COST  AS NUMERIC(10, 7)) AS VerbrauchSOLL,
										dbo.DATA0017.CONSIGN_ONHAND_QTY
								--FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
								--					  LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
								--					  LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
								--					  dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
								--					  dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
								--					  dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY
								FROM         LIVE2.dbo.MatRueck_Transaktion INNER JOIN
													  dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
													  dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
													  dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY
								GROUP BY dbo.DATA0017.RKEY, 
										--LIVE2.dbo.MatRueck_Abteilung.Abteilung, LIVE2.dbo.MatRueck_Anlage.Anlage, 
										dbo.DATA0017.INV_PART_NUMBER, 
										dbo.DATA0017.INV_PART_DESCRIPTION, dbo.DATA0002.UNIT_CODE, dbo.DATA0017.STOCK_PURCH, 
										dbo.DATA0017.QUAN_ON_HAND, DATA0002_1.UNIT_CODE, dbo.DATA0017.IES_DIRECT_MATL_COST, dbo.DATA0017.CONSIGN_ONHAND_QTY
								HAVING  dbo.DATA0017.RKEY = @p_D17_PTR --    (LIVE2.dbo.MatRueck_Anlage.Anlage = @p_Anlage) --'Black Hole')
							) As myTbl1
						) As myTbl2
						--------------------------------------------------------------------------------

					END
					SET @myMonth = @myMonth + 1
				END

				SET @myYear = @myYear + 1
				SET @myMonth = 1
			END

			FETCH NEXT FROM myCursorSample INTO @p_D17_PTR --@p_Abteilung, @p_Anlage, @p_Anlage_PTR, @p_DEPT_CODE, @p_BzGr_Typ
		END

		CLOSE myCursorSample
		DEALLOCATE myCursorSample

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Au-Vorrein. Cupra  Black Hole  Black Oxide  Chem. Zinn  Desmear  HAL VBH und NBH (BF) PAL Kupferbad  PAL Microätze
          1%            20%          5%           1%        1%             2%                60%           10%' WHERE Bezeichnung='Schwefelsäure 50%, chem. rein'
		
		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Atzen sauer  Au-Vorrein. Cupra  Black Hole  Black Oxide  Chem. Zinn  Desmear  Mikroätze
      55%            1%              25%          15%          2%        1%        1%' WHERE Bezeichnung='Wasserstoffperoxid 35%, wässerige Lösung'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Abwasser1  Abwasser2  Black Hole  Black Oxide  Desmear  HAL VBH und NBH (BF)
    79%        15%         1%          1%          3%             1%' WHERE Bezeichnung='Natronlauge 32/33 % techn.'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Black Hole  Black Oxide  PAL Kupferbad
     5%          5%            90%' WHERE Bezeichnung='Kupfer Sulfat'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Abwasser1  Abwasser2  Atzen sauer  PAL Gestell-Stripper
    20%         5%         70%              5%' WHERE Bezeichnung='Salzsäure 30% techn.rein'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Au- VT, NT, Schwefelsäure  Mikroätze  ML-Pressen  SES Ätzen alkalisch
            50%                15%         30%             5%' WHERE Bezeichnung='Schwefelsäure 96%, chem. rein'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Bims-Anlage  Desmear  HAL VBH und NBH (BF)  SES Ätzen alkalisch
     25%        25%            25%                   25%' WHERE Bezeichnung='White Sheating 30" Nr. 18002'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'FD Belichter LDI  FD Belichter Max 9000  FD manueller Belichter  Siebdruck allgemein
        25%                 25%                    25%                   25%' WHERE Bezeichnung='Klebepads / Adhäsivpads 240x330mm'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
        'HAL VBH und NBH (BF)  PAL Kupferbad  SES Ätzen alkalisch  Siebdruck allgemein
                  25%               25%              25%                   25%' WHERE Bezeichnung='Putzlappen Papier 3-lagig, blau, 1000Bl.'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Atzen sauer  Black Hole  HAL VBH und NBH (BF)
      19%         81%             1%' WHERE Bezeichnung='Filterkerzen 10µ / 10" Hytrex II'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Atzen sauer  Black Hole  FD Entwickler Aussenlagen
      25%         50%              25%' WHERE Bezeichnung='Filterkerzen 10µ/9 3/4" Garnwickelfilter'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'FT Loc8 Light  FT Ultim8-1  FT Ultim8-2
      33%           33%          33%' WHERE Bezeichnung='Prüfspitzen für Ultim8'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Fräsmaschine 19  Fräsmaschine 20
        0%              0%' WHERE Bezeichnung='Bürstenring / Fräsbürste 6mm'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Abwasser 1  Abwasser 2
      0%         100%' WHERE Bezeichnung='Eisen-III Chlorid'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'FD Entwickler Aussenlagen  FD Entwickler Innenlagen
           60%                        40%' WHERE Bezeichnung='Entschäumer Pluronic BASF'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'FD Entwickler Innenlagen  Gießlinie
           50%                50%' WHERE Bezeichnung='Ethylacetat 98/100 %'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Abwasser 1  Abwasser 2
     90%         10%' WHERE Bezeichnung='Flockungsmittel'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'HAL bleifrei  HAL PBSN
     100%         0%' WHERE Bezeichnung='Fluxer'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Abwasser 1  Abwasser 2
     80%         20%' WHERE Bezeichnung='Weißkalkhydrat (Calciumhydroxid 94-96%)'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Black Hole  Chem. Zinn
     70%         30%' WHERE Bezeichnung='Macuprep Etch G-5-S (Stabilisator)'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'FD Entwickler Aussenlagen  FD Entwickler Innenlagen
           95%                         5%' WHERE Bezeichnung='Magnesiumsufat 49 % tech. (Bittersalz)'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Black Oxide  ML-Pressen
     100%         0%' WHERE Bezeichnung='Multibond 100 A-20'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'FD Entwickler Aussenlagen  FD Entwickler Innenlagen
           70%                         30%' WHERE Bezeichnung='Natriumkarbonat (Kalzium Soda)'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'HAL VBH und NBH (BF)  PAL Microätze
           5%              95%' WHERE Bezeichnung='Natriumpersulfat'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Entwickler Fotolabor  SES Ätzen alkalisch
           5%                  95%' WHERE Bezeichnung='Salmiakgeist (Ammoniaklösung 25 %)'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Au-Nickelbad  PAL Gestell-Stripper
      5%                 95%' WHERE Bezeichnung='Salpetersäure 53% techn.rein'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Abwasser 1  Abwasser 2
     80%         20%' WHERE Bezeichnung='Schwermetallfäller'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Festresist-Stripper (ÄS)  SES Festresist-Stripper
            50%                     50%' WHERE Bezeichnung='Resist Stripper'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Siebdruck allgemein  Siebherstellung
          100%               0%' WHERE Bezeichnung='Stopplack Stripper'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Abziehlack  Siebherstellung
     100%          0%' WHERE Bezeichnung='Kapillarfilm 400 µm, 45x60cm'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Bims-Anlage  Black Hole
     98%          2%' WHERE Bezeichnung='Filterbeutel 520 x 520/350 f. Bimsanlage'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Chem. Zinn  SES Ätzen alkalisch
     90%             10%' WHERE Bezeichnung='Filterkerzen 10µ / 20" Garnwickelfilter'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Atzen sauer  PAL Kupferbad
     10%           90%' WHERE Bezeichnung='Filterkerzen 10µ / 30" Garnwickelfilter'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Abwasser 1  Black Hole
     50%         50%' WHERE Bezeichnung='Filterkerzen 75µ / 9 3/4" Hytrex II'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Fräsmaschine 19  Zuschneiden
       100%            0%' WHERE Bezeichnung='Fräsunterlagen 8x700x650 mm'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'FD Belichter Max 9000  Laminieren LB
          50%                50%' WHERE Bezeichnung='Kleberolle / Adhäsionsrolle 650mm'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'KD  Stopplack 2 K
 98%       2%' WHERE Bezeichnung='ZKS Stoplack rot RAL 3020 / 432350'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'KD  Stopplack 2 K
 5%       95%' WHERE Bezeichnung='ZKS-0 Stoplack grau RAL7035 / 432806'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'KD  Stopplack 2 K
 20%       80%' WHERE Bezeichnung='ZKS-0 Stoplack schwarz incl.Härter OH-16'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Bohrmaschine 18  Fräsmaschine 19
        50%              50%' WHERE Bezeichnung='Spannzange Nr. 65264, f. LM2-80S'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'FD Entwickler Aussenlagen  FD Entwickler Innenlagen
        60%                           40%' WHERE Bezeichnung='Weinsäure'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'PAL Dekapierung Zinn  PAL Zinnbad
         70%                30%' WHERE Bezeichnung='Zinnbad NF2019 Methane Sulfonic Acid'

		UPDATE @tblMaterialRelKosten SET MatInDivAnlagen=
'Bims-Anlage  FD Entwickler Aussenlagen
      0%                100%' WHERE Bezeichnung='Zitronensäure'

		SELECT * FROM @tblMaterialRelKosten ORDER BY Bezeichnung, JahrMonat --Abteilung, Anlage, Bezeichnung, JahrMonat
	END

END
