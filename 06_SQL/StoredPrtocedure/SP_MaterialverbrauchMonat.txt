USE [LIVE]
GO
/****** Object:  StoredProcedure [dbo].[GGP_SP_MaterialverbrauchMonat]    Script Date: 22.12.2017 11:50:55 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		Daniel Simic
-- Create date: 05.08.2016
-- Last change: 05.08.2016
-- Description:	Hiermit wird Materialverbrauch pro Monat weggespeichert
-- =============================================
ALTER PROCEDURE [dbo].[GGP_SP_MaterialverbrauchMonat]
	@p_Case_ varchar(255) = '',
	@p_para1 varchar(255) = '',
	@p_para2 varchar(255) = '',
	@p_para3 varchar(255) = '',
	@p_para4 varchar(255) = '',
	@p_para5 varchar(255) = '',
	@p_para6 varchar(255) = '',
	@p_para7 varchar(255) = '',
	@p_para8 varchar(255) = '',
	@p_para9 varchar(2000) = '',
	@OUTPUT_RES AS varchar(1000) = '' OUTPUT
AS
BEGIN

	DECLARE
		@Case_ varchar(255) = '',
		@para1 varchar(255) = '',
		@para2 varchar(255) = '',
		@para3 varchar(255) = '',
		@para4 varchar(255) = '',
		@para5 varchar(255) = '',
		@para6 varchar(255) = '',
		@para7 varchar(255) = '',
		@para8 varchar(255) = '',
		@para9 varchar(2000) = ''

		SET @Case_ = @p_Case_
		SET @para1 = @p_para1
		SET @para2 = @p_para2
		SET @para3 = @p_para3
		SET @para4 = @p_para4
		SET @para5 = @p_para5
		SET @para6 = @p_para6
		SET @para7 = @p_para7
		SET @para8 = @p_para8
		SET @para9 = @p_para9

	SET NOCOUNT ON;

	--Applikation Einkaufshistorie
	IF @Case_ = 'Ätzen alkalisch'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'

		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = @Case_ AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103) 
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			@Case_ AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						--SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						--SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID IN (38, 39, 40) --Ätzen alkalisch => SES Festresist-Stripper, SES Ätzen alkalisch, SES Zinn-Stripper 
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END


	IF @Case_ = 'Ätzen sauer'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'

		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = @Case_ AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			@Case_ AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						--SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						--SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID IN (3, 41, 56) --Ätzen sauer => Ätzen sauer, FD Entwickler Innenlagen, Festresist-Stripper (ÄS)
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END


	IF @Case_ = 'Black Hole'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = @Case_ AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			@Case_ AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						--SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						--SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID = 1 --Black Hole => Black Hole
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END

	IF @Case_ = 'Chem Sn'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = @Case_ AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			@Case_ AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						--SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						--SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID = 4 --Chem. Zinn => Chem. Zinn
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END

	IF @Case_ = 'Desmear'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = @Case_ AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			@Case_ AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						--SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						--SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID = 5 --Desmear => Desmear
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END

	IF @Case_ = 'ETest'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = 'E-Test' AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			'E-Test' AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						--SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						--SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID IN (53, 54, 55) -- E-Test => FT Ultim8-1, FT Ultim8-2, FT Loc8 Light
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END

	IF @Case_ = 'Fotodruck'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = 'Fotodruck' AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			'Fotodruck' AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						--SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						--SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID IN (28, 29, 59, 58, 57, 60, 146, 147) -- Fotodruck => Laminieren LB, Laminieren galv Au, FD Belichter LDI, FD Belichter Max 9000, FD Entwickler Aussenlagen, FD manueller Belichter, Laminieren LB IL, Fotodruck allgemein 
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END


	IF @Case_ = 'Fotolabor'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = 'Fotolabor' AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			'Fotolabor' AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						--SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						--SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID IN (66, 65, 67, 64, 92) -- Fotolabor => Entwickler Fotolabor, FL Diazo-Filme, FL Fixierer, FL Silber-Filme, FL Sonstiges
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END

	IF @Case_ = 'Giesslinie'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = 'Gießlinie' AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			'Gießlinie' AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						--SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						--SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID IN (12, 30, 49, 90, 91, 143) -- Gisslienie => Gießlinie, Stopplack-Entwickler, Bims-Anlage, Belichter 2, Belichter 1, Stopplack-Stripper
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END

	IF @Case_ = 'BlackOxide'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = 'Haftvermittler' AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			'Haftvermittler' AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						--SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						--SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID = 6 -- Black Oxide
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END

	IF @Case_ = 'HAL'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = 'HAL' AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			'HAL' AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							CASE WHEN
								ISNULL((
									SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
									FROM LIVE2.dbo.NachKalk_MatVerteilung
									WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
											AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
								), 0) > 0 THEN
									ISNULL((
										SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
										FROM LIVE2.dbo.NachKalk_MatVerteilung
										WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
												AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
									), 0) 
								ELSE
									1
							END
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						CASE WHEN SUM(Menge)  > 0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						CASE WHEN SUM(RES_Menge) > 0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID IN (9, 42, 46) -- HAL => HAL PBSN, HAL bleifrei, HAL VBH und NBH
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END

	IF @Case_ = 'Mikroätze'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = 'Mikroätze' AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			'Mikroätze' AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID = 16 -- Mikroätze
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END

	IF @Case_ = 'MLPresse'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = 'ML-Presse' AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			'ML-Presse' AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						--SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						--SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID IN (19, 94, 112, 149) -- ML Presse => ML-Pressen, Plasma Ätze, ML Schweißen, ML-Pressbleche
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END

	IF @Case_ = 'QS'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = 'QS' AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			'QS' AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						--SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						--SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID IN (107, 108, 145) -- QS => Schlifferstellung, QS Labor, Klebefolie
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END

	IF @Case_ = 'Ritzen'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = 'Ritzen' AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)

		--ALT
		-----------------------------------------------------------------------------------------------------------------------------------------
		DECLARE @tblRitzenArtikel table(
											D17_PTR NUMERIC(10, 0),
											VerbrauchSOLL DECIMAL(20, 7),
											LagerEinheit varchar(5)
											)


		INSERT @tblRitzenArtikel(D17_PTR, VerbrauchSOLL, LagerEinheit) 
		SELECT  DISTINCT dbo.DATA0017.RKEY AS D17_PTR,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit
		FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
                      LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
                      LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
                      dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
                      dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
                      dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
                      LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
                      dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
		WHERE      dbo.DATA0017.ACTIVE_FLAG='Y' AND (LIVE2.dbo.MatRueck_Anlage.ID = 20) 
					AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)


		DECLARE @tblRitzVerbrauch table(
											D17_PTR NUMERIC(10, 0),
											D95_PTR NUMERIC(10, 0),
											ArtBezeichnung char(40), 
											DatumVon datetime,
											ZeitVon int,
											VerrPreis DECIMAL(20, 7),
											Verbrauch int,
											VerbrauchSOLL DECIMAL(20, 7),
											LagerEinheit varchar(5)
											)
		INSERT @tblRitzVerbrauch(D17_PTR, D95_PTR, ArtBezeichnung, DatumVon, ZeitVon, VerrPreis, Verbrauch, VerbrauchSOLL, LagerEinheit)
		SELECT
			D17_RKEY,
			D95_PTR,
			ArtBezeichnung,
			TRAN_DATE AS DatumVon,
			TTIME AS ZeitVon,
			VerrPreis,
			(
				ISNULL(tblDATA0095.QUANTITY, 0)
			) AS Verbrauch,
			(
				SELECT TOP 1 VerbrauchSOLL 
				FROM @tblRitzenArtikel AS tblRitzenArtikel 
				WHERE tblRitzenArtikel.D17_PTR=tblAnlageArtikel.D17_RKEY
			) AS VerbrauchSOLL,
			(
				SELECT TOP 1 LagerEinheit 
				FROM @tblRitzenArtikel AS tblRitzenArtikel 
				WHERE tblRitzenArtikel.D17_PTR=tblAnlageArtikel.D17_RKEY
			) AS LagerEinheit
		FROM
		(
			SELECT     LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_PTR, LIVE2.dbo.MatRueck_Anlage.Anlage, dbo.DATA0017.RKEY AS D17_RKEY, 
						dbo.DATA0017.INV_PART_DESCRIPTION AS ArtBezeichnung,
						dbo.DATA0002.UNIT_CODE AS Lagereinheit, dbo.DATA0017.STOCK_PURCH, dbo.DATA0017.STD_COST AS VerrPreis
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
					  LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
					  LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
					  dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
					  dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
					  dbo.DATA0034 ON LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR = dbo.DATA0034.RKEY
			WHERE dbo.DATA0034.DEPT_CODE = 'RITZ-01-01'
			GROUP BY LIVE2.dbo.MatRueck_Anlage.ID, LIVE2.dbo.MatRueck_Anlage.Anlage, dbo.DATA0017.RKEY, 
					dbo.DATA0017.INV_PART_DESCRIPTION , dbo.DATA0017.STOCK_PURCH, dbo.DATA0002.UNIT_CODE, dbo.DATA0017.STD_COST 
			HAVING LIVE2.dbo.MatRueck_Anlage.ID = 20
		) AS tblAnlageArtikel INNER JOIN --LEFT OUTER JOIN 
		(
			SELECT dbo.DATA0095.RKEY AS D95_PTR, ISNULL(QUANTITY, 0) AS QUANTITY, INVT_PTR, YEAR(TRAN_DATE) AS Jahr, TRAN_DATE, TTIME, MONTH(TRAN_DATE
		) AS Monat, TRAN_TP 
		FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
		WHERE dbo.DATA0095.TRAN_TP IN (15, 16, 23) AND dbo.DATA0034.DEPT_CODE = 'RITZ-01-01'
		AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
		AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
		AND dbo.DATA0095.INVT_PTR IN (SELECT D17_PTR FROM @tblRitzenArtikel AS tblRitzenArtikel) --= tblAnlageArtikel_.D17_PTR 
		) AS tblDATA0095 
		ON tblAnlageArtikel.D17_RKEY = tblDATA0095.INVT_PTR

			
		DECLARE @tblRitzAusgabe table(
											D17_PTR NUMERIC(10, 0),
											D95_PTR NUMERIC(10, 0),
											ArtBezeichnung char(40), 
											DatumVon datetime,
											ZeitVon int,
											DatumBis datetime,
											ZeitBis int,
											Tage int,
											Stunden int,
											Durchsatz DECIMAL(20, 7),
											VerrPreis DECIMAL(20, 7),
											Verbrauch int,
											VerbrauchSOLL DECIMAL(20, 7),
											LagerEinheit varchar(5)
											)
		INSERT @tblRitzAusgabe(D17_PTR, D95_PTR, ArtBezeichnung, DatumVon, ZeitVon, DatumBis, ZeitBis, Tage, 
								Stunden, Durchsatz, VerrPreis, Verbrauch, VerbrauchSOLL, LagerEinheit)
		SELECT 
			D17_PTR,
			D95_PTR,
			ArtBezeichnung,
			DatumVon,
			ZeitVon,
			ISNULL((
				SELECT TOP 1 DatumVon 
				FROM @tblRitzVerbrauch AS tblRitzVerbrauch 
				WHERE tblRitzVerbrauch.D95_PTR>tblRitzVerbrauchBasis.D95_PTR
				ORDER BY D95_PTR
			), DATEADD(dd, 0, DATEDIFF(dd, 0, GETDATE()))) AS DatumBis,
			ISNULL((
					SELECT TOP 1 ZeitVon 
						FROM @tblRitzVerbrauch AS tblRitzVerbrauch 
						WHERE tblRitzVerbrauch.D95_PTR>tblRitzVerbrauchBasis.D95_PTR
						ORDER BY D95_PTR
					), REPLACE(CONVERT(VARCHAR(8),GETDATE(),108), ':', '')) AS ZeitBis,
			DATEDIFF(d, DatumVon, (
									ISNULL((
										SELECT TOP 1 DatumVon 
										FROM @tblRitzVerbrauch AS tblRitzVerbrauch 
										WHERE tblRitzVerbrauch.D95_PTR>tblRitzVerbrauchBasis.D95_PTR
										ORDER BY D95_PTR
									), GETDATE())
			)) AS Tage,
			DATEDIFF(hh , dbo.UF_ToDateTime(ZeitVon, DatumVon) 
						, dbo.UF_ToDateTime(
											ISNULL((
													SELECT TOP 1 ZeitVon 
														FROM @tblRitzVerbrauch AS tblRitzVerbrauch 
														WHERE tblRitzVerbrauch.D95_PTR>tblRitzVerbrauchBasis.D95_PTR
														ORDER BY D95_PTR
													), REPLACE(CONVERT(VARCHAR(8),GETDATE(),108), ':', ''))
											, ISNULL((
													SELECT TOP 1 DatumVon 
														FROM @tblRitzVerbrauch AS tblRitzVerbrauch 
														WHERE tblRitzVerbrauch.D95_PTR>tblRitzVerbrauchBasis.D95_PTR
														ORDER BY D95_PTR
													), GETDATE()))
			) AS Stunden,
			ISNULL((
					SELECT     
						SUM(
							ISNULL(dbo.ARTIKELDATEN.RITZWEG, 0) * CAST(CAST(dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT AS FLOAT)/ dbo.ARTIKELDATEN.ELP_Zu + 0.9999 AS INT)
							*
							CASE WHEN dbo.ARTIKELDATEN.LPD <= 1.8 THEN 1
									ELSE
										CASE WHEN dbo.ARTIKELDATEN.LPD > 1.8 AND dbo.ARTIKELDATEN.LPD < 2.4 THEN 2
												ELSE 3
										END
							END
							)
						AS RES
					FROM         dbo.DATA0006 INNER JOIN
								  dbo.DATA0048 ON dbo.DATA0006.RKEY = dbo.DATA0048.WO_PTR INNER JOIN
								  dbo.DATA0034 ON dbo.DATA0048.WORK_CENTER_PTR = dbo.DATA0034.RKEY INNER JOIN
								  dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE    
								dbo.UF_ToDateTime(dbo.DATA0048.TTIME, dbo.DATA0048.TDATE) >= 
										dbo.UF_ToDateTime(ZeitVon, CONVERT(DATETIME, DatumVon, 103)) 
								AND dbo.UF_ToDateTime(dbo.DATA0048.TTIME, dbo.DATA0048.TDATE) <=
									dbo.UF_ToDateTime(
														(
															ISNULL((
																SELECT TOP 1 ZeitVon 
																FROM @tblRitzVerbrauch AS tblRitzVerbrauch 
																WHERE tblRitzVerbrauch.D95_PTR>tblRitzVerbrauchBasis.D95_PTR
																ORDER BY D95_PTR
															), REPLACE(CONVERT(VARCHAR(8),GETDATE(),108), ':', ''))
														) 
														, (
															CONVERT(DATETIME, (
																				ISNULL((
																					SELECT TOP 1 DatumVon 
																					FROM @tblRitzVerbrauch AS tblRitzVerbrauch 
																					WHERE tblRitzVerbrauch.D95_PTR>tblRitzVerbrauchBasis.D95_PTR
																					ORDER BY D95_PTR
																				), GETDATE()) 
															), 103) 
														))
								AND dbo.DATA0034.DEPT_CODE = 'RITZ-01-01'
				), 0) AS Durchsatz,
			VerrPreis,
			Verbrauch,
			VerbrauchSOLL,
			LagerEinheit
		FROM @tblRitzVerbrauch AS tblRitzVerbrauchBasis 
		ORDER BY D95_PTR



		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT 
			20 AS Anlage_ID,
			'Ritzen' AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			--(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			SUM(Verbrauch) AS MengeGesamt,
			0 AS Ausgabe,
			0 AS Rueckgabe,
			0 AS Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			'' AS INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			VerrPreis AS STD_COST,
			0 AS gewMonDBE_Preis,
			0 As leBE_Preis
			/*
			Bezeichnung,
			SUM(IstKosten_je_100Lfm) AS KS_IstKosten,
			SUM(SollKosten_je_10Lfm) AS SollKosten,
			SUM(MehrMinderKosten) AS MehrMinderKosten,
			SUM(IstKosten) AS IstKosten,
			VerrPreis,
			SUM(SollV_100) AS SollV_100,
			SUM(IstV_100) AS IstV_100,
			LagerEinheit,
			SUM(Verbrauch) AS Verbrauch,
			BzgGr,
			(SELECT SUM(Durchsatz) AS RES FROM @tblRitzAusgabe AS tblRitzAusgabe) AS Durchsatz,
			VerbrauchSOLL
			*/
		FROM
		(
			SELECT
				D17_PTR,
				ArtBezeichnung AS INV_PART_DESCRIPTION,
				ISNULL((
					CASE 
						WHEN Durchsatz>0 THEN
							(Verbrauch*VerrPreis)/Durchsatz 
						ELSE
							0
					END), 0) AS IstKosten_je_100Lfm,
				ISNULL((VerrPreis*VerbrauchSOLL), 0) AS SollKosten_je_10Lfm,
				ISNULL(((VerrPreis*Durchsatz*Verbrauch)-(VerrPreis*VerbrauchSOLL)), 0) AS MehrMinderKosten,
				ISNULL((Verbrauch*VerrPreis), 0) AS IstKosten,
				VerrPreis,
				ISNULL(CAST(VerbrauchSOLL AS DECIMAL(20, 7)), 0) AS SollV_100,
				Durchsatz AS IstV_100,
				LagerEinheit,
				Verbrauch,
				'Lfm' AS BzgGr,
				VerbrauchSOLL

			FROM @tblRitzAusgabe AS tblRitzAusgabe
		) AS tblGrpRitzen
		GROUP BY 			
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_DESCRIPTION, 
			VerrPreis
		-----------------------------------------------------------------------------------------------------------------------------------------




		/*
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			'Ritzen' AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID = 20 -- Ritzen
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
		*/
	END

	IF @Case_ = 'Siebdruck'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = 'Siebdruck' AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			'Siebdruck' AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						--SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						--SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID IN (21, 22, 23, 24, 27, 26, 63, 62, 61, 93, 148) -- Siebdruck => Abziehlack, Carbon, Durchsteiger, KD, Siebherstellung, Silberleitlack, Siebdruck allgemein, Stopplack 2 K, Stopplack Foto, Flexlack, Widerstandspastendruck
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END

	IF @Case_ = 'Versand'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = 'Versand' AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			'Versand' AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						--SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						--SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID = 84 -- Versand
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END

	IF @Case_ = 'Zuschnitt'
	BEGIN
		--DECLARE 
		--	@para1 varchar(255),
		--	@para2 varchar(255)
		--SET @para1 = '01.07.2016'
		--SET @para2 = '31.07.2016'
		DELETE LIVE2.dbo.Materialverbrauch_Monat 
		WHERE Prozess = 'Zuschnitt' AND Datum >= CONVERT(DATETIME, @para1, 103) AND Datum <= CONVERT(DATETIME, @para2, 103)
		INSERT LIVE2.dbo.Materialverbrauch_Monat(
													MatRueckmeldung_AnlageID
													, Prozess
													, JahrMonat
													, Datum
													, ErstelltAm
													, Menge
													, MengeAusgabe
													, MengeRueckgabe
													, MengeInventur
													, Verbrauch_SOLL
													, LagerEinheit
													, D17_PTR
													, INV_PART_NUMBER
													, INV_PART_DESCRIPTION
													, STD_COST
													, gewMonDBE_Preis
													, leBE_Preis
												)
		SELECT
			Anlage_ID,
			'Zuschnitt' AS Prozess,
			RIGHT(RTRIM(@para1), 4) + '.' + LEFT(RIGHT(RTRIM(@para1), 7), 2) AS JahrMonat,
			@para2 AS Datum,
			GETDATE() AS ErstelltAm,
			(Ausgabe + Rueckgabe + Inventur) AS MengeGesamt,
			Ausgabe,
			Rueckgabe,
			Inventur,
			VerbrauchSOLL,
			LagerEinheit,
			D17_PTR,
			INV_PART_NUMBER,
			INV_PART_DESCRIPTION, 
			STD_COST,
			gewMonDBE_Preis,
			leBE_Preis
		FROM
		(
			SELECT  DISTINCT 
				LIVE2.dbo.MatRueck_Anlage.ID AS Anlage_ID,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 15 
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Ausgabe,
				ISNULL((
						SELECT TOP 1
							SUM(dbo.DATA0095.QUANTITY) AS RES
						FROM dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
						WHERE 
							dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
							AND dbo.DATA0095.TRAN_TP = 16
							AND dbo.DATA0034.RKEY = LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
							AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
				), 0) AS Rueckgabe,
				ISNULL((
					SELECT 
						ISNULL((
							(-1)*SUM(QUANTITY) 
							*
							ISNULL((
								SELECT TOP 1 CAST(LIVE2.dbo.NachKalk_MatVerteilung.Verteilung_Prozent AS NUMERIC(10, 4))/100
								FROM LIVE2.dbo.NachKalk_MatVerteilung
								WHERE LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID
										AND LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR = dbo.DATA0017.RKEY
							), 0) 
						), 0) AS RES 
					FROM 
						dbo.DATA0095 LEFT OUTER JOIN dbo.DATA0034 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0034.RKEY
					WHERE 
						dbo.DATA0095.TRAN_TP = 23
						AND dbo.DATA0095.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
						AND dbo.DATA0095.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
						AND dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY
				), 0) AS Inventur,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE AS LagerEinheit,
				dbo.DATA0017.RKEY AS D17_PTR, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR,
				ISNULL((
					SELECT TOP 1
						--SUM(Res_DREPreis*Menge)/SUM(Menge) AS DPreis_12Mon
						CASE WHEN SUM(Menge)>0 THEN SUM(Res_DREPreis*Menge)/SUM(Menge) ELSE 0 END AS DPreis_12Mon
					FROM
					(
						SELECT     
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS Res_DREPreis,
							D95.QUANTITY As Menge,
							D95.INVT_PTR
						FROM         dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR RIGHT OUTER JOIN
											  dbo.DATA0095 AS D95 INNER JOIN
											  dbo.DATA0022 AS D22 ON D95.SRCE_PTR = D22.RKEY INNER JOIN
											  dbo.DATA0071 AS D71 ON D22.SOURCE_PTR = D71.RKEY INNER JOIN
											  dbo.DATA0070 AS D70 ON D71.PO_PTR = D70.RKEY ON D108.DATA0071_PTR = D71.RKEY
						WHERE     
							D95.INVT_PTR = dbo.DATA0017.RKEY
							AND D95.TRAN_TP = 5 
							AND (D95.TRAN_DATE > DATEADD(mm, - 12, GETDATE())) 
							--AND D95.TRAN_DATE >= CONVERT(DATETIME, @para1, 103) 
							--AND D95.TRAN_DATE <= CONVERT(DATETIME, @para2, 103) 
					) AS tblDPreisTbl
				), 0)  AS gewMonDBE_Preis,
				ISNULL((
					SELECT TOP 1
						--SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) AS RES
						CASE WHEN SUM(RES_Menge)>0 THEN SUM(RES_Preis*RES_Menge)/SUM(RES_Menge) ELSE 0 END AS RES
					FROM
					(
						SELECT TOP 1    
							CASE 
								WHEN ISNULL(D108.PRICE, 0)>0 THEN (D108.PRICE/dbo.DATA0107.EX_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH)
								ELSE
									CASE WHEN ISNULL(D71.PRICE, 0)>0 THEN (D71.PRICE/D70.EXCHANGE_RATE)/ISNULL((SELECT TOP 1 CONVERSION_FACTOR 
																									FROM dbo.DATA0028 
																									WHERE dbo.DATA0028.SUPPLIER_PTR=D70.SUPPLIER_POINTER
																										AND dbo.DATA0028.INVENTORY_PTR=dbo.DATA0017.RKEY), dbo.DATA0017.STOCK_PURCH) 
										ELSE 0
									END
							END AS RES_Preis,
							CASE 
								WHEN ISNULL(D108.QUANTITY, 0)>0 THEN (D108.QUANTITY)
								ELSE
									CASE WHEN ISNULL(D71.QUAN_ORD, 0)>0 THEN (D71.QUAN_ORD) 
										ELSE 0
									END
							END AS RES_Menge
						FROM         dbo.DATA0070 AS D70 INNER JOIN
											  dbo.DATA0071 AS D71 ON D70.RKEY = D71.PO_PTR LEFT OUTER JOIN
											  dbo.DATA0107 INNER JOIN
											  dbo.DATA0108 AS D108 ON dbo.DATA0107.RKEY = D108.DATA0107_PTR ON D71.RKEY = D108.DATA0071_PTR
						WHERE     
							D71.INVT_PTR = dbo.DATA0017.RKEY
						ORDER BY 
							D70.PO_DATE DESC
					) AS tblLeEK_Preis
				), 0)  AS leBE_Preis
			
			FROM         LIVE2.dbo.MatRueck_Abteilung INNER JOIN
							LIVE2.dbo.MatRueck_Transaktion ON LIVE2.dbo.MatRueck_Abteilung.ID = LIVE2.dbo.MatRueck_Transaktion.Abteilung_PTR INNER JOIN
							LIVE2.dbo.MatRueck_Anlage ON LIVE2.dbo.MatRueck_Transaktion.Anlage_PTR = LIVE2.dbo.MatRueck_Anlage.ID INNER JOIN
							dbo.DATA0017 ON LIVE2.dbo.MatRueck_Transaktion.D17_Art_PTR = dbo.DATA0017.RKEY INNER JOIN
							dbo.DATA0002 ON dbo.DATA0017.STOCK_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
							dbo.DATA0002 AS DATA0002_1 ON dbo.DATA0017.PURCH_UNIT_PTR = DATA0002_1.RKEY INNER JOIN
							LIVE2.dbo.NachKalk_MatVerteilung ON LIVE2.dbo.MatRueck_Anlage.ID = LIVE2.dbo.NachKalk_MatVerteilung.Anlage_PTR AND 
							dbo.DATA0017.RKEY = LIVE2.dbo.NachKalk_MatVerteilung.D17_PTR
			WHERE      
				LIVE2.dbo.MatRueck_Anlage.ID = 68 -- Zuschnitt
				AND LIVE2.dbo.NachKalk_MatVerteilung.KSMaterial = CAST(1 AS bit)
				AND dbo.DATA0017.INV_PART_DESCRIPTION NOT LIKE 'Aluminium %'
				AND dbo.DATA0017.INV_PART_DESCRIPTION NOT LIKE 'Bohrunterl%'
				AND dbo.DATA0017.INV_PART_DESCRIPTION NOT LIKE 'Fräsunterlagen%'
				AND dbo.DATA0017.INV_PART_DESCRIPTION NOT LIKE 'Plexiglas%'
			GROUP BY 
				LIVE2.dbo.MatRueck_Anlage.ID,
				LIVE2.dbo.NachKalk_MatVerteilung.VerbrauchSOLL,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0017.RKEY, 
				dbo.DATA0017.INV_PART_NUMBER,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0017.STD_COST,
				dbo.DATA0017.STOCK_PURCH,
				LIVE2.dbo.MatRueck_Transaktion.D34_Dept_PTR
		) AS tblGrp
	END
END
