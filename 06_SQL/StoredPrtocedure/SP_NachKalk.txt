USE [LIVE]
GO
/****** Object:  StoredProcedure [dbo].[GGP_SP_NachKalk]    Script Date: 22.12.2017 11:57:55 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO
-- =============================================
-- Author:		D.S.Simic
-- Create date: 25.04.2014
-- Change date: 24.05.2014
-- Description:	Wird bei der Nachkalkulation verwendet
-- =============================================
ALTER PROCEDURE [dbo].[GGP_SP_NachKalk]
	@p_Case_ varchar(255) = '',
	@p_para1 varchar(255) = '',
	@p_para2 varchar(255) = '',
	@p_para3 varchar(255) = '',
	@p_para4 varchar(255) = '',
	@p_para5 varchar(255) = '',
	@p_para6 varchar(255) = '',
	@p_para7 varchar(255) = '',
	@p_para8 varchar(255) = '',
	@p_para9 varchar(2000) = '',
	@p_para10 varchar(2000) = '',
	@OUTPUT_RES AS varchar(1000) = '' OUTPUT
AS
BEGIN

	DECLARE
		@Case_ varchar(255) = '',
		@para1 varchar(255) = '',
		@para2 varchar(255) = '',
		@para3 varchar(255) = '',
		@para4 varchar(255) = '',
		@para5 varchar(255) = '',
		@para6 varchar(255) = '',
		@para7 varchar(255) = '',
		@para8 varchar(255) = '',
		@para9 varchar(2000) = '',
		@para10 varchar(2000) = ''

		SET @Case_ = @p_Case_
		SET @para1 = @p_para1
		SET @para2 = @p_para2
		SET @para3 = @p_para3
		SET @para4 = @p_para4
		SET @para5 = @p_para5
		SET @para6 = @p_para6
		SET @para7 = @p_para7
		SET @para8 = @p_para8
		SET @para9 = @p_para9
		SET @para10 = @p_para10

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


	IF @Case_ = 'abDatum_FA_Kundenteil'
	BEGIN
		SELECT     TOP 100 PERCENT RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) AS Kundenteil, 
							  SUBSTRING(dbo.DATA0006.WORK_ORDER_NUMBER, 1, 12) AS FA
		FROM         dbo.DATA0006 INNER JOIN
							  dbo.DATA0048 ON dbo.DATA0006.RKEY = dbo.DATA0048.WO_PTR INNER JOIN
							  dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
		WHERE     (dbo.DATA0048.TDATE >= CONVERT(DATETIME, @para1, 102)) AND (dbo.DATA0006.PROD_STATUS = 5)
					AND SUBSTRING(dbo.DATA0006.WORK_ORDER_NUMBER, 1, 1)<>'T'
		GROUP BY RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV), dbo.DATA0006.WORK_ORDER_NUMBER
		ORDER BY RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV), dbo.DATA0006.WORK_ORDER_NUMBER
	END

	IF @Case_ = 'FA_Kundenteil'
	BEGIN
		SELECT   SUBSTRING(dbo.DATA0006.WORK_ORDER_NUMBER, 1, 12) AS WORK_ORDER_NUMBER
		FROM         dbo.DATA0006 INNER JOIN
							  dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
		WHERE ROOT_PTR=0 AND RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) LIKE @para1
		ORDER BY dbo.DATA0006.WORK_ORDER_NUMBER
	END

	IF @Case_ = 'FA_KundenteilKunde'
	BEGIN
		/*
		SELECT   
				SUBSTRING(dbo.DATA0006.WORK_ORDER_NUMBER, 1, 12) AS FA, 
				dbo.DATA0006.ACT_COMPL_DATE, 
				dbo.DATA0010.CUSTOMER_NAME, 
				RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) AS Kundenteil,
				dbo.DATA0006.PROD_STATUS
		FROM         dbo.DATA0006 INNER JOIN
							  dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
							  dbo.DATA0010 ON dbo.DATA0050.CUSTOMER_PTR = dbo.DATA0010.RKEY
		WHERE 
			ROOT_PTR=0 
			AND dbo.DATA0006.PROD_STATUS IN (5, 3007)
			AND (
					(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para3, 103))AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para4, 103))
					OR
					ISNULL(dbo.DATA0006.ACT_COMPL_DATE, '')=''
				)
			AND 
				(
					RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para1
					OR
					RTRIM(dbo.DATA0010.CUSTOMER_NAME) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para1
				)
			AND SUBSTRING(LTRIM(dbo.DATA0050.CP_REV), 1, 1) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para2
		ORDER BY 
			RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) DESC,
			dbo.DATA0006.ACT_COMPL_DATE DESC
		*/
		IF @para2='A' 
		BEGIN
			SELECT   
					SUBSTRING(dbo.DATA0006.WORK_ORDER_NUMBER, 1, 12) AS FA, 
					dbo.DATA0006.ACT_COMPL_DATE, 
					dbo.DATA0010.CUSTOMER_NAME, 
					RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) AS Kundenteil,
					dbo.DATA0006.PROD_STATUS
			FROM         dbo.DATA0006 INNER JOIN
								  dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
								  dbo.DATA0010 ON dbo.DATA0050.CUSTOMER_PTR = dbo.DATA0010.RKEY
			WHERE 
				ROOT_PTR=0 
				AND dbo.DATA0006.PROD_STATUS IN (5, 3007)
				AND (
						(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para3, 103))AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para4, 103))
						OR
						ISNULL(dbo.DATA0006.ACT_COMPL_DATE, '')=''
					)
				AND 
					(
						RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para1
						OR
						RTRIM(dbo.DATA0010.CUSTOMER_NAME) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para1
					)
				AND SUBSTRING(LTRIM(dbo.DATA0050.CP_REV), 1, 1) IN ('1', '2', '9')
			ORDER BY 
				RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) DESC,
				dbo.DATA0006.ACT_COMPL_DATE DESC
		END
		ELSE
		BEGIN
			SELECT   
					SUBSTRING(dbo.DATA0006.WORK_ORDER_NUMBER, 1, 12) AS FA, 
					dbo.DATA0006.ACT_COMPL_DATE, 
					dbo.DATA0010.CUSTOMER_NAME, 
					RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) AS Kundenteil,
					dbo.DATA0006.PROD_STATUS
			FROM         dbo.DATA0006 INNER JOIN
								  dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
								  dbo.DATA0010 ON dbo.DATA0050.CUSTOMER_PTR = dbo.DATA0010.RKEY
			WHERE 
				ROOT_PTR=0 
				AND dbo.DATA0006.PROD_STATUS IN (5, 3007)
				AND (
						(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para3, 103))AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para4, 103))
						OR
						ISNULL(dbo.DATA0006.ACT_COMPL_DATE, '')=''
					)
				AND 
					(
						RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para1
						OR
						RTRIM(dbo.DATA0010.CUSTOMER_NAME) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para1
					)
				AND SUBSTRING(LTRIM(dbo.DATA0050.CP_REV), 1, 1) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE @para2
			ORDER BY 
				RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) DESC,
				dbo.DATA0006.ACT_COMPL_DATE DESC
		END
	END

	IF @Case_ = 'Kommissionsdaten'
	BEGIN
		SELECT     
			dbo.DATA0060.RKEY AS D60_PTR,
			dbo.DATA0060.SALES_ORDER AS Kommission, 
			dbo.DATA0064.ANALYSIS_CODE_5 AS Kommission_eingetragen, 
			dbo.DATA0060.PARTS_ORDERED AS bestellt, 
			dbo.DATA0064.DATE_SHIPPED AS gesendet_am, 
			dbo.DATA0064.QUAN_SHIPPED AS gesendet, 
			dbo.DATA0060.PARTS_RETURNED AS retourniert,
			CASE 
				WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
					ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
					* 
					dbo.DATA0060.EXCH_RATE 
				ELSE
					dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
			END AS ELP_Preis_EUR, 
			CASE WHEN dbo.DATA0060.STATUS = 4 THEN 'komplettiert' ELSE STR(dbo.DATA0060.STATUS) END AS STATUS,
			dbo.DATA0052.QUAN_SHP AS gesendet_FA,
			ISNULL((SELECT TOP 1 dbo.DATA0507.TOOLING_CHARGES FROM dbo.DATA0507 WITH (NOLOCK) WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0) AS NK
		FROM         dbo.DATA0006 WITH (NOLOCK) INNER JOIN
							  dbo.DATA0053 WITH (NOLOCK) ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
							  dbo.DATA0052 WITH (NOLOCK) ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
							  dbo.DATA0064 WITH (NOLOCK) ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
							  dbo.DATA0060 WITH (NOLOCK) ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
							  dbo.DATA0010 WITH (NOLOCK) ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
							  dbo.DATA0050 WITH (NOLOCK) ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
							  dbo.DATA0008 WITH (NOLOCK) ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
							  dbo.ARTIKELDATEN WITH (NOLOCK) ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
		WHERE     dbo.DATA0006.WORK_ORDER_NUMBER = @para1 --'  -093456-01-000' 
	END

	IF @Case_ = 'FA_MatKosten'
	BEGIN
		SELECT DISTINCT *
		FROM
		(
			SELECT
				dbo_DATA0006.WORK_ORDER_NUMBER,
				CASE
					WHEN dbo_DATA0006.ROOT_PTR=0 THEN 'Aussenlage'
					ELSE 'Innenlage'
						--SUBSTRING(dbo.DATA0006.WORK_ORDER_NUMBER, 14, 1) + '. Innenlage' + ', Material ' + SUBSTRING(dbo.DATA0006.WORK_ORDER_NUMBER, 16, 1) 
				END AS Level,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0020.BATCH_NO AS Charge,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0095.QUANTITY,
				dbo.DATA0017.STOCK_PURCH,
				ISNULL((
					SELECT TOP 1     
						ISNULL(dbo.DATA0108.PRICE, 0) AS RES
					FROM         dbo.DATA0070 WITH (NOLOCK) INNER JOIN
										  dbo.DATA0071 WITH (NOLOCK) ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR LEFT OUTER JOIN
										  dbo.DATA0107 WITH (NOLOCK) INNER JOIN
										  dbo.DATA0108 WITH (NOLOCK) ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
					WHERE dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR
				), 0) AS EK_Preis,
				--dbo.DATA0108.PRICE AS EK_Preis,
				ISNULL((
					SELECT TOP 1     
						ISNULL(dbo.DATA0107.EX_RATE, 0) AS RES
					FROM         dbo.DATA0070 WITH (NOLOCK) INNER JOIN
										  dbo.DATA0071 WITH (NOLOCK) ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR LEFT OUTER JOIN
										  dbo.DATA0107 WITH (NOLOCK) INNER JOIN
										  dbo.DATA0108 WITH (NOLOCK) ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
					WHERE dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR
				), 0) AS EK_WK,
				--dbo.DATA0107.EX_RATE AS EK_WK,
				ISNULL((
					SELECT TOP 1     
						ISNULL(dbo.DATA0071.PRICE, 0) AS RES
					FROM         dbo.DATA0070 WITH (NOLOCK) INNER JOIN
										  dbo.DATA0071 WITH (NOLOCK) ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR LEFT OUTER JOIN
										  dbo.DATA0107 WITH (NOLOCK) INNER JOIN
										  dbo.DATA0108 WITH (NOLOCK) ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
					WHERE dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR
				), 0) AS BE_Preis,
				--dbo.DATA0071.PRICE AS BE_Preis,
				ISNULL((
					SELECT TOP 1     
						ISNULL(dbo.DATA0070.EXCHANGE_RATE, 0) AS RES
					FROM         dbo.DATA0070 WITH (NOLOCK) INNER JOIN
										  dbo.DATA0071 WITH (NOLOCK) ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR LEFT OUTER JOIN
										  dbo.DATA0107 WITH (NOLOCK) INNER JOIN
										  dbo.DATA0108 WITH (NOLOCK) ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
					WHERE dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR
				), 0) AS BE_WK,
				--dbo.DATA0070.EXCHANGE_RATE AS BE_WK,
				dbo.DATA0017.ACTUAL_COST AS STD_COST,
				ISNULL((
					SELECT TOP 1     
					CASE
						WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN 
							(dbo.DATA0108.PRICE/dbo.DATA0107.EX_RATE)*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
						ELSE
							CASE
								WHEN ISNULL(dbo.DATA0071.PRICE, 0)>0 THEN 
									(dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE)*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
								ELSE
									dbo.DATA0017.ACTUAL_COST*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
							END
					END AS RES
					FROM         dbo.DATA0070 WITH (NOLOCK) INNER JOIN
										  dbo.DATA0071 WITH (NOLOCK) ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR LEFT OUTER JOIN
										  dbo.DATA0107 WITH (NOLOCK) INNER JOIN
										  dbo.DATA0108 WITH (NOLOCK) ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
					WHERE dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR
				), (dbo.DATA0017.ACTUAL_COST*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH))) AS Materialkosten 
			FROM         dbo.DATA0020 WITH (NOLOCK) RIGHT OUTER JOIN
                      dbo.DATA0050 WITH (NOLOCK) INNER JOIN
                      dbo.DATA0095 WITH (NOLOCK) INNER JOIN
                      dbo.DATA0067 WITH (NOLOCK) ON dbo.DATA0095.SRCE_PTR = dbo.DATA0067.RKEY INNER JOIN
                      --dbo.DATA0006 ON dbo.DATA0067.WO_PTR = dbo.DATA0006.RKEY ON dbo.DATA0050.RKEY = dbo.DATA0006.CUST_PART_PTR INNER JOIN
					  (
							SELECT RKEY, ROOT_PTR, CUST_PART_PTR, REPLACE(WORK_ORDER_NUMBER, 'B', 'M') AS WORK_ORDER_NUMBER 
							FROM dbo.DATA0006 WITH (NOLOCK)
							WHERE SUBSTRING(dbo.DATA0006.WORK_ORDER_NUMBER, 3, 10) = SUBSTRING(@para1, 3, 10)
					  ) AS dbo_DATA0006 ON dbo.DATA0067.WO_PTR = dbo_DATA0006.RKEY ON dbo.DATA0050.RKEY = dbo_DATA0006.CUST_PART_PTR INNER JOIN
                      dbo.DATA0010 WITH (NOLOCK) ON dbo.DATA0050.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
                      dbo.DATA0008 WITH (NOLOCK) ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
                      dbo.DATA0017 WITH (NOLOCK) INNER JOIN
                      dbo.DATA0002 WITH (NOLOCK) ON dbo.DATA0017.PURCH_UNIT_PTR = dbo.DATA0002.RKEY INNER JOIN
                      dbo.DATA0002 AS DATA0002_1 WITH (NOLOCK) ON dbo.DATA0017.STOCK_UNIT_PTR = DATA0002_1.RKEY ON dbo.DATA0095.INVT_PTR = dbo.DATA0017.RKEY ON 
                      dbo.DATA0020.RKEY = dbo.DATA0095.INVT_LOC_PTR
			WHERE     (dbo.DATA0095.TRAN_TP = 13 OR dbo.DATA0095.TRAN_TP = 14) AND (dbo.DATA0017.TTYPE = 'R' OR
								  dbo.DATA0017.TTYPE = 'M') AND (dbo_DATA0006.WORK_ORDER_NUMBER LIKE @para1 ) --'  -086881-01%') -- = 147320)
									AND ISNULL(dbo.DATA0020.BATCH_NO, '')<>''

			UNION ALL

			SELECT
				dbo_DATA0006.WORK_ORDER_NUMBER,
				CASE
					WHEN dbo_DATA0006.ROOT_PTR=0 THEN 'Aussenlage'
					ELSE 'Innenlage'
						--SUBSTRING(dbo.DATA0006.WORK_ORDER_NUMBER, 14, 1) + '. Innenlage' + ', Material ' + SUBSTRING(dbo.DATA0006.WORK_ORDER_NUMBER, 16, 1) 
				END AS Level,
				dbo.DATA0017.INV_PART_DESCRIPTION,
				dbo.DATA0341.REFERENCE_NUMBER AS Charge,
				dbo.DATA0002.UNIT_CODE,
				dbo.DATA0341.QUANTITY,
				dbo.DATA0017.STOCK_PURCH,
				ISNULL(dbo.DATA0467.PRICE, 0) AS EK_Preis,
				ISNULL(dbo.DATA0466.EXCHANGE_RATE, 0) AS EK_WK,
				ISNULL(dbo.DATA0467.PRICE, 0) AS BE_Preis,
				ISNULL(dbo.DATA0466.EXCHANGE_RATE, 0) AS BE_WK,
				dbo.DATA0017.ACTUAL_COST AS STD_COST,
				CASE 
					WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 then
						(dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE) * dbo.DATA0341.QUANTITY
					ELSE
						(dbo.DATA0017.ACTUAL_COST * dbo.DATA0341.QUANTITY) 
				END AS Materialkosten
			FROM         dbo.DATA0467 WITH (NOLOCK) INNER JOIN
								  dbo.DATA0466 WITH (NOLOCK) ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
								  dbo.DATA0002 WITH (NOLOCK) INNER JOIN
								  dbo.DATA0017 WITH (NOLOCK) ON dbo.DATA0002.RKEY = dbo.DATA0017.STOCK_UNIT_PTR INNER JOIN
								  dbo.DATA0067 WITH (NOLOCK) INNER JOIN
								  dbo.DATA0341 WITH (NOLOCK) ON dbo.DATA0067.RKEY = dbo.DATA0341.SRCE_PTR INNER JOIN
								  --dbo.DATA0006 ON dbo.DATA0067.WO_PTR = dbo.DATA0006.RKEY ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR ON 
								  (
										SELECT RKEY, ROOT_PTR, CUST_PART_PTR, REPLACE(WORK_ORDER_NUMBER, 'B', 'M') AS WORK_ORDER_NUMBER 
										FROM dbo.DATA0006 WITH (NOLOCK)
										WHERE SUBSTRING(dbo.DATA0006.WORK_ORDER_NUMBER, 3, 10) = SUBSTRING(@para1, 3, 10)
								  ) AS dbo_DATA0006 ON dbo.DATA0067.WO_PTR = dbo_DATA0006.RKEY ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR ON 
								  dbo.DATA0467.RKEY = dbo.DATA0341.DATA0467_PTR
			WHERE     (dbo.DATA0341.TRAN_TP IN (4, 6)) AND (dbo.DATA0017.TTYPE = 'R' OR
								  dbo.DATA0017.TTYPE = 'M') AND (dbo_DATA0006.WORK_ORDER_NUMBER LIKE @para1 ) --= '  -093073-01-000')
									--AND ISNULL(dbo.DATA0341.REFERENCE_NUMBER, '')<>''
		) AS tblMatKosten

	END

	IF @Case_ = 'Kosten_je_Bohrer'
	BEGIN
		SELECT TOP 1
		ISNULL(
			CASE
				WHEN (Standzeit+StandzeitS1)*(1+Bruchfaktor)>0 THEN
					(Neupreis+Schliffpreis)/(Standzeit+StandzeitS1)*(1+Bruchfaktor) 
				ELSE
					0
			END , 0) AS Kosten_je_Bohrer 
		FROM LIVE2.dbo.NachKalk_Bohrerwerte WHERE BD=CAST(@para1 AS NUMERIC(20, 7)) and ISNULL(Zusatz, '')=''
	END

	IF @Case_ = 'MaterialkostenALIL'
	BEGIN
		SELECT TOP 1
			ISNULL(SUM(Materialkosten), 0) AS RES
		FROM
		(
			SELECT
				dbo.DATA0006.RKEY AS D6_PTR_MatKosten,
				ISNULL((
					SELECT TOP 1
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN 
								(dbo.DATA0108.PRICE/dbo.DATA0107.EX_RATE)*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
							ELSE
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN 
										(dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE)*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
									ELSE
										dbo.DATA0017.ACTUAL_COST*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
								END
						END
					FROM         dbo.DATA0107 WITH (NOLOCK) INNER JOIN
											dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
											dbo.DATA0070 INNER JOIN
											dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
					WHERE     (dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR) 
				), (dbo.DATA0017.ACTUAL_COST*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH))) AS Materialkosten 
			FROM         dbo.DATA0095 WITH (NOLOCK) INNER JOIN
									dbo.DATA0067 WITH (NOLOCK) ON dbo.DATA0095.SRCE_PTR = dbo.DATA0067.RKEY INNER JOIN
									dbo.DATA0006 WITH (NOLOCK) ON dbo.DATA0067.WO_PTR = dbo.DATA0006.RKEY INNER JOIN
									dbo.DATA0020 WITH (NOLOCK) ON dbo.DATA0095.INVT_LOC_PTR = dbo.DATA0020.RKEY INNER JOIN
									dbo.DATA0017 WITH (NOLOCK) ON dbo.DATA0020.INVENTORY_POINTER = dbo.DATA0017.RKEY INNER JOIN
									dbo.DATA0050 WITH (NOLOCK) ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
			WHERE     (dbo.DATA0095.TRAN_TP = 13 OR dbo.DATA0095.TRAN_TP = 14) AND (dbo.DATA0017.TTYPE = 'R' OR
									dbo.DATA0017.TTYPE = 'M') AND (dbo.DATA0006.WORK_ORDER_NUMBER LIKE @para1) --@para1 ) --'  -086881-01%') -- = 147320)
								AND ISNULL(dbo.DATA0020.BATCH_NO, '')<>''

			UNION ALL

			SELECT
				dbo.DATA0006.RKEY AS D6_PTR_MatKosten, 
				ISNULL((CASE 
					WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 then
						(dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE) * dbo.DATA0341.QUANTITY
					ELSE
						(dbo.DATA0017.ACTUAL_COST * dbo.DATA0341.QUANTITY) 
				END), 0) AS Materialkosten
			FROM         dbo.DATA0467 WITH (NOLOCK) INNER JOIN
									dbo.DATA0466 WITH (NOLOCK) ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									dbo.DATA0002 WITH (NOLOCK) INNER JOIN
									dbo.DATA0017 WITH (NOLOCK) ON dbo.DATA0002.RKEY = dbo.DATA0017.STOCK_UNIT_PTR INNER JOIN
									dbo.DATA0067 WITH (NOLOCK) INNER JOIN
									dbo.DATA0341 WITH (NOLOCK) ON dbo.DATA0067.RKEY = dbo.DATA0341.SRCE_PTR INNER JOIN
									dbo.DATA0006 WITH (NOLOCK) ON dbo.DATA0067.WO_PTR = dbo.DATA0006.RKEY ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR ON 
									dbo.DATA0467.RKEY = dbo.DATA0341.DATA0467_PTR
			WHERE     (dbo.DATA0341.TRAN_TP IN (4, 6)) AND (dbo.DATA0017.TTYPE = 'R' OR
									dbo.DATA0017.TTYPE = 'M') AND (dbo.DATA0006.WORK_ORDER_NUMBER LIKE @para1)
						AND ISNULL(dbo.DATA0341.REFERENCE_NUMBER, '')<>''
		) AS tblMatKosten
		--WHERE D6_PTR_MatKosten = D0006_PTR
	END

	IF @Case_ = 'MaterialkostenAL'
	BEGIN
		SELECT TOP 1
			ISNULL(SUM(Materialkosten), 0) AS RES
		FROM
		(
			SELECT
				dbo.DATA0006.RKEY AS D6_PTR_MatKosten,
				ISNULL((
					SELECT TOP 1
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN 
								(dbo.DATA0108.PRICE/dbo.DATA0107.EX_RATE)*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
							ELSE
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN 
										(dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE)*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
									ELSE
										dbo.DATA0017.ACTUAL_COST*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
								END
						END
					FROM         dbo.DATA0107 WITH (NOLOCK) INNER JOIN
											dbo.DATA0108 WITH (NOLOCK) ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
											dbo.DATA0070 WITH (NOLOCK) INNER JOIN
											dbo.DATA0071 WITH (NOLOCK) ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
					WHERE     (dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR) 
				), (dbo.DATA0017.ACTUAL_COST*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH))) AS Materialkosten 
			FROM         dbo.DATA0095 WITH (NOLOCK) INNER JOIN
									dbo.DATA0067 WITH (NOLOCK) ON dbo.DATA0095.SRCE_PTR = dbo.DATA0067.RKEY INNER JOIN
									dbo.DATA0006 WITH (NOLOCK) ON dbo.DATA0067.WO_PTR = dbo.DATA0006.RKEY INNER JOIN
									dbo.DATA0020 WITH (NOLOCK) ON dbo.DATA0095.INVT_LOC_PTR = dbo.DATA0020.RKEY INNER JOIN
									dbo.DATA0017 WITH (NOLOCK) ON dbo.DATA0020.INVENTORY_POINTER = dbo.DATA0017.RKEY INNER JOIN
									dbo.DATA0050 WITH (NOLOCK) ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
			WHERE     (dbo.DATA0095.TRAN_TP = 13 OR dbo.DATA0095.TRAN_TP = 14) AND (dbo.DATA0017.TTYPE = 'R' OR
									dbo.DATA0017.TTYPE = 'M') AND (dbo.DATA0006.WORK_ORDER_NUMBER LIKE @para1) --@para1 ) --'  -086881-01%') -- = 147320)
								AND ISNULL(dbo.DATA0020.BATCH_NO, '')<>''
								AND dbo.DATA0006.ROOT_PTR=0

			UNION ALL

			SELECT
				dbo.DATA0006.RKEY AS D6_PTR_MatKosten, 
				ISNULL((CASE 
					WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 then
						(dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE) * dbo.DATA0341.QUANTITY
					ELSE
						(dbo.DATA0017.ACTUAL_COST * dbo.DATA0341.QUANTITY) 
				END), 0) AS Materialkosten
			FROM         dbo.DATA0467 WITH (NOLOCK) INNER JOIN
									dbo.DATA0466 WITH (NOLOCK) ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									dbo.DATA0002 WITH (NOLOCK) INNER JOIN
									dbo.DATA0017 WITH (NOLOCK) ON dbo.DATA0002.RKEY = dbo.DATA0017.STOCK_UNIT_PTR INNER JOIN
									dbo.DATA0067 WITH (NOLOCK) INNER JOIN
									dbo.DATA0341 WITH (NOLOCK) ON dbo.DATA0067.RKEY = dbo.DATA0341.SRCE_PTR INNER JOIN
									dbo.DATA0006 WITH (NOLOCK) ON dbo.DATA0067.WO_PTR = dbo.DATA0006.RKEY ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR ON 
									dbo.DATA0467.RKEY = dbo.DATA0341.DATA0467_PTR
			WHERE     (dbo.DATA0341.TRAN_TP IN (4, 6)) AND (dbo.DATA0017.TTYPE = 'R' OR
									dbo.DATA0017.TTYPE = 'M') AND (dbo.DATA0006.WORK_ORDER_NUMBER LIKE @para1)
						AND ISNULL(dbo.DATA0341.REFERENCE_NUMBER, '')<>''
						AND dbo.DATA0006.ROOT_PTR=0
		) AS tblMatKosten
		--WHERE D6_PTR_MatKosten = D0006_PTR
	END

	IF @Case_ = 'MaterialkostenIL'
	BEGIN
		SELECT TOP 1
			ISNULL(SUM(Materialkosten), 0) AS RES
		FROM
		(
			SELECT
				dbo.DATA0006.RKEY AS D6_PTR_MatKosten,
				ISNULL((
					SELECT TOP 1
						CASE
							WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN 
								(dbo.DATA0108.PRICE/dbo.DATA0107.EX_RATE)*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
							ELSE
								CASE
									WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN 
										(dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE)*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
									ELSE
										dbo.DATA0017.ACTUAL_COST*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
								END
						END
					FROM         dbo.DATA0107 WITH (NOLOCK) INNER JOIN
											dbo.DATA0108 WITH (NOLOCK) ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
											dbo.DATA0070 WITH (NOLOCK) INNER JOIN
											dbo.DATA0071 WITH (NOLOCK) ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
					WHERE     (dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR) 
				), (dbo.DATA0017.ACTUAL_COST*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH))) AS Materialkosten 
			FROM         dbo.DATA0095 WITH (NOLOCK) INNER JOIN
									dbo.DATA0067 WITH (NOLOCK) ON dbo.DATA0095.SRCE_PTR = dbo.DATA0067.RKEY INNER JOIN
									dbo.DATA0006 WITH (NOLOCK) ON dbo.DATA0067.WO_PTR = dbo.DATA0006.RKEY INNER JOIN
									dbo.DATA0020 WITH (NOLOCK) ON dbo.DATA0095.INVT_LOC_PTR = dbo.DATA0020.RKEY INNER JOIN
									dbo.DATA0017 WITH (NOLOCK) ON dbo.DATA0020.INVENTORY_POINTER = dbo.DATA0017.RKEY INNER JOIN
									dbo.DATA0050 WITH (NOLOCK) ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
			WHERE     (dbo.DATA0095.TRAN_TP = 13 OR dbo.DATA0095.TRAN_TP = 14) AND (dbo.DATA0017.TTYPE = 'R' OR
									dbo.DATA0017.TTYPE = 'M') AND (dbo.DATA0006.WORK_ORDER_NUMBER LIKE @para1) --@para1 ) --'  -086881-01%') -- = 147320)
								AND ISNULL(dbo.DATA0020.BATCH_NO, '')<>''
								AND dbo.DATA0006.ROOT_PTR>0

			UNION ALL

			SELECT
				dbo.DATA0006.RKEY AS D6_PTR_MatKosten, 
				ISNULL((CASE 
					WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 then
						(dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE) * dbo.DATA0341.QUANTITY
					ELSE
						(dbo.DATA0017.ACTUAL_COST * dbo.DATA0341.QUANTITY) 
				END), 0) AS Materialkosten
			FROM         dbo.DATA0467 WITH (NOLOCK) INNER JOIN
									dbo.DATA0466 WITH (NOLOCK) ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
									dbo.DATA0002 WITH (NOLOCK) INNER JOIN
									dbo.DATA0017 WITH (NOLOCK) ON dbo.DATA0002.RKEY = dbo.DATA0017.STOCK_UNIT_PTR INNER JOIN
									dbo.DATA0067 WITH (NOLOCK) INNER JOIN
									dbo.DATA0341 WITH (NOLOCK) ON dbo.DATA0067.RKEY = dbo.DATA0341.SRCE_PTR INNER JOIN
									dbo.DATA0006 WITH (NOLOCK) ON dbo.DATA0067.WO_PTR = dbo.DATA0006.RKEY ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR ON 
									dbo.DATA0467.RKEY = dbo.DATA0341.DATA0467_PTR
			WHERE     (dbo.DATA0341.TRAN_TP IN (4, 6)) AND (dbo.DATA0017.TTYPE = 'R' OR
									dbo.DATA0017.TTYPE = 'M') AND (dbo.DATA0006.WORK_ORDER_NUMBER LIKE @para1)
						AND ISNULL(dbo.DATA0341.REFERENCE_NUMBER, '')<>''
						AND dbo.DATA0006.ROOT_PTR>0
		) AS tblMatKosten
		--WHERE D6_PTR_MatKosten = D0006_PTR
	END

	IF @Case_ = 'FA_AblaufMatKosten'
	BEGIN
		--DECLARE
		--@para1 varchar(16)
		--SET @para1='M1-099066-01%'

		SELECT
			CUSTOMER_PART_NUMBER,
			CP_REV,
			ZUX,
			ZUY,
			ELP_KN,
			ELP_ZU,
			LPD,
			CHSN,
			ELPX,
			ELPY,
			(SELECT TOP 1 CHAuFl FROM dbo.ARTIKELDATEN WITH (NOLOCK) WHERE CUST_PART_PTR=D0050_PTR) AS CHAuFl,
			--D0050_PTR,
			--D0006_PTR,
			WORK_ORDER_NUMBER, 
			ROOT_PTR,
			Start, 
			Stop, 
			--CASE WHEN DATEDIFF(n , Start , Stop )=0 THEN 1 ELSE DATEDIFF(n , Start , Stop ) END AS Anz_Minuten,
			Anz_Minuten,
			Anz_Sekunden,
			TDATE_D48, 
			TTIME_D48,
			DEPT_CODE,
			D34_PTR, 
			CASE 
				WHEN ISNULL(AGName, '')<>'' THEN AGName ELSE DEPT_NAME
			END AS AGName, 
			Anz_ZU,
			ZU_m2,
			Ofl_m2,
			Akt_Cu_Fl,
			Ritzweg,
			Verstiften,
			ZusatzInfos,
			MatVerbrauch,
			ISNULL(MatKostensatz, 0) AS MatKostensatz,
			ISNULL(MatBzgGroesse, '') AS MatBzgGroesse,
			ISNULL(PersKostensatz, 0) AS PersKostensatz,
			ISNULL(PersBzgGroesse, '') AS PersBzgGroesse,
			ISNULL(EKostensatz, 0) AS EKostensatz,
			ISNULL(EBzgGroesse, '') AS EBzgGroesse,
			ISNULL(AbschKostensatz, 0) AS AbschKostensatz,
			ISNULL(AbschBzgGroesse, '') AS AbschBzgGroesse,
			ISNULL(WartRepKostensatz, 0) AS WartRepKostensatz,
			ISNULL(WartRepBzgGroesse, '') AS WartRepBzgGroesse,
			ISNULL(SonstKostensatz, 0) AS SonstKostensatz,
			ISNULL(SonstBzgGroesse, '') AS SonstBzgGroesse,
			ISNULL((
				CASE
					WHEN AGName Like '%Zuschnitt%' OR AGName='ML Pressen' OR AGName='Zwischenlagerung Masslam' OR AGName='QS WE Handel' OR AGName='Prüfen Handel' THEN
						CASE
							WHEN AGName='ML Pressen' THEN
								((2 * Anz_ZU * Trennfolie_LetzterPreis) + (4 * CEILING(CAST(Anz_ZU AS FLOAT) / CAST(Zuschnitte_je_Pressstapel AS FLOAT)) * Trennfolie_LetzterPreis) +   (2 * CEILING(CAST(Anz_ZU AS FLOAT) / CAST(Zuschnitte_je_Pressstapel AS FLOAT)) * Presspolster_LetzterPreis))
								+
								(ZU_m2*ISNULL((SELECT TOP 1 MatKostensatz AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WHERE Schluessel = 'ML Presse indirekte Materialkosten'), 0))
							ELSE
								0
						END
					ELSE
						CASE 
							WHEN MatBzgGroesse='ZU_m2' THEN ZU_m2*MatKostensatz ELSE
								CASE WHEN MatBzgGroesse='ZU' THEN Anz_ZU*MatKostensatz ELSE
									CASE WHEN MatBzgGroesse='Zeit' THEN Anz_Minuten*MatKostensatz/60 ELSE
										CASE WHEN MatBzgGroesse='Ofl_m2' THEN Ofl_m2*MatKostensatz ELSE
											CASE WHEN MatBzgGroesse='Ritz_m' THEN Ritzweg*MatKostensatz ELSE
												0 --ZU_m2*MatKostensatz
											END
										END
									END
								END
						END
				END
			), 0) AS Materialkosten,
			/*
			ISNULL((
				CASE
					WHEN AGName Like '%Zuschnitt%' OR AGName='ML Pressen' OR AGName='Zwischenlagerung Masslam' OR AGName='QS WE Handel' OR AGName='Prüfen Handel' THEN
					(
						SELECT TOP 1
							SUM(Materialkosten) AS RES
						FROM
						(
							SELECT
								dbo.DATA0006.RKEY AS D6_PTR_MatKosten,
								ISNULL((
									SELECT TOP 1
										CASE
											WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN 
												(dbo.DATA0108.PRICE/dbo.DATA0107.EX_RATE)*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
											ELSE
												CASE
													WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN 
														(dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE)*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
													ELSE
														dbo.DATA0017.ACTUAL_COST*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
												END
										END
									FROM         dbo.DATA0107 INNER JOIN
														  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
														  dbo.DATA0070 INNER JOIN
														  dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
									WHERE     (dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR) 
								), (dbo.DATA0017.ACTUAL_COST*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH))) AS Materialkosten 
							FROM         dbo.DATA0095 INNER JOIN
												  dbo.DATA0067 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0067.RKEY INNER JOIN
												  dbo.DATA0006 ON dbo.DATA0067.WO_PTR = dbo.DATA0006.RKEY INNER JOIN
												  dbo.DATA0020 ON dbo.DATA0095.INVT_LOC_PTR = dbo.DATA0020.RKEY INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0020.INVENTORY_POINTER = dbo.DATA0017.RKEY INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
							WHERE     (dbo.DATA0095.TRAN_TP = 13 OR dbo.DATA0095.TRAN_TP = 14) AND (dbo.DATA0017.TTYPE = 'R' OR
												  dbo.DATA0017.TTYPE = 'M') --AND (dbo.DATA0006.RKEY = D0006_PTR) --@para1 ) --'  -086881-01%') -- = 147320)
												AND ISNULL(dbo.DATA0020.BATCH_NO, '')<>''

							UNION ALL

							SELECT
								dbo.DATA0006.RKEY AS D6_PTR_MatKosten, 
								ISNULL((CASE 
									WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 then
										(dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE) * dbo.DATA0341.QUANTITY
									ELSE
										(dbo.DATA0017.ACTUAL_COST * dbo.DATA0341.QUANTITY) 
								END), 0) AS Materialkosten
							FROM         dbo.DATA0467 INNER JOIN
												  dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												  dbo.DATA0002 INNER JOIN
												  dbo.DATA0017 ON dbo.DATA0002.RKEY = dbo.DATA0017.STOCK_UNIT_PTR INNER JOIN
												  dbo.DATA0067 INNER JOIN
												  dbo.DATA0341 ON dbo.DATA0067.RKEY = dbo.DATA0341.SRCE_PTR INNER JOIN
												  dbo.DATA0006 ON dbo.DATA0067.WO_PTR = dbo.DATA0006.RKEY ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR ON 
												  dbo.DATA0467.RKEY = dbo.DATA0341.DATA0467_PTR
							WHERE     (dbo.DATA0341.TRAN_TP IN (4, 6)) AND (dbo.DATA0017.TTYPE = 'R' OR
												  dbo.DATA0017.TTYPE = 'M') --AND (dbo.DATA0006.RKEY = D0006_PTR)
										AND ISNULL(dbo.DATA0341.REFERENCE_NUMBER, '')<>''
						) AS tblMatKosten
						WHERE D6_PTR_MatKosten = D0006_PTR
					)
					ELSE
						0
				END
			) * CASE WHEN ZU_m2=0 THEN 0 ELSE 1 END, 0) 
			*/
			0 AS PP_CU_BM_Kosten,
			ISNULL(( 
				CASE WHEN EBzgGroesse='ZU_m2' THEN ZU_m2*EKostensatz ELSE
					CASE WHEN EBzgGroesse='ZU' THEN Anz_ZU*EKostensatz ELSE
						CASE WHEN EBzgGroesse='Zeit' THEN Anz_Minuten*EKostensatz/60 ELSE
							CASE WHEN EBzgGroesse='Ofl_m2' THEN Ofl_m2*EKostensatz ELSE
								CASE WHEN EBzgGroesse='Ritz_m' THEN Ritzweg*EKostensatz ELSE
									ZU_m2*EKostensatz
								END
							END
						END
					END
				END
			), 0) AS Energiekosten,
			ISNULL((
				CASE WHEN PersBzgGroesse='ZU_m2' THEN ZU_m2*PersKostensatz ELSE
					CASE WHEN PersBzgGroesse='ZU' THEN Anz_ZU*PersKostensatz ELSE
						CASE WHEN PersBzgGroesse='Zeit' THEN Anz_Minuten*PersKostensatz/60 ELSE
							CASE WHEN PersBzgGroesse='Ofl_m2' THEN Ofl_m2*PersKostensatz ELSE
								CASE WHEN PersBzgGroesse='Ritz_m' THEN Ritzweg*PersKostensatz ELSE
									ZU_m2*PersKostensatz
								END
							END
						END
					END
				END
			), 0) AS Personalkosten,
			ISNULL((
				CASE WHEN AbschBzgGroesse='ZU_m2' THEN ZU_m2*AbschKostensatz ELSE
					CASE WHEN AbschBzgGroesse='ZU' THEN Anz_ZU*AbschKostensatz ELSE
						CASE WHEN AbschBzgGroesse='Zeit' THEN Anz_Minuten*AbschKostensatz/60 ELSE
							CASE WHEN AbschBzgGroesse='Ofl_m2' THEN Ofl_m2*AbschKostensatz ELSE
								CASE WHEN AbschBzgGroesse='Ritz_m' THEN Ritzweg*AbschKostensatz ELSE
									ZU_m2*AbschKostensatz
								END
							END
						END
					END
				END
			), 0) AS Abschreibungskosten,
			ISNULL((
				CASE WHEN WartRepBzgGroesse='ZU_m2' THEN ZU_m2*WartRepKostensatz ELSE
					CASE WHEN WartRepBzgGroesse='ZU' THEN Anz_ZU*WartRepKostensatz ELSE
						CASE WHEN WartRepBzgGroesse='Zeit' THEN Anz_Minuten*WartRepKostensatz/60 ELSE
							CASE WHEN WartRepBzgGroesse='Ofl_m2' THEN Ofl_m2*WartRepKostensatz ELSE
								CASE WHEN WartRepBzgGroesse='Ritz_m' THEN Ritzweg*WartRepKostensatz ELSE
									ZU_m2*WartRepKostensatz
								END
							END
						END
					END
				END
			), 0) AS Wartungskosten,
			ISNULL((
				CASE WHEN SonstBzgGroesse='ZU_m2' THEN ZU_m2*SonstKostensatz ELSE
					CASE WHEN SonstBzgGroesse='ZU' THEN Anz_ZU*SonstKostensatz ELSE
						CASE WHEN SonstBzgGroesse='Zeit' THEN Anz_Minuten*SonstKostensatz/60 ELSE
							CASE WHEN SonstBzgGroesse='Ofl_m2' THEN Ofl_m2*SonstKostensatz ELSE
								CASE WHEN SonstBzgGroesse='Ritz_m' THEN Ritzweg*SonstKostensatz ELSE
									ZU_m2*SonstKostensatz
								END
							END
						END
					END
				END
			), 0) AS Sonstigekosten,
			Presspolster_LetzterPreis,
			Trennfolie_LetzterPreis,
			Pressstapel_je_Zyklus,
			Zuschnitte_je_Pressstapel,
			CASE
				WHEN Zuschnitte_je_Pressstapel > 0 THEN
					CEILING(Anz_ZU /Zuschnitte_je_Pressstapel) 
				ELSE
					0
			END AS Anzahl_Stapel,
			Fremdleistungskosten,
			PARAMETER_3,
			MinBohrDM,
			CASE WHEN Is_FL_SF>0 THEN 'J' ELSE 'N' END AS FL_SF,
			(SELECT TOP 1 MatKostensatz AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK) WHERE Schluessel = 'Bohrunterlage') AS BohrUnterlagen_12D_REPreis_pro_QM,
			(SELECT TOP 1 MatKostensatz AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK) WHERE Schluessel = 'Bohrauflage') AS BohrAuflagen_12D_REPreis_pro_QM,
			CuD_End,
			CuD_B,
			HAL,
			HAL_BF,
			AbmeldeZeitMenge,
			ELP_aufgelegt, 
			ELP_ausschuss,
			LB,
			PC,
			Kunde,
			KNX,
			KNY,
			D6_PTR,
			D50_PTR,
			D10_PTR,
			FAkompletiertAm,
			ISNULL((SELECT TOP 1 QTY_ALLOC FROM dbo.DATA0053 WITH (NOLOCK) WHERE dbo.DATA0053.WORK_ORDER_PTR = D6_PTR), 0) AS FAreserviert,
			MA,
			ArtCode,
			LE

		FROM
		(
			SELECT    
				dbo.DATA0050.CUSTOMER_PART_NUMBER,
				dbo.DATA0050.CP_REV,
				dbo.DATA0050.RKEY AS D0050_PTR,
				dbo_DATA0006.RKEY AS D0006_PTR,
				dbo_DATA0006.ROOT_PTR,
				dbo.DATA0034.RKEY AS D34_PTR,
				dbo_DATA0006.WORK_ORDER_NUMBER, 
				dbo.UF_ToDateTime(dbo.DATA0059.START_TIME, dbo.DATA0059.START_DATE) AS Start, 
				dbo.UF_ToDateTime(dbo.DATA0059.STOP_TIME, dbo.DATA0059.STOP_DATE) AS Stop, 
				CASE 
					WHEN DATEDIFF(n , dbo.UF_ToDateTime(dbo.DATA0059.START_TIME, dbo.DATA0059.START_DATE) , dbo.UF_ToDateTime(dbo.DATA0059.STOP_TIME, dbo.DATA0059.STOP_DATE))=0 THEN 
						1 
					ELSE 
						DATEDIFF(n , dbo.UF_ToDateTime(dbo.DATA0059.START_TIME, dbo.DATA0059.START_DATE) , dbo.UF_ToDateTime(dbo.DATA0059.STOP_TIME, dbo.DATA0059.STOP_DATE) )
				END AS Anz_Minuten,
				DATEDIFF(s , dbo.UF_ToDateTime(dbo.DATA0059.START_TIME, dbo.DATA0059.START_DATE) , dbo.UF_ToDateTime(dbo.DATA0059.STOP_TIME, dbo.DATA0059.STOP_DATE) ) AS Anz_Sekunden,
				dbo.DATA0048.TDATE AS TDATE_D48, 
				dbo.DATA0048.TTIME AS TTIME_D48,
				dbo.DATA0034.DEPT_CODE, 
				dbo.DATA0034.DEPT_NAME, 
				dbo.ARTIKELDATEN.ZuX,
				dbo.ARTIKELDATEN.ZuY,
				dbo.ARTIKELDATEN.ELP_KN,
				dbo.ARTIKELDATEN.ELP_ZU,
				dbo.ARTIKELDATEN.Verstiften,
				LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1)) AS AGName, 
				CAST(CAST(dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT AS FLOAT) / dbo.ARTIKELDATEN.ELP_Zu + 0.9999 AS INT) AS Anz_ZU,
				dbo.ARTIKELDATEN.ZuX * dbo.ARTIKELDATEN.ZuY * CAST(CAST(dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT AS FLOAT) 
									  / dbo.ARTIKELDATEN.ELP_Zu + 0.9999 AS INT) / 1000000 AS ZU_m2, 
				(dbo.ARTIKELDATEN.ZuX * dbo.ARTIKELDATEN.ZuY * CAST(CAST(dbo.DATA0048.QTY_PROD + dbo.DATA0048.QTY_REJECT AS FLOAT) 
									  / dbo.ARTIKELDATEN.ELP_Zu + 0.9999 AS INT) / 1000000)*CASE WHEN dbo.ARTIKELDATEN.LE>1 THEN 2 ELSE 2 END AS Ofl_m2, 
				dbo.DATA0056.STEP,
				(dbo.ARTIKELDATEN.ZuX * dbo.ARTIKELDATEN.ZuY / 1000000) AS ZuX_x_ZuY,
				dbo.DATA0038.PARAMETER_2 As ZusatzInfos,
				--Verbrauch
				(SELECT TOP 1 ISNULL(Verbrauch/1000, 0) AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK)
					WHERE Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = SUBSTRING(dbo.DATA0038.PARAMETER_2, 3, 7) 
						AND D34_PTR=0 AND ISNULL(Schluessel, '')<>''
					ORDER BY ISNULL(MatKostensatz, 0) DESC) AS MatVerbrauch,
				--Materialkosten 
				(SELECT TOP 1 ISNULL(MatBzgGroesse, '') AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK)
					WHERE (D34_PTR=dbo.DATA0034.RKEY AND ISNULL(Schluessel, '')='') 
						OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0038.PARAMETER_2 AND D34_PTR=0 AND ISNULL(Schluessel, '')<>'')
						OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1)) 
						AND D34_PTR=0 AND (dbo.DATA0038.PARAMETER_2='' OR dbo.DATA0038.PARAMETER_2='.') AND ISNULL(Schluessel, '')<>'') ORDER BY ISNULL(MatKostensatz, 0) DESC) AS MatBzgGroesse,
				(SELECT TOP 1 ISNULL(MatKostensatz, 0) AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK)
					WHERE (D34_PTR=dbo.DATA0034.RKEY AND ISNULL(Schluessel, '')='')
					OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0038.PARAMETER_2 AND D34_PTR=0 AND ISNULL(Schluessel, '')<>'')
					OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1)) AND D34_PTR=0 
						AND (dbo.DATA0038.PARAMETER_2='' OR dbo.DATA0038.PARAMETER_2='.') AND ISNULL(Schluessel, '')<>'') ORDER BY ISNULL(MatKostensatz, 0) DESC) AS MatKostensatz,
				--Energiekosten
				(SELECT TOP 1 ISNULL(EBzgGroesse, '') AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK)
					WHERE (D34_PTR=dbo.DATA0034.RKEY AND ISNULL(Schluessel, '')='') 
						OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0038.PARAMETER_2 AND D34_PTR=0 AND ISNULL(Schluessel, '')<>'')
						OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1)) 
							AND D34_PTR=0 AND (dbo.DATA0038.PARAMETER_2='' OR dbo.DATA0038.PARAMETER_2='.') AND ISNULL(Schluessel, '')<>'') ORDER BY ISNULL(EKostensatz, 0) DESC) AS EBzgGroesse,
				(SELECT TOP 1 ISNULL(EKostensatz, 0) AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK)
					WHERE (D34_PTR=dbo.DATA0034.RKEY AND ISNULL(Schluessel, '')='')
					OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0038.PARAMETER_2 AND D34_PTR=0 AND ISNULL(Schluessel, '')<>'')
					OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1)) AND D34_PTR=0 
						AND (dbo.DATA0038.PARAMETER_2='' OR dbo.DATA0038.PARAMETER_2='.') AND ISNULL(Schluessel, '')<>'') ORDER BY ISNULL(EKostensatz, 0) DESC) AS EKostensatz,
				--Personalkosten
				(CASE
					WHEN (SELECT TOP 1 COUNT(Kostenstelle) AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK) WHERE ISNULL(Kostenstelle, '')<>'' AND RTRIM(ISNULL(Kostenstelle, '')) COLLATE SQL_Latin1_General_CP1_CI_AS  = RTRIM(ISNULL(dbo.DATA0034.ANALYSIS_CODE_2, '')))>0 THEN
						(SELECT TOP 1 ISNULL(PersBzgGroesse, '') AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK) WHERE RTRIM(Kostenstelle) COLLATE SQL_Latin1_General_CP1_CI_AS  = RTRIM(dbo.DATA0034.ANALYSIS_CODE_2))
					ELSE
						(SELECT TOP 1 ISNULL(PersBzgGroesse, '') AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK)
							WHERE (D34_PTR=dbo.DATA0034.RKEY AND ISNULL(Schluessel, '')='') 
								OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0038.PARAMETER_2 AND D34_PTR=0 AND ISNULL(Schluessel, '')<>'')
								OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1)) 
									AND D34_PTR=0 AND (dbo.DATA0038.PARAMETER_2='' OR dbo.DATA0038.PARAMETER_2='.') AND ISNULL(Schluessel, '')<>'') ORDER BY ISNULL(PersKostensatz, 0) DESC)
				END) AS PersBzgGroesse,
				(CASE
					WHEN (SELECT TOP 1 COUNT(Kostenstelle) AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK) WHERE ISNULL(Kostenstelle, '')<>'' AND RTRIM(ISNULL(Kostenstelle, '')) COLLATE SQL_Latin1_General_CP1_CI_AS  = RTRIM(ISNULL(dbo.DATA0034.ANALYSIS_CODE_2, '')))>0 THEN
						(SELECT TOP 1 ISNULL(PersKostensatz, '') AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK) WHERE RTRIM(Kostenstelle) COLLATE SQL_Latin1_General_CP1_CI_AS  = RTRIM(dbo.DATA0034.ANALYSIS_CODE_2))
					ELSE
						0
				END) AS PersKostensatz,
				(SELECT TOP 1 ISNULL(AbschBzgGroesse, '') AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK)
					WHERE (D34_PTR=dbo.DATA0034.RKEY AND ISNULL(Schluessel, '')='') 
						OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0038.PARAMETER_2 AND D34_PTR=0 AND ISNULL(Schluessel, '')<>'')
						OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1)) 
							AND D34_PTR=0 AND (dbo.DATA0038.PARAMETER_2='' OR dbo.DATA0038.PARAMETER_2='.') AND ISNULL(Schluessel, '')<>'') ORDER BY ISNULL(AbschKostensatz, 0) DESC) AS AbschBzgGroesse,
				--(SELECT TOP 1 ISNULL(AbschKostensatz, 0) AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WHERE D34_PTR=dbo.DATA0034.RKEY OR 
				--	Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0038.PARAMETER_2) AS AbschKostensatz,
				(SELECT TOP 1 ISNULL(AbschKostensatz, 0) AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK)
					WHERE (D34_PTR=dbo.DATA0034.RKEY AND ISNULL(Schluessel, '')='')
					OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0038.PARAMETER_2 AND D34_PTR=0 AND ISNULL(Schluessel, '')<>'')
					OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1)) AND D34_PTR=0 
						AND (dbo.DATA0038.PARAMETER_2='' OR dbo.DATA0038.PARAMETER_2='.') AND ISNULL(Schluessel, '')<>'') ORDER BY ISNULL(AbschKostensatz, 0) DESC) AS AbschKostensatz,
				--Wartungskosten
				(SELECT TOP 1 ISNULL(WartRepBzgGroesse, '') AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK)
					WHERE (D34_PTR=dbo.DATA0034.RKEY AND ISNULL(Schluessel, '')='') 
						OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0038.PARAMETER_2 AND D34_PTR=0 AND ISNULL(Schluessel, '')<>'')
						OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1)) 
							AND D34_PTR=0 AND (dbo.DATA0038.PARAMETER_2='' OR dbo.DATA0038.PARAMETER_2='.') AND ISNULL(Schluessel, '')<>'') ORDER BY ISNULL(AbschKostensatz, 0) DESC) AS WartRepBzgGroesse,
				(SELECT TOP 1 ISNULL(WartRepKostensatz, 0) AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK)
					WHERE (D34_PTR=dbo.DATA0034.RKEY AND ISNULL(Schluessel, '')='')
					OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0038.PARAMETER_2 AND D34_PTR=0 AND ISNULL(Schluessel, '')<>'')
					OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1)) AND D34_PTR=0 
						AND (dbo.DATA0038.PARAMETER_2='' OR dbo.DATA0038.PARAMETER_2='.') AND ISNULL(Schluessel, '')<>'') ORDER BY ISNULL(AbschKostensatz, 0) DESC) AS WartRepKostensatz,
				--Sonstigekosten
				(SELECT TOP 1 ISNULL(SonstBzgGroesse, '') AS RES FROM LIVE2.dbo.NachKalk_Kostensatz 
					WHERE (D34_PTR=dbo.DATA0034.RKEY AND ISNULL(Schluessel, '')='') 
						OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0038.PARAMETER_2 AND D34_PTR=0 AND ISNULL(Schluessel, '')<>'')
						OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1)) 
							AND D34_PTR=0 AND (dbo.DATA0038.PARAMETER_2='' OR dbo.DATA0038.PARAMETER_2='.') AND ISNULL(Schluessel, '')<>'') ORDER BY ISNULL(AbschKostensatz, 0) DESC) AS SonstBzgGroesse,
				(SELECT TOP 1 ISNULL(SonstKostensatz, 0) AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK)
					WHERE (D34_PTR=dbo.DATA0034.RKEY AND ISNULL(Schluessel, '')='')
					OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = dbo.DATA0038.PARAMETER_2 AND D34_PTR=0 AND ISNULL(Schluessel, '')<>'')
					OR (Schluessel COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1)) AND D34_PTR=0 
						AND (dbo.DATA0038.PARAMETER_2='' OR dbo.DATA0038.PARAMETER_2='.') AND ISNULL(Schluessel, '')<>'') ORDER BY ISNULL(AbschKostensatz, 0) DESC) AS SonstKostensatz,
				dbo.ARTIKELDATEN.Ritzweg,
				dbo.ARTIKELDATEN.LPD,
				dbo.ARTIKELDATEN.CHSN,
				dbo.ARTIKELDATEN.ELPX,
				dbo.ARTIKELDATEN.ELPY,
				(
					CASE
						WHEN LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1))='ML Pressen' THEN
							(
								--0,1725  => Presspappen 500 x 345 => RKEY 289
								--0,25875 => Presspappen 575 x 450 => RKEY 35
								--0,325   => Presspappen 650 x 500 => RKEY 1525
								CASE
									WHEN (dbo.ARTIKELDATEN.ZuX * dbo.ARTIKELDATEN.ZuY / 1000000) <= 0.1725 THEN
										ISNULL((
										SELECT TOP 1 MatKostensatz AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK) WHERE Schluessel = 'Presspappen 500 x 345'
										), 0)
									ELSE
									CASE 
										WHEN (dbo.ARTIKELDATEN.ZuX * dbo.ARTIKELDATEN.ZuY / 1000000) <= 0.25875 THEN
											ISNULL((
												SELECT TOP 1 MatKostensatz AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK) WHERE Schluessel = 'Presspappen 575 x 450'
											), 0)
										ELSE
										CASE 
											WHEN (dbo.ARTIKELDATEN.ZuX * dbo.ARTIKELDATEN.ZuY / 1000000) <= 0.325 THEN
												ISNULL((
													SELECT TOP 1 MatKostensatz AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK) WHERE Schluessel = 'Presspappen 650 x 500'
												), 0)
											ELSE
												ISNULL((SELECT TOP 1 MatKostensatz AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK) WHERE Schluessel = 'Presspappen grösser 650 x 500'), 0)
										END
									END
								END
							)
						ELSE
							0
					END
				) AS Presspolster_LetzterPreis,
				(
					CASE
						WHEN LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1))='ML Pressen' THEN
							(
								--0,1725  => Presspappen 500 x 345 => RKEY 289
								--0,25875 => Presspappen 575 x 450 => RKEY 35
								--0,325   => Presspappen 650 x 500 => RKEY 1525
								CASE
									WHEN (dbo.ARTIKELDATEN.ZuX * dbo.ARTIKELDATEN.ZuY / 1000000) <= 0.1725 THEN
										ISNULL((SELECT TOP 1 MatKostensatz AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK) WHERE Schluessel = 'Trennfolie 500 x 345'), 0)
									ELSE
										CASE 
											WHEN (dbo.ARTIKELDATEN.ZuX * dbo.ARTIKELDATEN.ZuY / 1000000) <= 0.25875 THEN
												ISNULL((SELECT TOP 1 MatKostensatz AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK) WHERE Schluessel = 'Trennfolie 575 x 450'), 0)
											ELSE
												CASE 
													WHEN (dbo.ARTIKELDATEN.ZuX * dbo.ARTIKELDATEN.ZuY / 1000000) <= 0.325 THEN
														ISNULL((SELECT TOP 1 MatKostensatz AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK) WHERE Schluessel = 'Trennfolie 650 x 500'), 0)
													ELSE
														ISNULL((SELECT TOP 1 MatKostensatz AS RES FROM LIVE2.dbo.NachKalk_Kostensatz WITH (NOLOCK) WHERE Schluessel = 'Trennfolie grösser 650 x 500'), 0)
												END
										END
								END
							)
						ELSE
							0
					END
				) AS Trennfolie_LetzterPreis,
				(
					CASE
						WHEN LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1))='ML Pressen' THEN
							(
								--0,1725  => Presspappen 500 x 345 => RKEY 289
								--0,25875 => Presspappen 575 x 450 => RKEY 35
								--0,325   => Presspappen 650 x 500 => RKEY 1525
								CASE
									WHEN (dbo.ARTIKELDATEN.ZuX * dbo.ARTIKELDATEN.ZuY / 1000000) <= 0.1725 THEN
										4
									ELSE
										2
								END
							)
						ELSE
							0
					END
				) AS Pressstapel_je_Zyklus,
				(
					CASE
						WHEN LTRIM(RTRIM(dbo.DATA0038.PARAMETER_1))='ML Pressen' THEN
							(
								CASE
									WHEN dbo.ARTIKELDATEN.LPD < 1.6 THEN
										5
									ELSE
										CASE 
											WHEN dbo.ARTIKELDATEN.LPD >= 1.6 AND dbo.ARTIKELDATEN.LPD <= 2.2 THEN
												4
											ELSE
												CASE 
													WHEN dbo.ARTIKELDATEN.LPD > 2.2 AND dbo.ARTIKELDATEN.LPD < 3.3 THEN
														3
													ELSE
														CASE 
															WHEN dbo.ARTIKELDATEN.LPD >= 3.3 AND dbo.ARTIKELDATEN.LPD <= 4.5 THEN
																2
															ELSE
																1
														END
												END
										END
								END
							)
						ELSE
							0
					END
				) AS Zuschnitte_je_Pressstapel,
				CASE WHEN ISNULL(dbo.ARTIKELDATEN.GalvAU, '')<>'Ohne' AND ISNULL(dbo.ARTIKELDATEN.GalvAU, '')<>'false' THEN 'J' ELSE 'N' END AS GalvAU,
				dbo.DATA0038.PARAMETER_3,
				/*
				CASE
					WHEN SUBSTRING(LTRIM(RTRIM(dbo.DATA0038.PARAMETER_3)), 1, 3)='FL;' THEN
						CASE
							WHEN (SELECT TOP 1 COUNT(*) AS Anzahl FROM dbo.abfr_Best_ExtDL WHERE FA LIKE LTRIM(@para1))=0 THEN --CASE WHEN dbo_DATA0006.ROOT_PTR<>0 THEN REPLACE(LTRIM(dbo_DATA0006.WORK_ORDER_NUMBER), 'M', 'B') ELSE LTRIM(dbo_DATA0006.WORK_ORDER_NUMBER) END)=0 THEN
								1000000
							ELSE
								CASE
									WHEN (SELECT TOP 1 COUNT(*) AS Anzahl FROM dbo.abfr_Best_ExtDL WHERE FA LIKE LTRIM(@para1))=0 THEN --= CASE WHEN dbo_DATA0006.ROOT_PTR<>0 THEN REPLACE(LTRIM(dbo_DATA0006.WORK_ORDER_NUMBER), 'M', 'B') ELSE LTRIM(dbo_DATA0006.WORK_ORDER_NUMBER) END)=1 THEN
										ISNULL((
											SELECT  TOP 1   
												CASE
													WHEN ISNULL(dbo.DATA0107.INVOICE_NO, '')<>'' THEN
														((dbo.DATA0109.QUANTITY * dbo.DATA0109.PRICE) + dbo.DATA0107.MISC_TOT)
													ELSE
														((dbo.DATA0072.QUAN_ORD * dbo.DATA0072.UNIT_PRICE) + dbo.DATA0070.MISC_CHARGE)
												END AS FLKosten

											FROM         dbo.DATA0107 INNER JOIN
																  dbo.DATA0109 ON dbo.DATA0107.RKEY = dbo.DATA0109.DATA0107_PTR RIGHT OUTER JOIN
																  dbo.DATA0070 INNER JOIN
																  dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR ON dbo.DATA0109.DATA0072_PTR = dbo.DATA0072.RKEY
											WHERE     (dbo.DATA0072.DESCRIPTION LIKE 'DL:%') AND (dbo.DATA0070.PO_TYPE = '1') AND (LTRIM(RTRIM(SUBSTRING(dbo.DATA0072.DESCRIPTION2, 0, CHARINDEX('/', 
																  dbo.DATA0072.DESCRIPTION2)))) LIKE LTRIM(@para1))--= CASE WHEN dbo_DATA0006.ROOT_PTR<>0 THEN REPLACE(RTRIM(LTRIM(dbo_DATA0006.WORK_ORDER_NUMBER)), 'M', 'B') ELSE RTRIM(LTRIM(dbo_DATA0006.WORK_ORDER_NUMBER)) END)
										), 0) 
									ELSE
										CASE
											WHEN (SELECT TOP 1 COUNT(*) AS Anzahl FROM dbo.abfr_Best_ExtDL WHERE FA LIKE LTRIM(@para1))=0 THEN --= CASE WHEN dbo_DATA0006.ROOT_PTR<>0 THEN REPLACE(LTRIM(dbo_DATA0006.WORK_ORDER_NUMBER), 'M', 'B') ELSE LTRIM(dbo_DATA0006.WORK_ORDER_NUMBER) END)=2 THEN
												1000000 --muss noch programmiert werden, aktuell gibt es kein Beispiel in der Datenbank!
											ELSE
												1000000
										END
								END 
						END 
					ELSE
						0
				END AS Fremdleistungskosten,
				*/
				0 AS Fremdleistungskosten,
				dbo.ARTIKELDATEN.MinBohrDM,
				(
					SELECT TOP 1 COUNT(*) AS Res FROM dbo.DATA0008 WITH (NOLOCK) INNER JOIN  dbo.DATA0050 AS D50 ON dbo.DATA0008.RKEY = dbo.DATA0050.PROD_CODE_PTR 
					WHERE LEFT(dbo.DATA0008.PROD_CODE, 2) IN ('FL', 'SF') AND (D50.RKEY = dbo.DATA0050.RKEY) 
				) AS Is_FL_SF,
				ISNULL((dbo.ARTIKELDATEN.CuFl_L + dbo.ARTIKELDATEN.CuFl_B), 0) AS Akt_Cu_Fl,
				ISNULL(dbo.ARTIKELDATEN.CuD_End, 0) AS CuD_End,
				ISNULL(dbo.ARTIKELDATEN.CuD_B, 0) AS CuD_B,
				dbo.ARTIKELDATEN.HAL,
				dbo.ARTIKELDATEN.HAL_BF,
				dbo.DATA0059.QTY_PROD AS AbmeldeZeitMenge,
				dbo_DATA0006.QUAN_SCH AS ELP_aufgelegt, 
				dbo_DATA0006.QUAN_REJ AS ELP_ausschuss,
				ISNULL((SELECT TOP 1 QTY_ON_HAND-QTY_ALLOC AS RES FROM dbo.DATA0053 WITH (NOLOCK) WHERE WORK_ORDER_PTR = dbo_DATA0006.RKEY), 0) AS LB,
				ISNULL((
					SELECT   TOP 1  dbo.DATA0008.PROD_CODE
					FROM         dbo.DATA0008 INNER JOIN
										  dbo.DATA0050 AS D50 ON dbo.DATA0008.RKEY = D50.PROD_CODE_PTR
					WHERE     (D50.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR)
				), '') AS PC,
				ISNULL((
					SELECT TOP 1 dbo.DATA0010.CUSTOMER_NAME FROM dbo.DATA0010 WITH (NOLOCK) WHERE dbo.DATA0010.RKEY = dbo.DATA0050.CUSTOMER_PTR
				), '') AS Kunde,
				dbo.ARTIKELDATEN.KNX,
				dbo.ARTIKELDATEN.KNY,
				--ISNULL((SELECT TOP 1 D6.RKEY FROM dbo.DATA0006 AS D6 WHERE D6.WORK_ORDER_NUMBER = REPLACE(@para1, '%', '') + '-000'), 0) AS D6_PTR,
				ISNULL((
						SELECT TOP 1 D6.RKEY 
						FROM dbo.DATA0006 AS D6 WITH (NOLOCK)
						WHERE D6.RKEY = CASE WHEN dbo_DATA0006.ROOT_PTR<>0 THEN dbo_DATA0006.ROOT_PTR ELSE dbo_DATA0006.RKEY END
				), 0) AS D6_PTR,
				dbo.DATA0050.RKEY AS D50_PTR,
				dbo.DATA0050.CUSTOMER_PTR AS D10_PTR,
				--ISNULL((SELECT TOP 1 D6.ACT_COMPL_DATE FROM dbo.DATA0006 AS D6 WHERE D6.WORK_ORDER_NUMBER = REPLACE(@para1, '%', '') + '-000'), 0) AS FAkompletiertAm,
				ISNULL((
						SELECT TOP 1 D6.ACT_COMPL_DATE 
						FROM dbo.DATA0006 AS D6 WITH (NOLOCK)
						WHERE D6.RKEY = CASE WHEN dbo_DATA0006.ROOT_PTR<>0 THEN dbo_DATA0006.ROOT_PTR ELSE dbo_DATA0006.RKEY END
				), 0) AS FAkompletiertAm,
				dbo.DATA0005.ABBR_NAME AS MA,
				ISNULL((
						SELECT TOP 1 ARTIKELCODE.ArtCode 
						FROM  dbo.ARTIKELCODE() AS ARTIKELCODE INNER JOIN dbo.DATA0050 ON ARTIKELCODE.CUST_PART_PTR = dbo.DATA0050.RKEY
				), '') AS ArtCode,
				dbo.ARTIKELDATEN.LE

			FROM         (
							SELECT RKEY, ROOT_PTR, QUAN_SCH, QUAN_REJ, CUST_PART_PTR, REPLACE(WORK_ORDER_NUMBER, 'B', 'M') AS WORK_ORDER_NUMBER 
							FROM dbo.DATA0006 WITH (NOLOCK)
							WHERE SUBSTRING(dbo.DATA0006.WORK_ORDER_NUMBER, 3, 10) = SUBSTRING(@para1, 3, 10)
						 ) AS dbo_DATA0006 INNER JOIN
								  dbo.DATA0048 WITH (NOLOCK) ON dbo_DATA0006.RKEY = dbo.DATA0048.WO_PTR INNER JOIN
								  dbo.DATA0050 WITH (NOLOCK) ON dbo_DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
								  dbo.DATA0059 WITH (NOLOCK) ON dbo.DATA0048.RKEY = dbo.DATA0059.TRAN_PTR INNER JOIN
								  dbo.DATA0034 WITH (NOLOCK) ON dbo.DATA0048.WORK_CENTER_PTR = dbo.DATA0034.RKEY INNER JOIN
								  dbo.DATA0056 WITH (NOLOCK) ON dbo.DATA0048.TPUT_PTR = dbo.DATA0056.RKEY INNER JOIN
								  dbo.DATA0038 WITH (NOLOCK) ON dbo.DATA0056.STEP = dbo.DATA0038.STEP_NUMBER AND dbo.DATA0056.WO_PTR = dbo.DATA0038.SOURCE_PTR INNER JOIN
								  dbo.DATA0005 WITH (NOLOCK) ON dbo.DATA0059.EMPL_PTR = dbo.DATA0005.RKEY INNER JOIN
								  dbo.ARTIKELDATEN WITH (NOLOCK) ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
			WHERE   
				(dbo.DATA0038.TTYPE = 2) 
				--AND (dbo.DATA0006.RKEY IN (204746, 204747, 204748, 204749))
				--AND dbo.DATA0006.WORK_ORDER_NUMBER LIKE '  -087832-01%' --'  -085553-01%' --'  -087177-01%' --@para1
				AND dbo_DATA0006.WORK_ORDER_NUMBER LIKE @para1 --= '  -085809-01-000'
		) AS myTbl
		--ORDER BY WORK_ORDER_NUMBER DESC, TDATE_D48, TTIME_D48
		ORDER BY WORK_ORDER_NUMBER DESC, Start, AbmeldeZeitMenge DESC
	END

	IF @Case_ = 'FA_FremdleistungskostenDetail'
	BEGIN
		SELECT     dbo.DATA0070.PO_NUMBER, dbo.DATA0070.STATUS, dbo.DATA0072.QUAN_ORD, dbo.DATA0072.UNIT_PRICE, dbo.DATA0070.MISC_CHARGE, 
							  dbo.DATA0070.PO_DATE, LTRIM(RTRIM(SUBSTRING(dbo.DATA0072.DESCRIPTION, CHARINDEX(':', dbo.DATA0072.DESCRIPTION) + 1, 100))) AS DL, 
							  LTRIM(RTRIM(SUBSTRING(dbo.DATA0072.DESCRIPTION2, 0, CHARINDEX('/', dbo.DATA0072.DESCRIPTION2)))) AS FA, 
							  LTRIM(RTRIM(SUBSTRING(dbo.DATA0072.DESCRIPTION2, CHARINDEX('/', dbo.DATA0072.DESCRIPTION2) + 1, 100))) AS Artikel, dbo.DATA0107.INVOICE_NO, 
							  dbo.DATA0109.QUANTITY, dbo.DATA0109.PRICE, dbo.DATA0107.MISC_TOT, dbo.DATA0201.AMOUNT, dbo.DATA0199.MISC_CHARGE_CATEGORY, 
							  dbo.DATA0072.DESCRIPTION
		FROM         dbo.DATA0109 WITH (NOLOCK) INNER JOIN
							  dbo.DATA0107 WITH (NOLOCK) ON dbo.DATA0109.DATA0107_PTR = dbo.DATA0107.RKEY INNER JOIN
							  dbo.DATA0072 WITH (NOLOCK) INNER JOIN
							  dbo.DATA0070 WITH (NOLOCK) ON dbo.DATA0072.POPTR = dbo.DATA0070.RKEY ON dbo.DATA0109.DATA0072_PTR = dbo.DATA0072.RKEY LEFT OUTER JOIN
							  dbo.DATA0199 WITH (NOLOCK) INNER JOIN
							  dbo.DATA0201 WITH (NOLOCK) ON dbo.DATA0199.RKEY = dbo.DATA0201.MISC_CHARGEPTR ON dbo.DATA0107.RKEY = dbo.DATA0201.INVOICE_APPTR
		WHERE     (dbo.DATA0072.DESCRIPTION LIKE 'DL:%') AND (dbo.DATA0070.STATUS <> 3) AND (LTRIM(RTRIM(SUBSTRING(dbo.DATA0072.DESCRIPTION2, 0, CHARINDEX('/', 
							  dbo.DATA0072.DESCRIPTION2)))) LIKE LTRIM(@para1)) --'-086188-01-000')
	END

	IF @Case_ = 'FA_FremdleistungskostenDetail_AG'
	BEGIN
		SELECT TOP 1
			ISNULL(SUM(FL), 0) AS RES
		FROM
		(
			SELECT DISTINCT
				dbo.DATA0072.RKEY,   
				((dbo.DATA0109.PRICE/dbo.DATA0107.EX_RATE)*dbo.DATA0109.QUANTITY)+(dbo.DATA0107.MISC_TOT/dbo.DATA0107.EX_RATE) AS FL
			FROM         dbo.DATA0109 WITH (NOLOCK) INNER JOIN
								  dbo.DATA0107 WITH (NOLOCK) ON dbo.DATA0109.DATA0107_PTR = dbo.DATA0107.RKEY INNER JOIN
								  dbo.DATA0072 WITH (NOLOCK) INNER JOIN
								  dbo.DATA0070 WITH (NOLOCK) ON dbo.DATA0072.POPTR = dbo.DATA0070.RKEY ON dbo.DATA0109.DATA0072_PTR = dbo.DATA0072.RKEY LEFT OUTER JOIN
								  dbo.DATA0199 WITH (NOLOCK) INNER JOIN
								  dbo.DATA0201 WITH (NOLOCK) ON dbo.DATA0199.RKEY = dbo.DATA0201.MISC_CHARGEPTR ON dbo.DATA0107.RKEY = dbo.DATA0201.INVOICE_APPTR
			WHERE     (dbo.DATA0072.DESCRIPTION LIKE 'DL:%') AND (dbo.DATA0070.STATUS <> 3) AND (LTRIM(RTRIM(SUBSTRING(dbo.DATA0072.DESCRIPTION2, 0, CHARINDEX('/', 
								  dbo.DATA0072.DESCRIPTION2)))) LIKE LTRIM(@para1)) --'-096495-01%') 
		) AS tblFL --'-086188-01-000')
	END

	IF @Case_ = 'Artikelpreis'
	BEGIN
		--Letzte bestellung schauen und kontrollieren, ob der Rechnungspreis vorhaneden. Falls RE-Preis nicht vorhanen, 
		--dann RE-Durchschnittspreis aus letzten 12 Monaten rechnen. Falls gar keine Rechnung vorhanden, dann den Preis 
		--aus der letzten Bestellung nehmen. Falls das auch nicht geht, dann Preis von 1000000 setzen!

		--DECLARE @para1 varchar(255)
		--SET @para1 = 'Stopplack XV-501T-4 SM Grün'

		DECLARE @D17_RKEY int
		SET @D17_RKEY = (SELECT TOP 1 dbo.DATA0017.RKEY FROM dbo.DATA0017 WHERE dbo.DATA0017.INV_PART_DESCRIPTION = @para1)
		SELECT     TOP 1  
		CASE 
			WHEN ISNULL(dbo.DATA0108.PRICE, 0) <> 0 THEN dbo.DATA0108.PRICE
			ELSE 
				CASE WHEN ISNULL((
									SELECT     SUM(dbo.DATA0108.PRICE * dbo.DATA0108.QUANTITY) / SUM(dbo.DATA0108.QUANTITY) AS DPreis
									FROM         dbo.DATA0070 INNER JOIN
														  dbo.DATA0017 INNER JOIN
														  dbo.DATA0071 ON dbo.DATA0017.RKEY = dbo.DATA0071.INVT_PTR ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR LEFT OUTER JOIN
														  dbo.DATA0107 INNER JOIN
														  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
									WHERE     (dbo.DATA0017.RKEY = @D17_RKEY) AND (dbo.DATA0070.PO_DATE > DATEADD(mm, - 12, GETDATE()))
								), 0) > 0 THEN
						(
							SELECT     SUM(dbo.DATA0108.PRICE * dbo.DATA0108.QUANTITY) / SUM(dbo.DATA0108.QUANTITY) AS DPreis
							FROM         dbo.DATA0070 INNER JOIN
												  dbo.DATA0017 INNER JOIN
												  dbo.DATA0071 ON dbo.DATA0017.RKEY = dbo.DATA0071.INVT_PTR ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR LEFT OUTER JOIN
												  dbo.DATA0107 INNER JOIN
												  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR ON dbo.DATA0071.RKEY = dbo.DATA0108.DATA0071_PTR
							WHERE     (dbo.DATA0017.RKEY = @D17_RKEY) AND (dbo.DATA0070.PO_DATE > DATEADD(mm, - 12, GETDATE()))
						)
					ELSE
						CASE WHEN ISNULL(dbo.DATA0071.PRICE, 0) <> 0 THEN dbo.DATA0071.PRICE
							ELSE 1000000
						END
				END
		END AS Preis
		FROM         dbo.DATA0107 INNER JOIN
							  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
							  dbo.DATA0017 INNER JOIN
							  dbo.DATA0071 ON dbo.DATA0017.RKEY = dbo.DATA0071.INVT_PTR INNER JOIN
							  dbo.DATA0070 ON dbo.DATA0071.PO_PTR = dbo.DATA0070.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
		WHERE     (dbo.DATA0017.RKEY = @D17_RKEY)
		ORDER BY dbo.DATA0070.PO_DATE DESC
	END

	IF @Case_ = 'NachKalk_Berichte_LP_Daten'
	BEGIN
		/*
		DECLARE
		@para1 varchar(255),
		@para2 varchar(255),
		@para3 varchar(255),
		@para4 varchar(255),
		@para5 varchar(255)
		SET @para1 = 'TEST 50430'
		SET @para2 = '326, 120'
		SET @para3 = '39137, 40791, 36668'
		SET @para4 = '81'
		SET @para5 = '''Masslam'', ''Intern'''
		*/
		DECLARE
		@SQLAbfrageLP1Daten as varchar(MAX)

		SET @SQLAbfrageLP1Daten = 
		'
			SELECT
				Aufbereitung,
				Kunde,
				AnzKommissionen,
				Kommission,
				FA,
				LP,
				PC,
				CAST(FA_Umsatz AS FLOAT) AS FA_Umsatz_von_gesendELPs,
				CAST(GutschriftProFAinEUR AS FLOAT) AS GutschriftProFAinEUR,
				--CAST(RetourniertProFAinEUR AS FLOAT) AS RetourniertProFAinEUR,
				CAST(ISNULL(ELP_gesend_gewDP, 0) AS FLOAT) AS gewDPreis_von_gesendELPs,
				CAST(FA_reserviert AS INT) AS ELP_reserviert,
				CAST(ISNULL(ELP_gesend_gewDP, 0) * ISNULL(FA_reserviert, 0) AS FLOAT) AS LB_in_EUR,
				CAST(EKHandelNasslamFA AS FLOAT) AS EKHandelNasslamFA_EUR,
				CAST(Matko_EK AS FLOAT) AS Matko_EK_EUR,
				CAST(Matko_GK_SO AS FLOAT) AS Matko_GK_SO_EUR,
				CAST(Fremd_EK AS FLOAT) AS Fremd_EK_EUR,
				CAST(Pers_etc AS FLOAT) AS Pers_etc_EUR,
				CAST(Kosten_Uml AS FLOAT) AS Kosten_Uml_EUR,
				InternMasslamHandel,
				FAkomplAm,
				letzte_Lieferung,
				ExcelDatei_Link

			FROM
			(
				SELECT
					tblNachKalk_Daten.Aufbereitung,
					tblNachKalk_Daten.LP,
					CASE
						WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)=1 THEN 
							''Intern''
						ELSE
							CASE
								WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)=2 THEN 
									''Masslam''
								ELSE
									CASE
										WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)=3 THEN 
											''Handel''
										ELSE
											''unbekannt''
									END
							END
					END AS InternMasslamHandel,
					tblNachKalk_Daten.Kunde,
					tblNachKalk_Daten.PC,
					tblNachKalk_Daten.AnzKommissionen,
					tblNachKalk_Daten.Kommission,
					tblNachKalk_Daten.FA,
					tblNachKalk_Daten.FAkomplAm,
					tblNachKalk_Daten.letzte_Lieferung,
					tblNachKalk_Daten.ExcelDatei_Link,
					ISNULL((
						SELECT TOP 1
							SUM(ELP_Preis_EUR*gesendet_FA)/SUM(gesendet_FA) AS umsatz
						FROM
						(
							SELECT 
								dbo.DATA0006.RKEY AS D0006_PTR,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										* 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
								END AS ELP_Preis_EUR,
								dbo.DATA0052.QUAN_SHP AS gesendet_FA

							FROM         dbo.DATA0006 INNER JOIN
												  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
												  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
												  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
												  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
												  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
							--GROUP BY
							--	dbo.DATA0006.RKEY
						) AS tblFAUmsatz
						WHERE D0006_PTR = D6_PTR 
					), (
							SELECT TOP 1 (dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE) AS RES 
							FROM dbo.DATA0054 INNER JOIN  dbo.DATA0060 ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY 
							WHERE dbo.DATA0054.WO_PTR = D6_PTR
						)) AS ELP_gesend_gewDP,
					ISNULL((
						SELECT TOP 1
							SUM(RES) AS umsatz
						FROM
						(
							SELECT 
								dbo.DATA0006.RKEY AS D0006_PTR,
								(
									CASE 
										WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
											ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
											* 
											dbo.DATA0060.EXCH_RATE 
										ELSE
											dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
									END --ELP_Preis_EUR
									*
									dbo.DATA0052.QUAN_SHP --AS gesendet_FA
								) AS RES

							FROM         dbo.DATA0006 INNER JOIN
												  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
												  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
												  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
												  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
												  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
							--GROUP BY
							--	dbo.DATA0006.RKEY
						) AS tblFAUmsatz
						WHERE D0006_PTR = D6_PTR 
					), 0) AS FA_Umsatz,
					tblNachKalk_Daten.EK_Handel_Masslam_HauptFA AS EKHandelNasslamFA,
					tblNachKalk_Daten.Matko_EK,
					tblNachKalk_Daten.Matko_GK + tblNachKalk_Daten.Matko_So AS Matko_GK_SO,
					tblNachKalk_Daten.Fremd_EK,
					tblNachKalk_Daten.Pers_etc,
					tblNachKalk_Daten.Kosten_Uml,
					ISNULL((SELECT TOP 1 QTY_ALLOC AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_reserviert,
/*
					ISNULL((
						ISNULL((
							SELECT TOP 1
								SUM(RES) AS retourn
							FROM
							(
								SELECT
									dbo.DATA0006.RKEY AS D0006_PTR,
									(
										CASE 
											WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
												ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
												* 
												dbo.DATA0060.EXCH_RATE 
											ELSE
												dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
										END --AS ELP_Preis_EUR
										*
										dbo.DATA0060.PARTS_RETURNED
									) AS RES

								FROM         dbo.DATA0006 INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
							) AS tblRetourn
							WHERE D0006_PTR = D6_PTR 
						), 0) 
						/
						CASE
							WHEN 
								(
									ISNULL((
										SELECT
											COUNT(dbo.DATA0060.SALES_ORDER) AS RES

										FROM         dbo.DATA0006 INNER JOIN
															  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
															  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
															  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
															  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
															  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
															  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
															  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
															  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
									WHERE dbo.DATA0060.RKEY = D60_PTR 
									), 0)
								) > 0 THEN
									ISNULL((
										SELECT
											COUNT(dbo.DATA0060.SALES_ORDER) AS RES

										FROM         dbo.DATA0006 INNER JOIN
															  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
															  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
															  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
															  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
															  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
															  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
															  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
															  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
									WHERE dbo.DATA0060.RKEY = D60_PTR 
									), 0) 
							ELSE
								1
						END
					), 0) AS RetourniertProFAinEUR,
*/
					ISNULL((
						ISNULL((
								SELECT TOP 1
									  SUM(dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) AS RES
									FROM         dbo.DATA0060 LEFT OUTER JOIN
														  dbo.DATA0116 INNER JOIN
														  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
								WHERE dbo.DATA0060.RKEY = D60_PTR 
						), 0) 
						/
						CASE
							WHEN 
								(
									ISNULL((
										SELECT
											COUNT(dbo.DATA0060.SALES_ORDER) AS RES

										FROM         dbo.DATA0006 INNER JOIN
															  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
															  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
															  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
															  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
															  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
															  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
															  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
															  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
									WHERE dbo.DATA0060.RKEY = D60_PTR 
									), 0)
								) > 0 THEN
									ISNULL((
										SELECT
											COUNT(dbo.DATA0060.SALES_ORDER) AS RES

										FROM         dbo.DATA0006 INNER JOIN
															  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
															  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
															  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
															  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
															  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
															  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
															  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
															  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
									WHERE dbo.DATA0060.RKEY = D60_PTR 
									), 0) 
							ELSE
								1
						END
					), 0) AS GutschriftProFAinEUR
				FROM
					LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
				WHERE 
					tblNachKalk_Daten.FAkomplAm >= CONVERT(DATETIME, ''' + @para6 + ''', 103)
					AND tblNachKalk_Daten.FAkomplAm <= CONVERT(DATETIME, ''' + @para7 + ''', 103)
					AND tblNachKalk_Daten.Aufbereitung = ''' + @para1 + '''' +
					CASE WHEN @para2<>'-1' THEN ' AND tblNachKalk_Daten.D10_PTR IN (' + @para2 + ')' ELSE '' END + 
					CASE WHEN @para3<>'-1' THEN ' AND tblNachKalk_Daten.D50_PTR IN (' + @para3 + ')' ELSE '' END +
					CASE WHEN @para4<>'-1' THEN ' AND tblNachKalk_Daten.D8_PTR IN (' + @para4 + ')' ELSE '' END +
		'
			) AS tblDaten
			WHERE 
				InternMasslamHandel IN (' + @para5 + ')' 


		EXECUTE(@SQLAbfrageLP1Daten)
	END

	IF @Case_ = 'Lieferhistorie'
	BEGIN
		SELECT
			*
		FROM
		(
			SELECT  
				'Lieferung' AS Vorgang,
				dbo.DATA0006.WORK_ORDER_NUMBER AS FA,
				dbo.DATA0052.QUAN_SHP AS Menge, 
				dbo.DATA0064.DATE_SHIPPED AS Datum,
				CASE 
					WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
						ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
						* 
						dbo.DATA0060.EXCH_RATE 
					ELSE
						dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
				END AS ELP_Preis_EUR, 
				dbo.DATA0060.SALES_ORDER AS Kommission,
				ISNULL((
					SELECT TOP 1
						ISNULL(SUM(Materialkosten)/SUM(Menge), 0) AS RES
					FROM
					(
						SELECT
							D6.RKEY AS D6_PTR_MatKosten,
							(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH) AS Menge,
							ISNULL((
								SELECT TOP 1
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN 
											(dbo.DATA0108.PRICE/dbo.DATA0107.EX_RATE)*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
										ELSE
											CASE
												WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN 
													(dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE)*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
												ELSE
													dbo.DATA0017.ACTUAL_COST*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
											END
									END
								FROM         dbo.DATA0107 INNER JOIN
														dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
														dbo.DATA0070 INNER JOIN
														dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
								WHERE     (dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR) 
							), (dbo.DATA0017.ACTUAL_COST*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH))) AS Materialkosten 
						FROM         dbo.DATA0095 INNER JOIN
												dbo.DATA0067 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0067.RKEY INNER JOIN
												dbo.DATA0006 AS D6 ON dbo.DATA0067.WO_PTR = D6.RKEY INNER JOIN
												dbo.DATA0020 ON dbo.DATA0095.INVT_LOC_PTR = dbo.DATA0020.RKEY INNER JOIN
												dbo.DATA0017 ON dbo.DATA0020.INVENTORY_POINTER = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0050 ON D6.CUST_PART_PTR = dbo.DATA0050.RKEY
						WHERE     (dbo.DATA0095.TRAN_TP = 13 OR dbo.DATA0095.TRAN_TP = 14) AND (dbo.DATA0017.TTYPE = 'R' OR
												dbo.DATA0017.TTYPE = 'M') AND (D6.WORK_ORDER_NUMBER LIKE REPLACE(dbo.DATA0006.WORK_ORDER_NUMBER, '000', '%')) --@para1 ) --'  -086881-01%') -- = 147320)
											AND ISNULL(dbo.DATA0020.BATCH_NO, '')<>''

						UNION ALL

						SELECT
							D6.RKEY AS D6_PTR_MatKosten, 
							dbo.DATA0341.QUANTITY AS Menge,
							ISNULL((CASE 
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 then
									(dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE) * dbo.DATA0341.QUANTITY
								ELSE
									(dbo.DATA0017.ACTUAL_COST * dbo.DATA0341.QUANTITY) 
							END), 0) AS Materialkosten
						FROM         dbo.DATA0467 INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0002 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0002.RKEY = dbo.DATA0017.STOCK_UNIT_PTR INNER JOIN
												dbo.DATA0067 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0067.RKEY = dbo.DATA0341.SRCE_PTR INNER JOIN
												dbo.DATA0006 AS D6 ON dbo.DATA0067.WO_PTR = D6.RKEY ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR ON 
												dbo.DATA0467.RKEY = dbo.DATA0341.DATA0467_PTR
						WHERE     (dbo.DATA0341.TRAN_TP IN (4, 6)) AND (dbo.DATA0017.TTYPE = 'R' OR
												dbo.DATA0017.TTYPE = 'M') AND (D6.WORK_ORDER_NUMBER LIKE REPLACE(dbo.DATA0006.WORK_ORDER_NUMBER, '000', '%'))
									AND ISNULL(dbo.DATA0341.REFERENCE_NUMBER, '')<>''
					) AS tblMatKosten
				), 0) AS PCB_EKPreis,
				ISNULL((
						SELECT TOP 1
							ISNULL((
								SELECT TOP 1
									MAX(dbo.DATA0070.PO_NUMBER) AS RES
								FROM         dbo.DATA0107 INNER JOIN
														dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
														dbo.DATA0070 INNER JOIN
														dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
								WHERE     (dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR) 
							), '') AS PO 
						FROM         dbo.DATA0095 INNER JOIN
												dbo.DATA0067 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0067.RKEY INNER JOIN
												dbo.DATA0006 AS D6 ON dbo.DATA0067.WO_PTR = D6.RKEY INNER JOIN
												dbo.DATA0020 ON dbo.DATA0095.INVT_LOC_PTR = dbo.DATA0020.RKEY INNER JOIN
												dbo.DATA0017 ON dbo.DATA0020.INVENTORY_POINTER = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
						WHERE     (dbo.DATA0095.TRAN_TP = 13 OR dbo.DATA0095.TRAN_TP = 14) AND (dbo.DATA0017.TTYPE = 'R' OR
												dbo.DATA0017.TTYPE = 'M') AND (D6.WORK_ORDER_NUMBER LIKE REPLACE(dbo.DATA0006.WORK_ORDER_NUMBER, '000', '%')) --@para1 ) --'  -086881-01%') -- = 147320)
											AND ISNULL(dbo.DATA0020.BATCH_NO, '')<>''
				), '') AS Bestellung
			FROM         dbo.DATA0006 INNER JOIN
								  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
								  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
								  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
								  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
								  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
								  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
								  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
								  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
			WHERE     
					RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) = @para1 --'51051.300' --'  
					AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para2, 103))
					AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para3, 103))

			UNION ALL

			SELECT DISTINCT
				Vorgang,
				MAX(FA) AS FA,
				Menge, 
				Datum,
				ELP_Preis_EUR, 
				Kommission,
				PCB_EKPreis,
				Bestellung
			FROM
			(
				SELECT
					'Reklamation' AS Vorgang,
					dbo.DATA0006.WORK_ORDER_NUMBER AS FA,
					(-1)*dbo.DATA0098.QTY_AUTH AS Menge, 
					dbo.DATA0098.RMA_DATE AS Datum,
					CASE 
						WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
							ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
							* 
							dbo.DATA0060.EXCH_RATE 
						ELSE
							dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
					END AS ELP_Preis_EUR, 
					dbo.DATA0060.SALES_ORDER AS Kommission,
					0 AS PCB_EKPreis,
					ISNULL((
							SELECT TOP 1
								ISNULL((
									SELECT TOP 1
										MAX(dbo.DATA0070.PO_NUMBER) AS RES
									FROM         dbo.DATA0107 INNER JOIN
															dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
															dbo.DATA0070 INNER JOIN
															dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
									WHERE     (dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR) 
								), '') AS PO 
							FROM         dbo.DATA0095 INNER JOIN
													dbo.DATA0067 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0067.RKEY INNER JOIN
													dbo.DATA0006 AS D6 ON dbo.DATA0067.WO_PTR = D6.RKEY INNER JOIN
													dbo.DATA0020 ON dbo.DATA0095.INVT_LOC_PTR = dbo.DATA0020.RKEY INNER JOIN
													dbo.DATA0017 ON dbo.DATA0020.INVENTORY_POINTER = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
							WHERE     (dbo.DATA0095.TRAN_TP = 13 OR dbo.DATA0095.TRAN_TP = 14) AND (dbo.DATA0017.TTYPE = 'R' OR
													dbo.DATA0017.TTYPE = 'M') AND (D6.WORK_ORDER_NUMBER LIKE REPLACE(dbo.DATA0006.WORK_ORDER_NUMBER, '000', '%')) --@para1 ) --'  -086881-01%') -- = 147320)
												AND ISNULL(dbo.DATA0020.BATCH_NO, '')<>''
					), '') AS Bestellung
				FROM         dbo.DATA0098 INNER JOIN
									  dbo.DATA0050 ON dbo.DATA0098.CUSTOMER_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
									  dbo.DATA0064 ON dbo.DATA0098.SHIPMENT_PTR = dbo.DATA0064.RKEY INNER JOIN
									  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
									  dbo.DATA0052 ON dbo.DATA0064.RKEY = dbo.DATA0052.SO_SHP_PTR INNER JOIN
									  dbo.DATA0053 ON dbo.DATA0052.DATA0053_PTR = dbo.DATA0053.RKEY INNER JOIN
									  dbo.DATA0006 ON dbo.DATA0053.WORK_ORDER_PTR = dbo.DATA0006.RKEY
				WHERE     
						RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) = @para1 --'51051.300' 
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para2, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para3, 103))
		) AS tblGrp
		GROUP BY
			Vorgang,
			Menge, 
			Datum,
			ELP_Preis_EUR, 
			Kommission,
			PCB_EKPreis,
			Bestellung

		UNION ALL

		SELECT DISTINCT
			'Lastschriften Gesamt' AS Vorgang,
			'LS-' + dbo.DATA0132.MEMO_NUMBER AS FA,
			0 AS Menge, 
			(dbo.DATA0132.MEMO_DATE) AS Datum,
			--0 AS ELP_Preis_EUR, 
			ISNULL((
					((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE)
					-
					(
						SELECT TOP 1 dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE FROM dbo.DATA0212 WHERE dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY
					)
			),0)*(-1) AS ELP_Preis_EUR,
			'' AS Kommission,
			ISNULL((
				ISNULL((
						((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE)
						-
						(
							SELECT TOP 1 dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE FROM dbo.DATA0212 WHERE dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY
						)
				),0)
				/
				ISNULL((
					SELECT TOP 1 
						SUM(dbo.DATA0219.QUAN_DEBITED) AS RES
					FROM         dbo.DATA0212 INNER JOIN
										  dbo.DATA0132 AS D132 INNER JOIN
										  dbo.DATA0107 ON D132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
										  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
										  dbo.DATA0219 ON dbo.DATA0108.RKEY = dbo.DATA0219.DATA0108_PTR ON dbo.DATA0212.DEBIT_PTR = D132.RKEY LEFT OUTER JOIN
										  dbo.DATA0201 INNER JOIN
										  dbo.DATA0199 ON dbo.DATA0201.MISC_CHARGEPTR = dbo.DATA0199.RKEY ON dbo.DATA0107.RKEY = dbo.DATA0201.INVOICE_APPTR
					WHERE     (D132.RKEY = dbo.DATA0132.RKEY)
				), 1)
			), 0)*(-1) AS PCB_EKPreis,
			(dbo.DATA0070.PO_NUMBER) AS Bestellung

			FROM         dbo.DATA0132 INNER JOIN
						dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
						dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
						dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY
			WHERE      
						RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(@para1) + '%'    
						AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para2, 103))
						AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para3, 103))
						--AND dbo.DATA0132.MEMO_TP=1
						AND dbo.DATA0132.MEMO_TP IN (1, 6)

		) AS tblLiefHistorie
		ORDER BY 
			Datum DESC, FA DESC
	END

	IF @Case_ = 'NachKalk_Berichte_LPgruppiert'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255),
			@para7 varchar(255),
			@para8 varchar(255),
			@para9 varchar(255),
			@para10 varchar(255)
		SET @para1 = 'Handel 2015 2'
		SET @para2 = '74, 492' --Kunde
		SET @para3 = '39223, 33339' --Kundenteil
		SET @para4 = '-1' --PC
		--SET @para5 = ''Intern', 'Masslam', 'Handel''
		SET @para6 = '01.01.2015'
		SET @para7 = '31.12.2015'
		SET @para8 = 'Intern'
		SET @para9 = 'Masslam'
		SET @para10 = 'Handel'
		*/

		DECLARE 
			@InsertSQLLP varchar(1000)

		--Kunde
		DECLARE @tblD10LP table(D10_PTR NUMERIC(10, 0))
		IF @para2<>'-1'
		BEGIN
			SET @InsertSQLLP = '
								--INSERT @tblD10(D10_PTR)
								SELECT DISTINCT
									D10_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
								WHERE
									tblNachKalk_Daten.D10_PTR IN (' + RTRIM(@para2) + ')
							'
							INSERT @tblD10LP(D10_PTR) EXECUTE(@InsertSQLLP)
		END
		ELSE
		BEGIN
			INSERT @tblD10LP(D10_PTR)
			SELECT DISTINCT
				D10_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
		END

		--Kundenteil
		DECLARE @tblD50LP table(D50_PTR NUMERIC(10, 0))
		IF @para3<>'-1'
		BEGIN
			SET @InsertSQLLP = '
								--INSERT @tblD50(D50_PTR)
								SELECT DISTINCT
									D50_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
								WHERE
									tblNachKalk_Daten.D50_PTR IN (' + RTRIM(@para3) + ')
							'
							INSERT @tblD50LP(D50_PTR) EXECUTE(@InsertSQLLP)
		END
		ELSE
		BEGIN
			INSERT @tblD50LP(D50_PTR)
			SELECT DISTINCT
				D50_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
		END

		--PC
		DECLARE @tblD8LP table(D8_PTR NUMERIC(10, 0))
		IF @para4<>'-1'
		BEGIN
			SET @InsertSQLLP = '
								--INSERT @tblD8(D8_PTR)
								SELECT DISTINCT
									D8_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
								WHERE
									tblNachKalk_Daten.D8_PTR IN (' + RTRIM(@para4) + ')
							'
							INSERT @tblD8LP(D8_PTR) EXECUTE(@InsertSQLLP)
		END
		ELSE
		BEGIN
			INSERT @tblD8LP(D8_PTR)
			SELECT DISTINCT
				D8_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
		END

		--Lastschriften
		DECLARE @tblLSLP table(LS VARCHAR(9), LSBetrag FLOAT)
		INSERT @tblLSLP(LS, LSBetrag) SELECT '41333.301' AS LS, 1823 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '53136.300' AS LS, 1286 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '50735.300' AS LS, 4694 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '51712.302' AS LS, 584 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '52247.300' AS LS, 4625 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '34844.202' AS LS, 1853 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '49037.300' AS LS, 316 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '52395.300' AS LS, 1827 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '46660.301' AS LS, 5086 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '46861.301' AS LS, 704 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '51915.300' AS LS, 533 AS LSBetrag

		SELECT
			D10_PTR,
			Kunde,
			LP,
			MAX(AnzKommissionen) AS AnzKommissionen,
			MAX(Kommission) AS Kommission,
			COUNT(FA) AS AnzFA,
			MAX(PC) AS PC,
			MAX(ELP_gesend_gewDP) AS ELP_gesend_gewDP,
			SUM(FA_Umsatz) AS FA_Umsatz_ohneGutschrift,
			SUM(LB_in_EUR) AS LB_in_EUR,
			SUM(EKHandelNasslamFA) AS EKHandelNasslamFA_EUR,
			SUM(Matko_EK) AS Matko_EK_EUR,
			SUM(Matko_GK_SO) AS Matko_GK_SO_EUR,
			SUM(Matko_GK) AS Matko_GK,
			SUM(Matko_So) AS Matko_So,
			SUM(Fremd_EK) AS Fremd_EK_EUR,
			SUM(Pers_etc) AS Pers_etc_EUR,
			SUM(Kosten_Uml) AS Kosten_Uml_EUR,
			SUM(FA_freiLB) AS ELP_freiLB,
			SUM(FA_reserviert) AS ELP_reserviert,
			MAX(FAkomplAm) AS FAkomplAm,
			MAX(ArtikelCode) AS ArtikelCode,

			------------------------------------------------------------------------
			--Lastschriften
			ISNULL((
					SELECT TOP 1
						SUM(Lastschriften) 
						+
						ISNULL((SELECT TOP 1 LSBetrag FROM @tblLSLP AS tblLSLP WHERE LS COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(LP))), 0)
						AS Lastschrift_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0132.RKEY, 
							((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE) AS Lastschriften

						FROM         dbo.DATA0132 INNER JOIN
									dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
									dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

						WHERE      
									RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriften						
			), 0) AS Lastschrift_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(NK) AS LastschriftNK_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS NK
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Nebenkosten Handel')
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenNebenkosten					
			), 0) AS LastschriftNebenkosten_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(Sonstiges) AS LastschriftSonstiges_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Sonstiges
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Sonstiges')
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenSonstiges					
			), 0) AS LastschriftSonstiges_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(Rest) AS LastschriftRest_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Rest
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									AND dbo.DATA0199.MISC_CHARGE_CATEGORY NOT IN ('Sonstiges', 'Nebenkosten Handel')
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenRest						
			), 0) AS LastschriftRest_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(NKLastschriften) AS NKLastschrift_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0132.RKEY, 
							(dbo.DATA0132.MISC_TOT / dbo.DATA0132.EX_RATE) AS NKLastschriften

						FROM         dbo.DATA0132 INNER JOIN
									dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
									dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

						WHERE      
									RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblNKLastschriften						
			), 0) AS SonstigeLastschrift_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Einkauf (BM, CU, PP, PCB, Masslam)
			ISNULL(( 
				SELECT
					SUM(NK) AS NKEinkauf
				FROM
				(
					SELECT DISTINCT 
						D107_.RKEY,
						(D107_.SHIPPING + D107_.MISC_TOT) / D107_.EX_RATE  AS NK
					FROM         dbo.DATA0070 AS D70_ INNER JOIN
										dbo.DATA0071 AS D71_ ON D70_.RKEY = D71_.PO_PTR INNER JOIN
										dbo.DATA0108 AS D108_ ON D71_.RKEY = D108_.DATA0071_PTR INNER JOIN
										dbo.DATA0107 AS D107_ ON D108_.DATA0107_PTR = D107_.RKEY INNER JOIN
										dbo.DATA0017 AS D17_ ON D71_.INVT_PTR = D17_.RKEY
					WHERE
						RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						AND (D107_.INV_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (D107_.INV_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblNKEinkauf_
			), 0) AS NKEinkauf_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Gutschriften
			/*
			ISNULL((
				SELECT
					SUM(Gutschrift) AS Gutschrift_EUR
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0116.RKEY,
						(dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE AS Gutschrift
					FROM         dbo.DATA0060 INNER JOIN
										  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
										  dbo.DATA0116 INNER JOIN
										  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschrift	
			), 0) AS Gutschrift_EUR,	
			*/
			ISNULL((
				SELECT
					SUM(BetragNetto) AS Gutschrift_EUR
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0116.RKEY,
						dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY) AS BetragNetto
					FROM         dbo.DATA0116 INNER JOIN
							  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
							  dbo.DATA0060 INNER JOIN
							  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschrift	
			), 0) AS Gutschrift_EUR,
			ISNULL((
				SELECT
					SUM(GSNK) AS GutschriftNK_EUR
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0116.RKEY,
						(
							((dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE)
							-
							(dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY)) 
						) AS GSNK
					FROM         dbo.DATA0116 INNER JOIN
							  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
							  dbo.DATA0060 INNER JOIN
							  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschriftNK
			), 0) AS GutschriftNebenkosten_EUR,		
			ISNULL((
				SELECT
					SUM(RMenge) AS GutschriftMenge
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0098.RKEY,
						dbo.DATA0098.QTY_AUTH AS RMenge
					FROM         
						dbo.DATA0098 
					WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
							AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschriftMenge
			), 0) AS GutschriftMenge,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Provision
			ISNULL((
				SELECT TOP 1
					dbo.DATA0009.SALES_REP_NAME
				FROM         dbo.DATA0006 INNER JOIN
										dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
										dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
										dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
										dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
										dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
										dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
										dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
										dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
										dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
										dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
										dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
				WHERE
					dbo.DATA0050.RKEY = MAX(D50_PTR)
					AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
					AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
			), '') AS ProvisionVerteter,
			SUM(FA_Umsatz_VertProvision) AS VerkaufProvision_EUR,
			ISNULL((
				SELECT
					SUM(Provision) AS GutschriftNK_EUR
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0116.RKEY,
						ISNULL(dbo.DATA0509.COMMISSION_DEBITED / dbo.DATA0509.EXCHANGE_RATE, 0) AS Provision
					FROM         dbo.DATA0125 INNER JOIN
										  dbo.DATA0509 ON dbo.DATA0125.DATA0509_PTR = dbo.DATA0509.RKEY RIGHT OUTER JOIN
										  dbo.DATA0116 INNER JOIN
										  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
										  dbo.DATA0060 INNER JOIN
										  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY ON 
										  dbo.DATA0125.MEMO_PTR = dbo.DATA0116.RKEY LEFT OUTER JOIN
										  dbo.DATA0508 INNER JOIN
										  dbo.DATA0061 ON dbo.DATA0508.DATA0061_PTR = dbo.DATA0061.RKEY INNER JOIN
										  dbo.DATA0124 ON dbo.DATA0508.RKEY = dbo.DATA0124.DATA0508_PTR ON dbo.DATA0116.RKEY = dbo.DATA0124.MEMO_PTR
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschriftNK
			), 0) AS GutschriftProvision_EUR,
			ISNULL((
				SELECT TOP 1
					dbo.DATA0009.COMMISSION_1
				FROM         dbo.DATA0006 INNER JOIN
										dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
										dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
										dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
										dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
										dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
										dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
										dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
										dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
										dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
										dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
										dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
				WHERE
					dbo.DATA0050.RKEY = MAX(D50_PTR)
					AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
					AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
			), 0)/100 AS ProvisionVerteterProzent,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Produktion
			ISNULL((
				SELECT TOP 1
					SUM(QUAN_SCH) AS RES
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0006.RKEY, 
						dbo.DATA0006.QUAN_SCH
					FROM         dbo.DATA0006 --INNER JOIN
											--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND dbo.DATA0006.ROOT_PTR=0
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
						AND dbo.DATA0006.PROD_STATUS=5
				) AS tblAufgelegt
			), 0) AS Aufgelegt,
			ISNULL((
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_REJ) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_REJ 
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) <> 'R'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAusschuss
				), 0)
				+
				ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
					SELECT
						SUM(RMenge) AS GutschriftMenge
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0098.RKEY,
							dbo.DATA0098.QTY_AUTH AS RMenge
						FROM         
							dbo.DATA0098 
						WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftMenge
				), 0)
				-
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_PROD) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_PROD
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblProduziert
				), 0)
			), 0) AS Ausschuss,
			ISNULL((
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_PROD) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_PROD
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblProduziert
				), 0)
				-
				ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
					SELECT
						SUM(RMenge) AS GutschriftMenge
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0098.RKEY,
							dbo.DATA0098.QTY_AUTH AS RMenge
						FROM         
							dbo.DATA0098 
						WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftMenge
				), 0)
				-
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_REJ) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_REJ
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='W'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAusschuss_R
				), 0)
				+
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_PROD) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_PROD
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblProduziert
				), 0)
			), 0) AS Produziert,
			ISNULL((
				SELECT TOP 1
					SUM(QUAN_REJ)/SUM(QUAN_SCH) AS RES
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0006.RKEY, 
						dbo.DATA0006.QUAN_REJ,
						dbo.DATA0006.QUAN_SCH
					FROM         dbo.DATA0006 --INNER JOIN
											--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND dbo.DATA0006.ROOT_PTR=0
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						AND dbo.DATA0006.PROD_STATUS=5
				) AS tblAusschuss
			), 0) AS Ausschuss_Proz,
			ISNULL((
					SELECT
						SUM(QTY_ON_HAND) AS LPKonsi_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0053.RKEY, 
							dbo.DATA0053.QTY_ON_HAND
						FROM         dbo.DATA0006 INNER JOIN
												dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
						WHERE     
								dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
					) AS tblNLPKonsiMenge
			), 0) AS LPKonsi,
			ISNULL((
					SELECT
						SUM(QTY_ON_HAND*LAST_SO_PRICE) AS LPKonsi_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0053.RKEY, 
							dbo.DATA0053.QTY_ON_HAND,
							dbo.DATA0050.LAST_SO_PRICE
						--FROM         dbo.DATA0006 INNER JOIN
						--						dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
						FROM         dbo.DATA0006 INNER JOIN
											  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
						WHERE     
								dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
					) AS tblNLPKonsiMenge
			--), 0) * MAX(ELP_gesend_gewDP)  AS LPKonsi_EUR,
			), 0)  AS LPKonsi_EUR,
			ISNULL((
				SELECT TOP 1
					SUM(gesendet_FA * KNX * KNY / ELP_KN / 10000) AS RES
				FROM
				(
					SELECT 
						dbo.ARTIKELDATEN.*,
						dbo.DATA0050.RKEY AS D0050_PTR,
						CASE 
							WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
								ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
								* 
								dbo.DATA0060.EXCH_RATE 
							ELSE
								dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
						END AS ELP_Preis_EUR,
						dbo.DATA0052.QUAN_SHP AS gesendet_FA

					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE
						(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblFAUmsatz
				WHERE D0050_PTR = MAX(D50_PTR) 
			), 0) AS Durch_VK_dm2,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Verkauf
			ISNULL((
				SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
				FROM         dbo.DATA0006 INNER JOIN
										dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
										dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
										dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
				WHERE 
					dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
					AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
					AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
			), 0) AS LMenge,
			ISNULL((
				SELECT
					SUM(NK) AS NKVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.TOOLING_CHARGES AS NK
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblNKVerkauf
			), 0) AS NKVerkauf_EUR,
			ISNULL((
				SELECT
					SUM(Rabatt) AS RabattVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.DISCOUNT_AMOUNT AS Rabatt
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblRabattVerkauf
			), 0) AS RabattVerkauf_EUR,
			ISNULL((
				SELECT
					SUM(Einzuschlag) AS EZVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.RUSH_CHARGE_AMOUNT AS Einzuschlag
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblEZVerkauf
			), 0) AS EZVerkauf_EUR,
			ISNULL((
				SELECT
					SUM(Versandkosten) AS VersandVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.SHIPPING_CHARGES AS Versandkosten
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblVersandVerkauf
			), 0) AS VersandVerkauf_EUR,

			(
				SUM(FA_Umsatz)
				-
				ISNULL((
					SELECT TOP 1 
						SUM(Gutschrift) AS Gutschrift_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0116.RKEY,
							dbo.DATA0116.CREDIT_AMOUNT/dbo.DATA0116.EX_RATE - dbo.DATA0116.STATE_TAX AS Gutschrift
						FROM         dbo.DATA0060 INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
											  dbo.DATA0116 INNER JOIN
											  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE     (dbo.DATA0060.CUST_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschrift	
				), 0)
			) AS FA_Umsatz,
			ISNULL((
				SELECT TOP 1
					--SUM(FK) AS FK1,
					SUM(FK/CASE WHEN PlusZeichen_1=0 THEN 1 ELSE CASE WHEN PlusZeichen_1>0 AND PlusZeichen_2=0 THEN 2 ELSE 3 END END) AS FK_EUR
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0072.RKEY,
						dbo.DATA0072.DESCRIPTION2 AS LP,
						(dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE * dbo.DATA0072.QUAN_ORD) AS FK,
						CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 1) AS PlusZeichen_1,
						CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 21) AS PlusZeichen_2
					FROM         dbo.DATA0070 INNER JOIN
										  dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR
					WHERE
						LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION, '')), 3) = 'FK '
						AND LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION2, '')), 3) = 'LP '
						AND dbo.DATA0072.DESCRIPTION2 COLLATE SQL_Latin1_General_CP1_CI_AS LIKE '%' + LTRIM(RTRIM(LP)) + '%' 
						AND (dbo.DATA0070.PO_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0070.PO_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblFK
			), 0) AS Frachtkosten_EUR,
			ISNULL((
				ISNULL(SUM(FA_reserviert), 0)
				+
				ISNULL((
					SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				), 0) 
				+
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND) AS LPKonsi
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND
							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				), 0) 
			), 0) AS GesamtVerkaufsmenge
			------------------------------------------------------------------------
			------------------------------------------------------------------------
			
		FROM
		(
			SELECT
				tblDaten.*
				--CAST(ELP_gesend_gewDP*FA_reserviert AS FLOAT) AS LB_in_EUR
			FROM
			(
				SELECT
					tblNachKalk_Daten.D10_PTR,
					tblNachKalk_Daten.Kunde,
					tblNachKalk_Daten.Aufbereitung,
					tblNachKalk_Daten.LP,
					tblNachKalk_Daten.D50_PTR,
					tblNachKalk_Daten.D60_PTR,
					CASE
						WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)=1 THEN 
							'Intern'
						ELSE
							CASE
								WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)=2 THEN 
									'Masslam'
								ELSE
									CASE
										WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)=3 THEN 
											'Handel'
										ELSE
											'unbekannt'
									END
							END
					END AS InternMasslamHandel,
					tblNachKalk_Daten.PC,
					tblNachKalk_Daten.AnzKommissionen,
					tblNachKalk_Daten.Kommission,
					tblNachKalk_Daten.FA,
					ISNULL((
						SELECT TOP 1
							SUM(RES) AS umsatz
						FROM
						(
							SELECT 
								dbo.DATA0006.RKEY AS D0006_PTR,
								(
									CASE 
										WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
											ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
											/ 
											dbo.DATA0060.EXCH_RATE 
										ELSE
											dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
									END --ELP_Preis_EUR
									*
									dbo.DATA0052.QUAN_SHP --AS gesendet_FA
								) AS RES
							FROM         dbo.DATA0006 INNER JOIN
												  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
												  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
												  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
												  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
												  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE
								(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblFAUmsatz
						WHERE 
							D0006_PTR = D6_PTR 
							--D0006_PTR = CASE WHEN LEFT(tblNachKalk_Daten.FA, 1)='S' THEN tblNachKalk_Daten.D6S_PTR ELSE tblNachKalk_Daten.D6_PTR END
					), 0) AS FA_Umsatz,
					ISNULL((
						SELECT TOP 1
							SUM(RES) AS umsatzProv
						FROM
						(
							SELECT 
								dbo.DATA0006.RKEY AS D0006_PTR,
								(
									CASE 
										WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
											ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
											/ 
											dbo.DATA0060.EXCH_RATE 
										ELSE
											dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
									END --ELP_Preis_EUR
									*
									dbo.DATA0052.QUAN_SHP --AS gesendet_FA
									*
									(dbo.DATA0509.SALES_COMMISSION_PER/100)
								) AS RES
							FROM         dbo.DATA0006 INNER JOIN
												  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
												  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
												  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
												  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
												  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
												  dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
												  dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR
							WHERE
								(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblFAUmsatzProv
						WHERE D0006_PTR = D6_PTR 
					), 0) AS FA_Umsatz_VertProvision,
					tblNachKalk_Daten.EK_Handel_Masslam_HauptFA AS EKHandelNasslamFA,
					tblNachKalk_Daten.Matko_EK,
					tblNachKalk_Daten.Matko_GK + tblNachKalk_Daten.Matko_So AS Matko_GK_SO,
					tblNachKalk_Daten.Matko_GK,
					tblNachKalk_Daten.Matko_So,
					tblNachKalk_Daten.Fremd_EK,
					tblNachKalk_Daten.Pers_etc,
					tblNachKalk_Daten.Kosten_Uml,
					ISNULL((SELECT TOP 1 QTY_ALLOC AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_reserviert,
					ISNULL((
							SELECT TOP 1
								SUM(RES) AS LBEur
							FROM
							(
								SELECT DISTINCT
									dbo.DATA0053.RKEY,
									(dbo.DATA0060.PART_PRICE/dbo.DATA0060.EXCH_RATE*dbo.DATA0053.QTY_ALLOC) AS RES
									--SUM(dbo.DATA0053.QTY_ALLOC) AS RES
								FROM         dbo.DATA0060 INNER JOIN
													  dbo.DATA0063 ON dbo.DATA0060.RKEY = dbo.DATA0063.SO_PTR INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0063.PART_BATCH_PTR = dbo.DATA0053.RKEY
								WHERE dbo.DATA0053.WORK_ORDER_PTR = D6_PTR 
							) AS tblLBEur
					), 0) AS LB_in_EUR,
					ISNULL((SELECT TOP 1 (QTY_ON_HAND - QTY_ALLOC) AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_freiLB,
					tblNachKalk_Daten.Aus_in_Proz,
					ISNULL((
						SELECT TOP 1
							SUM(ELP_Preis_EUR*gesendet_FA)/SUM(gesendet_FA) AS umsatz
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.ACT_COMPL_DATE,
								dbo.DATA0050.RKEY AS D0050_PTR,
								--dbo.DATA0006.RKEY AS D0006_PTR,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										* 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
								END AS ELP_Preis_EUR,
								dbo.DATA0052.QUAN_SHP AS gesendet_FA

							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						) AS tblFAUmsatz
						WHERE 
							D0050_PTR = tblNachKalk_Daten.D50_PTR
							AND (ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						--WHERE D0006_PTR = D6_PTR 
					), 
						(
							SELECT TOP 1 (dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE) AS RES 
							FROM dbo.DATA0054 INNER JOIN  dbo.DATA0060 ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY 
							WHERE dbo.DATA0060.CUST_PART_PTR = tblNachKalk_Daten.D50_PTR
						)
					) AS ELP_gesend_gewDP,
					tblNachKalk_Daten.FAkomplAm,
					tblNachKalk_Daten.ArtikelCode

				FROM
					LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
				WHERE 
					tblNachKalk_Daten.FAkomplAm >= CONVERT(DATETIME, @para6, 103)
					AND tblNachKalk_Daten.FAkomplAm <= CONVERT(DATETIME, @para7, 103)
					AND tblNachKalk_Daten.Aufbereitung = @para1
					AND tblNachKalk_Daten.D10_PTR IN (SELECT D10_PTR FROM @tblD10LP)
					AND tblNachKalk_Daten.D50_PTR IN (SELECT D50_PTR FROM @tblD50LP)
					AND tblNachKalk_Daten.D8_PTR IN (SELECT D8_PTR FROM @tblD8LP)
			) AS tblDaten
		) AS tblDatenGrp 
		WHERE 
			InternMasslamHandel IN (ISNULL(@para8, ''), ISNULL(@para9, ''), ISNULL(@para10, ''))
		GROUP BY
			D10_PTR,
			Kunde, 
			LP
		ORDER BY
			LP
	END

	IF @Case_ = 'NachKalk_Berichte_Kundengruppiert'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255),
			@para7 varchar(255),
			@para8 varchar(255),
			@para9 varchar(255),
			@para10 varchar(255)
		SET @para1 = 'Handel 2015 2'
		SET @para2 = '74, 492' --Kunde
		SET @para3 = '39223, 33339' --Kundenteil
		SET @para4 = '-1' --PC
		--SET @para5 = ''Intern', 'Masslam', 'Handel''
		SET @para6 = '01.01.2015'
		SET @para7 = '31.12.2015'
		SET @para8 = 'Intern'
		SET @para9 = 'Masslam'
		SET @para10 = 'Handel'
		*/

		DECLARE 
			@InsertSQLKunden varchar(1000)

		--Kunde
		DECLARE @tblD10Kunden table(D10_PTR NUMERIC(10, 0))
		IF @para2<>'-1'
		BEGIN
			SET @InsertSQLKunden = '
								--INSERT @tblD10(D10_PTR)
								SELECT DISTINCT
									D10_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
								WHERE
									tblNachKalk_Daten.D10_PTR IN (' + RTRIM(@para2) + ')
							'
							INSERT @tblD10Kunden(D10_PTR) EXECUTE(@InsertSQLKunden)
		END
		ELSE
		BEGIN
			INSERT @tblD10Kunden(D10_PTR)
			SELECT DISTINCT
				D10_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
		END

		--Kundenteil
		DECLARE @tblD50Kunden table(D50_PTR NUMERIC(10, 0))
		IF @para3<>'-1'
		BEGIN
			SET @InsertSQLKunden = '
								--INSERT @tblD50(D50_PTR)
								SELECT DISTINCT
									D50_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
								WHERE
									tblNachKalk_Daten.D50_PTR IN (' + RTRIM(@para3) + ')
							'
							INSERT @tblD50Kunden(D50_PTR) EXECUTE(@InsertSQLKunden)
		END
		ELSE
		BEGIN
			INSERT @tblD50Kunden(D50_PTR)
			SELECT DISTINCT
				D50_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
		END

		--PC
		DECLARE @tblD8Kunden table(D8_PTR NUMERIC(10, 0))
		IF @para4<>'-1'
		BEGIN
			SET @InsertSQLKunden = '
								--INSERT @tblD8(D8_PTR)
								SELECT DISTINCT
									D8_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
								WHERE
									tblNachKalk_Daten.D8_PTR IN (' + RTRIM(@para4) + ')
							'
							INSERT @tblD8Kunden(D8_PTR) EXECUTE(@InsertSQLKunden)
		END
		ELSE
		BEGIN
			INSERT @tblD8Kunden(D8_PTR)
			SELECT DISTINCT
				D8_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
		END

		--Lastschriften
		DECLARE @tblLSKunde table(LS VARCHAR(9), LSBetrag FLOAT)
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '41333.301' AS LS, 1823 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '53136.300' AS LS, 1286 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '50735.300' AS LS, 4694 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '51712.302' AS LS, 584 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '52247.300' AS LS, 4625 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '34844.202' AS LS, 1853 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '49037.300' AS LS, 316 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '52395.300' AS LS, 1827 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '46660.301' AS LS, 5086 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '46861.301' AS LS, 704 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '51915.300' AS LS, 533 AS LSBetrag

		SELECT
			D10_PTR,
			Kunde,
			COUNT(DISTINCT LP) AS AnzLP,
			MAX(AnzKommissionen) AS AnzKommissionen,
			MAX(Kommission) AS Kommission,
			SUM(AnzFA) AS AnzFA,
			COUNT(DISTINCT PC) AS AnzPC,
			MAX(ELP_gesend_gewDP) AS ELP_gesend_gewDP,
			SUM(FA_Umsatz) AS FA_Umsatz_ohneGutschrift,
			SUM(LB_in_EUR) AS LB_in_EUR,
			SUM(EKHandelNasslamFA_EUR) AS EKHandelNasslamFA_EUR,
			SUM(Matko_EK_EUR) AS Matko_EK_EUR,
			SUM(Matko_GK_SO_EUR) AS Matko_GK_SO_EUR,
			SUM(Matko_GK) AS Matko_GK,
			SUM(Matko_So) AS Matko_So,
			SUM(Fremd_EK_EUR) AS Fremd_EK_EUR,
			SUM(Pers_etc_EUR) AS Pers_etc_EUR,
			SUM(Kosten_Uml_EUR) AS Kosten_Uml_EUR,
			SUM(ELP_freiLB) AS ELP_freiLB,
			SUM(ELP_reserviert) AS ELP_reserviert,
			MAX(FAkomplAm) AS FAkomplAm,
			MAX(ArtikelCode) AS ArtikelCode,
			SUM(Lastschrift_EUR) AS Lastschrift_EUR,
			SUM(LastschriftNebenkosten_EUR) AS LastschriftNebenkosten_EUR,
			SUM(LastschriftSonstiges_EUR) AS LastschriftSonstiges_EUR,
			SUM(LastschriftRest_EUR) AS LastschriftRest_EUR,
			SUM(SonstigeLastschrift_EUR) AS SonstigeLastschrift_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Einkauf (BM, CU, PP, PCB, Masslam)
			SUM(NKEinkauf_EUR) AS NKEinkauf_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Gutschriften
			SUM(Gutschrift_EUR) AS Gutschrift_EUR,
			SUM(GutschriftNebenkosten_EUR) AS GutschriftNebenkosten_EUR,		
			SUM(GutschriftMenge) AS GutschriftMenge,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Provision
			MAX(ProvisionVerteter) AS ProvisionVerteter,
			SUM(VerkaufProvision_EUR) AS VerkaufProvision_EUR,
			SUM(GutschriftProvision_EUR) AS GutschriftProvision_EUR,
			AVG(ProvisionVerteterProzent) AS ProvisionVerteterProzent,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Produktion
			SUM(Aufgelegt) AS Aufgelegt,
			SUM(Ausschuss) AS Ausschuss,
			SUM(Produziert) AS Produziert,
			AVG(Ausschuss_Proz) AS Ausschuss_Proz,
			SUM(LPKonsi) AS LPKonsi,
			SUM(LPKonsi_EUR)  AS LPKonsi_EUR,
			SUM(Durch_VK_dm2) AS Durch_VK_dm2,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Verkauf
			SUM(LMenge) AS LMenge,
			SUM(NKVerkauf_EUR) AS NKVerkauf_EUR,
			SUM(RabattVerkauf_EUR) AS RabattVerkauf_EUR,
			SUM(EZVerkauf_EUR) AS EZVerkauf_EUR,
			SUM(VersandVerkauf_EUR) AS VersandVerkauf_EUR,
			SUM(FA_Umsatz) AS FA_Umsatz,
			SUM(Frachtkosten_EUR) AS Frachtkosten_EUR,
			SUM(GesamtVerkaufsmenge) AS GesamtVerkaufsmenge

		FROM
		(
			SELECT
				D10_PTR,
				Kunde,
				LP,
				MAX(AnzKommissionen) AS AnzKommissionen,
				MAX(Kommission) AS Kommission,
				COUNT(FA) AS AnzFA,
				PC,
				MAX(ELP_gesend_gewDP) AS ELP_gesend_gewDP,
				SUM(FA_Umsatz) AS FA_Umsatz_ohneGutschrift,
				SUM(LB_in_EUR) AS LB_in_EUR,
				SUM(EKHandelNasslamFA) AS EKHandelNasslamFA_EUR,
				SUM(Matko_EK) AS Matko_EK_EUR,
				SUM(Matko_GK_SO) AS Matko_GK_SO_EUR,
				SUM(Matko_GK) AS Matko_GK,
				SUM(Matko_So) AS Matko_So,
				SUM(Fremd_EK) AS Fremd_EK_EUR,
				SUM(Pers_etc) AS Pers_etc_EUR,
				SUM(Kosten_Uml) AS Kosten_Uml_EUR,
				SUM(FA_freiLB) AS ELP_freiLB,
				SUM(FA_reserviert) AS ELP_reserviert,
				MAX(FAkomplAm) AS FAkomplAm,
				MAX(ArtikelCode) AS ArtikelCode,

				------------------------------------------------------------------------
				--Lastschriften
				ISNULL((
						SELECT TOP 1
							SUM(Lastschriften) 
							+
							ISNULL((SELECT TOP 1 LSBetrag FROM @tblLSKunde AS tblLSKunde WHERE LS COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(LP))), 0)
							AS Lastschrift_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0132.RKEY, 
								((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE) AS Lastschriften

							FROM         dbo.DATA0132 INNER JOIN
										dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
										dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
										dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

							WHERE      
										RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriften						
				), 0) AS Lastschrift_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(NK) AS LastschriftNK_EUR
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0132.RKEY,
								dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS NK
							FROM         dbo.DATA0199 INNER JOIN
													dbo.DATA0212 INNER JOIN
													dbo.DATA0132 INNER JOIN
													dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
													dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
													dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
													dbo.DATA0071 INNER JOIN
													dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
							WHERE     
										RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Nebenkosten Handel')
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriftenNebenkosten					
				), 0) AS LastschriftNebenkosten_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(Sonstiges) AS LastschriftSonstiges_EUR
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0132.RKEY,
								dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Sonstiges
							FROM         dbo.DATA0199 INNER JOIN
													dbo.DATA0212 INNER JOIN
													dbo.DATA0132 INNER JOIN
													dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
													dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
													dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
													dbo.DATA0071 INNER JOIN
													dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
							WHERE     
										RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Sonstiges')
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriftenSonstiges					
				), 0) AS LastschriftSonstiges_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(Rest) AS LastschriftRest_EUR
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0132.RKEY,
								dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Rest
							FROM         dbo.DATA0199 INNER JOIN
													dbo.DATA0212 INNER JOIN
													dbo.DATA0132 INNER JOIN
													dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
													dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
													dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
													dbo.DATA0071 INNER JOIN
													dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
							WHERE     
										RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										AND dbo.DATA0199.MISC_CHARGE_CATEGORY NOT IN ('Sonstiges', 'Nebenkosten Handel')
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriftenRest						
				), 0) AS LastschriftRest_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(NKLastschriften) AS NKLastschrift_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0132.RKEY, 
								(dbo.DATA0132.MISC_TOT / dbo.DATA0132.EX_RATE) AS NKLastschriften

							FROM         dbo.DATA0132 INNER JOIN
										dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
										dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
										dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

							WHERE      
										RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblNKLastschriften						
				), 0) AS SonstigeLastschrift_EUR,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Einkauf (BM, CU, PP, PCB, Masslam)
				ISNULL(( 
					SELECT
						SUM(NK) AS NKEinkauf
					FROM
					(
						SELECT DISTINCT 
							D107_.RKEY,
							(D107_.SHIPPING + D107_.MISC_TOT) / D107_.EX_RATE  AS NK
						FROM         dbo.DATA0070 AS D70_ INNER JOIN
											dbo.DATA0071 AS D71_ ON D70_.RKEY = D71_.PO_PTR INNER JOIN
											dbo.DATA0108 AS D108_ ON D71_.RKEY = D108_.DATA0071_PTR INNER JOIN
											dbo.DATA0107 AS D107_ ON D108_.DATA0107_PTR = D107_.RKEY INNER JOIN
											dbo.DATA0017 AS D17_ ON D71_.INVT_PTR = D17_.RKEY
						WHERE
							RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
							AND (D107_.INV_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (D107_.INV_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblNKEinkauf_
				), 0) AS NKEinkauf_EUR,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Gutschriften
				/*
				ISNULL((
					SELECT
						SUM(Gutschrift) AS Gutschrift_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0116.RKEY,
							(dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE AS Gutschrift
						FROM         dbo.DATA0060 INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
											  dbo.DATA0116 INNER JOIN
											  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschrift	
				), 0) AS Gutschrift_EUR,	
				*/
				ISNULL((
					SELECT
						SUM(BetragNetto) AS Gutschrift_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0116.RKEY,
							dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY) AS BetragNetto
						FROM         dbo.DATA0116 INNER JOIN
								  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
								  dbo.DATA0060 INNER JOIN
								  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschrift	
				), 0) AS Gutschrift_EUR,
				ISNULL((
					SELECT
						SUM(GSNK) AS GutschriftNK_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0116.RKEY,
							(
								((dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE)
								-
								(dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY)) 
							) AS GSNK
						FROM         dbo.DATA0116 INNER JOIN
								  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
								  dbo.DATA0060 INNER JOIN
								  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftNK
				), 0) AS GutschriftNebenkosten_EUR,		
				ISNULL((
					SELECT
						SUM(RMenge) AS GutschriftMenge
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0098.RKEY,
							dbo.DATA0098.QTY_AUTH AS RMenge
						FROM         
							dbo.DATA0098 
						WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftMenge
				), 0) AS GutschriftMenge,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Provision
				ISNULL((
					SELECT TOP 1
						dbo.DATA0009.SALES_REP_NAME
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
											dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
											dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
											dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
					WHERE
						dbo.DATA0050.RKEY = MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
				), '') AS ProvisionVerteter,
				SUM(FA_Umsatz_VertProvision) AS VerkaufProvision_EUR,
				ISNULL((
					SELECT
						SUM(Provision) AS GutschriftNK_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0116.RKEY,
							ISNULL(dbo.DATA0509.COMMISSION_DEBITED / dbo.DATA0509.EXCHANGE_RATE, 0) AS Provision
						FROM         dbo.DATA0125 INNER JOIN
											  dbo.DATA0509 ON dbo.DATA0125.DATA0509_PTR = dbo.DATA0509.RKEY RIGHT OUTER JOIN
											  dbo.DATA0116 INNER JOIN
											  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
											  dbo.DATA0060 INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY ON 
											  dbo.DATA0125.MEMO_PTR = dbo.DATA0116.RKEY LEFT OUTER JOIN
											  dbo.DATA0508 INNER JOIN
											  dbo.DATA0061 ON dbo.DATA0508.DATA0061_PTR = dbo.DATA0061.RKEY INNER JOIN
											  dbo.DATA0124 ON dbo.DATA0508.RKEY = dbo.DATA0124.DATA0508_PTR ON dbo.DATA0116.RKEY = dbo.DATA0124.MEMO_PTR
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftNK
				), 0) AS GutschriftProvision_EUR,
				ISNULL((
					SELECT TOP 1
						dbo.DATA0009.COMMISSION_1
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
											dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
											dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
											dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
					WHERE
						dbo.DATA0050.RKEY = MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
				), 0)/100 AS ProvisionVerteterProzent,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Produktion
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_SCH) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_SCH
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAufgelegt
				), 0) AS Aufgelegt,
				ISNULL((
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_REJ) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_REJ 
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) <> 'R'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblAusschuss
					), 0)
					+
					ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
						SELECT
							SUM(RMenge) AS GutschriftMenge
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0098.RKEY,
								dbo.DATA0098.QTY_AUTH AS RMenge
							FROM         
								dbo.DATA0098 
							WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
									AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblGutschriftMenge
					), 0)
					-
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_PROD) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_PROD
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblProduziert
					), 0)
				), 0) AS Ausschuss,
				ISNULL((
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_PROD) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_PROD
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblProduziert
					), 0)
					-
					ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
						SELECT
							SUM(RMenge) AS GutschriftMenge
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0098.RKEY,
								dbo.DATA0098.QTY_AUTH AS RMenge
							FROM         
								dbo.DATA0098 
							WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
									AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblGutschriftMenge
					), 0)
					-
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_REJ) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_REJ
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='W'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblAusschuss_R
					), 0)
					+
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_PROD) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_PROD
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblProduziert
					), 0)
				), 0) AS Produziert,
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_REJ)/SUM(QUAN_SCH) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_REJ,
							dbo.DATA0006.QUAN_SCH
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAusschuss
				), 0) AS Ausschuss_Proz,
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND) AS LPKonsi_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND
							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				), 0) AS LPKonsi,
				/*
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND) AS LPKonsi_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND
							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				), 0) * MAX(ELP_gesend_gewDP)  AS LPKonsi_EUR,
				*/
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND*LAST_SO_PRICE) AS LPKonsi_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND,
								dbo.DATA0050.LAST_SO_PRICE
							--FROM         dbo.DATA0006 INNER JOIN
							--						dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							FROM         dbo.DATA0006 INNER JOIN
												  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				--), 0) * MAX(ELP_gesend_gewDP)  AS LPKonsi_EUR,
				), 0)  AS LPKonsi_EUR,
				ISNULL((
					SELECT TOP 1
						SUM(gesendet_FA * KNX * KNY / ELP_KN / 10000) AS RES
					FROM
					(
						SELECT 
							dbo.ARTIKELDATEN.*,
							dbo.DATA0050.RKEY AS D0050_PTR,
							CASE 
								WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
									ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
									* 
									dbo.DATA0060.EXCH_RATE 
								ELSE
									dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
							END AS ELP_Preis_EUR,
							dbo.DATA0052.QUAN_SHP AS gesendet_FA

						FROM         dbo.DATA0006 INNER JOIN
												dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
												dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
												dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
												dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
												dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
												dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE
							(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblFAUmsatz
					WHERE D0050_PTR = MAX(D50_PTR) 
				), 0) AS Durch_VK_dm2,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Verkauf
				ISNULL((
					SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				), 0) AS LMenge,
				ISNULL((
					SELECT
						SUM(NK) AS NKVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.TOOLING_CHARGES AS NK
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblNKVerkauf
				), 0) AS NKVerkauf_EUR,
				ISNULL((
					SELECT
						SUM(Rabatt) AS RabattVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.DISCOUNT_AMOUNT AS Rabatt
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblRabattVerkauf
				), 0) AS RabattVerkauf_EUR,
				ISNULL((
					SELECT
						SUM(Einzuschlag) AS EZVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.RUSH_CHARGE_AMOUNT AS Einzuschlag
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblEZVerkauf
				), 0) AS EZVerkauf_EUR,
				ISNULL((
					SELECT
						SUM(Versandkosten) AS VersandVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.SHIPPING_CHARGES AS Versandkosten
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblVersandVerkauf
				), 0) AS VersandVerkauf_EUR,

				(
					SUM(FA_Umsatz)
					-
					ISNULL((
						SELECT TOP 1 
							SUM(Gutschrift) AS Gutschrift_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0116.RKEY,
								dbo.DATA0116.CREDIT_AMOUNT/dbo.DATA0116.EX_RATE - dbo.DATA0116.STATE_TAX AS Gutschrift
							FROM         dbo.DATA0060 INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
												  dbo.DATA0116 INNER JOIN
												  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
							WHERE     (dbo.DATA0060.CUST_PART_PTR = MAX(D50_PTR))
									AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblGutschrift	
					), 0)
				) AS FA_Umsatz,
				ISNULL((
					SELECT TOP 1
						--SUM(FK) AS FK1,
						SUM(FK/CASE WHEN PlusZeichen_1=0 THEN 1 ELSE CASE WHEN PlusZeichen_1>0 AND PlusZeichen_2=0 THEN 2 ELSE 3 END END) AS FK_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0072.RKEY,
							dbo.DATA0072.DESCRIPTION2 AS LP,
							(dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE * dbo.DATA0072.QUAN_ORD) AS FK,
							CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 1) AS PlusZeichen_1,
							CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 21) AS PlusZeichen_2
						FROM         dbo.DATA0070 INNER JOIN
											  dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR
						WHERE
							LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION, '')), 3) = 'FK '
							AND LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION2, '')), 3) = 'LP '
							AND dbo.DATA0072.DESCRIPTION2 COLLATE SQL_Latin1_General_CP1_CI_AS LIKE '%' + LTRIM(RTRIM(LP)) + '%' 
							AND (dbo.DATA0070.PO_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0070.PO_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblFK
				), 0) AS Frachtkosten_EUR,
				ISNULL((
					ISNULL(SUM(FA_reserviert), 0)
					+
					ISNULL((
						SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
						FROM         dbo.DATA0006 INNER JOIN
												dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					), 0) 
				), 0) AS GesamtVerkaufsmenge
				------------------------------------------------------------------------
				------------------------------------------------------------------------

			FROM
			(
				SELECT
					tblDaten.*
					--CAST(ELP_gesend_gewDP*FA_reserviert AS FLOAT) AS LB_in_EUR
				FROM
				(
					SELECT
						tblNachKalk_Daten.D10_PTR,
						tblNachKalk_Daten.Kunde,
						tblNachKalk_Daten.Aufbereitung,
						tblNachKalk_Daten.LP,
						tblNachKalk_Daten.D50_PTR,
						tblNachKalk_Daten.D60_PTR,
						CASE
							WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)=1 THEN 
								'Intern'
							ELSE
								CASE
									WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)=2 THEN 
										'Masslam'
									ELSE
										CASE
											WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)=3 THEN 
												'Handel'
											ELSE
												'unbekannt'
										END
								END
						END AS InternMasslamHandel,
						tblNachKalk_Daten.PC,
						tblNachKalk_Daten.AnzKommissionen,
						tblNachKalk_Daten.Kommission,
						tblNachKalk_Daten.FA,
						ISNULL((
							SELECT TOP 1
								SUM(RES) AS umsatz
							FROM
							(
								SELECT 
									dbo.DATA0006.RKEY AS D0006_PTR,
									(
										CASE 
											WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
												ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
												/ 
												dbo.DATA0060.EXCH_RATE 
											ELSE
												dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
										END --ELP_Preis_EUR
										*
										dbo.DATA0052.QUAN_SHP --AS gesendet_FA
									) AS RES
								FROM         dbo.DATA0006 INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
								WHERE
									(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							) AS tblFAUmsatz
							WHERE 
								D0006_PTR = D6_PTR 
								--D0006_PTR = CASE WHEN LEFT(tblNachKalk_Daten.FA, 1)='S' THEN tblNachKalk_Daten.D6S_PTR ELSE tblNachKalk_Daten.D6_PTR END
						), 0) AS FA_Umsatz,
						ISNULL((
							SELECT TOP 1
								SUM(RES) AS umsatzProv
							FROM
							(
								SELECT 
									dbo.DATA0006.RKEY AS D0006_PTR,
									(
										CASE 
											WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
												ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
												/ 
												dbo.DATA0060.EXCH_RATE 
											ELSE
												dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
										END --ELP_Preis_EUR
										*
										dbo.DATA0052.QUAN_SHP --AS gesendet_FA
										*
										(dbo.DATA0509.SALES_COMMISSION_PER/100)
									) AS RES
								FROM         dbo.DATA0006 INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
													  dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
													  dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR
								WHERE
									(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							) AS tblFAUmsatzProv
							WHERE D0006_PTR = D6_PTR 
						), 0) AS FA_Umsatz_VertProvision,
						tblNachKalk_Daten.EK_Handel_Masslam_HauptFA AS EKHandelNasslamFA,
						tblNachKalk_Daten.Matko_EK,
						tblNachKalk_Daten.Matko_GK + tblNachKalk_Daten.Matko_So AS Matko_GK_SO,
						tblNachKalk_Daten.Matko_GK,
						tblNachKalk_Daten.Matko_So,
						tblNachKalk_Daten.Fremd_EK,
						tblNachKalk_Daten.Pers_etc,
						tblNachKalk_Daten.Kosten_Uml,
						ISNULL((SELECT TOP 1 QTY_ALLOC AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_reserviert,
						ISNULL((
								SELECT TOP 1
									SUM(RES) AS LBEur
								FROM
								(
									SELECT DISTINCT
										dbo.DATA0053.RKEY,
										(dbo.DATA0060.PART_PRICE/dbo.DATA0060.EXCH_RATE*dbo.DATA0053.QTY_ALLOC) AS RES
										--SUM(dbo.DATA0053.QTY_ALLOC) AS RES
									FROM         dbo.DATA0060 INNER JOIN
														  dbo.DATA0063 ON dbo.DATA0060.RKEY = dbo.DATA0063.SO_PTR INNER JOIN
														  dbo.DATA0053 ON dbo.DATA0063.PART_BATCH_PTR = dbo.DATA0053.RKEY
									WHERE dbo.DATA0053.WORK_ORDER_PTR = D6_PTR 
								) AS tblLBEur
						), 0) AS LB_in_EUR,
						ISNULL((SELECT TOP 1 (QTY_ON_HAND - QTY_ALLOC) AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_freiLB,
						tblNachKalk_Daten.Aus_in_Proz,
						ISNULL((
							SELECT TOP 1
								SUM(ELP_Preis_EUR*gesendet_FA)/SUM(gesendet_FA) AS umsatz
							FROM
							(
								SELECT DISTINCT
									dbo.DATA0006.ACT_COMPL_DATE,
									dbo.DATA0050.RKEY AS D0050_PTR,
									--dbo.DATA0006.RKEY AS D0006_PTR,
									CASE 
										WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
											ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
											* 
											dbo.DATA0060.EXCH_RATE 
										ELSE
											dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
									END AS ELP_Preis_EUR,
									dbo.DATA0052.QUAN_SHP AS gesendet_FA

								FROM         dbo.DATA0006 INNER JOIN
														dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
														dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
														dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
														dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
														dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
														dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
														dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
														dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
							) AS tblFAUmsatz
							WHERE 
								D0050_PTR = tblNachKalk_Daten.D50_PTR
								AND (ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							--WHERE D0006_PTR = D6_PTR 
						), 
							(
								SELECT TOP 1 (dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE) AS RES 
								FROM dbo.DATA0054 INNER JOIN  dbo.DATA0060 ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY 
								WHERE dbo.DATA0060.CUST_PART_PTR = tblNachKalk_Daten.D50_PTR
							)
						) AS ELP_gesend_gewDP,
						tblNachKalk_Daten.FAkomplAm,
						tblNachKalk_Daten.ArtikelCode

					FROM
						LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
					WHERE 
						tblNachKalk_Daten.FAkomplAm >= CONVERT(DATETIME, @para6, 103)
						AND tblNachKalk_Daten.FAkomplAm <= CONVERT(DATETIME, @para7, 103)
						AND tblNachKalk_Daten.Aufbereitung = @para1
						AND tblNachKalk_Daten.D10_PTR IN (SELECT D10_PTR FROM @tblD10Kunden)
						AND tblNachKalk_Daten.D50_PTR IN (SELECT D50_PTR FROM @tblD50Kunden)
						AND tblNachKalk_Daten.D8_PTR IN (SELECT D8_PTR FROM @tblD8Kunden)
				) AS tblDaten
			) AS tblDatenGrp 
			WHERE 
				InternMasslamHandel IN (ISNULL(@para8, ''), ISNULL(@para9, ''), ISNULL(@para10, ''))
			GROUP BY
				D10_PTR,
				Kunde, 
				LP,
				PC
		) AS tblKundeGrupp
		GROUP BY
			D10_PTR,
			Kunde
	END

	IF @Case_ = 'NachKalk_Berichte_PCgruppiert'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255),
			@para7 varchar(255),
			@para8 varchar(255),
			@para9 varchar(255),
			@para10 varchar(255)
		SET @para1 = 'Handel 2015 2'
		SET @para2 = '74, 492' --Kunde
		SET @para3 = '39223, 33339' --Kundenteil
		SET @para4 = '-1' --PC
		--SET @para5 = ''Intern', 'Masslam', 'Handel''
		SET @para6 = '01.01.2015'
		SET @para7 = '31.12.2015'
		SET @para8 = 'Intern'
		SET @para9 = 'Masslam'
		SET @para10 = 'Handel'
		*/

		DECLARE 
			@InsertSQLPC varchar(1000)

		--Kunde
		DECLARE @tblD10PC table(D10_PTR NUMERIC(10, 0))
		IF @para2<>'-1'
		BEGIN
			SET @InsertSQLPC = '
								--INSERT @tblD10(D10_PTR)
								SELECT DISTINCT
									D10_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
								WHERE
									tblNachKalk_Daten.D10_PTR IN (' + RTRIM(@para2) + ')
							'
							INSERT @tblD10PC(D10_PTR) EXECUTE(@InsertSQLPC)
		END
		ELSE
		BEGIN
			INSERT @tblD10PC(D10_PTR)
			SELECT DISTINCT
				D10_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
		END

		--Kundenteil
		DECLARE @tblD50PC table(D50_PTR NUMERIC(10, 0))
		IF @para3<>'-1'
		BEGIN
			SET @InsertSQLPC = '
								--INSERT @tblD50(D50_PTR)
								SELECT DISTINCT
									D50_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
								WHERE
									tblNachKalk_Daten.D50_PTR IN (' + RTRIM(@para3) + ')
							'
							INSERT @tblD50PC(D50_PTR) EXECUTE(@InsertSQLPC)
		END
		ELSE
		BEGIN
			INSERT @tblD50PC(D50_PTR)
			SELECT DISTINCT
				D50_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
		END

		--PC
		DECLARE @tblD8PC table(D8_PTR NUMERIC(10, 0))
		IF @para4<>'-1'
		BEGIN
			SET @InsertSQLPC = '
								--INSERT @tblD8(D8_PTR)
								SELECT DISTINCT
									D8_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
								WHERE
									tblNachKalk_Daten.D8_PTR IN (' + RTRIM(@para4) + ')
							'
							INSERT @tblD8PC(D8_PTR) EXECUTE(@InsertSQLPC)
		END
		ELSE
		BEGIN
			INSERT @tblD8PC(D8_PTR)
			SELECT DISTINCT
				D8_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
		END

		--Lastschriften
		DECLARE @tblLSPC table(LS VARCHAR(9), LSBetrag FLOAT)
		INSERT @tblLSPC(LS, LSBetrag) SELECT '41333.301' AS LS, 1823 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '53136.300' AS LS, 1286 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '50735.300' AS LS, 4694 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '51712.302' AS LS, 584 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '52247.300' AS LS, 4625 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '34844.202' AS LS, 1853 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '49037.300' AS LS, 316 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '52395.300' AS LS, 1827 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '46660.301' AS LS, 5086 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '46861.301' AS LS, 704 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '51915.300' AS LS, 533 AS LSBetrag


		SELECT
			ISNULL((
				SELECT TOP 1
					COUNT(DISTINCT D10_PTR) AS RES
				FROM
					LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
				WHERE 
					tblNachKalk_Daten.FAkomplAm >= CONVERT(DATETIME, @para6, 103)
					AND tblNachKalk_Daten.FAkomplAm <= CONVERT(DATETIME, @para7, 103)
					AND tblNachKalk_Daten.Aufbereitung = @para1
					AND tblNachKalk_Daten.D10_PTR IN (SELECT D10_PTR FROM @tblD10PC)
					AND tblNachKalk_Daten.D50_PTR IN (SELECT D50_PTR FROM @tblD50PC)
					AND tblNachKalk_Daten.D8_PTR IN (SELECT D8_PTR FROM @tblD8PC)
			), 0) AS Summenzeile_AnzKunden,
			COUNT(DISTINCT Kunde) AS AnzKunden,
			COUNT(DISTINCT LP) AS AnzLP,
			MAX(AnzKommissionen) AS AnzKommissionen,
			MAX(Kommission) AS Kommission,
			SUM(AnzFA) AS AnzFA,
			PC,
			MAX(ELP_gesend_gewDP) AS ELP_gesend_gewDP,
			SUM(FA_Umsatz) AS FA_Umsatz_ohneGutschrift,
			SUM(LB_in_EUR) AS LB_in_EUR,
			SUM(EKHandelNasslamFA_EUR) AS EKHandelNasslamFA_EUR,
			SUM(Matko_EK_EUR) AS Matko_EK_EUR,
			SUM(Matko_GK_SO_EUR) AS Matko_GK_SO_EUR,
			SUM(Matko_GK) AS Matko_GK,
			SUM(Matko_So) AS Matko_So,
			SUM(Fremd_EK_EUR) AS Fremd_EK_EUR,
			SUM(Pers_etc_EUR) AS Pers_etc_EUR,
			SUM(Kosten_Uml_EUR) AS Kosten_Uml_EUR,
			SUM(ELP_freiLB) AS ELP_freiLB,
			SUM(ELP_reserviert) AS ELP_reserviert,
			MAX(FAkomplAm) AS FAkomplAm,
			MAX(ArtikelCode) AS ArtikelCode,
			SUM(Lastschrift_EUR) AS Lastschrift_EUR,
			SUM(LastschriftNebenkosten_EUR) AS LastschriftNebenkosten_EUR,
			SUM(LastschriftSonstiges_EUR) AS LastschriftSonstiges_EUR,
			SUM(LastschriftRest_EUR) AS LastschriftRest_EUR,
			SUM(SonstigeLastschrift_EUR) AS SonstigeLastschrift_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Einkauf (BM, CU, PP, PCB, Masslam)
			SUM(NKEinkauf_EUR) AS NKEinkauf_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Gutschriften
			SUM(Gutschrift_EUR) AS Gutschrift_EUR,
			SUM(GutschriftNebenkosten_EUR) AS GutschriftNebenkosten_EUR,		
			SUM(GutschriftMenge) AS GutschriftMenge,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Provision
			MAX(ProvisionVerteter) AS ProvisionVerteter,
			SUM(VerkaufProvision_EUR) AS VerkaufProvision_EUR,
			SUM(GutschriftProvision_EUR) AS GutschriftProvision_EUR,
			AVG(ProvisionVerteterProzent) AS ProvisionVerteterProzent,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Produktion
			SUM(Aufgelegt) AS Aufgelegt,
			SUM(Ausschuss) AS Ausschuss,
			SUM(Produziert) AS Produziert,
			AVG(Ausschuss_Proz) AS Ausschuss_Proz,
			SUM(LPKonsi) AS LPKonsi,
			SUM(LPKonsi_EUR)  AS LPKonsi_EUR,
			SUM(Durch_VK_dm2) AS Durch_VK_dm2,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Verkauf
			SUM(LMenge) AS LMenge,
			SUM(NKVerkauf_EUR) AS NKVerkauf_EUR,
			SUM(RabattVerkauf_EUR) AS RabattVerkauf_EUR,
			SUM(EZVerkauf_EUR) AS EZVerkauf_EUR,
			SUM(VersandVerkauf_EUR) AS VersandVerkauf_EUR,
			SUM(FA_Umsatz) AS FA_Umsatz,
			SUM(Frachtkosten_EUR) AS Frachtkosten_EUR,
			SUM(GesamtVerkaufsmenge) AS GesamtVerkaufsmenge
		FROM
		(
			SELECT
				Kunde,
				LP,
				MAX(AnzKommissionen) AS AnzKommissionen,
				MAX(Kommission) AS Kommission,
				COUNT(FA) AS AnzFA,
				PC,
				MAX(ELP_gesend_gewDP) AS ELP_gesend_gewDP,
				SUM(FA_Umsatz) AS FA_Umsatz_ohneGutschrift,
				SUM(LB_in_EUR) AS LB_in_EUR,
				SUM(EKHandelNasslamFA) AS EKHandelNasslamFA_EUR,
				SUM(Matko_EK) AS Matko_EK_EUR,
				SUM(Matko_GK_SO) AS Matko_GK_SO_EUR,
				SUM(Matko_GK) AS Matko_GK,
				SUM(Matko_So) AS Matko_So,
				SUM(Fremd_EK) AS Fremd_EK_EUR,
				SUM(Pers_etc) AS Pers_etc_EUR,
				SUM(Kosten_Uml) AS Kosten_Uml_EUR,
				SUM(FA_freiLB) AS ELP_freiLB,
				SUM(FA_reserviert) AS ELP_reserviert,
				MAX(FAkomplAm) AS FAkomplAm,
				MAX(ArtikelCode) AS ArtikelCode,

				------------------------------------------------------------------------
				--Lastschriften
				ISNULL((
						SELECT TOP 1
							SUM(Lastschriften) 
							+
							ISNULL((SELECT TOP 1 LSBetrag FROM @tblLSPC AS tblLSPC WHERE LS COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(LP))), 0)
							AS Lastschrift_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0132.RKEY, 
								((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE) AS Lastschriften

							FROM         dbo.DATA0132 INNER JOIN
										dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
										dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
										dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

							WHERE      
										RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriften						
				), 0) AS Lastschrift_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(NK) AS LastschriftNK_EUR
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0132.RKEY,
								dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS NK
							FROM         dbo.DATA0199 INNER JOIN
													dbo.DATA0212 INNER JOIN
													dbo.DATA0132 INNER JOIN
													dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
													dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
													dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
													dbo.DATA0071 INNER JOIN
													dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
							WHERE     
										RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Nebenkosten Handel')
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriftenNebenkosten					
				), 0) AS LastschriftNebenkosten_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(Sonstiges) AS LastschriftSonstiges_EUR
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0132.RKEY,
								dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Sonstiges
							FROM         dbo.DATA0199 INNER JOIN
													dbo.DATA0212 INNER JOIN
													dbo.DATA0132 INNER JOIN
													dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
													dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
													dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
													dbo.DATA0071 INNER JOIN
													dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
							WHERE     
										RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Sonstiges')
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriftenSonstiges					
				), 0) AS LastschriftSonstiges_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(Rest) AS LastschriftRest_EUR
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0132.RKEY,
								dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Rest
							FROM         dbo.DATA0199 INNER JOIN
													dbo.DATA0212 INNER JOIN
													dbo.DATA0132 INNER JOIN
													dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
													dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
													dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
													dbo.DATA0071 INNER JOIN
													dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
							WHERE     
										RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										AND dbo.DATA0199.MISC_CHARGE_CATEGORY NOT IN ('Sonstiges', 'Nebenkosten Handel')
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriftenRest						
				), 0) AS LastschriftRest_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(NKLastschriften) AS NKLastschrift_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0132.RKEY, 
								(dbo.DATA0132.MISC_TOT / dbo.DATA0132.EX_RATE) AS NKLastschriften

							FROM         dbo.DATA0132 INNER JOIN
										dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
										dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
										dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

							WHERE      
										RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblNKLastschriften						
				), 0) AS SonstigeLastschrift_EUR,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Einkauf (BM, CU, PP, PCB, Masslam)
				ISNULL(( 
					SELECT
						SUM(NK) AS NKEinkauf
					FROM
					(
						SELECT DISTINCT 
							D107_.RKEY,
							(D107_.SHIPPING + D107_.MISC_TOT) / D107_.EX_RATE  AS NK
						FROM         dbo.DATA0070 AS D70_ INNER JOIN
											dbo.DATA0071 AS D71_ ON D70_.RKEY = D71_.PO_PTR INNER JOIN
											dbo.DATA0108 AS D108_ ON D71_.RKEY = D108_.DATA0071_PTR INNER JOIN
											dbo.DATA0107 AS D107_ ON D108_.DATA0107_PTR = D107_.RKEY INNER JOIN
											dbo.DATA0017 AS D17_ ON D71_.INVT_PTR = D17_.RKEY
						WHERE
							RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
							AND (D107_.INV_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (D107_.INV_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblNKEinkauf_
				), 0) AS NKEinkauf_EUR,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Gutschriften
				/*
				ISNULL((
					SELECT
						SUM(Gutschrift) AS Gutschrift_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0116.RKEY,
							(dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE AS Gutschrift
						FROM         dbo.DATA0060 INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
											  dbo.DATA0116 INNER JOIN
											  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschrift	
				), 0) AS Gutschrift_EUR,	
				*/
				ISNULL((
					SELECT
						SUM(BetragNetto) AS Gutschrift_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0116.RKEY,
							dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY) AS BetragNetto
						FROM         dbo.DATA0116 INNER JOIN
								  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
								  dbo.DATA0060 INNER JOIN
								  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschrift	
				), 0) AS Gutschrift_EUR,
				ISNULL((
					SELECT
						SUM(GSNK) AS GutschriftNK_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0116.RKEY,
							(
								((dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE)
								-
								(dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY)) 
							) AS GSNK
						FROM         dbo.DATA0116 INNER JOIN
								  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
								  dbo.DATA0060 INNER JOIN
								  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftNK
				), 0) AS GutschriftNebenkosten_EUR,		
				ISNULL((
					SELECT
						SUM(RMenge) AS GutschriftMenge
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0098.RKEY,
							dbo.DATA0098.QTY_AUTH AS RMenge
						FROM         
							dbo.DATA0098 
						WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftMenge
				), 0) AS GutschriftMenge,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Provision
				ISNULL((
					SELECT TOP 1
						dbo.DATA0009.SALES_REP_NAME
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
											dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
											dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
											dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
					WHERE
						dbo.DATA0050.RKEY = MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
				), '') AS ProvisionVerteter,
				SUM(FA_Umsatz_VertProvision) AS VerkaufProvision_EUR,
				ISNULL((
					SELECT
						SUM(Provision) AS GutschriftNK_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0116.RKEY,
							ISNULL(dbo.DATA0509.COMMISSION_DEBITED / dbo.DATA0509.EXCHANGE_RATE, 0) AS Provision
						FROM         dbo.DATA0125 INNER JOIN
											  dbo.DATA0509 ON dbo.DATA0125.DATA0509_PTR = dbo.DATA0509.RKEY RIGHT OUTER JOIN
											  dbo.DATA0116 INNER JOIN
											  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
											  dbo.DATA0060 INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY ON 
											  dbo.DATA0125.MEMO_PTR = dbo.DATA0116.RKEY LEFT OUTER JOIN
											  dbo.DATA0508 INNER JOIN
											  dbo.DATA0061 ON dbo.DATA0508.DATA0061_PTR = dbo.DATA0061.RKEY INNER JOIN
											  dbo.DATA0124 ON dbo.DATA0508.RKEY = dbo.DATA0124.DATA0508_PTR ON dbo.DATA0116.RKEY = dbo.DATA0124.MEMO_PTR
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftNK
				), 0) AS GutschriftProvision_EUR,
				ISNULL((
					SELECT TOP 1
						dbo.DATA0009.COMMISSION_1
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
											dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
											dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
											dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
					WHERE
						dbo.DATA0050.RKEY = MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
				), 0)/100 AS ProvisionVerteterProzent,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Produktion
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_SCH) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_SCH
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAufgelegt
				), 0) AS Aufgelegt,
				ISNULL((
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_REJ) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_REJ 
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) <> 'R'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblAusschuss
					), 0)
					+
					ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
						SELECT
							SUM(RMenge) AS GutschriftMenge
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0098.RKEY,
								dbo.DATA0098.QTY_AUTH AS RMenge
							FROM         
								dbo.DATA0098 
							WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
									AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblGutschriftMenge
					), 0)
					-
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_PROD) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_PROD
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblProduziert
					), 0)
				), 0) AS Ausschuss,
				ISNULL((
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_PROD) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_PROD
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblProduziert
					), 0)
					-
					ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
						SELECT
							SUM(RMenge) AS GutschriftMenge
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0098.RKEY,
								dbo.DATA0098.QTY_AUTH AS RMenge
							FROM         
								dbo.DATA0098 
							WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
									AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblGutschriftMenge
					), 0)
					-
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_REJ) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_REJ
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='W'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblAusschuss_R
					), 0)
					+
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_PROD) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_PROD
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblProduziert
					), 0)
				), 0) AS Produziert,
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_REJ)/SUM(QUAN_SCH) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_REJ,
							dbo.DATA0006.QUAN_SCH
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAusschuss
				), 0) AS Ausschuss_Proz,
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND) AS LPKonsi_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND
							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				), 0) AS LPKonsi,
				/*
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND) AS LPKonsi_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND
							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				), 0) * MAX(ELP_gesend_gewDP)  AS LPKonsi_EUR,
				*/
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND*LAST_SO_PRICE) AS LPKonsi_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND,
								dbo.DATA0050.LAST_SO_PRICE
							--FROM         dbo.DATA0006 INNER JOIN
							--						dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							FROM         dbo.DATA0006 INNER JOIN
												  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				--), 0) * MAX(ELP_gesend_gewDP)  AS LPKonsi_EUR,
				), 0)  AS LPKonsi_EUR,
				ISNULL((
					SELECT TOP 1
						SUM(gesendet_FA * KNX * KNY / ELP_KN / 10000) AS RES
					FROM
					(
						SELECT 
							dbo.ARTIKELDATEN.*,
							dbo.DATA0050.RKEY AS D0050_PTR,
							CASE 
								WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
									ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
									* 
									dbo.DATA0060.EXCH_RATE 
								ELSE
									dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
							END AS ELP_Preis_EUR,
							dbo.DATA0052.QUAN_SHP AS gesendet_FA

						FROM         dbo.DATA0006 INNER JOIN
												dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
												dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
												dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
												dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
												dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
												dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE
							(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblFAUmsatz
					WHERE D0050_PTR = MAX(D50_PTR) 
				), 0) AS Durch_VK_dm2,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Verkauf
				ISNULL((
					SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				), 0) AS LMenge,
				ISNULL((
					SELECT
						SUM(NK) AS NKVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.TOOLING_CHARGES AS NK
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblNKVerkauf
				), 0) AS NKVerkauf_EUR,
				ISNULL((
					SELECT
						SUM(Rabatt) AS RabattVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.DISCOUNT_AMOUNT AS Rabatt
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblRabattVerkauf
				), 0) AS RabattVerkauf_EUR,
				ISNULL((
					SELECT
						SUM(Einzuschlag) AS EZVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.RUSH_CHARGE_AMOUNT AS Einzuschlag
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblEZVerkauf
				), 0) AS EZVerkauf_EUR,
				ISNULL((
					SELECT
						SUM(Versandkosten) AS VersandVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.SHIPPING_CHARGES AS Versandkosten
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblVersandVerkauf
				), 0) AS VersandVerkauf_EUR,

				(
					SUM(FA_Umsatz)
					-
					ISNULL((
						SELECT TOP 1 
							SUM(Gutschrift) AS Gutschrift_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0116.RKEY,
								dbo.DATA0116.CREDIT_AMOUNT/dbo.DATA0116.EX_RATE - dbo.DATA0116.STATE_TAX AS Gutschrift
							FROM         dbo.DATA0060 INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
												  dbo.DATA0116 INNER JOIN
												  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
							WHERE     (dbo.DATA0060.CUST_PART_PTR = MAX(D50_PTR))
									AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblGutschrift	
					), 0)
				) AS FA_Umsatz,
				ISNULL((
					SELECT TOP 1
						--SUM(FK) AS FK1,
						SUM(FK/CASE WHEN PlusZeichen_1=0 THEN 1 ELSE CASE WHEN PlusZeichen_1>0 AND PlusZeichen_2=0 THEN 2 ELSE 3 END END) AS FK_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0072.RKEY,
							dbo.DATA0072.DESCRIPTION2 AS LP,
							(dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE * dbo.DATA0072.QUAN_ORD) AS FK,
							CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 1) AS PlusZeichen_1,
							CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 21) AS PlusZeichen_2
						FROM         dbo.DATA0070 INNER JOIN
											  dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR
						WHERE
							LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION, '')), 3) = 'FK '
							AND LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION2, '')), 3) = 'LP '
							AND dbo.DATA0072.DESCRIPTION2 COLLATE SQL_Latin1_General_CP1_CI_AS LIKE '%' + LTRIM(RTRIM(LP)) + '%' 
							AND (dbo.DATA0070.PO_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0070.PO_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblFK
				), 0) AS Frachtkosten_EUR,
				ISNULL((
					ISNULL(SUM(FA_reserviert), 0)
					+
					ISNULL((
						SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
						FROM         dbo.DATA0006 INNER JOIN
												dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					), 0) 
				), 0) AS GesamtVerkaufsmenge
				------------------------------------------------------------------------
				------------------------------------------------------------------------

			FROM
			(
				SELECT
					tblDaten.*
					--CAST(ELP_gesend_gewDP*FA_reserviert AS FLOAT) AS LB_in_EUR
				FROM
				(
					SELECT
						tblNachKalk_Daten.Kunde,
						tblNachKalk_Daten.Aufbereitung,
						tblNachKalk_Daten.LP,
						tblNachKalk_Daten.D50_PTR,
						tblNachKalk_Daten.D60_PTR,
						CASE
							WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)=1 THEN 
								'Intern'
							ELSE
								CASE
									WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)=2 THEN 
										'Masslam'
									ELSE
										CASE
											WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)=3 THEN 
												'Handel'
											ELSE
												'unbekannt'
										END
								END
						END AS InternMasslamHandel,
						tblNachKalk_Daten.PC,
						tblNachKalk_Daten.AnzKommissionen,
						tblNachKalk_Daten.Kommission,
						tblNachKalk_Daten.FA,
						ISNULL((
							SELECT TOP 1
								SUM(RES) AS umsatz
							FROM
							(
								SELECT 
									dbo.DATA0006.RKEY AS D0006_PTR,
									(
										CASE 
											WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
												ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
												/ 
												dbo.DATA0060.EXCH_RATE 
											ELSE
												dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
										END --ELP_Preis_EUR
										*
										dbo.DATA0052.QUAN_SHP --AS gesendet_FA
									) AS RES
								FROM         dbo.DATA0006 INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
								WHERE
									(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							) AS tblFAUmsatz
							WHERE 
								D0006_PTR = D6_PTR 
								--D0006_PTR = CASE WHEN LEFT(tblNachKalk_Daten.FA, 1)='S' THEN tblNachKalk_Daten.D6S_PTR ELSE tblNachKalk_Daten.D6_PTR END
						), 0) AS FA_Umsatz,
						ISNULL((
							SELECT TOP 1
								SUM(RES) AS umsatzProv
							FROM
							(
								SELECT 
									dbo.DATA0006.RKEY AS D0006_PTR,
									(
										CASE 
											WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
												ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
												/ 
												dbo.DATA0060.EXCH_RATE 
											ELSE
												dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
										END --ELP_Preis_EUR
										*
										dbo.DATA0052.QUAN_SHP --AS gesendet_FA
										*
										(dbo.DATA0509.SALES_COMMISSION_PER/100)
									) AS RES
								FROM         dbo.DATA0006 INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
													  dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
													  dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR
								WHERE
									(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							) AS tblFAUmsatzProv
							WHERE D0006_PTR = D6_PTR 
						), 0) AS FA_Umsatz_VertProvision,
						tblNachKalk_Daten.EK_Handel_Masslam_HauptFA AS EKHandelNasslamFA,
						tblNachKalk_Daten.Matko_EK,
						tblNachKalk_Daten.Matko_GK + tblNachKalk_Daten.Matko_So AS Matko_GK_SO,
						tblNachKalk_Daten.Matko_GK,
						tblNachKalk_Daten.Matko_So,
						tblNachKalk_Daten.Fremd_EK,
						tblNachKalk_Daten.Pers_etc,
						tblNachKalk_Daten.Kosten_Uml,
						ISNULL((SELECT TOP 1 QTY_ALLOC AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_reserviert,
						ISNULL((
								SELECT TOP 1
									SUM(RES) AS LBEur
								FROM
								(
									SELECT DISTINCT
										dbo.DATA0053.RKEY,
										(dbo.DATA0060.PART_PRICE/dbo.DATA0060.EXCH_RATE*dbo.DATA0053.QTY_ALLOC) AS RES
										--SUM(dbo.DATA0053.QTY_ALLOC) AS RES
									FROM         dbo.DATA0060 INNER JOIN
														  dbo.DATA0063 ON dbo.DATA0060.RKEY = dbo.DATA0063.SO_PTR INNER JOIN
														  dbo.DATA0053 ON dbo.DATA0063.PART_BATCH_PTR = dbo.DATA0053.RKEY
									WHERE dbo.DATA0053.WORK_ORDER_PTR = D6_PTR 
								) AS tblLBEur
						), 0) AS LB_in_EUR,
						ISNULL((SELECT TOP 1 (QTY_ON_HAND - QTY_ALLOC) AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_freiLB,
						tblNachKalk_Daten.Aus_in_Proz,
						ISNULL((
							SELECT TOP 1
								SUM(ELP_Preis_EUR*gesendet_FA)/SUM(gesendet_FA) AS umsatz
							FROM
							(
								SELECT DISTINCT
									dbo.DATA0006.ACT_COMPL_DATE,
									dbo.DATA0050.RKEY AS D0050_PTR,
									--dbo.DATA0006.RKEY AS D0006_PTR,
									CASE 
										WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
											ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
											* 
											dbo.DATA0060.EXCH_RATE 
										ELSE
											dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
									END AS ELP_Preis_EUR,
									dbo.DATA0052.QUAN_SHP AS gesendet_FA

								FROM         dbo.DATA0006 INNER JOIN
														dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
														dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
														dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
														dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
														dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
														dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
														dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
														dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
							) AS tblFAUmsatz
							WHERE 
								D0050_PTR = tblNachKalk_Daten.D50_PTR
								AND (ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							--WHERE D0006_PTR = D6_PTR 
						), 
							(
								SELECT TOP 1 (dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE) AS RES 
								FROM dbo.DATA0054 INNER JOIN  dbo.DATA0060 ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY 
								WHERE dbo.DATA0060.CUST_PART_PTR = tblNachKalk_Daten.D50_PTR
							)
						) AS ELP_gesend_gewDP,
						tblNachKalk_Daten.FAkomplAm,
						tblNachKalk_Daten.ArtikelCode

					FROM
						LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
					WHERE 
						tblNachKalk_Daten.FAkomplAm >= CONVERT(DATETIME, @para6, 103)
						AND tblNachKalk_Daten.FAkomplAm <= CONVERT(DATETIME, @para7, 103)
						AND tblNachKalk_Daten.Aufbereitung = @para1
						AND tblNachKalk_Daten.D10_PTR IN (SELECT D10_PTR FROM @tblD10PC)
						AND tblNachKalk_Daten.D50_PTR IN (SELECT D50_PTR FROM @tblD50PC)
						AND tblNachKalk_Daten.D8_PTR IN (SELECT D8_PTR FROM @tblD8PC)
				) AS tblDaten
			) AS tblDatenGrp 
			WHERE 
				InternMasslamHandel IN (ISNULL(@para8, ''), ISNULL(@para9, ''), ISNULL(@para10, ''))
			GROUP BY
				Kunde, 
				LP,
				PC
		) AS tblPCGrupp
		GROUP BY
			PC
	END
END
