USE [LIVE]
GO
/****** Object:  StoredProcedure [dbo].[GGP_SP_NachKalkBerichte_2]    Script Date: 22.12.2017 11:59:32 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		D.S.Simic
-- Create date: 25.03.2016
-- Change date: 25.03.2016
-- Description:	Wird bei der Nachkalkulation verwendet
-- =============================================
ALTER PROCEDURE [dbo].[GGP_SP_NachKalkBerichte_2]
	@p_Case_ varchar(255) = '',
	@p_para1 varchar(255) = '',
	@p_para2 varchar(255) = '',
	@p_para3 varchar(255) = '',
	@p_para4 varchar(255) = '',
	@p_para5 varchar(255) = '',
	@p_para6 varchar(255) = '',
	@p_para7 varchar(255) = '',
	@p_para8 varchar(255) = '',
	@p_para9 varchar(2000) = '',
	@p_para10 varchar(2000) = '',
	@p_para11 varchar(255) = '',
	@p_para12 varchar(255) = '',
	@OUTPUT_RES AS varchar(1000) = '' OUTPUT
AS
BEGIN

	DECLARE
		@Case_ varchar(255) = '',
		@para1 varchar(255) = '',
		@para2 varchar(255) = '',
		@para3 varchar(255) = '',
		@para4 varchar(255) = '',
		@para5 varchar(255) = '',
		@para6 varchar(255) = '',
		@para7 varchar(255) = '',
		@para8 varchar(255) = '',
		@para9 varchar(2000) = '',
		@para10 varchar(2000) = '',
		@para11 varchar(255) = '',
		@para12 varchar(255) = ''

		SET @Case_ = @p_Case_
		SET @para1 = @p_para1
		SET @para2 = @p_para2
		SET @para3 = @p_para3
		SET @para4 = @p_para4
		SET @para5 = @p_para5
		SET @para6 = @p_para6
		SET @para7 = @p_para7
		SET @para8 = @p_para8
		SET @para9 = @p_para9
		SET @para10 = @p_para10
		SET @para11 = @p_para11
		SET @para12 = @p_para12

	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;



	IF @Case_ = 'Lieferhistorie'
	BEGIN
		SELECT
			*
		FROM
		(
			SELECT  
				'Lieferung' AS Vorgang,
				dbo.DATA0006.WORK_ORDER_NUMBER AS FA,
				dbo.DATA0052.QUAN_SHP AS Menge, 
				dbo.DATA0064.DATE_SHIPPED AS Datum,
				CASE 
					WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
						ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
						* 
						dbo.DATA0060.EXCH_RATE 
					ELSE
						dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
				END AS ELP_Preis_EUR, 
				dbo.DATA0060.SALES_ORDER AS Kommission,
				ISNULL((
					SELECT TOP 1
						ISNULL(SUM(Materialkosten)/SUM(Menge), 0) AS RES
					FROM
					(
						SELECT
							dbo.DATA0006.RKEY AS D6_PTR_MatKosten,
							(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH) AS Menge,
							ISNULL((
								SELECT TOP 1
									CASE
										WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN 
											(dbo.DATA0108.PRICE/dbo.DATA0107.EX_RATE)*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
										ELSE
											CASE
												WHEN ISNULL(dbo.DATA0108.PRICE, 0)>0 THEN 
													(dbo.DATA0071.PRICE/dbo.DATA0070.EXCHANGE_RATE)*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
												ELSE
													dbo.DATA0017.ACTUAL_COST*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH)
											END
									END
								FROM         dbo.DATA0107 INNER JOIN
														dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
														dbo.DATA0070 INNER JOIN
														dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
								WHERE     (dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR) 
							), (dbo.DATA0017.ACTUAL_COST*(dbo.DATA0095.QUANTITY*dbo.DATA0017.STOCK_PURCH))) AS Materialkosten 
						FROM         dbo.DATA0095 INNER JOIN
												dbo.DATA0067 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0067.RKEY INNER JOIN
												dbo.DATA0006 AS D6 ON dbo.DATA0067.WO_PTR = D6.RKEY INNER JOIN
												dbo.DATA0020 ON dbo.DATA0095.INVT_LOC_PTR = dbo.DATA0020.RKEY INNER JOIN
												dbo.DATA0017 ON dbo.DATA0020.INVENTORY_POINTER = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
						WHERE     (dbo.DATA0095.TRAN_TP = 13 OR dbo.DATA0095.TRAN_TP = 14) AND (dbo.DATA0017.TTYPE = 'R' OR
												dbo.DATA0017.TTYPE = 'M') AND (D6.WORK_ORDER_NUMBER LIKE REPLACE(dbo.DATA0006.WORK_ORDER_NUMBER, '000', '%')) --@para1 ) --'  -086881-01%') -- = 147320)
											AND ISNULL(dbo.DATA0020.BATCH_NO, '')<>''

						UNION ALL

						SELECT
							dbo.DATA0006.RKEY AS D6_PTR_MatKosten, 
							dbo.DATA0341.QUANTITY AS Menge,
							ISNULL((CASE 
								WHEN ISNULL(dbo.DATA0467.PRICE, 0)>0 then
									(dbo.DATA0467.PRICE/dbo.DATA0466.EXCHANGE_RATE) * dbo.DATA0341.QUANTITY
								ELSE
									(dbo.DATA0017.ACTUAL_COST * dbo.DATA0341.QUANTITY) 
							END), 0) AS Materialkosten
						FROM         dbo.DATA0467 INNER JOIN
												dbo.DATA0466 ON dbo.DATA0467.RO_PTR = dbo.DATA0466.RKEY INNER JOIN
												dbo.DATA0002 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0002.RKEY = dbo.DATA0017.STOCK_UNIT_PTR INNER JOIN
												dbo.DATA0067 INNER JOIN
												dbo.DATA0341 ON dbo.DATA0067.RKEY = dbo.DATA0341.SRCE_PTR INNER JOIN
												dbo.DATA0006 AS D6 ON dbo.DATA0067.WO_PTR = D6.RKEY ON dbo.DATA0017.RKEY = dbo.DATA0341.DATA0017_PTR ON 
												dbo.DATA0467.RKEY = dbo.DATA0341.DATA0467_PTR
						WHERE     (dbo.DATA0341.TRAN_TP IN (4, 6)) AND (dbo.DATA0017.TTYPE = 'R' OR
												dbo.DATA0017.TTYPE = 'M') AND (D6.WORK_ORDER_NUMBER LIKE REPLACE(dbo.DATA0006.WORK_ORDER_NUMBER, '000', '%'))
									AND ISNULL(dbo.DATA0341.REFERENCE_NUMBER, '')<>''
					) AS tblMatKosten
				), 0) AS PCB_EKPreis,
				ISNULL((
						SELECT TOP 1
							ISNULL((
								SELECT TOP 1
									MAX(dbo.DATA0070.PO_NUMBER) AS RES
								FROM         dbo.DATA0107 INNER JOIN
														dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
														dbo.DATA0070 INNER JOIN
														dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
								WHERE     (dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR) 
							), '') AS PO 
						FROM         dbo.DATA0095 INNER JOIN
												dbo.DATA0067 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0067.RKEY INNER JOIN
												dbo.DATA0006 AS D6 ON dbo.DATA0067.WO_PTR = D6.RKEY INNER JOIN
												dbo.DATA0020 ON dbo.DATA0095.INVT_LOC_PTR = dbo.DATA0020.RKEY INNER JOIN
												dbo.DATA0017 ON dbo.DATA0020.INVENTORY_POINTER = dbo.DATA0017.RKEY INNER JOIN
												dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
						WHERE     (dbo.DATA0095.TRAN_TP = 13 OR dbo.DATA0095.TRAN_TP = 14) AND (dbo.DATA0017.TTYPE = 'R' OR
												dbo.DATA0017.TTYPE = 'M') AND (D6.WORK_ORDER_NUMBER LIKE REPLACE(dbo.DATA0006.WORK_ORDER_NUMBER, '000', '%')) --@para1 ) --'  -086881-01%') -- = 147320)
											AND ISNULL(dbo.DATA0020.BATCH_NO, '')<>''
				), '') AS Bestellung
			FROM         dbo.DATA0006 INNER JOIN
								  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
								  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
								  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
								  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
								  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
								  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
								  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
								  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
			WHERE     
					RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) = @para1 --'51051.300' --'  
					AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para2, 103))
					AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para3, 103))

			UNION ALL

			/*
			SELECT DISTINCT
				Vorgang,
				MAX(FA) AS FA,
				Menge, 
				Datum,
				ELP_Preis_EUR, 
				Kommission,
				PCB_EKPreis,
				Bestellung
			FROM
			(
				SELECT
					'Reklamation' AS Vorgang,
					dbo.DATA0006.WORK_ORDER_NUMBER AS FA,
					(-1)*dbo.DATA0098.QTY_AUTH AS Menge, 
					dbo.DATA0098.RMA_DATE AS Datum,
					CASE 
						WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
							ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
							* 
							dbo.DATA0060.EXCH_RATE 
						ELSE
							dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
					END AS ELP_Preis_EUR, 
					dbo.DATA0060.SALES_ORDER AS Kommission,
					0 AS PCB_EKPreis,
					ISNULL((
							SELECT TOP 1
								ISNULL((
									SELECT TOP 1
										MAX(dbo.DATA0070.PO_NUMBER) AS RES
									FROM         dbo.DATA0107 INNER JOIN
															dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
															dbo.DATA0070 INNER JOIN
															dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
									WHERE     (dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR) 
								), '') AS PO 
							FROM         dbo.DATA0095 INNER JOIN
													dbo.DATA0067 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0067.RKEY INNER JOIN
													dbo.DATA0006 AS D6 ON dbo.DATA0067.WO_PTR = D6.RKEY INNER JOIN
													dbo.DATA0020 ON dbo.DATA0095.INVT_LOC_PTR = dbo.DATA0020.RKEY INNER JOIN
													dbo.DATA0017 ON dbo.DATA0020.INVENTORY_POINTER = dbo.DATA0017.RKEY INNER JOIN
													dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
							WHERE     (dbo.DATA0095.TRAN_TP = 13 OR dbo.DATA0095.TRAN_TP = 14) AND (dbo.DATA0017.TTYPE = 'R' OR
													dbo.DATA0017.TTYPE = 'M') AND (D6.WORK_ORDER_NUMBER LIKE REPLACE(dbo.DATA0006.WORK_ORDER_NUMBER, '000', '%')) --@para1 ) --'  -086881-01%') -- = 147320)
												AND ISNULL(dbo.DATA0020.BATCH_NO, '')<>''
					), '') AS Bestellung
				FROM         dbo.DATA0098 INNER JOIN
									  dbo.DATA0050 ON dbo.DATA0098.CUSTOMER_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
									  dbo.DATA0064 ON dbo.DATA0098.SHIPMENT_PTR = dbo.DATA0064.RKEY INNER JOIN
									  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
									  dbo.DATA0052 ON dbo.DATA0064.RKEY = dbo.DATA0052.SO_SHP_PTR INNER JOIN
									  dbo.DATA0053 ON dbo.DATA0052.DATA0053_PTR = dbo.DATA0053.RKEY INNER JOIN
									  dbo.DATA0006 ON dbo.DATA0053.WORK_ORDER_PTR = dbo.DATA0006.RKEY
				WHERE     
						RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) = @para1 --'51051.300' 
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para2, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para3, 103))
		) AS tblGrp
		GROUP BY
			Vorgang,
			Menge, 
			Datum,
			ELP_Preis_EUR, 
			Kommission,
			PCB_EKPreis,
			Bestellung
		*/
		SELECT DISTINCT
			'Reklamation' AS Vorgang,
			--dbo.DATA0006.WORK_ORDER_NUMBER AS FA,
			dbo.DATA0098.RMA_NUMBER AS FA,
			(-1)*dbo.DATA0098.QTY_AUTH AS Menge, 
			dbo.DATA0098.RMA_DATE AS Datum,
			CASE 
				WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
					ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
					* 
					dbo.DATA0060.EXCH_RATE 
				ELSE
					dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
			END AS ELP_Preis_EUR, 
			dbo.DATA0060.SALES_ORDER AS Kommission,
			0 AS PCB_EKPreis,
			/*
			ISNULL((
					SELECT TOP 1
						ISNULL((
							SELECT TOP 1
								MAX(dbo.DATA0070.PO_NUMBER) AS RES
							FROM         dbo.DATA0107 INNER JOIN
													dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR RIGHT OUTER JOIN
													dbo.DATA0070 INNER JOIN
													dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
							WHERE     (dbo.DATA0071.RKEY = dbo.DATA0020.PO_PTR) 
						), '') AS PO 
					FROM         dbo.DATA0095 INNER JOIN
											dbo.DATA0067 ON dbo.DATA0095.SRCE_PTR = dbo.DATA0067.RKEY INNER JOIN
											dbo.DATA0006 AS D6 ON dbo.DATA0067.WO_PTR = D6.RKEY INNER JOIN
											dbo.DATA0020 ON dbo.DATA0095.INVT_LOC_PTR = dbo.DATA0020.RKEY INNER JOIN
											dbo.DATA0017 ON dbo.DATA0020.INVENTORY_POINTER = dbo.DATA0017.RKEY INNER JOIN
											dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
					WHERE     (dbo.DATA0095.TRAN_TP = 13 OR dbo.DATA0095.TRAN_TP = 14) AND (dbo.DATA0017.TTYPE = 'R' OR
											dbo.DATA0017.TTYPE = 'M') AND (D6.WORK_ORDER_NUMBER LIKE REPLACE(dbo.DATA0006.WORK_ORDER_NUMBER, '000', '%')) --@para1 ) --'  -086881-01%') -- = 147320)
										AND ISNULL(dbo.DATA0020.BATCH_NO, '')<>''
			), '') 
			*/
			'' AS Bestellung
		--FROM         dbo.DATA0098 INNER JOIN
		--					  dbo.DATA0050 ON dbo.DATA0098.CUSTOMER_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
		--					  dbo.DATA0064 ON dbo.DATA0098.SHIPMENT_PTR = dbo.DATA0064.RKEY INNER JOIN
		--					  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
		--					  dbo.DATA0052 ON dbo.DATA0064.RKEY = dbo.DATA0052.SO_SHP_PTR INNER JOIN
		--					  dbo.DATA0053 ON dbo.DATA0052.DATA0053_PTR = dbo.DATA0053.RKEY INNER JOIN
		--					  dbo.DATA0006 ON dbo.DATA0053.WORK_ORDER_PTR = dbo.DATA0006.RKEY
		FROM         dbo.DATA0098 INNER JOIN
								dbo.DATA0050 AS DATA0050_1 ON dbo.DATA0098.CUSTOMER_PART_PTR = DATA0050_1.RKEY INNER JOIN
								dbo.DATA0064 ON dbo.DATA0098.SHIPMENT_PTR = dbo.DATA0064.RKEY INNER JOIN
								dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY
		WHERE     
				dbo.DATA0064.RKEY IN (
										SELECT DISTINCT
											dbo.DATA0052.SO_SHP_PTR
										FROM         dbo.DATA0006 INNER JOIN
																dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
																dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
																dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
										WHERE
											RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) = @para1
											AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para2, 103))
											AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para3, 103))
									)

		UNION ALL

		SELECT DISTINCT
			'Lastschriften Gesamt' AS Vorgang,
			'LS-' + dbo.DATA0132.MEMO_NUMBER AS FA,
			0 AS Menge, 
			(dbo.DATA0132.MEMO_DATE) AS Datum,
			--0 AS ELP_Preis_EUR, 
			ISNULL((
					((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE)
					--(dbo.DATA0132.AMOUNT / dbo.DATA0132.EX_RATE)
					-
					(
						SELECT TOP 1 dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE FROM dbo.DATA0212 WHERE dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY
					)
			),0)*(-1) AS ELP_Preis_EUR,
			'' AS Kommission,
			ISNULL((
				ISNULL((
						((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE)
						--(dbo.DATA0132.AMOUNT / dbo.DATA0132.EX_RATE)
						-
						(
							SELECT TOP 1 dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE FROM dbo.DATA0212 WHERE dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY
						)
				),0)
				/
				ISNULL((
					SELECT TOP 1 
						SUM(dbo.DATA0219.QUAN_DEBITED) AS RES
					FROM         dbo.DATA0212 INNER JOIN
										  dbo.DATA0132 AS D132 INNER JOIN
										  dbo.DATA0107 ON D132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
										  dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
										  dbo.DATA0219 ON dbo.DATA0108.RKEY = dbo.DATA0219.DATA0108_PTR ON dbo.DATA0212.DEBIT_PTR = D132.RKEY LEFT OUTER JOIN
										  dbo.DATA0201 INNER JOIN
										  dbo.DATA0199 ON dbo.DATA0201.MISC_CHARGEPTR = dbo.DATA0199.RKEY ON dbo.DATA0107.RKEY = dbo.DATA0201.INVOICE_APPTR
					WHERE     (D132.RKEY = dbo.DATA0132.RKEY)
				), 1)
			), 0)*(-1) AS PCB_EKPreis,
			(dbo.DATA0070.PO_NUMBER) AS Bestellung

			FROM         dbo.DATA0132 INNER JOIN
						dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
						dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
						dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
						dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY
			WHERE      
						--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(@para1) + '%'    
						--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
						REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(@para1)) + '%'
						AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para2, 103))
						AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para3, 103))
						--AND dbo.DATA0132.MEMO_TP=1
						AND dbo.DATA0132.MEMO_TP IN (1, 6)

		) AS tblLiefHistorie
		ORDER BY 
			Datum DESC, FA DESC
	END

	/*
	IF @Case_ = 'NachKalk_Berichte_LPgruppiert'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255),
			@para7 varchar(255),
			@para8 varchar(255),
			@para9 varchar(255),
			@para10 varchar(255)
		SET @para1 = 'TEST DSI'
		SET @para2 = '-1' --Kunde
		SET @para3 = '-1' --Kundenteil
		SET @para4 = '-1' --PC
		--SET @para5 = ''Intern', 'Masslam', 'Handel''
		SET @para6 = '01.01.2015'
		SET @para7 = '31.12.2016'
		SET @para8 = 'Intern'
		SET @para9 = 'Masslam'
		SET @para10 = 'Handel'
		*/

		DECLARE 
			@InsertSQLLP varchar(1000)

		--Kunde
		DECLARE @tblD10LP table(D10_PTR NUMERIC(10, 0))
		IF @para2<>'-1'
		BEGIN
			SET @InsertSQLLP = '
								--INSERT @tblD10(D10_PTR)
								SELECT DISTINCT
									D10_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
								WHERE
									tblNachKalk_Daten_2.D10_PTR IN (' + RTRIM(@para2) + ')
							'
							INSERT @tblD10LP(D10_PTR) EXECUTE(@InsertSQLLP)
		END
		ELSE
		BEGIN
			INSERT @tblD10LP(D10_PTR)
			SELECT DISTINCT
				D10_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
		END

		--Kundenteil
		DECLARE @tblD50LP table(D50_PTR NUMERIC(10, 0))
		IF @para3<>'-1'
		BEGIN
			SET @InsertSQLLP = '
								--INSERT @tblD50(D50_PTR)
								SELECT DISTINCT
									D50_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
								WHERE
									tblNachKalk_Daten_2.D50_PTR IN (' + RTRIM(@para3) + ')
							'
							INSERT @tblD50LP(D50_PTR) EXECUTE(@InsertSQLLP)
		END
		ELSE
		BEGIN
			INSERT @tblD50LP(D50_PTR)
			SELECT DISTINCT
				D50_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
		END

		--PC
		DECLARE @tblD8LP table(D8_PTR NUMERIC(10, 0))
		IF @para4<>'-1'
		BEGIN
			SET @InsertSQLLP = '
								--INSERT @tblD8(D8_PTR)
								SELECT DISTINCT
									D8_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
								WHERE
									tblNachKalk_Daten_2.D8_PTR IN (' + RTRIM(@para4) + ')
							'
							INSERT @tblD8LP(D8_PTR) EXECUTE(@InsertSQLLP)
		END
		ELSE
		BEGIN
			INSERT @tblD8LP(D8_PTR)
			SELECT DISTINCT
				D8_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
		END

		--Lastschriften
		DECLARE @tblLSLP table(LS VARCHAR(9), LSBetrag FLOAT)
		INSERT @tblLSLP(LS, LSBetrag) SELECT '41333.301' AS LS, 1823 AS LSBetrag
		--INSERT @tblLSLP(LS, LSBetrag) SELECT '53136.300' AS LS, 1286 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '50735.300' AS LS, 4694 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '51712.302' AS LS, 584 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '52247.300' AS LS, 4625 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '34844.202' AS LS, 1853 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '49037.300' AS LS, 316 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '52395.300' AS LS, 1827 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '46660.301' AS LS, 5086 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '46861.301' AS LS, 704 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '51915.300' AS LS, 533 AS LSBetrag

		SELECT
			D10_PTR,
			Kunde,
			LP,
			--MAX(AnzKommissionen) AS AnzKommissionen,
			--MAX(Kommission) AS Kommission,
			ISNULL((
				SELECT TOP 1
					COUNT(WORK_ORDER_NUMBER) AS RES
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0006.WORK_ORDER_NUMBER
					FROM         dbo.DATA0006 --INNER JOIN
											--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND dbo.DATA0006.ROOT_PTR=0
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
						AND dbo.DATA0006.PROD_STATUS=5
				) AS tblAnzFA
			), 0) AS AnzFA,
			MAX(PC) AS PC,
			MAX(ELP_gesend_gewDP) AS ELP_gesend_gewDP,
			SUM(FA_Umsatz) AS FA_Umsatz,
			SUM(FA_Umsatz_R) AS FA_Umsatz_R,
			SUM(LB_in_EUR) AS LB_in_EUR,
			SUM(EKHandelNasslamFA) AS EKHandelNasslamFA_EUR,
			SUM(Matko_EK_HauptFA) AS Matko_EK_EUR,
			SUM(Matko_EK_IL) AS Matko_EK_IL_EUR,
			SUM(Matko_GK_SO) AS Matko_GK_SO_EUR,
			SUM(Matko_GK_SO_IL) AS Matko_GK_SO_IL_EUR,
			SUM(Matko_GK_HauptFA) AS Matko_GK,
			SUM(Matko_GK_IL) AS Matko_GK_IL,
			SUM(Matko_So_HauptFA) AS Matko_So,
			SUM(Matko_So_IL) AS Matko_So_IL,
			SUM(Fremd_EK_HauptFA) AS Fremd_EK_EUR,
			SUM(Pers_var_HauptFA)+SUM(Pers_var_IL) AS Pers_var_EUR,
			SUM(Pers_fix_HauptFA)+SUM(Pers_fix_IL) AS Pers_fix_EUR,
			SUM(Ekosten_var_HauptFA)+SUM(Ekosten_var_IL) AS Ekosten_var_EUR,
			SUM(Ekosten_fix_HauptFA)+SUM(Ekosten_fix_IL) AS Ekosten_fix_EUR,
			SUM(Leasing_var_HauptFA)+SUM(Leasing_var_IL) AS Leasing_var_EUR,
			SUM(Leasing_fix_HauptFA)+SUM(Leasing_fix_IL) AS Leasing_fix_EUR,
			SUM(Inst_var_HauptFA)+SUM(Inst_var_IL) AS Inst_var_EUR,
			SUM(Inst_fix_HauptFA)+SUM(Inst_fix_IL) AS Inst_fix_EUR,
			SUM(Sokosten_var_HauptFA)+SUM(Sokosten_var_IL) AS Sokosten_var_EUR,
			SUM(Sokosten_fix_HauptFA)+SUM(Sokosten_fix_IL) AS Sokosten_fix_EUR,
			(
				SUM(Pers_var_HauptFA) + SUM(Pers_fix_HauptFA) + SUM(Pers_var_IL) + SUM(Pers_fix_IL) 
				+ 
				SUM(Ekosten_var_HauptFA) + SUM(Ekosten_fix_HauptFA) + SUM(Ekosten_var_IL) + SUM(Ekosten_fix_IL) 
				+ 
				SUM(Leasing_var_HauptFA) + SUM(Leasing_fix_HauptFA) + SUM(Leasing_var_IL) + SUM(Leasing_fix_IL) 
				+ 
				SUM(Inst_var_HauptFA) + SUM(Inst_fix_HauptFA) + SUM(Inst_var_IL) + SUM(Inst_fix_IL)
				+ 
				SUM(Sokosten_var_HauptFA) + SUM(Sokosten_fix_HauptFA) + SUM(Sokosten_var_IL) + SUM(Sokosten_fix_IL) 
			) AS AlleKostenarten_EUR,
			(
				SUM(Pers_var_HauptFA) + SUM(Pers_var_IL) 
				+ 
				SUM(Ekosten_var_HauptFA) + SUM(Ekosten_var_IL) 
				+ 
				SUM(Leasing_var_HauptFA) + SUM(Leasing_var_IL) 
				+ 
				SUM(Inst_var_HauptFA) + SUM(Inst_var_IL) 
				+ 
				SUM(Sokosten_var_HauptFA) + SUM(Sokosten_var_IL)
			) AS AlleKostenarten_var_EUR,
			(
				SUM(Pers_fix_HauptFA) + SUM(Pers_fix_IL) 
				+ 
				SUM(Ekosten_fix_HauptFA) + SUM(Ekosten_fix_IL) 
				+ 
				SUM(Leasing_fix_HauptFA) + SUM(Leasing_fix_IL) 
				+ 
				SUM(Inst_fix_HauptFA) + SUM(Inst_fix_IL) 
				+ 
				SUM(Sokosten_fix_HauptFA) + SUM(Sokosten_fix_IL)
			) AS AlleKostenarten_fix_EUR,
			(
				SUM(EKHandelNasslamFA) + SUM(Matko_EK_HauptFA) + SUM(Matko_GK_SO) + SUM(Fremd_EK_HauptFA) + SUM(Matko_EK_IL) + SUM(Matko_GK_SO_IL) 
			) AS Materialkosten_EUR,
			--SUM(Kosten_Uml) AS Kosten_Uml_EUR,
			SUM(FA_freiLB) AS ELP_freiLB,
			SUM(FA_reserviert) AS ELP_reserviert,
			MAX(FAkomplAm) AS FAkomplAm,
			MAX(ArtikelCode) AS ArtikelCode,
			SUM(Herstellung_AnzMinuten) AS Herstellung_AnzMinuten,
			SUM(Vertriebskosten_var) AS Vertriebskosten_var,
			SUM(Vertriebskosten_fix) AS Vertriebskosten_fix,
			SUM(Verwaltungskosten_var) AS Verwaltungskosten_var,
			SUM(Verwaltungskosten_fix) AS Verwaltungskosten_fix,
			SUM(PersVertriebskosten_var) AS PersVertriebskosten_var,
			SUM(PersVertriebskosten_fix) AS PersVertriebskosten_fix,
			SUM(PersVerwaltungskosten_var) AS PersVerwaltungskosten_var,
			SUM(PersVerwaltungskosten_fix) AS PersVerwaltungskosten_fix,
			AVG(SollVorgabe_BM_Anteil) AS SollVorgabe_BM_Anteil,
			SUM(CAMKosten) AS CAMKosten,
			SUM(SoKostVertriebskosten_var) AS SoKostVertriebskosten_var,
			SUM(SoKostVertriebskosten_fix) AS SoKostVertriebskosten_fix,
			SUM(SoKostVerwaltungskosten_var) AS SoKostVerwaltungskosten_var,
			SUM(SoKostVerwaltungskosten_fix) AS SoKostVerwaltungskosten_fix,
			SUM(HandelEKVol) AS HandelEKVol,
			SUM(InhouseMasslamlEKVol) AS InhouseMasslamlEKVol,
			SUM(VKVol) AS VKVol,
			--SUM(HandelEKVol)/SUM(VKVol) AS HandelMatAnteil_Proz,
			--SUM(InhouseMasslamlEKVol)/SUM(VKVol) AS InhouseMasslamMatAnteil_Proz,

			------------------------------------------------------------------------
			--Lastschriften
			ISNULL((
					ISNULL(
						(SELECT TOP 1
							SUM(Lastschriften) 
							--+
							--ISNULL((SELECT TOP 1 LSBetrag FROM @tblLSLP AS tblLSLP WHERE LS COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(LP))), 0)
							AS Lastschrift_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0132.RKEY, 
								((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE) AS Lastschriften
								--(dbo.DATA0132.AMOUNT / dbo.DATA0132.EX_RATE) AS Lastschriften

							FROM         dbo.DATA0132 INNER JOIN
										dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
										dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
										dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

							WHERE      
										RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriften		
					), 0)		
					+
					ISNULL((SELECT TOP 1 LSBetrag FROM @tblLSLP AS tblLSLP WHERE LS COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(LP))), 0)	
			), 0) AS Lastschrift_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(NK) AS LastschriftNK_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS NK
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Nebenkosten Handel')
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenNebenkosten					
			), 0) AS LastschriftNebenkosten_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(Sonstiges) AS LastschriftSonstiges_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Sonstiges
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Sonstiges')
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenSonstiges					
			), 0) AS LastschriftSonstiges_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(Rest) AS LastschriftRest_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Rest
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									AND dbo.DATA0199.MISC_CHARGE_CATEGORY NOT IN ('Sonstiges', 'Nebenkosten Handel')
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenRest						
			), 0) AS LastschriftRest_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(NKLastschriften) AS NKLastschrift_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0132.RKEY, 
							(dbo.DATA0132.MISC_TOT / dbo.DATA0132.EX_RATE) AS NKLastschriften

						FROM         dbo.DATA0132 INNER JOIN
									dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
									dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

						WHERE      
									RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblNKLastschriften						
			), 0) AS SonstigeLastschrift_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(Rest) AS LastschriftRest_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Rest
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									AND dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Nebenkosten Handel'
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenRest						
			), 0) AS LastschriftNebenkostenHandel_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(Rest) AS LastschriftRest_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Rest
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									AND dbo.DATA0199.MISC_CHARGE_CATEGORY IN ('Filmerstellung', 'complete mounted PCB', 'Sonstiges', 'Transportkosten', 'Selection cost', 'Debit Handel Rekla.', 'Rekla. / Belastung', 'Nebenkosten/KleMenZ', 'additional cost QA')
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenRest						
			), 0) AS LastschriftRestkostenJHA_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Einkauf (BM, CU, PP, PCB, Masslam)
			ISNULL(( 
				SELECT
					SUM(NK) AS NKEinkauf
				FROM
				(
					SELECT DISTINCT 
						D107_.RKEY,
						(D107_.SHIPPING + D107_.MISC_TOT) / D107_.EX_RATE  AS NK
					FROM         dbo.DATA0070 AS D70_ INNER JOIN
										dbo.DATA0071 AS D71_ ON D70_.RKEY = D71_.PO_PTR INNER JOIN
										dbo.DATA0108 AS D108_ ON D71_.RKEY = D108_.DATA0071_PTR INNER JOIN
										dbo.DATA0107 AS D107_ ON D108_.DATA0107_PTR = D107_.RKEY INNER JOIN
										dbo.DATA0017 AS D17_ ON D71_.INVT_PTR = D17_.RKEY
					WHERE
						RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						AND (D107_.INV_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (D107_.INV_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblNKEinkauf_
			), 0) AS NKEinkauf_EUR,
			ISNULL((
				SELECT TOP 1
					SUM(EKPreis_EUR*Menge)/SUM(Menge) AS DEKPreis_EUR_
				FROM
				(
					SELECT DISTINCT 
						D108_.RKEY,
						D107_.INV_DATE,
						D108_.PRICE / D107_.EX_RATE  AS EKPreis_EUR,
						D108_.QUANTITY AS Menge
					FROM         dbo.DATA0070 AS D70_ INNER JOIN
										dbo.DATA0071 AS D71_ ON D70_.RKEY = D71_.PO_PTR INNER JOIN
										dbo.DATA0108 AS D108_ ON D71_.RKEY = D108_.DATA0071_PTR INNER JOIN
										dbo.DATA0107 AS D107_ ON D108_.DATA0107_PTR = D107_.RKEY INNER JOIN
										dbo.DATA0017 AS D17_ ON D71_.INVT_PTR = D17_.RKEY
					WHERE
						RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						AND (D107_.INV_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (D107_.INV_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblDEKPreis_EUR
			), 0) AS DEKPreis_EUR,
			ISNULL((
				SELECT TOP 1
					EKPreis_EUR_
				FROM
				(
					SELECT DISTINCT 
						D108_.RKEY,
						D107_.INV_DATE,
						D108_.PRICE / D107_.EX_RATE  AS EKPreis_EUR_
					FROM         dbo.DATA0070 AS D70_ INNER JOIN
										dbo.DATA0071 AS D71_ ON D70_.RKEY = D71_.PO_PTR INNER JOIN
										dbo.DATA0108 AS D108_ ON D71_.RKEY = D108_.DATA0071_PTR INNER JOIN
										dbo.DATA0107 AS D107_ ON D108_.DATA0107_PTR = D107_.RKEY INNER JOIN
										dbo.DATA0017 AS D17_ ON D71_.INVT_PTR = D17_.RKEY
					WHERE
						RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						AND (D107_.INV_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (D107_.INV_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblEKPreis_EUR
				ORDER BY INV_DATE DESC
			), 0) AS EKPreis_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Gutschriften
			/*
			ISNULL((
				SELECT
					SUM(Gutschrift) AS Gutschrift_EUR
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0116.RKEY,
						(dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE AS Gutschrift
					FROM         dbo.DATA0060 INNER JOIN
										  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
										  dbo.DATA0116 INNER JOIN
										  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschrift	
			), 0) AS Gutschrift_EUR,	
			*/
			ISNULL((
				SELECT
					SUM(BetragNetto) AS Gutschrift_EUR
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0116.RKEY,
						dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY) AS BetragNetto
					FROM         dbo.DATA0116 INNER JOIN
							  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
							  dbo.DATA0060 INNER JOIN
							  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschrift	
			), 0) AS Gutschrift_EUR,
			ISNULL((
				SELECT
					SUM(GSNK) AS GutschriftNK_EUR
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0116.RKEY,
						(
							((dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE)
							-
							(dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY)) 
						) AS GSNK
					FROM         dbo.DATA0116 INNER JOIN
							  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
							  dbo.DATA0060 INNER JOIN
							  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschriftNK
			), 0) AS GutschriftNebenkosten_EUR,		
			ISNULL((
				SELECT
					SUM(RMenge) AS GutschriftMenge
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0098.RKEY,
						dbo.DATA0098.QTY_AUTH AS RMenge
					FROM         
						dbo.DATA0098 
					WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
							AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschriftMenge
			), 0) AS GutschriftMenge,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Provision
			ISNULL((
				SELECT TOP 1
					dbo.DATA0009.SALES_REP_NAME
				FROM         dbo.DATA0006 INNER JOIN
										dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
										dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
										dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
										dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
										dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
										dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
										dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
										dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
										dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
										dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
										dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
				WHERE
					dbo.DATA0050.RKEY = MAX(D50_PTR)
					AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
					AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
			), '') AS ProvisionVerteter,
			SUM(FA_Umsatz_VertProvision) AS VerkaufProvision_EUR,
			ISNULL((
				SELECT
					SUM(Provision) AS GutschriftNK_EUR
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0116.RKEY,
						ISNULL(dbo.DATA0509.COMMISSION_DEBITED / dbo.DATA0509.EXCHANGE_RATE, 0) AS Provision
					FROM         dbo.DATA0125 INNER JOIN
										  dbo.DATA0509 ON dbo.DATA0125.DATA0509_PTR = dbo.DATA0509.RKEY RIGHT OUTER JOIN
										  dbo.DATA0116 INNER JOIN
										  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
										  dbo.DATA0060 INNER JOIN
										  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY ON 
										  dbo.DATA0125.MEMO_PTR = dbo.DATA0116.RKEY LEFT OUTER JOIN
										  dbo.DATA0508 INNER JOIN
										  dbo.DATA0061 ON dbo.DATA0508.DATA0061_PTR = dbo.DATA0061.RKEY INNER JOIN
										  dbo.DATA0124 ON dbo.DATA0508.RKEY = dbo.DATA0124.DATA0508_PTR ON dbo.DATA0116.RKEY = dbo.DATA0124.MEMO_PTR
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschriftNK
			), 0) AS GutschriftProvision_EUR,
			ISNULL((
				SELECT TOP 1
					dbo.DATA0009.COMMISSION_1
				FROM         dbo.DATA0006 INNER JOIN
										dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
										dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
										dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
										dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
										dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
										dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
										dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
										dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
										dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
										dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
										dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
				WHERE
					dbo.DATA0050.RKEY = MAX(D50_PTR)
					AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
					AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
			), 0)/100 AS ProvisionVerteterProzent,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Produktion
			ISNULL((
				SELECT TOP 1
					SUM(QUAN_SCH) AS RES
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0006.RKEY, 
						dbo.DATA0006.QUAN_SCH
					FROM         dbo.DATA0006 --INNER JOIN
											--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND dbo.DATA0006.ROOT_PTR=0
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
						AND dbo.DATA0006.PROD_STATUS=5
				) AS tblAufgelegt
			), 0) AS Aufgelegt,
			ISNULL((
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_REJ) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_REJ 
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) <> 'R'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAusschuss
				), 0)
				+
				ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
					SELECT
						SUM(RMenge) AS GutschriftMenge
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0098.RKEY,
							dbo.DATA0098.QTY_AUTH AS RMenge
						FROM         
							dbo.DATA0098 
						WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftMenge
				), 0)
				-
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_PROD) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_PROD
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblProduziert
				), 0)
			), 0) AS Ausschuss,
			ISNULL((
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_PROD) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_PROD
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblProduziert
				), 0)
				-
				ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
					SELECT
						SUM(RMenge) AS GutschriftMenge
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0098.RKEY,
							dbo.DATA0098.QTY_AUTH AS RMenge
						FROM         
							dbo.DATA0098 
						WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftMenge
				), 0)
				-
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_REJ) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_REJ
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='W'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAusschuss_R
				), 0)
				+
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_PROD) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_PROD
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblProduziert
				), 0)
			), 0) AS Produziert,
			ISNULL((
				SELECT TOP 1
					SUM(QUAN_REJ)/SUM(QUAN_SCH) AS RES
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0006.RKEY, 
						dbo.DATA0006.QUAN_REJ,
						dbo.DATA0006.QUAN_SCH
					FROM         dbo.DATA0006 --INNER JOIN
											--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND dbo.DATA0006.ROOT_PTR=0
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						AND dbo.DATA0006.PROD_STATUS=5
				) AS tblAusschuss
			), 0) AS Ausschuss_Proz,
			ISNULL((
					SELECT
						SUM(QTY_ON_HAND) AS LPKonsi_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0053.RKEY, 
							dbo.DATA0053.QTY_ON_HAND
						FROM         dbo.DATA0006 INNER JOIN
												dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
						WHERE     
								dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
					) AS tblNLPKonsiMenge
			), 0) AS LPKonsi,
			ISNULL((
					SELECT
						SUM(QTY_ON_HAND*LAST_SO_PRICE) AS LPKonsi_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0053.RKEY, 
							dbo.DATA0053.QTY_ON_HAND,
							dbo.DATA0050.LAST_SO_PRICE
						--FROM         dbo.DATA0006 INNER JOIN
						--						dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
						FROM         dbo.DATA0006 INNER JOIN
											  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
						WHERE     
								dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
					) AS tblNLPKonsiMenge
			--), 0) * MAX(ELP_gesend_gewDP)  AS LPKonsi_EUR,
			), 0)  AS LPKonsi_EUR,
			ISNULL((
				SELECT TOP 1
					SUM(gesendet_FA * KNX * KNY / ELP_KN / 10000) AS RES
				FROM
				(
					SELECT 
						dbo.ARTIKELDATEN.*,
						dbo.DATA0050.RKEY AS D0050_PTR,
						CASE 
							WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
								ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
								* 
								dbo.DATA0060.EXCH_RATE 
							ELSE
								dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
						END AS ELP_Preis_EUR,
						dbo.DATA0052.QUAN_SHP AS gesendet_FA

					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE
						(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblFAUmsatz
				WHERE D0050_PTR = MAX(D50_PTR) 
			), 0) AS Durch_VK_dm2,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Verkauf
			ISNULL((
				SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
				FROM         dbo.DATA0006 INNER JOIN
										dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
										dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
										dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
				WHERE 
					dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
					AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
					AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
			), 0) AS LMenge,
			ISNULL((
				SELECT
					SUM(NK) AS NKVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.TOOLING_CHARGES AS NK
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblNKVerkauf
			), 0) AS NKVerkauf_EUR,
			ISNULL((
				SELECT
					SUM(Rabatt) AS RabattVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.DISCOUNT_AMOUNT AS Rabatt
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblRabattVerkauf
			), 0) AS RabattVerkauf_EUR,
			ISNULL((
				SELECT
					SUM(Einzuschlag) AS EZVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.RUSH_CHARGE_AMOUNT AS Einzuschlag
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblEZVerkauf
			), 0) AS EZVerkauf_EUR,
			ISNULL((
				SELECT
					SUM(Versandkosten) AS VersandVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.SHIPPING_CHARGES AS Versandkosten
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblVersandVerkauf
			), 0) AS VersandVerkauf_EUR,

			(
				SUM(FA_Umsatz)
				-
				ISNULL((
					SELECT TOP 1 
						SUM(Gutschrift) AS Gutschrift_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0116.RKEY,
							dbo.DATA0116.CREDIT_AMOUNT/dbo.DATA0116.EX_RATE - dbo.DATA0116.STATE_TAX AS Gutschrift
						FROM         dbo.DATA0060 INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
											  dbo.DATA0116 INNER JOIN
											  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE     (dbo.DATA0060.CUST_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschrift	
				), 0)
			) AS FA_Umsatz_ohneGutschrift,
			ISNULL((
				SELECT TOP 1
					--SUM(FK) AS FK1,
					SUM(FK/CASE WHEN PlusZeichen_1=0 THEN 1 ELSE CASE WHEN PlusZeichen_1>0 AND PlusZeichen_2=0 THEN 2 ELSE 3 END END) AS FK_EUR
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0072.RKEY,
						dbo.DATA0072.DESCRIPTION2 AS LP,
						(dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE * dbo.DATA0072.QUAN_ORD) AS FK,
						CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 1) AS PlusZeichen_1,
						CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 21) AS PlusZeichen_2
					FROM         dbo.DATA0070 INNER JOIN
										  dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR
					WHERE
						LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION, '')), 3) = 'FK '
						AND LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION2, '')), 3) = 'LP '
						AND dbo.DATA0072.DESCRIPTION2 COLLATE SQL_Latin1_General_CP1_CI_AS LIKE '%' + LTRIM(RTRIM(LP)) + '%' 
						AND (dbo.DATA0070.PO_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0070.PO_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblFK
			), 0) AS Frachtkosten_EUR,
			ISNULL((
				ISNULL(SUM(FA_reserviert), 0)
				+
				ISNULL((
					SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				), 0) 
				+
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND) AS LPKonsi
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND
							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				), 0) 
			), 0) AS GesamtVerkaufsmenge,
			ISNULL((
					SELECT TOP 1
						SUM(gesendet * Preis) / SUM(gesendet) AS DVKPreis
					FROM
					(
						SELECT 
								dbo.DATA0052.QUAN_SHP AS gesendet,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										/ 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
								END AS Preis

						FROM         dbo.DATA0006 INNER JOIN
											  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE     
								--RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) = @para1 --'51051.300' --'  
								dbo.DATA0050.RKEY=MAX(D50_PTR)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblDVKPreis
			), 0) AS DVKPreis,
			ISNULL((
					SELECT TOP 1 dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE AS RES
					FROM         dbo.DATA0054 INNER JOIN
						dbo.DATA0006 ON dbo.DATA0054.WO_PTR = dbo.DATA0006.RKEY INNER JOIN
						dbo.DATA0050 INNER JOIN
						dbo.DATA0060 ON dbo.DATA0050.RKEY = dbo.DATA0060.CUST_PART_PTR ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY
					WHERE
								dbo.DATA0050.RKEY=MAX(D50_PTR)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0060.ENT_DATE DESC
			), 0) AS LetzterKommPreis
			------------------------------------------------------------------------
			------------------------------------------------------------------------
			
		FROM
		(
			SELECT
				tblDaten.*
				--CAST(ELP_gesend_gewDP*FA_reserviert AS FLOAT) AS LB_in_EUR
			FROM
			(
				SELECT
					tblNachKalk_Daten_2.D10_PTR,
					tblNachKalk_Daten_2.Kunde,
					tblNachKalk_Daten_2.Aufbereitung,
					tblNachKalk_Daten_2.LP,
					tblNachKalk_Daten_2.D50_PTR,
					tblNachKalk_Daten_2.D60_PTR,
					CASE
						WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten_2.LP), 3), 1)=1 THEN 
							'Intern'
						ELSE
							CASE
								WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten_2.LP), 3), 1)=2 THEN 
									'Masslam'
								ELSE
									CASE
										WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten_2.LP), 3), 1)=3 THEN 
											'Handel'
										ELSE
											'unbekannt'
									END
							END
					END AS InternMasslamHandel,
					tblNachKalk_Daten_2.PC,
					--tblNachKalk_Daten_2.AnzKommissionen,
					--tblNachKalk_Daten_2.Kommission,
					tblNachKalk_Daten_2.FA,
					ISNULL((
						ISNULL((
							SELECT TOP 1
								SUM(RES) AS umsatz
							FROM
							(
								SELECT 
									dbo.DATA0006.RKEY AS D0006_PTR,
									(
										CASE 
											WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
												ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
												/ 
												dbo.DATA0060.EXCH_RATE 
											ELSE
												dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
										END --ELP_Preis_EUR
										*
										dbo.DATA0052.QUAN_SHP --AS gesendet_FA
									) AS RES
								FROM         dbo.DATA0006 INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
								WHERE
									(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							) AS tblFAUmsatz
							WHERE 
								D0006_PTR = D6_PTR 
								--D0006_PTR = CASE WHEN LEFT(tblNachKalk_Daten_2.FA, 1)='S' THEN tblNachKalk_Daten_2.D6S_PTR ELSE tblNachKalk_Daten_2.D6_PTR END
						), 0)
					), 0) AS FA_Umsatz,
					ISNULL((
						ISNULL((
							SELECT TOP 1
								SUM(RES) AS umsatz
							FROM
							(
								SELECT 
									dbo.DATA0006.RKEY AS D0006_PTR,
									(
										CASE 
											WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
												ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
												/ 
												dbo.DATA0060.EXCH_RATE 
											ELSE
												dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
										END --ELP_Preis_EUR
										*
										dbo.DATA0052.QUAN_SHP --AS gesendet_FA
									) AS RES
								FROM         dbo.DATA0006 INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
								WHERE
									(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
									AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) = 'R'
							) AS tblFAUmsatz
							WHERE 
								D0006_PTR = D6_PTR 
						), 0)
					), 0) AS FA_Umsatz_R,
					ISNULL((
						SELECT TOP 1
							SUM(RES) AS umsatzProv
						FROM
						(
							SELECT 
								dbo.DATA0006.RKEY AS D0006_PTR,
								(
									CASE 
										WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
											ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
											/ 
											dbo.DATA0060.EXCH_RATE 
										ELSE
											dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
									END --ELP_Preis_EUR
									*
									dbo.DATA0052.QUAN_SHP --AS gesendet_FA
									*
									(dbo.DATA0509.SALES_COMMISSION_PER/100)
								) AS RES
							FROM         dbo.DATA0006 INNER JOIN
												  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
												  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
												  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
												  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
												  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
												  dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
												  dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR
							WHERE
								(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblFAUmsatzProv
						WHERE D0006_PTR = D6_PTR 
					), 0) AS FA_Umsatz_VertProvision,
					tblNachKalk_Daten_2.EK_Handel_Masslam_HauptFA AS EKHandelNasslamFA,
					tblNachKalk_Daten_2.Matko_EK_HauptFA,
					tblNachKalk_Daten_2.Matko_EK_IL,
					tblNachKalk_Daten_2.Matko_GK_HauptFA + tblNachKalk_Daten_2.Matko_So_HauptFA AS Matko_GK_SO,
					tblNachKalk_Daten_2.Matko_GK_IL + tblNachKalk_Daten_2.Matko_So_IL AS Matko_GK_SO_IL,
					tblNachKalk_Daten_2.Matko_GK_HauptFA,
					tblNachKalk_Daten_2.Matko_GK_IL,
					tblNachKalk_Daten_2.Matko_So_HauptFA,
					tblNachKalk_Daten_2.Matko_So_IL,
					tblNachKalk_Daten_2.Fremd_EK_HauptFA,
					tblNachKalk_Daten_2.Ekosten_var_HauptFA,
					tblNachKalk_Daten_2.Ekosten_var_IL,
					tblNachKalk_Daten_2.Ekosten_fix_HauptFA,
					tblNachKalk_Daten_2.Ekosten_fix_IL,
					tblNachKalk_Daten_2.Leasing_var_HauptFA,
					tblNachKalk_Daten_2.Leasing_var_IL,
					tblNachKalk_Daten_2.Leasing_fix_HauptFA,
					tblNachKalk_Daten_2.Leasing_fix_IL,
					tblNachKalk_Daten_2.Inst_var_HauptFA,
					tblNachKalk_Daten_2.Inst_var_IL,
					tblNachKalk_Daten_2.Inst_fix_HauptFA,
					tblNachKalk_Daten_2.Inst_fix_IL,
					tblNachKalk_Daten_2.Sokosten_var_HauptFA,
					tblNachKalk_Daten_2.Sokosten_var_IL,
					tblNachKalk_Daten_2.Sokosten_fix_HauptFA,
					tblNachKalk_Daten_2.Sokosten_fix_IL,
					tblNachKalk_Daten_2.Pers_var_HauptFA,
					tblNachKalk_Daten_2.Pers_var_IL,
					tblNachKalk_Daten_2.Pers_fix_HauptFA,
					tblNachKalk_Daten_2.Pers_fix_IL,
					--tblNachKalk_Daten_2.Kosten_Uml,
					ISNULL((SELECT TOP 1 QTY_ALLOC AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_reserviert,
					ISNULL((
							SELECT TOP 1
								SUM(RES) AS LBEur
							FROM
							(
								SELECT DISTINCT
									dbo.DATA0053.RKEY,
									(dbo.DATA0060.PART_PRICE/dbo.DATA0060.EXCH_RATE*dbo.DATA0053.QTY_ALLOC) AS RES
									--SUM(dbo.DATA0053.QTY_ALLOC) AS RES
								FROM         dbo.DATA0060 INNER JOIN
													  dbo.DATA0063 ON dbo.DATA0060.RKEY = dbo.DATA0063.SO_PTR INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0063.PART_BATCH_PTR = dbo.DATA0053.RKEY
								WHERE dbo.DATA0053.WORK_ORDER_PTR = D6_PTR 
							) AS tblLBEur
					), 0) AS LB_in_EUR,
					ISNULL((SELECT TOP 1 (QTY_ON_HAND - QTY_ALLOC) AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_freiLB,
					--tblNachKalk_Daten_2.Aus_in_Proz,
					ISNULL((
						SELECT TOP 1
							SUM(ELP_Preis_EUR*gesendet_FA)/SUM(gesendet_FA) AS umsatz
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.ACT_COMPL_DATE,
								dbo.DATA0050.RKEY AS D0050_PTR,
								--dbo.DATA0006.RKEY AS D0006_PTR,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										* 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
								END AS ELP_Preis_EUR,
								dbo.DATA0052.QUAN_SHP AS gesendet_FA

							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						) AS tblFAUmsatz
						WHERE 
							D0050_PTR = tblNachKalk_Daten_2.D50_PTR
							AND (ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						--WHERE D0006_PTR = D6_PTR 
					), 
						(
							SELECT TOP 1 (dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE) AS RES 
							FROM dbo.DATA0054 INNER JOIN  dbo.DATA0060 ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY 
							WHERE dbo.DATA0060.CUST_PART_PTR = tblNachKalk_Daten_2.D50_PTR
						)
					) AS ELP_gesend_gewDP,
					tblNachKalk_Daten_2.FAkomplAm,
					tblNachKalk_Daten_2.ArtikelCode,
					tblNachKalk_Daten_2.Herstellung_AnzMinuten,
					ISNULL(tblNachKalk_Daten_2.Vertrieb_var, 0) AS Vertriebskosten_var,
					ISNULL(tblNachKalk_Daten_2.Vertrieb_fix, 0) AS Vertriebskosten_fix,
					ISNULL(tblNachKalk_Daten_2.Verwaltung_var, 0) AS Verwaltungskosten_var,
					ISNULL(tblNachKalk_Daten_2.Verwaltung_fix, 0) AS Verwaltungskosten_fix,
					ISNULL(tblNachKalk_Daten_2.PersVertrieb_var, 0) AS PersVertriebskosten_var,
					ISNULL(tblNachKalk_Daten_2.PersVertrieb_fix, 0) AS PersVertriebskosten_fix,
					ISNULL(tblNachKalk_Daten_2.PersVerwaltung_var, 0) AS PersVerwaltungskosten_var,
					ISNULL(tblNachKalk_Daten_2.PersVerwaltung_fix, 0) AS PersVerwaltungskosten_fix,
					ISNULL(tblNachKalk_Daten_2.SollVorgabe_BM_Anteil, 0) AS SollVorgabe_BM_Anteil,
					ISNULL(tblNachKalk_Daten_2.CAMKosten, 0) AS CAMKosten,
					ISNULL(tblNachKalk_Daten_2.SoKostVertrieb_var, 0) AS SoKostVertriebskosten_var,
					ISNULL(tblNachKalk_Daten_2.SoKostVertrieb_fix, 0) AS SoKostVertriebskosten_fix,
					ISNULL(tblNachKalk_Daten_2.SoKostVerwaltung_var, 0) AS SoKostVerwaltungskosten_var,
					ISNULL(tblNachKalk_Daten_2.SoKostVerwaltung_fix, 0) AS SoKostVerwaltungskosten_fix,
					--ISNULL(tblNachKalk_Daten_2.HandelEKVol, 0) AS HandelEKVol,
					--ISNULL(tblNachKalk_Daten_2.InhouseMasslamlEKVol, 0) AS InhouseMasslamlEKVol,
					--ISNULL(tblNachKalk_Daten_2.VKVol, 0) AS VKVol
					ISNULL(CASE WHEN LEFT(tblNachKalk_Daten_2.FA, 1) IN ('S', 'R', 'W') THEN 0 ELSE tblNachKalk_Daten_2.HandelEKVol END, 0) AS HandelEKVol,
					ISNULL(CASE WHEN LEFT(tblNachKalk_Daten_2.FA, 1) IN ('S', 'R', 'W') THEN 0 ELSE tblNachKalk_Daten_2.InhouseMasslamlEKVol END, 0) AS InhouseMasslamlEKVol,
					ISNULL(CASE WHEN LEFT(tblNachKalk_Daten_2.FA, 1) IN ('S', 'R', 'W') THEN 0 ELSE tblNachKalk_Daten_2.VKVol END, 0) AS VKVol

				FROM
					LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
				WHERE 
					tblNachKalk_Daten_2.FAkomplAm >= CONVERT(DATETIME, @para6, 103)
					AND tblNachKalk_Daten_2.FAkomplAm <= CONVERT(DATETIME, @para7, 103)
					AND tblNachKalk_Daten_2.Aufbereitung = @para1
					AND tblNachKalk_Daten_2.D10_PTR IN (SELECT D10_PTR FROM @tblD10LP)
					AND tblNachKalk_Daten_2.D50_PTR IN (SELECT D50_PTR FROM @tblD50LP)
					AND tblNachKalk_Daten_2.D8_PTR IN (SELECT D8_PTR FROM @tblD8LP)
			) AS tblDaten
		) AS tblDatenGrp 
		WHERE 
			InternMasslamHandel IN (ISNULL(@para8, ''), ISNULL(@para9, ''), ISNULL(@para10, ''))
		GROUP BY
			D10_PTR,
			Kunde, 
			LP
		ORDER BY
			LP
	END
	*/
	IF @Case_ = 'NachKalk_Berichte_Gruppiert'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255),
			@para7 varchar(255),
			@para8 varchar(255),
			@para9 varchar(255),
			@para10 varchar(255),
			@para11 varchar(255)
		SET @para1 = 'Handel_2015_Ver2_bis_04.16'
		SET @para2 = '-1' --Kunde
		SET @para3 = '-1' --Kundenteil
		SET @para4 = '-1' --PC
		--SET @para5 = ''Intern', 'Masslam', 'Handel''
		SET @para6 = '01.01.2016'
		SET @para7 = '31.12.2016'
		SET @para8 = 'Intern'
		SET @para9 = 'Masslam'
		SET @para10 = 'Handel'
		SET @para11 = 'PC' --'Kunde' --'LP'
		*/
		
		
		DECLARE @tblDaten table(
								D10_PTR NUMERIC(10, 0),
								Kunde varchar(150),
								LP varchar(50),
								AnzFA INT,
								PC varchar(15),
								ELP_gesend_gewDP FLOAT,
								ELP_gesend_gewDP_proKunde FLOAT,
								ELP_gesend_gewDP_proPC FLOAT,
								FA_Umsatz FLOAT,
								FA_Umsatz_R FLOAT,
								LB_in_EUR FLOAT,
								EKHandelMasslamFA_EUR FLOAT,
								Matko_EK_EUR FLOAT,
								Matko_EK_IL_EUR FLOAT,
								Matko_GK_SO_EUR FLOAT,
								Matko_GK_SO_IL_EUR FLOAT,
								Matko_GK FLOAT,
								Matko_GK_IL FLOAT,
								Matko_So FLOAT,
								Matko_So_IL FLOAT,
								Fremd_EK_EUR FLOAT,
								Pers_var_EUR FLOAT,
								Pers_fix_EUR FLOAT,
								Ekosten_var_EUR FLOAT,
								Ekosten_fix_EUR FLOAT,
								Leasing_var_EUR FLOAT,
								Leasing_fix_EUR FLOAT,
								Inst_var_EUR FLOAT,
								Inst_fix_EUR FLOAT,
								Sokosten_var_EUR FLOAT,
								Sokosten_fix_EUR FLOAT,
								AlleKostenarten_EUR FLOAT,
								AlleKostenarten_var_EUR FLOAT,
								AlleKostenarten_fix_EUR FLOAT,
								Materialkosten_EUR FLOAT,
								ELP_freiLB INT,
								ELP_reserviert INT,
								FAKomplAm smalldatetime,
								ArtikelCode varchar(50),
								Herstellung_AnzMinuten INT,
								Vertriebskosten_var FLOAT,
								Vertriebskosten_fix FLOAT,
								Verwaltungskosten_var FLOAT,
								Verwaltungskosten_fix FLOAT,
								PersVertriebskosten_var FLOAT,
								PersVertriebskosten_fix FLOAT,
								PersVerwaltungskosten_var FLOAT,
								PersVerwaltungskosten_fix FLOAT,
								SollVorgabe_BM_Anteil FLOAT,
								CAMKosten FLOAT,
								SoKostVertriebskosten_var FLOAT,
								SoKostVertriebskosten_fix FLOAT,
								SoKostVerwaltungskosten_var FLOAT,
								SoKostVerwaltungskosten_fix FLOAT,
								HandelEKVol FLOAT,
								InhouseMasslamEKVol FLOAT,
								VKVol FLOAT,
								Lastschrift_EUR FLOAT,
								LastschriftNebenkosten_EUR FLOAT,
								LastschriftSonstiges_EUR FLOAT,
								LastschriftRest_EUR FLOAT,
								SonstigeLastschrift_EUR FLOAT,
								LastschriftNebenkostenHandel_EUR FLOAT,
								LastschriftRestkostenJHA_EUR FLOAT,
								NKEinkauf_EUR FLOAT,
								DEKPreis_EUR FLOAT,
								EKPreis_EUR FLOAT,
								Gutschrift_EUR FLOAT,
								GutschriftNebenkosten_EUR FLOAT,
								GutschriftMenge INT,
								ProvisionVertreter varchar(150),
								VerkaufProvision_EUR FLOAT,
								GutschriftProvision_EUR FLOAT,
								ProvisionVertreterProzent FLOAT,
								Aufgelegt INT,
								Ausschuss INT,
								Produziert INT,
								Ausschuss_Proz FLOAT,
								LPKonsi INT,
								LPKonsi_EUR FLOAT,
								Durch_VK_dm2 FLOAT,
								LMenge INT,
								NKVerkauf_EUR FLOAT,
								RabattVerkauf_EUR FLOAT,
								EZVerkauf_EUR FLOAT,
								VersandVerkauf_EUR FLOAT,
								FA_Umsatz_ohneGutschrift FLOAT,
								Frachtkosten_EUR FLOAT,
								GesamtVerkaufsmenge INT,
								DVKPreis FLOAT,
								DVKPreis_proKunde FLOAT,
								DVKPreis_proPC FLOAT,
								LetzterKommPreis FLOAT,
								LetzterKommPreis_proKunde FLOAT,
								LetzterKommPreis_proPC FLOAT,
								Vorlageprovision FLOAT
								)


		DECLARE 
			@InsertSQLLP varchar(1000)

		--Kunde
		DECLARE @tblD10LP table(D10_PTR NUMERIC(10, 0))
		IF @para2<>'-1'
		BEGIN
			SET @InsertSQLLP = '
								--INSERT @tblD10(D10_PTR)
								SELECT DISTINCT
									D10_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
								WHERE
									tblNachKalk_Daten_2.D10_PTR IN (' + RTRIM(@para2) + ')
							'
							INSERT @tblD10LP(D10_PTR) EXECUTE(@InsertSQLLP)
		END
		ELSE
		BEGIN
			INSERT @tblD10LP(D10_PTR)
			SELECT DISTINCT
				D10_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
		END

		--Kundenteil
		DECLARE @tblD50LP table(D50_PTR NUMERIC(10, 0))
		IF @para3<>'-1'
		BEGIN
			SET @InsertSQLLP = '
								--INSERT @tblD50(D50_PTR)
								SELECT DISTINCT
									D50_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
								WHERE
									tblNachKalk_Daten_2.D50_PTR IN (' + RTRIM(@para3) + ')
							'
							INSERT @tblD50LP(D50_PTR) EXECUTE(@InsertSQLLP)
		END
		ELSE
		BEGIN
			INSERT @tblD50LP(D50_PTR)
			SELECT DISTINCT
				D50_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
		END

		--PC
		DECLARE @tblD8LP table(D8_PTR NUMERIC(10, 0))
		IF @para4<>'-1'
		BEGIN
			SET @InsertSQLLP = '
								--INSERT @tblD8(D8_PTR)
								SELECT DISTINCT
									D8_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
								WHERE
									tblNachKalk_Daten_2.D8_PTR IN (' + RTRIM(@para4) + ')
							'
							INSERT @tblD8LP(D8_PTR) EXECUTE(@InsertSQLLP)
		END
		ELSE
		BEGIN
			INSERT @tblD8LP(D8_PTR)
			SELECT DISTINCT
				D8_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
		END

		--Lastschriften
		DECLARE @tblLSLP table(LS VARCHAR(9), LSBetrag FLOAT)
		INSERT @tblLSLP(LS, LSBetrag) SELECT '41333.301' AS LS, 1823 AS LSBetrag
		--INSERT @tblLSLP(LS, LSBetrag) SELECT '53136.300' AS LS, 1286 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '50735.300' AS LS, 4694 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '51712.302' AS LS, 584 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '52247.300' AS LS, 4625 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '34844.202' AS LS, 1853 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '49037.300' AS LS, 316 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '52395.300' AS LS, 1827 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '46660.301' AS LS, 5086 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '46861.301' AS LS, 704 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '51915.300' AS LS, 533 AS LSBetrag

		
		INSERT @tblDaten (
							D10_PTR,
							Kunde,
							LP,
							AnzFA,
							PC,
							ELP_gesend_gewDP,
							ELP_gesend_gewDP_proKunde,
							ELP_gesend_gewDP_proPC,
							FA_Umsatz,
							FA_Umsatz_R,
							LB_in_EUR,
							EKHandelMasslamFA_EUR,
							Matko_EK_EUR,
							Matko_EK_IL_EUR,
							Matko_GK_SO_EUR,
							Matko_GK_SO_IL_EUR,
							Matko_GK,
							Matko_GK_IL,
							Matko_So,
							Matko_So_IL,
							Fremd_EK_EUR,
							Pers_var_EUR,
							Pers_fix_EUR,
							Ekosten_var_EUR,
							Ekosten_fix_EUR,
							Leasing_var_EUR,
							Leasing_fix_EUR,
							Inst_var_EUR,
							Inst_fix_EUR,
							Sokosten_var_EUR,
							Sokosten_fix_EUR,
							AlleKostenarten_EUR,
							AlleKostenarten_var_EUR,
							AlleKostenarten_fix_EUR,
							Materialkosten_EUR,
							ELP_freiLB,
							ELP_reserviert,
							FAKomplAm,
							ArtikelCode,
							Herstellung_AnzMinuten,
							Vertriebskosten_var,
							Vertriebskosten_fix,
							Verwaltungskosten_var,
							Verwaltungskosten_fix,
							PersVertriebskosten_var,
							PersVertriebskosten_fix,
							PersVerwaltungskosten_var,
							PersVerwaltungskosten_fix,
							SollVorgabe_BM_Anteil,
							CAMKosten,
							SoKostVertriebskosten_var,
							SoKostVertriebskosten_fix,
							SoKostVerwaltungskosten_var,
							SoKostVerwaltungskosten_fix,
							HandelEKVol,
							InhouseMasslamEKVol,
							VKVol,
							Lastschrift_EUR ,
							LastschriftNebenkosten_EUR,
							LastschriftSonstiges_EUR,
							LastschriftRest_EUR,
							SonstigeLastschrift_EUR,
							LastschriftNebenkostenHandel_EUR,
							LastschriftRestkostenJHA_EUR,
							NKEinkauf_EUR ,
							DEKPreis_EUR,
							EKPreis_EUR,
							Gutschrift_EUR,
							GutschriftNebenkosten_EUR,
							GutschriftMenge,
							ProvisionVertreter,
							VerkaufProvision_EUR,
							GutschriftProvision_EUR,
							ProvisionVertreterProzent,
							Aufgelegt,
							Ausschuss,
							Produziert,
							Ausschuss_Proz,
							LPKonsi,
							LPKonsi_EUR,
							Durch_VK_dm2,
							LMenge,
							NKVerkauf_EUR,
							RabattVerkauf_EUR,
							EZVerkauf_EUR,
							VersandVerkauf_EUR,
							FA_Umsatz_ohneGutschrift,
							Frachtkosten_EUR,
							GesamtVerkaufsmenge,
							DVKPreis,
							DVKPreis_proKunde,
							DVKPreis_proPC,
							LetzterKommPreis,
							LetzterKommPreis_proKunde,
							LetzterKommPreis_proPC,
							Vorlageprovision
						)
		
		SELECT
			D10_PTR,
			Kunde,
			LP,
			--MAX(AnzKommissionen) AS AnzKommissionen,
			--MAX(Kommission) AS Kommission,
			ISNULL((
				SELECT TOP 1
					COUNT(WORK_ORDER_NUMBER) AS RES
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0006.WORK_ORDER_NUMBER
					FROM         dbo.DATA0006 --INNER JOIN
											--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND dbo.DATA0006.ROOT_PTR=0
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
						AND dbo.DATA0006.PROD_STATUS=5
				) AS tblAnzFA
			), 0) AS AnzFA,
			MAX(PC) AS PC,
			MAX(ELP_gesend_gewDP) AS ELP_gesend_gewDP,
			MAX(ELP_gesend_gewDP_proKunde) AS ELP_gesend_gewDP_proKunde,
			MAX(ELP_gesend_gewDP_proPC) AS ELP_gesend_gewDP_proPC,
			SUM(FA_Umsatz) AS FA_Umsatz,
			SUM(FA_Umsatz_R) AS FA_Umsatz_R,
			SUM(LB_in_EUR) AS LB_in_EUR,
			SUM(EKHandelNasslamFA) AS EKHandelMasslamFA_EUR,
			SUM(Matko_EK_HauptFA) AS Matko_EK_EUR,
			SUM(Matko_EK_IL) AS Matko_EK_IL_EUR,
			SUM(Matko_GK_SO) AS Matko_GK_SO_EUR,
			SUM(Matko_GK_SO_IL) AS Matko_GK_SO_IL_EUR,
			SUM(Matko_GK_HauptFA) AS Matko_GK,
			SUM(Matko_GK_IL) AS Matko_GK_IL,
			SUM(Matko_So_HauptFA) AS Matko_So,
			SUM(Matko_So_IL) AS Matko_So_IL,
			SUM(Fremd_EK_HauptFA) AS Fremd_EK_EUR,
			SUM(Pers_var_HauptFA)+SUM(Pers_var_IL) AS Pers_var_EUR,
			SUM(Pers_fix_HauptFA)+SUM(Pers_fix_IL) AS Pers_fix_EUR,
			SUM(Ekosten_var_HauptFA)+SUM(Ekosten_var_IL) AS Ekosten_var_EUR,
			SUM(Ekosten_fix_HauptFA)+SUM(Ekosten_fix_IL) AS Ekosten_fix_EUR,
			SUM(Leasing_var_HauptFA)+SUM(Leasing_var_IL) AS Leasing_var_EUR,
			SUM(Leasing_fix_HauptFA)+SUM(Leasing_fix_IL) AS Leasing_fix_EUR,
			SUM(Inst_var_HauptFA)+SUM(Inst_var_IL) AS Inst_var_EUR,
			SUM(Inst_fix_HauptFA)+SUM(Inst_fix_IL) AS Inst_fix_EUR,
			SUM(Sokosten_var_HauptFA)+SUM(Sokosten_var_IL) AS Sokosten_var_EUR,
			SUM(Sokosten_fix_HauptFA)+SUM(Sokosten_fix_IL) AS Sokosten_fix_EUR,
			(
				SUM(Pers_var_HauptFA) + SUM(Pers_fix_HauptFA) + SUM(Pers_var_IL) + SUM(Pers_fix_IL) 
				+ 
				SUM(Ekosten_var_HauptFA) + SUM(Ekosten_fix_HauptFA) + SUM(Ekosten_var_IL) + SUM(Ekosten_fix_IL) 
				+ 
				SUM(Leasing_var_HauptFA) + SUM(Leasing_fix_HauptFA) + SUM(Leasing_var_IL) + SUM(Leasing_fix_IL) 
				+ 
				SUM(Inst_var_HauptFA) + SUM(Inst_fix_HauptFA) + SUM(Inst_var_IL) + SUM(Inst_fix_IL)
				+ 
				SUM(Sokosten_var_HauptFA) + SUM(Sokosten_fix_HauptFA) + SUM(Sokosten_var_IL) + SUM(Sokosten_fix_IL) 
			) AS AlleKostenarten_EUR,
			(
				SUM(Pers_var_HauptFA) + SUM(Pers_var_IL) 
				+ 
				SUM(Ekosten_var_HauptFA) + SUM(Ekosten_var_IL) 
				+ 
				SUM(Leasing_var_HauptFA) + SUM(Leasing_var_IL) 
				+ 
				SUM(Inst_var_HauptFA) + SUM(Inst_var_IL) 
				+ 
				SUM(Sokosten_var_HauptFA) + SUM(Sokosten_var_IL)
			) AS AlleKostenarten_var_EUR,
			(
				SUM(Pers_fix_HauptFA) + SUM(Pers_fix_IL) 
				+ 
				SUM(Ekosten_fix_HauptFA) + SUM(Ekosten_fix_IL) 
				+ 
				SUM(Leasing_fix_HauptFA) + SUM(Leasing_fix_IL) 
				+ 
				SUM(Inst_fix_HauptFA) + SUM(Inst_fix_IL) 
				+ 
				SUM(Sokosten_fix_HauptFA) + SUM(Sokosten_fix_IL)
			) AS AlleKostenarten_fix_EUR,
			(
				SUM(EKHandelNasslamFA) + SUM(Matko_EK_HauptFA) + SUM(Matko_GK_SO) + SUM(Fremd_EK_HauptFA) + SUM(Matko_EK_IL) + SUM(Matko_GK_SO_IL) 
			) AS Materialkosten_EUR,
			--SUM(Kosten_Uml) AS Kosten_Uml_EUR,
			SUM(FA_freiLB) AS ELP_freiLB,
			SUM(FA_reserviert) AS ELP_reserviert,
			MAX(FAkomplAm) AS FAkomplAm,
			MAX(ArtikelCode) AS ArtikelCode,
			SUM(Herstellung_AnzMinuten) AS Herstellung_AnzMinuten,
			SUM(Vertriebskosten_var) AS Vertriebskosten_var,
			SUM(Vertriebskosten_fix) AS Vertriebskosten_fix,
			SUM(Verwaltungskosten_var) AS Verwaltungskosten_var,
			SUM(Verwaltungskosten_fix) AS Verwaltungskosten_fix,
			SUM(PersVertriebskosten_var) AS PersVertriebskosten_var,
			SUM(PersVertriebskosten_fix) AS PersVertriebskosten_fix,
			SUM(PersVerwaltungskosten_var) AS PersVerwaltungskosten_var,
			SUM(PersVerwaltungskosten_fix) AS PersVerwaltungskosten_fix,
			AVG(SollVorgabe_BM_Anteil) AS SollVorgabe_BM_Anteil,
			SUM(CAMKosten) AS CAMKosten,
			SUM(SoKostVertriebskosten_var) AS SoKostVertriebskosten_var,
			SUM(SoKostVertriebskosten_fix) AS SoKostVertriebskosten_fix,
			SUM(SoKostVerwaltungskosten_var) AS SoKostVerwaltungskosten_var,
			SUM(SoKostVerwaltungskosten_fix) AS SoKostVerwaltungskosten_fix,
			SUM(HandelEKVol) AS HandelEKVol,
			SUM(InhouseMasslamlEKVol) AS InhouseMasslamlEKVol,
			SUM(VKVol) AS VKVol,
			--SUM(HandelEKVol)/SUM(VKVol) AS HandelMatAnteil_Proz,
			--SUM(InhouseMasslamlEKVol)/SUM(VKVol) AS InhouseMasslamMatAnteil_Proz,

			------------------------------------------------------------------------
			--Lastschriften
			ISNULL((
					ISNULL(
						(SELECT TOP 1
							SUM(Lastschriften) 
							--+
							--ISNULL((SELECT TOP 1 LSBetrag FROM @tblLSLP AS tblLSLP WHERE LS COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(LP))), 0)
							AS Lastschrift_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0132.RKEY, 
								((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE) AS Lastschriften
								--(dbo.DATA0132.AMOUNT / dbo.DATA0132.EX_RATE) AS Lastschriften

							FROM         dbo.DATA0132 INNER JOIN
										dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
										dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
										dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

							WHERE      
										--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
										REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriften		
					), 0)		
					+
					ISNULL((SELECT TOP 1 LSBetrag FROM @tblLSLP AS tblLSLP WHERE LS COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(LP))), 0)	
			), 0) AS Lastschrift_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(NK) AS LastschriftNK_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS NK
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
									REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
									AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Nebenkosten Handel')
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenNebenkosten					
			), 0) AS LastschriftNebenkosten_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(Sonstiges) AS LastschriftSonstiges_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Sonstiges
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
									REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
									AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Sonstiges')
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenSonstiges					
			), 0) AS LastschriftSonstiges_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(Rest) AS LastschriftRest_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Rest
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
									REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
									AND dbo.DATA0199.MISC_CHARGE_CATEGORY NOT IN ('Sonstiges', 'Nebenkosten Handel')
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenRest						
			), 0) AS LastschriftRest_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(NKLastschriften) AS NKLastschrift_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0132.RKEY, 
							(dbo.DATA0132.MISC_TOT / dbo.DATA0132.EX_RATE) AS NKLastschriften

						FROM         dbo.DATA0132 INNER JOIN
									dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
									dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

						WHERE      
									--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
									REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblNKLastschriften						
			), 0) AS SonstigeLastschrift_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(Rest) AS LastschriftRest_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Rest
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
									REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
									AND dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Nebenkosten Handel'
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenRest						
			), 0) AS LastschriftNebenkostenHandel_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(Rest) AS LastschriftRest_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Rest
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
									REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
									AND dbo.DATA0199.MISC_CHARGE_CATEGORY IN ('Filmerstellung', 'complete mounted PCB', 'Sonstiges', 'Transportkosten', 'Selection cost', 'Debit Handel Rekla.', 'Rekla. / Belastung', 'Nebenkosten/KleMenZ', 'additional cost QA')
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenRest						
			), 0) AS LastschriftRestkostenJHA_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Einkauf (BM, CU, PP, PCB, Masslam)
			ISNULL(( 
				SELECT
					SUM(NK) AS NKEinkauf
				FROM
				(
					SELECT DISTINCT 
						D107_.RKEY,
						(D107_.SHIPPING + D107_.MISC_TOT) / D107_.EX_RATE  AS NK
					FROM         dbo.DATA0070 AS D70_ INNER JOIN
										dbo.DATA0071 AS D71_ ON D70_.RKEY = D71_.PO_PTR INNER JOIN
										dbo.DATA0108 AS D108_ ON D71_.RKEY = D108_.DATA0071_PTR INNER JOIN
										dbo.DATA0107 AS D107_ ON D108_.DATA0107_PTR = D107_.RKEY INNER JOIN
										dbo.DATA0017 AS D17_ ON D71_.INVT_PTR = D17_.RKEY
					WHERE
						--RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
						REPLACE(RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						AND (D107_.INV_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (D107_.INV_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblNKEinkauf_
			), 0) AS NKEinkauf_EUR,
			ISNULL((
				SELECT TOP 1
					SUM(EKPreis_EUR*Menge)/SUM(Menge) AS DEKPreis_EUR_
				FROM
				(
					SELECT DISTINCT 
						D108_.RKEY,
						D107_.INV_DATE,
						D108_.PRICE / D107_.EX_RATE  AS EKPreis_EUR,
						D108_.QUANTITY AS Menge
					FROM         dbo.DATA0070 AS D70_ INNER JOIN
										dbo.DATA0071 AS D71_ ON D70_.RKEY = D71_.PO_PTR INNER JOIN
										dbo.DATA0108 AS D108_ ON D71_.RKEY = D108_.DATA0071_PTR INNER JOIN
										dbo.DATA0107 AS D107_ ON D108_.DATA0107_PTR = D107_.RKEY INNER JOIN
										dbo.DATA0017 AS D17_ ON D71_.INVT_PTR = D17_.RKEY
					WHERE
						--RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
						REPLACE(RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						AND (D107_.INV_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (D107_.INV_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblDEKPreis_EUR
			), 0) AS DEKPreis_EUR,
			ISNULL((
				SELECT TOP 1
					EKPreis_EUR_
				FROM
				(
					SELECT DISTINCT 
						D108_.RKEY,
						D107_.INV_DATE,
						D108_.PRICE / D107_.EX_RATE  AS EKPreis_EUR_
					FROM         dbo.DATA0070 AS D70_ INNER JOIN
										dbo.DATA0071 AS D71_ ON D70_.RKEY = D71_.PO_PTR INNER JOIN
										dbo.DATA0108 AS D108_ ON D71_.RKEY = D108_.DATA0071_PTR INNER JOIN
										dbo.DATA0107 AS D107_ ON D108_.DATA0107_PTR = D107_.RKEY INNER JOIN
										dbo.DATA0017 AS D17_ ON D71_.INVT_PTR = D17_.RKEY
					WHERE
						--RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
						REPLACE(RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						AND (D107_.INV_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (D107_.INV_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblEKPreis_EUR
				ORDER BY INV_DATE DESC
			), 0) AS EKPreis_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Gutschriften
			/*
			ISNULL((
				SELECT
					SUM(Gutschrift) AS Gutschrift_EUR
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0116.RKEY,
						(dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE AS Gutschrift
					FROM         dbo.DATA0060 INNER JOIN
										  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
										  dbo.DATA0116 INNER JOIN
										  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschrift	
			), 0) AS Gutschrift_EUR,	
			*/
			ISNULL((
				SELECT
					SUM(BetragNetto) AS Gutschrift_EUR
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0116.RKEY,
						dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY) AS BetragNetto
					FROM         dbo.DATA0116 INNER JOIN
							  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
							  dbo.DATA0060 INNER JOIN
							  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschrift	
			), 0) AS Gutschrift_EUR,
			ISNULL((
				SELECT
					SUM(GSNK) AS GutschriftNK_EUR
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0116.RKEY,
						(
							((dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE)
							-
							(dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY)) 
						) AS GSNK
					FROM         dbo.DATA0116 INNER JOIN
							  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
							  dbo.DATA0060 INNER JOIN
							  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschriftNK
			), 0) AS GutschriftNebenkosten_EUR,		
			ISNULL((
				SELECT
					SUM(RMenge) AS GutschriftMenge
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0098.RKEY,
						dbo.DATA0098.QTY_AUTH AS RMenge
					FROM         
						dbo.DATA0098 
					WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
							AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschriftMenge
			), 0) AS GutschriftMenge,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Provision
			ISNULL((
				SELECT TOP 1
					dbo.DATA0009.SALES_REP_NAME
				FROM         dbo.DATA0006 INNER JOIN
										dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
										dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
										dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
										dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
										dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
										dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
										dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
										dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
										dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
										dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
										dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
				WHERE
					dbo.DATA0050.RKEY = MAX(D50_PTR)
					AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
					AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
			), '') AS ProvisionVerteter,
			SUM(FA_Umsatz_VertProvision) AS VerkaufProvision_EUR,
			ISNULL((
				SELECT
					SUM(Provision) AS GutschriftNK_EUR
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0116.RKEY,
						ISNULL(dbo.DATA0509.COMMISSION_DEBITED / dbo.DATA0509.EXCHANGE_RATE, 0) AS Provision
					FROM         dbo.DATA0125 INNER JOIN
										  dbo.DATA0509 ON dbo.DATA0125.DATA0509_PTR = dbo.DATA0509.RKEY RIGHT OUTER JOIN
										  dbo.DATA0116 INNER JOIN
										  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
										  dbo.DATA0060 INNER JOIN
										  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY ON 
										  dbo.DATA0125.MEMO_PTR = dbo.DATA0116.RKEY LEFT OUTER JOIN
										  dbo.DATA0508 INNER JOIN
										  dbo.DATA0061 ON dbo.DATA0508.DATA0061_PTR = dbo.DATA0061.RKEY INNER JOIN
										  dbo.DATA0124 ON dbo.DATA0508.RKEY = dbo.DATA0124.DATA0508_PTR ON dbo.DATA0116.RKEY = dbo.DATA0124.MEMO_PTR
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschriftNK
			), 0) AS GutschriftProvision_EUR,
			ISNULL((
				SELECT TOP 1
					dbo.DATA0009.COMMISSION_1
				FROM         dbo.DATA0006 INNER JOIN
										dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
										dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
										dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
										dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
										dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
										dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
										dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
										dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
										dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
										dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
										dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
				WHERE
					dbo.DATA0050.RKEY = MAX(D50_PTR)
					AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
					AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
			), 0)/100 AS ProvisionVerteterProzent,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Produktion
			ISNULL((
				SELECT TOP 1
					SUM(QUAN_SCH) AS RES
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0006.RKEY, 
						dbo.DATA0006.QUAN_SCH
					FROM         dbo.DATA0006 --INNER JOIN
											--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND dbo.DATA0006.ROOT_PTR=0
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
						AND dbo.DATA0006.PROD_STATUS=5
				) AS tblAufgelegt
			), 0) AS Aufgelegt,
			ISNULL((
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_REJ) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_REJ 
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) <> 'R'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAusschuss
				), 0)
				+
				ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
					SELECT
						SUM(RMenge) AS GutschriftMenge
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0098.RKEY,
							dbo.DATA0098.QTY_AUTH AS RMenge
						FROM         
							dbo.DATA0098 
						WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftMenge
				), 0)
				-
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_PROD) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_PROD
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblProduziert
				), 0)
			), 0) AS Ausschuss,
			ISNULL((
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_PROD) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_PROD
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblProduziert
				), 0)
				-
				ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
					SELECT
						SUM(RMenge) AS GutschriftMenge
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0098.RKEY,
							dbo.DATA0098.QTY_AUTH AS RMenge
						FROM         
							dbo.DATA0098 
						WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftMenge
				), 0)
				-
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_REJ) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_REJ
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='W'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAusschuss_R
				), 0)
				+
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_PROD) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_PROD
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblProduziert
				), 0)
			), 0) AS Produziert,
			ISNULL((
				SELECT TOP 1
					SUM(QUAN_REJ)/SUM(QUAN_SCH) AS RES
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0006.RKEY, 
						dbo.DATA0006.QUAN_REJ,
						dbo.DATA0006.QUAN_SCH
					FROM         dbo.DATA0006 --INNER JOIN
											--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND dbo.DATA0006.ROOT_PTR=0
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						AND dbo.DATA0006.PROD_STATUS=5
				) AS tblAusschuss
			), 0) AS Ausschuss_Proz,
			ISNULL((
					SELECT
						SUM(QTY_ON_HAND) AS LPKonsi_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0053.RKEY, 
							dbo.DATA0053.QTY_ON_HAND
						FROM         dbo.DATA0006 INNER JOIN
												dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
						WHERE     
								dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
					) AS tblNLPKonsiMenge
			), 0) AS LPKonsi,
			ISNULL((
					SELECT
						SUM(QTY_ON_HAND*LAST_SO_PRICE) AS LPKonsi_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0053.RKEY, 
							dbo.DATA0053.QTY_ON_HAND,
							dbo.DATA0050.LAST_SO_PRICE
						--FROM         dbo.DATA0006 INNER JOIN
						--						dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
						FROM         dbo.DATA0006 INNER JOIN
											  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
						WHERE     
								dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
					) AS tblNLPKonsiMenge
			--), 0) * MAX(ELP_gesend_gewDP)  AS LPKonsi_EUR,
			), 0)  AS LPKonsi_EUR,
			ISNULL((
				SELECT TOP 1
					SUM(gesendet_FA * KNX * KNY / ELP_KN / 10000) AS RES
				FROM
				(
					SELECT 
						dbo.ARTIKELDATEN.*,
						dbo.DATA0050.RKEY AS D0050_PTR,
						CASE 
							WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
								ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
								* 
								dbo.DATA0060.EXCH_RATE 
							ELSE
								dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
						END AS ELP_Preis_EUR,
						dbo.DATA0052.QUAN_SHP AS gesendet_FA

					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE
						(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblFAUmsatz
				WHERE D0050_PTR = MAX(D50_PTR) 
			), 0) AS Durch_VK_dm2,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Verkauf
			ISNULL((
				SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
				FROM         dbo.DATA0006 INNER JOIN
										dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
										dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
										dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
				WHERE 
					--dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
					dbo.DATA0053.CUST_PART_PTR = MAX(D50_PTR)
					AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
					AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
			), 0) AS LMenge,
			ISNULL((
				SELECT
					SUM(NK) AS NKVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.TOOLING_CHARGES AS NK
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblNKVerkauf
			), 0) AS NKVerkauf_EUR,
			ISNULL((
				SELECT
					SUM(Rabatt) AS RabattVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.DISCOUNT_AMOUNT AS Rabatt
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblRabattVerkauf
			), 0) AS RabattVerkauf_EUR,
			ISNULL((
				SELECT
					SUM(Einzuschlag) AS EZVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.RUSH_CHARGE_AMOUNT AS Einzuschlag
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblEZVerkauf
			), 0) AS EZVerkauf_EUR,
			ISNULL((
				SELECT
					SUM(Versandkosten) AS VersandVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.SHIPPING_CHARGES AS Versandkosten
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblVersandVerkauf
			), 0) AS VersandVerkauf_EUR,

			(
				SUM(FA_Umsatz)
				-
				ISNULL((
					SELECT TOP 1 
						SUM(Gutschrift) AS Gutschrift_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0116.RKEY,
							dbo.DATA0116.CREDIT_AMOUNT/dbo.DATA0116.EX_RATE - dbo.DATA0116.STATE_TAX AS Gutschrift
						FROM         dbo.DATA0060 INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
											  dbo.DATA0116 INNER JOIN
											  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE     (dbo.DATA0060.CUST_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschrift	
				), 0)
			) AS FA_Umsatz_ohneGutschrift,
			ISNULL((
				SELECT TOP 1
					--SUM(FK) AS FK1,
					SUM(FK/CASE WHEN PlusZeichen_1=0 THEN 1 ELSE CASE WHEN PlusZeichen_1>0 AND PlusZeichen_2=0 THEN 2 ELSE 3 END END) AS FK_EUR
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0072.RKEY,
						dbo.DATA0072.DESCRIPTION2 AS LP,
						(dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE * dbo.DATA0072.QUAN_ORD) AS FK,
						CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 1) AS PlusZeichen_1,
						CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 21) AS PlusZeichen_2
					FROM         dbo.DATA0070 INNER JOIN
										  dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR
					WHERE
						LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION, '')), 3) = 'FK '
						AND LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION2, '')), 3) = 'LP '
						AND dbo.DATA0072.DESCRIPTION2 COLLATE SQL_Latin1_General_CP1_CI_AS LIKE '%' + LTRIM(RTRIM(LP)) + '%' 
						AND (dbo.DATA0070.PO_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0070.PO_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblFK
			), 0) AS Frachtkosten_EUR,
			ISNULL((
				ISNULL(SUM(FA_reserviert), 0)
				+
				ISNULL((
					SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				), 0) 
				+
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND) AS LPKonsi
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND
							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				), 0) 
			), 0) AS GesamtVerkaufsmenge,
			ISNULL((
					SELECT TOP 1
						SUM(gesendet * Preis) / SUM(gesendet) AS DVKPreis
					FROM
					(
						SELECT 
								dbo.DATA0052.QUAN_SHP AS gesendet,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										/ 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
								END AS Preis

						FROM         dbo.DATA0006 INNER JOIN
											  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE     
								--RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) = @para1 --'51051.300' --'  
								dbo.DATA0050.RKEY=MAX(D50_PTR)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblDVKPreis
			), 0) AS DVKPreis,
			ISNULL((
					SELECT TOP 1
						SUM(gesendet * Preis) / SUM(gesendet) AS DVKPreis
					FROM
					(
						SELECT 
								dbo.DATA0052.QUAN_SHP AS gesendet,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										/ 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
								END AS Preis

						FROM         dbo.DATA0006 INNER JOIN
											  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE     
								--RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) = @para1 --'51051.300' --'  
								dbo.DATA0010.RKEY=MAX(D10_PTR)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblDVKPreis
			), 0) AS DVKPreis_proKunde,
			ISNULL((
					SELECT TOP 1
						SUM(gesendet * Preis) / SUM(gesendet) AS DVKPreis
					FROM
					(
						SELECT 
								dbo.DATA0052.QUAN_SHP AS gesendet,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										/ 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
								END AS Preis

						FROM         dbo.DATA0006 INNER JOIN
											  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE     
								--RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) = @para1 --'51051.300' --'  
								dbo.DATA0008.PROD_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = MAX(PC)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblDVKPreis
			), 0) AS DVKPreis_proPC,
			ISNULL((
					SELECT TOP 1 dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE AS RES
					FROM         dbo.DATA0054 INNER JOIN
						dbo.DATA0006 ON dbo.DATA0054.WO_PTR = dbo.DATA0006.RKEY INNER JOIN
						dbo.DATA0050 INNER JOIN
						dbo.DATA0060 ON dbo.DATA0050.RKEY = dbo.DATA0060.CUST_PART_PTR ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY
					WHERE
								dbo.DATA0050.RKEY=MAX(D50_PTR)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0060.ENT_DATE DESC
			), 0) AS LetzterKommPreis,
			ISNULL((
					SELECT TOP 1 dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE AS RES
					FROM         dbo.DATA0054 INNER JOIN
						dbo.DATA0006 ON dbo.DATA0054.WO_PTR = dbo.DATA0006.RKEY INNER JOIN
						dbo.DATA0050 INNER JOIN
						dbo.DATA0060 ON dbo.DATA0050.RKEY = dbo.DATA0060.CUST_PART_PTR ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY
					WHERE
								dbo.DATA0060.CUSTOMER_PTR=MAX(D10_PTR)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0060.ENT_DATE DESC
			), 0) AS LetzterKommPreis_proKunde,
			ISNULL((
					SELECT TOP 1 dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE AS RES
					FROM         dbo.DATA0054 INNER JOIN
										  dbo.DATA0006 ON dbo.DATA0054.WO_PTR = dbo.DATA0006.RKEY INNER JOIN
										  dbo.DATA0050 INNER JOIN
										  dbo.DATA0060 ON dbo.DATA0050.RKEY = dbo.DATA0060.CUST_PART_PTR ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
										  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY
					WHERE
								dbo.DATA0008.PROD_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = MAX(PC)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0060.ENT_DATE DESC
			), 0) AS LetzterKommPreis_proPC,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			SUM(Vorlageprovision) AS Vorlageprovision_EUR
			
		FROM
		(
			SELECT
				tblDaten.*
				--CAST(ELP_gesend_gewDP*FA_reserviert AS FLOAT) AS LB_in_EUR
			FROM
			(
				SELECT
					tblNachKalk_Daten_2.D10_PTR,
					tblNachKalk_Daten_2.Kunde,
					tblNachKalk_Daten_2.Aufbereitung,
					tblNachKalk_Daten_2.LP,
					tblNachKalk_Daten_2.D50_PTR,
					tblNachKalk_Daten_2.D60_PTR,
					CASE
						WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten_2.LP), 3), 1)='1' THEN 
							'Intern'
						ELSE
							CASE
								WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten_2.LP), 3), 1)='2' THEN 
									'Masslam'
								ELSE
									CASE
										WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten_2.LP), 3), 1)='3' THEN 
											'Handel'
										ELSE
											'unbekannt'
									END
							END
					END AS InternMasslamHandel,
					tblNachKalk_Daten_2.PC,
					--tblNachKalk_Daten_2.AnzKommissionen,
					--tblNachKalk_Daten_2.Kommission,
					tblNachKalk_Daten_2.FA,
					ISNULL((
						ISNULL((
							SELECT TOP 1
								SUM(RES) AS umsatz
							FROM
							(
								SELECT 
									dbo.DATA0006.RKEY AS D0006_PTR,
									(
										CASE 
											WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
												ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
												/ 
												dbo.DATA0060.EXCH_RATE 
											ELSE
												dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
										END --ELP_Preis_EUR
										*
										dbo.DATA0052.QUAN_SHP --AS gesendet_FA
									) AS RES
								FROM         dbo.DATA0006 INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
								WHERE
									(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							) AS tblFAUmsatz
							WHERE 
								D0006_PTR = D6_PTR 
								--D0006_PTR = CASE WHEN LEFT(tblNachKalk_Daten_2.FA, 1)='S' THEN tblNachKalk_Daten_2.D6S_PTR ELSE tblNachKalk_Daten_2.D6_PTR END
						), 0)
					), 0) AS FA_Umsatz,
					ISNULL((
						ISNULL((
							SELECT TOP 1
								SUM(RES) AS umsatz
							FROM
							(
								SELECT 
									dbo.DATA0006.RKEY AS D0006_PTR,
									(
										CASE 
											WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
												ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
												/ 
												dbo.DATA0060.EXCH_RATE 
											ELSE
												dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
										END --ELP_Preis_EUR
										*
										dbo.DATA0052.QUAN_SHP --AS gesendet_FA
									) AS RES
								FROM         dbo.DATA0006 INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
								WHERE
									(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
									AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) = 'R'
							) AS tblFAUmsatz
							WHERE 
								D0006_PTR = D6_PTR 
						), 0)
					), 0) AS FA_Umsatz_R,
					ISNULL((
						SELECT TOP 1
							SUM(RES) AS umsatzProv
						FROM
						(
							SELECT 
								dbo.DATA0006.RKEY AS D0006_PTR,
								(
									CASE 
										WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
											ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
											/ 
											dbo.DATA0060.EXCH_RATE 
										ELSE
											dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
									END --ELP_Preis_EUR
									*
									dbo.DATA0052.QUAN_SHP --AS gesendet_FA
									*
									(dbo.DATA0509.SALES_COMMISSION_PER/100)
								) AS RES
							FROM         dbo.DATA0006 INNER JOIN
												  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
												  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
												  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
												  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
												  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
												  dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
												  dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR
							WHERE
								(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblFAUmsatzProv
						WHERE D0006_PTR = D6_PTR 
					), 0) AS FA_Umsatz_VertProvision,
					tblNachKalk_Daten_2.EK_Handel_Masslam_HauptFA AS EKHandelNasslamFA,
					tblNachKalk_Daten_2.Matko_EK_HauptFA,
					tblNachKalk_Daten_2.Matko_EK_IL,
					tblNachKalk_Daten_2.Matko_GK_HauptFA + tblNachKalk_Daten_2.Matko_So_HauptFA AS Matko_GK_SO,
					tblNachKalk_Daten_2.Matko_GK_IL + tblNachKalk_Daten_2.Matko_So_IL AS Matko_GK_SO_IL,
					tblNachKalk_Daten_2.Matko_GK_HauptFA,
					tblNachKalk_Daten_2.Matko_GK_IL,
					tblNachKalk_Daten_2.Matko_So_HauptFA,
					tblNachKalk_Daten_2.Matko_So_IL,
					tblNachKalk_Daten_2.Fremd_EK_HauptFA,
					tblNachKalk_Daten_2.Ekosten_var_HauptFA,
					tblNachKalk_Daten_2.Ekosten_var_IL,
					tblNachKalk_Daten_2.Ekosten_fix_HauptFA,
					tblNachKalk_Daten_2.Ekosten_fix_IL,
					tblNachKalk_Daten_2.Leasing_var_HauptFA,
					tblNachKalk_Daten_2.Leasing_var_IL,
					tblNachKalk_Daten_2.Leasing_fix_HauptFA,
					tblNachKalk_Daten_2.Leasing_fix_IL,
					tblNachKalk_Daten_2.Inst_var_HauptFA,
					tblNachKalk_Daten_2.Inst_var_IL,
					tblNachKalk_Daten_2.Inst_fix_HauptFA,
					tblNachKalk_Daten_2.Inst_fix_IL,
					tblNachKalk_Daten_2.Sokosten_var_HauptFA,
					tblNachKalk_Daten_2.Sokosten_var_IL,
					tblNachKalk_Daten_2.Sokosten_fix_HauptFA,
					tblNachKalk_Daten_2.Sokosten_fix_IL,
					tblNachKalk_Daten_2.Pers_var_HauptFA,
					tblNachKalk_Daten_2.Pers_var_IL,
					tblNachKalk_Daten_2.Pers_fix_HauptFA,
					tblNachKalk_Daten_2.Pers_fix_IL,
					--tblNachKalk_Daten_2.Kosten_Uml,
					ISNULL((SELECT TOP 1 QTY_ALLOC AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_reserviert,
					ISNULL((
							SELECT TOP 1
								SUM(RES) AS LBEur
							FROM
							(
								SELECT DISTINCT
									dbo.DATA0053.RKEY,
									(dbo.DATA0060.PART_PRICE/dbo.DATA0060.EXCH_RATE*dbo.DATA0053.QTY_ALLOC) AS RES
									--SUM(dbo.DATA0053.QTY_ALLOC) AS RES
								FROM         dbo.DATA0060 INNER JOIN
													  dbo.DATA0063 ON dbo.DATA0060.RKEY = dbo.DATA0063.SO_PTR INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0063.PART_BATCH_PTR = dbo.DATA0053.RKEY
								WHERE dbo.DATA0053.WORK_ORDER_PTR = D6_PTR 
							) AS tblLBEur
					), 0) AS LB_in_EUR,
					ISNULL((SELECT TOP 1 (QTY_ON_HAND - QTY_ALLOC) AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_freiLB,
					--tblNachKalk_Daten_2.Aus_in_Proz,
					ISNULL((
						SELECT TOP 1
							SUM(ELP_Preis_EUR*gesendet_FA)/SUM(gesendet_FA) AS umsatz
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.ACT_COMPL_DATE,
								dbo.DATA0050.RKEY AS D0050_PTR,
								--dbo.DATA0006.RKEY AS D0006_PTR,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										* 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
								END AS ELP_Preis_EUR,
								dbo.DATA0052.QUAN_SHP AS gesendet_FA

							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						) AS tblFAUmsatz
						WHERE 
							D0050_PTR = tblNachKalk_Daten_2.D50_PTR
							AND (ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						--WHERE D0006_PTR = D6_PTR 
					), 
						(
							SELECT TOP 1 (dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE) AS RES 
							FROM dbo.DATA0054 INNER JOIN  dbo.DATA0060 ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY 
							WHERE dbo.DATA0060.CUST_PART_PTR = tblNachKalk_Daten_2.D50_PTR
						)
					) AS ELP_gesend_gewDP,
					ISNULL((
						SELECT TOP 1
							SUM(ELP_Preis_EUR*gesendet_FA)/SUM(gesendet_FA) AS umsatz
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.ACT_COMPL_DATE,
								dbo.DATA0010.RKEY AS D0010_PTR,
								--dbo.DATA0006.RKEY AS D0006_PTR,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										* 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
								END AS ELP_Preis_EUR,
								dbo.DATA0052.QUAN_SHP AS gesendet_FA

							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						) AS tblFAUmsatz
						WHERE 
							D0010_PTR = tblNachKalk_Daten_2.D10_PTR
							AND (ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						--WHERE D0006_PTR = D6_PTR 
					), 
						(
							SELECT TOP 1 (dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE) AS RES 
							FROM dbo.DATA0054 INNER JOIN  dbo.DATA0060 ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY 
							WHERE dbo.DATA0060.CUSTOMER_PTR = tblNachKalk_Daten_2.D10_PTR
						)
					) AS ELP_gesend_gewDP_proKunde,
					ISNULL((
						SELECT TOP 1
							SUM(ELP_Preis_EUR*gesendet_FA)/SUM(gesendet_FA) AS umsatz
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.ACT_COMPL_DATE,
								dbo.DATA0008.PROD_CODE AS D0008_PROD_CODE,
								--dbo.DATA0006.RKEY AS D0006_PTR,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										* 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
								END AS ELP_Preis_EUR,
								dbo.DATA0052.QUAN_SHP AS gesendet_FA

							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						) AS tblFAUmsatz
						WHERE 
							D0008_PROD_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = tblNachKalk_Daten_2.PC
							AND (ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						--WHERE D0006_PTR = D6_PTR 
					), 
						(
							SELECT TOP 1 (dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE) AS RES 
							FROM         dbo.DATA0050 INNER JOIN
							  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
							  dbo.DATA0060 ON dbo.DATA0050.RKEY = dbo.DATA0060.CUST_PART_PTR
							WHERE dbo.DATA0008.PROD_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = tblNachKalk_Daten_2.PC
						)
					) AS ELP_gesend_gewDP_proPC,
					tblNachKalk_Daten_2.FAkomplAm,
					tblNachKalk_Daten_2.ArtikelCode,
					tblNachKalk_Daten_2.Herstellung_AnzMinuten,
					ISNULL(tblNachKalk_Daten_2.Vertrieb_var, 0) AS Vertriebskosten_var,
					ISNULL(tblNachKalk_Daten_2.Vertrieb_fix, 0) AS Vertriebskosten_fix,
					ISNULL(tblNachKalk_Daten_2.Verwaltung_var, 0) AS Verwaltungskosten_var,
					ISNULL(tblNachKalk_Daten_2.Verwaltung_fix, 0) AS Verwaltungskosten_fix,
					ISNULL(tblNachKalk_Daten_2.PersVertrieb_var, 0) AS PersVertriebskosten_var,
					ISNULL(tblNachKalk_Daten_2.PersVertrieb_fix, 0) AS PersVertriebskosten_fix,
					ISNULL(tblNachKalk_Daten_2.PersVerwaltung_var, 0) AS PersVerwaltungskosten_var,
					ISNULL(tblNachKalk_Daten_2.PersVerwaltung_fix, 0) AS PersVerwaltungskosten_fix,
					ISNULL(tblNachKalk_Daten_2.SollVorgabe_BM_Anteil, 0) AS SollVorgabe_BM_Anteil,
					ISNULL(tblNachKalk_Daten_2.CAMKosten, 0) AS CAMKosten,
					ISNULL(tblNachKalk_Daten_2.SoKostVertrieb_var, 0) AS SoKostVertriebskosten_var,
					ISNULL(tblNachKalk_Daten_2.SoKostVertrieb_fix, 0) AS SoKostVertriebskosten_fix,
					ISNULL(tblNachKalk_Daten_2.SoKostVerwaltung_var, 0) AS SoKostVerwaltungskosten_var,
					ISNULL(tblNachKalk_Daten_2.SoKostVerwaltung_fix, 0) AS SoKostVerwaltungskosten_fix,
					--ISNULL(tblNachKalk_Daten_2.HandelEKVol, 0) AS HandelEKVol,
					--ISNULL(tblNachKalk_Daten_2.InhouseMasslamlEKVol, 0) AS InhouseMasslamlEKVol,
					--ISNULL(tblNachKalk_Daten_2.VKVol, 0) AS VKVol
					ISNULL(CASE WHEN LEFT(tblNachKalk_Daten_2.FA, 1) IN ('S', 'R', 'W') THEN 0 ELSE tblNachKalk_Daten_2.HandelEKVol END, 0) AS HandelEKVol,
					ISNULL(CASE WHEN LEFT(tblNachKalk_Daten_2.FA, 1) IN ('S', 'R', 'W') THEN 0 ELSE tblNachKalk_Daten_2.InhouseMasslamlEKVol END, 0) AS InhouseMasslamlEKVol,
					ISNULL(CASE WHEN LEFT(tblNachKalk_Daten_2.FA, 1) IN ('S', 'R', 'W') THEN 0 ELSE tblNachKalk_Daten_2.VKVol END, 0) AS VKVol,
					ISNULL(Vorlageprovision, 0) AS Vorlageprovision
					--ISNULL(tblNachKalk_Daten_2.NKEinkauf, 0) AS NKEinkauf

				FROM
					LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
				WHERE 
					tblNachKalk_Daten_2.FAkomplAm >= CONVERT(DATETIME, @para6, 103)
					AND tblNachKalk_Daten_2.FAkomplAm <= CONVERT(DATETIME, @para7, 103)
					AND tblNachKalk_Daten_2.Aufbereitung = @para1
					AND tblNachKalk_Daten_2.D10_PTR IN (SELECT D10_PTR FROM @tblD10LP)
					AND tblNachKalk_Daten_2.D50_PTR IN (SELECT D50_PTR FROM @tblD50LP)
					AND tblNachKalk_Daten_2.D8_PTR IN (SELECT D8_PTR FROM @tblD8LP)
			) AS tblDaten
		) AS tblDatenGrp 
		WHERE 
			InternMasslamHandel IN (ISNULL(@para8, ''), ISNULL(@para9, ''), ISNULL(@para10, ''), ISNULL(@para12, ''))
		GROUP BY
			D10_PTR,
			Kunde, 
			LP
		ORDER BY
			LP

		IF @para11='LP' 
		BEGIN
			SELECT * FROM @tblDaten ORDER BY FA_Umsatz DESC
		END

		IF @para11='Kunde' 
		BEGIN
			SELECT
				D10_PTR,
				Kunde,
				COUNT(DISTINCT LP) AS AnzLP,
				SUM(AnzFA) AS AnzFA,
				COUNT(DISTINCT PC) AS AnzPC,
				MAX(ELP_gesend_gewDP_proKunde) AS ELP_gesend_gewDP,
				SUM(FA_Umsatz) AS FA_Umsatz,
				SUM(FA_Umsatz_R) AS FA_Umsatz_R,
				SUM(LB_in_EUR) AS LB_in_EUR,
				SUM(EKHandelMasslamFA_EUR) AS EKHandelMasslamFA_EUR,
				SUM(Matko_EK_EUR) AS Matko_EK_EUR,
				SUM(Matko_EK_IL_EUR) AS Matko_EK_IL_EUR,
				SUM(Matko_GK_SO_EUR) AS Matko_GK_SO_EUR,
				SUM(Matko_GK_SO_IL_EUR) AS Matko_GK_SO_IL_EUR,
				SUM(Matko_GK) AS Matko_GK,
				SUM(Matko_GK_IL) AS Matko_GK_IL,
				SUM(Matko_So) AS Matko_So,
				SUM(Matko_So_IL) AS Matko_So_IL,
				SUM(Fremd_EK_EUR) AS Fremd_EK_EUR,
				SUM(Pers_var_EUR) AS Pers_var_EUR,
				SUM(Pers_fix_EUR) AS Pers_fix_EUR,
				SUM(Ekosten_var_EUR) AS Ekosten_var_EUR,
				SUM(Ekosten_fix_EUR) AS Ekosten_fix_EUR,
				SUM(Leasing_var_EUR) AS Leasing_var_EUR,
				SUM(Leasing_fix_EUR) AS Leasing_fix_EUR,
				SUM(Inst_var_EUR) AS Inst_var_EUR,
				SUM(Inst_fix_EUR) AS Inst_fix_EUR,
				SUM(Sokosten_var_EUR) AS Sokosten_var_EUR,
				SUM(Sokosten_fix_EUR) AS Sokosten_fix_EUR,
				SUM(AlleKostenarten_EUR) AS AlleKostenarten_EUR,
				SUM(AlleKostenarten_var_EUR) AS AlleKostenarten_var_EUR,
				SUM(AlleKostenarten_fix_EUR) AS AlleKostenarten_fix_EUR,
				SUM(Materialkosten_EUR) AS Materialkosten_EUR,
				SUM(ELP_freiLB) AS ELP_freiLB,
				SUM(ELP_reserviert) AS ELP_reserviert,
				MAX(FAKomplAm) AS FAKomplAm,
				MAX(ArtikelCode) AS ArtikelCode,
				SUM(Herstellung_AnzMinuten) AS Herstellung_AnzMinuten,
				SUM(Vertriebskosten_var) AS Vertriebskosten_var,
				SUM(Vertriebskosten_fix) AS Vertriebskosten_fix,
				SUM(Verwaltungskosten_var) AS Verwaltungskosten_var,
				SUM(Verwaltungskosten_fix) AS Verwaltungskosten_fix,
				SUM(PersVertriebskosten_var) AS PersVertriebskosten_var,
				SUM(PersVertriebskosten_fix) AS PersVertriebskosten_fix,
				SUM(PersVerwaltungskosten_var) AS PersVerwaltungskosten_var,
				SUM(PersVerwaltungskosten_fix) AS PersVerwaltungskosten_fix,
				SUM(SollVorgabe_BM_Anteil) AS SollVorgabe_BM_Anteil,
				SUM(CAMKosten) AS CAMKosten,
				SUM(SoKostVertriebskosten_var) AS SoKostVertriebskosten_var,
				SUM(SoKostVertriebskosten_fix) AS SoKostVertriebskosten_fix,
				SUM(SoKostVerwaltungskosten_var) AS SoKostVerwaltungskosten_var,
				SUM(SoKostVerwaltungskosten_fix) AS SoKostVerwaltungskosten_fix,
				SUM(HandelEKVol) AS HandelEKVol,
				SUM(InhouseMasslamEKVol) AS InhouseMasslamEKVol,
				SUM(VKVol) AS VKVol,
				SUM(Lastschrift_EUR) AS Lastschrift_EUR,
				SUM(LastschriftNebenkosten_EUR) AS LastschriftNebenkosten_EUR,
				SUM(LastschriftSonstiges_EUR) AS LastschriftSonstiges_EUR,
				SUM(LastschriftRest_EUR) AS LastschriftRest_EUR,
				SUM(SonstigeLastschrift_EUR) AS SonstigeLastschrift_EUR,
				SUM(LastschriftNebenkostenHandel_EUR) AS LastschriftNebenkostenHandel_EUR,
				SUM(LastschriftRestkostenJHA_EUR) AS LastschriftRestkostenJHA_EUR,
				SUM(NKEinkauf_EUR) AS NKEinkauf_EUR,
				MAX(DEKPreis_EUR) AS DEKPreis_EUR,
				MAX(EKPreis_EUR) AS EKPreis_EUR,
				SUM(Gutschrift_EUR) AS Gutschrift_EUR,
				SUM(GutschriftNebenkosten_EUR) AS GutschriftNebenkosten_EUR,
				SUM(GutschriftMenge) AS GutschriftMenge,
				MAX(ProvisionVertreter) AS ProvisionVertreter,
				SUM(VerkaufProvision_EUR) AS VerkaufProvision_EUR,
				SUM(GutschriftProvision_EUR) AS GutschriftProvision_EUR,
				MAX(ProvisionVertreterProzent) AS ProvisionVertreterProzent,
				SUM(Aufgelegt) AS Aufgelegt,
				SUM(Ausschuss) AS Ausschuss,
				SUM(Aufgelegt*DVKPreis) AS Aufgelegt_EUR,
				SUM(Ausschuss*DVKPreis) AS Ausschuss_EUR,
				SUM(Produziert) AS Produziert,
				SUM(Ausschuss)/SUM(Aufgelegt) AS Ausschuss_Proz,
				SUM(LPKonsi) AS LPKonsi,
				SUM(LPKonsi_EUR) AS LPKonsi_EUR,
				AVG(Durch_VK_dm2) AS Durch_VK_dm2,
				SUM(LMenge) AS LMenge,
				SUM(NKVerkauf_EUR) AS NKVerkauf_EUR,
				SUM(RabattVerkauf_EUR) AS RabattVerkauf_EUR,
				SUM(EZVerkauf_EUR) AS EZVerkauf_EUR,
				SUM(VersandVerkauf_EUR) AS VersandVerkauf_EUR,
				SUM(FA_Umsatz_ohneGutschrift) AS FA_Umsatz_ohneGutschrift,
				SUM(Frachtkosten_EUR) AS Frachtkosten_EUR,
				SUM(GesamtVerkaufsmenge) AS GesamtVerkaufsmenge,
				MAX(DVKPreis_proKunde) AS DVKPreis,
				MAX(LetzterKommPreis_proKunde) AS LetzterKommPreis,
				SUM(Vorlageprovision) AS Vorlageprovision
			FROM @tblDaten
			GROUP BY
				D10_PTR,
				Kunde
			ORDER BY SUM(FA_Umsatz) DESC
		END

		IF @para11='PC' 
		BEGIN
			SELECT
				--D10_PTR,
				COUNT(DISTINCT Kunde) AS AnzKunden,
				COUNT(DISTINCT LP) AS AnzLP,
				SUM(AnzFA) AS AnzFA,
				PC,
				MAX(ELP_gesend_gewDP_proPC) AS ELP_gesend_gewDP,
				SUM(FA_Umsatz) AS FA_Umsatz,
				SUM(FA_Umsatz_R) AS FA_Umsatz_R,
				SUM(LB_in_EUR) AS LB_in_EUR,
				SUM(EKHandelMasslamFA_EUR) AS EKHandelMasslamFA_EUR,
				SUM(Matko_EK_EUR) AS Matko_EK_EUR,
				SUM(Matko_EK_IL_EUR) AS Matko_EK_IL_EUR,
				SUM(Matko_GK_SO_EUR) AS Matko_GK_SO_EUR,
				SUM(Matko_GK_SO_IL_EUR) AS Matko_GK_SO_IL_EUR,
				SUM(Matko_GK) AS Matko_GK,
				SUM(Matko_GK_IL) AS Matko_GK_IL,
				SUM(Matko_So) AS Matko_So,
				SUM(Matko_So_IL) AS Matko_So_IL,
				SUM(Fremd_EK_EUR) AS Fremd_EK_EUR,
				SUM(Pers_var_EUR) AS Pers_var_EUR,
				SUM(Pers_fix_EUR) AS Pers_fix_EUR,
				SUM(Ekosten_var_EUR) AS Ekosten_var_EUR,
				SUM(Ekosten_fix_EUR) AS Ekosten_fix_EUR,
				SUM(Leasing_var_EUR) AS Leasing_var_EUR,
				SUM(Leasing_fix_EUR) AS Leasing_fix_EUR,
				SUM(Inst_var_EUR) AS Inst_var_EUR,
				SUM(Inst_fix_EUR) AS Inst_fix_EUR,
				SUM(Sokosten_var_EUR) AS Sokosten_var_EUR,
				SUM(Sokosten_fix_EUR) AS Sokosten_fix_EUR,
				SUM(AlleKostenarten_EUR) AS AlleKostenarten_EUR,
				SUM(AlleKostenarten_var_EUR) AS AlleKostenarten_var_EUR,
				SUM(AlleKostenarten_fix_EUR) AS AlleKostenarten_fix_EUR,
				SUM(Materialkosten_EUR) AS Materialkosten_EUR,
				SUM(ELP_freiLB) AS ELP_freiLB,
				SUM(ELP_reserviert) AS ELP_reserviert,
				MAX(FAKomplAm) AS FAKomplAm,
				MAX(ArtikelCode) AS ArtikelCode,
				SUM(Herstellung_AnzMinuten) AS Herstellung_AnzMinuten,
				SUM(Vertriebskosten_var) AS Vertriebskosten_var,
				SUM(Vertriebskosten_fix) AS Vertriebskosten_fix,
				SUM(Verwaltungskosten_var) AS Verwaltungskosten_var,
				SUM(Verwaltungskosten_fix) AS Verwaltungskosten_fix,
				SUM(PersVertriebskosten_var) AS PersVertriebskosten_var,
				SUM(PersVertriebskosten_fix) AS PersVertriebskosten_fix,
				SUM(PersVerwaltungskosten_var) AS PersVerwaltungskosten_var,
				SUM(PersVerwaltungskosten_fix) AS PersVerwaltungskosten_fix,
				SUM(SollVorgabe_BM_Anteil) AS SollVorgabe_BM_Anteil,
				SUM(CAMKosten) AS CAMKosten,
				SUM(SoKostVertriebskosten_var) AS SoKostVertriebskosten_var,
				SUM(SoKostVertriebskosten_fix) AS SoKostVertriebskosten_fix,
				SUM(SoKostVerwaltungskosten_var) AS SoKostVerwaltungskosten_var,
				SUM(SoKostVerwaltungskosten_fix) AS SoKostVerwaltungskosten_fix,
				SUM(HandelEKVol) AS HandelEKVol,
				SUM(InhouseMasslamEKVol) AS InhouseMasslamEKVol,
				SUM(VKVol) AS VKVol,
				SUM(Lastschrift_EUR) AS Lastschrift_EUR,
				SUM(LastschriftNebenkosten_EUR) AS LastschriftNebenkosten_EUR,
				SUM(LastschriftSonstiges_EUR) AS LastschriftSonstiges_EUR,
				SUM(LastschriftRest_EUR) AS LastschriftRest_EUR,
				SUM(SonstigeLastschrift_EUR) AS SonstigeLastschrift_EUR,
				SUM(LastschriftNebenkostenHandel_EUR) AS LastschriftNebenkostenHandel_EUR,
				SUM(LastschriftRestkostenJHA_EUR) AS LastschriftRestkostenJHA_EUR,
				SUM(NKEinkauf_EUR) AS NKEinkauf_EUR,
				MAX(DEKPreis_EUR) AS DEKPreis_EUR,
				MAX(EKPreis_EUR) AS EKPreis_EUR,
				SUM(Gutschrift_EUR) AS Gutschrift_EUR,
				SUM(GutschriftNebenkosten_EUR) AS GutschriftNebenkosten_EUR,
				SUM(GutschriftMenge) AS GutschriftMenge,
				MAX(ProvisionVertreter) AS ProvisionVertreter,
				SUM(VerkaufProvision_EUR) AS VerkaufProvision_EUR,
				SUM(GutschriftProvision_EUR) AS GutschriftProvision_EUR,
				MAX(ProvisionVertreterProzent) AS ProvisionVertreterProzent,
				SUM(Aufgelegt) AS Aufgelegt,
				SUM(Ausschuss) AS Ausschuss,
				SUM(Aufgelegt*DVKPreis) AS Aufgelegt_EUR,
				SUM(Ausschuss*DVKPreis) AS Ausschuss_EUR,
				SUM(Produziert) AS Produziert,
				SUM(Ausschuss)/SUM(Aufgelegt) AS Ausschuss_Proz,
				SUM(LPKonsi) AS LPKonsi,
				SUM(LPKonsi_EUR) AS LPKonsi_EUR,
				AVG(Durch_VK_dm2) AS Durch_VK_dm2,
				SUM(LMenge) AS LMenge,
				SUM(NKVerkauf_EUR) AS NKVerkauf_EUR,
				SUM(RabattVerkauf_EUR) AS RabattVerkauf_EUR,
				SUM(EZVerkauf_EUR) AS EZVerkauf_EUR,
				SUM(VersandVerkauf_EUR) AS VersandVerkauf_EUR,
				SUM(FA_Umsatz_ohneGutschrift) AS FA_Umsatz_ohneGutschrift,
				SUM(Frachtkosten_EUR) AS Frachtkosten_EUR,
				SUM(GesamtVerkaufsmenge) AS GesamtVerkaufsmenge,
				MAX(DVKPreis_proPC) AS DVKPreis,
				MAX(LetzterKommPreis_proKunde) AS LetzterKommPreis,
				SUM(Vorlageprovision) AS Vorlageprovision
			FROM @tblDaten
			GROUP BY
				PC
			ORDER BY SUM(FA_Umsatz) DESC
		END
	END

	IF @Case_ = 'NachKalk_Berichte_Gruppiert2'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255),
			@para7 varchar(255),
			@para8 varchar(255),
			@para9 varchar(255),
			@para10 varchar(255),
			@para11 varchar(255)
		SET @para1 = 'Handel_2015_Ver2_bis_04.16'
		SET @para2 = '-1' --Kunde
		SET @para3 = '-1' --Kundenteil
		SET @para4 = '-1' --PC
		--SET @para5 = ''Intern', 'Masslam', 'Handel''
		SET @para6 = '01.01.2016'
		SET @para7 = '31.12.2016'
		SET @para8 = 'Intern'
		SET @para9 = 'Masslam'
		SET @para10 = 'Handel'
		SET @para11 = 'PC' --'Kunde' --'LP'
		*/
		
		IF OBJECT_ID('tempdb..##TMP_tblDaten') IS NULL --IS NOT NULL
		--BEGIN
		--	DROP TABLE #TMP_tblDaten
		--END
		--ELSE
		BEGIN
			--CREATE TABLE #TMP_KreuzFA (AG varchar(150), Bezug varchar(20))
			CREATE TABLE ##TMP_tblDaten
										(
											D10_PTR NUMERIC(10, 0),
											Kunde varchar(150),
											LP varchar(50),
											AnzFA INT,
											PC varchar(15),
											ELP_gesend_gewDP FLOAT,
											ELP_gesend_gewDP_proKunde FLOAT,
											ELP_gesend_gewDP_proPC FLOAT,
											FA_Umsatz FLOAT,
											FA_Umsatz_R FLOAT,
											LB_in_EUR FLOAT,
											EKHandelMasslamFA_EUR FLOAT,
											Matko_EK_EUR FLOAT,
											Matko_EK_IL_EUR FLOAT,
											Matko_GK_SO_EUR FLOAT,
											Matko_GK_SO_IL_EUR FLOAT,
											Matko_GK FLOAT,
											Matko_GK_IL FLOAT,
											Matko_So FLOAT,
											Matko_So_IL FLOAT,
											Fremd_EK_EUR FLOAT,
											Pers_var_EUR FLOAT,
											Pers_fix_EUR FLOAT,
											Ekosten_var_EUR FLOAT,
											Ekosten_fix_EUR FLOAT,
											Leasing_var_EUR FLOAT,
											Leasing_fix_EUR FLOAT,
											Inst_var_EUR FLOAT,
											Inst_fix_EUR FLOAT,
											Sokosten_var_EUR FLOAT,
											Sokosten_fix_EUR FLOAT,
											AlleKostenarten_EUR FLOAT,
											AlleKostenarten_var_EUR FLOAT,
											AlleKostenarten_fix_EUR FLOAT,
											Materialkosten_EUR FLOAT,
											ELP_freiLB INT,
											ELP_reserviert INT,
											FAKomplAm smalldatetime,
											ArtikelCode varchar(50),
											Herstellung_AnzMinuten INT,
											Vertriebskosten_var FLOAT,
											Vertriebskosten_fix FLOAT,
											Verwaltungskosten_var FLOAT,
											Verwaltungskosten_fix FLOAT,
											PersVertriebskosten_var FLOAT,
											PersVertriebskosten_fix FLOAT,
											PersVerwaltungskosten_var FLOAT,
											PersVerwaltungskosten_fix FLOAT,
											SollVorgabe_BM_Anteil FLOAT,
											CAMKosten FLOAT,
											SoKostVertriebskosten_var FLOAT,
											SoKostVertriebskosten_fix FLOAT,
											SoKostVerwaltungskosten_var FLOAT,
											SoKostVerwaltungskosten_fix FLOAT,
											HandelEKVol FLOAT,
											InhouseMasslamEKVol FLOAT,
											VKVol FLOAT,
											Lastschrift_EUR FLOAT,
											LastschriftNebenkosten_EUR FLOAT,
											LastschriftSonstiges_EUR FLOAT,
											LastschriftRest_EUR FLOAT,
											SonstigeLastschrift_EUR FLOAT,
											LastschriftNebenkostenHandel_EUR FLOAT,
											LastschriftRestkostenJHA_EUR FLOAT,
											NKEinkauf_EUR FLOAT,
											DEKPreis_EUR FLOAT,
											EKPreis_EUR FLOAT,
											Gutschrift_EUR FLOAT,
											GutschriftNebenkosten_EUR FLOAT,
											GutschriftMenge INT,
											ProvisionVertreter varchar(150),
											VerkaufProvision_EUR FLOAT,
											GutschriftProvision_EUR FLOAT,
											ProvisionVertreterProzent FLOAT,
											Aufgelegt INT,
											Ausschuss INT,
											Produziert INT,
											Ausschuss_Proz FLOAT,
											LPKonsi INT,
											LPKonsi_EUR FLOAT,
											Durch_VK_dm2 FLOAT,
											LMenge INT,
											NKVerkauf_EUR FLOAT,
											RabattVerkauf_EUR FLOAT,
											EZVerkauf_EUR FLOAT,
											VersandVerkauf_EUR FLOAT,
											FA_Umsatz_ohneGutschrift FLOAT,
											Frachtkosten_EUR FLOAT,
											GesamtVerkaufsmenge INT,
											DVKPreis FLOAT,
											DVKPreis_proKunde FLOAT,
											DVKPreis_proPC FLOAT,
											LetzterKommPreis FLOAT,
											LetzterKommPreis_proKunde FLOAT,
											LetzterKommPreis_proPC FLOAT,
											Vorlageprovision FLOAT,
											UserTimeStamp varchar(150)
										)
		END


		--Lastschriften
		--DECLARE @tblLSLP table(LS VARCHAR(9), LSBetrag FLOAT)
		INSERT @tblLSLP(LS, LSBetrag) SELECT '41333.301' AS LS, 1823 AS LSBetrag
		--INSERT @tblLSLP(LS, LSBetrag) SELECT '53136.300' AS LS, 1286 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '50735.300' AS LS, 4694 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '51712.302' AS LS, 584 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '52247.300' AS LS, 4625 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '34844.202' AS LS, 1853 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '49037.300' AS LS, 316 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '52395.300' AS LS, 1827 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '46660.301' AS LS, 5086 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '46861.301' AS LS, 704 AS LSBetrag
		INSERT @tblLSLP(LS, LSBetrag) SELECT '51915.300' AS LS, 533 AS LSBetrag

		
		INSERT ##TMP_tblDaten (
							D10_PTR,
							Kunde,
							LP,
							AnzFA,
							PC,
							ELP_gesend_gewDP,
							ELP_gesend_gewDP_proKunde,
							ELP_gesend_gewDP_proPC,
							FA_Umsatz,
							FA_Umsatz_R,
							LB_in_EUR,
							EKHandelMasslamFA_EUR,
							Matko_EK_EUR,
							Matko_EK_IL_EUR,
							Matko_GK_SO_EUR,
							Matko_GK_SO_IL_EUR,
							Matko_GK,
							Matko_GK_IL,
							Matko_So,
							Matko_So_IL,
							Fremd_EK_EUR,
							Pers_var_EUR,
							Pers_fix_EUR,
							Ekosten_var_EUR,
							Ekosten_fix_EUR,
							Leasing_var_EUR,
							Leasing_fix_EUR,
							Inst_var_EUR,
							Inst_fix_EUR,
							Sokosten_var_EUR,
							Sokosten_fix_EUR,
							AlleKostenarten_EUR,
							AlleKostenarten_var_EUR,
							AlleKostenarten_fix_EUR,
							Materialkosten_EUR,
							ELP_freiLB,
							ELP_reserviert,
							FAKomplAm,
							ArtikelCode,
							Herstellung_AnzMinuten,
							Vertriebskosten_var,
							Vertriebskosten_fix,
							Verwaltungskosten_var,
							Verwaltungskosten_fix,
							PersVertriebskosten_var,
							PersVertriebskosten_fix,
							PersVerwaltungskosten_var,
							PersVerwaltungskosten_fix,
							SollVorgabe_BM_Anteil,
							CAMKosten,
							SoKostVertriebskosten_var,
							SoKostVertriebskosten_fix,
							SoKostVerwaltungskosten_var,
							SoKostVerwaltungskosten_fix,
							HandelEKVol,
							InhouseMasslamEKVol,
							VKVol,
							Lastschrift_EUR ,
							LastschriftNebenkosten_EUR,
							LastschriftSonstiges_EUR,
							LastschriftRest_EUR,
							SonstigeLastschrift_EUR,
							LastschriftNebenkostenHandel_EUR,
							LastschriftRestkostenJHA_EUR,
							NKEinkauf_EUR ,
							DEKPreis_EUR,
							EKPreis_EUR,
							Gutschrift_EUR,
							GutschriftNebenkosten_EUR,
							GutschriftMenge,
							ProvisionVertreter,
							VerkaufProvision_EUR,
							GutschriftProvision_EUR,
							ProvisionVertreterProzent,
							Aufgelegt,
							Ausschuss,
							Produziert,
							Ausschuss_Proz,
							LPKonsi,
							LPKonsi_EUR,
							Durch_VK_dm2,
							LMenge,
							NKVerkauf_EUR,
							RabattVerkauf_EUR,
							EZVerkauf_EUR,
							VersandVerkauf_EUR,
							FA_Umsatz_ohneGutschrift,
							Frachtkosten_EUR,
							GesamtVerkaufsmenge,
							DVKPreis,
							DVKPreis_proKunde,
							DVKPreis_proPC,
							LetzterKommPreis,
							LetzterKommPreis_proKunde,
							LetzterKommPreis_proPC,
							Vorlageprovision,
							UserTimeStamp
						)
		
		SELECT
			D10_PTR,
			Kunde,
			LP,
			--MAX(AnzKommissionen) AS AnzKommissionen,
			--MAX(Kommission) AS Kommission,
			ISNULL((
				SELECT TOP 1
					COUNT(WORK_ORDER_NUMBER) AS RES
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0006.WORK_ORDER_NUMBER
					FROM         dbo.DATA0006 --INNER JOIN
											--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND dbo.DATA0006.ROOT_PTR=0
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
						AND dbo.DATA0006.PROD_STATUS=5
				) AS tblAnzFA
			), 0) AS AnzFA,
			PC,
			MAX(ELP_gesend_gewDP) AS ELP_gesend_gewDP,
			MAX(ELP_gesend_gewDP_proKunde) AS ELP_gesend_gewDP_proKunde,
			MAX(ELP_gesend_gewDP_proPC) AS ELP_gesend_gewDP_proPC,
			SUM(FA_Umsatz) AS FA_Umsatz,
			SUM(FA_Umsatz_R) AS FA_Umsatz_R,
			SUM(LB_in_EUR) AS LB_in_EUR,
			SUM(EKHandelNasslamFA) AS EKHandelMasslamFA_EUR,
			SUM(Matko_EK_HauptFA) AS Matko_EK_EUR,
			SUM(Matko_EK_IL) AS Matko_EK_IL_EUR,
			SUM(Matko_GK_SO) AS Matko_GK_SO_EUR,
			SUM(Matko_GK_SO_IL) AS Matko_GK_SO_IL_EUR,
			SUM(Matko_GK_HauptFA) AS Matko_GK,
			SUM(Matko_GK_IL) AS Matko_GK_IL,
			SUM(Matko_So_HauptFA) AS Matko_So,
			SUM(Matko_So_IL) AS Matko_So_IL,
			SUM(Fremd_EK_HauptFA) AS Fremd_EK_EUR,
			SUM(Pers_var_HauptFA)+SUM(Pers_var_IL) AS Pers_var_EUR,
			SUM(Pers_fix_HauptFA)+SUM(Pers_fix_IL) AS Pers_fix_EUR,
			SUM(Ekosten_var_HauptFA)+SUM(Ekosten_var_IL) AS Ekosten_var_EUR,
			SUM(Ekosten_fix_HauptFA)+SUM(Ekosten_fix_IL) AS Ekosten_fix_EUR,
			SUM(Leasing_var_HauptFA)+SUM(Leasing_var_IL) AS Leasing_var_EUR,
			SUM(Leasing_fix_HauptFA)+SUM(Leasing_fix_IL) AS Leasing_fix_EUR,
			SUM(Inst_var_HauptFA)+SUM(Inst_var_IL) AS Inst_var_EUR,
			SUM(Inst_fix_HauptFA)+SUM(Inst_fix_IL) AS Inst_fix_EUR,
			SUM(Sokosten_var_HauptFA)+SUM(Sokosten_var_IL) AS Sokosten_var_EUR,
			SUM(Sokosten_fix_HauptFA)+SUM(Sokosten_fix_IL) AS Sokosten_fix_EUR,
			(
				SUM(Pers_var_HauptFA) + SUM(Pers_fix_HauptFA) + SUM(Pers_var_IL) + SUM(Pers_fix_IL) 
				+ 
				SUM(Ekosten_var_HauptFA) + SUM(Ekosten_fix_HauptFA) + SUM(Ekosten_var_IL) + SUM(Ekosten_fix_IL) 
				+ 
				SUM(Leasing_var_HauptFA) + SUM(Leasing_fix_HauptFA) + SUM(Leasing_var_IL) + SUM(Leasing_fix_IL) 
				+ 
				SUM(Inst_var_HauptFA) + SUM(Inst_fix_HauptFA) + SUM(Inst_var_IL) + SUM(Inst_fix_IL)
				+ 
				SUM(Sokosten_var_HauptFA) + SUM(Sokosten_fix_HauptFA) + SUM(Sokosten_var_IL) + SUM(Sokosten_fix_IL) 
			) AS AlleKostenarten_EUR,
			(
				SUM(Pers_var_HauptFA) + SUM(Pers_var_IL) 
				+ 
				SUM(Ekosten_var_HauptFA) + SUM(Ekosten_var_IL) 
				+ 
				SUM(Leasing_var_HauptFA) + SUM(Leasing_var_IL) 
				+ 
				SUM(Inst_var_HauptFA) + SUM(Inst_var_IL) 
				+ 
				SUM(Sokosten_var_HauptFA) + SUM(Sokosten_var_IL)
			) AS AlleKostenarten_var_EUR,
			(
				SUM(Pers_fix_HauptFA) + SUM(Pers_fix_IL) 
				+ 
				SUM(Ekosten_fix_HauptFA) + SUM(Ekosten_fix_IL) 
				+ 
				SUM(Leasing_fix_HauptFA) + SUM(Leasing_fix_IL) 
				+ 
				SUM(Inst_fix_HauptFA) + SUM(Inst_fix_IL) 
				+ 
				SUM(Sokosten_fix_HauptFA) + SUM(Sokosten_fix_IL)
			) AS AlleKostenarten_fix_EUR,
			(
				SUM(EKHandelNasslamFA) + SUM(Matko_EK_HauptFA) + SUM(Matko_GK_SO) + SUM(Fremd_EK_HauptFA) + SUM(Matko_EK_IL) + SUM(Matko_GK_SO_IL) 
			) AS Materialkosten_EUR,
			--SUM(Kosten_Uml) AS Kosten_Uml_EUR,
			SUM(FA_freiLB) AS ELP_freiLB,
			SUM(FA_reserviert) AS ELP_reserviert,
			MAX(FAkomplAm) AS FAkomplAm,
			MAX(ArtikelCode) AS ArtikelCode,
			SUM(Herstellung_AnzMinuten) AS Herstellung_AnzMinuten,
			SUM(Vertriebskosten_var) AS Vertriebskosten_var,
			SUM(Vertriebskosten_fix) AS Vertriebskosten_fix,
			SUM(Verwaltungskosten_var) AS Verwaltungskosten_var,
			SUM(Verwaltungskosten_fix) AS Verwaltungskosten_fix,
			SUM(PersVertriebskosten_var) AS PersVertriebskosten_var,
			SUM(PersVertriebskosten_fix) AS PersVertriebskosten_fix,
			SUM(PersVerwaltungskosten_var) AS PersVerwaltungskosten_var,
			SUM(PersVerwaltungskosten_fix) AS PersVerwaltungskosten_fix,
			AVG(SollVorgabe_BM_Anteil) AS SollVorgabe_BM_Anteil,
			SUM(CAMKosten) AS CAMKosten,
			SUM(SoKostVertriebskosten_var) AS SoKostVertriebskosten_var,
			SUM(SoKostVertriebskosten_fix) AS SoKostVertriebskosten_fix,
			SUM(SoKostVerwaltungskosten_var) AS SoKostVerwaltungskosten_var,
			SUM(SoKostVerwaltungskosten_fix) AS SoKostVerwaltungskosten_fix,
			SUM(HandelEKVol) AS HandelEKVol,
			SUM(InhouseMasslamlEKVol) AS InhouseMasslamlEKVol,
			SUM(VKVol) AS VKVol,
			--SUM(HandelEKVol)/SUM(VKVol) AS HandelMatAnteil_Proz,
			--SUM(InhouseMasslamlEKVol)/SUM(VKVol) AS InhouseMasslamMatAnteil_Proz,

			------------------------------------------------------------------------
			--Lastschriften
			ISNULL((
					ISNULL(
						(SELECT TOP 1
							SUM(Lastschriften) 
							--+
							--ISNULL((SELECT TOP 1 LSBetrag FROM @tblLSLP AS tblLSLP WHERE LS COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(LP))), 0)
							AS Lastschrift_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0132.RKEY, 
								((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE) AS Lastschriften
								--(dbo.DATA0132.AMOUNT / dbo.DATA0132.EX_RATE) AS Lastschriften

							FROM         dbo.DATA0132 INNER JOIN
										dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
										dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
										dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

							WHERE      
										--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
										REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriften		
					), 0)		
					+
					ISNULL((SELECT TOP 1 LSBetrag FROM @tblLSLP AS tblLSLP WHERE LS COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(LP))), 0)	
			), 0) AS Lastschrift_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(NK) AS LastschriftNK_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS NK
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
									REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
									AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Nebenkosten Handel')
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenNebenkosten					
			), 0) AS LastschriftNebenkosten_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(Sonstiges) AS LastschriftSonstiges_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Sonstiges
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
									REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
									AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Sonstiges')
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenSonstiges					
			), 0) AS LastschriftSonstiges_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(Rest) AS LastschriftRest_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Rest
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
									REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
									AND dbo.DATA0199.MISC_CHARGE_CATEGORY NOT IN ('Sonstiges', 'Nebenkosten Handel')
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenRest						
			), 0) AS LastschriftRest_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(NKLastschriften) AS NKLastschrift_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0132.RKEY, 
							(dbo.DATA0132.MISC_TOT / dbo.DATA0132.EX_RATE) AS NKLastschriften

						FROM         dbo.DATA0132 INNER JOIN
									dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
									dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
									dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
									dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

						WHERE      
									--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
									REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblNKLastschriften						
			), 0) AS SonstigeLastschrift_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(Rest) AS LastschriftRest_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Rest
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
									REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
									AND dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Nebenkosten Handel'
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenRest						
			), 0) AS LastschriftNebenkostenHandel_EUR,
			ISNULL((
					SELECT TOP 1
						SUM(Rest) AS LastschriftRest_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0132.RKEY,
							dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Rest
						FROM         dbo.DATA0199 INNER JOIN
												dbo.DATA0212 INNER JOIN
												dbo.DATA0132 INNER JOIN
												dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
												dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
												dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
												dbo.DATA0071 INNER JOIN
												dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
						WHERE     
									--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
									--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
									REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
									AND dbo.DATA0199.MISC_CHARGE_CATEGORY IN ('Filmerstellung', 'complete mounted PCB', 'Sonstiges', 'Transportkosten', 'Selection cost', 'Debit Handel Rekla.', 'Rekla. / Belastung', 'Nebenkosten/KleMenZ', 'additional cost QA')
									AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
									--AND dbo.DATA0132.MEMO_TP=1
									AND dbo.DATA0132.MEMO_TP IN (1, 6)
					) AS tblLastschriftenRest						
			), 0) AS LastschriftRestkostenJHA_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Einkauf (BM, CU, PP, PCB, Masslam)
			ISNULL(( 
				SELECT
					SUM(NK) AS NKEinkauf
				FROM
				(
					SELECT DISTINCT 
						D107_.RKEY,
						(D107_.SHIPPING + D107_.MISC_TOT) / D107_.EX_RATE  AS NK
					FROM         dbo.DATA0070 AS D70_ INNER JOIN
										dbo.DATA0071 AS D71_ ON D70_.RKEY = D71_.PO_PTR INNER JOIN
										dbo.DATA0108 AS D108_ ON D71_.RKEY = D108_.DATA0071_PTR INNER JOIN
										dbo.DATA0107 AS D107_ ON D108_.DATA0107_PTR = D107_.RKEY INNER JOIN
										dbo.DATA0017 AS D17_ ON D71_.INVT_PTR = D17_.RKEY
					WHERE
						--RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
						REPLACE(RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						AND (D107_.INV_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (D107_.INV_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblNKEinkauf_
			), 0) AS NKEinkauf_EUR,
			ISNULL((
				SELECT TOP 1
					SUM(EKPreis_EUR*Menge)/SUM(Menge) AS DEKPreis_EUR_
				FROM
				(
					SELECT DISTINCT 
						D108_.RKEY,
						D107_.INV_DATE,
						D108_.PRICE / D107_.EX_RATE  AS EKPreis_EUR,
						D108_.QUANTITY AS Menge
					FROM         dbo.DATA0070 AS D70_ INNER JOIN
										dbo.DATA0071 AS D71_ ON D70_.RKEY = D71_.PO_PTR INNER JOIN
										dbo.DATA0108 AS D108_ ON D71_.RKEY = D108_.DATA0071_PTR INNER JOIN
										dbo.DATA0107 AS D107_ ON D108_.DATA0107_PTR = D107_.RKEY INNER JOIN
										dbo.DATA0017 AS D17_ ON D71_.INVT_PTR = D17_.RKEY
					WHERE
						--RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
						REPLACE(RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						AND (D107_.INV_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (D107_.INV_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblDEKPreis_EUR
			), 0) AS DEKPreis_EUR,
			ISNULL((
				SELECT TOP 1
					EKPreis_EUR_
				FROM
				(
					SELECT DISTINCT 
						D108_.RKEY,
						D107_.INV_DATE,
						D108_.PRICE / D107_.EX_RATE  AS EKPreis_EUR_
					FROM         dbo.DATA0070 AS D70_ INNER JOIN
										dbo.DATA0071 AS D71_ ON D70_.RKEY = D71_.PO_PTR INNER JOIN
										dbo.DATA0108 AS D108_ ON D71_.RKEY = D108_.DATA0071_PTR INNER JOIN
										dbo.DATA0107 AS D107_ ON D108_.DATA0107_PTR = D107_.RKEY INNER JOIN
										dbo.DATA0017 AS D17_ ON D71_.INVT_PTR = D17_.RKEY
					WHERE
						--RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
						REPLACE(RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
						AND (D107_.INV_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (D107_.INV_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblEKPreis_EUR
				ORDER BY INV_DATE DESC
			), 0) AS EKPreis_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Gutschriften
			/*
			ISNULL((
				SELECT
					SUM(Gutschrift) AS Gutschrift_EUR
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0116.RKEY,
						(dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE AS Gutschrift
					FROM         dbo.DATA0060 INNER JOIN
										  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
										  dbo.DATA0116 INNER JOIN
										  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschrift	
			), 0) AS Gutschrift_EUR,	
			*/
			ISNULL((
				SELECT
					SUM(BetragNetto) AS Gutschrift_EUR
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0116.RKEY,
						dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY) AS BetragNetto
					FROM         dbo.DATA0116 INNER JOIN
							  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
							  dbo.DATA0060 INNER JOIN
							  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschrift	
			), 0) AS Gutschrift_EUR,
			ISNULL((
				SELECT
					SUM(GSNK) AS GutschriftNK_EUR
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0116.RKEY,
						(
							((dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE)
							-
							(dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY)) 
						) AS GSNK
					FROM         dbo.DATA0116 INNER JOIN
							  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
							  dbo.DATA0060 INNER JOIN
							  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschriftNK
			), 0) AS GutschriftNebenkosten_EUR,		
			ISNULL((
				SELECT
					SUM(RMenge) AS GutschriftMenge
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0098.RKEY,
						dbo.DATA0098.QTY_AUTH AS RMenge
					FROM         
						dbo.DATA0098 
					WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
							AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschriftMenge
			), 0) AS GutschriftMenge,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Provision
			ISNULL((
				SELECT TOP 1
					dbo.DATA0009.SALES_REP_NAME
				FROM         dbo.DATA0006 INNER JOIN
										dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
										dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
										dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
										dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
										dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
										dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
										dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
										dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
										dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
										dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
										dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
				WHERE
					dbo.DATA0050.RKEY = MAX(D50_PTR)
					AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
					AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
			), '') AS ProvisionVerteter,
			SUM(FA_Umsatz_VertProvision) AS VerkaufProvision_EUR,
			ISNULL((
				SELECT
					SUM(Provision) AS GutschriftNK_EUR
				FROM
				(
					SELECT DISTINCT 
						dbo.DATA0116.RKEY,
						ISNULL(dbo.DATA0509.COMMISSION_DEBITED / dbo.DATA0509.EXCHANGE_RATE, 0) AS Provision
					FROM         dbo.DATA0125 INNER JOIN
										  dbo.DATA0509 ON dbo.DATA0125.DATA0509_PTR = dbo.DATA0509.RKEY RIGHT OUTER JOIN
										  dbo.DATA0116 INNER JOIN
										  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
										  dbo.DATA0060 INNER JOIN
										  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY ON 
										  dbo.DATA0125.MEMO_PTR = dbo.DATA0116.RKEY LEFT OUTER JOIN
										  dbo.DATA0508 INNER JOIN
										  dbo.DATA0061 ON dbo.DATA0508.DATA0061_PTR = dbo.DATA0061.RKEY INNER JOIN
										  dbo.DATA0124 ON dbo.DATA0508.RKEY = dbo.DATA0124.DATA0508_PTR ON dbo.DATA0116.RKEY = dbo.DATA0124.MEMO_PTR
					WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
							AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblGutschriftNK
			), 0) AS GutschriftProvision_EUR,
			ISNULL((
				SELECT TOP 1
					dbo.DATA0009.COMMISSION_1
				FROM         dbo.DATA0006 INNER JOIN
										dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
										dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
										dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
										dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
										dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
										dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
										dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
										dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
										dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
										dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
										dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
				WHERE
					dbo.DATA0050.RKEY = MAX(D50_PTR)
					AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
					AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
			), 0)/100 AS ProvisionVerteterProzent,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Produktion
			ISNULL((
				SELECT TOP 1
					SUM(QUAN_SCH) AS RES
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0006.RKEY, 
						dbo.DATA0006.QUAN_SCH
					FROM         dbo.DATA0006 --INNER JOIN
											--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND dbo.DATA0006.ROOT_PTR=0
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
						AND dbo.DATA0006.PROD_STATUS=5
				) AS tblAufgelegt
			), 0) AS Aufgelegt,
			ISNULL((
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_REJ) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_REJ 
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) <> 'R'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAusschuss
				), 0)
				+
				ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
					SELECT
						SUM(RMenge) AS GutschriftMenge
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0098.RKEY,
							dbo.DATA0098.QTY_AUTH AS RMenge
						FROM         
							dbo.DATA0098 
						WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftMenge
				), 0)
				-
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_PROD) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_PROD
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblProduziert
				), 0)
			), 0) AS Ausschuss,
			ISNULL((
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_PROD) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_PROD
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblProduziert
				), 0)
				-
				ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
					SELECT
						SUM(RMenge) AS GutschriftMenge
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0098.RKEY,
							dbo.DATA0098.QTY_AUTH AS RMenge
						FROM         
							dbo.DATA0098 
						WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftMenge
				), 0)
				-
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_REJ) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_REJ
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='W'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAusschuss_R
				), 0)
				+
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_PROD) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_PROD
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblProduziert
				), 0)
			), 0) AS Produziert,
			ISNULL((
				SELECT TOP 1
					SUM(QUAN_REJ)/SUM(QUAN_SCH) AS RES
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0006.RKEY, 
						dbo.DATA0006.QUAN_REJ,
						dbo.DATA0006.QUAN_SCH
					FROM         dbo.DATA0006 --INNER JOIN
											--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND dbo.DATA0006.ROOT_PTR=0
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						AND dbo.DATA0006.PROD_STATUS=5
				) AS tblAusschuss
			), 0) AS Ausschuss_Proz,
			ISNULL((
					SELECT
						SUM(QTY_ON_HAND) AS LPKonsi_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0053.RKEY, 
							dbo.DATA0053.QTY_ON_HAND
						FROM         dbo.DATA0006 INNER JOIN
												dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
						WHERE     
								dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
					) AS tblNLPKonsiMenge
			), 0) AS LPKonsi,
			ISNULL((
					SELECT
						SUM(QTY_ON_HAND*LAST_SO_PRICE) AS LPKonsi_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0053.RKEY, 
							dbo.DATA0053.QTY_ON_HAND,
							dbo.DATA0050.LAST_SO_PRICE
						--FROM         dbo.DATA0006 INNER JOIN
						--						dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
						FROM         dbo.DATA0006 INNER JOIN
											  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
						WHERE     
								dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
					) AS tblNLPKonsiMenge
			--), 0) * MAX(ELP_gesend_gewDP)  AS LPKonsi_EUR,
			), 0)  AS LPKonsi_EUR,
			ISNULL((
				SELECT TOP 1
					SUM(gesendet_FA * KNX * KNY / ELP_KN / 10000) AS RES
				FROM
				(
					SELECT 
						dbo.ARTIKELDATEN.*,
						dbo.DATA0050.RKEY AS D0050_PTR,
						CASE 
							WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
								ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
								* 
								dbo.DATA0060.EXCH_RATE 
							ELSE
								dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
						END AS ELP_Preis_EUR,
						dbo.DATA0052.QUAN_SHP AS gesendet_FA

					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE
						(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblFAUmsatz
				WHERE D0050_PTR = MAX(D50_PTR) 
			), 0) AS Durch_VK_dm2,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Verkauf
			ISNULL((
				SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
				FROM         dbo.DATA0006 INNER JOIN
										dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
										dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
										dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
				WHERE 
					dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
					AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
					AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
			), 0) AS LMenge,
			ISNULL((
				SELECT
					SUM(NK) AS NKVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.TOOLING_CHARGES AS NK
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblNKVerkauf
			), 0) AS NKVerkauf_EUR,
			ISNULL((
				SELECT
					SUM(Rabatt) AS RabattVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.DISCOUNT_AMOUNT AS Rabatt
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblRabattVerkauf
			), 0) AS RabattVerkauf_EUR,
			ISNULL((
				SELECT
					SUM(Einzuschlag) AS EZVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.RUSH_CHARGE_AMOUNT AS Einzuschlag
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblEZVerkauf
			), 0) AS EZVerkauf_EUR,
			ISNULL((
				SELECT
					SUM(Versandkosten) AS VersandVerkauf
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0112.RKEY,
						dbo.DATA0112.SHIPPING_CHARGES AS Versandkosten
					FROM         dbo.DATA0060 INNER JOIN
						dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
					WHERE 
						CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblVersandVerkauf
			), 0) AS VersandVerkauf_EUR,

			(
				SUM(FA_Umsatz)
				-
				ISNULL((
					SELECT TOP 1 
						SUM(Gutschrift) AS Gutschrift_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0116.RKEY,
							dbo.DATA0116.CREDIT_AMOUNT/dbo.DATA0116.EX_RATE - dbo.DATA0116.STATE_TAX AS Gutschrift
						FROM         dbo.DATA0060 INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
											  dbo.DATA0116 INNER JOIN
											  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE     (dbo.DATA0060.CUST_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschrift	
				), 0)
			) AS FA_Umsatz_ohneGutschrift,
			ISNULL((
				SELECT TOP 1
					--SUM(FK) AS FK1,
					SUM(FK/CASE WHEN PlusZeichen_1=0 THEN 1 ELSE CASE WHEN PlusZeichen_1>0 AND PlusZeichen_2=0 THEN 2 ELSE 3 END END) AS FK_EUR
				FROM
				(
					SELECT DISTINCT
						dbo.DATA0072.RKEY,
						dbo.DATA0072.DESCRIPTION2 AS LP,
						(dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE * dbo.DATA0072.QUAN_ORD) AS FK,
						CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 1) AS PlusZeichen_1,
						CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 21) AS PlusZeichen_2
					FROM         dbo.DATA0070 INNER JOIN
										  dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR
					WHERE
						LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION, '')), 3) = 'FK '
						AND LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION2, '')), 3) = 'LP '
						AND dbo.DATA0072.DESCRIPTION2 COLLATE SQL_Latin1_General_CP1_CI_AS LIKE '%' + LTRIM(RTRIM(LP)) + '%' 
						AND (dbo.DATA0070.PO_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0070.PO_DATE <= CONVERT(DATETIME, @para7, 103))
				) AS tblFK
			), 0) AS Frachtkosten_EUR,
			ISNULL((
				ISNULL(SUM(FA_reserviert), 0)
				+
				ISNULL((
					SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				), 0) 
				+
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND) AS LPKonsi
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND
							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				), 0) 
			), 0) AS GesamtVerkaufsmenge,
			ISNULL((
					SELECT TOP 1
						SUM(gesendet * Preis) / SUM(gesendet) AS DVKPreis
					FROM
					(
						SELECT 
								dbo.DATA0052.QUAN_SHP AS gesendet,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										/ 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
								END AS Preis

						FROM         dbo.DATA0006 INNER JOIN
											  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE     
								--RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) = @para1 --'51051.300' --'  
								dbo.DATA0050.RKEY=MAX(D50_PTR)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblDVKPreis
			), 0) AS DVKPreis,
			ISNULL((
					SELECT TOP 1
						SUM(gesendet * Preis) / SUM(gesendet) AS DVKPreis
					FROM
					(
						SELECT 
								dbo.DATA0052.QUAN_SHP AS gesendet,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										/ 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
								END AS Preis

						FROM         dbo.DATA0006 INNER JOIN
											  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE     
								--RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) = @para1 --'51051.300' --'  
								dbo.DATA0010.RKEY=MAX(D10_PTR)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblDVKPreis
			), 0) AS DVKPreis_proKunde,
			ISNULL((
					SELECT TOP 1
						SUM(gesendet * Preis) / SUM(gesendet) AS DVKPreis
					FROM
					(
						SELECT 
								dbo.DATA0052.QUAN_SHP AS gesendet,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										/ 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
								END AS Preis

						FROM         dbo.DATA0006 INNER JOIN
											  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE     
								--RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) = @para1 --'51051.300' --'  
								dbo.DATA0008.PROD_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = MAX(PC)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblDVKPreis
			), 0) AS DVKPreis_proPC,
			ISNULL((
					SELECT TOP 1 dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE AS RES
					FROM         dbo.DATA0054 INNER JOIN
						dbo.DATA0006 ON dbo.DATA0054.WO_PTR = dbo.DATA0006.RKEY INNER JOIN
						dbo.DATA0050 INNER JOIN
						dbo.DATA0060 ON dbo.DATA0050.RKEY = dbo.DATA0060.CUST_PART_PTR ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY
					WHERE
								dbo.DATA0050.RKEY=MAX(D50_PTR)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0060.ENT_DATE DESC
			), 0) AS LetzterKommPreis,
			ISNULL((
					SELECT TOP 1 dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE AS RES
					FROM         dbo.DATA0054 INNER JOIN
						dbo.DATA0006 ON dbo.DATA0054.WO_PTR = dbo.DATA0006.RKEY INNER JOIN
						dbo.DATA0050 INNER JOIN
						dbo.DATA0060 ON dbo.DATA0050.RKEY = dbo.DATA0060.CUST_PART_PTR ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY
					WHERE
								dbo.DATA0060.CUSTOMER_PTR=MAX(D10_PTR)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0060.ENT_DATE DESC
			), 0) AS LetzterKommPreis_proKunde,
			ISNULL((
					SELECT TOP 1 dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE AS RES
					FROM         dbo.DATA0054 INNER JOIN
										  dbo.DATA0006 ON dbo.DATA0054.WO_PTR = dbo.DATA0006.RKEY INNER JOIN
										  dbo.DATA0050 INNER JOIN
										  dbo.DATA0060 ON dbo.DATA0050.RKEY = dbo.DATA0060.CUST_PART_PTR ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
										  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY
					WHERE
								dbo.DATA0008.PROD_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = MAX(PC)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0060.ENT_DATE DESC
			), 0) AS LetzterKommPreis_proPC,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			SUM(Vorlageprovision) AS Vorlageprovision_EUR,
			@para3 AS UserTimeStamp
			
		FROM
		(
			SELECT
				tblDaten.*
				--CAST(ELP_gesend_gewDP*FA_reserviert AS FLOAT) AS LB_in_EUR
			FROM
			(
				SELECT
					tblNachKalk_Daten_2.D10_PTR,
					tblNachKalk_Daten_2.Kunde,
					tblNachKalk_Daten_2.Aufbereitung,
					tblNachKalk_Daten_2.LP,
					tblNachKalk_Daten_2.D50_PTR,
					tblNachKalk_Daten_2.D60_PTR,
					CASE
						WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten_2.LP), 3), 1)='1' THEN 
							'Intern'
						ELSE
							CASE
								WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten_2.LP), 3), 1)='2' THEN 
									'Masslam'
								ELSE
									CASE
										WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten_2.LP), 3), 1)='3' THEN 
											'Handel'
										ELSE
											'unbekannt'
									END
							END
					END AS InternMasslamHandel,
					tblNachKalk_Daten_2.PC,
					--tblNachKalk_Daten_2.AnzKommissionen,
					--tblNachKalk_Daten_2.Kommission,
					tblNachKalk_Daten_2.FA,
					ISNULL((
						ISNULL((
							SELECT TOP 1
								SUM(RES) AS umsatz
							FROM
							(
								SELECT 
									dbo.DATA0006.RKEY AS D0006_PTR,
									(
										CASE 
											WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
												ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
												/ 
												dbo.DATA0060.EXCH_RATE 
											ELSE
												dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
										END --ELP_Preis_EUR
										*
										dbo.DATA0052.QUAN_SHP --AS gesendet_FA
									) AS RES
								FROM         dbo.DATA0006 INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
								WHERE
									(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							) AS tblFAUmsatz
							WHERE 
								D0006_PTR = D6_PTR 
								--D0006_PTR = CASE WHEN LEFT(tblNachKalk_Daten_2.FA, 1)='S' THEN tblNachKalk_Daten_2.D6S_PTR ELSE tblNachKalk_Daten_2.D6_PTR END
						), 0)
					), 0) AS FA_Umsatz,
					ISNULL((
						ISNULL((
							SELECT TOP 1
								SUM(RES) AS umsatz
							FROM
							(
								SELECT 
									dbo.DATA0006.RKEY AS D0006_PTR,
									(
										CASE 
											WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
												ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
												/ 
												dbo.DATA0060.EXCH_RATE 
											ELSE
												dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
										END --ELP_Preis_EUR
										*
										dbo.DATA0052.QUAN_SHP --AS gesendet_FA
									) AS RES
								FROM         dbo.DATA0006 INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
								WHERE
									(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
									AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) = 'R'
							) AS tblFAUmsatz
							WHERE 
								D0006_PTR = D6_PTR 
						), 0)
					), 0) AS FA_Umsatz_R,
					ISNULL((
						SELECT TOP 1
							SUM(RES) AS umsatzProv
						FROM
						(
							SELECT 
								dbo.DATA0006.RKEY AS D0006_PTR,
								(
									CASE 
										WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
											ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
											/ 
											dbo.DATA0060.EXCH_RATE 
										ELSE
											dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
									END --ELP_Preis_EUR
									*
									dbo.DATA0052.QUAN_SHP --AS gesendet_FA
									*
									(dbo.DATA0509.SALES_COMMISSION_PER/100)
								) AS RES
							FROM         dbo.DATA0006 INNER JOIN
												  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
												  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
												  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
												  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
												  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
												  dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
												  dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR
							WHERE
								(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblFAUmsatzProv
						WHERE D0006_PTR = D6_PTR 
					), 0) AS FA_Umsatz_VertProvision,
					tblNachKalk_Daten_2.EK_Handel_Masslam_HauptFA AS EKHandelNasslamFA,
					tblNachKalk_Daten_2.Matko_EK_HauptFA,
					tblNachKalk_Daten_2.Matko_EK_IL,
					tblNachKalk_Daten_2.Matko_GK_HauptFA + tblNachKalk_Daten_2.Matko_So_HauptFA AS Matko_GK_SO,
					tblNachKalk_Daten_2.Matko_GK_IL + tblNachKalk_Daten_2.Matko_So_IL AS Matko_GK_SO_IL,
					tblNachKalk_Daten_2.Matko_GK_HauptFA,
					tblNachKalk_Daten_2.Matko_GK_IL,
					tblNachKalk_Daten_2.Matko_So_HauptFA,
					tblNachKalk_Daten_2.Matko_So_IL,
					tblNachKalk_Daten_2.Fremd_EK_HauptFA,
					tblNachKalk_Daten_2.Ekosten_var_HauptFA,
					tblNachKalk_Daten_2.Ekosten_var_IL,
					tblNachKalk_Daten_2.Ekosten_fix_HauptFA,
					tblNachKalk_Daten_2.Ekosten_fix_IL,
					tblNachKalk_Daten_2.Leasing_var_HauptFA,
					tblNachKalk_Daten_2.Leasing_var_IL,
					tblNachKalk_Daten_2.Leasing_fix_HauptFA,
					tblNachKalk_Daten_2.Leasing_fix_IL,
					tblNachKalk_Daten_2.Inst_var_HauptFA,
					tblNachKalk_Daten_2.Inst_var_IL,
					tblNachKalk_Daten_2.Inst_fix_HauptFA,
					tblNachKalk_Daten_2.Inst_fix_IL,
					tblNachKalk_Daten_2.Sokosten_var_HauptFA,
					tblNachKalk_Daten_2.Sokosten_var_IL,
					tblNachKalk_Daten_2.Sokosten_fix_HauptFA,
					tblNachKalk_Daten_2.Sokosten_fix_IL,
					tblNachKalk_Daten_2.Pers_var_HauptFA,
					tblNachKalk_Daten_2.Pers_var_IL,
					tblNachKalk_Daten_2.Pers_fix_HauptFA,
					tblNachKalk_Daten_2.Pers_fix_IL,
					--tblNachKalk_Daten_2.Kosten_Uml,
					ISNULL((SELECT TOP 1 QTY_ALLOC AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_reserviert,
					ISNULL((
							SELECT TOP 1
								SUM(RES) AS LBEur
							FROM
							(
								SELECT DISTINCT
									dbo.DATA0053.RKEY,
									(dbo.DATA0060.PART_PRICE/dbo.DATA0060.EXCH_RATE*dbo.DATA0053.QTY_ALLOC) AS RES
									--SUM(dbo.DATA0053.QTY_ALLOC) AS RES
								FROM         dbo.DATA0060 INNER JOIN
													  dbo.DATA0063 ON dbo.DATA0060.RKEY = dbo.DATA0063.SO_PTR INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0063.PART_BATCH_PTR = dbo.DATA0053.RKEY
								WHERE dbo.DATA0053.WORK_ORDER_PTR = D6_PTR 
							) AS tblLBEur
					), 0) AS LB_in_EUR,
					ISNULL((SELECT TOP 1 (QTY_ON_HAND - QTY_ALLOC) AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_freiLB,
					--tblNachKalk_Daten_2.Aus_in_Proz,
					ISNULL((
						SELECT TOP 1
							SUM(ELP_Preis_EUR*gesendet_FA)/SUM(gesendet_FA) AS umsatz
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.ACT_COMPL_DATE,
								dbo.DATA0050.RKEY AS D0050_PTR,
								--dbo.DATA0006.RKEY AS D0006_PTR,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										* 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
								END AS ELP_Preis_EUR,
								dbo.DATA0052.QUAN_SHP AS gesendet_FA

							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						) AS tblFAUmsatz
						WHERE 
							D0050_PTR = tblNachKalk_Daten_2.D50_PTR
							AND (ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						--WHERE D0006_PTR = D6_PTR 
					), 
						(
							SELECT TOP 1 (dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE) AS RES 
							FROM dbo.DATA0054 INNER JOIN  dbo.DATA0060 ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY 
							WHERE dbo.DATA0060.CUST_PART_PTR = tblNachKalk_Daten_2.D50_PTR
						)
					) AS ELP_gesend_gewDP,
					ISNULL((
						SELECT TOP 1
							SUM(ELP_Preis_EUR*gesendet_FA)/SUM(gesendet_FA) AS umsatz
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.ACT_COMPL_DATE,
								dbo.DATA0010.RKEY AS D0010_PTR,
								--dbo.DATA0006.RKEY AS D0006_PTR,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										* 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
								END AS ELP_Preis_EUR,
								dbo.DATA0052.QUAN_SHP AS gesendet_FA

							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						) AS tblFAUmsatz
						WHERE 
							D0010_PTR = tblNachKalk_Daten_2.D10_PTR
							AND (ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						--WHERE D0006_PTR = D6_PTR 
					), 
						(
							SELECT TOP 1 (dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE) AS RES 
							FROM dbo.DATA0054 INNER JOIN  dbo.DATA0060 ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY 
							WHERE dbo.DATA0060.CUSTOMER_PTR = tblNachKalk_Daten_2.D10_PTR
						)
					) AS ELP_gesend_gewDP_proKunde,
					ISNULL((
						SELECT TOP 1
							SUM(ELP_Preis_EUR*gesendet_FA)/SUM(gesendet_FA) AS umsatz
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.ACT_COMPL_DATE,
								dbo.DATA0008.PROD_CODE AS D0008_PROD_CODE,
								--dbo.DATA0006.RKEY AS D0006_PTR,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										* 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
								END AS ELP_Preis_EUR,
								dbo.DATA0052.QUAN_SHP AS gesendet_FA

							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						) AS tblFAUmsatz
						WHERE 
							D0008_PROD_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = tblNachKalk_Daten_2.PC
							AND (ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
						--WHERE D0006_PTR = D6_PTR 
					), 
						(
							SELECT TOP 1 (dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE) AS RES 
							FROM         dbo.DATA0050 INNER JOIN
							  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
							  dbo.DATA0060 ON dbo.DATA0050.RKEY = dbo.DATA0060.CUST_PART_PTR
							WHERE dbo.DATA0008.PROD_CODE COLLATE SQL_Latin1_General_CP1_CI_AS = tblNachKalk_Daten_2.PC
						)
					) AS ELP_gesend_gewDP_proPC,
					tblNachKalk_Daten_2.FAkomplAm,
					tblNachKalk_Daten_2.ArtikelCode,
					tblNachKalk_Daten_2.Herstellung_AnzMinuten,
					ISNULL(tblNachKalk_Daten_2.Vertrieb_var, 0) AS Vertriebskosten_var,
					ISNULL(tblNachKalk_Daten_2.Vertrieb_fix, 0) AS Vertriebskosten_fix,
					ISNULL(tblNachKalk_Daten_2.Verwaltung_var, 0) AS Verwaltungskosten_var,
					ISNULL(tblNachKalk_Daten_2.Verwaltung_fix, 0) AS Verwaltungskosten_fix,
					ISNULL(tblNachKalk_Daten_2.PersVertrieb_var, 0) AS PersVertriebskosten_var,
					ISNULL(tblNachKalk_Daten_2.PersVertrieb_fix, 0) AS PersVertriebskosten_fix,
					ISNULL(tblNachKalk_Daten_2.PersVerwaltung_var, 0) AS PersVerwaltungskosten_var,
					ISNULL(tblNachKalk_Daten_2.PersVerwaltung_fix, 0) AS PersVerwaltungskosten_fix,
					ISNULL(tblNachKalk_Daten_2.SollVorgabe_BM_Anteil, 0) AS SollVorgabe_BM_Anteil,
					ISNULL(tblNachKalk_Daten_2.CAMKosten, 0) AS CAMKosten,
					ISNULL(tblNachKalk_Daten_2.SoKostVertrieb_var, 0) AS SoKostVertriebskosten_var,
					ISNULL(tblNachKalk_Daten_2.SoKostVertrieb_fix, 0) AS SoKostVertriebskosten_fix,
					ISNULL(tblNachKalk_Daten_2.SoKostVerwaltung_var, 0) AS SoKostVerwaltungskosten_var,
					ISNULL(tblNachKalk_Daten_2.SoKostVerwaltung_fix, 0) AS SoKostVerwaltungskosten_fix,
					--ISNULL(tblNachKalk_Daten_2.HandelEKVol, 0) AS HandelEKVol,
					--ISNULL(tblNachKalk_Daten_2.InhouseMasslamlEKVol, 0) AS InhouseMasslamlEKVol,
					--ISNULL(tblNachKalk_Daten_2.VKVol, 0) AS VKVol
					ISNULL(CASE WHEN LEFT(tblNachKalk_Daten_2.FA, 1) IN ('S', 'R', 'W') THEN 0 ELSE tblNachKalk_Daten_2.HandelEKVol END, 0) AS HandelEKVol,
					ISNULL(CASE WHEN LEFT(tblNachKalk_Daten_2.FA, 1) IN ('S', 'R', 'W') THEN 0 ELSE tblNachKalk_Daten_2.InhouseMasslamlEKVol END, 0) AS InhouseMasslamlEKVol,
					ISNULL(CASE WHEN LEFT(tblNachKalk_Daten_2.FA, 1) IN ('S', 'R', 'W') THEN 0 ELSE tblNachKalk_Daten_2.VKVol END, 0) AS VKVol,
					ISNULL(Vorlageprovision, 0) AS Vorlageprovision
					--ISNULL(tblNachKalk_Daten_2.NKEinkauf, 0) AS NKEinkauf

				FROM
					LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
				WHERE 
					--tblNachKalk_Daten_2.FAkomplAm >= CONVERT(DATETIME, @para6, 103)
					--AND tblNachKalk_Daten_2.FAkomplAm <= CONVERT(DATETIME, @para7, 103)
					tblNachKalk_Daten_2.Aufbereitung = @para1
					AND tblNachKalk_Daten_2.D50_PTR = @para2
					--AND tblNachKalk_Daten_2.D10_PTR IN (SELECT D10_PTR FROM @tblD10LP)
					--AND tblNachKalk_Daten_2.D50_PTR IN (SELECT D50_PTR FROM @tblD50LP)
					--AND tblNachKalk_Daten_2.D8_PTR IN (SELECT D8_PTR FROM @tblD8LP)
			) AS tblDaten
		) AS tblDatenGrp 
		--WHERE 
		--	InternMasslamHandel IN (ISNULL(@para8, ''), ISNULL(@para9, ''), ISNULL(@para10, ''), ISNULL(@para12, ''))
		GROUP BY
			D10_PTR,
			Kunde, 
			LP,
			PC
		ORDER BY
			LP


		SELECT * FROM ##TMP_tblDaten WHERE UserTimeStamp = @para3 ORDER BY FA_Umsatz DESC
	END


	IF @Case_='LP' 
	BEGIN
		SELECT * FROM ##TMP_tblDaten WHERE UserTimeStamp = @para1 ORDER BY FA_Umsatz DESC
		/*
		SELECT
			D10_PTR,
			Kunde,
			LP,
			PC,
			SUM(AnzFA) AS AnzFA,
			MAX(ELP_gesend_gewDP_proKunde) AS ELP_gesend_gewDP,
			SUM(FA_Umsatz) AS FA_Umsatz,
			SUM(FA_Umsatz_R) AS FA_Umsatz_R,
			SUM(LB_in_EUR) AS LB_in_EUR,
			SUM(EKHandelMasslamFA_EUR) AS EKHandelMasslamFA_EUR,
			SUM(Matko_EK_EUR) AS Matko_EK_EUR,
			SUM(Matko_EK_IL_EUR) AS Matko_EK_IL_EUR,
			SUM(Matko_GK_SO_EUR) AS Matko_GK_SO_EUR,
			SUM(Matko_GK_SO_IL_EUR) AS Matko_GK_SO_IL_EUR,
			SUM(Matko_GK) AS Matko_GK,
			SUM(Matko_GK_IL) AS Matko_GK_IL,
			SUM(Matko_So) AS Matko_So,
			SUM(Matko_So_IL) AS Matko_So_IL,
			SUM(Fremd_EK_EUR) AS Fremd_EK_EUR,
			SUM(Pers_var_EUR) AS Pers_var_EUR,
			SUM(Pers_fix_EUR) AS Pers_fix_EUR,
			SUM(Ekosten_var_EUR) AS Ekosten_var_EUR,
			SUM(Ekosten_fix_EUR) AS Ekosten_fix_EUR,
			SUM(Leasing_var_EUR) AS Leasing_var_EUR,
			SUM(Leasing_fix_EUR) AS Leasing_fix_EUR,
			SUM(Inst_var_EUR) AS Inst_var_EUR,
			SUM(Inst_fix_EUR) AS Inst_fix_EUR,
			SUM(Sokosten_var_EUR) AS Sokosten_var_EUR,
			SUM(Sokosten_fix_EUR) AS Sokosten_fix_EUR,
			SUM(AlleKostenarten_EUR) AS AlleKostenarten_EUR,
			SUM(AlleKostenarten_var_EUR) AS AlleKostenarten_var_EUR,
			SUM(AlleKostenarten_fix_EUR) AS AlleKostenarten_fix_EUR,
			SUM(Materialkosten_EUR) AS Materialkosten_EUR,
			SUM(ELP_freiLB) AS ELP_freiLB,
			SUM(ELP_reserviert) AS ELP_reserviert,
			MAX(FAKomplAm) AS FAKomplAm,
			MAX(ArtikelCode) AS ArtikelCode,
			SUM(Herstellung_AnzMinuten) AS Herstellung_AnzMinuten,
			SUM(Vertriebskosten_var) AS Vertriebskosten_var,
			SUM(Vertriebskosten_fix) AS Vertriebskosten_fix,
			SUM(Verwaltungskosten_var) AS Verwaltungskosten_var,
			SUM(Verwaltungskosten_fix) AS Verwaltungskosten_fix,
			SUM(PersVertriebskosten_var) AS PersVertriebskosten_var,
			SUM(PersVertriebskosten_fix) AS PersVertriebskosten_fix,
			SUM(PersVerwaltungskosten_var) AS PersVerwaltungskosten_var,
			SUM(PersVerwaltungskosten_fix) AS PersVerwaltungskosten_fix,
			SUM(SollVorgabe_BM_Anteil) AS SollVorgabe_BM_Anteil,
			SUM(CAMKosten) AS CAMKosten,
			SUM(SoKostVertriebskosten_var) AS SoKostVertriebskosten_var,
			SUM(SoKostVertriebskosten_fix) AS SoKostVertriebskosten_fix,
			SUM(SoKostVerwaltungskosten_var) AS SoKostVerwaltungskosten_var,
			SUM(SoKostVerwaltungskosten_fix) AS SoKostVerwaltungskosten_fix,
			SUM(HandelEKVol) AS HandelEKVol,
			SUM(InhouseMasslamEKVol) AS InhouseMasslamEKVol,
			SUM(VKVol) AS VKVol,
			SUM(Lastschrift_EUR) AS Lastschrift_EUR,
			SUM(LastschriftNebenkosten_EUR) AS LastschriftNebenkosten_EUR,
			SUM(LastschriftSonstiges_EUR) AS LastschriftSonstiges_EUR,
			SUM(LastschriftRest_EUR) AS LastschriftRest_EUR,
			SUM(SonstigeLastschrift_EUR) AS SonstigeLastschrift_EUR,
			SUM(LastschriftNebenkostenHandel_EUR) AS LastschriftNebenkostenHandel_EUR,
			SUM(LastschriftRestkostenJHA_EUR) AS LastschriftRestkostenJHA_EUR,
			SUM(NKEinkauf_EUR) AS NKEinkauf_EUR,
			MAX(DEKPreis_EUR) AS DEKPreis_EUR,
			MAX(EKPreis_EUR) AS EKPreis_EUR,
			SUM(Gutschrift_EUR) AS Gutschrift_EUR,
			SUM(GutschriftNebenkosten_EUR) AS GutschriftNebenkosten_EUR,
			SUM(GutschriftMenge) AS GutschriftMenge,
			MAX(ProvisionVertreter) AS ProvisionVertreter,
			SUM(VerkaufProvision_EUR) AS VerkaufProvision_EUR,
			SUM(GutschriftProvision_EUR) AS GutschriftProvision_EUR,
			MAX(ProvisionVertreterProzent) AS ProvisionVertreterProzent,
			SUM(Aufgelegt) AS Aufgelegt,
			SUM(Ausschuss) AS Ausschuss,
			SUM(Aufgelegt*DVKPreis) AS Aufgelegt_EUR,
			SUM(Ausschuss*DVKPreis) AS Ausschuss_EUR,
			SUM(Produziert) AS Produziert,
			SUM(Ausschuss)/SUM(Aufgelegt) AS Ausschuss_Proz,
			SUM(LPKonsi) AS LPKonsi,
			SUM(LPKonsi_EUR) AS LPKonsi_EUR,
			AVG(Durch_VK_dm2) AS Durch_VK_dm2,
			SUM(LMenge) AS LMenge,
			SUM(NKVerkauf_EUR) AS NKVerkauf_EUR,
			SUM(RabattVerkauf_EUR) AS RabattVerkauf_EUR,
			SUM(EZVerkauf_EUR) AS EZVerkauf_EUR,
			SUM(VersandVerkauf_EUR) AS VersandVerkauf_EUR,
			SUM(FA_Umsatz_ohneGutschrift) AS FA_Umsatz_ohneGutschrift,
			SUM(Frachtkosten_EUR) AS Frachtkosten_EUR,
			SUM(GesamtVerkaufsmenge) AS GesamtVerkaufsmenge,
			MAX(DVKPreis_proKunde) AS DVKPreis,
			MAX(LetzterKommPreis_proKunde) AS LetzterKommPreis,
			SUM(Vorlageprovision) AS Vorlageprovision
		FROM ##TMP_tblDaten
		WHERE UserTimeStamp = @para1
		GROUP BY
			D10_PTR,
			Kunde,
			LP,
			PC
		*/
	END

	IF @Case_='Kunde' 
	BEGIN
		SELECT
			D10_PTR,
			Kunde,
			COUNT(DISTINCT LP) AS AnzLP,
			SUM(AnzFA) AS AnzFA,
			COUNT(DISTINCT PC) AS AnzPC,
			MAX(ELP_gesend_gewDP_proKunde) AS ELP_gesend_gewDP,
			SUM(FA_Umsatz) AS FA_Umsatz,
			SUM(FA_Umsatz_R) AS FA_Umsatz_R,
			SUM(LB_in_EUR) AS LB_in_EUR,
			SUM(EKHandelMasslamFA_EUR) AS EKHandelMasslamFA_EUR,
			SUM(Matko_EK_EUR) AS Matko_EK_EUR,
			SUM(Matko_EK_IL_EUR) AS Matko_EK_IL_EUR,
			SUM(Matko_GK_SO_EUR) AS Matko_GK_SO_EUR,
			SUM(Matko_GK_SO_IL_EUR) AS Matko_GK_SO_IL_EUR,
			SUM(Matko_GK) AS Matko_GK,
			SUM(Matko_GK_IL) AS Matko_GK_IL,
			SUM(Matko_So) AS Matko_So,
			SUM(Matko_So_IL) AS Matko_So_IL,
			SUM(Fremd_EK_EUR) AS Fremd_EK_EUR,
			SUM(Pers_var_EUR) AS Pers_var_EUR,
			SUM(Pers_fix_EUR) AS Pers_fix_EUR,
			SUM(Ekosten_var_EUR) AS Ekosten_var_EUR,
			SUM(Ekosten_fix_EUR) AS Ekosten_fix_EUR,
			SUM(Leasing_var_EUR) AS Leasing_var_EUR,
			SUM(Leasing_fix_EUR) AS Leasing_fix_EUR,
			SUM(Inst_var_EUR) AS Inst_var_EUR,
			SUM(Inst_fix_EUR) AS Inst_fix_EUR,
			SUM(Sokosten_var_EUR) AS Sokosten_var_EUR,
			SUM(Sokosten_fix_EUR) AS Sokosten_fix_EUR,
			SUM(AlleKostenarten_EUR) AS AlleKostenarten_EUR,
			SUM(AlleKostenarten_var_EUR) AS AlleKostenarten_var_EUR,
			SUM(AlleKostenarten_fix_EUR) AS AlleKostenarten_fix_EUR,
			SUM(Materialkosten_EUR) AS Materialkosten_EUR,
			SUM(ELP_freiLB) AS ELP_freiLB,
			SUM(ELP_reserviert) AS ELP_reserviert,
			MAX(FAKomplAm) AS FAKomplAm,
			MAX(ArtikelCode) AS ArtikelCode,
			SUM(Herstellung_AnzMinuten) AS Herstellung_AnzMinuten,
			SUM(Vertriebskosten_var) AS Vertriebskosten_var,
			SUM(Vertriebskosten_fix) AS Vertriebskosten_fix,
			SUM(Verwaltungskosten_var) AS Verwaltungskosten_var,
			SUM(Verwaltungskosten_fix) AS Verwaltungskosten_fix,
			SUM(PersVertriebskosten_var) AS PersVertriebskosten_var,
			SUM(PersVertriebskosten_fix) AS PersVertriebskosten_fix,
			SUM(PersVerwaltungskosten_var) AS PersVerwaltungskosten_var,
			SUM(PersVerwaltungskosten_fix) AS PersVerwaltungskosten_fix,
			SUM(SollVorgabe_BM_Anteil) AS SollVorgabe_BM_Anteil,
			SUM(CAMKosten) AS CAMKosten,
			SUM(SoKostVertriebskosten_var) AS SoKostVertriebskosten_var,
			SUM(SoKostVertriebskosten_fix) AS SoKostVertriebskosten_fix,
			SUM(SoKostVerwaltungskosten_var) AS SoKostVerwaltungskosten_var,
			SUM(SoKostVerwaltungskosten_fix) AS SoKostVerwaltungskosten_fix,
			SUM(HandelEKVol) AS HandelEKVol,
			SUM(InhouseMasslamEKVol) AS InhouseMasslamEKVol,
			SUM(VKVol) AS VKVol,
			SUM(Lastschrift_EUR) AS Lastschrift_EUR,
			SUM(LastschriftNebenkosten_EUR) AS LastschriftNebenkosten_EUR,
			SUM(LastschriftSonstiges_EUR) AS LastschriftSonstiges_EUR,
			SUM(LastschriftRest_EUR) AS LastschriftRest_EUR,
			SUM(SonstigeLastschrift_EUR) AS SonstigeLastschrift_EUR,
			SUM(LastschriftNebenkostenHandel_EUR) AS LastschriftNebenkostenHandel_EUR,
			SUM(LastschriftRestkostenJHA_EUR) AS LastschriftRestkostenJHA_EUR,
			SUM(NKEinkauf_EUR) AS NKEinkauf_EUR,
			MAX(DEKPreis_EUR) AS DEKPreis_EUR,
			MAX(EKPreis_EUR) AS EKPreis_EUR,
			SUM(Gutschrift_EUR) AS Gutschrift_EUR,
			SUM(GutschriftNebenkosten_EUR) AS GutschriftNebenkosten_EUR,
			SUM(GutschriftMenge) AS GutschriftMenge,
			MAX(ProvisionVertreter) AS ProvisionVertreter,
			SUM(VerkaufProvision_EUR) AS VerkaufProvision_EUR,
			SUM(GutschriftProvision_EUR) AS GutschriftProvision_EUR,
			MAX(ProvisionVertreterProzent) AS ProvisionVertreterProzent,
			SUM(Aufgelegt) AS Aufgelegt,
			SUM(Ausschuss) AS Ausschuss,
			SUM(Aufgelegt*DVKPreis) AS Aufgelegt_EUR,
			SUM(Ausschuss*DVKPreis) AS Ausschuss_EUR,
			SUM(Produziert) AS Produziert,
			SUM(Ausschuss)/SUM(Aufgelegt) AS Ausschuss_Proz,
			SUM(LPKonsi) AS LPKonsi,
			SUM(LPKonsi_EUR) AS LPKonsi_EUR,
			AVG(Durch_VK_dm2) AS Durch_VK_dm2,
			SUM(LMenge) AS LMenge,
			SUM(NKVerkauf_EUR) AS NKVerkauf_EUR,
			SUM(RabattVerkauf_EUR) AS RabattVerkauf_EUR,
			SUM(EZVerkauf_EUR) AS EZVerkauf_EUR,
			SUM(VersandVerkauf_EUR) AS VersandVerkauf_EUR,
			SUM(FA_Umsatz_ohneGutschrift) AS FA_Umsatz_ohneGutschrift,
			SUM(Frachtkosten_EUR) AS Frachtkosten_EUR,
			SUM(GesamtVerkaufsmenge) AS GesamtVerkaufsmenge,
			MAX(DVKPreis_proKunde) AS DVKPreis,
			MAX(LetzterKommPreis_proKunde) AS LetzterKommPreis,
			SUM(Vorlageprovision) AS Vorlageprovision
		FROM ##TMP_tblDaten
		WHERE UserTimeStamp = @para1
		GROUP BY
			D10_PTR,
			Kunde
		ORDER BY SUM(FA_Umsatz) DESC
	END

	IF @Case_='PC' 
	BEGIN
		SELECT
			--D10_PTR,
			COUNT(DISTINCT Kunde) AS AnzKunden,
			COUNT(DISTINCT LP) AS AnzLP,
			SUM(AnzFA) AS AnzFA,
			PC,
			MAX(ELP_gesend_gewDP_proPC) AS ELP_gesend_gewDP,
			SUM(FA_Umsatz) AS FA_Umsatz,
			SUM(FA_Umsatz_R) AS FA_Umsatz_R,
			SUM(LB_in_EUR) AS LB_in_EUR,
			SUM(EKHandelMasslamFA_EUR) AS EKHandelMasslamFA_EUR,
			SUM(Matko_EK_EUR) AS Matko_EK_EUR,
			SUM(Matko_EK_IL_EUR) AS Matko_EK_IL_EUR,
			SUM(Matko_GK_SO_EUR) AS Matko_GK_SO_EUR,
			SUM(Matko_GK_SO_IL_EUR) AS Matko_GK_SO_IL_EUR,
			SUM(Matko_GK) AS Matko_GK,
			SUM(Matko_GK_IL) AS Matko_GK_IL,
			SUM(Matko_So) AS Matko_So,
			SUM(Matko_So_IL) AS Matko_So_IL,
			SUM(Fremd_EK_EUR) AS Fremd_EK_EUR,
			SUM(Pers_var_EUR) AS Pers_var_EUR,
			SUM(Pers_fix_EUR) AS Pers_fix_EUR,
			SUM(Ekosten_var_EUR) AS Ekosten_var_EUR,
			SUM(Ekosten_fix_EUR) AS Ekosten_fix_EUR,
			SUM(Leasing_var_EUR) AS Leasing_var_EUR,
			SUM(Leasing_fix_EUR) AS Leasing_fix_EUR,
			SUM(Inst_var_EUR) AS Inst_var_EUR,
			SUM(Inst_fix_EUR) AS Inst_fix_EUR,
			SUM(Sokosten_var_EUR) AS Sokosten_var_EUR,
			SUM(Sokosten_fix_EUR) AS Sokosten_fix_EUR,
			SUM(AlleKostenarten_EUR) AS AlleKostenarten_EUR,
			SUM(AlleKostenarten_var_EUR) AS AlleKostenarten_var_EUR,
			SUM(AlleKostenarten_fix_EUR) AS AlleKostenarten_fix_EUR,
			SUM(Materialkosten_EUR) AS Materialkosten_EUR,
			SUM(ELP_freiLB) AS ELP_freiLB,
			SUM(ELP_reserviert) AS ELP_reserviert,
			MAX(FAKomplAm) AS FAKomplAm,
			MAX(ArtikelCode) AS ArtikelCode,
			SUM(Herstellung_AnzMinuten) AS Herstellung_AnzMinuten,
			SUM(Vertriebskosten_var) AS Vertriebskosten_var,
			SUM(Vertriebskosten_fix) AS Vertriebskosten_fix,
			SUM(Verwaltungskosten_var) AS Verwaltungskosten_var,
			SUM(Verwaltungskosten_fix) AS Verwaltungskosten_fix,
			SUM(PersVertriebskosten_var) AS PersVertriebskosten_var,
			SUM(PersVertriebskosten_fix) AS PersVertriebskosten_fix,
			SUM(PersVerwaltungskosten_var) AS PersVerwaltungskosten_var,
			SUM(PersVerwaltungskosten_fix) AS PersVerwaltungskosten_fix,
			SUM(SollVorgabe_BM_Anteil) AS SollVorgabe_BM_Anteil,
			SUM(CAMKosten) AS CAMKosten,
			SUM(SoKostVertriebskosten_var) AS SoKostVertriebskosten_var,
			SUM(SoKostVertriebskosten_fix) AS SoKostVertriebskosten_fix,
			SUM(SoKostVerwaltungskosten_var) AS SoKostVerwaltungskosten_var,
			SUM(SoKostVerwaltungskosten_fix) AS SoKostVerwaltungskosten_fix,
			SUM(HandelEKVol) AS HandelEKVol,
			SUM(InhouseMasslamEKVol) AS InhouseMasslamEKVol,
			SUM(VKVol) AS VKVol,
			SUM(Lastschrift_EUR) AS Lastschrift_EUR,
			SUM(LastschriftNebenkosten_EUR) AS LastschriftNebenkosten_EUR,
			SUM(LastschriftSonstiges_EUR) AS LastschriftSonstiges_EUR,
			SUM(LastschriftRest_EUR) AS LastschriftRest_EUR,
			SUM(SonstigeLastschrift_EUR) AS SonstigeLastschrift_EUR,
			SUM(LastschriftNebenkostenHandel_EUR) AS LastschriftNebenkostenHandel_EUR,
			SUM(LastschriftRestkostenJHA_EUR) AS LastschriftRestkostenJHA_EUR,
			SUM(NKEinkauf_EUR) AS NKEinkauf_EUR,
			MAX(DEKPreis_EUR) AS DEKPreis_EUR,
			MAX(EKPreis_EUR) AS EKPreis_EUR,
			SUM(Gutschrift_EUR) AS Gutschrift_EUR,
			SUM(GutschriftNebenkosten_EUR) AS GutschriftNebenkosten_EUR,
			SUM(GutschriftMenge) AS GutschriftMenge,
			MAX(ProvisionVertreter) AS ProvisionVertreter,
			SUM(VerkaufProvision_EUR) AS VerkaufProvision_EUR,
			SUM(GutschriftProvision_EUR) AS GutschriftProvision_EUR,
			MAX(ProvisionVertreterProzent) AS ProvisionVertreterProzent,
			SUM(Aufgelegt) AS Aufgelegt,
			SUM(Ausschuss) AS Ausschuss,
			SUM(Aufgelegt*DVKPreis) AS Aufgelegt_EUR,
			SUM(Ausschuss*DVKPreis) AS Ausschuss_EUR,
			SUM(Produziert) AS Produziert,
			SUM(Ausschuss)/SUM(Aufgelegt) AS Ausschuss_Proz,
			SUM(LPKonsi) AS LPKonsi,
			SUM(LPKonsi_EUR) AS LPKonsi_EUR,
			AVG(Durch_VK_dm2) AS Durch_VK_dm2,
			SUM(LMenge) AS LMenge,
			SUM(NKVerkauf_EUR) AS NKVerkauf_EUR,
			SUM(RabattVerkauf_EUR) AS RabattVerkauf_EUR,
			SUM(EZVerkauf_EUR) AS EZVerkauf_EUR,
			SUM(VersandVerkauf_EUR) AS VersandVerkauf_EUR,
			SUM(FA_Umsatz_ohneGutschrift) AS FA_Umsatz_ohneGutschrift,
			SUM(Frachtkosten_EUR) AS Frachtkosten_EUR,
			SUM(GesamtVerkaufsmenge) AS GesamtVerkaufsmenge,
			MAX(DVKPreis_proPC) AS DVKPreis,
			MAX(LetzterKommPreis_proKunde) AS LetzterKommPreis,
			SUM(Vorlageprovision) AS Vorlageprovision
		FROM ##TMP_tblDaten
		WHERE UserTimeStamp = @para1
		GROUP BY
			PC
		ORDER BY SUM(FA_Umsatz) DESC
	END
	

	IF @Case_ = 'NachKalk_Berichte_Kundengruppiert'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255),
			@para7 varchar(255),
			@para8 varchar(255),
			@para9 varchar(255),
			@para10 varchar(255)
		SET @para1 = 'Handel 2015 2'
		SET @para2 = '74, 492' --Kunde
		SET @para3 = '39223, 33339' --Kundenteil
		SET @para4 = '-1' --PC
		--SET @para5 = ''Intern', 'Masslam', 'Handel''
		SET @para6 = '01.01.2015'
		SET @para7 = '31.12.2015'
		SET @para8 = 'Intern'
		SET @para9 = 'Masslam'
		SET @para10 = 'Handel'
		*/

		DECLARE 
			@InsertSQLKunden varchar(1000)

		--Kunde
		DECLARE @tblD10Kunden table(D10_PTR NUMERIC(10, 0))
		IF @para2<>'-1'
		BEGIN
			SET @InsertSQLKunden = '
								--INSERT @tblD10(D10_PTR)
								SELECT DISTINCT
									D10_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
								WHERE
									tblNachKalk_Daten.D10_PTR IN (' + RTRIM(@para2) + ')
							'
							INSERT @tblD10Kunden(D10_PTR) EXECUTE(@InsertSQLKunden)
		END
		ELSE
		BEGIN
			INSERT @tblD10Kunden(D10_PTR)
			SELECT DISTINCT
				D10_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
		END

		--Kundenteil
		DECLARE @tblD50Kunden table(D50_PTR NUMERIC(10, 0))
		IF @para3<>'-1'
		BEGIN
			SET @InsertSQLKunden = '
								--INSERT @tblD50(D50_PTR)
								SELECT DISTINCT
									D50_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
								WHERE
									tblNachKalk_Daten.D50_PTR IN (' + RTRIM(@para3) + ')
							'
							INSERT @tblD50Kunden(D50_PTR) EXECUTE(@InsertSQLKunden)
		END
		ELSE
		BEGIN
			INSERT @tblD50Kunden(D50_PTR)
			SELECT DISTINCT
				D50_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
		END

		--PC
		DECLARE @tblD8Kunden table(D8_PTR NUMERIC(10, 0))
		IF @para4<>'-1'
		BEGIN
			SET @InsertSQLKunden = '
								--INSERT @tblD8(D8_PTR)
								SELECT DISTINCT
									D8_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
								WHERE
									tblNachKalk_Daten.D8_PTR IN (' + RTRIM(@para4) + ')
							'
							INSERT @tblD8Kunden(D8_PTR) EXECUTE(@InsertSQLKunden)
		END
		ELSE
		BEGIN
			INSERT @tblD8Kunden(D8_PTR)
			SELECT DISTINCT
				D8_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
		END

		--Lastschriften
		DECLARE @tblLSKunde table(LS VARCHAR(9), LSBetrag FLOAT)
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '41333.301' AS LS, 1823 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '53136.300' AS LS, 1286 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '50735.300' AS LS, 4694 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '51712.302' AS LS, 584 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '52247.300' AS LS, 4625 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '34844.202' AS LS, 1853 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '49037.300' AS LS, 316 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '52395.300' AS LS, 1827 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '46660.301' AS LS, 5086 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '46861.301' AS LS, 704 AS LSBetrag
		INSERT @tblLSKunde(LS, LSBetrag) SELECT '51915.300' AS LS, 533 AS LSBetrag

		SELECT
			D10_PTR,
			Kunde,
			COUNT(DISTINCT LP) AS AnzLP,
			--MAX(AnzKommissionen) AS AnzKommissionen,
			--MAX(Kommission) AS Kommission,
			SUM(AnzFA) AS AnzFA,
			COUNT(DISTINCT PC) AS AnzPC,
			MAX(ELP_gesend_gewDP) AS ELP_gesend_gewDP,
			SUM(FA_Umsatz) AS FA_Umsatz,
			SUM(LB_in_EUR) AS LB_in_EUR,
			SUM(EKHandelNasslamFA_EUR) AS EKHandelNasslamFA_EUR,
			SUM(Matko_EK_EUR) AS Matko_EK_EUR,
			SUM(Matko_EK_IL_EUR) AS Matko_EK_IL_EUR,
			SUM(Matko_GK_SO_EUR) AS Matko_GK_SO_EUR,
			SUM(Matko_GK_SO_IL_EUR) AS Matko_GK_SO_IL_EUR,
			SUM(Matko_GK) AS Matko_GK,
			SUM(Matko_GK_IL) AS Matko_GK_IL,
			SUM(Matko_So) AS Matko_So,
			SUM(Matko_So_IL) AS Matko_So_IL,
			SUM(Fremd_EK_EUR) AS Fremd_EK_EUR,
			--SUM(Pers_etc_EUR) AS Pers_etc_EUR,
			--SUM(Kosten_Uml_EUR) AS Kosten_Uml_EUR,
			SUM(Pers_var_EUR) AS Pers_var_EUR,
			SUM(Pers_fix_EUR) AS Pers_fix_EUR,
			SUM(Ekosten_var_EUR) AS Ekosten_var_EUR,
			SUM(Ekosten_fix_EUR) AS Ekosten_fix_EUR,
			SUM(Leasing_var_EUR) AS Leasing_var_EUR,
			SUM(Leasing_fix_EUR) AS Leasing_fix_EUR,
			SUM(Inst_var_EUR) AS Inst_var_EUR,
			SUM(Inst_fix_EUR) AS Inst_fix_EUR,
			SUM(Sokosten_var_EUR) AS Sokosten_var_EUR,
			SUM(Sokosten_fix_EUR) AS Sokosten_fix_EUR,
			(
				SUM(Pers_var_EUR) + SUM(Pers_fix_EUR) 
				+ 
				SUM(Ekosten_var_EUR) + SUM(Ekosten_fix_EUR) 
				+ 
				SUM(Leasing_var_EUR) + SUM(Leasing_fix_EUR) 
				+ 
				SUM(Inst_var_EUR) + SUM(Inst_fix_EUR) 
				+ 
				SUM(Sokosten_var_EUR) + SUM(Sokosten_fix_EUR) 
			) AS AlleKostenarten_EUR,
			(
				SUM(Pers_var_EUR) 
				+ 
				SUM(Ekosten_var_EUR) 
				+ 
				SUM(Leasing_var_EUR) 
				+ 
				SUM(Inst_var_EUR) 
				+ 
				SUM(Sokosten_var_EUR) 
			) AS AlleKostenarten_var_EUR,
			(
				SUM(Pers_fix_EUR) 
				+ 
				SUM(Ekosten_fix_EUR) 
				+ 
				SUM(Leasing_fix_EUR) 
				+ 
				SUM(Inst_fix_EUR) 
				+ 
				SUM(Sokosten_fix_EUR) 
			) AS AlleKostenarten_fix_EUR,
			(
				SUM(EKHandelNasslamFA_EUR) + SUM(Matko_EK_EUR) + SUM(Matko_GK_SO_EUR) + SUM(Matko_EK_IL_EUR) + SUM(Matko_GK_SO_IL_EUR) + SUM(Fremd_EK_EUR)
			) AS Materialkosten_EUR,
			SUM(ELP_freiLB) AS ELP_freiLB,
			SUM(ELP_reserviert) AS ELP_reserviert,
			MAX(FAkomplAm) AS FAkomplAm,
			MAX(ArtikelCode) AS ArtikelCode,
			SUM(Lastschrift_EUR) AS Lastschrift_EUR,
			SUM(LastschriftNebenkosten_EUR) AS LastschriftNebenkosten_EUR,
			SUM(LastschriftSonstiges_EUR) AS LastschriftSonstiges_EUR,
			SUM(LastschriftRest_EUR) AS LastschriftRest_EUR,
			SUM(SonstigeLastschrift_EUR) AS SonstigeLastschrift_EUR,
			SUM(Vorlageprovision_EUR) AS Vorlageprovision_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Einkauf (BM, CU, PP, PCB, Masslam)
			SUM(NKEinkauf_EUR) AS NKEinkauf_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Gutschriften
			SUM(Gutschrift_EUR) AS Gutschrift_EUR,
			SUM(GutschriftNebenkosten_EUR) AS GutschriftNebenkosten_EUR,		
			SUM(GutschriftMenge) AS GutschriftMenge,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Provision
			MAX(ProvisionVerteter) AS ProvisionVerteter,
			SUM(VerkaufProvision_EUR) AS VerkaufProvision_EUR,
			SUM(GutschriftProvision_EUR) AS GutschriftProvision_EUR,
			AVG(ProvisionVerteterProzent) AS ProvisionVerteterProzent,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Produktion
			SUM(Aufgelegt) AS Aufgelegt,
			SUM(Ausschuss) AS Ausschuss,
			SUM(Produziert) AS Produziert,
			AVG(Ausschuss_Proz) AS Ausschuss_Proz,
			SUM(LPKonsi) AS LPKonsi,
			SUM(LPKonsi_EUR)  AS LPKonsi_EUR,
			SUM(Durch_VK_dm2) AS Durch_VK_dm2,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Verkauf
			SUM(LMenge) AS LMenge,
			SUM(NKVerkauf_EUR) AS NKVerkauf_EUR,
			SUM(RabattVerkauf_EUR) AS RabattVerkauf_EUR,
			SUM(EZVerkauf_EUR) AS EZVerkauf_EUR,
			SUM(VersandVerkauf_EUR) AS VersandVerkauf_EUR,
			--SUM(FA_Umsatz) AS FA_Umsatz,
			SUM(Frachtkosten_EUR) AS Frachtkosten_EUR,
			SUM(GesamtVerkaufsmenge) AS GesamtVerkaufsmenge,
			ISNULL((
					SELECT TOP 1
						SUM(gesendet * Preis) / SUM(gesendet) AS DVKPreis
					FROM
					(
						SELECT 
								dbo.DATA0052.QUAN_SHP AS gesendet,
								CASE 
									WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
										ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
										/ 
										dbo.DATA0060.EXCH_RATE 
									ELSE
										dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
								END AS Preis

						FROM         dbo.DATA0006 INNER JOIN
											  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE     
								--RTRIM(dbo.DATA0050.CUSTOMER_PART_NUMBER) + '.' + LTRIM(dbo.DATA0050.CP_REV) = @para1 --'51051.300' --'  
								dbo.DATA0010.RKEY=MAX(D10_PTR)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblDVKPreis
			), 0) AS DVKPreis,
			ISNULL((
					SELECT TOP 1 dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE AS RES
					FROM         dbo.DATA0054 INNER JOIN
										  dbo.DATA0006 ON dbo.DATA0054.WO_PTR = dbo.DATA0006.RKEY INNER JOIN
										  dbo.DATA0060 ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
										  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY
					WHERE
								dbo.DATA0010.RKEY=MAX(D10_PTR)
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0060.ENT_DATE DESC
			), 0) AS LetzterKommPreis

		FROM
		(
			SELECT
				D10_PTR,
				Kunde,
				LP,
				--MAX(AnzKommissionen) AS AnzKommissionen,
				--MAX(Kommission) AS Kommission,
				COUNT(FA) AS AnzFA,
				PC,
				MAX(ELP_gesend_gewDP) AS ELP_gesend_gewDP,
				SUM(FA_Umsatz) AS FA_Umsatz,
				SUM(LB_in_EUR) AS LB_in_EUR,
				SUM(EKHandelNasslamFA) AS EKHandelNasslamFA_EUR,


				SUM(Matko_EK_HauptFA) AS Matko_EK_EUR,
				SUM(Matko_EK_IL) AS Matko_EK_IL_EUR,
				SUM(Matko_GK_SO) AS Matko_GK_SO_EUR,
				SUM(Matko_GK_SO_IL) AS Matko_GK_SO_IL_EUR,
				SUM(Matko_GK_HauptFA) AS Matko_GK,
				SUM(Matko_GK_IL) AS Matko_GK_IL,
				SUM(Matko_So_HauptFA) AS Matko_So,
				SUM(Matko_So_IL) AS Matko_So_IL,
				SUM(Fremd_EK_HauptFA) AS Fremd_EK_EUR,
				SUM(Pers_var_HauptFA)+SUM(Pers_var_IL) AS Pers_var_EUR,
				SUM(Pers_fix_HauptFA)+SUM(Pers_fix_IL) AS Pers_fix_EUR,
				SUM(Ekosten_var_HauptFA)+SUM(Ekosten_var_IL) AS Ekosten_var_EUR,
				SUM(Ekosten_fix_HauptFA)+SUM(Ekosten_fix_IL) AS Ekosten_fix_EUR,
				SUM(Leasing_var_HauptFA)+SUM(Leasing_var_IL) AS Leasing_var_EUR,
				SUM(Leasing_fix_HauptFA)+SUM(Leasing_fix_IL) AS Leasing_fix_EUR,
				SUM(Inst_var_HauptFA)+SUM(Inst_var_IL) AS Inst_var_EUR,
				SUM(Inst_fix_HauptFA)+SUM(Inst_fix_IL) AS Inst_fix_EUR,
				SUM(Sokosten_var_HauptFA)+SUM(Sokosten_var_IL) AS Sokosten_var_EUR,
				SUM(Sokosten_fix_HauptFA)+SUM(Sokosten_fix_IL) AS Sokosten_fix_EUR,
				(
					SUM(Pers_var_HauptFA) + SUM(Pers_fix_HauptFA) + SUM(Pers_var_IL) + SUM(Pers_fix_IL) 
					+ 
					SUM(Ekosten_var_HauptFA) + SUM(Ekosten_fix_HauptFA) + SUM(Ekosten_var_IL) + SUM(Ekosten_fix_IL) 
					+ 
					SUM(Leasing_var_HauptFA) + SUM(Leasing_fix_HauptFA) + SUM(Leasing_var_IL) + SUM(Leasing_fix_IL) 
					+ 
					SUM(Inst_var_HauptFA) + SUM(Inst_fix_HauptFA) + SUM(Inst_var_IL) + SUM(Inst_fix_IL)
					+ 
					SUM(Sokosten_var_HauptFA) + SUM(Sokosten_fix_HauptFA) + SUM(Sokosten_var_IL) + SUM(Sokosten_fix_IL) 
				) AS AlleKostenarten_EUR,
				(
					SUM(Pers_var_HauptFA) + SUM(Pers_var_IL) 
					+ 
					SUM(Ekosten_var_HauptFA) + SUM(Ekosten_var_IL) 
					+ 
					SUM(Leasing_var_HauptFA) + SUM(Leasing_var_IL) 
					+ 
					SUM(Inst_var_HauptFA) + SUM(Inst_var_IL) 
					+ 
					SUM(Sokosten_var_HauptFA) + SUM(Sokosten_var_IL)
				) AS AlleKostenarten_var_EUR,
				(
					SUM(Pers_fix_HauptFA) + SUM(Pers_fix_IL) 
					+ 
					SUM(Ekosten_fix_HauptFA) + SUM(Ekosten_fix_IL) 
					+ 
					SUM(Leasing_fix_HauptFA) + SUM(Leasing_fix_IL) 
					+ 
					SUM(Inst_fix_HauptFA) + SUM(Inst_fix_IL) 
					+ 
					SUM(Sokosten_fix_HauptFA) + SUM(Sokosten_fix_IL)
				) AS AlleKostenarten_fix_EUR,
				(
					SUM(EKHandelNasslamFA) + SUM(Matko_EK_HauptFA) + SUM(Matko_GK_SO) + SUM(Fremd_EK_HauptFA) + SUM(Matko_EK_IL) + SUM(Matko_GK_SO_IL) 
				) AS Materialkosten_EUR,


				/*
				SUM(Matko_EK_HauptFA) AS Matko_EK_EUR,
				SUM(Matko_GK_SO) AS Matko_GK_SO_EUR,
				SUM(Matko_GK_HauptFA) AS Matko_GK,
				SUM(Matko_So_HauptFA) AS Matko_So,
				SUM(Fremd_EK_HauptFA) AS Fremd_EK_EUR,
				--SUM(Pers_etc) AS Pers_etc_EUR,
				--SUM(Kosten_Uml) AS Kosten_Uml_EUR,
				SUM(Pers_var_HauptFA) AS Pers_var_EUR,
				SUM(Pers_fix_HauptFA) AS Pers_fix_EUR,
				SUM(Ekosten_var_HauptFA) AS Ekosten_var_EUR,
				SUM(Ekosten_fix_HauptFA) AS Ekosten_fix_EUR,
				SUM(Leasing_var_HauptFA) AS Leasing_var_EUR,
				SUM(Leasing_fix_HauptFA) AS Leasing_fix_EUR,
				SUM(Inst_var_HauptFA) AS Inst_var_EUR,
				SUM(Inst_fix_HauptFA) AS Inst_fix_EUR,
				SUM(Sokosten_var_HauptFA) AS Sokosten_var_EUR,
				SUM(Sokosten_fix_HauptFA) AS Sokosten_fix_EUR,
				(
					SUM(Pers_var_HauptFA) + SUM(Pers_fix_HauptFA) 
					+ 
					SUM(Ekosten_var_HauptFA) + SUM(Ekosten_fix_HauptFA) 
					+ 
					SUM(Leasing_var_HauptFA) + SUM(Leasing_fix_HauptFA) 
					+ 
					SUM(Inst_var_HauptFA) + SUM(Inst_fix_HauptFA) 
					+ 
					SUM(Sokosten_var_HauptFA) + SUM(Sokosten_fix_HauptFA) 
				) AS AlleKostenarten_EUR,
				(
					SUM(Pers_var_HauptFA) 
					+ 
					SUM(Ekosten_var_HauptFA) 
					+ 
					SUM(Leasing_var_HauptFA) 
					+ 
					SUM(Inst_var_HauptFA) 
					+ 
					SUM(Sokosten_var_HauptFA) 
				) AS AlleKostenarten_var_EUR,
				(
					SUM(Pers_fix_HauptFA) 
					+ 
					SUM(Ekosten_fix_HauptFA) 
					+ 
					SUM(Leasing_fix_HauptFA) 
					+ 
					SUM(Inst_fix_HauptFA) 
					+ 
					SUM(Sokosten_fix_HauptFA) 
				) AS AlleKostenarten_fix_EUR,
				*/

				SUM(FA_freiLB) AS ELP_freiLB,
				SUM(FA_reserviert) AS ELP_reserviert,
				MAX(FAkomplAm) AS FAkomplAm,
				MAX(ArtikelCode) AS ArtikelCode,
				SUM(Vorlageprovision) AS Vorlageprovision_EUR,

				------------------------------------------------------------------------
				--Lastschriften
				ISNULL((
						SELECT TOP 1
							SUM(Lastschriften) 
							+
							ISNULL((SELECT TOP 1 LSBetrag FROM @tblLSKunde AS tblLSKunde WHERE LS COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(LP))), 0)
							AS Lastschrift_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0132.RKEY, 
								((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE) AS Lastschriften
								--(dbo.DATA0132.AMOUNT / dbo.DATA0132.EX_RATE) AS Lastschriften

							FROM         dbo.DATA0132 INNER JOIN
										dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
										dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
										dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

							WHERE      
										--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
										REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriften						
				), 0) AS Lastschrift_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(NK) AS LastschriftNK_EUR
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0132.RKEY,
								dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS NK
							FROM         dbo.DATA0199 INNER JOIN
													dbo.DATA0212 INNER JOIN
													dbo.DATA0132 INNER JOIN
													dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
													dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
													dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
													dbo.DATA0071 INNER JOIN
													dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
							WHERE     
										--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
										REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
										AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Nebenkosten Handel')
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriftenNebenkosten					
				), 0) AS LastschriftNebenkosten_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(Sonstiges) AS LastschriftSonstiges_EUR
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0132.RKEY,
								dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Sonstiges
							FROM         dbo.DATA0199 INNER JOIN
													dbo.DATA0212 INNER JOIN
													dbo.DATA0132 INNER JOIN
													dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
													dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
													dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
													dbo.DATA0071 INNER JOIN
													dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
							WHERE     
										--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
										REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
										AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Sonstiges')
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriftenSonstiges					
				), 0) AS LastschriftSonstiges_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(Rest) AS LastschriftRest_EUR
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0132.RKEY,
								dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Rest
							FROM         dbo.DATA0199 INNER JOIN
													dbo.DATA0212 INNER JOIN
													dbo.DATA0132 INNER JOIN
													dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
													dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
													dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
													dbo.DATA0071 INNER JOIN
													dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
							WHERE     
										--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
										REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
										AND dbo.DATA0199.MISC_CHARGE_CATEGORY NOT IN ('Sonstiges', 'Nebenkosten Handel')
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriftenRest						
				), 0) AS LastschriftRest_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(NKLastschriften) AS NKLastschrift_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0132.RKEY, 
								(dbo.DATA0132.MISC_TOT / dbo.DATA0132.EX_RATE) AS NKLastschriften

							FROM         dbo.DATA0132 INNER JOIN
										dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
										dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
										dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

							WHERE      
										--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
										REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblNKLastschriften						
				), 0) AS SonstigeLastschrift_EUR,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Einkauf (BM, CU, PP, PCB, Masslam)
				ISNULL(( 
					SELECT
						SUM(NK) AS NKEinkauf
					FROM
					(
						SELECT DISTINCT 
							D107_.RKEY,
							(D107_.SHIPPING + D107_.MISC_TOT) / D107_.EX_RATE  AS NK
						FROM         dbo.DATA0070 AS D70_ INNER JOIN
											dbo.DATA0071 AS D71_ ON D70_.RKEY = D71_.PO_PTR INNER JOIN
											dbo.DATA0108 AS D108_ ON D71_.RKEY = D108_.DATA0071_PTR INNER JOIN
											dbo.DATA0107 AS D107_ ON D108_.DATA0107_PTR = D107_.RKEY INNER JOIN
											dbo.DATA0017 AS D17_ ON D71_.INVT_PTR = D17_.RKEY
						WHERE
							--RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
							--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
							REPLACE(RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
							AND (D107_.INV_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (D107_.INV_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblNKEinkauf_
				), 0) AS NKEinkauf_EUR,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Gutschriften
				/*
				ISNULL((
					SELECT
						SUM(Gutschrift) AS Gutschrift_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0116.RKEY,
							(dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE AS Gutschrift
						FROM         dbo.DATA0060 INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
											  dbo.DATA0116 INNER JOIN
											  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschrift	
				), 0) AS Gutschrift_EUR,	
				*/
				ISNULL((
					SELECT
						SUM(BetragNetto) AS Gutschrift_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0116.RKEY,
							dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY) AS BetragNetto
						FROM         dbo.DATA0116 INNER JOIN
								  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
								  dbo.DATA0060 INNER JOIN
								  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschrift	
				), 0) AS Gutschrift_EUR,
				ISNULL((
					SELECT
						SUM(GSNK) AS GutschriftNK_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0116.RKEY,
							(
								((dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE)
								-
								(dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY)) 
							) AS GSNK
						FROM         dbo.DATA0116 INNER JOIN
								  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
								  dbo.DATA0060 INNER JOIN
								  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftNK
				), 0) AS GutschriftNebenkosten_EUR,		
				ISNULL((
					SELECT
						SUM(RMenge) AS GutschriftMenge
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0098.RKEY,
							dbo.DATA0098.QTY_AUTH AS RMenge
						FROM         
							dbo.DATA0098 
						WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftMenge
				), 0) AS GutschriftMenge,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Provision
				ISNULL((
					SELECT TOP 1
						dbo.DATA0009.SALES_REP_NAME
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
											dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
											dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
											dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
					WHERE
						dbo.DATA0050.RKEY = MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
				), '') AS ProvisionVerteter,
				SUM(FA_Umsatz_VertProvision) AS VerkaufProvision_EUR,
				ISNULL((
					SELECT
						SUM(Provision) AS GutschriftNK_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0116.RKEY,
							ISNULL(dbo.DATA0509.COMMISSION_DEBITED / dbo.DATA0509.EXCHANGE_RATE, 0) AS Provision
						FROM         dbo.DATA0125 INNER JOIN
											  dbo.DATA0509 ON dbo.DATA0125.DATA0509_PTR = dbo.DATA0509.RKEY RIGHT OUTER JOIN
											  dbo.DATA0116 INNER JOIN
											  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
											  dbo.DATA0060 INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY ON 
											  dbo.DATA0125.MEMO_PTR = dbo.DATA0116.RKEY LEFT OUTER JOIN
											  dbo.DATA0508 INNER JOIN
											  dbo.DATA0061 ON dbo.DATA0508.DATA0061_PTR = dbo.DATA0061.RKEY INNER JOIN
											  dbo.DATA0124 ON dbo.DATA0508.RKEY = dbo.DATA0124.DATA0508_PTR ON dbo.DATA0116.RKEY = dbo.DATA0124.MEMO_PTR
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftNK
				), 0) AS GutschriftProvision_EUR,
				ISNULL((
					SELECT TOP 1
						dbo.DATA0009.COMMISSION_1
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
											dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
											dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
											dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
					WHERE
						dbo.DATA0050.RKEY = MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
				), 0)/100 AS ProvisionVerteterProzent,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Produktion
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_SCH) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_SCH
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAufgelegt
				), 0) AS Aufgelegt,
				ISNULL((
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_REJ) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_REJ 
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) <> 'R'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblAusschuss
					), 0)
					+
					ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
						SELECT
							SUM(RMenge) AS GutschriftMenge
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0098.RKEY,
								dbo.DATA0098.QTY_AUTH AS RMenge
							FROM         
								dbo.DATA0098 
							WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
									AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblGutschriftMenge
					), 0)
					-
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_PROD) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_PROD
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblProduziert
					), 0)
				), 0) AS Ausschuss,
				ISNULL((
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_PROD) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_PROD
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblProduziert
					), 0)
					-
					ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
						SELECT
							SUM(RMenge) AS GutschriftMenge
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0098.RKEY,
								dbo.DATA0098.QTY_AUTH AS RMenge
							FROM         
								dbo.DATA0098 
							WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
									AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblGutschriftMenge
					), 0)
					-
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_REJ) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_REJ
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='W'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblAusschuss_R
					), 0)
					+
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_PROD) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_PROD
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblProduziert
					), 0)
				), 0) AS Produziert,
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_REJ)/SUM(QUAN_SCH) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_REJ,
							dbo.DATA0006.QUAN_SCH
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAusschuss
				), 0) AS Ausschuss_Proz,
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND) AS LPKonsi_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND
							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				), 0) AS LPKonsi,
				/*
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND) AS LPKonsi_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND
							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				), 0) * MAX(ELP_gesend_gewDP)  AS LPKonsi_EUR,
				*/
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND*LAST_SO_PRICE) AS LPKonsi_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND,
								dbo.DATA0050.LAST_SO_PRICE
							--FROM         dbo.DATA0006 INNER JOIN
							--						dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							FROM         dbo.DATA0006 INNER JOIN
												  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				--), 0) * MAX(ELP_gesend_gewDP)  AS LPKonsi_EUR,
				), 0)  AS LPKonsi_EUR,
				ISNULL((
					SELECT TOP 1
						SUM(gesendet_FA * KNX * KNY / ELP_KN / 10000) AS RES
					FROM
					(
						SELECT 
							dbo.ARTIKELDATEN.*,
							dbo.DATA0050.RKEY AS D0050_PTR,
							CASE 
								WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
									ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
									* 
									dbo.DATA0060.EXCH_RATE 
								ELSE
									dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
							END AS ELP_Preis_EUR,
							dbo.DATA0052.QUAN_SHP AS gesendet_FA

						FROM         dbo.DATA0006 INNER JOIN
												dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
												dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
												dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
												dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
												dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
												dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE
							(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblFAUmsatz
					WHERE D0050_PTR = MAX(D50_PTR) 
				), 0) AS Durch_VK_dm2,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Verkauf
				ISNULL((
					SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				), 0) AS LMenge,
				ISNULL((
					SELECT
						SUM(NK) AS NKVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.TOOLING_CHARGES AS NK
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblNKVerkauf
				), 0) AS NKVerkauf_EUR,
				ISNULL((
					SELECT
						SUM(Rabatt) AS RabattVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.DISCOUNT_AMOUNT AS Rabatt
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblRabattVerkauf
				), 0) AS RabattVerkauf_EUR,
				ISNULL((
					SELECT
						SUM(Einzuschlag) AS EZVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.RUSH_CHARGE_AMOUNT AS Einzuschlag
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblEZVerkauf
				), 0) AS EZVerkauf_EUR,
				ISNULL((
					SELECT
						SUM(Versandkosten) AS VersandVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.SHIPPING_CHARGES AS Versandkosten
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblVersandVerkauf
				), 0) AS VersandVerkauf_EUR,

				(
					SUM(FA_Umsatz)
					-
					ISNULL((
						SELECT TOP 1 
							SUM(Gutschrift) AS Gutschrift_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0116.RKEY,
								dbo.DATA0116.CREDIT_AMOUNT/dbo.DATA0116.EX_RATE - dbo.DATA0116.STATE_TAX AS Gutschrift
							FROM         dbo.DATA0060 INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
												  dbo.DATA0116 INNER JOIN
												  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
							WHERE     (dbo.DATA0060.CUST_PART_PTR = MAX(D50_PTR))
									AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblGutschrift	
					), 0)
				) AS FA_Umsatz_ohneGutschrift,
				ISNULL((
					SELECT TOP 1
						--SUM(FK) AS FK1,
						SUM(FK/CASE WHEN PlusZeichen_1=0 THEN 1 ELSE CASE WHEN PlusZeichen_1>0 AND PlusZeichen_2=0 THEN 2 ELSE 3 END END) AS FK_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0072.RKEY,
							dbo.DATA0072.DESCRIPTION2 AS LP,
							(dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE * dbo.DATA0072.QUAN_ORD) AS FK,
							CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 1) AS PlusZeichen_1,
							CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 21) AS PlusZeichen_2
						FROM         dbo.DATA0070 INNER JOIN
											  dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR
						WHERE
							LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION, '')), 3) = 'FK '
							AND LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION2, '')), 3) = 'LP '
							AND dbo.DATA0072.DESCRIPTION2 COLLATE SQL_Latin1_General_CP1_CI_AS LIKE '%' + LTRIM(RTRIM(LP)) + '%' 
							AND (dbo.DATA0070.PO_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0070.PO_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblFK
				), 0) AS Frachtkosten_EUR,
				ISNULL((
					ISNULL(SUM(FA_reserviert), 0)
					+
					ISNULL((
						SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
						FROM         dbo.DATA0006 INNER JOIN
												dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					), 0) 
				), 0) AS GesamtVerkaufsmenge
				------------------------------------------------------------------------
				------------------------------------------------------------------------

			FROM
			(
				SELECT
					tblDaten.*
					--CAST(ELP_gesend_gewDP*FA_reserviert AS FLOAT) AS LB_in_EUR
				FROM
				(
					SELECT
						tblNachKalk_Daten.D10_PTR,
						tblNachKalk_Daten.Kunde,
						tblNachKalk_Daten.Aufbereitung,
						tblNachKalk_Daten.LP,
						tblNachKalk_Daten.D50_PTR,
						tblNachKalk_Daten.D60_PTR,
						CASE
							WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)='1' THEN 
								'Intern'
							ELSE
								CASE
									WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)='2' THEN 
										'Masslam'
									ELSE
										CASE
											WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)='3' THEN 
												'Handel'
											ELSE
												'unbekannt'
										END
								END
						END AS InternMasslamHandel,
						tblNachKalk_Daten.PC,
						--tblNachKalk_Daten.AnzKommissionen,
						--tblNachKalk_Daten.Kommission,
						tblNachKalk_Daten.FA,
						ISNULL((
							ISNULL((
								SELECT TOP 1
									SUM(RES) AS umsatz
								FROM
								(
									SELECT 
										dbo.DATA0006.RKEY AS D0006_PTR,
										(
											CASE 
												WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
													ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
													/ 
													dbo.DATA0060.EXCH_RATE 
												ELSE
													dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
											END --ELP_Preis_EUR
											*
											dbo.DATA0052.QUAN_SHP --AS gesendet_FA
										) AS RES
									FROM         dbo.DATA0006 INNER JOIN
														  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
														  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
														  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
														  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
														  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
														  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
														  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
														  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
									WHERE
										(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								) AS tblFAUmsatz
								WHERE 
									D0006_PTR = D6_PTR 
									--D0006_PTR = CASE WHEN LEFT(tblNachKalk_Daten.FA, 1)='S' THEN tblNachKalk_Daten.D6S_PTR ELSE tblNachKalk_Daten.D6_PTR END
							), 0)
						), 0) AS FA_Umsatz,
						ISNULL((
							SELECT TOP 1
								SUM(RES) AS umsatzProv
							FROM
							(
								SELECT 
									dbo.DATA0006.RKEY AS D0006_PTR,
									(
										CASE 
											WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
												ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
												/ 
												dbo.DATA0060.EXCH_RATE 
											ELSE
												dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
										END --ELP_Preis_EUR
										*
										dbo.DATA0052.QUAN_SHP --AS gesendet_FA
										*
										(dbo.DATA0509.SALES_COMMISSION_PER/100)
									) AS RES
								FROM         dbo.DATA0006 INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
													  dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
													  dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR
								WHERE
									(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							) AS tblFAUmsatzProv
							WHERE D0006_PTR = D6_PTR 
						), 0) AS FA_Umsatz_VertProvision,
						tblNachKalk_Daten.EK_Handel_Masslam_HauptFA AS EKHandelNasslamFA,
						tblNachKalk_Daten.Matko_EK_HauptFA,
						tblNachKalk_Daten.Matko_EK_IL,
						tblNachKalk_Daten.Matko_GK_HauptFA + tblNachKalk_Daten.Matko_So_HauptFA AS Matko_GK_SO,
						tblNachKalk_Daten.Matko_GK_IL + tblNachKalk_Daten.Matko_So_IL AS Matko_GK_SO_IL,
						tblNachKalk_Daten.Matko_GK_HauptFA,
						tblNachKalk_Daten.Matko_GK_IL,
						tblNachKalk_Daten.Matko_So_HauptFA,
						tblNachKalk_Daten.Matko_So_IL,
						tblNachKalk_Daten.Fremd_EK_HauptFA,
						--tblNachKalk_Daten.Pers_etc,
						--tblNachKalk_Daten.Kosten_Uml,
						ISNULL((SELECT TOP 1 QTY_ALLOC AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_reserviert,
						ISNULL((
								SELECT TOP 1
									SUM(RES) AS LBEur
								FROM
								(
									SELECT DISTINCT
										dbo.DATA0053.RKEY,
										(dbo.DATA0060.PART_PRICE/dbo.DATA0060.EXCH_RATE*dbo.DATA0053.QTY_ALLOC) AS RES
										--SUM(dbo.DATA0053.QTY_ALLOC) AS RES
									FROM         dbo.DATA0060 INNER JOIN
														  dbo.DATA0063 ON dbo.DATA0060.RKEY = dbo.DATA0063.SO_PTR INNER JOIN
														  dbo.DATA0053 ON dbo.DATA0063.PART_BATCH_PTR = dbo.DATA0053.RKEY
									WHERE dbo.DATA0053.WORK_ORDER_PTR = D6_PTR 
								) AS tblLBEur
						), 0) AS LB_in_EUR,
						ISNULL((SELECT TOP 1 (QTY_ON_HAND - QTY_ALLOC) AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_freiLB,
						--tblNachKalk_Daten.Aus_in_Proz,
						ISNULL((
							SELECT TOP 1
								SUM(ELP_Preis_EUR*gesendet_FA)/SUM(gesendet_FA) AS umsatz
							FROM
							(
								SELECT DISTINCT
									dbo.DATA0006.ACT_COMPL_DATE,
									dbo.DATA0050.RKEY AS D0050_PTR,
									--dbo.DATA0006.RKEY AS D0006_PTR,
									CASE 
										WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
											ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
											* 
											dbo.DATA0060.EXCH_RATE 
										ELSE
											dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
									END AS ELP_Preis_EUR,
									dbo.DATA0052.QUAN_SHP AS gesendet_FA

								FROM         dbo.DATA0006 INNER JOIN
														dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
														dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
														dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
														dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
														dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
														dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
														dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
														dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
							) AS tblFAUmsatz
							WHERE 
								D0050_PTR = tblNachKalk_Daten.D50_PTR
								AND (ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							--WHERE D0006_PTR = D6_PTR 
						), 
							(
								SELECT TOP 1 (dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE) AS RES 
								FROM dbo.DATA0054 INNER JOIN  dbo.DATA0060 ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY 
								WHERE dbo.DATA0060.CUST_PART_PTR = tblNachKalk_Daten.D50_PTR
							)
						) AS ELP_gesend_gewDP,
						tblNachKalk_Daten.FAkomplAm,
						tblNachKalk_Daten.ArtikelCode,
						tblNachKalk_Daten.Pers_var_HauptFA,
						tblNachKalk_Daten.Pers_fix_HauptFA,
						tblNachKalk_Daten.Ekosten_var_HauptFA,
						tblNachKalk_Daten.Ekosten_fix_HauptFA,
						tblNachKalk_Daten.Leasing_var_HauptFA,
						tblNachKalk_Daten.Leasing_fix_HauptFA,
						tblNachKalk_Daten.Inst_var_HauptFA,
						tblNachKalk_Daten.Inst_fix_HauptFA,
						tblNachKalk_Daten.Sokosten_var_HauptFA,
						tblNachKalk_Daten.Sokosten_fix_HauptFA,
						tblNachKalk_Daten.Pers_var_IL,
						tblNachKalk_Daten.Pers_fix_IL,
						tblNachKalk_Daten.Ekosten_var_IL,
						tblNachKalk_Daten.Ekosten_fix_IL,
						tblNachKalk_Daten.Leasing_var_IL,
						tblNachKalk_Daten.Leasing_fix_IL,
						tblNachKalk_Daten.Inst_var_IL,
						tblNachKalk_Daten.Inst_fix_IL,
						tblNachKalk_Daten.Sokosten_var_IL,
						tblNachKalk_Daten.Sokosten_fix_IL,
						--Kunde
						ISNULL(Vorlageprovision, 0) AS Vorlageprovision

					FROM
						LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten
					WHERE 
						tblNachKalk_Daten.FAkomplAm >= CONVERT(DATETIME, @para6, 103)
						AND tblNachKalk_Daten.FAkomplAm <= CONVERT(DATETIME, @para7, 103)
						AND tblNachKalk_Daten.Aufbereitung = @para1
						AND tblNachKalk_Daten.D10_PTR IN (SELECT D10_PTR FROM @tblD10Kunden)
						AND tblNachKalk_Daten.D50_PTR IN (SELECT D50_PTR FROM @tblD50Kunden)
						AND tblNachKalk_Daten.D8_PTR IN (SELECT D8_PTR FROM @tblD8Kunden)
				) AS tblDaten
			) AS tblDatenGrp 
			WHERE 
				InternMasslamHandel IN (ISNULL(@para8, ''), ISNULL(@para9, ''), ISNULL(@para10, ''), ISNULL(@para12, ''))
			GROUP BY
				D10_PTR,
				Kunde, 
				LP,
				PC
		) AS tblKundeGrupp
		GROUP BY
			D10_PTR,
			Kunde
	END

	IF @Case_ = 'NachKalk_Berichte_PCgruppiert'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255),
			@para7 varchar(255),
			@para8 varchar(255),
			@para9 varchar(255),
			@para10 varchar(255)
		SET @para1 = 'Handel 2015 2'
		SET @para2 = '74, 492' --Kunde
		SET @para3 = '39223, 33339' --Kundenteil
		SET @para4 = '-1' --PC
		--SET @para5 = ''Intern', 'Masslam', 'Handel''
		SET @para6 = '01.01.2015'
		SET @para7 = '31.12.2015'
		SET @para8 = 'Intern'
		SET @para9 = 'Masslam'
		SET @para10 = 'Handel'
		*/

		DECLARE 
			@InsertSQLPC varchar(1000)

		--Kunde
		DECLARE @tblD10PC table(D10_PTR NUMERIC(10, 0))
		IF @para2<>'-1'
		BEGIN
			SET @InsertSQLPC = '
								--INSERT @tblD10(D10_PTR)
								SELECT DISTINCT
									D10_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
								WHERE
									tblNachKalk_Daten.D10_PTR IN (' + RTRIM(@para2) + ')
							'
							INSERT @tblD10PC(D10_PTR) EXECUTE(@InsertSQLPC)
		END
		ELSE
		BEGIN
			INSERT @tblD10PC(D10_PTR)
			SELECT DISTINCT
				D10_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
		END

		--Kundenteil
		DECLARE @tblD50PC table(D50_PTR NUMERIC(10, 0))
		IF @para3<>'-1'
		BEGIN
			SET @InsertSQLPC = '
								--INSERT @tblD50(D50_PTR)
								SELECT DISTINCT
									D50_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
								WHERE
									tblNachKalk_Daten.D50_PTR IN (' + RTRIM(@para3) + ')
							'
							INSERT @tblD50PC(D50_PTR) EXECUTE(@InsertSQLPC)
		END
		ELSE
		BEGIN
			INSERT @tblD50PC(D50_PTR)
			SELECT DISTINCT
				D50_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
		END

		--PC
		DECLARE @tblD8PC table(D8_PTR NUMERIC(10, 0))
		IF @para4<>'-1'
		BEGIN
			SET @InsertSQLPC = '
								--INSERT @tblD8(D8_PTR)
								SELECT DISTINCT
									D8_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
								WHERE
									tblNachKalk_Daten.D8_PTR IN (' + RTRIM(@para4) + ')
							'
							INSERT @tblD8PC(D8_PTR) EXECUTE(@InsertSQLPC)
		END
		ELSE
		BEGIN
			INSERT @tblD8PC(D8_PTR)
			SELECT DISTINCT
				D8_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
		END

		--Lastschriften
		DECLARE @tblLSPC table(LS VARCHAR(9), LSBetrag FLOAT)
		INSERT @tblLSPC(LS, LSBetrag) SELECT '41333.301' AS LS, 1823 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '53136.300' AS LS, 1286 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '50735.300' AS LS, 4694 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '51712.302' AS LS, 584 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '52247.300' AS LS, 4625 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '34844.202' AS LS, 1853 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '49037.300' AS LS, 316 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '52395.300' AS LS, 1827 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '46660.301' AS LS, 5086 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '46861.301' AS LS, 704 AS LSBetrag
		INSERT @tblLSPC(LS, LSBetrag) SELECT '51915.300' AS LS, 533 AS LSBetrag


		SELECT
			ISNULL((
				SELECT TOP 1
					COUNT(DISTINCT D10_PTR) AS RES
				FROM
					LIVE2.dbo.NachKalk_Daten AS tblNachKalk_Daten
				WHERE 
					tblNachKalk_Daten.FAkomplAm >= CONVERT(DATETIME, @para6, 103)
					AND tblNachKalk_Daten.FAkomplAm <= CONVERT(DATETIME, @para7, 103)
					AND tblNachKalk_Daten.Aufbereitung = @para1
					AND tblNachKalk_Daten.D10_PTR IN (SELECT D10_PTR FROM @tblD10PC)
					AND tblNachKalk_Daten.D50_PTR IN (SELECT D50_PTR FROM @tblD50PC)
					AND tblNachKalk_Daten.D8_PTR IN (SELECT D8_PTR FROM @tblD8PC)
			), 0) AS Summenzeile_AnzKunden,
			COUNT(DISTINCT Kunde) AS AnzKunden,
			COUNT(DISTINCT LP) AS AnzLP,
			--MAX(AnzKommissionen) AS AnzKommissionen,
			--MAX(Kommission) AS Kommission,
			SUM(AnzFA) AS AnzFA,
			PC,
			MAX(ELP_gesend_gewDP) AS ELP_gesend_gewDP,
			SUM(FA_Umsatz) AS FA_Umsatz,
			SUM(LB_in_EUR) AS LB_in_EUR,
			SUM(EKHandelNasslamFA_EUR) AS EKHandelNasslamFA_EUR,
			SUM(Matko_EK_EUR) AS Matko_EK_EUR,
			SUM(Matko_EK_IL_EUR) AS Matko_EK_IL_EUR,
			SUM(Matko_GK_SO_EUR) AS Matko_GK_SO_EUR,
			SUM(Matko_GK_SO_IL_EUR) AS Matko_GK_SO_IL_EUR,
			SUM(Matko_GK) AS Matko_GK,
			SUM(Matko_GK_IL) AS Matko_GK_IL,
			SUM(Matko_So) AS Matko_So,
			SUM(Matko_So_IL) AS Matko_So_IL,
			SUM(Fremd_EK_EUR) AS Fremd_EK_EUR,
			--SUM(Pers_etc_EUR) AS Pers_etc_EUR,
			--SUM(Kosten_Uml_EUR) AS Kosten_Uml_EUR,
			SUM(Pers_var_EUR) AS Pers_var_EUR,
			SUM(Pers_fix_EUR) AS Pers_fix_EUR,
			SUM(Ekosten_var_EUR) AS Ekosten_var_EUR,
			SUM(Ekosten_fix_EUR) AS Ekosten_fix_EUR,
			SUM(Leasing_var_EUR) AS Leasing_var_EUR,
			SUM(Leasing_fix_EUR) AS Leasing_fix_EUR,
			SUM(Inst_var_EUR) AS Inst_var_EUR,
			SUM(Inst_fix_EUR) AS Inst_fix_EUR,
			SUM(Sokosten_var_EUR) AS Sokosten_var_EUR,
			SUM(Sokosten_fix_EUR) AS Sokosten_fix_EUR,
			(
				SUM(Pers_var_EUR) + SUM(Pers_fix_EUR) 
				+ 
				SUM(Ekosten_var_EUR) + SUM(Ekosten_fix_EUR) 
				+ 
				SUM(Leasing_var_EUR) + SUM(Leasing_fix_EUR) 
				+ 
				SUM(Inst_var_EUR) + SUM(Inst_fix_EUR) 
				+ 
				SUM(Sokosten_var_EUR) + SUM(Sokosten_fix_EUR) 
			) AS AlleKostenarten_EUR,
			(
				SUM(Pers_var_EUR) 
				+ 
				SUM(Ekosten_var_EUR) 
				+ 
				SUM(Leasing_var_EUR) 
				+ 
				SUM(Inst_var_EUR) 
				+ 
				SUM(Sokosten_var_EUR) 
			) AS AlleKostenarten_var_EUR,
			(
				SUM(Pers_fix_EUR) 
				+ 
				SUM(Ekosten_fix_EUR) 
				+ 
				SUM(Leasing_fix_EUR) 
				+ 
				SUM(Inst_fix_EUR) 
				+ 
				SUM(Sokosten_fix_EUR) 
			) AS AlleKostenarten_fix_EUR,
			(
				SUM(EKHandelNasslamFA_EUR) + SUM(Matko_EK_EUR) + SUM(Matko_GK_SO_EUR) + SUM(Matko_EK_IL_EUR) + SUM(Matko_GK_SO_IL_EUR) + SUM(Fremd_EK_EUR)
			) AS Materialkosten_EUR,
			SUM(ELP_freiLB) AS ELP_freiLB,
			SUM(ELP_reserviert) AS ELP_reserviert,
			MAX(FAkomplAm) AS FAkomplAm,
			MAX(ArtikelCode) AS ArtikelCode,
			SUM(Lastschrift_EUR) AS Lastschrift_EUR,
			SUM(LastschriftNebenkosten_EUR) AS LastschriftNebenkosten_EUR,
			SUM(LastschriftSonstiges_EUR) AS LastschriftSonstiges_EUR,
			SUM(LastschriftRest_EUR) AS LastschriftRest_EUR,
			SUM(SonstigeLastschrift_EUR) AS SonstigeLastschrift_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Einkauf (BM, CU, PP, PCB, Masslam)
			SUM(NKEinkauf_EUR) AS NKEinkauf_EUR,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Gutschriften
			SUM(Gutschrift_EUR) AS Gutschrift_EUR,
			SUM(GutschriftNebenkosten_EUR) AS GutschriftNebenkosten_EUR,		
			SUM(GutschriftMenge) AS GutschriftMenge,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Provision
			MAX(ProvisionVerteter) AS ProvisionVerteter,
			SUM(VerkaufProvision_EUR) AS VerkaufProvision_EUR,
			SUM(GutschriftProvision_EUR) AS GutschriftProvision_EUR,
			AVG(ProvisionVerteterProzent) AS ProvisionVerteterProzent,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Produktion
			SUM(Aufgelegt) AS Aufgelegt,
			SUM(Ausschuss) AS Ausschuss,
			SUM(Produziert) AS Produziert,
			AVG(Ausschuss_Proz) AS Ausschuss_Proz,
			SUM(LPKonsi) AS LPKonsi,
			SUM(LPKonsi_EUR)  AS LPKonsi_EUR,
			SUM(Durch_VK_dm2) AS Durch_VK_dm2,
			------------------------------------------------------------------------
			------------------------------------------------------------------------

			------------------------------------------------------------------------
			--Verkauf
			SUM(LMenge) AS LMenge,
			SUM(NKVerkauf_EUR) AS NKVerkauf_EUR,
			SUM(RabattVerkauf_EUR) AS RabattVerkauf_EUR,
			SUM(EZVerkauf_EUR) AS EZVerkauf_EUR,
			SUM(VersandVerkauf_EUR) AS VersandVerkauf_EUR,
			SUM(FA_Umsatz) AS FA_Umsatz,
			SUM(Frachtkosten_EUR) AS Frachtkosten_EUR,
			SUM(GesamtVerkaufsmenge) AS GesamtVerkaufsmenge,
			SUM(Vorlageprovision_EUR) AS Vorlageprovision_EUR
		FROM
		(
			SELECT
				Kunde,
				LP,
				--MAX(AnzKommissionen) AS AnzKommissionen,
				--MAX(Kommission) AS Kommission,
				COUNT(FA) AS AnzFA,
				PC,
				MAX(ELP_gesend_gewDP) AS ELP_gesend_gewDP,
				SUM(FA_Umsatz) AS FA_Umsatz,
				SUM(LB_in_EUR) AS LB_in_EUR,
				SUM(EKHandelNasslamFA) AS EKHandelNasslamFA_EUR,
				SUM(Matko_EK_HauptFA) AS Matko_EK_EUR,
				SUM(Matko_EK_IL) AS Matko_EK_IL_EUR,
				SUM(Matko_GK_SO) AS Matko_GK_SO_EUR,
				SUM(Matko_GK_SO_IL) AS Matko_GK_SO_IL_EUR,
				SUM(Matko_GK_HauptFA) AS Matko_GK,
				SUM(Matko_GK_IL) AS Matko_GK_IL,
				SUM(Matko_So_HauptFA) AS Matko_So,
				SUM(Matko_So_IL) AS Matko_So_IL,
				SUM(Fremd_EK_HauptFA) AS Fremd_EK_EUR,
				--SUM(Pers_etc) AS Pers_etc_EUR,
				--SUM(Kosten_Uml) AS Kosten_Uml_EUR,
				SUM(Pers_var_HauptFA)+SUM(Pers_var_IL) AS Pers_var_EUR,
				SUM(Pers_fix_HauptFA)+SUM(Pers_fix_IL) AS Pers_fix_EUR,
				SUM(Ekosten_var_HauptFA)+SUM(Ekosten_var_IL) AS Ekosten_var_EUR,
				SUM(Ekosten_fix_HauptFA)+SUM(Ekosten_fix_IL) AS Ekosten_fix_EUR,
				SUM(Leasing_var_HauptFA)+SUM(Leasing_var_IL) AS Leasing_var_EUR,
				SUM(Leasing_fix_HauptFA)+SUM(Leasing_fix_IL) AS Leasing_fix_EUR,
				SUM(Inst_var_HauptFA)+SUM(Inst_var_IL) AS Inst_var_EUR,
				SUM(Inst_fix_HauptFA)+SUM(Inst_fix_IL) AS Inst_fix_EUR,
				SUM(Sokosten_var_HauptFA)+SUM(Sokosten_var_IL) AS Sokosten_var_EUR,
				SUM(Sokosten_fix_HauptFA)+SUM(Sokosten_fix_IL) AS Sokosten_fix_EUR,
				SUM(Vorlageprovision) AS Vorlageprovision_EUR,
				(
					SUM(Pers_var_HauptFA) + SUM(Pers_fix_HauptFA) + SUM(Pers_var_IL) + SUM(Pers_fix_IL) 
					+ 
					SUM(Ekosten_var_HauptFA) + SUM(Ekosten_fix_HauptFA) + SUM(Ekosten_var_IL) + SUM(Ekosten_fix_IL) 
					+ 
					SUM(Leasing_var_HauptFA) + SUM(Leasing_fix_HauptFA) + SUM(Leasing_var_IL) + SUM(Leasing_fix_IL) 
					+ 
					SUM(Inst_var_HauptFA) + SUM(Inst_fix_HauptFA) + SUM(Inst_var_IL) + SUM(Inst_fix_IL) 
					+ 
					SUM(Sokosten_var_HauptFA) + SUM(Sokosten_fix_HauptFA) + SUM(Sokosten_var_IL) + SUM(Sokosten_fix_IL) 
				) AS AlleKostenarten_EUR,
				(
					SUM(Pers_var_HauptFA) + SUM(Pers_var_IL) 
					+ 
					SUM(Ekosten_var_HauptFA) + SUM(Ekosten_var_IL) 
					+ 
					SUM(Leasing_var_HauptFA) + SUM(Leasing_var_IL) 
					+ 
					SUM(Inst_var_HauptFA) + SUM(Inst_var_IL) 
					+ 
					SUM(Sokosten_var_HauptFA) + SUM(Sokosten_var_IL) 
				) AS AlleKostenarten_var_EUR,
				(
					SUM(Pers_fix_HauptFA) + SUM(Pers_fix_IL) 
					+ 
					SUM(Ekosten_fix_HauptFA) + SUM(Ekosten_fix_IL) 
					+ 
					SUM(Leasing_fix_HauptFA) + SUM(Leasing_fix_IL) 
					+ 
					SUM(Inst_fix_HauptFA) + SUM(Inst_fix_IL) 
					+ 
					SUM(Sokosten_fix_HauptFA) + SUM(Sokosten_fix_IL) 
				) AS AlleKostenarten_fix_EUR,
				SUM(FA_freiLB) AS ELP_freiLB,
				SUM(FA_reserviert) AS ELP_reserviert,
				MAX(FAkomplAm) AS FAkomplAm,
				MAX(ArtikelCode) AS ArtikelCode,

				------------------------------------------------------------------------
				--Lastschriften
				ISNULL((
						SELECT TOP 1
							SUM(Lastschriften) 
							+
							ISNULL((SELECT TOP 1 LSBetrag FROM @tblLSPC AS tblLSPC WHERE LS COLLATE SQL_Latin1_General_CP1_CI_AS = LTRIM(RTRIM(LP))), 0)
							AS Lastschrift_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0132.RKEY, 
								((dbo.DATA0132.AMOUNT - dbo.DATA0132.STATE_TAX) / dbo.DATA0132.EX_RATE) AS Lastschriften
								--(dbo.DATA0132.AMOUNT / dbo.DATA0132.EX_RATE) AS Lastschriften

							FROM         dbo.DATA0132 INNER JOIN
										dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
										dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
										dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

							WHERE      
										--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
										REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriften						
				), 0) AS Lastschrift_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(NK) AS LastschriftNK_EUR
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0132.RKEY,
								dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS NK
							FROM         dbo.DATA0199 INNER JOIN
													dbo.DATA0212 INNER JOIN
													dbo.DATA0132 INNER JOIN
													dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
													dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
													dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
													dbo.DATA0071 INNER JOIN
													dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
							WHERE     
										--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
										REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
										AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Nebenkosten Handel')
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriftenNebenkosten					
				), 0) AS LastschriftNebenkosten_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(Sonstiges) AS LastschriftSonstiges_EUR
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0132.RKEY,
								dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Sonstiges
							FROM         dbo.DATA0199 INNER JOIN
													dbo.DATA0212 INNER JOIN
													dbo.DATA0132 INNER JOIN
													dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
													dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
													dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
													dbo.DATA0071 INNER JOIN
													dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
							WHERE     
										--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
										REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
										AND (dbo.DATA0199.MISC_CHARGE_CATEGORY = 'Sonstiges')
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriftenSonstiges					
				), 0) AS LastschriftSonstiges_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(Rest) AS LastschriftRest_EUR
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0132.RKEY,
								dbo.DATA0212.AMOUNT/dbo.DATA0132.EX_RATE AS Rest
							FROM         dbo.DATA0199 INNER JOIN
													dbo.DATA0212 INNER JOIN
													dbo.DATA0132 INNER JOIN
													dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY ON dbo.DATA0212.DEBIT_PTR = dbo.DATA0132.RKEY ON 
													dbo.DATA0199.RKEY = dbo.DATA0212.MISC_CHARGE_PTR INNER JOIN
													dbo.DATA0108 ON dbo.DATA0107.RKEY = dbo.DATA0108.DATA0107_PTR INNER JOIN
													dbo.DATA0071 INNER JOIN
													dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY ON dbo.DATA0108.DATA0071_PTR = dbo.DATA0071.RKEY
							WHERE     
										--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
										REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
										AND dbo.DATA0199.MISC_CHARGE_CATEGORY NOT IN ('Sonstiges', 'Nebenkosten Handel')
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblLastschriftenRest						
				), 0) AS LastschriftRest_EUR,
				ISNULL((
						SELECT TOP 1
							SUM(NKLastschriften) AS NKLastschrift_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0132.RKEY, 
								(dbo.DATA0132.MISC_TOT / dbo.DATA0132.EX_RATE) AS NKLastschriften

							FROM         dbo.DATA0132 INNER JOIN
										dbo.DATA0107 ON dbo.DATA0132.SRCE_PTR = dbo.DATA0107.RKEY INNER JOIN
										dbo.DATA0070 ON dbo.DATA0107.PO_PTR = dbo.DATA0070.RKEY INNER JOIN
										dbo.DATA0071 ON dbo.DATA0070.RKEY = dbo.DATA0071.PO_PTR INNER JOIN
										dbo.DATA0017 ON dbo.DATA0071.INVT_PTR = dbo.DATA0017.RKEY

							WHERE      
										--RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE RTRIM(LP) + '%'
										--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
										REPLACE(RTRIM(REPLACE(dbo.DATA0017.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
										AND (dbo.DATA0132.MEMO_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0132.MEMO_DATE <= CONVERT(DATETIME, @para7, 103))
										--AND dbo.DATA0132.MEMO_TP=1
										AND dbo.DATA0132.MEMO_TP IN (1, 6)
						) AS tblNKLastschriften						
				), 0) AS SonstigeLastschrift_EUR,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Einkauf (BM, CU, PP, PCB, Masslam)
				ISNULL(( 
					SELECT
						SUM(NK) AS NKEinkauf
					FROM
					(
						SELECT DISTINCT 
							D107_.RKEY,
							(D107_.SHIPPING + D107_.MISC_TOT) / D107_.EX_RATE  AS NK
						FROM         dbo.DATA0070 AS D70_ INNER JOIN
											dbo.DATA0071 AS D71_ ON D70_.RKEY = D71_.PO_PTR INNER JOIN
											dbo.DATA0108 AS D108_ ON D71_.RKEY = D108_.DATA0071_PTR INNER JOIN
											dbo.DATA0107 AS D107_ ON D108_.DATA0107_PTR = D107_.RKEY INNER JOIN
											dbo.DATA0017 AS D17_ ON D71_.INVT_PTR = D17_.RKEY
						WHERE
							--RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')) COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
							--27.02.2017 / Dsi : Masslams müssen auch berücksichtigt werden!
							REPLACE(RTRIM(REPLACE(D17_.INV_PART_NUMBER, 'HD', '')), 'MS', '') COLLATE SQL_Latin1_General_CP1_CI_AS LIKE LTRIM(RTRIM(LP)) + '%'
							AND (D107_.INV_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (D107_.INV_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblNKEinkauf_
				), 0) AS NKEinkauf_EUR,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Gutschriften
				/*
				ISNULL((
					SELECT
						SUM(Gutschrift) AS Gutschrift_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0116.RKEY,
							(dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE AS Gutschrift
						FROM         dbo.DATA0060 INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
											  dbo.DATA0116 INNER JOIN
											  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschrift	
				), 0) AS Gutschrift_EUR,	
				*/
				ISNULL((
					SELECT
						SUM(BetragNetto) AS Gutschrift_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0116.RKEY,
							dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY) AS BetragNetto
						FROM         dbo.DATA0116 INNER JOIN
								  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
								  dbo.DATA0060 INNER JOIN
								  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschrift	
				), 0) AS Gutschrift_EUR,
				ISNULL((
					SELECT
						SUM(GSNK) AS GutschriftNK_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0116.RKEY,
							(
								((dbo.DATA0116.CREDIT_AMOUNT - dbo.DATA0116.STATE_TAX) / dbo.DATA0116.EX_RATE)
								-
								(dbo.DATA0116.PART_PRICE / dbo.DATA0116.EX_RATE * (dbo.DATA0116.QUANTITY + dbo.DATA0116.OVERSHIP_QTY)) 
							) AS GSNK
						FROM         dbo.DATA0116 INNER JOIN
								  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
								  dbo.DATA0060 INNER JOIN
								  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftNK
				), 0) AS GutschriftNebenkosten_EUR,		
				ISNULL((
					SELECT
						SUM(RMenge) AS GutschriftMenge
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0098.RKEY,
							dbo.DATA0098.QTY_AUTH AS RMenge
						FROM         
							dbo.DATA0098 
						WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
								AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftMenge
				), 0) AS GutschriftMenge,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Provision
				ISNULL((
					SELECT TOP 1
						dbo.DATA0009.SALES_REP_NAME
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
											dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
											dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
											dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
					WHERE
						dbo.DATA0050.RKEY = MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
				), '') AS ProvisionVerteter,
				SUM(FA_Umsatz_VertProvision) AS VerkaufProvision_EUR,
				ISNULL((
					SELECT
						SUM(Provision) AS GutschriftNK_EUR
					FROM
					(
						SELECT DISTINCT 
							dbo.DATA0116.RKEY,
							ISNULL(dbo.DATA0509.COMMISSION_DEBITED / dbo.DATA0509.EXCHANGE_RATE, 0) AS Provision
						FROM         dbo.DATA0125 INNER JOIN
											  dbo.DATA0509 ON dbo.DATA0125.DATA0509_PTR = dbo.DATA0509.RKEY RIGHT OUTER JOIN
											  dbo.DATA0116 INNER JOIN
											  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY INNER JOIN
											  dbo.DATA0060 INNER JOIN
											  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY ON dbo.DATA0112.SALES_ORDER_PTR = dbo.DATA0060.RKEY ON 
											  dbo.DATA0125.MEMO_PTR = dbo.DATA0116.RKEY LEFT OUTER JOIN
											  dbo.DATA0508 INNER JOIN
											  dbo.DATA0061 ON dbo.DATA0508.DATA0061_PTR = dbo.DATA0061.RKEY INNER JOIN
											  dbo.DATA0124 ON dbo.DATA0508.RKEY = dbo.DATA0124.DATA0508_PTR ON dbo.DATA0116.RKEY = dbo.DATA0124.MEMO_PTR
						WHERE     (dbo.DATA0050.RKEY = MAX(D50_PTR))
								AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblGutschriftNK
				), 0) AS GutschriftProvision_EUR,
				ISNULL((
					SELECT TOP 1
						dbo.DATA0009.COMMISSION_1
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
											dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
											dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
											dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
											dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
											dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
											dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR INNER JOIN
											dbo.DATA0009 ON dbo.DATA0509.DATA0009_PTR = dbo.DATA0009.RKEY
					WHERE
						dbo.DATA0050.RKEY = MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					ORDER BY dbo.DATA0006.ACT_COMPL_DATE DESC
				), 0)/100 AS ProvisionVerteterProzent,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Produktion
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_SCH) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_SCH
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAufgelegt
				), 0) AS Aufgelegt,
				ISNULL((
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_REJ) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_REJ 
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) <> 'R'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblAusschuss
					), 0)
					+
					ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
						SELECT
							SUM(RMenge) AS GutschriftMenge
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0098.RKEY,
								dbo.DATA0098.QTY_AUTH AS RMenge
							FROM         
								dbo.DATA0098 
							WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
									AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblGutschriftMenge
					), 0)
					-
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_PROD) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_PROD
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblProduziert
					), 0)
				), 0) AS Ausschuss,
				ISNULL((
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_PROD) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_PROD
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) NOT IN ('R', 'W')
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblProduziert
					), 0)
					-
					ISNULL(( --Reklamationsmenge => Es werden nicht immer R-Aufträge erstellt, deswegen ist es sicherer so
						SELECT
							SUM(RMenge) AS GutschriftMenge
						FROM
						(
							SELECT DISTINCT 
								dbo.DATA0098.RKEY,
								dbo.DATA0098.QTY_AUTH AS RMenge
							FROM         
								dbo.DATA0098 
							WHERE   (dbo.DATA0098.CUSTOMER_PART_PTR = MAX(D50_PTR))
									AND (dbo.DATA0098.RMA_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0098.RMA_DATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblGutschriftMenge
					), 0)
					-
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_REJ) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_REJ
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='W'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblAusschuss_R
					), 0)
					+
					ISNULL((
						SELECT TOP 1
							SUM(QUAN_PROD) AS RES
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0006.RKEY, 
								dbo.DATA0006.QUAN_PROD
							FROM         dbo.DATA0006 --INNER JOIN
													--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
							WHERE 
								dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
								AND dbo.DATA0006.ROOT_PTR=0
								AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								AND LEFT(dbo.DATA0006.WORK_ORDER_NUMBER, 1) ='R'
								AND dbo.DATA0006.PROD_STATUS=5
						) AS tblProduziert
					), 0)
				), 0) AS Produziert,
				ISNULL((
					SELECT TOP 1
						SUM(QUAN_REJ)/SUM(QUAN_SCH) AS RES
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0006.RKEY, 
							dbo.DATA0006.QUAN_REJ,
							dbo.DATA0006.QUAN_SCH
						FROM         dbo.DATA0006 --INNER JOIN
												--dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												--dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												--dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND dbo.DATA0006.ROOT_PTR=0
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							AND dbo.DATA0006.PROD_STATUS=5
					) AS tblAusschuss
				), 0) AS Ausschuss_Proz,
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND) AS LPKonsi_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND
							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				), 0) AS LPKonsi,
				/*
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND) AS LPKonsi_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND
							FROM         dbo.DATA0006 INNER JOIN
													dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				), 0) * MAX(ELP_gesend_gewDP)  AS LPKonsi_EUR,
				*/
				ISNULL((
						SELECT
							SUM(QTY_ON_HAND*LAST_SO_PRICE) AS LPKonsi_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0053.RKEY, 
								dbo.DATA0053.QTY_ON_HAND,
								dbo.DATA0050.LAST_SO_PRICE
							--FROM         dbo.DATA0006 INNER JOIN
							--						dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR
							FROM         dbo.DATA0006 INNER JOIN
												  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0006.CUST_PART_PTR = dbo.DATA0050.RKEY
							WHERE     
									dbo.DATA0006.CUST_PART_PTR = MAX(D50_PTR) AND dbo.DATA0053.LOC_PTR = 225
						) AS tblNLPKonsiMenge
				--), 0) * MAX(ELP_gesend_gewDP)  AS LPKonsi_EUR,
				), 0)  AS LPKonsi_EUR,
				ISNULL((
					SELECT TOP 1
						SUM(gesendet_FA * KNX * KNY / ELP_KN / 10000) AS RES
					FROM
					(
						SELECT 
							dbo.ARTIKELDATEN.*,
							dbo.DATA0050.RKEY AS D0050_PTR,
							CASE 
								WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
									ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
									* 
									dbo.DATA0060.EXCH_RATE 
								ELSE
									dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
							END AS ELP_Preis_EUR,
							dbo.DATA0052.QUAN_SHP AS gesendet_FA

						FROM         dbo.DATA0006 INNER JOIN
												dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
												dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
												dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
												dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
												dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
												dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE
							(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblFAUmsatz
					WHERE D0050_PTR = MAX(D50_PTR) 
				), 0) AS Durch_VK_dm2,
				------------------------------------------------------------------------
				------------------------------------------------------------------------

				------------------------------------------------------------------------
				--Verkauf
				ISNULL((
					SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
					FROM         dbo.DATA0006 INNER JOIN
											dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
											dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
											dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
					WHERE 
						dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
						AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
						AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
				), 0) AS LMenge,
				ISNULL((
					SELECT
						SUM(NK) AS NKVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.TOOLING_CHARGES AS NK
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblNKVerkauf
				), 0) AS NKVerkauf_EUR,
				ISNULL((
					SELECT
						SUM(Rabatt) AS RabattVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.DISCOUNT_AMOUNT AS Rabatt
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblRabattVerkauf
				), 0) AS RabattVerkauf_EUR,
				ISNULL((
					SELECT
						SUM(Einzuschlag) AS EZVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.RUSH_CHARGE_AMOUNT AS Einzuschlag
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblEZVerkauf
				), 0) AS EZVerkauf_EUR,
				ISNULL((
					SELECT
						SUM(Versandkosten) AS VersandVerkauf
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0112.RKEY,
							dbo.DATA0112.SHIPPING_CHARGES AS Versandkosten
						FROM         dbo.DATA0060 INNER JOIN
							dbo.DATA0112 ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
						WHERE 
							CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0112.INVOICE_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0112.INVOICE_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblVersandVerkauf
				), 0) AS VersandVerkauf_EUR,

				(
					SUM(FA_Umsatz)
					-
					ISNULL((
						SELECT TOP 1 
							SUM(Gutschrift) AS Gutschrift_EUR
						FROM
						(
							SELECT DISTINCT
								dbo.DATA0116.RKEY,
								dbo.DATA0116.CREDIT_AMOUNT/dbo.DATA0116.EX_RATE - dbo.DATA0116.STATE_TAX AS Gutschrift
							FROM         dbo.DATA0060 INNER JOIN
												  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY LEFT OUTER JOIN
												  dbo.DATA0116 INNER JOIN
												  dbo.DATA0112 ON dbo.DATA0116.INV_PTR = dbo.DATA0112.RKEY ON dbo.DATA0060.RKEY = dbo.DATA0112.SALES_ORDER_PTR
							WHERE     (dbo.DATA0060.CUST_PART_PTR = MAX(D50_PTR))
									AND (dbo.DATA0116.TDATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0116.TDATE <= CONVERT(DATETIME, @para7, 103))
						) AS tblGutschrift	
					), 0)
				) AS FA_Umsatz_ohneGutschrift,
				ISNULL((
					SELECT TOP 1
						--SUM(FK) AS FK1,
						SUM(FK/CASE WHEN PlusZeichen_1=0 THEN 1 ELSE CASE WHEN PlusZeichen_1>0 AND PlusZeichen_2=0 THEN 2 ELSE 3 END END) AS FK_EUR
					FROM
					(
						SELECT DISTINCT
							dbo.DATA0072.RKEY,
							dbo.DATA0072.DESCRIPTION2 AS LP,
							(dbo.DATA0072.UNIT_PRICE/dbo.DATA0070.EXCHANGE_RATE * dbo.DATA0072.QUAN_ORD) AS FK,
							CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 1) AS PlusZeichen_1,
							CHARINDEX('+', dbo.DATA0072.DESCRIPTION2, 21) AS PlusZeichen_2
						FROM         dbo.DATA0070 INNER JOIN
											  dbo.DATA0072 ON dbo.DATA0070.RKEY = dbo.DATA0072.POPTR
						WHERE
							LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION, '')), 3) = 'FK '
							AND LEFT(LTRIM(ISNULL(dbo.DATA0072.DESCRIPTION2, '')), 3) = 'LP '
							AND dbo.DATA0072.DESCRIPTION2 COLLATE SQL_Latin1_General_CP1_CI_AS LIKE '%' + LTRIM(RTRIM(LP)) + '%' 
							AND (dbo.DATA0070.PO_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0070.PO_DATE <= CONVERT(DATETIME, @para7, 103))
					) AS tblFK
				), 0) AS Frachtkosten_EUR,
				ISNULL((
					ISNULL(SUM(FA_reserviert), 0)
					+
					ISNULL((
						SELECT TOP 1 SUM(dbo.DATA0052.QUAN_SHP) AS LMenge
						FROM         dbo.DATA0006 INNER JOIN
												dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
												dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
												dbo.ARTIKELDATEN ON dbo.DATA0006.CUST_PART_PTR = dbo.ARTIKELDATEN.CUST_PART_PTR
						WHERE 
							dbo.DATA0006.CUST_PART_PTR=MAX(D50_PTR)
							AND (dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
							AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
					), 0) 
				), 0) AS GesamtVerkaufsmenge
				------------------------------------------------------------------------
				------------------------------------------------------------------------

			FROM
			(
				SELECT
					tblDaten.*
					--CAST(ELP_gesend_gewDP*FA_reserviert AS FLOAT) AS LB_in_EUR
				FROM
				(
					SELECT
						tblNachKalk_Daten.Kunde,
						tblNachKalk_Daten.Aufbereitung,
						tblNachKalk_Daten.LP,
						tblNachKalk_Daten.D50_PTR,
						tblNachKalk_Daten.D60_PTR,
						CASE
							WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)='1' THEN 
								'Intern'
							ELSE
								CASE
									WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)='2' THEN 
										'Masslam'
									ELSE
										CASE
											WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten.LP), 3), 1)='3' THEN 
												'Handel'
											ELSE
												'unbekannt'
										END
								END
						END AS InternMasslamHandel,
						tblNachKalk_Daten.PC,
						--tblNachKalk_Daten.AnzKommissionen,
						--tblNachKalk_Daten.Kommission,
						tblNachKalk_Daten.FA,
						ISNULL((
							ISNULL((
								SELECT TOP 1
									SUM(RES) AS umsatz
								FROM
								(
									SELECT 
										dbo.DATA0006.RKEY AS D0006_PTR,
										(
											CASE 
												WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
													ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
													/ 
													dbo.DATA0060.EXCH_RATE 
												ELSE
													dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
											END --ELP_Preis_EUR
											*
											dbo.DATA0052.QUAN_SHP --AS gesendet_FA
										) AS RES
									FROM         dbo.DATA0006 INNER JOIN
														  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
														  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
														  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
														  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
														  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
														  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
														  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
														  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
									WHERE
										(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
										AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
								) AS tblFAUmsatz
								WHERE 
									D0006_PTR = D6_PTR 
									--D0006_PTR = CASE WHEN LEFT(tblNachKalk_Daten.FA, 1)='S' THEN tblNachKalk_Daten.D6S_PTR ELSE tblNachKalk_Daten.D6_PTR END
							), 0)
						), 0) AS FA_Umsatz,
						ISNULL((
							SELECT TOP 1
								SUM(RES) AS umsatzProv
							FROM
							(
								SELECT 
									dbo.DATA0006.RKEY AS D0006_PTR,
									(
										CASE 
											WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
												ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
												/ 
												dbo.DATA0060.EXCH_RATE 
											ELSE
												dbo.DATA0060.PART_PRICE / dbo.DATA0060.EXCH_RATE 
										END --ELP_Preis_EUR
										*
										dbo.DATA0052.QUAN_SHP --AS gesendet_FA
										*
										(dbo.DATA0509.SALES_COMMISSION_PER/100)
									) AS RES
								FROM         dbo.DATA0006 INNER JOIN
													  dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
													  dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
													  dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
													  dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
													  dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
													  dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
													  dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
													  dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR INNER JOIN
													  dbo.DATA0507 ON dbo.DATA0064.RKEY = dbo.DATA0507.DATA0064_PTR INNER JOIN
													  dbo.DATA0509 ON dbo.DATA0507.RKEY = dbo.DATA0509.DATA0507_PTR
								WHERE
									(dbo.DATA0006.ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
									AND (dbo.DATA0006.ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							) AS tblFAUmsatzProv
							WHERE D0006_PTR = D6_PTR 
						), 0) AS FA_Umsatz_VertProvision,
						tblNachKalk_Daten.EK_Handel_Masslam_HauptFA AS EKHandelNasslamFA,
						tblNachKalk_Daten.Matko_EK_HauptFA,
						tblNachKalk_Daten.Matko_EK_IL,
						tblNachKalk_Daten.Matko_GK_HauptFA + tblNachKalk_Daten.Matko_So_HauptFA AS Matko_GK_SO,
						tblNachKalk_Daten.Matko_GK_IL + tblNachKalk_Daten.Matko_So_IL AS Matko_GK_SO_IL,
						tblNachKalk_Daten.Matko_GK_HauptFA,
						tblNachKalk_Daten.Matko_GK_IL,
						tblNachKalk_Daten.Matko_So_HauptFA,
						tblNachKalk_Daten.Matko_So_IL,
						tblNachKalk_Daten.Fremd_EK_HauptFA,
						--tblNachKalk_Daten.Pers_etc,
						--tblNachKalk_Daten.Kosten_Uml,
						ISNULL((SELECT TOP 1 QTY_ALLOC AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_reserviert,
						ISNULL((
								SELECT TOP 1
									SUM(RES) AS LBEur
								FROM
								(
									SELECT DISTINCT
										dbo.DATA0053.RKEY,
										(dbo.DATA0060.PART_PRICE/dbo.DATA0060.EXCH_RATE*dbo.DATA0053.QTY_ALLOC) AS RES
										--SUM(dbo.DATA0053.QTY_ALLOC) AS RES
									FROM         dbo.DATA0060 INNER JOIN
														  dbo.DATA0063 ON dbo.DATA0060.RKEY = dbo.DATA0063.SO_PTR INNER JOIN
														  dbo.DATA0053 ON dbo.DATA0063.PART_BATCH_PTR = dbo.DATA0053.RKEY
									WHERE dbo.DATA0053.WORK_ORDER_PTR = D6_PTR 
								) AS tblLBEur
						), 0) AS LB_in_EUR,
						ISNULL((SELECT TOP 1 (QTY_ON_HAND - QTY_ALLOC) AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_freiLB,
						--tblNachKalk_Daten.Aus_in_Proz,
						ISNULL((
							SELECT TOP 1
								SUM(ELP_Preis_EUR*gesendet_FA)/SUM(gesendet_FA) AS umsatz
							FROM
							(
								SELECT DISTINCT
									dbo.DATA0006.ACT_COMPL_DATE,
									dbo.DATA0050.RKEY AS D0050_PTR,
									--dbo.DATA0006.RKEY AS D0006_PTR,
									CASE 
										WHEN ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)>0 THEN
											ISNULL((SELECT TOP 1 dbo.DATA0507.UNIT_PRICE FROM dbo.DATA0507 WHERE dbo.DATA0507.DATA0060_PTR = dbo.DATA0060.RKEY), 0)
											* 
											dbo.DATA0060.EXCH_RATE 
										ELSE
											dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE 
									END AS ELP_Preis_EUR,
									dbo.DATA0052.QUAN_SHP AS gesendet_FA

								FROM         dbo.DATA0006 INNER JOIN
														dbo.DATA0053 ON dbo.DATA0006.RKEY = dbo.DATA0053.WORK_ORDER_PTR INNER JOIN
														dbo.DATA0052 ON dbo.DATA0053.RKEY = dbo.DATA0052.DATA0053_PTR INNER JOIN
														dbo.DATA0064 ON dbo.DATA0052.SO_SHP_PTR = dbo.DATA0064.RKEY INNER JOIN
														dbo.DATA0060 ON dbo.DATA0064.SO_PTR = dbo.DATA0060.RKEY INNER JOIN
														dbo.DATA0010 ON dbo.DATA0060.CUSTOMER_PTR = dbo.DATA0010.RKEY INNER JOIN
														dbo.DATA0050 ON dbo.DATA0060.CUST_PART_PTR = dbo.DATA0050.RKEY INNER JOIN
														dbo.DATA0008 ON dbo.DATA0050.PROD_CODE_PTR = dbo.DATA0008.RKEY INNER JOIN
														dbo.ARTIKELDATEN ON dbo.DATA0050.RKEY = dbo.ARTIKELDATEN.CUST_PART_PTR
							) AS tblFAUmsatz
							WHERE 
								D0050_PTR = tblNachKalk_Daten.D50_PTR
								AND (ACT_COMPL_DATE >= CONVERT(DATETIME, @para6, 103))
								AND (ACT_COMPL_DATE <= CONVERT(DATETIME, @para7, 103))
							--WHERE D0006_PTR = D6_PTR 
						), 
							(
								SELECT TOP 1 (dbo.DATA0060.PART_PRICE * dbo.DATA0060.EXCH_RATE) AS RES 
								FROM dbo.DATA0054 INNER JOIN  dbo.DATA0060 ON dbo.DATA0054.SO_PTR = dbo.DATA0060.RKEY 
								WHERE dbo.DATA0060.CUST_PART_PTR = tblNachKalk_Daten.D50_PTR
							)
						) AS ELP_gesend_gewDP,
						tblNachKalk_Daten.FAkomplAm,
						tblNachKalk_Daten.ArtikelCode,
						tblNachKalk_Daten.Pers_var_HauptFA,
						tblNachKalk_Daten.Pers_fix_HauptFA,
						tblNachKalk_Daten.Ekosten_var_HauptFA,
						tblNachKalk_Daten.Ekosten_fix_HauptFA,
						tblNachKalk_Daten.Leasing_var_HauptFA,
						tblNachKalk_Daten.Leasing_fix_HauptFA,
						tblNachKalk_Daten.Inst_var_HauptFA,
						tblNachKalk_Daten.Inst_fix_HauptFA,
						tblNachKalk_Daten.Sokosten_var_HauptFA,
						tblNachKalk_Daten.Sokosten_fix_HauptFA,
						tblNachKalk_Daten.Pers_var_IL,
						tblNachKalk_Daten.Pers_fix_IL,
						tblNachKalk_Daten.Ekosten_var_IL,
						tblNachKalk_Daten.Ekosten_fix_IL,
						tblNachKalk_Daten.Leasing_var_IL,
						tblNachKalk_Daten.Leasing_fix_IL,
						tblNachKalk_Daten.Inst_var_IL,
						tblNachKalk_Daten.Inst_fix_IL,
						tblNachKalk_Daten.Sokosten_var_IL,
						tblNachKalk_Daten.Sokosten_fix_IL,
						--PC
						ISNULL(Vorlageprovision, 0) AS Vorlageprovision

					FROM
						LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten
					WHERE 
						tblNachKalk_Daten.FAkomplAm >= CONVERT(DATETIME, @para6, 103)
						AND tblNachKalk_Daten.FAkomplAm <= CONVERT(DATETIME, @para7, 103)
						AND tblNachKalk_Daten.Aufbereitung = @para1
						AND tblNachKalk_Daten.D10_PTR IN (SELECT D10_PTR FROM @tblD10PC)
						AND tblNachKalk_Daten.D50_PTR IN (SELECT D50_PTR FROM @tblD50PC)
						AND tblNachKalk_Daten.D8_PTR IN (SELECT D8_PTR FROM @tblD8PC)
				) AS tblDaten
			) AS tblDatenGrp 
			WHERE 
				InternMasslamHandel IN (ISNULL(@para8, ''), ISNULL(@para9, ''), ISNULL(@para10, ''), ISNULL(@para12, ''))
			GROUP BY
				Kunde, 
				LP,
				PC
		) AS tblPCGrupp
		GROUP BY
			PC
	END

	IF @Case_ = 'NKFADetails'
	BEGIN
		/*
		DECLARE
			@para1 varchar(255),
			@para2 varchar(255),
			@para3 varchar(255),
			@para4 varchar(255),
			@para5 varchar(255),
			@para6 varchar(255),
			@para7 varchar(255),
			@para8 varchar(255),
			@para9 varchar(255),
			@para10 varchar(255)
		SET @para1 = 'AUTO'
		SET @para2 = '-1' --Kunde
		SET @para3 = '-1' --Kundenteil
		SET @para4 = '-1' --PC
		--SET @para5 = ''Intern', 'Masslam', 'Handel''
		SET @para6 = '01.01.2015'
		SET @para7 = '31.12.2016'
		SET @para8 = 'Intern'
		SET @para9 = 'Masslam'
		SET @para10 = 'Handel'
		*/

		--ECLARE 
		--	@InsertSQLLP varchar(1000)

		--Kunde
		--DECLARE @tblD10LP table(D10_PTR NUMERIC(10, 0))
		IF @para2<>'-1'
		BEGIN
			SET @InsertSQLLP = '
								--INSERT @tblD10(D10_PTR)
								SELECT DISTINCT
									D10_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
								WHERE
									tblNachKalk_Daten_2.D10_PTR IN (' + RTRIM(@para2) + ')
							'
							INSERT @tblD10LP(D10_PTR) EXECUTE(@InsertSQLLP)
		END
		ELSE
		BEGIN
			INSERT @tblD10LP(D10_PTR)
			SELECT DISTINCT
				D10_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
		END

		--Kundenteil
		--DECLARE @tblD50LP table(D50_PTR NUMERIC(10, 0))
		IF @para3<>'-1'
		BEGIN
			SET @InsertSQLLP = '
								--INSERT @tblD50(D50_PTR)
								SELECT DISTINCT
									D50_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
								WHERE
									tblNachKalk_Daten_2.D50_PTR IN (' + RTRIM(@para3) + ')
							'
							INSERT @tblD50LP(D50_PTR) EXECUTE(@InsertSQLLP)
		END
		ELSE
		BEGIN
			INSERT @tblD50LP(D50_PTR)
			SELECT DISTINCT
				D50_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
		END

		--PC
		--DECLARE @tblD8LP table(D8_PTR NUMERIC(10, 0))
		IF @para4<>'-1'
		BEGIN
			SET @InsertSQLLP = '
								--INSERT @tblD8(D8_PTR)
								SELECT DISTINCT
									D8_PTR
								FROM
									LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
								WHERE
									tblNachKalk_Daten_2.D8_PTR IN (' + RTRIM(@para4) + ')
							'
							INSERT @tblD8LP(D8_PTR) EXECUTE(@InsertSQLLP)
		END
		ELSE
		BEGIN
			INSERT @tblD8LP(D8_PTR)
			SELECT DISTINCT
				D8_PTR
			FROM
				LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
		END


		SELECT
			tblNKDaten.*
		FROM
		(
			SELECT
				CASE
					WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten_2.LP), 3), 1)='1' THEN 
						'Intern'
					ELSE
						CASE
							WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten_2.LP), 3), 1)='2' THEN 
								'Masslam'
							ELSE
								CASE
									WHEN LEFT(RIGHT(RTRIM(tblNachKalk_Daten_2.LP), 3), 1)='3' THEN 
										'Handel'
									ELSE
										'unbekannt'
								END
						END
				END AS InternMasslamHandel,
				ISNULL((SELECT TOP 1 QTY_ALLOC AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_reserviert,
				ISNULL((SELECT TOP 1 (QTY_ON_HAND - QTY_ALLOC) AS RES FROM dbo.DATA0053 WHERE WORK_ORDER_PTR = D6_PTR), 0) AS FA_freiLB,
				tblNachKalk_Daten_2.Kunde,
				tblNachKalk_Daten_2.LP,
				tblNachKalk_Daten_2.FA,
				tblNachKalk_Daten_2.PC,
				tblNachKalk_Daten_2.FAkomplAm,
				ISNULL(tblNachKalk_Daten_2.Herstellung_AnzMinuten, 0) AS Herstellung_AnzMinuten,
				tblNachKalk_Daten_2.FAUmsatz_amKmpltag,
				tblNachKalk_Daten_2.ExcelDatei_Link,
				ISNULL(tblNachKalk_Daten_2.EK_Handel_Masslam_HauptFA, 0) AS EK_Handel_Masslam_HauptFA,
				ISNULL(Matko_EK_HauptFA, 0)+ISNULL(Matko_EK_IL, 0) AS Matko_EK,
				ISNULL(Matko_GK_HauptFA, 0)+ISNULL(Matko_GK_IL, 0) AS Matko_GK,
				ISNULL(Matko_So_HauptFA, 0)+ISNULL(Matko_So_IL, 0) AS Matko_So,
				ISNULL(Pers_var_HauptFA, 0)+ISNULL(Pers_fix_HauptFA, 0)+ISNULL(Pers_var_IL, 0)+ISNULL(Pers_fix_IL, 0) AS PerKosten,
				ISNULL(Ekosten_var_HauptFA, 0)+ISNULL(Ekosten_fix_HauptFA, 0)+ISNULL(Ekosten_var_IL, 0)+ISNULL(Ekosten_fix_IL, 0) AS EKosten,
				ISNULL(Leasing_var_HauptFA, 0)+ISNULL(Leasing_fix_HauptFA, 0)+ISNULL(Leasing_var_IL, 0)+ISNULL(Leasing_fix_IL, 0) AS LeasingKosten,
				ISNULL(Inst_var_HauptFA, 0)+ISNULL(Inst_fix_HauptFA, 0)+ISNULL(Inst_var_IL, 0)+ISNULL(Inst_fix_IL, 0) AS InstKosten,
				ISNULL(Sokosten_var_HauptFA, 0)+ISNULL(Sokosten_fix_HauptFA, 0)+ISNULL(Sokosten_var_IL, 0)+ISNULL(Sokosten_fix_IL, 0) AS SonstKosten,
				ISNULL(tblNachKalk_Daten_2.Fremd_EK_HauptFA, 0) AS Fremd_EK_HauptFA,
				(
					ISNULL(tblNachKalk_Daten_2.EK_Handel_Masslam_HauptFA, 0)
					+ ISNULL(Matko_EK_HauptFA, 0)+ISNULL(Matko_EK_IL, 0)
					+ ISNULL(Matko_GK_HauptFA, 0)+ISNULL(Matko_GK_IL, 0) 
					+ ISNULL(Matko_So_HauptFA, 0)+ISNULL(Matko_So_IL, 0) 
					+ ISNULL(Pers_var_HauptFA, 0)+ISNULL(Pers_fix_HauptFA, 0)+ISNULL(Pers_var_IL, 0)+ISNULL(Pers_fix_IL, 0) 
					+ ISNULL(Ekosten_var_HauptFA, 0)+ISNULL(Ekosten_fix_HauptFA, 0)+ISNULL(Ekosten_var_IL, 0)+ISNULL(Ekosten_fix_IL, 0) 
					+ ISNULL(Leasing_var_HauptFA, 0)+ISNULL(Leasing_fix_HauptFA, 0)+ISNULL(Leasing_var_IL, 0)+ISNULL(Leasing_fix_IL, 0) 
					+ ISNULL(Inst_var_HauptFA, 0)+ISNULL(Inst_fix_HauptFA, 0)+ISNULL(Inst_var_IL, 0)+ISNULL(Inst_fix_IL, 0)
					+ ISNULL(Sokosten_var_HauptFA, 0)+ISNULL(Sokosten_fix_HauptFA, 0)+ISNULL(Sokosten_var_IL, 0)+ISNULL(Sokosten_fix_IL, 0) 
					+ ISNULL(tblNachKalk_Daten_2.Fremd_EK_HauptFA, 0) 
				) AS Herstellkosten,
				tblNachKalk_Daten_2.Ausschuss,
				tblNachKalk_Daten_2.Gutmenge_FA,
				tblNachKalk_Daten_2.Vorgabe_FA,
				tblNachKalk_Daten_2.ZuX,
				tblNachKalk_Daten_2.ZuY,
				tblNachKalk_Daten_2.Vorlageprovision

			FROM
				LIVE2.dbo.NachKalk_Daten_2 AS tblNachKalk_Daten_2
			WHERE 
				tblNachKalk_Daten_2.FAkomplAm >= CONVERT(DATETIME, @para6, 103)
				AND tblNachKalk_Daten_2.FAkomplAm <= CONVERT(DATETIME, @para7, 103)
				AND tblNachKalk_Daten_2.Aufbereitung = @para1
				AND tblNachKalk_Daten_2.D10_PTR IN (SELECT D10_PTR FROM @tblD10LP)
				AND tblNachKalk_Daten_2.D50_PTR IN (SELECT D50_PTR FROM @tblD50LP)
				AND tblNachKalk_Daten_2.D8_PTR IN (SELECT D8_PTR FROM @tblD8LP)
		) AS tblNKDaten
		WHERE 
			InternMasslamHandel IN (ISNULL(@para8, ''), ISNULL(@para9, ''), ISNULL(@para10, ''), ISNULL(@para12, ''))
	END

	IF @Case_ = 'Prozesskosten_FAKreuztabelle'
	BEGIN
		/*
		--DECLARE
		--@para1 varchar(250),
		--@para2 varchar(250)
		--SET @para1 = 'TEST DSI 06032017'
		--SET @para2 = '54329.100'

		DECLARE @cur_FA varchar(16)

		DECLARE Cursor_ADD_COL CURSOR fast_forward FOR (
															SELECT DISTINCT FA
															FROM LIVE2.dbo.tmpNachkalkProzesskosten WHERE Pool=@para1 AND LP=@para2
														)



		--Kreuztabelle erstellen
		--DROP TABLE #TMP_KreuzFA
		IF OBJECT_ID('tempdb..#TMP_KreuzFA') IS NOT NULL DROP TABLE #TMP_KreuzFA
		CREATE TABLE #TMP_KreuzFA (AG varchar(150))

		OPEN Cursor_ADD_COL
		FETCH NEXT FROM Cursor_ADD_COL INTO @cur_FA

		WHILE @@FETCH_STATUS = 0 
		BEGIN   
			-----------------------------------------------------------------------------------
			--FA als Spalten hinzufügen
			-----------------------------------------------------------------------------------
			DECLARE @SQL_AlterTable nvarchar(4000)

			--FA
			SET @SQL_AlterTable = 'ALTER TABLE #TMP_KreuzFA ADD [' + LTRIM(@cur_FA) + ' Arb-Zeit] varchar(16)'
			--PRINT @SQL_AlterTable
			EXEC sp_executesql @SQL_AlterTable

			--Anz ZU
			SET @SQL_AlterTable = 'ALTER TABLE #TMP_KreuzFA ADD [' + LTRIM(@cur_FA) + ' Anz-ZU] varchar(16)'
			--PRINT @SQL_AlterTable
			EXEC sp_executesql @SQL_AlterTable
					

			IF (SELECT COUNT(AG) AS RES FROM #TMP_KreuzFA)=0 
			BEGIN
				SET @SQL_AlterTable = '
										INSERT #TMP_KreuzFA(
															AG, 
															[' + LTRIM(@cur_FA) + ' Arb-Zeit],
															[' + LTRIM(@cur_FA) + ' Anz-ZU]
															)

										SELECT AG, SUM(B_Zeit_Min) AS RES_AnzMin, SUM(AnzAbgem_ELP_beiAG/ELP_je_ZU) AS RES_AnzZU
										FROM LIVE2.dbo.tmpNachkalkProzesskosten 
										WHERE Pool=''' + @para1 + ''' AND FA LIKE ''%' + RTRIM(LTRIM(@cur_FA)) + '%''
										GROUP BY AG
										ORDER BY AG
									'		
				EXEC sp_executesql @SQL_AlterTable	
			END
			ELSE
			BEGIN
				SET @SQL_AlterTable = '
										UPDATE #TMP_KreuzFA
										SET 
											#TMP_KreuzFA.[' + LTRIM(@cur_FA) + ' Arb-Zeit] = ISNULL(tblGrpFA.RES_AnzMin, 0),
											#TMP_KreuzFA.[' + LTRIM(@cur_FA) + ' Anz-ZU] = ISNULL(tblGrpFA.RES_AnzZU, 0)
										FROM
											(
												SELECT 
													AG AS AG_,
													SUM(B_Zeit_Min) AS RES_AnzMin,
													SUM(AnzAbgem_ELP_beiAG/ELP_je_ZU) AS RES_AnzZU
												FROM
													LIVE2.dbo.tmpNachkalkProzesskosten 
												WHERE 
													LIVE2.dbo.tmpNachkalkProzesskosten.Pool=''' + @para1 + ''' 
													AND 
													LIVE2.dbo.tmpNachkalkProzesskosten.FA LIKE ''%' + RTRIM(LTRIM(@cur_FA)) + '%''
												GROUP BY AG
											) AS tblGrpFA
										WHERE 
											#TMP_KreuzFA.AG = tblGrpFA.AG_
									'	
				EXEC sp_executesql @SQL_AlterTable	
			END
			

			FETCH NEXT FROM Cursor_ADD_COL INTO @cur_FA
		END

		CLOSE Cursor_ADD_COL
		DEALLOCATE Cursor_ADD_COL


		SELECT * FROM #TMP_KreuzFA
		*/


		--DECLARE
		--@para1 varchar(250),
		--@para2 varchar(250)
		--SET @para1 = 'DSI 52786.901'
		--SET @para2 = '52786.901'
		/*
		DECLARE @cur_FA varchar(16)

		DECLARE Cursor_ADD_COL CURSOR fast_forward FOR (
															SELECT DISTINCT FA
															FROM LIVE2.dbo.tmpNachkalkProzesskosten WHERE Pool=@para1 AND LP=@para2
														)



		--Kreuztabelle erstellen
		--DROP TABLE #TMP_KreuzFA
		IF OBJECT_ID('tempdb..#TMP_KreuzFA') IS NOT NULL DROP TABLE #TMP_KreuzFA
		CREATE TABLE #TMP_KreuzFA (AG varchar(150), Bezug varchar(20))

		OPEN Cursor_ADD_COL
		FETCH NEXT FROM Cursor_ADD_COL INTO @cur_FA

		WHILE @@FETCH_STATUS = 0 
		BEGIN   
			-----------------------------------------------------------------------------------
			--FA als Spalten hinzufügen
			-----------------------------------------------------------------------------------
			DECLARE @SQL_AlterTable nvarchar(4000)

			--FA
			SET @SQL_AlterTable = 'ALTER TABLE #TMP_KreuzFA ADD [' + LTRIM(@cur_FA) + ' BzgGr] varchar(16)'
			--PRINT @SQL_AlterTable
			EXEC sp_executesql @SQL_AlterTable

			--Anz ZU
			SET @SQL_AlterTable = 'ALTER TABLE #TMP_KreuzFA ADD [' + LTRIM(@cur_FA) + ' ZU] varchar(16)'
			--PRINT @SQL_AlterTable
			EXEC sp_executesql @SQL_AlterTable
					

			IF (SELECT COUNT(AG) AS RES FROM #TMP_KreuzFA)=0 
			BEGIN
				--Zeit
				SET @SQL_AlterTable = '
										INSERT #TMP_KreuzFA(
															AG, 
															Bezug,
															[' + LTRIM(@cur_FA) + ' BzgGr],
															[' + LTRIM(@cur_FA) + ' ZU]
															)

										SELECT AG, ''Minuten'', SUM(B_Zeit_Min) AS RES_AnzMin, SUM(AnzAbgem_ELP_beiAG/ELP_je_ZU) AS RES_AnzZU
										FROM LIVE2.dbo.tmpNachkalkProzesskosten 
										WHERE Pool=''' + @para1 + ''' AND FA LIKE ''%' + RTRIM(LTRIM(@cur_FA)) + '%''
										GROUP BY AG
										ORDER BY AG
									'	
				EXEC sp_executesql @SQL_AlterTable	

				--Trennung
				SET @SQL_AlterTable = 'INSERT #TMP_KreuzFA(AG, Bezug, [' + LTRIM(@cur_FA) + ' BzgGr], [' + LTRIM(@cur_FA) + ' ZU]) SELECT '''', '''', '''', '''''	
				EXEC sp_executesql @SQL_AlterTable	

				--Materialkosten
				SET @SQL_AlterTable = '
										INSERT #TMP_KreuzFA(
															AG, 
															Bezug,
															[' + LTRIM(@cur_FA) + ' BzgGr],
															[' + LTRIM(@cur_FA) + ' ZU]
															)

										SELECT AG, ''Mat-Ko.'', SUM(MatKosten) AS RES_AnzMin, SUM(AnzAbgem_ELP_beiAG/ELP_je_ZU) AS RES_AnzZU
										FROM LIVE2.dbo.tmpNachkalkProzesskosten 
										WHERE Pool=''' + @para1 + ''' AND FA LIKE ''%' + RTRIM(LTRIM(@cur_FA)) + '%''
										GROUP BY AG
										ORDER BY AG
									'	
				EXEC sp_executesql @SQL_AlterTable	

				--Trennung
				SET @SQL_AlterTable = 'INSERT #TMP_KreuzFA(AG, Bezug, [' + LTRIM(@cur_FA) + ' BzgGr], [' + LTRIM(@cur_FA) + ' ZU]) SELECT '''', '''', '''', '''''	
				EXEC sp_executesql @SQL_AlterTable	

				--Andere Kosten (Pers, E, Inst usw.)
				SET @SQL_AlterTable = '
										INSERT #TMP_KreuzFA(
															AG, 
															Bezug,
															[' + LTRIM(@cur_FA) + ' BzgGr],
															[' + LTRIM(@cur_FA) + ' ZU]
															)

										SELECT AG, ''Andere-Ko.'', SUM(ISNULL(varPersKosten, 0) + ISNULL(fixPersKosten, 0) + ISNULL(EKosten, 0) + ISNULL(AfALeasing, 0) + ISNULL(Inst, 0) + ISNULL(SonstKosten, 0)) AS RES_AnzMin, SUM(AnzAbgem_ELP_beiAG/ELP_je_ZU) AS RES_AnzZU
										FROM LIVE2.dbo.tmpNachkalkProzesskosten 
										WHERE Pool=''' + @para1 + ''' AND FA LIKE ''%' + RTRIM(LTRIM(@cur_FA)) + '%''
										GROUP BY AG
										ORDER BY AG
									'	
				EXEC sp_executesql @SQL_AlterTable	
			END
			ELSE
			BEGIN
				--Zeit
				SET @SQL_AlterTable = '
										UPDATE #TMP_KreuzFA
										SET 
											#TMP_KreuzFA.[' + LTRIM(@cur_FA) + ' BzgGr] = ISNULL(tblGrpFA.RES_AnzMin, 0),
											#TMP_KreuzFA.[' + LTRIM(@cur_FA) + ' ZU] = ISNULL(tblGrpFA.RES_AnzZU, 0)
										FROM
											(
												SELECT 
													AG AS AG_,
													SUM(B_Zeit_Min) AS RES_AnzMin,
													SUM(AnzAbgem_ELP_beiAG/ELP_je_ZU) AS RES_AnzZU
												FROM
													LIVE2.dbo.tmpNachkalkProzesskosten 
												WHERE 
													LIVE2.dbo.tmpNachkalkProzesskosten.Pool=''' + @para1 + ''' 
													AND 
													LIVE2.dbo.tmpNachkalkProzesskosten.FA LIKE ''%' + RTRIM(LTRIM(@cur_FA)) + '%''
												GROUP BY AG
											) AS tblGrpFA
										WHERE 
											#TMP_KreuzFA.AG = tblGrpFA.AG_ AND #TMP_KreuzFA.Bezug=''Minuten''
									'	
				EXEC sp_executesql @SQL_AlterTable	

				--Materialkosten
				SET @SQL_AlterTable = '
										UPDATE #TMP_KreuzFA
										SET 
											#TMP_KreuzFA.[' + LTRIM(@cur_FA) + ' BzgGr] = ISNULL(tblGrpFA.RES_AnzMin, 0),
											#TMP_KreuzFA.[' + LTRIM(@cur_FA) + ' ZU] = ISNULL(tblGrpFA.RES_AnzZU, 0)
										FROM
											(
												SELECT 
													AG AS AG_,
													SUM(MatKosten) AS RES_AnzMin,
													SUM(AnzAbgem_ELP_beiAG/ELP_je_ZU) AS RES_AnzZU
												FROM
													LIVE2.dbo.tmpNachkalkProzesskosten 
												WHERE 
													LIVE2.dbo.tmpNachkalkProzesskosten.Pool=''' + @para1 + ''' 
													AND 
													LIVE2.dbo.tmpNachkalkProzesskosten.FA LIKE ''%' + RTRIM(LTRIM(@cur_FA)) + '%''
												GROUP BY AG
											) AS tblGrpFA
										WHERE 
											#TMP_KreuzFA.AG = tblGrpFA.AG_ AND #TMP_KreuzFA.Bezug=''Mat-Ko.''
									'	
				EXEC sp_executesql @SQL_AlterTable

				--Andere Kosten (Pers, E, Inst usw.)
				SET @SQL_AlterTable = '
										UPDATE #TMP_KreuzFA
										SET 
											#TMP_KreuzFA.[' + LTRIM(@cur_FA) + ' BzgGr] = ISNULL(tblGrpFA.RES_AnzMin, 0),
											#TMP_KreuzFA.[' + LTRIM(@cur_FA) + ' ZU] = ISNULL(tblGrpFA.RES_AnzZU, 0)
										FROM
											(
												SELECT 
													AG AS AG_,
													SUM(ISNULL(varPersKosten, 0) + ISNULL(fixPersKosten, 0) + ISNULL(EKosten, 0) + ISNULL(AfALeasing, 0) + ISNULL(Inst, 0) + ISNULL(SonstKosten, 0)) AS RES_AnzMin,
													SUM(AnzAbgem_ELP_beiAG/ELP_je_ZU) AS RES_AnzZU
												FROM
													LIVE2.dbo.tmpNachkalkProzesskosten 
												WHERE 
													LIVE2.dbo.tmpNachkalkProzesskosten.Pool=''' + @para1 + ''' 
													AND 
													LIVE2.dbo.tmpNachkalkProzesskosten.FA LIKE ''%' + RTRIM(LTRIM(@cur_FA)) + '%''
												GROUP BY AG
											) AS tblGrpFA
										WHERE 
											#TMP_KreuzFA.AG = tblGrpFA.AG_ AND #TMP_KreuzFA.Bezug=''Andere-Ko.''
									'	
				EXEC sp_executesql @SQL_AlterTable
			END
			

			FETCH NEXT FROM Cursor_ADD_COL INTO @cur_FA
		END

		CLOSE Cursor_ADD_COL
		DEALLOCATE Cursor_ADD_COL


		SELECT * FROM #TMP_KreuzFA
		*/
		--DECLARE
		--@para1 varchar(250),
		--@para2 varchar(250)
		--SET @para1 = 'DSI 52786.901'
		--SET @para2 = '52786.901'

		DECLARE @cur_FA varchar(16)

		DECLARE Cursor_ADD_COL CURSOR fast_forward FOR (
															SELECT DISTINCT FA
															FROM LIVE2.dbo.tmpNachkalkProzesskosten WHERE Pool=@para1 AND LP=@para2
														)



		--Kreuztabelle erstellen
		--DROP TABLE #TMP_KreuzFA
		IF OBJECT_ID('tempdb..#TMP_KreuzFA') IS NOT NULL DROP TABLE #TMP_KreuzFA
		CREATE TABLE #TMP_KreuzFA (AG varchar(150), Bezug varchar(20))

		OPEN Cursor_ADD_COL
		FETCH NEXT FROM Cursor_ADD_COL INTO @cur_FA

		--Tabelle mit allen AGs füllen
		INSERT #TMP_KreuzFA(AG, Bezug)
		SELECT AG, 'Minuten' AS Min
		FROM
		(
			SELECT AG, MIN(Abmeldezeit) AS Abmeldung
			FROM LIVE2.dbo.tmpNachkalkProzesskosten WHERE Pool=@para1 AND LP=@para2
			GROUP BY AG
		) AS tblAGs
		ORDER BY Abmeldung
		----
		--Trennung
		INSERT #TMP_KreuzFA(AG) SELECT ''
		----
		INSERT #TMP_KreuzFA(AG, Bezug)
		SELECT AG, 'Mat-Ko.' AS Min
		FROM
		(
			SELECT AG, MIN(Abmeldezeit) AS Abmeldung
			FROM LIVE2.dbo.tmpNachkalkProzesskosten WHERE Pool=@para1 AND LP=@para2
			GROUP BY AG
		) AS tblAGs
		ORDER BY Abmeldung
		----
		--Trennung
		INSERT #TMP_KreuzFA(AG) SELECT ''
		----
		INSERT #TMP_KreuzFA(AG, Bezug)
		SELECT AG, 'Andere-Ko.' AS Min
		FROM
		(
			SELECT AG, MIN(Abmeldezeit) AS Abmeldung
			FROM LIVE2.dbo.tmpNachkalkProzesskosten WHERE Pool=@para1 AND LP=@para2
			GROUP BY AG
		) AS tblAGs
		ORDER BY Abmeldung


		WHILE @@FETCH_STATUS = 0 
		BEGIN   
			-----------------------------------------------------------------------------------
			--FA als Spalten hinzufügen
			-----------------------------------------------------------------------------------
			DECLARE @SQL_AlterTable nvarchar(4000)

			--FA
			SET @SQL_AlterTable = 'ALTER TABLE #TMP_KreuzFA ADD [' + LTRIM(@cur_FA) + '] varchar(16)'
			--PRINT @SQL_AlterTable
			EXEC sp_executesql @SQL_AlterTable

			--Anz ZU
			SET @SQL_AlterTable = 'ALTER TABLE #TMP_KreuzFA ADD [' + LTRIM(@cur_FA) + ' ZU] varchar(16)'
			--PRINT @SQL_AlterTable
			EXEC sp_executesql @SQL_AlterTable
					
			IF (SELECT COUNT(AG) AS RES FROM #TMP_KreuzFA)>0 
			BEGIN
				--Zeit
				SET @SQL_AlterTable = '
										UPDATE #TMP_KreuzFA
										SET 
											#TMP_KreuzFA.[' + LTRIM(@cur_FA) + '] = ISNULL(tblGrpFA.RES_AnzMin, 0),
											#TMP_KreuzFA.[' + LTRIM(@cur_FA) + ' ZU] = ISNULL(tblGrpFA.RES_AnzZU, 0)
										FROM
											(
												SELECT 
													AG AS AG_,
													SUM(B_Zeit_Min) AS RES_AnzMin,
													SUM(AnzAbgem_ELP_beiAG/ELP_je_ZU) AS RES_AnzZU
												FROM
													LIVE2.dbo.tmpNachkalkProzesskosten 
												WHERE 
													LIVE2.dbo.tmpNachkalkProzesskosten.Pool=''' + @para1 + ''' 
													AND 
													LIVE2.dbo.tmpNachkalkProzesskosten.FA LIKE ''%' + RTRIM(LTRIM(@cur_FA)) + '%''
												GROUP BY AG
											) AS tblGrpFA
										WHERE 
											#TMP_KreuzFA.AG = tblGrpFA.AG_ AND #TMP_KreuzFA.Bezug=''Minuten''
									'	
				EXEC sp_executesql @SQL_AlterTable	

				--Materialkosten
				SET @SQL_AlterTable = '
										UPDATE #TMP_KreuzFA
										SET 
											#TMP_KreuzFA.[' + LTRIM(@cur_FA) + '] = ISNULL(tblGrpFA.RES_AnzMin, 0),
											#TMP_KreuzFA.[' + LTRIM(@cur_FA) + ' ZU] = ISNULL(tblGrpFA.RES_AnzZU, 0)
										FROM
											(
												SELECT 
													AG AS AG_,
													SUM(MatKosten) AS RES_AnzMin,
													SUM(AnzAbgem_ELP_beiAG/ELP_je_ZU) AS RES_AnzZU
												FROM
													LIVE2.dbo.tmpNachkalkProzesskosten 
												WHERE 
													LIVE2.dbo.tmpNachkalkProzesskosten.Pool=''' + @para1 + ''' 
													AND 
													LIVE2.dbo.tmpNachkalkProzesskosten.FA LIKE ''%' + RTRIM(LTRIM(@cur_FA)) + '%''
												GROUP BY AG
											) AS tblGrpFA
										WHERE 
											#TMP_KreuzFA.AG = tblGrpFA.AG_ AND #TMP_KreuzFA.Bezug=''Mat-Ko.''
									'	
				EXEC sp_executesql @SQL_AlterTable

				--Andere Kosten (Pers, E, Inst usw.)
				SET @SQL_AlterTable = '
										UPDATE #TMP_KreuzFA
										SET 
											#TMP_KreuzFA.[' + LTRIM(@cur_FA) + '] = ISNULL(tblGrpFA.RES_AnzMin, 0),
											#TMP_KreuzFA.[' + LTRIM(@cur_FA) + ' ZU] = ISNULL(tblGrpFA.RES_AnzZU, 0)
										FROM
											(
												SELECT 
													AG AS AG_,
													SUM(ISNULL(varPersKosten, 0) + ISNULL(fixPersKosten, 0) + ISNULL(EKosten, 0) + ISNULL(AfALeasing, 0) + ISNULL(Inst, 0) + ISNULL(SonstKosten, 0)) AS RES_AnzMin,
													SUM(AnzAbgem_ELP_beiAG/ELP_je_ZU) AS RES_AnzZU
												FROM
													LIVE2.dbo.tmpNachkalkProzesskosten 
												WHERE 
													LIVE2.dbo.tmpNachkalkProzesskosten.Pool=''' + @para1 + ''' 
													AND 
													LIVE2.dbo.tmpNachkalkProzesskosten.FA LIKE ''%' + RTRIM(LTRIM(@cur_FA)) + '%''
												GROUP BY AG
											) AS tblGrpFA
										WHERE 
											#TMP_KreuzFA.AG = tblGrpFA.AG_ AND #TMP_KreuzFA.Bezug=''Andere-Ko.''
									'	
				EXEC sp_executesql @SQL_AlterTable
			END
			

			FETCH NEXT FROM Cursor_ADD_COL INTO @cur_FA
		END

		CLOSE Cursor_ADD_COL
		DEALLOCATE Cursor_ADD_COL


		SELECT * FROM #TMP_KreuzFA
	END

	IF @Case_ = 'Prozesskosten_FAgrupp'
	BEGIN
		--DECLARE
		--@para1 varchar(250),
		--@para2 varchar(250)
		--SET @para1 = 'TEST DSI 47999.101'
		--SET @para2 = '47999.101'

		SELECT
			Kunde,
			LP,
			AG,
			MatKo,
			RestKo,
			FL,
			AnzMin,
			AnzZU,
			CASE WHEN AnzZU>0 THEN MatKo/AnzZU ELSE 0 END AS MatKo_pro_ZU,
			CASE WHEN AnzZU>0 THEN RestKo/AnzZU ELSE 0 END AS RestKo_pro_ZU,
			ISNULL((
					SELECT
						COUNT(DISTINCT FA) AS RES
					FROM 
						LIVE2.dbo.tmpNachkalkProzesskosten 
					WHERE 
						Pool=@para1 AND LP=@para2
			), 0) AS AnzFAs
		FROM
		(
			SELECT 
				Kunde,
				LP,
				AG,
				SUM(ISNULL(MatKosten, 0)) AS MatKo,
				SUM(ISNULL(varPersKosten, 0) + ISNULL(fixPersKosten, 0) + ISNULL(EKosten, 0) + ISNULL(AfALeasing, 0) + ISNULL(Inst, 0) + ISNULL(SonstKosten, 0)) AS RestKo,
				SUM(ISNULL(Fremdleistung, 0)) AS FL,
				SUM(ISNULL(B_Zeit_Min, 0)) AS AnzMin,
				--SUM(CASE WHEN ISNULL(ELP_je_ZU, 0)>0 THEN CEILING(CAST(ISNULL(AnzAbgem_ELP_beiAG, 0) AS FLOAT) / CAST(ELP_je_ZU AS FLOAT)) ELSE 0 END) AS AnzZU
				--CASE 
				--	WHEN MAX(AnzAbgem_ELP_beiAG)>0 THEN
				--		SUM(CASE WHEN ISNULL(ELP_je_ZU, 0)>0 THEN CEILING(CAST(ISNULL(AnzAbgem_ELP_beiAG, 0) AS FLOAT) / CAST(ELP_je_ZU AS FLOAT)) ELSE 0 END) 
				--	ELSE
				--		CASE 
				--			WHEN AG IN ('AV', 'Fotolabor', 'Materialkosten AL (BM, PP, Cu)', 'Materialkosten IL (BM)', 'Einkauf Handel', 'Einkauf Masslam, BM, PP, Cu', 'CAM Kosten', 'Verwaltung', 'Vertrieb') THEN
				--				SUM(Vorgabe_ZU)
				--			ELSE
				--				0
				--		END
				--END AS AnzZU
				ISNULL((
						SELECT TOP 1
							SUM(tblProzessMain.Vorgabe_ZU)
						FROM
						(
							SELECT DISTINCT
								tblProzess.FA,
								tblProzess.AG,
								tblProzess.Vorgabe_ZU
							FROM 
								LIVE2.dbo.tmpNachkalkProzesskosten AS tblProzess
							WHERE 
								tblProzess.Pool=@para1 AND tblProzess.LP=@para2
						) AS tblProzessMain
						WHERE tblProzessMain.AG = LIVE2.dbo.tmpNachkalkProzesskosten .AG
				), 0) AS AnzZU,
				MIN(Abmeldezeit) AS Abmeldung
			FROM 
				LIVE2.dbo.tmpNachkalkProzesskosten 
			WHERE 
				Pool=@para1 AND LP=@para2 --AND LEFT(FA, 1)<>'R'
			GROUP BY
				Kunde,
				LP,
				AG		
		) AS tblGrpFA
		ORDER BY Abmeldung
	END

	IF @Case_ = 'Prozesskosten_Detail'
	BEGIN
		--DECLARE
		--@para1 varchar(250),
		--@para2 varchar(250)
		--SET @para1 = 'TEST DSI 47999.101'
		--SET @para2 = '47999.101'

		SELECT
			Kunde,
			LP,
			AG,
			AL_IL_HBF,
			MatKo,
			--RestKo,
			varPersKosten,
			fixPersKosten,
			EKosten,
			AfALeasing,
			Inst,
			SonstKosten,
			FL,
			AnzMin,
			AnzZU,
			--CASE WHEN AnzZU>0 THEN MatKo/AnzZU ELSE 0 END AS MatKo_pro_ZU,
			--CASE WHEN AnzZU>0 THEN RestKo/AnzZU ELSE 0 END AS RestKo_pro_ZU,
			ISNULL((
					SELECT
						COUNT(DISTINCT FA) AS RES
					FROM 
						LIVE2.dbo.tmpNachkalkProzesskosten 
					WHERE 
						Pool=@para1 AND LP=@para2
			), 0) AS AnzFAs
		FROM
		(
			SELECT 
				Kunde,
				LP,
				AG,
				AL_IL_HBF,
				SUM(ISNULL(MatKosten, 0)) AS MatKo,
				--SUM(ISNULL(varPersKosten, 0) + ISNULL(fixPersKosten, 0) + ISNULL(EKosten, 0) + ISNULL(AfALeasing, 0) + ISNULL(Inst, 0) + ISNULL(SonstKosten, 0)) AS RestKo,
				SUM(ISNULL(varPersKosten, 0)) AS varPersKosten,
				SUM(ISNULL(fixPersKosten, 0)) AS fixPersKosten,
				SUM(ISNULL(EKosten, 0)) AS EKosten,
				SUM(ISNULL(AfALeasing, 0)) AS AfALeasing,
				SUM(ISNULL(Inst, 0)) AS Inst,
				SUM(ISNULL(SonstKosten, 0)) AS SonstKosten,
				SUM(ISNULL(Fremdleistung, 0)) AS FL,
				SUM(ISNULL(B_Zeit_Min, 0)) AS AnzMin,
				ISNULL((
						SELECT TOP 1
							SUM(tblProzessMain.Vorgabe_ZU)
						FROM
						(
							SELECT DISTINCT
								tblProzess.FA,
								tblProzess.AG,
								tblProzess.Vorgabe_ZU
							FROM 
								LIVE2.dbo.tmpNachkalkProzesskosten AS tblProzess
							WHERE 
								tblProzess.Pool=@para1 AND tblProzess.LP=@para2
						) AS tblProzessMain
						WHERE tblProzessMain.AG = LIVE2.dbo.tmpNachkalkProzesskosten .AG
				), 0) AS AnzZU,
				MIN(Abmeldezeit) AS Abmeldung
			FROM 
				LIVE2.dbo.tmpNachkalkProzesskosten 
			WHERE 
				Pool=@para1 AND LP=@para2 --AND LEFT(FA, 1)<>'R'
			GROUP BY
				Kunde,
				LP,
				AG,
				AL_IL_HBF
		) AS tblGrpFA
		ORDER BY Abmeldung
	END

END
